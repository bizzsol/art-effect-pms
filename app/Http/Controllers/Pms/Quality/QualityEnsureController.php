<?php
bolt_decrypt( __FILE__ , 'v8v0eG'); return 0;
##!!!##CgpuYW1lc3BhY2UgQXBwXEh0dHBcQ29udHJvbGxlcnNcUG1zXFF1YWxpdHk7Cgp1c2UgQXBwXEh0dHBcQ29udHJvbGxlcnNcQ29udHJvbGxlcjsKdXNlIElsbHVtaW5hdGVcRGF0YWJhc2VcRWxvcXVlbnRcQnVpbGRlcjsKdXNlIElsbHVtaW5hdGVcSHR0cFxSZXF1ZXN0OwoKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXEludmVudG9yeU1vZGVsc1xJbnZlbnRvcnlBY3Rpb25Db250cm9sOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUHJvZHVjdDsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFdhcmVob3VzZXM7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xQdXJjaGFzZVJldHVybjsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFB1cmNoYXNlXFB1cmNoYXNlT3JkZXI7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xQdXJjaGFzZVxQdXJjaGFzZU9yZGVySXRlbTsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXEdyblxHb29kc1JlY2VpdmVkTm90ZTsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXEdyblxHb29kc1JlY2VpdmVkU3VtbWFyeTsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXEdyblxHb29kc1JlY2VpdmVkSXRlbTsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXEdyblxHb29kc1JlY2VpdmVkSXRlbVN0b2NrSW47CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xHcm5cRmFxOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcR3JuXFJldHVybkNoYW5nZUZhcTsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFJlcXVpc2l0aW9uSXRlbTsKCnVzZSBBcHBcTW9kZWxzXEZpeGVkQXNzZXRzXEZpeGVkQXNzZXRCYXRjaDsKdXNlIEFwcFxNb2RlbHNcRml4ZWRBc3NldHNcRml4ZWRBc3NldEJhdGNoSXRlbTsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXEFjY291bnRzXENvc3RDZW50cmU7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xSZXF1aXNpdGlvbkRlbGl2ZXJ5Owp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUmVxdWlzaXRpb25UcmFja2luZzsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFJlcXVpc2l0aW9uOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUmVxdWlzaXRpb25EZWxpdmVyeUl0ZW07Cgp1c2UgSWxsdW1pbmF0ZVxTdXBwb3J0XEZhY2FkZXNcTWFpbDsKdXNlIERhdGFUYWJsZXM7CnVzZSBEQixBdXRoLFNlc3Npb24scmVkaXJlY3Q7CgoKY2xhc3MgUXVhbGl0eUVuc3VyZUNvbnRyb2xsZXIgZXh0ZW5kcyBDb250cm9sbGVyCnsKICAgIHB1YmxpYyBmdW5jdGlvbiBhcHByb3ZlZEhlYWRlckNvbHVtbnMoJHZhbHVlPScnKQogICAgewogICAgICAgIHJldHVybiBhcnJheSgKICAgICAgICAgICAgWydTTCcsICdTTCddLAogICAgICAgICAgICBbJ1BPX3JlZmVyZW5jZScsICdQT19yZWZlcmVuY2UnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydQT19kYXRlJywgJ1BPX2RhdGUnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydyZXF1aXNpdGlvbnMnLCAncmVxdWlzaXRpb25zJywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsnY2hhbGxhbicsICdjaGFsbGFuJywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsnZ2F0ZV9pbl9yZWZlcmVuY2UnLCAnZ2F0ZV9pbl9yZWZlcmVuY2UnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydnYXRlX2luX2RhdGUnLCAnZ2F0ZV9pbl9kYXRlJywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsnZ2F0ZV9pbl9xdHknLCAnZ2F0ZV9pbl9xdHknLCAndGV4dC1yaWdodCddLAogICAgICAgICAgICBbJ3JlY2VpdmVkX3N0YXR1cycsICdyZWNlaXZlZF9zdGF0dXMnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydhcHByb3ZlZF9xdHknLCAnYXBwcm92ZWRfcXR5JywgJ3RleHQtcmlnaHQnXSwKICAgICAgICAgICAgWydvcHRpb25zJywgJ29wdGlvbnMnLCd0ZXh0LWNlbnRlciddLAogICAgICAgICk7CiAgICB9CgogICAgLyoqCiAgICAgKiBEaXNwbGF5IGEgYXBwcm92ZWQgbGlzdGluZyBvZiB0aGUgcmVzb3VyY2UuCiAgICAgKgogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KICAgIHB1YmxpYyBmdW5jdGlvbiBpbmRleCgpCiAgICB7CiAgICAgICAgdHJ5ewoKICAgICAgICAgICAgJHVzZXJVbml0cyA9IGF1dGgoKS0+dXNlcigpLT5wcmlvcml0aWVzLT5wbHVjaygnaHJfdW5pdF9pZCcpLT50b0FycmF5KCk7CiAgICAgICAgICAgICR1c2VyRGVwYXJ0bWVudHMgPSBhdXRoKCktPnVzZXIoKS0+cHJpb3JpdGllcy0+cGx1Y2soJ2hyX2RlcGFydG1lbnRfaWQnKS0+dG9BcnJheSgpOwogICAgICAgICAgICAkaXRlbXMgPSBHb29kc1JlY2VpdmVkTm90ZTo6d2l0aChbCiAgICAgICAgICAgICAgICAncmVsUHVyY2hhc2VPcmRlci5wdXJjaGFzZU9yZGVyUmVxdWlzaXRpb25zJywKICAgICAgICAgICAgICAgICdyZWxQdXJjaGFzZU9yZGVyLnB1cmNoYXNlT3JkZXJSZXF1aXNpdGlvbnMucmVxdWlzaXRpb24nLAogICAgICAgICAgICAgICAgJ3JlbEdvb2RzUmVjZWl2ZWRJdGVtcycKICAgICAgICAgICAgXSkKICAgICAgICAgICAgLT53aGVyZUhhcygncmVsUHVyY2hhc2VPcmRlcicsIGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnaXNfc2VuZCcsICd5ZXMnKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT53aGVuKGlzc2V0KGF1dGgoKS0+dXNlcigpLT5lbXBsb3llZS0+YXNfdW5pdF9pZCksIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCR1c2VyVW5pdHMpewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFB1cmNoYXNlT3JkZXInLCBmdW5jdGlvbigkcXVlcnkpIHVzZSgkdXNlclVuaXRzKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnaHJfdW5pdF9pZCcsICR1c2VyVW5pdHMpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC8vIC0+d2hlbihhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnRGVwYXJ0bWVudC1IZWFkJyksIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCR1c2VyRGVwYXJ0bWVudHMpewogICAgICAgICAgICAvLyAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFB1cmNoYXNlT3JkZXIucHVyY2hhc2VPcmRlclJlcXVpc2l0aW9ucycsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCR1c2VyRGVwYXJ0bWVudHMpewogICAgICAgICAgICAvLyAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdocl9kZXBhcnRtZW50X2lkJywgJHVzZXJEZXBhcnRtZW50cyk7CiAgICAgICAgICAgIC8vICAgICB9KTsKICAgICAgICAgICAgLy8gfSkKICAgICAgICAgICAgLT53aGVuKCFhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnRGVwYXJ0bWVudC1IZWFkJyksIGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgICAgICBpZiAoYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ0VtcGxveWVlJykpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnaXNfc2VudF90b19yZXF1aXNpdG9yJywgJ3llcycpLT53aGVyZUhhcygncmVsUHVyY2hhc2VPcmRlci5wdXJjaGFzZU9yZGVyUmVxdWlzaXRpb25zLnJlcXVpc2l0aW9uJywKICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2F1dGhvcl9pZCcsIGF1dGgoKS0+dXNlcigpLT5pZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFB1cmNoYXNlT3JkZXIucHVyY2hhc2VPcmRlclJlcXVpc2l0aW9ucycsIGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2hyX2RlcGFydG1lbnRfaWQnLCAwKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPndoZW4oYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ0VtcGxveWVlJyksIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxQdXJjaGFzZU9yZGVyLnB1cmNoYXNlT3JkZXJSZXF1aXNpdGlvbnMucmVxdWlzaXRpb24nLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2F1dGhvcl9pZCcsIGF1dGgoKS0+dXNlcigpLT5pZCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT53aGVyZUhhcygncmVsR29vZHNSZWNlaXZlZEl0ZW1zJywgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdxdWFsaXR5X2Vuc3VyZScsJ2FwcHJvdmVkJyk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+d2hlbighZGF0YXRhYmxlT3JkZXJpbmcoKSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyYnkoJ3JlY2VpdmVkX2RhdGUnLCAnZGVzYycpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBpZiAocmVxdWVzdCgpLT5hamF4KCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBEYXRhVGFibGVzOjpvZigkaXRlbXMpCiAgICAgICAgICAgICAgICAgICAgLT5hZGRJbmRleENvbHVtbigpCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ1BPX3JlZmVyZW5jZScsIGZ1bmN0aW9uKCRncm4pewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgY2xhc3M9ImJ0biBidG4tbGluayIgb25jbGljaz0icHVyY2hhc2VPcmRlckRldGFpbHMoJCh0aGlzKSkiIGRhdGEtc3JjPSInLnJvdXRlKCdwbXMucHVyY2hhc2Uub3JkZXItbGlzdC5zaG93JywgJGdybi0+cmVsUHVyY2hhc2VPcmRlci0+aWQpLiciIGRhdGEtdGl0bGU9IlB1cmNoYXNlIE9yZGVyIERldGFpbHMiPicuJGdybi0+cmVsUHVyY2hhc2VPcmRlci0+cmVmZXJlbmNlX25vLicKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvYT4nOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ1BPX3JlZmVyZW5jZScsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxQdXJjaGFzZU9yZGVyJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdyZWZlcmVuY2Vfbm8nLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ1BPX3JlZmVyZW5jZScsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBQdXJjaGFzZU9yZGVyOjpzZWxlY3QoJ3B1cmNoYXNlX29yZGVycy5yZWZlcmVuY2Vfbm8nKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbigncHVyY2hhc2Vfb3JkZXJzLmlkJywgJ2dvb2RzX3JlY2VpdmVkX25vdGVzLnB1cmNoYXNlX29yZGVyX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdQT19kYXRlJywgZnVuY3Rpb24oJGdybil7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkYXRlKCdZLW0tZCcsIHN0cnRvdGltZSgkZ3JuLT5yZWxQdXJjaGFzZU9yZGVyLT5wb19kYXRlKSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbignUE9fZGF0ZScsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxQdXJjaGFzZU9yZGVyJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdwb19kYXRlJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdQT19yZWZlcmVuY2UnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgUHVyY2hhc2VPcmRlcjo6c2VsZWN0KCdwdXJjaGFzZV9vcmRlcnMucG9fZGF0ZScpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCdwdXJjaGFzZV9vcmRlcnMuaWQnLCAnZ29vZHNfcmVjZWl2ZWRfbm90ZXMucHVyY2hhc2Vfb3JkZXJfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT50YWtlKDEpCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbigncmVxdWlzaXRpb25zJywgZnVuY3Rpb24gKCRncm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRncm4tPnJlbFB1cmNoYXNlT3JkZXItPnB1cmNoYXNlT3JkZXJSZXF1aXNpdGlvbnMtPnBsdWNrKCdyZXF1aXNpdGlvbi5yZWZlcmVuY2Vfbm8nKS0+aW1wbG9kZSgnLCAnKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdyZXF1aXNpdGlvbnMnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUHVyY2hhc2VPcmRlci5wdXJjaGFzZU9yZGVyUmVxdWlzaXRpb25zLnJlcXVpc2l0aW9uJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgncmVmZXJlbmNlX25vJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbigncmVxdWlzaXRpb25zJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwbGVhc2VTb3J0TWUoJHF1ZXJ5LCAkb3JkZXIsIFB1cmNoYXNlT3JkZXI6OnNlbGVjdCgncmVxdWlzaXRpb25zLnJlZmVyZW5jZV9ubycpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ3JlcXVpc2l0aW9ucycsICdyZXF1aXNpdGlvbnMuaWQnLCAnPScsICdwdXJjaGFzZV9vcmRlcl9yZXF1aXNpdGlvbnMucmVxdWlzaXRpb25faWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdwdXJjaGFzZV9vcmRlcl9yZXF1aXNpdGlvbnMnLCAncHVyY2hhc2Vfb3JkZXJfcmVxdWlzaXRpb25zLnB1cmNoYXNlX29yZGVyX2lkJywgJz0nLCAncHVyY2hhc2Vfb3JkZXJzLmlkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3B1cmNoYXNlX29yZGVycy5pZCcsICdnb29kc19yZWNlaXZlZF9ub3Rlcy5wdXJjaGFzZV9vcmRlcl9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdnYXRlX2luX3JlZmVyZW5jZScsIGZ1bmN0aW9uKCRncm4pewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxkaXYgc3R5bGU9IndpZHRoOiAxMDAlIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0id2lkdGg6IDkwJTtmbG9hdDogbGVmdDtjbGVhcjpyaWdodCI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIGNsYXNzPSJidG4gYnRuLWxpbmsiIG9uY2xpY2s9InNob3dRRVBPRGV0YWlscygkKHRoaXMpKSIgZGF0YS1zcmM9Iicucm91dGUoJ3Btcy5ncm4uZ3JuLXByb2Nlc3Muc2hvdycsJGdybi0+aWQpLiciIGRhdGEtdGl0bGU9IkdhdGUgSW4gRGV0YWlscyI+Jy4kZ3JuLT5yZWZlcmVuY2Vfbm8uJzwvYT4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9IndpZHRoOiAxMCU7ZmxvYXQ6IGxlZnQ7Y2xlYXI6cmlnaHQiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGEgY2xhc3M9ImJ0biBidG4tcHJpbWFyeSBidG4teHMiIGhyZWY9IicuIHVybCgncG1zL2dybi9nYXRlLWluLXNsaXAvJy4kZ3JuLT5wdXJjaGFzZV9vcmRlcl9pZC4nP2dybj0nLiRncm4tPmlkKSAuJyIgdGFyZ2V0PSJfYmxhbmsiIHN0eWxlPSJtYXJnaW4tdG9wOiA3LjVweCIgdGl0bGU9IkdhdGUgSW4gU2xpcCI+PGkgY2xhc3M9ImxhIGxhLXByaW50Ij48L2k+PC9hPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4nOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ2dhdGVfaW5fcmVmZXJlbmNlJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgncmVmZXJlbmNlX25vJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ2dhdGVfaW5fcmVmZXJlbmNlJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyQnkoJ3JlZmVyZW5jZV9ubycsICRvcmRlcik7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignZ2F0ZV9pbl9kYXRlJywgZnVuY3Rpb24oJGdybil7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkYXRlKCdZLW0tZCcsIHN0cnRvdGltZSgkZ3JuLT5yZWNlaXZlZF9kYXRlKSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbignZ2F0ZV9pbl9kYXRlJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgncmVjZWl2ZWRfZGF0ZScsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJyk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdnYXRlX2luX2RhdGUnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+b3JkZXJCeSgncmVjZWl2ZWRfZGF0ZScsICRvcmRlcik7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignZ2F0ZV9pbl9xdHknLCBmdW5jdGlvbigkZ3JuKXsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRncm4tPnJlbEdvb2RzUmVjZWl2ZWRJdGVtcy0+c3VtKCdxdHknKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZWRpdENvbHVtbigncmVjZWl2ZWRfc3RhdHVzJywgZnVuY3Rpb24oJGdybil7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCRncm4tPnJlY2VpdmVkX3N0YXR1cyA9PSAncGFydGlhbCcpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8YSBjbGFzcz0iYnRuIGJ0bi13YXJuaW5nIGJ0bi14cyI+UGFydGlhbCBSZWNlaXZlZDwvYT4nOwogICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZWlmKCRncm4tPnJlY2VpdmVkX3N0YXR1cyA9PSAnZnVsbCcpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8YSBjbGFzcz0iYnRuIGJ0bi1zdWNjZXNzIGJ0bi14cyI+RnVsbCBSZWNlaXZlZDwvYT4nOwogICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnPGEgY2xhc3M9ImJ0biBidG4tZGFyayBidG4teHMiPicudWN3b3JkcygkZ3JuLT5yZWNlaXZlZF9zdGF0dXMpLic8L2E+JzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2FwcHJvdmVkX3F0eScsIGZ1bmN0aW9uKCRncm4pewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGdybi0+cmVsR29vZHNSZWNlaXZlZEl0ZW1zLT53aGVyZSgncXVhbGl0eV9lbnN1cmUnLCdhcHByb3ZlZCcpLT5zdW0oJ3F0eScpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ29wdGlvbnMnLCBmdW5jdGlvbigkZ3JuKXsKICAgICAgICAgICAgICAgICAgICAgICAgJG9wdGlvbnMgPSAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgJGNvdW50ID0gJGdybi0+cmVsR29vZHNSZWNlaXZlZEl0ZW1zKCktPndoZXJlKCdxdWFsaXR5X2Vuc3VyZScsJ2FwcHJvdmVkJyktPmNvdW50KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCRjb3VudCA+IDApewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJG9wdGlvbnMgLj0gJzxhIGhyZWY9Iicucm91dGUoJ3Btcy5xdWFsaXR5LmVuc3VyZS5hcHByb3ZlZC5zaW5nbGUubGlzdCcsJGdybi0+aWQpLiciIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi1pbmZvIj5JdGVtcyAoJy4kY291bnQuJyk8L2E+JzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAkb3B0aW9ucyAuPSAnJm5ic3A7Jm5ic3A7PGEgdGFyZ2V0PSJfYmxhbmsiIGhyZWY9Iicucm91dGUoJ3Btcy5xdWFsaXR5LmFwcHJvdmVkLml0ZW0ucHJpbnQnLFsnaWQnPT4kZ3JuLT5pZCwndHlwZSc9PidhcHByb3ZlZCddKS4nIiB0aXRsZT0iUXVhbGl0eSBFbnN1cmUgQXBwcm92ZWQgUHJpbnQgVmlldyIgY2xhc3M9ImJ0biBidG4teHMgYnRuLXN1Y2Nlc3MiPjxpIGNsYXNzPSJsYXMgbGEtcHJpbnQiPjwvaT48L2E+JzsKCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkb3B0aW9uczsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+cmF3Q29sdW1ucyhbJ1BPX3JlZmVyZW5jZScsICdnYXRlX2luX3JlZmVyZW5jZScsICdyZWNlaXZlZF9zdGF0dXMnLCAnb3B0aW9ucyddKQogICAgICAgICAgICAgICAgICAgIC0+bWFrZSh0cnVlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnF1YWxpdHkuYXBwcm92ZWQtaW5kZXgnLCBbCiAgICAgICAgICAgICAgICAndGl0bGUnID0+ICJRdWFsaXR5IEVuc3VyZSBBcHByb3ZhbCBMaXN0IiwKICAgICAgICAgICAgICAgICdoZWFkZXJDb2x1bW5zJyA9PiAkdGhpcy0+YXBwcm92ZWRIZWFkZXJDb2x1bW5zKCkKICAgICAgICAgICAgXSk7CiAgICAgICAgfWNhdGNoKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAvKioKICAgICAqIFNob3cgdGhlIEdybiBXaXNlIEFwcHJvdmVkIEl0ZW0gTGlzdC4KICAgICAqCiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwoKICAgIHB1YmxpYyBmdW5jdGlvbiBlbnN1cmVDaGVjaygkaWQpCiAgICB7CiAgICAgICAgdHJ5ewogICAgICAgICAgICAkdGl0bGUgPSAiUXVhbGl0eSBFbnN1cmUgQ2hlY2siOwoKICAgICAgICAgICAgJGdybiA9IEdvb2RzUmVjZWl2ZWROb3RlOjp3aXRoKFsKICAgICAgICAgICAgICAgICdyZWxQdXJjaGFzZU9yZGVyLnJlbFF1b3RhdGlvbi5yZWxTdXBwbGllcnMuU3VwcGxpZXJSYXRpbmdzJywKICAgICAgICAgICAgICAgICdyZWxQdXJjaGFzZU9yZGVyLnJlbFF1b3RhdGlvbi5leGNoYW5nZVJhdGUuY3VycmVuY3knLAogICAgICAgICAgICAgICAgJ3JlbFB1cmNoYXNlT3JkZXIucmVsUXVvdGF0aW9uJywKICAgICAgICAgICAgICAgICdyZWxHb29kc1JlY2VpdmVkSXRlbXMucmVsUHJvZHVjdC5wcm9kdWN0VW5pdCcsCiAgICAgICAgICAgICAgICAncmVsR29vZHNSZWNlaXZlZEl0ZW1zLnJlbFByb2R1Y3QuY2F0ZWdvcnkuY2F0ZWdvcnknLAogICAgICAgICAgICAgICAgJ3JlbEdvb2RzUmVjZWl2ZWRJdGVtcy5yZWxQcm9kdWN0LmF0dHJpYnV0ZXMuYXR0cmlidXRlT3B0aW9uLmF0dHJpYnV0ZScsCiAgICAgICAgICAgICAgICAncmVsR29vZHNSZWNlaXZlZEl0ZW1zLmF0dHJpYnV0ZXMuYXR0cmlidXRlT3B0aW9uLmF0dHJpYnV0ZScsCiAgICAgICAgICAgICAgICAncmVsR29vZHNSZWNlaXZlZEl0ZW1zLnJlbFB1cmNoYXNlT3JkZXJSZXR1cm5zJwogICAgICAgICAgICBdKQogICAgICAgICAgICAtPndoZXJlKCdpZCcsJGlkKQogICAgICAgICAgICAtPmZpcnN0KCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAkZ3JuLT5yZWxfZ29vZHNfcmVjZWl2ZWRfaXRlbXMgPSAkZ3JuLT5yZWxHb29kc1JlY2VpdmVkSXRlbXMtPndoZXJlSW4oJ3F1YWxpdHlfZW5zdXJlJyxbJ3BlbmRpbmcnXSk7CiAgICAgICAgICAgICR3YXJlSG91c2VzID0gV2FyZWhvdXNlczo6c2VsZWN0KCduYW1lJywnaWQnKS0+Z2V0KCk7CiAgICAgICAgICAgICRmYXFzID0gRmFxOjp3aGVyZSgnc3RhdHVzJywnYWN0aXZlJyktPmdldCgpOwogICAgICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMucXVhbGl0eS5wZW5kaW5nLWluZGV4Jyxjb21wYWN0KCd0aXRsZScsJ2dybicsJ3dhcmVIb3VzZXMnLCdmYXFzJykpOwogICAgICAgIH1jYXRjaChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBnZXRGYXFzKCRjYXRlZ29yeV9pZCkKICAgIHsKICAgICAgICAkcXVlc3Rpb25zID0gRmFxOjp3aGVyZSgnY2F0ZWdvcnlfaWQnLCAkY2F0ZWdvcnlfaWQpLT53aGVyZSgnc3RhdHVzJywnYWN0aXZlJyktPmdldCgpOwogICAgICAgICRkYXRhID0gJyc7CiAgICAgICAgaWYoaXNzZXQoJHF1ZXN0aW9uc1swXSkpewogICAgICAgICAgICBmb3JlYWNoKCRxdWVzdGlvbnMgYXMgJGtleSA9PiAkcXVlc3Rpb24pewogICAgICAgICAgICAgICAgJGRhdGEgLj0nPGxpPgogICAgICAgICAgICAgICAgICAgIDxpbnB1dCBjbGFzcz0iZm9ybS1jaGVjay1pbnB1dCIgdHlwZT0iY2hlY2tib3giIG5hbWU9ImZhcV9pZFtdIiBpZD0iZmFxXycuJHF1ZXN0aW9uLT5pZC4nIiB2YWx1ZT0iJy4kcXVlc3Rpb24tPmlkLiciIHJlcXVpcmVkPgogICAgICAgICAgICAgICAgICAgIDxsYWJlbCBjbGFzcz0iZm9ybS1jaGVjay1sYWJlbCIgZm9yPSJmYXFfJy4kcXVlc3Rpb24tPmlkLiciPjxzdHJvbmc+Jy4kcXVlc3Rpb24tPm5hbWUuJzwvc3Ryb25nPgogICAgICAgICAgICAgICAgICAgIDwvbGFiZWw+CiAgICAgICAgICAgICAgICA8L2xpPic7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiAkZGF0YTsKICAgIH0KICAgIC8qKgogICAgICogU3RvcmUgYSBuZXdseSBjcmVhdGVkIHJlc291cmNlIGluIHN0b3JhZ2UuCiAgICAgKgogICAgICogQHBhcmFtICBcSWxsdW1pbmF0ZVxIdHRwXFJlcXVlc3QgICRyZXF1ZXN0CiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwogICAgcHVibGljIGZ1bmN0aW9uIHNhdmUoUmVxdWVzdCAkcmVxdWVzdCkKICAgIHsKICAgICAgICAkbW9kZWwgPSBHb29kc1JlY2VpdmVkSXRlbTo6d2l0aChbCiAgICAgICAgICAgICdyZWxHb29kc1JlY2VpdmVkTm90ZS5yZWxQdXJjaGFzZU9yZGVyLnB1cmNoYXNlT3JkZXJSZXF1aXNpdGlvbnMucmVxdWlzaXRpb24nCiAgICAgICAgXSktPmZpbmRPckZhaWwoJHJlcXVlc3QtPmlkKTsKICAgICAgICAkcHJvZHVjdCA9IFByb2R1Y3Q6OmZpbmRPckZhaWwoJG1vZGVsLT5wcm9kdWN0X2lkKTsKICAgICAgICBpZihpc3NldCgkbW9kZWwtPmlkKSAmJiAkcmVxdWVzdC0+cXVhbGl0eV9lbnN1cmUgPT09ICdhcHByb3ZlZCcpewoKICAgICAgICAgICAgREI6OmJlZ2luVHJhbnNhY3Rpb24oKTsKICAgICAgICAgICAgdHJ5ewogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAkbmV3VGV4dCA9ICdBcHByb3ZlZCc7CiAgICAgICAgICAgICAgICAkdXBkYXRlPSRtb2RlbC0+dXBkYXRlKFsKICAgICAgICAgICAgICAgICAgICAncXVhbGl0eV9lbnN1cmUnID0+ICRyZXF1ZXN0LT5xdWFsaXR5X2Vuc3VyZSwKICAgICAgICAgICAgICAgICAgICAncmVjZWl2ZWRfcXR5JyA9PiAgJG1vZGVsLT5xdHksCiAgICAgICAgICAgICAgICAgICAgJ3VwZGF0ZWRfYXQnID0+IGRhdGUoJ1ktbS1kIEg6aTpzJyksCiAgICAgICAgICAgICAgICAgICAgJ3VwZGF0ZWRfYnknID0+IEF1dGg6OnVzZXIoKS0+aWQKICAgICAgICAgICAgICAgIF0pOwoKICAgICAgICAgICAgICAgICRtb2RlbCA9IEdvb2RzUmVjZWl2ZWRJdGVtOjpmaW5kT3JGYWlsKCRyZXF1ZXN0LT5pZCk7CgogICAgICAgICAgICAgICAgJHByZWZpeD0nUUUtQVAtJy5kYXRlKCd5Jywgc3RydG90aW1lKGRhdGUoJ1ktbS1kJykpKS4nLScuKGF1dGgoKS0+dXNlcigpLT5lbXBsb3llZS0+dW5pdC0+aHJfdW5pdF9zaG9ydF9uYW1lKS4nLSc7CiAgICAgICAgICAgICAgICAkcmVmTm89dW5pcXVlQ29kZSgxOCwkcHJlZml4LCdnb29kc19yZWNlaXZlZF9pdGVtc19zdG9ja19pbicsJ2lkJyk7CgogICAgICAgICAgICAgICAgJEdSSXRlbXNTdG9ja0luID0gbmV3IEdvb2RzUmVjZWl2ZWRJdGVtU3RvY2tJbigpOwogICAgICAgICAgICAgICAgJEdSSXRlbXNTdG9ja0luLT5wdXJjaGFzZV9vcmRlcl9pZCA9ICRtb2RlbC0+cmVsR29vZHNSZWNlaXZlZE5vdGUtPnB1cmNoYXNlX29yZGVyX2lkOwogICAgICAgICAgICAgICAgJEdSSXRlbXNTdG9ja0luLT5nb29kc19yZWNlaXZlZF9pdGVtX2lkID0gJG1vZGVsLT5pZDsKICAgICAgICAgICAgICAgICRHUkl0ZW1zU3RvY2tJbi0+cmVmZXJlbmNlX25vID0gJHJlZk5vOwogICAgICAgICAgICAgICAgJEdSSXRlbXNTdG9ja0luLT51bml0X2Ftb3VudCA9ICRtb2RlbC0+dW5pdF9hbW91bnQ7CiAgICAgICAgICAgICAgICAkR1JJdGVtc1N0b2NrSW4tPnJlY2VpdmVkX3F0eSA9ICRtb2RlbC0+cXR5OwogICAgICAgICAgICAgICAgJEdSSXRlbXNTdG9ja0luLT5zdWJfdG90YWwgPSAkbW9kZWwtPnN1Yl90b3RhbDsKICAgICAgICAgICAgICAgICRHUkl0ZW1zU3RvY2tJbi0+ZGlzY291bnRfcGVyY2VudGFnZSA9ICRtb2RlbC0+ZGlzY291bnRfcGVyY2VudGFnZTsKICAgICAgICAgICAgICAgICRHUkl0ZW1zU3RvY2tJbi0+ZGlzY291bnQgPSAkbW9kZWwtPmRpc2NvdW50OwogICAgICAgICAgICAgICAgJEdSSXRlbXNTdG9ja0luLT52YXRfcGVyY2VudGFnZSA9ICRtb2RlbC0+dmF0X3BlcmNlbnRhZ2U7CiAgICAgICAgICAgICAgICAkR1JJdGVtc1N0b2NrSW4tPnZhdCA9ICRtb2RlbC0+dmF0OwogICAgICAgICAgICAgICAgJEdSSXRlbXNTdG9ja0luLT50b3RhbF9hbW91bnQgPSAkbW9kZWwtPnRvdGFsX2Ftb3VudDsKICAgICAgICAgICAgICAgICRHUkl0ZW1zU3RvY2tJbi0+aXNfZ3JuX2NvbXBsZXRlID0gJ25vJzsKICAgICAgICAgICAgICAgICRHUkl0ZW1zU3RvY2tJbi0+c2F2ZSgpOwoKICAgICAgICAgICAgICAgIGlmKCRtb2RlbC0+cmVsR29vZHNSZWNlaXZlZE5vdGUtPnJlbFB1cmNoYXNlT3JkZXItPnB1cmNoYXNlT3JkZXJSZXF1aXNpdGlvbnMtPmZpcnN0KCktPnJlcXVpc2l0aW9uLT5hdXRob3JfaWQgPT0gYXV0aCgpLT51c2VyKCktPmlkKXsKICAgICAgICAgICAgICAgICAgICAkdGhpcy0+cHJvY2Vzc1NlbGZHUk4oJEdSSXRlbXNTdG9ja0luKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAkbWVzc2FnZSA9ICc8c3BhbiBjbGFzcz0ibm90aWZpY2F0aW9uLWxpbmtzIiBkYXRhLXNyYz0iJy5yb3V0ZSgncG1zLmdybi5ncm4tcHJvY2Vzcy5zaG93JywkbW9kZWwtPnJlbEdvb2RzUmVjZWl2ZWROb3RlLT5pZCkuJz92aWV3IiBkYXRhLXRpdGxlPSJHYXRlLUluIERldGFpbHMiPlJlZmVyZW5jZSBObzonLiRtb2RlbC0+cmVsR29vZHNSZWNlaXZlZE5vdGUtPnJlZmVyZW5jZV9uby4nLiBXYWl0aW5nIGZvciB0aGUgR1JOLjwvc3Bhbj4nOwoKICAgICAgICAgICAgICAgIENyZWF0ZU9yVXBkYXRlTm90aWZpY2F0aW9uKCRtZXNzYWdlLCd1bnJlYWQnLCcnLGdldE1hbmFnZXJJbmZvKCdTdG9yZS1NYW5hZ2VyJywkbW9kZWwtPnJlbEdvb2RzUmVjZWl2ZWROb3RlLT5yZWxQdXJjaGFzZU9yZGVyLT5ocl91bml0X2lkKSwnc2VuZC10by1zdG9yZScpOwoKICAgICAgICAgICAgICAgIENyZWF0ZU9yVXBkYXRlTm90aWZpY2F0aW9uKCRtZXNzYWdlLCd1bnJlYWQnLCcnLGdldE1hbmFnZXJJbmZvKCdQdXJjaGFzZS1EZXBhcnRtZW50JyksJ3NlbnQtdG8tcHVyY2hhc2UnLCcnKTsKCiAgICAgICAgICAgICAgICAkdGhpcy0+dXBkYXRlUUNRdWFudGl0eSgkbW9kZWwtPmlkLCAkbW9kZWwtPnF0eSk7CgogICAgICAgICAgICAgICAgREI6OmNvbW1pdCgpOwoKICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAnbmV3X3RleHQnID0+ICRuZXdUZXh0LAogICAgICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAnU3VjY2Vzc2Z1bGx5IFVwZGF0ZWQgdGhpcyBJdGVtIFF1YWxpdHkgU3RhdHVzISEnCiAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgICAgICBEQjo6cm9sbGJhY2soKTsKICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgJ21lc3NhZ2UnID0+ICR0aC0+Z2V0TWVzc2FnZSgpCiAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgfQoKICAgICAgICB9ZWxzZWlmKGlzc2V0KCRtb2RlbC0+aWQpICYmICRyZXF1ZXN0LT5xdWFsaXR5X2Vuc3VyZSA9PT0gJ3JldHVybi1jaGFuZ2UnIHx8ICRyZXF1ZXN0LT5xdWFsaXR5X2Vuc3VyZSA9PT0gJ3JldHVybicpewoKICAgICAgICAgICAgaWYgKCgkbW9kZWwtPnF0eSkgPCAkcmVxdWVzdC0+cmV0dXJuX3F0eSkgewogICAgICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aFdhcm5pbmcoJ1lvdXIgcmV0dXJuIHF0eSBpcyBncmVhdGVyIHRoZW4gbWF4aW11bSBxdHknKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCRyZXF1ZXN0LT5yZXR1cm5fcXR5IDw9IDApIHsKICAgICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aFdhcm5pbmcoJ01pbmltdW0gT25lIGl0ZW0gaXMgcmVxdWlyZWQnKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgJGNvZGU9KCRyZXF1ZXN0LT5xdWFsaXR5X2Vuc3VyZT09J3JldHVybi1jaGFuZ2UnPydRRS1SUC0nOidRRS1SVC0nKTsKCiAgICAgICAgICAgICRwcmVmaXg9JGNvZGUuZGF0ZSgneScsIHN0cnRvdGltZShkYXRlKCdZLW0tZCcpKSkuJy0nLihhdXRoKCktPnVzZXIoKS0+ZW1wbG95ZWUtPnVuaXQtPmhyX3VuaXRfc2hvcnRfbmFtZSkuJy0nOwogICAgICAgICAgICAkcmVmTm89dW5pcXVlQ29kZSgxOCwkcHJlZml4LCdnb29kc19yZWNlaXZlZF9pdGVtc19zdG9ja19pbicsJ2lkJyk7CgogICAgICAgICAgICBpZigkcmVxdWVzdC0+cXVhbGl0eV9lbnN1cmU9PSdyZXR1cm4tY2hhbmdlJyl7CiAgICAgICAgICAgICAgICAkcHVyY2hhc2VSZXR1cm5Db2RlUHJlZml4ID0gJ1JQLScuZGF0ZSgneScsIHN0cnRvdGltZShkYXRlKCdZLW0tZCcpKSkuJy0nLihhdXRoKCktPnVzZXIoKS0+ZW1wbG95ZWUtPnVuaXQtPmhyX3VuaXRfc2hvcnRfbmFtZSkuJy0nOwogICAgICAgICAgICAgICAgJHByZXYgPSBQdXJjaGFzZVJldHVybjo6d2hlcmVIYXMoJ3JlbEdvb2RzUmVjZWl2ZWRJdGVtcy5yZWxHb29kc1JlY2VpdmVkTm90ZScsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRtb2RlbCl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2lkJywgJG1vZGVsLT5nb29kc19yZWNlaXZlZF9ub3RlX2lkKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPndoZXJlKCdzdGF0dXMnLCAncmV0dXJuLWNoYW5nZScpCiAgICAgICAgICAgICAgICAtPmZpcnN0KCk7CiAgICAgICAgICAgICAgICBpZihpc3NldCgkcHJldi0+aWQpKXsKICAgICAgICAgICAgICAgICAgICAkcHVyY2hhc2VSZXR1cm5Db2RlID0gJHByZXYtPmNvZGU7CiAgICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICAgICAkcHVyY2hhc2VSZXR1cm5Db2RlID0gdW5pcXVlQ29kZSgxNiwkcHVyY2hhc2VSZXR1cm5Db2RlUHJlZml4LCdwdXJjaGFzZV9yZXR1cm5zJywnaWQnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAkcHVyY2hhc2VSZXR1cm5Db2RlUHJlZml4ID0gJ1JULScuZGF0ZSgneScsIHN0cnRvdGltZShkYXRlKCdZLW0tZCcpKSkuJy0nLihhdXRoKCktPnVzZXIoKS0+ZW1wbG95ZWUtPnVuaXQtPmhyX3VuaXRfc2hvcnRfbmFtZSkuJy0nOwogICAgICAgICAgICAgICAgJHByZXYgPSBQdXJjaGFzZVJldHVybjo6d2hlcmVIYXMoJ3JlbEdvb2RzUmVjZWl2ZWRJdGVtcy5yZWxHb29kc1JlY2VpdmVkTm90ZScsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRtb2RlbCl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2lkJywgJG1vZGVsLT5nb29kc19yZWNlaXZlZF9ub3RlX2lkKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPndoZXJlKCdzdGF0dXMnLCAncmV0dXJuJykKICAgICAgICAgICAgICAgIC0+Zmlyc3QoKTsKICAgICAgICAgICAgICAgIGlmKGlzc2V0KCRwcmV2LT5pZCkpewogICAgICAgICAgICAgICAgICAgICRwdXJjaGFzZVJldHVybkNvZGUgPSAkcHJldi0+Y29kZTsKICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgICRwdXJjaGFzZVJldHVybkNvZGUgPSB1bmlxdWVDb2RlKDE2LCRwdXJjaGFzZVJldHVybkNvZGVQcmVmaXgsJ3B1cmNoYXNlX3JldHVybnMnLCdpZCcpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBEQjo6YmVnaW5UcmFuc2FjdGlvbigpOwogICAgICAgICAgICB0cnl7CiAgICAgICAgICAgICAgICAkdXBkYXRlID0gJG1vZGVsLT51cGRhdGUoWwogICAgICAgICAgICAgICAgICAgICdxdWFsaXR5X2Vuc3VyZScgPT4gJHJlcXVlc3QtPnF1YWxpdHlfZW5zdXJlLAogICAgICAgICAgICAgICAgICAgICdyZWNlaXZlZF9xdHknID0+ICAkbW9kZWwtPnF0eS0kcmVxdWVzdC0+cmV0dXJuX3F0eSwKICAgICAgICAgICAgICAgICAgICAndXBkYXRlZF9hdCcgPT4gZGF0ZSgnWS1tLWQgSDppOnMnKSwKICAgICAgICAgICAgICAgICAgICAndXBkYXRlZF9ieScgPT4gQXV0aDo6dXNlcigpLT5pZAogICAgICAgICAgICAgICAgXSk7CgogICAgICAgICAgICAgICAgaWYgKCR1cGRhdGUpIHsKICAgICAgICAgICAgICAgICAgICBQdXJjaGFzZVJldHVybjo6Y3JlYXRlKFsKICAgICAgICAgICAgICAgICAgICAgICAgJ2dvb2RzX3JlY2VpdmVkX2l0ZW1faWQnPT4kbW9kZWwtPmlkLAogICAgICAgICAgICAgICAgICAgICAgICAnY29kZScgPT4gJHB1cmNoYXNlUmV0dXJuQ29kZSwKICAgICAgICAgICAgICAgICAgICAgICAgJ3JldHVybl9ub3RlJyA9PiAkcmVxdWVzdC0+cmV0dXJuX25vdGUsCiAgICAgICAgICAgICAgICAgICAgICAgICdyZXR1cm5fcXR5JyA9PiAkcmVxdWVzdC0+cmV0dXJuX3F0eSwKICAgICAgICAgICAgICAgICAgICAgICAgJ3N0YXR1cycgPT4gJHJlcXVlc3QtPnF1YWxpdHlfZW5zdXJlLAogICAgICAgICAgICAgICAgICAgIF0pOwoKICAgICAgICAgICAgICAgICAgICAvL3N1YnRvdGFsLHJlY2VpdmVkX3F0eSxkaXNjb3VudF9hbW91bnQsdmF0X2Ftb3VudAogICAgICAgICAgICAgICAgICAgICRyZWNlaXZlZFF0eT0kbW9kZWwtPnF0eS0kcmVxdWVzdC0+cmV0dXJuX3F0eTsKICAgICAgICAgICAgICAgICAgICBpZigkcmVjZWl2ZWRRdHkgPiAwKXsKICAgICAgICAgICAgICAgICAgICAgICAgJHN1YnRvdGFsPSRyZWNlaXZlZFF0eSokbW9kZWwtPnVuaXRfYW1vdW50OwogICAgICAgICAgICAgICAgICAgICAgICAkZGlzY291bnRBbW91bnQ9ICgkbW9kZWwtPmRpc2NvdW50X3BlcmNlbnRhZ2UgKiAkc3VidG90YWwpLzEwMDsKICAgICAgICAgICAgICAgICAgICAgICAgJHZhdEFtb3VudD0gKCRtb2RlbC0+dmF0X3BlcmNlbnRhZ2UgKiAkc3VidG90YWwpLzEwMDsKCiAgICAgICAgICAgICAgICAgICAgICAgICRHUkl0ZW1zU3RvY2tJbiA9IG5ldyBHb29kc1JlY2VpdmVkSXRlbVN0b2NrSW4oKTsKICAgICAgICAgICAgICAgICAgICAgICAgJEdSSXRlbXNTdG9ja0luLT5wdXJjaGFzZV9vcmRlcl9pZCA9ICRtb2RlbC0+cmVsR29vZHNSZWNlaXZlZE5vdGUtPnB1cmNoYXNlX29yZGVyX2lkOwogICAgICAgICAgICAgICAgICAgICAgICAkR1JJdGVtc1N0b2NrSW4tPnJlZmVyZW5jZV9ubyA9ICRyZWZObzsKICAgICAgICAgICAgICAgICAgICAgICAgJEdSSXRlbXNTdG9ja0luLT5nb29kc19yZWNlaXZlZF9pdGVtX2lkID0gJG1vZGVsLT5pZDsKICAgICAgICAgICAgICAgICAgICAgICAgJEdSSXRlbXNTdG9ja0luLT51bml0X2Ftb3VudCA9ICRtb2RlbC0+dW5pdF9hbW91bnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICRHUkl0ZW1zU3RvY2tJbi0+cmVjZWl2ZWRfcXR5ID0gJHJlY2VpdmVkUXR5OwogICAgICAgICAgICAgICAgICAgICAgICAkR1JJdGVtc1N0b2NrSW4tPnN1Yl90b3RhbCA9ICRzdWJ0b3RhbDsKICAgICAgICAgICAgICAgICAgICAgICAgJEdSSXRlbXNTdG9ja0luLT5kaXNjb3VudF9wZXJjZW50YWdlID0gJG1vZGVsLT5kaXNjb3VudF9wZXJjZW50YWdlOwogICAgICAgICAgICAgICAgICAgICAgICAkR1JJdGVtc1N0b2NrSW4tPmRpc2NvdW50ID0gJGRpc2NvdW50QW1vdW50OwogICAgICAgICAgICAgICAgICAgICAgICAkR1JJdGVtc1N0b2NrSW4tPnZhdF9wZXJjZW50YWdlID0gJG1vZGVsLT52YXRfcGVyY2VudGFnZTsKICAgICAgICAgICAgICAgICAgICAgICAgJEdSSXRlbXNTdG9ja0luLT52YXQgPSAkdmF0QW1vdW50OwogICAgICAgICAgICAgICAgICAgICAgICAkR1JJdGVtc1N0b2NrSW4tPnRvdGFsX2Ftb3VudCA9ICgkc3VidG90YWwtJGRpc2NvdW50QW1vdW50KSskdmF0QW1vdW50OwogICAgICAgICAgICAgICAgICAgICAgICAkR1JJdGVtc1N0b2NrSW4tPmlzX2dybl9jb21wbGV0ZSA9ICdubyc7CiAgICAgICAgICAgICAgICAgICAgICAgICRHUkl0ZW1zU3RvY2tJbi0+c2F2ZSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYoJG1vZGVsLT5yZWxHb29kc1JlY2VpdmVkTm90ZS0+cmVsUHVyY2hhc2VPcmRlci0+cHVyY2hhc2VPcmRlclJlcXVpc2l0aW9ucy0+Zmlyc3QoKS0+cmVxdWlzaXRpb24tPmF1dGhvcl9pZCA9PSBhdXRoKCktPnVzZXIoKS0+aWQpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHRoaXMtPnByb2Nlc3NTZWxmR1JOKCRHUkl0ZW1zU3RvY2tJbik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICghZW1wdHkoJHJlcXVlc3QtPmZhcV9pZCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yZWFjaCAoJHJlcXVlc3QtPmZhcV9pZCBhcyAka2V5ID0+ICRmYXFfaWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFJldHVybkNoYW5nZUZhcTo6Y3JlYXRlKFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZmFxX2lkJz0+JGZhcV9pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZ29vZHNfcmVjZWl2ZWRfaXRlbV9pZCc9PiRtb2RlbC0+aWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAkbWVzc2FnZSA9ICc8c3BhbiBjbGFzcz0ibm90aWZpY2F0aW9uLWxpbmtzIiBkYXRhLXNyYz0iJy5yb3V0ZSgncG1zLmdybi5ncm4tcHJvY2Vzcy5zaG93JywkbW9kZWwtPnJlbEdvb2RzUmVjZWl2ZWROb3RlLT5pZCkuJz92aWV3IiBkYXRhLXRpdGxlPSJHYXRlLUluIERldGFpbHMiPlJlZmVyZW5jZSBObzonLiRtb2RlbC0+cmVsR29vZHNSZWNlaXZlZE5vdGUtPnJlZmVyZW5jZV9uby4nLiBXYWl0aW5nIGZvciB0aGUgR1JOLjwvc3Bhbj4nOwoKICAgICAgICAgICAgICAgIENyZWF0ZU9yVXBkYXRlTm90aWZpY2F0aW9uKCRtZXNzYWdlLCd1bnJlYWQnLCcnLGdldE1hbmFnZXJJbmZvKCdTdG9yZS1NYW5hZ2VyJywkbW9kZWwtPnJlbEdvb2RzUmVjZWl2ZWROb3RlLT5yZWxQdXJjaGFzZU9yZGVyLT5ocl91bml0X2lkKSwnc2VuZC10by1zdG9yZScpOwoKICAgICAgICAgICAgICAgIENyZWF0ZU9yVXBkYXRlTm90aWZpY2F0aW9uKCRtZXNzYWdlLCd1bnJlYWQnLCcnLGdldE1hbmFnZXJJbmZvKCdQdXJjaGFzZS1EZXBhcnRtZW50JyksJ3NlbnQtdG8tcHVyY2hhc2UnLCcnKTsKCiAgICAgICAgICAgICAgICAkdGhpcy0+dXBkYXRlUUNRdWFudGl0eSgkbW9kZWwtPmlkLCAkcmVjZWl2ZWRRdHkpOwogICAgICAgICAgICAgICAgREI6OmNvbW1pdCgpOwoKICAgICAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhTdWNjZXNzKCdTdWNjZXNzZnVsbHkgVXBkYXRlZCB0aGlzIEl0ZW0gUXVhbGl0eSBTdGF0dXMhIScpOwoKICAgICAgICAgICAgfWNhdGNoIChUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgICAgIERCOjpyb2xsYmFjaygpOwogICAgICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGJhY2soKTsKICAgIH0KCiAgICBwdWJsaWMgZnVuY3Rpb24gdXBkYXRlUUNRdWFudGl0eSgkZ29vZHNfcmVjZWl2ZWRfaXRlbV9pZCwgJHFjX3F0eSkKICAgIHsKICAgICAgICBpZigkcWNfcXR5ID4gMCl7CiAgICAgICAgICAgICRhcnJheSA9IFtdOwoKICAgICAgICAgICAgLy9QTyBHZW5lcmF0ZSBFcXVhbGx5IGRpc3RyaWJ1dGUKICAgICAgICAgICAgJGdvb2RzUmVjZWl2ZWRJdGVtID0gR29vZHNSZWNlaXZlZEl0ZW06OmZpbmQoJGdvb2RzX3JlY2VpdmVkX2l0ZW1faWQpOwogICAgICAgICAgICAkcmVxdWlzaXRpb25fcXR5ID0gUmVxdWlzaXRpb25JdGVtOjp3aGVyZSgncHJvZHVjdF9pZCcsICRnb29kc1JlY2VpdmVkSXRlbS0+cHJvZHVjdF9pZCkKICAgICAgICAgICAgLT53aGVyZUhhcygncmVxdWlzaXRpb24ucHVyY2hhc2VPcmRlcnMucHVyY2hhc2VPcmRlci5yZWxHb29kUmVjZWl2ZU5vdGUnLCBmdW5jdGlvbigkcXVlcnkpIHVzZSgkZ29vZHNSZWNlaXZlZEl0ZW0pewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2lkJywgJGdvb2RzUmVjZWl2ZWRJdGVtLT5nb29kc19yZWNlaXZlZF9ub3RlX2lkKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT5zdW0oJ3F0eScpOwogICAgICAgICAgICAkcGVyY2VudGFnZSA9ICgkcmVxdWlzaXRpb25fcXR5ID4gMCAmJiAkcWNfcXR5ID4gMCA/ICgoJHFjX3F0eS8kcmVxdWlzaXRpb25fcXR5KSoxMDApIDogMCk7CgogICAgICAgICAgICAvL2FycmF5X3B1c2goJGFycmF5LCAkcGVyY2VudGFnZSk7CgogICAgICAgICAgICAkcmVxdWlzaXRpb25zID0gJGdvb2RzUmVjZWl2ZWRJdGVtLT5yZWxHb29kc1JlY2VpdmVkTm90ZS0+cmVsUHVyY2hhc2VPcmRlci0+cHVyY2hhc2VPcmRlclJlcXVpc2l0aW9ucy0+cGx1Y2soJ3JlcXVpc2l0aW9uX2lkJyktPnRvQXJyYXkoKTsKICAgICAgICAgICAgJHJlcXVpc2l0aW9uSXRlbXMgPSBSZXF1aXNpdGlvbkl0ZW06OndoZXJlSW4oJ3JlcXVpc2l0aW9uX2lkJywgJHJlcXVpc2l0aW9ucyktPndoZXJlKCdwcm9kdWN0X2lkJywgJGdvb2RzUmVjZWl2ZWRJdGVtLT5wcm9kdWN0X2lkKS0+Z2V0KCk7CiAgICAgICAgICAgIGlmKGlzc2V0KCRyZXF1aXNpdGlvbkl0ZW1zWzBdKSl7CiAgICAgICAgICAgICAgICBmb3JlYWNoKCRyZXF1aXNpdGlvbkl0ZW1zIGFzICRrZXkgPT4gJHJlcXVpc2l0aW9uSXRlbSl7CiAgICAgICAgICAgICAgICAgICAgaWYoJHFjX3F0eT4wKXsKICAgICAgICAgICAgICAgICAgICAgICAgJHRoaXNfcWNfcXR5ID0gcm91bmQoKCRwZXJjZW50YWdlID4gMCA/ICgkcmVxdWlzaXRpb25JdGVtLT5xdHkqKCRwZXJjZW50YWdlLzEwMCkpIDogMCkpOwogICAgICAgICAgICAgICAgICAgICAgICAkdGhpc19xY19xdHkgPSAoJHRoaXNfcWNfcXR5ID4gJHFjX3F0eSA/ICRxY19xdHkgOiAkdGhpc19xY19xdHkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gYXJyYXlfcHVzaCgkYXJyYXksIFsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgICdwZXJjZW50YWdlJyA9PiAkcGVyY2VudGFnZSwKICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgICdyJyA9PiAkcmVxdWlzaXRpb25JdGVtLT5xdHksCiAgICAgICAgICAgICAgICAgICAgICAgIC8vICAgICAncScgPT4gJHRoaXNfcWNfcXR5CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIF0pOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9uSXRlbS0+cWNfcXR5ID0gJHRoaXNfcWNfcXR5OwogICAgICAgICAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb25JdGVtLT5zYXZlKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAkcWNfcXR5ID0gKCRxY19xdHkgLSAkdGhpc19xY19xdHkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmKCRxY19xdHk+MCl7CiAgICAgICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9uSXRlbSA9IFJlcXVpc2l0aW9uSXRlbTo6d2hlcmVJbigncmVxdWlzaXRpb25faWQnLCAkcmVxdWlzaXRpb25zKS0+d2hlcmUoJ3Byb2R1Y3RfaWQnLCAkZ29vZHNSZWNlaXZlZEl0ZW0tPnByb2R1Y3RfaWQpLT5maXJzdCgpOwogICAgICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbkl0ZW0tPnFjX3F0eSA9ICgkcmVxdWlzaXRpb25JdGVtLT5xY19xdHkrcm91bmQoJHFjX3F0eSkpOwogICAgICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbkl0ZW0tPnNhdmUoKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gYXJyYXlfcHVzaCgkYXJyYXksIFsKICAgICAgICAgICAgICAgICAgICAvLyAgICAgJ3BlcmNlbnRhZ2UnID0+ICRwZXJjZW50YWdlLAogICAgICAgICAgICAgICAgICAgIC8vICAgICAncicgPT4gJHJlcXVpc2l0aW9uSXRlbS0+cXR5LAogICAgICAgICAgICAgICAgICAgIC8vICAgICAncScgPT4gcm91bmQoJHFjX3F0eSksCiAgICAgICAgICAgICAgICAgICAgLy8gICAgICdlJyA9PiB0cnVlCiAgICAgICAgICAgICAgICAgICAgLy8gXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy9QTyBHZW5lcmF0ZSBFcXVhbGx5IGRpc3RyaWJ1dGUKICAgICAgICAgICAgLy9yZXR1cm4gJGFycmF5OwogICAgICAgIH0KICAgIH0KCgogICAgLyoqCiAgICAqIFNob3cgdGhlIEdybiBXaXNlIEFwcHJvdmVkIEl0ZW0gTGlzdC4KICAgICoKICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAqLwoKICAgIHB1YmxpYyBmdW5jdGlvbiBncm5XaXNlQXBwcm92ZWRJdGVtTGlzdCgkaWQpCiAgICB7CiAgICAgICAgdHJ5ewogICAgICAgICAgICAkdGl0bGU9IlF1YWxpdHkgRW5zdXJlIEFwcHJvdmFsIExpc3QiOwogICAgICAgICAgICAkZ3JuID0gR29vZHNSZWNlaXZlZE5vdGU6OmZpbmQoJGlkKTsKICAgICAgICAgICAgJGdvb2RzUmVjZWl2ZWRJdGVtSWQgPSBHb29kc1JlY2VpdmVkSXRlbTo6d2hlcmUoJ2dvb2RzX3JlY2VpdmVkX25vdGVfaWQnLCRpZCktPndoZXJlKCdxdWFsaXR5X2Vuc3VyZScsJ2FwcHJvdmVkJyktPnBsdWNrKCdpZCcpLT5hbGwoKTsKCiAgICAgICAgICAgICRhcHByb3ZhbF9saXN0ID0gR29vZHNSZWNlaXZlZEl0ZW1TdG9ja0luOjp3aXRoKFsKICAgICAgICAgICAgICAgICdyZWxHb29kc1JlY2VpdmVkSXRlbXMucmVsUHJvZHVjdC5hdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGUnLAogICAgICAgICAgICAgICAgJ3JlbEdvb2RzUmVjZWl2ZWRJdGVtcy5hdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGUnLAogICAgICAgICAgICBdKS0+d2hlcmVJbignZ29vZHNfcmVjZWl2ZWRfaXRlbV9pZCcsJGdvb2RzUmVjZWl2ZWRJdGVtSWQpLT5vcmRlckJ5KCdpZCcsJ2Rlc2MnKS0+cGFnaW5hdGUoMzApOwogICAgICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMucXVhbGl0eS5hcHByb3ZlZC1saXN0Jyxjb21wYWN0KCd0aXRsZScsJ2FwcHJvdmFsX2xpc3QnLCAnZ3JuJykpOwogICAgICAgIH1jYXRjaChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiByZXR1cm5MaXN0SGVhZGVyQ29sdW1ucygkdmFsdWU9JycpCiAgICB7CiAgICAgICAgcmV0dXJuIGFycmF5KAogICAgICAgICAgICBbJ1NMJywgJ1NMJ10sCiAgICAgICAgICAgIFsnUE9fcmVmZXJlbmNlJywgJ1BPX3JlZmVyZW5jZScsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ1BPX2RhdGUnLCAnUE9fZGF0ZScsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3JlcXVpc2l0aW9ucycsICdyZXF1aXNpdGlvbnMnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydjaGFsbGFuJywgJ2NoYWxsYW4nLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydnYXRlX2luX3JlZmVyZW5jZScsICdnYXRlX2luX3JlZmVyZW5jZScsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ2dhdGVfaW5fcXR5JywgJ2dhdGVfaW5fcXR5JywgJ3RleHQtcmlnaHQnXSwKICAgICAgICAgICAgWydyZXR1cm5fcXR5JywgJ3JldHVybl9xdHknLCAndGV4dC1yaWdodCddLAogICAgICAgICAgICBbJ3JlY2VpdmVkX3N0YXR1cycsICdyZWNlaXZlZF9zdGF0dXMnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydvcHRpb25zJywgJ29wdGlvbnMnLCd0ZXh0LWNlbnRlciddLAogICAgICAgICk7CiAgICB9CgogICAgLyoqCiAgICAqIFNob3cgdGhlIEdybiBXaXNlIFJldHVybiBMaXN0LgogICAgKgogICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICovCiAgICBwdWJsaWMgZnVuY3Rpb24gcmV0dXJubExpc3QoKQogICAgewogICAgICAgIHRyeXsKICAgICAgICAgICAgaWYgKHJlcXVlc3QoKS0+YWpheCgpKSB7CiAgICAgICAgICAgICAgICAkdXNlclVuaXRzID0gYXV0aCgpLT51c2VyKCktPnByaW9yaXRpZXMtPnBsdWNrKCdocl91bml0X2lkJyktPnRvQXJyYXkoKTsKICAgICAgICAgICAgICAgICR1c2VyRGVwYXJ0bWVudHMgPSBhdXRoKCktPnVzZXIoKS0+cHJpb3JpdGllcy0+cGx1Y2soJ2hyX2RlcGFydG1lbnRfaWQnKS0+dG9BcnJheSgpOwogICAgICAgICAgICAgICAgJGl0ZW1zID0gR29vZHNSZWNlaXZlZE5vdGU6OndpdGgoWwogICAgICAgICAgICAgICAgICAgICdyZWxQdXJjaGFzZU9yZGVyLnJlbFB1cmNoYXNlT3JkZXJJdGVtcycsCiAgICAgICAgICAgICAgICAgICAgJ3JlbFB1cmNoYXNlT3JkZXIucHVyY2hhc2VPcmRlclJlcXVpc2l0aW9ucy5yZXF1aXNpdGlvbicsCiAgICAgICAgICAgICAgICAgICAgJ3JlbEdvb2RzUmVjZWl2ZWRJdGVtcycsCiAgICAgICAgICAgICAgICBdKQogICAgICAgICAgICAgICAgLT53aGVyZUhhcygncmVsUHVyY2hhc2VPcmRlcicsIGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2lzX3NlbmQnLCAneWVzJyk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT53aGVuKGlzc2V0KGF1dGgoKS0+dXNlcigpLT5lbXBsb3llZS0+YXNfdW5pdF9pZCksIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCR1c2VyVW5pdHMpewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxQdXJjaGFzZU9yZGVyJywgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJHVzZXJVbml0cyl7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdocl91bml0X2lkJywgJHVzZXJVbml0cyk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLy8gLT53aGVuKGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdEZXBhcnRtZW50LUhlYWQnKSwgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJHVzZXJEZXBhcnRtZW50cyl7CiAgICAgICAgICAgICAgICAvLyAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFB1cmNoYXNlT3JkZXIucHVyY2hhc2VPcmRlclJlcXVpc2l0aW9ucycsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCR1c2VyRGVwYXJ0bWVudHMpewogICAgICAgICAgICAgICAgLy8gICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnaHJfZGVwYXJ0bWVudF9pZCcsICR1c2VyRGVwYXJ0bWVudHMpOwogICAgICAgICAgICAgICAgLy8gICAgIH0pOwogICAgICAgICAgICAgICAgLy8gfSkKICAgICAgICAgICAgICAgIC0+d2hlbighYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ0RlcGFydG1lbnQtSGVhZCcpLCBmdW5jdGlvbigkcXVlcnkpewogICAgICAgICAgICAgICAgICAgIGlmIChhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnRW1wbG95ZWUnKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnaXNfc2VudF90b19yZXF1aXNpdG9yJywgJ3llcycpLT53aGVyZUhhcygncmVsUHVyY2hhc2VPcmRlci5wdXJjaGFzZU9yZGVyUmVxdWlzaXRpb25zLnJlcXVpc2l0aW9uJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnYXV0aG9yX2lkJywgYXV0aCgpLT51c2VyKCktPmlkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUHVyY2hhc2VPcmRlci5wdXJjaGFzZU9yZGVyUmVxdWlzaXRpb25zJywgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2hyX2RlcGFydG1lbnRfaWQnLCAwKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPndoZW4oYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ0VtcGxveWVlJyksIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUHVyY2hhc2VPcmRlci5wdXJjaGFzZU9yZGVyUmVxdWlzaXRpb25zLnJlcXVpc2l0aW9uJywgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnYXV0aG9yX2lkJywgYXV0aCgpLT51c2VyKCktPmlkKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPndoZXJlSGFzKCdyZWxHb29kc1JlY2VpdmVkSXRlbXMnLCBmdW5jdGlvbigkcXVlcnkpewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdxdWFsaXR5X2Vuc3VyZScsJ3JldHVybicpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+d2hlbighZGF0YXRhYmxlT3JkZXJpbmcoKSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT5vcmRlcmJ5KCdyZWNlaXZlZF9kYXRlJywgJ2Rlc2MnKTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIHJldHVybiBEYXRhVGFibGVzOjpvZigkaXRlbXMpCiAgICAgICAgICAgICAgICAgICAgLT5hZGRJbmRleENvbHVtbigpCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ1BPX3JlZmVyZW5jZScsIGZ1bmN0aW9uKCRncm4pewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgY2xhc3M9ImJ0biBidG4tbGluayIgb25jbGljaz0icHVyY2hhc2VPcmRlckRldGFpbHMoJCh0aGlzKSkiIGRhdGEtc3JjPSInLnJvdXRlKCdwbXMucHVyY2hhc2Uub3JkZXItbGlzdC5zaG93JywgJGdybi0+cmVsUHVyY2hhc2VPcmRlci0+aWQpLiciIGRhdGEtdGl0bGU9IlB1cmNoYXNlIE9yZGVyIERldGFpbHMiPicuJGdybi0+cmVsUHVyY2hhc2VPcmRlci0+cmVmZXJlbmNlX25vLicKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvYT4nOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ1BPX3JlZmVyZW5jZScsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxQdXJjaGFzZU9yZGVyJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdyZWZlcmVuY2Vfbm8nLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ1BPX3JlZmVyZW5jZScsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBQdXJjaGFzZU9yZGVyOjpzZWxlY3QoJ3B1cmNoYXNlX29yZGVycy5yZWZlcmVuY2Vfbm8nKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbigncHVyY2hhc2Vfb3JkZXJzLmlkJywgJ2dvb2RzX3JlY2VpdmVkX25vdGVzLnB1cmNoYXNlX29yZGVyX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdQT19kYXRlJywgZnVuY3Rpb24oJGdybil7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkYXRlKCdZLW0tZCcsIHN0cnRvdGltZSgkZ3JuLT5yZWxQdXJjaGFzZU9yZGVyLT5wb19kYXRlKSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbignUE9fZGF0ZScsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxQdXJjaGFzZU9yZGVyJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdwb19kYXRlJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbignUE9fZGF0ZScsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxQdXJjaGFzZU9yZGVyJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdwb19kYXRlJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbigncmVxdWlzaXRpb25zJywgZnVuY3Rpb24gKCRncm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRncm4tPnJlbFB1cmNoYXNlT3JkZXItPnB1cmNoYXNlT3JkZXJSZXF1aXNpdGlvbnMtPnBsdWNrKCdyZXF1aXNpdGlvbi5yZWZlcmVuY2Vfbm8nKS0+aW1wbG9kZSgnLCAnKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdyZXF1aXNpdGlvbnMnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUHVyY2hhc2VPcmRlci5wdXJjaGFzZU9yZGVyUmVxdWlzaXRpb25zLnJlcXVpc2l0aW9uJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgncmVmZXJlbmNlX25vJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbigncmVxdWlzaXRpb25zJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwbGVhc2VTb3J0TWUoJHF1ZXJ5LCAkb3JkZXIsIFB1cmNoYXNlT3JkZXI6OnNlbGVjdCgncmVxdWlzaXRpb25zLnJlZmVyZW5jZV9ubycpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ3JlcXVpc2l0aW9ucycsICdyZXF1aXNpdGlvbnMuaWQnLCAnPScsICdwdXJjaGFzZV9vcmRlcl9yZXF1aXNpdGlvbnMucmVxdWlzaXRpb25faWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdwdXJjaGFzZV9vcmRlcl9yZXF1aXNpdGlvbnMnLCAncHVyY2hhc2Vfb3JkZXJfcmVxdWlzaXRpb25zLnB1cmNoYXNlX29yZGVyX2lkJywgJz0nLCAncHVyY2hhc2Vfb3JkZXJzLmlkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3B1cmNoYXNlX29yZGVycy5pZCcsICdnb29kc19yZWNlaXZlZF9ub3Rlcy5wdXJjaGFzZV9vcmRlcl9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdnYXRlX2luX3JlZmVyZW5jZScsIGZ1bmN0aW9uKCRncm4pewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxkaXYgc3R5bGU9IndpZHRoOiAxMDAlIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0id2lkdGg6IDkwJTtmbG9hdDogbGVmdDtjbGVhcjpyaWdodCI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIGNsYXNzPSJidG4gYnRuLWxpbmsiIG9uY2xpY2s9InNob3dRRVBPRGV0YWlscygkKHRoaXMpKSIgZGF0YS1zcmM9Iicucm91dGUoJ3Btcy5ncm4uZ3JuLXByb2Nlc3Muc2hvdycsJGdybi0+aWQpLiciIGRhdGEtdGl0bGU9IkdhdGUgSW4gRGV0YWlscyI+Jy4kZ3JuLT5yZWZlcmVuY2Vfbm8uJzwvYT4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9IndpZHRoOiAxMCU7ZmxvYXQ6IGxlZnQ7Y2xlYXI6cmlnaHQiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGEgY2xhc3M9ImJ0biBidG4tcHJpbWFyeSBidG4teHMiIGhyZWY9IicuIHVybCgncG1zL2dybi9nYXRlLWluLXNsaXAvJy4kZ3JuLT5wdXJjaGFzZV9vcmRlcl9pZC4nP2dybj0nLiRncm4tPmlkKSAuJyIgdGFyZ2V0PSJfYmxhbmsiIHN0eWxlPSJtYXJnaW4tdG9wOiA3LjVweCI+PGkgY2xhc3M9ImxhIGxhLXByaW50Ij48L2k+PC9hPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4nOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ2dhdGVfaW5fcmVmZXJlbmNlJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgncmVmZXJlbmNlX25vJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ2dhdGVfaW5fcmVmZXJlbmNlJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyQnkoJ3JlZmVyZW5jZV9ubycsICRvcmRlcik7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignZ2F0ZV9pbl9xdHknLCBmdW5jdGlvbigkZ3JuKXsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRncm4tPnJlbEdvb2RzUmVjZWl2ZWRJdGVtcy0+c3VtKCdxdHknKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdyZXR1cm5fcXR5JywgZnVuY3Rpb24oJGdybil7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkZ3JuLT5yZWxHb29kc1JlY2VpdmVkSXRlbXMtPnN1bSgncXR5Jyk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmVkaXRDb2x1bW4oJ3JlY2VpdmVkX3N0YXR1cycsIGZ1bmN0aW9uKCRncm4pewogICAgICAgICAgICAgICAgICAgICAgICBpZigkZ3JuLT5yZWNlaXZlZF9zdGF0dXMgPT0gJ3BhcnRpYWwnKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnPGEgY2xhc3M9ImJ0biBidG4td2FybmluZyBidG4teHMiPlBhcnRpYWwgUmVjZWl2ZWQ8L2E+JzsKICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2VpZigkZ3JuLT5yZWNlaXZlZF9zdGF0dXMgPT0gJ2Z1bGwnKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnPGEgY2xhc3M9ImJ0biBidG4tc3VjY2VzcyBidG4teHMiPkZ1bGwgUmVjZWl2ZWQ8L2E+JzsKICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxhIGNsYXNzPSJidG4gYnRuLWRhcmsgYnRuLXhzIj4nLnVjd29yZHMoJGdybi0+cmVjZWl2ZWRfc3RhdHVzKS4nPC9hPic7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdvcHRpb25zJywgZnVuY3Rpb24oJGdybil7CiAgICAgICAgICAgICAgICAgICAgICAgICRyZXR1cm5lZCA9IFB1cmNoYXNlUmV0dXJuOjp3aGVyZUhhcygncmVsR29vZHNSZWNlaXZlZEl0ZW1zJywgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJGdybil7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnZ29vZHNfcmVjZWl2ZWRfbm90ZV9pZCcsICRncm4tPmlkKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSktPndoZXJlKCdzdGF0dXMnLCAncmV0dXJuJyktPnN1bSgncmV0dXJuX3F0eScpOwoKICAgICAgICAgICAgICAgICAgICAgICAgJHJldHVybmVkQ291bnQgPSBQdXJjaGFzZVJldHVybjo6d2hlcmVIYXMoJ3JlbEdvb2RzUmVjZWl2ZWRJdGVtcycsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRncm4pewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2dvb2RzX3JlY2VpdmVkX25vdGVfaWQnLCAkZ3JuLT5pZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pLT53aGVyZSgnc3RhdHVzJywgJ3JldHVybicpLT5jb3VudCgpOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgJGFwcHJvdmVkID0gUHVyY2hhc2VSZXR1cm46OndoZXJlSGFzKCdyZWxHb29kc1JlY2VpdmVkSXRlbXMnLCBmdW5jdGlvbigkcXVlcnkpIHVzZSgkZ3JuKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdnb29kc19yZWNlaXZlZF9ub3RlX2lkJywgJGdybi0+aWQpOwogICAgICAgICAgICAgICAgICAgICAgICB9KS0+d2hlcmUoJ3N0YXR1cycsICdyZXR1cm4nKS0+c3VtKCdyZWNlaXZlZF9xdHknKTsKICAgICAgICAgICAgICAgICAgICAgICAgJG9wdGlvbnMgPSAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoJHJldHVybmVkID4gMCl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkb3B0aW9ucyAuPSAnPGEgaHJlZj0iJy5yb3V0ZSgncG1zLnF1YWxpdHkuZW5zdXJlLnJldHVybi5zaW5nbGUubGlzdCcsJGdybi0+aWQpLiciIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi1pbmZvIj5JdGVtcyAoJy4kcmV0dXJuZWRDb3VudC4nKTwvYT4nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJG9wdGlvbnMgLj0gJyZuYnNwOyZuYnNwOzxhIHRhcmdldD0iX19ibGFuayIgaHJlZj0iJy5yb3V0ZSgncG1zLnF1YWxpdHkucmV0dXJuLml0ZW0ucHJpbnQnLFsnaWQnPT4kZ3JuLT5pZCwndHlwZSc9PidyZXR1cm4nXSkuJyIgY2xhc3M9ImJ0biBidG4teHMgYnRuLXdhcm5pbmciIHRpdGxlPSJSZXR1cm4gTGlzdCI+PGkgY2xhc3M9ImxhcyBsYS1wcmludCI+PC9pPjwvYT4nOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYoJGFwcHJvdmVkID4gMCl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkb3B0aW9ucyAuPSAnJm5ic3A7Jm5ic3A7PGEgdGFyZ2V0PSJfX2JsYW5rIiBocmVmPSInLnJvdXRlKCdwbXMucXVhbGl0eS5yZXR1cm4uaXRlbS5wcmludCcsWydpZCc9PiRncm4tPmlkLCd0eXBlJz0+J3JldHVybi1hcHByb3ZlZC1saXN0J10pLiciIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi1zdWNjZXNzIiB0aXRsZT0iUmV0dXJuIEFwcHJvdmVkIExpc3QiPjxpIGNsYXNzPSJsYXMgbGEtcHJpbnQiPjwvaT48L2E+JzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJG9wdGlvbnM7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPnJhd0NvbHVtbnMoWydQT19yZWZlcmVuY2UnLCAnZ2F0ZV9pbl9yZWZlcmVuY2UnLCAncmVjZWl2ZWRfc3RhdHVzJywgJ29wdGlvbnMnXSkKICAgICAgICAgICAgICAgICAgICAtPm1ha2UodHJ1ZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5xdWFsaXR5LnJldHVybi1pbmRleCcsIFsKICAgICAgICAgICAgICAgICd0aXRsZScgPT4gIlF1YWxpdHkgRW5zdXJlIFJldHVybiBMaXN0IiwKICAgICAgICAgICAgICAgICdoZWFkZXJDb2x1bW5zJyA9PiAkdGhpcy0+cmV0dXJuTGlzdEhlYWRlckNvbHVtbnMoKQogICAgICAgICAgICBdKTsKICAgICAgICB9Y2F0Y2goXFRocm93YWJsZSAkdGgpewogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICogU2hvdyB0aGUgR3JuIFdpc2UgU2luZ2xlIFJldHVybiBJdGVtIExpc3QuCiAgICAqCiAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgKi8KCiAgICBwdWJsaWMgZnVuY3Rpb24gZ3JuV2lzZVJldHVybkl0ZW1MaXN0KCRpZCkKICAgIHsKICAgICAgICB0cnl7CgogICAgICAgICAgICAkdGl0bGU9IlF1YWxpdHkgRW5zdXJlIFJldHVybiBMaXN0IjsKICAgICAgICAgICAgJGdybiA9IEdvb2RzUmVjZWl2ZWROb3RlOjpmaW5kKCRpZCk7CiAgICAgICAgICAgICRnb29kc1JlY2VpdmVkSXRlbUlkID0gR29vZHNSZWNlaXZlZEl0ZW06OndoZXJlKCdnb29kc19yZWNlaXZlZF9ub3RlX2lkJywkaWQpLT53aGVyZSgncXVhbGl0eV9lbnN1cmUnLCdyZXR1cm4nKS0+cGx1Y2soJ2lkJyktPmFsbCgpOwogICAgICAgICAgICAkcmV0dXJuTGlzdCA9IFB1cmNoYXNlUmV0dXJuOjp3aXRoKFsKICAgICAgICAgICAgICAgICdyZWxHb29kc1JlY2VpdmVkSXRlbXMucmVsUHJvZHVjdC5jYXRlZ29yeS5jYXRlZ29yeScsCiAgICAgICAgICAgICAgICAncmVsR29vZHNSZWNlaXZlZEl0ZW1zLnJlbFByb2R1Y3QuYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24uYXR0cmlidXRlJywKICAgICAgICAgICAgICAgICdyZWxHb29kc1JlY2VpdmVkSXRlbXMuYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24uYXR0cmlidXRlJywKICAgICAgICAgICAgXSktPndoZXJlSW4oJ2dvb2RzX3JlY2VpdmVkX2l0ZW1faWQnLCRnb29kc1JlY2VpdmVkSXRlbUlkKS0+b3JkZXJCeSgnaWQnLCdkZXNjJyktPnBhZ2luYXRlKDMwKTsKCiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5xdWFsaXR5LnJldHVybi1saXN0Jyxjb21wYWN0KCd0aXRsZScsJ3JldHVybkxpc3QnLCAnZ3JuJykpOwogICAgICAgIH1jYXRjaChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiByZXR1cm5DaGFuZ2VMaXN0SGVhZGVyQ29sdW1ucygkdmFsdWU9JycpCiAgICB7CiAgICAgICAgcmV0dXJuIGFycmF5KAogICAgICAgICAgICBbJ1NMJywgJ1NMJ10sCiAgICAgICAgICAgIFsnUE9fcmVmZXJlbmNlJywgJ1BPX3JlZmVyZW5jZScsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ1BPX2RhdGUnLCAnUE9fZGF0ZScsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3JlcXVpc2l0aW9ucycsICdyZXF1aXNpdGlvbnMnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydjaGFsbGFuJywgJ2NoYWxsYW4nLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydnYXRlX2luX3JlZmVyZW5jZScsICdnYXRlX2luX3JlZmVyZW5jZScsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ2dhdGVfaW5fcXR5JywgJ2dhdGVfaW5fcXR5JywgJ3RleHQtcmlnaHQnXSwKICAgICAgICAgICAgWydyZXR1cm5fcXR5JywgJ3JldHVybl9xdHknLCAndGV4dC1yaWdodCddLAogICAgICAgICAgICBbJ3JlY2VpdmVkX3N0YXR1cycsICdyZWNlaXZlZF9zdGF0dXMnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydvcHRpb25zJywgJ29wdGlvbnMnLCd0ZXh0LWNlbnRlciddLAogICAgICAgICk7CiAgICB9CgogICAgLyoqCiAgICAqIFNob3cgdGhlIEdybiBXaXNlIFJldHVybiBDaGFuZ2UgTGlzdC4KICAgICoKICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAqLwoKICAgIHB1YmxpYyBmdW5jdGlvbiByZXR1cm5DaGFuZ2VMaXN0KCkKICAgIHsKICAgICAgICB0cnl7CiAgICAgICAgICAgIGlmIChyZXF1ZXN0KCktPmFqYXgoKSkgewogICAgICAgICAgICAgICAgJHVzZXJVbml0cyA9IGF1dGgoKS0+dXNlcigpLT5wcmlvcml0aWVzLT5wbHVjaygnaHJfdW5pdF9pZCcpLT50b0FycmF5KCk7CiAgICAgICAgICAgICAgICAkdXNlckRlcGFydG1lbnRzID0gYXV0aCgpLT51c2VyKCktPnByaW9yaXRpZXMtPnBsdWNrKCdocl9kZXBhcnRtZW50X2lkJyktPnRvQXJyYXkoKTsKICAgICAgICAgICAgICAgICRpdGVtcyA9IEdvb2RzUmVjZWl2ZWROb3RlOjp3aXRoKFsKICAgICAgICAgICAgICAgICAgICAncmVsUHVyY2hhc2VPcmRlci5yZWxQdXJjaGFzZU9yZGVySXRlbXMnLAogICAgICAgICAgICAgICAgICAgICdyZWxQdXJjaGFzZU9yZGVyLnB1cmNoYXNlT3JkZXJSZXF1aXNpdGlvbnMucmVxdWlzaXRpb24nLAogICAgICAgICAgICAgICAgICAgICdyZWxHb29kc1JlY2VpdmVkSXRlbXMnCiAgICAgICAgICAgICAgICBdKQogICAgICAgICAgICAgICAgLT53aGVyZUhhcygncmVsUHVyY2hhc2VPcmRlcicsIGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2lzX3NlbmQnLCAneWVzJyk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT53aGVuKGlzc2V0KGF1dGgoKS0+dXNlcigpLT5lbXBsb3llZS0+YXNfdW5pdF9pZCksIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCR1c2VyVW5pdHMpewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxQdXJjaGFzZU9yZGVyJywgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJHVzZXJVbml0cyl7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdocl91bml0X2lkJywgJHVzZXJVbml0cyk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLy8gLT53aGVuKGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdEZXBhcnRtZW50LUhlYWQnKSwgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJHVzZXJEZXBhcnRtZW50cyl7CiAgICAgICAgICAgICAgICAvLyAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFB1cmNoYXNlT3JkZXIucHVyY2hhc2VPcmRlclJlcXVpc2l0aW9ucycsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCR1c2VyRGVwYXJ0bWVudHMpewogICAgICAgICAgICAgICAgLy8gICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnaHJfZGVwYXJ0bWVudF9pZCcsICR1c2VyRGVwYXJ0bWVudHMpOwogICAgICAgICAgICAgICAgLy8gICAgIH0pOwogICAgICAgICAgICAgICAgLy8gfSkKICAgICAgICAgICAgICAgIC0+d2hlbighYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ0RlcGFydG1lbnQtSGVhZCcpLCBmdW5jdGlvbigkcXVlcnkpewogICAgICAgICAgICAgICAgICAgIGlmIChhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnRW1wbG95ZWUnKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnaXNfc2VudF90b19yZXF1aXNpdG9yJywgJ3llcycpLT53aGVyZUhhcygncmVsUHVyY2hhc2VPcmRlci5wdXJjaGFzZU9yZGVyUmVxdWlzaXRpb25zLnJlcXVpc2l0aW9uJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnYXV0aG9yX2lkJywgYXV0aCgpLT51c2VyKCktPmlkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUHVyY2hhc2VPcmRlci5wdXJjaGFzZU9yZGVyUmVxdWlzaXRpb25zJywgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2hyX2RlcGFydG1lbnRfaWQnLCAwKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPndoZW4oYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ0VtcGxveWVlJyksIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUHVyY2hhc2VPcmRlci5wdXJjaGFzZU9yZGVyUmVxdWlzaXRpb25zLnJlcXVpc2l0aW9uJywgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnYXV0aG9yX2lkJywgYXV0aCgpLT51c2VyKCktPmlkKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPndoZXJlSGFzKCdyZWxHb29kc1JlY2VpdmVkSXRlbXMnLCBmdW5jdGlvbigkcXVlcnkpewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdxdWFsaXR5X2Vuc3VyZScsJ3JldHVybi1jaGFuZ2UnKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPndoZW4oIWRhdGF0YWJsZU9yZGVyaW5nKCksIGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+b3JkZXJieSgncmVjZWl2ZWRfZGF0ZScsICdkZXNjJyk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICByZXR1cm4gRGF0YVRhYmxlczo6b2YoJGl0ZW1zKQogICAgICAgICAgICAgICAgICAgIC0+YWRkSW5kZXhDb2x1bW4oKQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdQT19yZWZlcmVuY2UnLCBmdW5jdGlvbigkZ3JuKXsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIGNsYXNzPSJidG4gYnRuLWxpbmsiIG9uY2xpY2s9InB1cmNoYXNlT3JkZXJEZXRhaWxzKCQodGhpcykpIiBkYXRhLXNyYz0iJy5yb3V0ZSgncG1zLnB1cmNoYXNlLm9yZGVyLWxpc3Quc2hvdycsICRncm4tPnJlbFB1cmNoYXNlT3JkZXItPmlkKS4nIiBkYXRhLXRpdGxlPSJQdXJjaGFzZSBPcmRlciBEZXRhaWxzIj4nLiRncm4tPnJlbFB1cmNoYXNlT3JkZXItPnJlZmVyZW5jZV9uby4nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2E+JzsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdQT19yZWZlcmVuY2UnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUHVyY2hhc2VPcmRlcicsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgncmVmZXJlbmNlX25vJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdQT19yZWZlcmVuY2UnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgUHVyY2hhc2VPcmRlcjo6c2VsZWN0KCdwdXJjaGFzZV9vcmRlcnMucmVmZXJlbmNlX25vJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3B1cmNoYXNlX29yZGVycy5pZCcsICdnb29kc19yZWNlaXZlZF9ub3Rlcy5wdXJjaGFzZV9vcmRlcl9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignUE9fZGF0ZScsIGZ1bmN0aW9uKCRncm4pewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGF0ZSgnWS1tLWQnLCBzdHJ0b3RpbWUoJGdybi0+cmVsUHVyY2hhc2VPcmRlci0+cG9fZGF0ZSkpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ1BPX2RhdGUnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUHVyY2hhc2VPcmRlcicsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgncG9fZGF0ZScsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbignUE9fcmVmZXJlbmNlJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwbGVhc2VTb3J0TWUoJHF1ZXJ5LCAkb3JkZXIsIFB1cmNoYXNlT3JkZXI6OnNlbGVjdCgncHVyY2hhc2Vfb3JkZXJzLnBvX2RhdGUnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbigncHVyY2hhc2Vfb3JkZXJzLmlkJywgJ2dvb2RzX3JlY2VpdmVkX25vdGVzLnB1cmNoYXNlX29yZGVyX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+dGFrZSgxKQogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3JlcXVpc2l0aW9ucycsIGZ1bmN0aW9uICgkZ3JuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkZ3JuLT5yZWxQdXJjaGFzZU9yZGVyLT5wdXJjaGFzZU9yZGVyUmVxdWlzaXRpb25zLT5wbHVjaygncmVxdWlzaXRpb24ucmVmZXJlbmNlX25vJyktPmltcGxvZGUoJywgJyk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbigncmVxdWlzaXRpb25zJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFB1cmNoYXNlT3JkZXIucHVyY2hhc2VPcmRlclJlcXVpc2l0aW9ucy5yZXF1aXNpdGlvbicsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ3JlZmVyZW5jZV9ubycsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ3JlcXVpc2l0aW9ucycsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBQdXJjaGFzZU9yZGVyOjpzZWxlY3QoJ3JlcXVpc2l0aW9ucy5yZWZlcmVuY2Vfbm8nKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdyZXF1aXNpdGlvbnMnLCAncmVxdWlzaXRpb25zLmlkJywgJz0nLCAncHVyY2hhc2Vfb3JkZXJfcmVxdWlzaXRpb25zLnJlcXVpc2l0aW9uX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbigncHVyY2hhc2Vfb3JkZXJfcmVxdWlzaXRpb25zJywgJ3B1cmNoYXNlX29yZGVyX3JlcXVpc2l0aW9ucy5wdXJjaGFzZV9vcmRlcl9pZCcsICc9JywgJ3B1cmNoYXNlX29yZGVycy5pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCdwdXJjaGFzZV9vcmRlcnMuaWQnLCAnZ29vZHNfcmVjZWl2ZWRfbm90ZXMucHVyY2hhc2Vfb3JkZXJfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT50YWtlKDEpCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignZ2F0ZV9pbl9yZWZlcmVuY2UnLCBmdW5jdGlvbigkZ3JuKXsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8ZGl2IHN0eWxlPSJ3aWR0aDogMTAwJSI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9IndpZHRoOiA5MCU7ZmxvYXQ6IGxlZnQ7Y2xlYXI6cmlnaHQiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiBjbGFzcz0iYnRuIGJ0bi1saW5rIiBvbmNsaWNrPSJzaG93UUVQT0RldGFpbHMoJCh0aGlzKSkiIGRhdGEtc3JjPSInLnJvdXRlKCdwbXMuZ3JuLmdybi1wcm9jZXNzLnNob3cnLCRncm4tPmlkKS4nIiBkYXRhLXRpdGxlPSJHYXRlIEluIERldGFpbHMiPicuJGdybi0+cmVmZXJlbmNlX25vLic8L2E+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJ3aWR0aDogMTAlO2Zsb2F0OiBsZWZ0O2NsZWFyOnJpZ2h0Ij4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxhIGNsYXNzPSJidG4gYnRuLXByaW1hcnkgYnRuLXhzIiBocmVmPSInLiB1cmwoJ3Btcy9ncm4vZ2F0ZS1pbi1zbGlwLycuJGdybi0+cHVyY2hhc2Vfb3JkZXJfaWQuJz9ncm49Jy4kZ3JuLT5pZCkgLiciIHRhcmdldD0iX2JsYW5rIiBzdHlsZT0ibWFyZ2luLXRvcDogNy41cHgiPjxpIGNsYXNzPSJsYSBsYS1wcmludCI+PC9pPjwvYT4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+JzsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdnYXRlX2luX3JlZmVyZW5jZScsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ3JlZmVyZW5jZV9ubycsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJyk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdnYXRlX2luX3JlZmVyZW5jZScsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT5vcmRlckJ5KCdyZWZlcmVuY2Vfbm8nLCAkb3JkZXIpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2dhdGVfaW5fcXR5JywgZnVuY3Rpb24oJGdybil7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkZ3JuLT5yZWxHb29kc1JlY2VpdmVkSXRlbXMtPnN1bSgncXR5Jyk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbigncmV0dXJuX3F0eScsIGZ1bmN0aW9uKCRncm4pewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGdybi0+cmVsR29vZHNSZWNlaXZlZEl0ZW1zLT53aGVyZSgncXVhbGl0eV9lbnN1cmUnLCdyZXR1cm4tY2hhbmdlJyktPnN1bSgncXR5JyktJGdybi0+cmVsR29vZHNSZWNlaXZlZEl0ZW1zLT53aGVyZSgncXVhbGl0eV9lbnN1cmUnLCdyZXR1cm4tY2hhbmdlJyktPnN1bSgncmVjZWl2ZWRfcXR5Jyk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmVkaXRDb2x1bW4oJ3JlY2VpdmVkX3N0YXR1cycsIGZ1bmN0aW9uKCRncm4pewogICAgICAgICAgICAgICAgICAgICAgICBpZigkZ3JuLT5yZWNlaXZlZF9zdGF0dXMgPT0gJ3BhcnRpYWwnKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnPGEgY2xhc3M9ImJ0biBidG4td2FybmluZyBidG4teHMiPlBhcnRpYWwgUmVjZWl2ZWQ8L2E+JzsKICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2VpZigkZ3JuLT5yZWNlaXZlZF9zdGF0dXMgPT0gJ2Z1bGwnKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnPGEgY2xhc3M9ImJ0biBidG4tc3VjY2VzcyBidG4teHMiPkZ1bGwgUmVjZWl2ZWQ8L2E+JzsKICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxhIGNsYXNzPSJidG4gYnRuLWRhcmsgYnRuLXhzIj4nLnVjd29yZHMoJGdybi0+cmVjZWl2ZWRfc3RhdHVzKS4nPC9hPic7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdvcHRpb25zJywgZnVuY3Rpb24oJGdybil7CiAgICAgICAgICAgICAgICAgICAgICAgICRyZXR1cm5lZCA9IFB1cmNoYXNlUmV0dXJuOjp3aGVyZUhhcygncmVsR29vZHNSZWNlaXZlZEl0ZW1zJywgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJGdybil7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnZ29vZHNfcmVjZWl2ZWRfbm90ZV9pZCcsICRncm4tPmlkKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSktPndoZXJlKCdzdGF0dXMnLCAncmV0dXJuLWNoYW5nZScpLT5zdW0oJ3JldHVybl9xdHknKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICRyZXR1cm5lZENvdW50ID0gUHVyY2hhc2VSZXR1cm46OndoZXJlSGFzKCdyZWxHb29kc1JlY2VpdmVkSXRlbXMnLCBmdW5jdGlvbigkcXVlcnkpIHVzZSgkZ3JuKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdnb29kc19yZWNlaXZlZF9ub3RlX2lkJywgJGdybi0+aWQpOwogICAgICAgICAgICAgICAgICAgICAgICB9KS0+d2hlcmUoJ3N0YXR1cycsICdyZXR1cm4tY2hhbmdlJyktPmNvdW50KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAkYXBwcm92ZWQgPSBQdXJjaGFzZVJldHVybjo6d2hlcmVIYXMoJ3JlbEdvb2RzUmVjZWl2ZWRJdGVtcycsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRncm4pewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2dvb2RzX3JlY2VpdmVkX25vdGVfaWQnLCAkZ3JuLT5pZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pLT53aGVyZSgnc3RhdHVzJywgJ3JldHVybi1jaGFuZ2UnKS0+c3VtKCdyZWNlaXZlZF9xdHknKTsKICAgICAgICAgICAgICAgICAgICAgICAgJGNvdW50ID0gJGdybi0+cmVsR29vZHNSZWNlaXZlZEl0ZW1zKCktPndoZXJlKCdxdWFsaXR5X2Vuc3VyZScsJ3JldHVybi1jaGFuZ2UnKS0+Y291bnQoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICRvcHRpb25zID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGF1dGgoKS0+dXNlcigpLT5oYXNQZXJtaXNzaW9uVG8oJ3F1YWxpdHktZW5zdXJlLXJldHVybi1jaGFuZ2UtcmVjZWl2ZWQtbGlzdCcpKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCRjb3VudCA+IDApewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRvcHRpb25zIC49ICc8YSBocmVmPSInLnJvdXRlKCdwbXMucXVhbGl0eS5lbnN1cmUucmV0dXJuLmNoYW5nZS5zaW5nbGUubGlzdCcsJGdybi0+aWQpLiciIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi1pbmZvIj4nLl9fKCdJdGVtcycpLicgKCcuJGNvdW50LicpPC9hPic7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCRyZXR1cm5lZCA+IDApewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJG9wdGlvbnMgLj0gJyZuYnNwOyZuYnNwOzxhIHRhcmdldD0iX19ibGFuayIgaHJlZj0iJy5yb3V0ZSgncG1zLnF1YWxpdHkucmV0dXJuLnJlcGxhY2UuaXRlbS5wcmludCcsWydpZCc9PiRncm4tPmlkLCd0eXBlJz0+J3JldHVybi1jaGFuZ2UtbGlzdCddKS4nIiB0aXRsZT0iUmV0dXJuIFJlcGxhY2UgTGlzdCIgY2xhc3M9ImJ0biBidG4teHMgYnRuLXdhcm5pbmciPjxpIGNsYXNzPSJsYXMgbGEtcHJpbnQiPjwvaT48L2E+JzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCRhcHByb3ZlZCA+IDApewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJG9wdGlvbnMgLj0gJyZuYnNwOyZuYnNwOzxhIHRhcmdldD0iX19ibGFuayIgaHJlZj0iJy5yb3V0ZSgncG1zLnF1YWxpdHkucmV0dXJuLnJlcGxhY2UuaXRlbS5wcmludCcsWydpZCc9PiRncm4tPmlkLCd0eXBlJz0+J3JldHVybi1jaGFuZ2UnXSkuJyIgdGl0bGU9IlJldHVybiBSZXBsYWNlIEFwcHJvdmVkIExpc3QiIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi1zdWNjZXNzIj48aSBjbGFzcz0ibGFzIGxhLXByaW50Ij48L2k+PC9hPic7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkb3B0aW9uczsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+cmF3Q29sdW1ucyhbJ1BPX3JlZmVyZW5jZScsICdnYXRlX2luX3JlZmVyZW5jZScsICdyZWNlaXZlZF9zdGF0dXMnLCAnb3B0aW9ucyddKQogICAgICAgICAgICAgICAgICAgIC0+bWFrZSh0cnVlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnF1YWxpdHkucmV0dXJuLWNoYW5nZS1pbmRleCcsIFsKICAgICAgICAgICAgICAgICd0aXRsZScgPT4gIlF1YWxpdHkgRW5zdXJlIFJldHVybiBSZXBsYWNlIExpc3QiLAogICAgICAgICAgICAgICAgJ2hlYWRlckNvbHVtbnMnID0+ICR0aGlzLT5yZXR1cm5DaGFuZ2VMaXN0SGVhZGVyQ29sdW1ucygpLAogICAgICAgICAgICBdKTsKCiAgICAgICAgfWNhdGNoKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAqIFNob3cgdGhlIEdybiBXaXNlIFJldHVybiBJdGVtIExpc3QuCiAgICAqCiAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgKi8KICAgIHB1YmxpYyBmdW5jdGlvbiBncm5XaXNlUmV0dXJuQ2hhbmdlSXRlbUxpc3QoJGlkKQogICAgewogICAgICAgIHRyeXsKCiAgICAgICAgICAgICR0aXRsZT0iUXVhbGl0eSBFbnN1cmUgUmV0dXJuIFJlcGxhY2UgTGlzdCI7CgogICAgICAgICAgICAkY2hhbmdlZCA9IFB1cmNoYXNlUmV0dXJuOjp3aXRoKFsKICAgICAgICAgICAgICAgICdyZWxHb29kc1JlY2VpdmVkSXRlbXMucmVsUHJvZHVjdC5jYXRlZ29yeS5jYXRlZ29yeScsCiAgICAgICAgICAgICAgICAncmVsR29vZHNSZWNlaXZlZEl0ZW1zLnJlbFByb2R1Y3QuYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24uYXR0cmlidXRlJywKICAgICAgICAgICAgICAgICdyZWxHb29kc1JlY2VpdmVkSXRlbXMuYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24uYXR0cmlidXRlJywKICAgICAgICAgICAgXSktPndoZXJlSGFzKCdyZWxHb29kc1JlY2VpdmVkSXRlbXMnLCBmdW5jdGlvbigkcXVlcnkpIHVzZSgkaWQpewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2dvb2RzX3JlY2VpdmVkX25vdGVfaWQnLCAkaWQpOwogICAgICAgICAgICB9KS0+d2hlcmUoJ3N0YXR1cycsICdyZXR1cm4tY2hhbmdlJyktPmdldCgpOwoKICAgICAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnF1YWxpdHkucmV0dXJuLWNoYW5nZS1saXN0Jyxjb21wYWN0KCd0aXRsZScsJ2NoYW5nZWQnKSk7CgogICAgICAgIH1jYXRjaChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBhcHByb3ZlZEl0ZW1QcmludCgkaWQsJHR5cGUpCiAgICB7CiAgICAgICAgIHRyeXsKCiAgICAgICAgICAgICR0aXRsZT0iUXVhbGl0eSBFbnN1cmUgQXBwcm92ZWQgUHJpbnQgVmlldyI7CgogICAgICAgICAgICAkcXVvdGF0aW9uPUdvb2RzUmVjZWl2ZWROb3RlOjpmaW5kT3JGYWlsKCRpZCk7CgogICAgICAgICAgICAkZ29vZHNSZWNlaXZlZEl0ZW1JZCA9IEdvb2RzUmVjZWl2ZWRJdGVtOjp3aGVyZSgnZ29vZHNfcmVjZWl2ZWRfbm90ZV9pZCcsJGlkKS0+d2hlcmUoJ3F1YWxpdHlfZW5zdXJlJywkdHlwZSktPnBsdWNrKCdpZCcpLT5hbGwoKTsKCiAgICAgICAgICAgICRhcHByb3ZhbF9saXN0ID0gR29vZHNSZWNlaXZlZEl0ZW1TdG9ja0luOjp3aGVyZUluKCdnb29kc19yZWNlaXZlZF9pdGVtX2lkJywkZ29vZHNSZWNlaXZlZEl0ZW1JZCktPmdldCgpOwoKICAgICAgICAgICAgcmV0dXJuIHZpZXdNUERGKCdwbXMuYmFja2VuZC5wYWdlcy5xdWFsaXR5LmFwcHJvdmVkLWl0ZW0tcHJpbnQtdmlldy1wZGYnLCBbCiAgICAgICAgICAgICAgICAndGl0bGUnID0+ICR0aXRsZSwKICAgICAgICAgICAgICAgICdhcHByb3ZhbF9saXN0JyA9PiAkYXBwcm92YWxfbGlzdCwKICAgICAgICAgICAgICAgICdxdW90YXRpb24nID0+ICRxdW90YXRpb24KICAgICAgICAgICAgXSwgJHRpdGxlLCAkdGl0bGUpOwogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnF1YWxpdHkuYXBwcm92ZWQtaXRlbS1wcmludC12aWV3Jyxjb21wYWN0KCd0aXRsZScsJ2FwcHJvdmFsX2xpc3QnLCdxdW90YXRpb24nKSk7CgogICAgICAgIH1jYXRjaChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiByZXR1cm5JdGVtUHJpbnRWaWV3KCRpZCwkdHlwZSkKICAgIHsKICAgICAgICAgdHJ5ewoKICAgICAgICAgICAgJHRpdGxlPSJSZXR1cm4gSXRlbXMiOwoKICAgICAgICAgICAgJHF1b3RhdGlvbiA9IEdvb2RzUmVjZWl2ZWROb3RlOjpmaW5kT3JGYWlsKCRpZCk7CgogICAgICAgICAgICAkZ29vZHNSZWNlaXZlZEl0ZW1JZCA9IEdvb2RzUmVjZWl2ZWRJdGVtOjp3aGVyZSgnZ29vZHNfcmVjZWl2ZWRfbm90ZV9pZCcsJGlkKS0+d2hlcmUoJ3F1YWxpdHlfZW5zdXJlJywncmV0dXJuJyktPnBsdWNrKCdpZCcpLT5hbGwoKTsKCiAgICAgICAgICAgICRjb2RlID0gUHVyY2hhc2VSZXR1cm46OndoZXJlSGFzKCdyZWxHb29kc1JlY2VpdmVkSXRlbXMnLCBmdW5jdGlvbigkcXVlcnkpIHVzZSgkaWQpewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2dvb2RzX3JlY2VpdmVkX25vdGVfaWQnLCAkaWQpOwogICAgICAgICAgICB9KS0+d2hlcmUoJ3N0YXR1cycsICdyZXR1cm4nKS0+Zmlyc3QoKS0+Y29kZTsKCgogICAgICAgICAgICBpZiAoJHR5cGU9PSdyZXR1cm4tYXBwcm92ZWQtbGlzdCcpIHsKICAgICAgICAgICAgICAgICRhcHByb3ZlZCA9IEdvb2RzUmVjZWl2ZWRJdGVtU3RvY2tJbjo6d2hlcmVJbignZ29vZHNfcmVjZWl2ZWRfaXRlbV9pZCcsJGdvb2RzUmVjZWl2ZWRJdGVtSWQpLT5nZXQoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgJGRhdGEgPSBbCiAgICAgICAgICAgICAgICAgICAgJ3RpdGxlJyA9PiAkdGl0bGUsCiAgICAgICAgICAgICAgICAgICAgJ3F1b3RhdGlvbicgPT4gJHF1b3RhdGlvbiwKICAgICAgICAgICAgICAgICAgICAnYXBwcm92ZWQnID0+ICRhcHByb3ZlZCwKICAgICAgICAgICAgICAgICAgICAnY29kZScgPT4gJGNvZGUsCiAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgcmV0dXJuIHZpZXdNUERGKCdwbXMuYmFja2VuZC5wYWdlcy5xdWFsaXR5LnJldHVybi1hcHByb3ZlZC1pdGVtLXByaW50LXZpZXctcGRmJywgJGRhdGEsICR0aXRsZSwgJHRpdGxlKTsKCiAgICAgICAgICAgICAgICAvL3JldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5xdWFsaXR5LnJldHVybi1hcHByb3ZlZC1pdGVtLXByaW50LXZpZXcnLCAkZGF0YSk7CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgJHJldHVybmVkID0gUHVyY2hhc2VSZXR1cm46OndoZXJlSW4oJ2dvb2RzX3JlY2VpdmVkX2l0ZW1faWQnLCRnb29kc1JlY2VpdmVkSXRlbUlkKS0+d2hlcmUoJ3N0YXR1cycsICdyZXR1cm4nKS0+Z2V0KCk7CgogICAgICAgICAgICAgICAgJGRhdGEgPSBbCiAgICAgICAgICAgICAgICAgICAgJ3RpdGxlJyA9PiAkdGl0bGUsCiAgICAgICAgICAgICAgICAgICAgJ3F1b3RhdGlvbicgPT4gJHF1b3RhdGlvbiwKICAgICAgICAgICAgICAgICAgICAncmV0dXJuZWQnID0+ICRyZXR1cm5lZCwKICAgICAgICAgICAgICAgICAgICAnY29kZScgPT4gJGNvZGUsCiAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgcmV0dXJuIHZpZXdNUERGKCdwbXMuYmFja2VuZC5wYWdlcy5xdWFsaXR5LnJldHVybi1pdGVtLXByaW50LXZpZXctcGRmJywgJGRhdGEsICR0aXRsZSwgJHRpdGxlKTsKCiAgICAgICAgICAgICAgICAvL3JldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5xdWFsaXR5LnJldHVybi1pdGVtLXByaW50LXZpZXcnLCAkZGF0YSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCgogICAgICAgIH1jYXRjaChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiByZXR1cm5SZXBsYWNlSXRlbVByaW50VmlldygkaWQsJHR5cGUpCiAgICB7CiAgICAgICAgIHRyeXsKCiAgICAgICAgICAgICR0aXRsZT0iUmV0dXJuIFJlcGxhY2UgQXBwcm92ZWQgTGlzdCI7CgogICAgICAgICAgICAkcXVvdGF0aW9uPUdvb2RzUmVjZWl2ZWROb3RlOjpmaW5kT3JGYWlsKCRpZCk7CgogICAgICAgICAgICAkcmV0dXJuQ2hhbmdlTGlzdCA9IEdvb2RzUmVjZWl2ZWRJdGVtOjp3aGVyZSgnZ29vZHNfcmVjZWl2ZWRfbm90ZV9pZCcsJGlkKQogICAgICAgICAgICAtPndoZXJlKCdxdWFsaXR5X2Vuc3VyZScsJ3JldHVybi1jaGFuZ2UnKS0+Z2V0KCk7CgogICAgICAgICAgICAkY29kZSA9IFB1cmNoYXNlUmV0dXJuOjp3aGVyZUhhcygncmVsR29vZHNSZWNlaXZlZEl0ZW1zJywgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJGlkKXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdnb29kc19yZWNlaXZlZF9ub3RlX2lkJywgJGlkKTsKICAgICAgICAgICAgfSktPndoZXJlKCdzdGF0dXMnLCAncmV0dXJuLWNoYW5nZScpLT5maXJzdCgpLT5jb2RlOwoKICAgICAgICAgICAgaWYgKCR0eXBlPT0ncmV0dXJuLWNoYW5nZS1saXN0JykgewogICAgICAgICAgICAgICAgJGRhdGEgPSBbCiAgICAgICAgICAgICAgICAgICAgJ3RpdGxlJyA9PiAkdGl0bGUsCiAgICAgICAgICAgICAgICAgICAgJ3F1b3RhdGlvbicgPT4gJHF1b3RhdGlvbiwKICAgICAgICAgICAgICAgICAgICAncmV0dXJuQ2hhbmdlTGlzdCcgPT4gJHJldHVybkNoYW5nZUxpc3QsCiAgICAgICAgICAgICAgICAgICAgJ2NvZGUnID0+ICRjb2RlLAogICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgIHJldHVybiB2aWV3TVBERigncG1zLmJhY2tlbmQucGFnZXMucXVhbGl0eS5yZXR1cm4tcmVwbGFjZS1yZXR1cm4taXRlbS1wcmludC12aWV3LXBkZicsICRkYXRhLCAkdGl0bGUsICR0aXRsZSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnF1YWxpdHkucmV0dXJuLXJlcGxhY2UtcmV0dXJuLWl0ZW0tcHJpbnQtdmlldycsY29tcGFjdCgndGl0bGUnLCdyZXR1cm5DaGFuZ2VMaXN0JywncXVvdGF0aW9uJywgJ2NvZGUnKSk7CiAgICAgICAgICAgIH1lbHNlewoKICAgICAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5xdWFsaXR5LnJldHVybi1yZXBsYWNlLWl0ZW0tcHJpbnQtdmlldycsY29tcGFjdCgndGl0bGUnLCdyZXR1cm5DaGFuZ2VMaXN0JywncXVvdGF0aW9uJywgJ2NvZGUnKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgfWNhdGNoKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CiAgICAKICAgIC8qKgogICAgICogU3RvcmUgYSBuZXdseSBjcmVhdGVkIHJlc291cmNlIGluIHN0b3JhZ2UuCiAgICAgKgogICAgICogQHBhcmFtICBcSWxsdW1pbmF0ZVxIdHRwXFJlcXVlc3QgICRyZXF1ZXN0CiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwogICAgcHVibGljIGZ1bmN0aW9uIHJldHVybkNoYW5nZVJlY2VpdmVkKFJlcXVlc3QgJHJlcXVlc3QpCiAgICB7ICAgIAoKICAgICAgICB0cnl7CgogICAgICAgICAgICBEQjo6YmVnaW5UcmFuc2FjdGlvbigpOwogICAgICAgICAgICBmb3JlYWNoKCRyZXF1ZXN0LT5pZCBhcyAka2V5PT4kaWQpewoKICAgICAgICAgICAgICAgICRtb2RlbD1Hb29kc1JlY2VpdmVkSXRlbTo6d2hlcmUoWydpZCc9PiRpZCwncXVhbGl0eV9lbnN1cmUnPT4ncmV0dXJuLWNoYW5nZSddKS0+Zmlyc3QoKTsKICAgICAgICAgICAgICAgICRwcm9kdWN0PVByb2R1Y3Q6OmZpbmRPckZhaWwoJG1vZGVsLT5wcm9kdWN0X2lkKTsKICAgICAgICAgICAgICAgICRwcmVmaXg9J1FFLVJSUC0nLmRhdGUoJ3knLCBzdHJ0b3RpbWUoZGF0ZSgnWS1tLWQnKSkpLictU1NMWi0nOwogICAgICAgICAgICAgICAgJHJlZk5vPXVuaXF1ZUNvZGUoMTgsJHByZWZpeCwnZ29vZHNfcmVjZWl2ZWRfaXRlbXNfc3RvY2tfaW4nLCdpZCcpOwoKICAgICAgICAgICAgICAgIGlmKGlzc2V0KCRtb2RlbC0+aWQpICYmICRyZXF1ZXN0LT5zdGF0dXM9PT0ncmVjZWl2ZWQnKXsKICAgICAgICAgICAgICAgICAgICBpZiAoKCRtb2RlbC0+cXR5LSRtb2RlbC0+cmVjZWl2ZWRfcXR5KSA8ICRyZXF1ZXN0LT5yZWNlaXZlZF9xdHlbJGtleV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aFdhcm5pbmcoJ1lvdXIgcmV0dXJuIHF0eSBpcyBncmVhdGVyIHRoZW4gbWF4aW11bSBxdHknKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICR0b3RhbFJlY2VpdmVkUXR5ID0gJG1vZGVsLT5yZWNlaXZlZF9xdHkrJHJlcXVlc3QtPnJlY2VpdmVkX3F0eVska2V5XTsKCiAgICAgICAgICAgICAgICAgICAgJHF1YWxpdHlFbnN1cmU9KCR0b3RhbFJlY2VpdmVkUXR5PT0kbW9kZWwtPnF0eSk/J2FwcHJvdmVkJzoncmV0dXJuLWNoYW5nZSc7CgogICAgICAgICAgICAgICAgICAgICR1cGRhdGU9JG1vZGVsLT51cGRhdGUoWwogICAgICAgICAgICAgICAgICAgICAgICAncXVhbGl0eV9lbnN1cmUnID0+ICRxdWFsaXR5RW5zdXJlLAogICAgICAgICAgICAgICAgICAgICAgICAncmVjZWl2ZWRfcXR5JyA9PiAgJHRvdGFsUmVjZWl2ZWRRdHksCiAgICAgICAgICAgICAgICAgICAgICAgICd1cGRhdGVkX2F0JyA9PiBkYXRlKCdZLW0tZCBIOmk6cycpLAogICAgICAgICAgICAgICAgICAgICAgICAndXBkYXRlZF9ieScgPT4gQXV0aDo6dXNlcigpLT5pZAogICAgICAgICAgICAgICAgICAgIF0pOwoKICAgICAgICAgICAgICAgICAgICBpZiAoJHVwZGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBQdXJjaGFzZVJldHVybjo6Y3JlYXRlKFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdnb29kc19yZWNlaXZlZF9pdGVtX2lkJz0+JG1vZGVsLT5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdyZXR1cm5fbm90ZScgPT4gJHJlcXVlc3QtPnJldHVybl9ub3RlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3JldHVybl9xdHknID0+ICRyZXF1ZXN0LT5yZWNlaXZlZF9xdHlbJGtleV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnc3RhdHVzJyA9PiAkcmVxdWVzdC0+c3RhdHVzLAogICAgICAgICAgICAgICAgICAgICAgICBdKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICRyZWNlaXZlZFF0eT0kcmVxdWVzdC0+cmVjZWl2ZWRfcXR5WyRrZXldOwogICAgICAgICAgICAgICAgICAgICAgICAkc3VidG90YWw9JHJlY2VpdmVkUXR5KiRtb2RlbC0+dW5pdF9hbW91bnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICRkaXNjb3VudEFtb3VudD0gKCRtb2RlbC0+ZGlzY291bnRfcGVyY2VudGFnZSAqICRzdWJ0b3RhbCkvMTAwOwogICAgICAgICAgICAgICAgICAgICAgICAkdmF0QW1vdW50PSAoJG1vZGVsLT52YXRfcGVyY2VudGFnZSAqICRzdWJ0b3RhbCkvMTAwOwoKICAgICAgICAgICAgICAgICAgICAgICAgJEdSSXRlbXNTdG9ja0luID0gbmV3IEdvb2RzUmVjZWl2ZWRJdGVtU3RvY2tJbigpOwogICAgICAgICAgICAgICAgICAgICAgICAkR1JJdGVtc1N0b2NrSW4tPnB1cmNoYXNlX29yZGVyX2lkID0gJG1vZGVsLT5yZWxHb29kc1JlY2VpdmVkTm90ZS0+cHVyY2hhc2Vfb3JkZXJfaWQ7CiAgICAgICAgICAgICAgICAgICAgICAgICRHUkl0ZW1zU3RvY2tJbi0+cmVmZXJlbmNlX25vID0gJHJlZk5vOwogICAgICAgICAgICAgICAgICAgICAgICAkR1JJdGVtc1N0b2NrSW4tPmdvb2RzX3JlY2VpdmVkX2l0ZW1faWQgPSAkbW9kZWwtPmlkOwogICAgICAgICAgICAgICAgICAgICAgICAkR1JJdGVtc1N0b2NrSW4tPnVuaXRfYW1vdW50ID0gJG1vZGVsLT51bml0X2Ftb3VudDsKICAgICAgICAgICAgICAgICAgICAgICAgJEdSSXRlbXNTdG9ja0luLT5yZWNlaXZlZF9xdHkgPSAkcmVjZWl2ZWRRdHk7CiAgICAgICAgICAgICAgICAgICAgICAgICRHUkl0ZW1zU3RvY2tJbi0+c3ViX3RvdGFsID0gJHN1YnRvdGFsOwogICAgICAgICAgICAgICAgICAgICAgICAkR1JJdGVtc1N0b2NrSW4tPmRpc2NvdW50X3BlcmNlbnRhZ2UgPSAkbW9kZWwtPmRpc2NvdW50X3BlcmNlbnRhZ2U7CiAgICAgICAgICAgICAgICAgICAgICAgICRHUkl0ZW1zU3RvY2tJbi0+ZGlzY291bnQgPSAkZGlzY291bnRBbW91bnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICRHUkl0ZW1zU3RvY2tJbi0+dmF0X3BlcmNlbnRhZ2UgPSAkbW9kZWwtPnZhdF9wZXJjZW50YWdlOwogICAgICAgICAgICAgICAgICAgICAgICAkR1JJdGVtc1N0b2NrSW4tPnZhdCA9ICR2YXRBbW91bnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICRHUkl0ZW1zU3RvY2tJbi0+dG90YWxfYW1vdW50ID0gKCRzdWJ0b3RhbC0kZGlzY291bnRBbW91bnQpKyR2YXRBbW91bnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICRHUkl0ZW1zU3RvY2tJbi0+aXNfZ3JuX2NvbXBsZXRlID0gJ25vJzsKICAgICAgICAgICAgICAgICAgICAgICAgJEdSSXRlbXNTdG9ja0luLT5zYXZlKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAkbWVzc2FnZSA9ICc8c3BhbiBjbGFzcz0ibm90aWZpY2F0aW9uLWxpbmtzIiBkYXRhLXNyYz0iJy5yb3V0ZSgncG1zLmdybi5ncm4tcHJvY2Vzcy5zaG93JywkbW9kZWwtPnJlbEdvb2RzUmVjZWl2ZWROb3RlLT5pZCkuJz92aWV3IiBkYXRhLXRpdGxlPSJHYXRlLUluIERldGFpbHMiPlJlZmVyZW5jZSBObzonLiRtb2RlbC0+cmVsR29vZHNSZWNlaXZlZE5vdGUtPnJlZmVyZW5jZV9uby4nLiBXYWl0aW5nIGZvciB0aGUgR1JOLjwvc3Bhbj4nOwoKICAgICAgICAgICAgQ3JlYXRlT3JVcGRhdGVOb3RpZmljYXRpb24oICRtZXNzYWdlLCd1bnJlYWQnLCcnLGdldE1hbmFnZXJJbmZvKCdTdG9yZS1NYW5hZ2VyJywkbW9kZWwtPnJlbEdvb2RzUmVjZWl2ZWROb3RlLT5yZWxQdXJjaGFzZU9yZGVyLT5ocl91bml0X2lkKSwnc2VuZC10by1zdG9yZScsJycpOwoKICAgICAgICAgICAgQ3JlYXRlT3JVcGRhdGVOb3RpZmljYXRpb24oJG1lc3NhZ2UsJ3VucmVhZCcsJycsZ2V0TWFuYWdlckluZm8oJ1B1cmNoYXNlLURlcGFydG1lbnQnKSwnc2VudC10by1wdXJjaGFzZScsJycpOwoKICAgICAgICAgICAgREI6OmNvbW1pdCgpOwogICAgICAgICAgICByZXR1cm4gJHRoaXMtPnJlZGlyZWN0QmFja1dpdGhTdWNjZXNzKCdTdWNjZXNzZnVsbHkgVXBkYXRlZCB0aGlzIEl0ZW0gUXVhbGl0eSBTdGF0dXMhIScsJ3Btcy5xdWFsaXR5LmVuc3VyZS5yZXR1cm4uY2hhbmdlLmxpc3QnKTsKCiAgICAgICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgIERCOjpyb2xsYmFjaygpOwogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCiAgICBwdWJsaWMgZnVuY3Rpb24gcHJvY2Vzc1NlbGZHUk4oJHN0b2NrKQogICAgewogICAgICAgIC8vR1JOCiAgICAgICAgJGdybiA9ICRzdG9jay0+cmVsR29vZHNSZWNlaXZlZEl0ZW1zLT5yZWxHb29kc1JlY2VpdmVkTm90ZTsKICAgICAgICAkd2FyZWhvdXNlID0gV2FyZWhvdXNlczo6d2hlcmVOb3ROdWxsKCdpZCcpLT5maXJzdCgpOwogICAgICAgICRjcmVkaXQgPSAwOwogICAgICAgICRzdG9ja0lucyA9IFtdOwogICAgICAgICRwdXJjaGFzZV9vcmRlcl9pZCA9IFtdOwogICAgICAgIGlmKCRzdG9jay0+aXNfZ3JuX2NvbXBsZXRlID09ICdubycpewogICAgICAgICAgICAkcHJvZHVjdCA9IFByb2R1Y3Q6OmZpbmRPckZhaWwoJHN0b2NrLT5yZWxHb29kc1JlY2VpdmVkSXRlbXMtPnByb2R1Y3RfaWQpOwogICAgICAgICAgICBuZXcgSW52ZW50b3J5QWN0aW9uQ29udHJvbCgkcHJvZHVjdCwgJHdhcmVob3VzZSwgJHN0b2NrLT50b3RhbF9hbW91bnQsICRzdG9jay0+cmVjZWl2ZWRfcXR5LCAnYWN0aXZlJywgJHN0b2NrLT5yZWxHb29kc1JlY2VpdmVkSXRlbXMtPnJlbEdvb2RzUmVjZWl2ZWROb3RlLT5ncm5fcmVmZXJlbmNlX25vLCAkc3RvY2stPmlkKTsKCiAgICAgICAgICAgICRzdG9jay0+aXNfZ3JuX2NvbXBsZXRlID0gJ3llcyc7CiAgICAgICAgICAgICRzdG9jay0+d2FyZWhvdXNlX2lkID0gJHdhcmVob3VzZS0+aWQ7CgogICAgICAgICAgICAkcHJvamVjdCA9IGZhbHNlOwogICAgICAgICAgICBpZiAoaXNzZXQoJGdybi0+cmVsUHVyY2hhc2VPcmRlci0+cHVyY2hhc2VPcmRlclJlcXVpc2l0aW9uc1swXSkpIHsKICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRncm4tPnJlbFB1cmNoYXNlT3JkZXItPnB1cmNoYXNlT3JkZXJSZXF1aXNpdGlvbnMgYXMgJGtleSA9PiAkcG9yKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCRwb3ItPnJlcXVpc2l0aW9uLT5yZXF1aXNpdGlvbkl0ZW1zLT53aGVyZSgncHJvZHVjdF9pZCcsICRzdG9jay0+cmVsR29vZHNSZWNlaXZlZEl0ZW1zLT5wcm9kdWN0X2lkKS0+Y291bnQoKSA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzc2V0KCRwb3ItPnJlcXVpc2l0aW9uLT5wcm9qZWN0VGFzay0+aWQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcHJvamVjdCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICgkc3RvY2stPnJlbEdvb2RzUmVjZWl2ZWRJdGVtcy0+cmVsUHJvZHVjdC0+aXNfZml4ZWRfYXNzZXQgPT0gMSB8fCAkc3RvY2stPnJlbEdvb2RzUmVjZWl2ZWRJdGVtcy0+cmVsUHJvZHVjdC0+aXNfY3dpcCA9PSAxIHx8ICRwcm9qZWN0KSB7CiAgICAgICAgICAgICAgICAkZml4ZWRBc3NldExvY2F0aW9uID0gXEFwcFxNb2RlbHNcRml4ZWRBc3NldHNcRml4ZWRBc3NldExvY2F0aW9uOjp3aGVyZShbCiAgICAgICAgICAgICAgICAgICAgJ3VuaXRfaWQnID0+ICRzdG9jay0+cmVsUHVyY2hhc2VPcmRlci0+aHJfdW5pdF9pZCwKICAgICAgICAgICAgICAgICAgICAnY2F0ZWdvcnlfaWQnID0+ICRzdG9jay0+cmVsR29vZHNSZWNlaXZlZEl0ZW1zLT5yZWxQcm9kdWN0LT5jYXRlZ29yeS0+cGFyZW50X2lkLAogICAgICAgICAgICAgICAgXSktPmZpcnN0KCk7CiAgICAgICAgICAgICAgICAkc3RvY2stPmZpeGVkX2Fzc2V0X2xvY2F0aW9uX2lkID0gKGlzc2V0KCRmaXhlZEFzc2V0TG9jYXRpb24tPmlkKSA/ICRmaXhlZEFzc2V0TG9jYXRpb24tPmlkIDogMCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICRzdG9jay0+c2F2ZSgpOwoKICAgICAgICAgICAgJGNyZWRpdCArPSAkc3RvY2stPnRvdGFsX2Ftb3VudDsKCiAgICAgICAgICAgIGFycmF5X3B1c2goJHN0b2NrSW5zLCAkc3RvY2stPmlkKTsKICAgICAgICAgICAgYXJyYXlfcHVzaCgkcHVyY2hhc2Vfb3JkZXJfaWQsICRzdG9jay0+cHVyY2hhc2Vfb3JkZXJfaWQpOwogICAgICAgIH0KCiAgICAgICAgJGVudHJ5ID0gJHRoaXMtPnJ1bkxlZGdlclF1ZXJpZXMoJHN0b2NrSW5zLCAkZ3JuKTsKICAgICAgICBpZiAoaXNzZXQoJHB1cmNoYXNlX29yZGVyX2lkWzBdKSAmJiBpc3NldCgkZW50cnlbJ3N1Y2Nlc3MnXSkgJiYgJGVudHJ5WydzdWNjZXNzJ10pIHsKICAgICAgICAgICAgZm9yZWFjaCAoJHB1cmNoYXNlX29yZGVyX2lkIGFzICRrZXkgPT4gJHBvX2lkKSB7CiAgICAgICAgICAgICAgICBcQXBwXE1vZGVsc1xQbXNNb2RlbHNcUHVyY2hhc2VcUHVyY2hhc2VPcmRlckVudHJ5Ojp1cGRhdGVPckNyZWF0ZShbCiAgICAgICAgICAgICAgICAgICAgJ3N1cHBsaWVyX2lkJyA9PiBQdXJjaGFzZU9yZGVyOjpmaW5kT3JGYWlsKCRwb19pZCktPnJlbFF1b3RhdGlvbi0+c3VwcGxpZXJfaWQsCiAgICAgICAgICAgICAgICAgICAgJ3B1cmNoYXNlX29yZGVyX2lkJyA9PiAkcG9faWQsCiAgICAgICAgICAgICAgICAgICAgJ3R5cGUnID0+ICdncm4nLAogICAgICAgICAgICAgICAgICAgICdlbnRyeV9pZCcgPT4gJGVudHJ5WydlbnRyeSddWydpZCddLAogICAgICAgICAgICAgICAgXSwgWwogICAgICAgICAgICAgICAgICAgICd1cGRhdGVkX2F0JyA9PiBkYXRlKCdZLW0tZCBIOmk6cycpCiAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGlzc2V0KCRzdG9ja0luc1swXSkpIHsKICAgICAgICAgICAgJHByb2plY3QgPSBpc3NldCgkZ3JuLT5yZWxQdXJjaGFzZU9yZGVyLT5wdXJjaGFzZU9yZGVyUmVxdWlzaXRpb25zWzBdLT5yZXF1aXNpdGlvbi0+cHJvamVjdFRhc2stPmlkKTsKICAgICAgICAgICAgZm9yZWFjaCAoJHN0b2NrSW5zIGFzICRrZXkgPT4gJHN0b2NrX2luX2lkKSB7CiAgICAgICAgICAgICAgICAkc3RvY2tJbiA9IEdvb2RzUmVjZWl2ZWRJdGVtU3RvY2tJbjo6d2hlcmUoJ2lkJywgJHN0b2NrX2luX2lkKS0+d2hlcmUoJ2lzX2dybl9jb21wbGV0ZScsICd5ZXMnKS0+Zmlyc3QoKTsKICAgICAgICAgICAgICAgICRjYXBpdGFsaXplID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGlmICgkcHJvamVjdCkgewogICAgICAgICAgICAgICAgICAgIGlmICgkc3RvY2tJbi0+cmVsR29vZHNSZWNlaXZlZEl0ZW1zLT5yZWxQcm9kdWN0LT5pc19jd2lwID09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGNhcGl0YWxpemUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmICgkc3RvY2tJbi0+cmVsR29vZHNSZWNlaXZlZEl0ZW1zLT5yZWxQcm9kdWN0LT5pc19maXhlZF9hc3NldCA9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRjYXBpdGFsaXplID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICgkY2FwaXRhbGl6ZSAmJiAkc3RvY2tJbi0+cmVjZWl2ZWRfcXR5ID4gMCkgewogICAgICAgICAgICAgICAgICAgICRiYXRjaCA9IEZpeGVkQXNzZXRCYXRjaDo6Y3JlYXRlKFsKICAgICAgICAgICAgICAgICAgICAgICAgJ2dvb2RzX3JlY2VpdmVkX2l0ZW1zX3N0b2NrX2luX2lkJyA9PiAkc3RvY2tJbi0+aWQsCiAgICAgICAgICAgICAgICAgICAgICAgICdiYXRjaCcgPT4gdW5pcXVlQ29kZVdpdGhvdXRQcmVmaXgoOCwgJ2ZpeGVkX2Fzc2V0X2JhdGNoZXMnLCAnYmF0Y2gnKSwKCiAgICAgICAgICAgICAgICAgICAgICAgICdkZXByZWNpYXRpb25fbWV0aG9kX2lkJyA9PiAkc3RvY2tJbi0+cmVsR29vZHNSZWNlaXZlZEl0ZW1zLT5yZWxQcm9kdWN0LT5kZXByZWNpYXRpb25fbWV0aG9kX2lkLAogICAgICAgICAgICAgICAgICAgICAgICAnYmFzZV9yYXRlJyA9PiAkc3RvY2tJbi0+cmVsR29vZHNSZWNlaXZlZEl0ZW1zLT5yZWxQcm9kdWN0LT5iYXNlX3JhdGUsCiAgICAgICAgICAgICAgICAgICAgICAgICdyYXRlX211bHRpcGxpZXInID0+ICRzdG9ja0luLT5yZWxHb29kc1JlY2VpdmVkSXRlbXMtPnJlbFByb2R1Y3QtPnJhdGVfbXVsdGlwbGllciwKICAgICAgICAgICAgICAgICAgICAgICAgJ2RlcHJlY2lhdGlvbl9yYXRlJyA9PiAkc3RvY2tJbi0+cmVsR29vZHNSZWNlaXZlZEl0ZW1zLT5yZWxQcm9kdWN0LT5kZXByZWNpYXRpb25fcmF0ZSwKICAgICAgICAgICAgICAgICAgICAgICAgJ2lzX3llYXJseScgPT4gJHN0b2NrSW4tPnJlbEdvb2RzUmVjZWl2ZWRJdGVtcy0+cmVsUHJvZHVjdC0+aXNfeWVhcmx5LAogICAgICAgICAgICAgICAgICAgICAgICAneWVhcnMnID0+ICRzdG9ja0luLT5yZWxHb29kc1JlY2VpdmVkSXRlbXMtPnJlbFByb2R1Y3QtPnllYXJzLAogICAgICAgICAgICAgICAgICAgICAgICAnaXNfb25ldGltZScgPT4gJHN0b2NrSW4tPnJlbEdvb2RzUmVjZWl2ZWRJdGVtcy0+cmVsUHJvZHVjdC0+aXNfb25ldGltZSwKICAgICAgICAgICAgICAgICAgICAgICAgJ2RlcHJlY2lhdGlvbl9zdGFydF9kYXRlJyA9PiBkYXRlKCdZLW0tZCcsIHN0cnRvdGltZSgkc3RvY2tJbi0+dXBkYXRlZF9hdCkpLAogICAgICAgICAgICAgICAgICAgIF0pOwogICAgICAgICAgICAgICAgICAgIGlmICgkYmF0Y2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICgkaSA9IDE7ICRpIDw9ICRzdG9ja0luLT5yZWNlaXZlZF9xdHk7ICRpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEZpeGVkQXNzZXRCYXRjaEl0ZW06OmNyZWF0ZShbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2ZpeGVkX2Fzc2V0X2JhdGNoX2lkJyA9PiAkYmF0Y2gtPmlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdhc3NldF9jb2RlJyA9PiAkYmF0Y2gtPmJhdGNoIC4gJy0nIC4gJGksCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdkZXByZWNpYXRpb25fbWV0aG9kX2lkJyA9PiAkc3RvY2tJbi0+cmVsR29vZHNSZWNlaXZlZEl0ZW1zLT5yZWxQcm9kdWN0LT5kZXByZWNpYXRpb25fbWV0aG9kX2lkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdiYXNlX3JhdGUnID0+ICRzdG9ja0luLT5yZWxHb29kc1JlY2VpdmVkSXRlbXMtPnJlbFByb2R1Y3QtPmJhc2VfcmF0ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAncmF0ZV9tdWx0aXBsaWVyJyA9PiAkc3RvY2tJbi0+cmVsR29vZHNSZWNlaXZlZEl0ZW1zLT5yZWxQcm9kdWN0LT5yYXRlX211bHRpcGxpZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2RlcHJlY2lhdGlvbl9yYXRlJyA9PiAkc3RvY2tJbi0+cmVsR29vZHNSZWNlaXZlZEl0ZW1zLT5yZWxQcm9kdWN0LT5kZXByZWNpYXRpb25fcmF0ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnaXNfeWVhcmx5JyA9PiAkc3RvY2tJbi0+cmVsR29vZHNSZWNlaXZlZEl0ZW1zLT5yZWxQcm9kdWN0LT5pc195ZWFybHksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3llYXJzJyA9PiAkc3RvY2tJbi0+cmVsR29vZHNSZWNlaXZlZEl0ZW1zLT5yZWxQcm9kdWN0LT55ZWFycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnaXNfb25ldGltZScgPT4gJHN0b2NrSW4tPnJlbEdvb2RzUmVjZWl2ZWRJdGVtcy0+cmVsUHJvZHVjdC0+aXNfb25ldGltZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZGVwcmVjaWF0aW9uX3N0YXJ0X2RhdGUnID0+IGRhdGUoJ1ktbS1kJywgc3RydG90aW1lKCRzdG9ja0luLT51cGRhdGVkX2F0KSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvL0dSTgoKICAgICAgICAvL0RlbGl2ZXJ5CiAgICAgICAgJGxlZGdlckl0ZW1zID0gW107CgogICAgICAgICRyZXF1aXNpdGlvbklkID0gJHN0b2NrLT5yZWxHb29kc1JlY2VpdmVkSXRlbXMtPnJlbEdvb2RzUmVjZWl2ZWROb3RlLT5yZWxQdXJjaGFzZU9yZGVyLT5wdXJjaGFzZU9yZGVyUmVxdWlzaXRpb25zLT5maXJzdCgpLT5yZXF1aXNpdGlvbl9pZDsKICAgICAgICAkcmVxdWlzaXRpb24gPSBSZXF1aXNpdGlvbjo6ZmluZE9yRmFpbCgkcmVxdWlzaXRpb25JZCk7CgogICAgICAgIGlmICgkcmVxdWlzaXRpb24tPnB1cmNoYXNlT3JkZXJzLT5jb3VudCgpID4gMCkgewogICAgICAgICAgICAkY29zdF9jZW50cmVfaWQgPSAkcmVxdWlzaXRpb24tPnB1cmNoYXNlT3JkZXJzWzBdLT5wdXJjaGFzZU9yZGVyLT5jb3N0X2NlbnRyZV9pZDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAkY29zdF9jZW50cmVfaWQgPSBDb3N0Q2VudHJlOjp3aGVyZShbCiAgICAgICAgICAgICAgICAnaHJfdW5pdF9pZCcgPT4gJHJlcXVpc2l0aW9uLT5yZWxVc2Vyc0xpc3QtPmVtcGxveWVlLT5hc191bml0X2lkLAogICAgICAgICAgICAgICAgJ2hyX2RlcGFydG1lbnRfaWQnID0+ICRyZXF1aXNpdGlvbi0+cmVsVXNlcnNMaXN0LT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCwKICAgICAgICAgICAgXSktPmZpcnN0KCktPmlkOwogICAgICAgIH0KCiAgICAgICAgJHByb2plY3QgPSBpc3NldCgkcmVxdWlzaXRpb24tPnByb2plY3RUYXNrLT5pZCk7CiAgICAgICAgJHB1cmNoYXNlT3JkZXIgPSBQdXJjaGFzZU9yZGVyOjp3aGVyZUhhcygncHVyY2hhc2VPcmRlclJlcXVpc2l0aW9ucycsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJHJlcXVpc2l0aW9uSWQpIHsKICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ3JlcXVpc2l0aW9uX2lkJywgJHJlcXVpc2l0aW9uSWQpOwogICAgICAgIH0pLT5maXJzdCgpOwogICAgICAgICRyZXF1aXNpdGlvbkRlbGl2ZXJ5ID0gUmVxdWlzaXRpb25EZWxpdmVyeTo6Y3JlYXRlKFsKICAgICAgICAgICAgJ3JlcXVpc2l0aW9uX2lkJyA9PiAkcmVxdWlzaXRpb25JZCwKICAgICAgICAgICAgJ3JlZmVyZW5jZV9ubycgPT4gJHJlcXVpc2l0aW9uLT5yZWZlcmVuY2Vfbm8sCiAgICAgICAgICAgICdkZWxpdmVyeV9kYXRlJyA9PiBkYXRlKCdZLW0tZCcpLAogICAgICAgICAgICAnbm90ZScgPT4gJycsCiAgICAgICAgICAgICdkZWxpdmVyeV9ieScgPT4gYXV0aCgpLT51c2VyKCktPmlkLAogICAgICAgICAgICAnY3JlYXRlZF9ieScgPT4gYXV0aCgpLT51c2VyKCktPmlkLAogICAgICAgIF0pOwoKICAgICAgICAkcHJvZHVjdCA9IFByb2R1Y3Q6OndpdGgoWwogICAgICAgICAgICAncHJvZHVjdFVuaXRDb252ZXJzaW9ucycKICAgICAgICBdKS0+ZmluZE9yRmFpbCgkc3RvY2stPnJlbEdvb2RzUmVjZWl2ZWRJdGVtcy0+cHJvZHVjdF9pZCk7CiAgICAgICAgJGRlbGl2ZXJ5UXR5ID0gJHN0b2NrLT5yZWNlaXZlZF9xdHk7CiAgICAgICAgJHJlcXVpc2l0aW9uSXRlbSA9IFJlcXVpc2l0aW9uSXRlbTo6d2hlcmUoJ3JlcXVpc2l0aW9uX2lkJywgJHJlcXVpc2l0aW9uSWQpCiAgICAgICAgICAgIC0+d2hlcmUoJ3Byb2R1Y3RfaWQnLCAkc3RvY2stPnJlbEdvb2RzUmVjZWl2ZWRJdGVtcy0+cHJvZHVjdF9pZCkKICAgICAgICAgICAgLT5maXJzdCgpOwogICAgICAgICRyZXF1aXNpdGlvbkl0ZW0tPnVwZGF0ZShbCiAgICAgICAgICAgICdkZWxpdmVyeV9xdHknID0+ICRkZWxpdmVyeVF0eSArICRyZXF1aXNpdGlvbkl0ZW0tPmRlbGl2ZXJ5X3F0eQogICAgICAgIF0pOwoKICAgICAgICAkdW5pdFByaWNlID0gMDsKICAgICAgICAkc3RvY2tQcmljZSA9IFxBcHBcTW9kZWxzXFBtc01vZGVsc1xHcm5cR29vZHNSZWNlaXZlZEl0ZW1TdG9ja0luOjp3aGVyZUhhcygncmVsUHVyY2hhc2VPcmRlci5wdXJjaGFzZU9yZGVyUmVxdWlzaXRpb25zJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgkcmVxdWlzaXRpb25JdGVtKSB7CiAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdyZXF1aXNpdGlvbl9pZCcsICRyZXF1aXNpdGlvbkl0ZW0tPnJlcXVpc2l0aW9uX2lkKTsKICAgICAgICB9KQogICAgICAgIC0+d2hlcmVIYXMoJ3JlbEdvb2RzUmVjZWl2ZWRJdGVtcycsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJHJlcXVpc2l0aW9uSXRlbSkgewogICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgncHJvZHVjdF9pZCcsICRyZXF1aXNpdGlvbkl0ZW0tPnByb2R1Y3RfaWQpOwogICAgICAgIH0pCiAgICAgICAgLT5maXJzdCgpOwogICAgICAgIGlmKCFpc3NldCgkc3RvY2tQcmljZS0+dW5pdF9hbW91bnQpKXsKICAgICAgICAgICAgJHN0b2NrUHJpY2UgPSBcQXBwXE1vZGVsc1xQbXNNb2RlbHNcR3JuXEdvb2RzUmVjZWl2ZWRJdGVtU3RvY2tJbjo6d2hlcmVIYXMoJ3JlbEdvb2RzUmVjZWl2ZWRJdGVtcycsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJHJlcXVpc2l0aW9uSXRlbSkgewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ3Byb2R1Y3RfaWQnLCAkcmVxdWlzaXRpb25JdGVtLT5wcm9kdWN0X2lkKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT53aGVyZUhhcygnaW52ZW50b3J5TG9ncycsIGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnYXZhaWxhYmxlJywgJz4nLCAwKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT5maXJzdCgpOwogICAgICAgIH0KICAgICAgICBpZihpc3NldCgkc3RvY2tQcmljZS0+dW5pdF9hbW91bnQpKXsKICAgICAgICAgICAgJHVuaXRQcmljZSA9ICRzdG9ja1ByaWNlLT51bml0X2Ftb3VudDsKICAgICAgICB9CgogICAgICAgICRyZXF1aXNpdGlvbkRlbGl2ZXJ5SXRlbSA9IFJlcXVpc2l0aW9uRGVsaXZlcnlJdGVtOjpjcmVhdGUoWwogICAgICAgICAgICAncmVxdWlzaXRpb25fZGVsaXZlcnlfaWQnID0+ICRyZXF1aXNpdGlvbkRlbGl2ZXJ5LT5pZCwKICAgICAgICAgICAgJ3dhcmVob3VzZV9pZCcgPT4gJHdhcmVob3VzZS0+aWQsCiAgICAgICAgICAgICdwcm9kdWN0X2lkJyA9PiAkc3RvY2stPnJlbEdvb2RzUmVjZWl2ZWRJdGVtcy0+cHJvZHVjdF9pZCwKICAgICAgICAgICAgJ2RlbGl2ZXJ5X3F0eScgPT4gJGRlbGl2ZXJ5UXR5LAogICAgICAgIF0pOwoKICAgICAgICBpZiAoJHJlcXVpc2l0aW9uSXRlbS0+cHJvZHVjdC0+aXNfZml4ZWRfYXNzZXQgPT0gMCAmJiAkcmVxdWlzaXRpb25JdGVtLT5wcm9kdWN0LT5pc19jd2lwID09IDAgJiYgISRwcm9qZWN0ICYmICRkZWxpdmVyeVF0eSA+IDApIHsKICAgICAgICAgICAgJGFjY291bnREZWZhdWx0U2V0dGluZ3MgPSBhY2NvdW50RGVmYXVsdFNldHRpbmdzKCdqc29uJyk7CiAgICAgICAgICAgIGFycmF5X3B1c2goJGxlZGdlckl0ZW1zLCBbCiAgICAgICAgICAgICAgICAnY29zdF9jZW50cmVfaWQnID0+ICRjb3N0X2NlbnRyZV9pZCwKICAgICAgICAgICAgICAgICdjaGFydF9vZl9hY2NvdW50X2lkJyA9PiAoaXNzZXQoJHJlcXVpc2l0aW9uSXRlbS0+cHJvZHVjdC0+Y29nc19hY2NvdW50X2lkKSAmJiAkcmVxdWlzaXRpb25JdGVtLT5wcm9kdWN0LT5jb2dzX2FjY291bnRfaWQgPiAwID8gJHJlcXVpc2l0aW9uSXRlbS0+cHJvZHVjdC0+Y29nc19hY2NvdW50X2lkIDogJGFjY291bnREZWZhdWx0U2V0dGluZ3NbJ2NvZ3NfYWNjb3VudCddKSwKICAgICAgICAgICAgICAgICdkZWJpdCcgPT4gJGRlbGl2ZXJ5UXR5ICogJHVuaXRQcmljZSwKICAgICAgICAgICAgICAgICdjcmVkaXQnID0+IDAsCiAgICAgICAgICAgICAgICAnbmFycmF0aW9uJyA9PiAiUHJvZHVjdCBEZWxpdmVyeSA6OiBDT0dTIERlYml0IiwKICAgICAgICAgICAgICAgICd0eXBlJyA9PiAncHJvZHVjdC1kZWxpdmVyeScsCiAgICAgICAgICAgICAgICAnc291cmNlJyA9PiAkcmVxdWlzaXRpb25EZWxpdmVyeUl0ZW0tPmlkCiAgICAgICAgICAgIF0pOwogICAgICAgICAgICBhcnJheV9wdXNoKCRsZWRnZXJJdGVtcywgWwogICAgICAgICAgICAgICAgJ2Nvc3RfY2VudHJlX2lkJyA9PiAkY29zdF9jZW50cmVfaWQsCiAgICAgICAgICAgICAgICAnY2hhcnRfb2ZfYWNjb3VudF9pZCcgPT4gKGlzc2V0KCRyZXF1aXNpdGlvbkl0ZW0tPnByb2R1Y3QtPmludmVudG9yeV9hY2NvdW50X2lkKSAmJiAkcmVxdWlzaXRpb25JdGVtLT5wcm9kdWN0LT5pbnZlbnRvcnlfYWNjb3VudF9pZCA+IDAgPyAkcmVxdWlzaXRpb25JdGVtLT5wcm9kdWN0LT5pbnZlbnRvcnlfYWNjb3VudF9pZCA6ICRhY2NvdW50RGVmYXVsdFNldHRpbmdzWydpbnZlbnRvcnlfYWNjb3VudCddKSwKICAgICAgICAgICAgICAgICdkZWJpdCcgPT4gMCwKICAgICAgICAgICAgICAgICdjcmVkaXQnID0+ICRkZWxpdmVyeVF0eSAqICR1bml0UHJpY2UsCiAgICAgICAgICAgICAgICAnbmFycmF0aW9uJyA9PiAiUHJvZHVjdCBEZWxpdmVyeSA6OiBJbnZlbnRvcnkgQ3JlZGl0IiwKICAgICAgICAgICAgICAgICd0eXBlJyA9PiAncHJvZHVjdC1kZWxpdmVyeScsCiAgICAgICAgICAgICAgICAnc291cmNlJyA9PiAkcmVxdWlzaXRpb25EZWxpdmVyeUl0ZW0tPmlkCiAgICAgICAgICAgIF0pOwogICAgICAgIH0KCiAgICAgICAgJHJlcXVpc2l0aW9uTW9kZWwgPSBSZXF1aXNpdGlvbjo6ZmluZE9yRmFpbCgkcmVxdWlzaXRpb25JZCk7CiAgICAgICAgUmVxdWlzaXRpb25UcmFja2luZzo6c3RvcmVSZXF1aXNpdGlvblRyYWNraW5nKCRyZXF1aXNpdGlvbk1vZGVsLT5pZCwgJ2RlbGl2ZXJlZCcpOwogICAgICAgIGlmICgkcmVxdWlzaXRpb25Nb2RlbC0+cmVxdWlzaXRpb25JdGVtcy0+c3VtKCdxY19xdHknKSA9PSAkcmVxdWlzaXRpb25Nb2RlbC0+cmVxdWlzaXRpb25JdGVtcy0+c3VtKCdkZWxpdmVyeV9xdHknKSkgewogICAgICAgICAgICAkcmVxdWlzaXRpb25Nb2RlbC0+dXBkYXRlKFsnZGVsaXZlcnlfc3RhdHVzJyA9PiAnZGVsaXZlcmVkJ10pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICRyZXF1aXNpdGlvbk1vZGVsLT51cGRhdGUoWydkZWxpdmVyeV9zdGF0dXMnID0+ICdwYXJ0aWFsLWRlbGl2ZXJlZCddKTsKICAgICAgICB9CgogICAgICAgIGlmIChpc3NldCgkbGVkZ2VySXRlbXNbMF0pKSB7CiAgICAgICAgICAgICRlbnRyeSA9IHNhdmVMZWRnZXJFbnRyaWVzKDUsIGRhdGUoJ1ktbS1kIEg6aTpzJyksIDEsICcnLCAnUHJvZHVjdCBEZWxpdmVyeScsICRsZWRnZXJJdGVtcywgKGlzc2V0KCRwdXJjaGFzZU9yZGVyLT5yZWxRdW90YXRpb24tPmV4Y2hhbmdlX3JhdGVfaWQpID8gJHB1cmNoYXNlT3JkZXItPnJlbFF1b3RhdGlvbi0+ZXhjaGFuZ2VfcmF0ZV9pZCA6IGdldEV4Y2hhbmdlUmF0ZXMoc3lzdGVtQ3VycmVuY3koKS0+aWQpKSwgMCwgMCwgMCwgZ2V0Q29zdENlbnRyZUNvbXBhbnkoJGNvc3RfY2VudHJlX2lkKSwgZmFsc2UsICdqc29uJyk7CiAgICAgICAgICAgIGlmIChpc3NldCgkZW50cnlbJ2VudHJ5J10tPmlkKSAmJiBpc3NldCgkcHVyY2hhc2VPcmRlci0+cmVsUXVvdGF0aW9uLT5zdXBwbGllcl9pZCkpIHsKICAgICAgICAgICAgICAgIHNhdmVQT0VudHJ5KCRlbnRyeSwgJHB1cmNoYXNlT3JkZXItPnJlbFF1b3RhdGlvbi0+c3VwcGxpZXJfaWQsICRwdXJjaGFzZU9yZGVyLT5pZCwgJ3Byb2R1Y3QtZGVsaXZlcnknKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvL0RlbGl2ZXJ5CgogICAgICAgIC8vUmVjZWl2ZQogICAgICAgICRyZXF1aXNpdGlvbkRlbGl2ZXJ5SXRlbS0+c3RhdHVzID0gJ2Fja25vd2xlZGdlJzsKICAgICAgICAkcmVxdWlzaXRpb25EZWxpdmVyeUl0ZW0tPnNhdmUoKTsKICAgICAgICBSZXF1aXNpdGlvblRyYWNraW5nOjpzdG9yZVJlcXVpc2l0aW9uVHJhY2tpbmcoJHJlcXVpc2l0aW9uSWQsICdyZWNlaXZlZCcpOwogICAgICAgIC8vUmVjZWl2ZQogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBydW5MZWRnZXJRdWVyaWVzKCRpZHMsICRncm4pCiAgICB7CiAgICAgICAgJGFjY291bnREZWZhdWx0U2V0dGluZ3MgPSBhY2NvdW50RGVmYXVsdFNldHRpbmdzKCdqc29uJyk7CiAgICAgICAgJHN0b2NrSW5zID0gR29vZHNSZWNlaXZlZEl0ZW1TdG9ja0luOjp3aGVyZUluKCdpZCcsICRpZHMpLT53aGVyZSgnaXNfZ3JuX2NvbXBsZXRlJywgJ3llcycpLT5nZXQoKTsKICAgICAgICAkaXRlbXMgPSBbXTsKICAgICAgICBpZiAoaXNzZXQoJHN0b2NrSW5zWzBdKSkgewogICAgICAgICAgICBmb3JlYWNoICgkc3RvY2tJbnMgYXMgJGtleSA9PiAkaXRlbSkgewogICAgICAgICAgICAgICAgJGNvc3RfY2VudHJlX2lkID0gJGl0ZW0tPnJlbEdvb2RzUmVjZWl2ZWRJdGVtcy0+cmVsR29vZHNSZWNlaXZlZE5vdGUtPnJlbFB1cmNoYXNlT3JkZXItPmNvc3RfY2VudHJlX2lkOwoKICAgICAgICAgICAgICAgICRkZWJpdF9hY2NvdW50ID0gJGFjY291bnREZWZhdWx0U2V0dGluZ3NbJ2ludmVudG9yeV9hY2NvdW50J107CiAgICAgICAgICAgICAgICBpZiAoaXNzZXQoJGl0ZW0tPnJlbEdvb2RzUmVjZWl2ZWRJdGVtcy0+cmVsUHJvZHVjdC0+aWQpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCRpdGVtLT5yZWxHb29kc1JlY2VpdmVkSXRlbXMtPnJlbFByb2R1Y3QtPmlzX3NlcnZpY2UgPT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICAkZGViaXRfYWNjb3VudCA9ICRhY2NvdW50RGVmYXVsdFNldHRpbmdzWydjb2dzX2FjY291bnQnXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRpdGVtLT5yZWxHb29kc1JlY2VpdmVkSXRlbXMtPnJlbFByb2R1Y3QtPmNvZ3NfYWNjb3VudF9pZCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRkZWJpdF9hY2NvdW50ID0gJGl0ZW0tPnJlbEdvb2RzUmVjZWl2ZWRJdGVtcy0+cmVsUHJvZHVjdC0+Y29nc19hY2NvdW50X2lkOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRpdGVtLT5yZWxHb29kc1JlY2VpdmVkSXRlbXMtPnJlbFByb2R1Y3QtPmludmVudG9yeV9hY2NvdW50X2lkID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGRlYml0X2FjY291bnQgPSAkaXRlbS0+cmVsR29vZHNSZWNlaXZlZEl0ZW1zLT5yZWxQcm9kdWN0LT5pbnZlbnRvcnlfYWNjb3VudF9pZDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBhcnJheV9wdXNoKCRpdGVtcywgWwogICAgICAgICAgICAgICAgICAgICdjb3N0X2NlbnRyZV9pZCcgPT4gJGNvc3RfY2VudHJlX2lkLAogICAgICAgICAgICAgICAgICAgICdjaGFydF9vZl9hY2NvdW50X2lkJyA9PiAkZGViaXRfYWNjb3VudCwKICAgICAgICAgICAgICAgICAgICAnZGViaXQnID0+ICRpdGVtLT50b3RhbF9hbW91bnQsCiAgICAgICAgICAgICAgICAgICAgJ2NyZWRpdCcgPT4gMCwKICAgICAgICAgICAgICAgICAgICAnbmFycmF0aW9uJyA9PiAnR1JOIDo6IEludmVudG9yeSBEZWJpdCcsCiAgICAgICAgICAgICAgICAgICAgJ3R5cGUnID0+ICdncm4nLAogICAgICAgICAgICAgICAgICAgICdzb3VyY2UnID0+ICRpdGVtLT5pZAogICAgICAgICAgICAgICAgXSk7CgogICAgICAgICAgICAgICAgYXJyYXlfcHVzaCgkaXRlbXMsIFsKICAgICAgICAgICAgICAgICAgICAnY29zdF9jZW50cmVfaWQnID0+ICRjb3N0X2NlbnRyZV9pZCwKICAgICAgICAgICAgICAgICAgICAnY2hhcnRfb2ZfYWNjb3VudF9pZCcgPT4gJGFjY291bnREZWZhdWx0U2V0dGluZ3NbJ2dyaXJfYWNjb3VudCddLAogICAgICAgICAgICAgICAgICAgICdkZWJpdCcgPT4gMCwKICAgICAgICAgICAgICAgICAgICAnY3JlZGl0JyA9PiAkaXRlbS0+dG90YWxfYW1vdW50LAogICAgICAgICAgICAgICAgICAgICduYXJyYXRpb24nID0+ICdHUk4gOjogR1IvSVIgQ3JlZGl0JywKICAgICAgICAgICAgICAgICAgICAndHlwZScgPT4gJ2dybicsCiAgICAgICAgICAgICAgICAgICAgJ3NvdXJjZScgPT4gJGl0ZW0tPmlkCiAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHNhdmVMZWRnZXJFbnRyaWVzKDUsIGRhdGUoJ1ktbS1kIEg6aTpzJyksIDEsICcnLCAnR1JOJywgJGl0ZW1zLCAkZ3JuLT5yZWxQdXJjaGFzZU9yZGVyLT5yZWxRdW90YXRpb24tPmV4Y2hhbmdlX3JhdGVfaWQsIDAsIDAsIDAsIGdldENvc3RDZW50cmVDb21wYW55KCRncm4tPnJlbFB1cmNoYXNlT3JkZXItPmNvc3RfY2VudHJlX2lkKSwgZmFsc2UsICdqc29uJyk7CiAgICB9Cn0K