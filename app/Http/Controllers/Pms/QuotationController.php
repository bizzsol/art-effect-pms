<?php
bolt_decrypt( __FILE__ , 'PuFIdH'); return 0;
##!!!##CgpuYW1lc3BhY2UgQXBwXEh0dHBcQ29udHJvbGxlcnNcUG1zOwoKdXNlIEFwcFxIdHRwXENvbnRyb2xsZXJzXENvbnRyb2xsZXI7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xRdW90YXRpb25IaXN0b3J5Owp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUXVvdGF0aW9uSGlzdG9yeUl0ZW07CnVzZSBJbGx1bWluYXRlXEh0dHBcUmVxdWVzdDsKdXNlIEFwcFxIdHRwXFJlcXVlc3RzOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUHJvZHVjdDsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFN1cHBsaWVyczsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFB1cmNoYXNlXFB1cmNoYXNlT3JkZXI7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xQdXJjaGFzZVxQdXJjaGFzZU9yZGVyTWlsZXN0b25lOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUHVyY2hhc2VcUHVyY2hhc2VPcmRlckl0ZW07CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xSZnBcUmVxdWVzdFByb3Bvc2FsOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUmZwXFJlcXVlc3RQcm9wb3NhbERldGFpbHM7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xSZnBcUmVxdWVzdFByb3Bvc2FsRGVmaW5lU3VwcGxpZXI7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xRdW90YXRpb25zOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUXVvdGF0aW9uc0l0ZW1zOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUGF5bWVudFRlcm07CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xTdXBwbGllclBheW1lbnRUZXJtOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcU3VwcGxpZXJQYXltZW50Owp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUmVxdWlzaXRpb247CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xSZXF1aXNpdGlvblRyYWNraW5nOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUmVxdWlzaXRpb25JdGVtOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUmZwXFJlcXVlc3RQcm9wb3NhbEFwcHJvdmFsOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUHVyY2hhc2VcUHVyY2hhc2VPcmRlclJlcXVpc2l0aW9uOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcQWNjb3VudHNcQ3VycmVuY3lUeXBlOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcQWNjb3VudHNcRXhjaGFuZ2VSYXRlOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcQWNjb3VudHNcQ29zdENlbnRyZTsKdXNlIEFwcFxNb2RlbHNcSHJcVW5pdDsKdXNlIEFwcFxNb2RlbHNcSHJcRGVwYXJ0bWVudDsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXENhdGVnb3J5Owp1c2UgQXBwXFVzZXI7CnVzZSBBcHAsIElsbHVtaW5hdGVcU3VwcG9ydFxGYWNhZGVzXERCLCBCYXJyeXZkaFxEb21QREZcRmFjYWRlXFBkZiwgWWFqcmFcRGF0YVRhYmxlc1xGYWNhZGVzXERhdGFUYWJsZXM7CnVzZSBJbGx1bWluYXRlXFN1cHBvcnRcRmFjYWRlc1xBdXRoOwoKY2xhc3MgUXVvdGF0aW9uQ29udHJvbGxlciBleHRlbmRzIENvbnRyb2xsZXIKewogICAgLyoqCiAgICAgKiBEaXNwbGF5IGEgbGlzdGluZyBvZiB0aGUgcmVzb3VyY2UuCiAgICAgKgogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KICAgIHB1YmxpYyBmdW5jdGlvbiBpbmRleCgpCiAgICB7CiAgICAgICAgJHRpdGxlID0gJ1F1b3RhdGlvbnMgTGlzdCc7CiAgICAgICAgdHJ5IHsKCiAgICAgICAgICAgICRxdW90YXRpb25zID0gUXVvdGF0aW9uczo6d2l0aChbCiAgICAgICAgICAgICAgICAncmVsUmVxdWVzdFByb3Bvc2FsJywKICAgICAgICAgICAgICAgICdyZWxTdXBwbGllcnMnLAogICAgICAgICAgICAgICAgJ2V4Y2hhbmdlUmF0ZS5jdXJyZW5jeScsCiAgICAgICAgICAgICAgICAnaGlzdG9yaWVzJwogICAgICAgICAgICBdKQogICAgICAgICAgICAtPndoZXJlSGFzKCdyZWxTdXBwbGllcnMnLCBmdW5jdGlvbigkcXVlcnkpewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVOb3RJbignbmFtZScsIGlnbm9yZVN1cHBsaWVycygpKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT53aGVuKCFhdXRoKCktPnVzZXIoKS0+aGFzQW55Um9sZShbJ1B1cmNoYXNlLURlcGFydG1lbnQnLCAnQXVkaXQnLCAnQmlsbGluZycsICdNYW5hZ2VtZW50JywgJ0FjY291bnRzJ10pLCBmdW5jdGlvbigkcXVlcnkpewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVlc3RQcm9wb3NhbC5yZXF1ZXN0UHJvcG9zYWxSZXF1aXNpdGlvbi5yZWxSZXF1aXNpdGlvbicsIGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2Fzc2lnbmVkX3VzZXJfaWQnLCBhdXRoKCktPnVzZXIoKS0+aWQpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+d2hlcmVIYXMoJ3JlbFJlcXVlc3RQcm9wb3NhbC5yZXF1ZXN0UHJvcG9zYWxSZXF1aXNpdGlvbi5yZWxSZXF1aXNpdGlvbicsIGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUluKCdocl91bml0X2lkJywgYXV0aCgpLT51c2VyKCktPnByaW9yaXRpZXMtPnBsdWNrKCdocl91bml0X2lkJyktPnRvQXJyYXkoKSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+d2hlcmVOb3RJbigndHlwZScsIFsnZGlyZWN0LXB1cmNoYXNlJ10pCiAgICAgICAgICAgIC0+d2hlbighZGF0YXRhYmxlT3JkZXJpbmcoKSwgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+b3JkZXJieSgnaWQnLCAnZGVzYycpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGlmIChyZXF1ZXN0KCktPmFqYXgoKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIERhdGFUYWJsZXM6Om9mKCRxdW90YXRpb25zKQogICAgICAgICAgICAgICAgICAgIC0+YWRkSW5kZXhDb2x1bW4oKQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdDU19udW1iZXInLCBmdW5jdGlvbiAoJHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgb25jbGljaz0ib3BlblJlcXVlc3RQcm9wb3NhbE1vZGFsKCcgLiAkdmFsdWVzLT5yZXF1ZXN0X3Byb3Bvc2FsX2lkIC4gJykiICBjbGFzcz0iYnRuIGJ0bi1saW5rIj4nIC4gJHZhbHVlcy0+cmVsUmVxdWVzdFByb3Bvc2FsLT5yZWZlcmVuY2Vfbm8gLiAnPC9hPic7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbignQ1NfbnVtYmVyJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVlc3RQcm9wb3NhbCcsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ3JlZmVyZW5jZV9ubycsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ0NTX251bWJlcicsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBSZXF1ZXN0UHJvcG9zYWw6OnNlbGVjdCgncmVxdWVzdF9wcm9wb3NhbHMucmVmZXJlbmNlX25vJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3JlcXVlc3RfcHJvcG9zYWxzLmlkJywgJ3F1b3RhdGlvbnMucmVxdWVzdF9wcm9wb3NhbF9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZWRpdENvbHVtbigncXVvdGF0aW9uX2RhdGUnLCBmdW5jdGlvbiAoJHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGF0ZSgnWS1tLWQnLCBzdHJ0b3RpbWUoJHZhbHVlcy0+cXVvdGF0aW9uX2RhdGUpKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdxdW90YXRpb25fZGF0ZScsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ3F1b3RhdGlvbl9kYXRlJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdxdW90YXRpb25fZGF0ZScsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT5vcmRlckJ5KCdxdW90YXRpb25fZGF0ZScsICRvcmRlcik7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmVkaXRDb2x1bW4oJ3JlZmVyZW5jZV9ubycsIGZ1bmN0aW9uICgkdmFsdWVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnPGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiBvbmNsaWNrPSJvcGVuTW9kYWwoJyAuICR2YWx1ZXMtPmlkIC4gJykiICBjbGFzcz0iYnRuIGJ0bi1saW5rIj4nIC4gJHZhbHVlcy0+cmVmZXJlbmNlX25vIC4gJzwvYT4nOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3N1cHBsaWVycycsIGZ1bmN0aW9uICgkdmFsdWVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkdmFsdWVzLT5yZWxTdXBwbGllcnMtPm5hbWUgLiAnICgnIC4gJHZhbHVlcy0+cmVsU3VwcGxpZXJzLT5jb2RlIC4gJyknOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3N1cHBsaWVycycsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxTdXBwbGllcnMnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbignc3VwcGxpZXJzJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwbGVhc2VTb3J0TWUoJHF1ZXJ5LCAkb3JkZXIsIFN1cHBsaWVyczo6c2VsZWN0KCdzdXBwbGllcnMubmFtZScpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCdzdXBwbGllcnMuaWQnLCAncXVvdGF0aW9ucy5zdXBwbGllcl9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdjdXJyZW5jeScsIGZ1bmN0aW9uICgkdmFsdWVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpc3NldCgkdmFsdWVzLT5leGNoYW5nZVJhdGUtPmN1cnJlbmN5LT5jb2RlKSA/ICR2YWx1ZXMtPmV4Y2hhbmdlUmF0ZS0+Y3VycmVuY3ktPmNvZGUgOiAnJzsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdjdXJyZW5jeScsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdleGNoYW5nZVJhdGUuY3VycmVuY3knLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdjb2RlJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbignY3VycmVuY3knLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgRXhjaGFuZ2VSYXRlOjpzZWxlY3QoJ2N1cnJlbmNpZXMuY29kZScpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ2N1cnJlbmNpZXMnLCAnY3VycmVuY2llcy5pZCcsICc9JywgJ2V4Y2hhbmdlX3JhdGVzLmN1cnJlbmN5X2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ2V4Y2hhbmdlX3JhdGVzLmlkJywgJ3F1b3RhdGlvbnMuZXhjaGFuZ2VfcmF0ZV9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZWRpdENvbHVtbignc3RhdHVzJywgZnVuY3Rpb24gKCR2YWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVjZmlyc3QoJHZhbHVlcy0+c3RhdHVzKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZWRpdENvbHVtbigndHlwZScsIGZ1bmN0aW9uICgkdmFsdWVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB1Y2ZpcnN0KCR2YWx1ZXMtPnR5cGUpOwogICAgICAgICAgICAgICAgICAgIH0pCgogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdyZXF1aXNpdGlvbnMnLCBmdW5jdGlvbiAoJHF1b3RhdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb25zID0gJyc7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHF1b3RhdGlvbi0+cmVsUmVxdWVzdFByb3Bvc2FsLT5yZXF1ZXN0UHJvcG9zYWxSZXF1aXNpdGlvbi0+Y291bnQoKSA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRxdW90YXRpb24tPnJlbFJlcXVlc3RQcm9wb3NhbC0+cmVxdWVzdFByb3Bvc2FsUmVxdWlzaXRpb24gYXMgJGtleSA9PiAkcmVxdWlzaXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb25zIC49ICgka2V5ID4gMCA/ICcsICcgOiAnJykgLiAnPGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiBkYXRhLXNyYz0iJyAuIHJvdXRlKCdwbXMucmVxdWlzaXRpb24ubGlzdC52aWV3LnNob3cnLCAkcmVxdWlzaXRpb24tPnJlbFJlcXVpc2l0aW9uLT5pZCkgLiAnIiBjbGFzcz0idGV4dC1wcmltYXJ5IHJlcXVpc2l0aW9uIG0tMSByb3VuZGVkIHNob3dSZXF1aXN0aW9uRGV0YWlscyIgb25jbGljaz0icmVxdWlzdGlvbkRldGFpbHMoJCh0aGlzKSkiPicgLiAkcmVxdWlzaXRpb24tPnJlbFJlcXVpc2l0aW9uLT5yZWZlcmVuY2Vfbm8gLiAnPC9hPic7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcmVxdWlzaXRpb25zOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3JlcXVpc2l0aW9ucycsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVlc3RQcm9wb3NhbC5yZXF1ZXN0UHJvcG9zYWxSZXF1aXNpdGlvbi5yZWxSZXF1aXNpdGlvbicsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdyZWZlcmVuY2Vfbm8nLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdyZXF1aXNpdGlvbnMnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgUmVxdWVzdFByb3Bvc2FsOjpzZWxlY3QoJ3JlcXVpc2l0aW9ucy5yZWZlcmVuY2Vfbm8nKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdyZXF1aXNpdGlvbnMnLCAncmVxdWlzaXRpb25zLmlkJywgJz0nLCAncmVxdWVzdF9wcm9wb3NhbF9yZXF1aXNpdGlvbnMucmVxdWlzaXRpb25faWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdyZXF1ZXN0X3Byb3Bvc2FsX3JlcXVpc2l0aW9ucycsICdyZXF1ZXN0X3Byb3Bvc2FsX3JlcXVpc2l0aW9ucy5yZXF1ZXN0X3Byb3Bvc2FsX2lkJywgJz0nLCAncmVxdWVzdF9wcm9wb3NhbHMuaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbigncmVxdWVzdF9wcm9wb3NhbHMuaWQnLCAncXVvdGF0aW9ucy5yZXF1ZXN0X3Byb3Bvc2FsX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+dGFrZSgxKQogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3Byb2R1Y3RzJywgZnVuY3Rpb24gKCRxdW90YXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHByb2R1Y3RzID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgICRzbCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICRhcnJheSA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHF1b3RhdGlvbi0+cmVsUmVxdWVzdFByb3Bvc2FsLT5yZXF1ZXN0UHJvcG9zYWxEZXRhaWxzLT5jb3VudCgpID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yZWFjaCAoJHF1b3RhdGlvbi0+cmVsUmVxdWVzdFByb3Bvc2FsLT5yZXF1ZXN0UHJvcG9zYWxEZXRhaWxzIGFzICRrZXkgPT4gJHByb2R1Y3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNzZXQoJHByb2R1Y3QtPnByb2R1Y3QtPmlkKSAmJiAhaW5fYXJyYXkoJHByb2R1Y3QtPnByb2R1Y3QtPmlkLCAkYXJyYXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzbCsrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcHJvZHVjdHMgLj0gKCRzbCA+IDEgPyAnLCAnIDogJycpIC4gJHByb2R1Y3QtPnByb2R1Y3QtPm5hbWUgLiAnICcgLiBnZXRQcm9kdWN0QXR0cmlidXRlc0Zhc3RlcigkcHJvZHVjdC0+cHJvZHVjdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5X3B1c2goJGFycmF5LCAkcHJvZHVjdC0+cHJvZHVjdC0+aWQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRwcm9kdWN0czsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdwcm9kdWN0cycsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUmVxdWVzdFByb3Bvc2FsLnJlcXVlc3RQcm9wb3NhbERldGFpbHMucHJvZHVjdCcsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5vcldoZXJlKGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVlc3RQcm9wb3NhbC5yZXF1ZXN0UHJvcG9zYWxEZXRhaWxzLnByb2R1Y3QuYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24nLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPm9yV2hlcmVIYXMoJ3JlbFJlcXVlc3RQcm9wb3NhbC5yZXF1ZXN0UHJvcG9zYWxEZXRhaWxzLnByb2R1Y3QuYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24uYXR0cmlidXRlJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdwcm9kdWN0cycsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBSZXF1ZXN0UHJvcG9zYWw6OnNlbGVjdCgncHJvZHVjdHMubmFtZScpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ3Byb2R1Y3RzJywgJ3Byb2R1Y3RzLmlkJywgJz0nLCAncmVxdWVzdF9wcm9wb3NhbF9kZXRhaWxzLnByb2R1Y3RfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdyZXF1ZXN0X3Byb3Bvc2FsX2RldGFpbHMnLCAncmVxdWVzdF9wcm9wb3NhbF9kZXRhaWxzLnJlcXVlc3RfcHJvcG9zYWxfaWQnLCAnPScsICdyZXF1ZXN0X3Byb3Bvc2Fscy5pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ3JlcXVlc3RfcHJvcG9zYWxfcmVxdWlzaXRpb25zJywgJ3JlcXVlc3RfcHJvcG9zYWxfcmVxdWlzaXRpb25zLnJlcXVlc3RfcHJvcG9zYWxfaWQnLCAnPScsICdyZXF1ZXN0X3Byb3Bvc2Fscy5pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCdyZXF1ZXN0X3Byb3Bvc2Fscy5pZCcsICdxdW90YXRpb25zLnJlcXVlc3RfcHJvcG9zYWxfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT50YWtlKDEpCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfSkKCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2FwcHJvdmFscycsIGZ1bmN0aW9uICgkcXVvdGF0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRhcHByb3ZhbHMgPSAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoaXNzZXQoJHF1b3RhdGlvbi0+cmVsUmVxdWVzdFByb3Bvc2FsLT5hcHByb3ZhbHNbMF0pKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRxdW90YXRpb24tPnJlbFJlcXVlc3RQcm9wb3NhbC0+YXBwcm92YWxzIGFzICRrZXkgPT4gJGFwcHJvdmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFwcHJvdmFscyAuPSAnPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi14cyBidG4tJyAuICgkYXBwcm92YWwtPnJlc3BvbnNlID09ICdwZW5kaW5nJyA/ICd3YXJuaW5nJyA6ICgkYXBwcm92YWwtPnJlc3BvbnNlID09ICdhcHByb3ZlZCcgPyAnc3VjY2VzcycgOiAnZGFuZ2VyJykpIC4gJyI+JyAuICRhcHByb3ZhbC0+dXNlci0+bmFtZSAuICcgWycgLiB1Y3dvcmRzKCRhcHByb3ZhbC0+cmVzcG9uc2UpIC4gJ108L2J1dHRvbj4mbmJzcDsnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGFwcHJvdmFsczsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdhcHByb3ZhbHMnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUmVxdWVzdFByb3Bvc2FsLmFwcHJvdmFscy51c2VyJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5vcldoZXJlSGFzKCdyZWxSZXF1ZXN0UHJvcG9zYWwuYXBwcm92YWxzJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdzdGF0dXMnLCAnTElLRScsICclJyAuIHN0cnRvbG93ZXIoJGtleXdvcmQpIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCgogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdhY3Rpb25zJywgZnVuY3Rpb24gKCR2YWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgPSAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgb25jbGljaz0ib3Blbk1vZGFsKCcgLiAkdmFsdWVzLT5pZCAuICcpIiAgY2xhc3M9ImJ0biBidG4teHMgYnRuLWluZm8iPjxpIGNsYXNzPSJsYXMgbGEtZXllIj48L2k+PC9hPic7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHZhbHVlcy0+aXNfYXBwcm92ZWQgPT0gJ3BlbmRpbmcnICYmICR2YWx1ZXMtPnR5cGUgIT09ICdkaXJlY3QtcHVyY2hhc2UnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnPGEgaHJlZj0iJyAuIHJvdXRlKCdwbXMucXVvdGF0aW9uLnF1b3RhdGlvbnMuZWRpdCcsICR2YWx1ZXMtPmlkKSAuICciIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi1zdWNjZXNzIG1sLTEiIHRpdGxlPSJRdW90YXRpb24gRWRpdCI+PGkgY2xhc3M9ImxhcyBsYS1lZGl0Ij48L2k+PC9hPic7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkdmFsdWVzLT5oaXN0b3JpZXMtPmNvdW50KCkgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnPGEgaHJlZj0iJyAuIHJvdXRlKCdwbXMucXVvdGF0aW9uLmhpc3RvcnknLCAkdmFsdWVzLT5pZCkgLiAnIiBjbGFzcz0iYnRuIGJ0bi14cyBidG4td2FybmluZyBtbC0xIiB0aXRsZT0iUXVvdGF0aW9uIEJhcmdhaW4gSGlzdG9yeSI+PGkgY2xhc3M9ImxhcyBsYS1jbG9jayI+PC9pPjwvYT4nOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHZhbHVlcy0+aXNfYXBwcm92ZWQgPT0gInByZS1wcm9jZXNzaW5nIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxhIG9uY2xpY2s9InNlbmRUb01hbmFnZW1lbnQoJyAuICR2YWx1ZXMtPmlkIC4gJykiIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi1zdWNjZXNzIj48aSBjbGFzcz0ibGFzIGxhLWNoZWNrIj48L2k+Jm5ic3A7U2VuZCB0byBNYW5hZ2VtZW50PC9hPic7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRhY3Rpb25zOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5yYXdDb2x1bW5zKFsnQ1NfbnVtYmVyJywgJ3JlZmVyZW5jZV9ubycsICdyZXF1aXNpdGlvbnMnLCAncHJvZHVjdHMnLCAnYXBwcm92YWxzJywgJ2FjdGlvbnMnXSkKICAgICAgICAgICAgICAgICAgICAtPm1ha2UodHJ1ZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5xdW90YXRpb24uaW5kZXgnLCBbCiAgICAgICAgICAgICAgICAndGl0bGUnID0+ICR0aXRsZSwKICAgICAgICAgICAgICAgICdoZWFkZXJDb2x1bW5zJyA9PiAkdGhpcy0+ZXN0aW1hdGVIZWFkZXJDb2x1bW5zKCkKICAgICAgICAgICAgXSk7CiAgICAgICAgfSBjYXRjaCAoXFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIGVzdGltYXRlSGVhZGVyQ29sdW1ucygkdmFsdWUgPSAnJykKICAgIHsKICAgICAgICByZXR1cm4gYXJyYXkoCiAgICAgICAgICAgIFsnU0wnLCAnU0wnXSwKICAgICAgICAgICAgWydDU19udW1iZXInLCAnQ1NfbnVtYmVyJywgJ3RleHQtY2VudGVyJywgJ3dpZHRoOjE1JSddLAogICAgICAgICAgICBbJ3F1b3RhdGlvbl9kYXRlJywgJ3F1b3RhdGlvbl9kYXRlJywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsncmVmZXJlbmNlX25vJywgJ3JlZmVyZW5jZV9ubycsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3JlcXVpc2l0aW9ucycsICdyZXF1aXNpdGlvbnMnLCAndGV4dC1sZWZ0J10sCiAgICAgICAgICAgIFsncHJvZHVjdHMnLCAncHJvZHVjdHMnLCAndGV4dC1sZWZ0J10sCiAgICAgICAgICAgIFsnc3VwcGxpZXJzJywgJ3N1cHBsaWVycycsICd0ZXh0LWxlZnQnXSwKICAgICAgICAgICAgWydhcHByb3ZhbHMnLCAnYXBwcm92YWxzJywgJ3RleHQtbGVmdCddLAogICAgICAgICAgICBbJ2FjdGlvbnMnLCAnYWN0aW9ucycsICd0ZXh0LWNlbnRlciddCiAgICAgICAgKTsKICAgIH0KCiAgICBwdWJsaWMgZnVuY3Rpb24gZXN0aW1hdGUoKQogICAgewogICAgICAgICR0aXRsZSA9ICdFc3RpbWF0ZSBMaXN0JzsKICAgICAgICB0cnkgewoKICAgICAgICAgICAgJHF1b3RhdGlvbnMgPSBRdW90YXRpb25zOjp3aXRoKFsKICAgICAgICAgICAgICAgICdyZWxTdXBwbGllcnMnLAogICAgICAgICAgICAgICAgJ2V4Y2hhbmdlUmF0ZS5jdXJyZW5jeScsCiAgICAgICAgICAgICAgICAncmVsUmVxdWVzdFByb3Bvc2FsLnJlcXVlc3RQcm9wb3NhbERldGFpbHMucHJvZHVjdC5hdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGUnLAogICAgICAgICAgICAgICAgJ3JlbFJlcXVlc3RQcm9wb3NhbC5yZXF1ZXN0UHJvcG9zYWxSZXF1aXNpdGlvbi5yZWxSZXF1aXNpdGlvbicsCiAgICAgICAgICAgICAgICAncmVsU2VsZlF1b3RhdGlvblN1cHBsaWVyQnlQcm9wb3NhbElkLnJlbFN1cHBsaWVycycsCiAgICAgICAgICAgICAgICAncmVsUmVxdWVzdFByb3Bvc2FsLmFwcHJvdmFscy51c2VyJwogICAgICAgICAgICBdKQogICAgICAgICAgICAtPndoZW4oIWF1dGgoKS0+dXNlcigpLT5oYXNBbnlSb2xlKFsnUHVyY2hhc2UtRGVwYXJ0bWVudCcsICdBdWRpdCcsICdCaWxsaW5nJywgJ01hbmFnZW1lbnQnLCAnQWNjb3VudHMnXSksIGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUmVxdWVzdFByb3Bvc2FsLnJlcXVlc3RQcm9wb3NhbFJlcXVpc2l0aW9uLnJlbFJlcXVpc2l0aW9uJywgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnYXNzaWduZWRfdXNlcl9pZCcsIGF1dGgoKS0+dXNlcigpLT5pZCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT53aGVyZUhhcygncmVsUmVxdWVzdFByb3Bvc2FsLnJlcXVlc3RQcm9wb3NhbFJlcXVpc2l0aW9uLnJlbFJlcXVpc2l0aW9uJywgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSW4oJ2hyX3VuaXRfaWQnLCBhdXRoKCktPnVzZXIoKS0+cHJpb3JpdGllcy0+cGx1Y2soJ2hyX3VuaXRfaWQnKS0+dG9BcnJheSgpKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT53aGVyZSgndHlwZScsICdkaXJlY3QtcHVyY2hhc2UnKQogICAgICAgICAgICAtPndoZW4oIWRhdGF0YWJsZU9yZGVyaW5nKCksIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyYnkoJ2lkJywgJ2Rlc2MnKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBpZiAocmVxdWVzdCgpLT5hamF4KCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBEYXRhVGFibGVzOjpvZigkcXVvdGF0aW9ucykKICAgICAgICAgICAgICAgICAgICAtPmFkZEluZGV4Q29sdW1uKCkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignQ1NfbnVtYmVyJywgZnVuY3Rpb24gKCR2YWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIG9uY2xpY2s9Im9wZW5SZXF1ZXN0UHJvcG9zYWxNb2RhbCgnIC4gJHZhbHVlcy0+cmVsUmVxdWVzdFByb3Bvc2FsLT5pZCAuICcpIiAgY2xhc3M9ImJ0biBidG4tbGluayI+JyAuICR2YWx1ZXMtPnJlbFJlcXVlc3RQcm9wb3NhbC0+cmVmZXJlbmNlX25vIC4gJzwvYT4nOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ0NTX251bWJlcicsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxSZXF1ZXN0UHJvcG9zYWwnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdyZWZlcmVuY2Vfbm8nLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdDU19udW1iZXInLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgUmVxdWVzdFByb3Bvc2FsOjpzZWxlY3QoJ3JlcXVlc3RfcHJvcG9zYWxzLnJlZmVyZW5jZV9ubycpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCdyZXF1ZXN0X3Byb3Bvc2Fscy5pZCcsICdxdW90YXRpb25zLnJlcXVlc3RfcHJvcG9zYWxfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT50YWtlKDEpCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmVkaXRDb2x1bW4oJ3F1b3RhdGlvbl9kYXRlJywgZnVuY3Rpb24gKCR2YWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRhdGUoJ1ktbS1kJywgc3RydG90aW1lKCR2YWx1ZXMtPnF1b3RhdGlvbl9kYXRlKSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbigncXVvdGF0aW9uX2RhdGUnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdxdW90YXRpb25fZGF0ZScsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbigncXVvdGF0aW9uX2RhdGUnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+b3JkZXJCeSgncXVvdGF0aW9uX2RhdGUnLCAkb3JkZXIpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5lZGl0Q29sdW1uKCdyZWZlcmVuY2Vfbm8nLCBmdW5jdGlvbiAoJHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgb25jbGljaz0ib3Blbk1vZGFsKCcgLiAkdmFsdWVzLT5pZCAuICcpIiAgY2xhc3M9ImJ0biBidG4tbGluayI+JyAuICR2YWx1ZXMtPnJlZmVyZW5jZV9ubyAuICc8L2E+JzsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdyZXF1aXNpdGlvbnMnLCBmdW5jdGlvbiAoJHF1b3RhdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb25zID0gJyc7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHF1b3RhdGlvbi0+cmVsUmVxdWVzdFByb3Bvc2FsLT5yZXF1ZXN0UHJvcG9zYWxSZXF1aXNpdGlvbi0+Y291bnQoKSA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRxdW90YXRpb24tPnJlbFJlcXVlc3RQcm9wb3NhbC0+cmVxdWVzdFByb3Bvc2FsUmVxdWlzaXRpb24gYXMgJGtleSA9PiAkcmVxdWlzaXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb25zIC49ICgka2V5ID4gMCA/ICcsICcgOiAnJykgLiAnPGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiBkYXRhLXNyYz0iJyAuIHJvdXRlKCdwbXMucmVxdWlzaXRpb24ubGlzdC52aWV3LnNob3cnLCAkcmVxdWlzaXRpb24tPnJlbFJlcXVpc2l0aW9uLT5pZCkgLiAnIiBjbGFzcz0idGV4dC1wcmltYXJ5IHJlcXVpc2l0aW9uIG0tMSByb3VuZGVkIHNob3dSZXF1aXN0aW9uRGV0YWlscyIgb25jbGljaz0icmVxdWlzdGlvbkRldGFpbHMoJCh0aGlzKSkiPicgLiAkcmVxdWlzaXRpb24tPnJlbFJlcXVpc2l0aW9uLT5yZWZlcmVuY2Vfbm8gLiAnPC9hPic7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcmVxdWlzaXRpb25zOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3JlcXVpc2l0aW9ucycsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVlc3RQcm9wb3NhbC5yZXF1ZXN0UHJvcG9zYWxSZXF1aXNpdGlvbi5yZWxSZXF1aXNpdGlvbicsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdyZWZlcmVuY2Vfbm8nLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdyZXF1aXNpdGlvbnMnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgUmVxdWVzdFByb3Bvc2FsOjpzZWxlY3QoJ3JlcXVpc2l0aW9ucy5yZWZlcmVuY2Vfbm8nKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdyZXF1aXNpdGlvbnMnLCAncmVxdWlzaXRpb25zLmlkJywgJz0nLCAncmVxdWVzdF9wcm9wb3NhbF9yZXF1aXNpdGlvbnMucmVxdWlzaXRpb25faWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdyZXF1ZXN0X3Byb3Bvc2FsX3JlcXVpc2l0aW9ucycsICdyZXF1ZXN0X3Byb3Bvc2FsX3JlcXVpc2l0aW9ucy5yZXF1ZXN0X3Byb3Bvc2FsX2lkJywgJz0nLCAncmVxdWVzdF9wcm9wb3NhbHMuaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbigncmVxdWVzdF9wcm9wb3NhbHMuaWQnLCAncXVvdGF0aW9ucy5yZXF1ZXN0X3Byb3Bvc2FsX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+dGFrZSgxKQogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3Byb2R1Y3RzJywgZnVuY3Rpb24gKCRxdW90YXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHByb2R1Y3RzID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgICRzbCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICRhcnJheSA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHF1b3RhdGlvbi0+cmVsUmVxdWVzdFByb3Bvc2FsLT5yZXF1ZXN0UHJvcG9zYWxEZXRhaWxzLT5jb3VudCgpID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yZWFjaCAoJHF1b3RhdGlvbi0+cmVsUmVxdWVzdFByb3Bvc2FsLT5yZXF1ZXN0UHJvcG9zYWxEZXRhaWxzIGFzICRrZXkgPT4gJHByb2R1Y3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNzZXQoJHByb2R1Y3QtPnByb2R1Y3QtPmlkKSAmJiAhaW5fYXJyYXkoJHByb2R1Y3QtPnByb2R1Y3QtPmlkLCAkYXJyYXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzbCsrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcHJvZHVjdHMgLj0gKCRzbCA+IDEgPyAnLCAnIDogJycpIC4gJHByb2R1Y3QtPnByb2R1Y3QtPm5hbWUgLiAnICcgLiBnZXRQcm9kdWN0QXR0cmlidXRlc0Zhc3RlcigkcHJvZHVjdC0+cHJvZHVjdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5X3B1c2goJGFycmF5LCAkcHJvZHVjdC0+cHJvZHVjdC0+aWQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRwcm9kdWN0czsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdwcm9kdWN0cycsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUmVxdWVzdFByb3Bvc2FsLnJlcXVlc3RQcm9wb3NhbERldGFpbHMucHJvZHVjdCcsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5vcldoZXJlKGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVlc3RQcm9wb3NhbC5yZXF1ZXN0UHJvcG9zYWxEZXRhaWxzLnByb2R1Y3QuYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24nLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPm9yV2hlcmVIYXMoJ3JlbFJlcXVlc3RQcm9wb3NhbC5yZXF1ZXN0UHJvcG9zYWxEZXRhaWxzLnByb2R1Y3QuYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24uYXR0cmlidXRlJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdwcm9kdWN0cycsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBSZXF1ZXN0UHJvcG9zYWw6OnNlbGVjdCgncHJvZHVjdHMubmFtZScpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ3Byb2R1Y3RzJywgJ3Byb2R1Y3RzLmlkJywgJz0nLCAncmVxdWVzdF9wcm9wb3NhbF9kZXRhaWxzLnByb2R1Y3RfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdyZXF1ZXN0X3Byb3Bvc2FsX2RldGFpbHMnLCAncmVxdWVzdF9wcm9wb3NhbF9kZXRhaWxzLnJlcXVlc3RfcHJvcG9zYWxfaWQnLCAnPScsICdyZXF1ZXN0X3Byb3Bvc2Fscy5pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ3JlcXVlc3RfcHJvcG9zYWxfcmVxdWlzaXRpb25zJywgJ3JlcXVlc3RfcHJvcG9zYWxfcmVxdWlzaXRpb25zLnJlcXVlc3RfcHJvcG9zYWxfaWQnLCAnPScsICdyZXF1ZXN0X3Byb3Bvc2Fscy5pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCdyZXF1ZXN0X3Byb3Bvc2Fscy5pZCcsICdxdW90YXRpb25zLnJlcXVlc3RfcHJvcG9zYWxfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT50YWtlKDEpCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignc3VwcGxpZXJzJywgZnVuY3Rpb24gKCRxdW90YXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHN1cHBsaWVycyA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICBmb3JlYWNoIChjb2xsZWN0KCRxdW90YXRpb24tPnJlbFNlbGZRdW90YXRpb25TdXBwbGllckJ5UHJvcG9zYWxJZCkgYXMgJGtleSA9PiAkc3VwcGxpZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc3NldCgkc3VwcGxpZXItPnJlbFN1cHBsaWVycy0+aWQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHN1cHBsaWVycyAuPSAnPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi14cyBidG4tJyAuICgkc3VwcGxpZXItPnJlY29tbWVuZGF0aW9uID09ICd5ZXMnID8gJ3N1Y2Nlc3MnIDogJ3ByaW1hcnknKSAuICciPicgLiAkc3VwcGxpZXItPnJlbFN1cHBsaWVycy0+bmFtZSAuICcgKCcgLiAkc3VwcGxpZXItPnJlbFN1cHBsaWVycy0+Y29kZSAuICcpIFsnIC4gdWN3b3Jkcygkc3VwcGxpZXItPmlzX2FwcHJvdmVkKSAuICddPC9idXR0b24+Jm5ic3A7JzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHN1cHBsaWVyczsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdzdXBwbGllcnMnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsU2VsZlF1b3RhdGlvblN1cHBsaWVyQnlQcm9wb3NhbElkJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVJbignaXNfYXBwcm92ZWQnLCAoYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ1B1cmNoYXNlLURlcGFydG1lbnQnKSA/IFsncGVuZGluZycsICdwcmUtcHJvY2Vzc2luZyddIDogWydwZW5kaW5nJywgJ3ByZS1wcm9jZXNzaW5nJ10pKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVIYXMoJ3JlbFNlbGZRdW90YXRpb25TdXBwbGllckJ5UHJvcG9zYWxJZC5yZWxTdXBwbGllcnMnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPm9yV2hlcmUoJ2NvZGUnLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbignc3VwcGxpZXJzJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwbGVhc2VTb3J0TWUoJHF1ZXJ5LCAkb3JkZXIsIFN1cHBsaWVyczo6c2VsZWN0KCdzdXBwbGllcnMubmFtZScpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCdzdXBwbGllcnMuaWQnLCAncXVvdGF0aW9ucy5zdXBwbGllcl9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9KQoKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignYXBwcm92YWxzJywgZnVuY3Rpb24gKCRxdW90YXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGFwcHJvdmFscyA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICBpZihpc3NldCgkcXVvdGF0aW9uLT5yZWxSZXF1ZXN0UHJvcG9zYWwtPmFwcHJvdmFsc1swXSkpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yZWFjaCAoJHF1b3RhdGlvbi0+cmVsUmVxdWVzdFByb3Bvc2FsLT5hcHByb3ZhbHMgYXMgJGtleSA9PiAkYXBwcm92YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYXBwcm92YWxzIC49ICc8YnV0dG9uIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi0nIC4gKCRhcHByb3ZhbC0+cmVzcG9uc2UgPT0gJ3BlbmRpbmcnID8gJ3dhcm5pbmcnIDogKCRhcHByb3ZhbC0+cmVzcG9uc2UgPT0gJ2FwcHJvdmVkJyA/ICdzdWNjZXNzJyA6ICdkYW5nZXInKSkgLiAnIj4nIC4gJGFwcHJvdmFsLT51c2VyLT5uYW1lIC4gJyBbJyAuIHVjd29yZHMoJGFwcHJvdmFsLT5yZXNwb25zZSkgLiAnXTwvYnV0dG9uPiZuYnNwOyc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkYXBwcm92YWxzOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ2FwcHJvdmFscycsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxSZXF1ZXN0UHJvcG9zYWwuYXBwcm92YWxzLnVzZXInLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPm9yV2hlcmVIYXMoJ3JlbFJlcXVlc3RQcm9wb3NhbC5hcHByb3ZhbHMnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ3N0YXR1cycsICdMSUtFJywgJyUnIC4gc3RydG9sb3dlcigka2V5d29yZCkgLiAnJScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2FjdGlvbnMnLCBmdW5jdGlvbiAoJHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnPGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiBvbmNsaWNrPSJvcGVuTW9kYWwoJyAuICR2YWx1ZXMtPmlkIC4gJykiICBjbGFzcz0iYnRuIGJ0bi14cyBidG4taW5mbyI+PGkgY2xhc3M9ImxhcyBsYS1leWUiPjwvaT48L2E+JzsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkdmFsdWVzLT5pc19hcHByb3ZlZCA9PSAicHJlLXByb2Nlc3NpbmciKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxhIG9uY2xpY2s9InNlbmRUb01hbmFnZW1lbnQoJyAuICR2YWx1ZXMtPmlkIC4gJykiIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi1zdWNjZXNzIj48aSBjbGFzcz0ibGFzIGxhLWNoZWNrIj48L2k+Jm5ic3A7U2VuZCB0byBNYW5hZ2VtZW50PC9hPic7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRhY3Rpb25zOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5yYXdDb2x1bW5zKFsnQ1NfbnVtYmVyJywgJ3JlZmVyZW5jZV9ubycsICdyZXF1aXNpdGlvbnMnLCAncHJvZHVjdHMnLCAnc3VwcGxpZXJzJywgJ2FwcHJvdmFscycsICdhY3Rpb25zJ10pCiAgICAgICAgICAgICAgICAgICAgLT5tYWtlKHRydWUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMucXVvdGF0aW9uLmVzdGltYXRlX2luZGV4JywgWwogICAgICAgICAgICAgICAgJ3RpdGxlJyA9PiAkdGl0bGUsCiAgICAgICAgICAgICAgICAnaGVhZGVyQ29sdW1ucycgPT4gJHRoaXMtPmVzdGltYXRlSGVhZGVyQ29sdW1ucygpCiAgICAgICAgICAgIF0pOwogICAgICAgIH0gY2F0Y2ggKFxUaHJvd2FibGUgJHRoKSB7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBzZW5kVG9NYW5hZ2VtZW50KCRxdW90YXRpb25faWQpCiAgICB7CiAgICAgICAgaWYgKGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdQdXJjaGFzZS1EZXBhcnRtZW50JykpIHsKICAgICAgICAgICAgJHF1b3RhdGlvbiA9IFF1b3RhdGlvbnM6OmZpbmRPckZhaWwoJHF1b3RhdGlvbl9pZCk7CiAgICAgICAgICAgICRxdW90YXRpb24tPmlzX2FwcHJvdmVkID0gJ3Byb2Nlc3NpbmcnOwogICAgICAgICAgICAkcXVvdGF0aW9uLT5zYXZlKCk7CgogICAgICAgICAgICAkbWVzc2FnZSA9ICc8c3BhbiBjbGFzcz0ibm90aWZpY2F0aW9uLWxpbmtzIiBkYXRhLXNyYz0iJyAuIHJvdXRlKCdwbXMucXVvdGF0aW9uLnF1b3RhdGlvbnMuY3MucHJvcG9zYWwuZGV0YWlscycsICRxdW90YXRpb24tPnJlcXVlc3RfcHJvcG9zYWxfaWQpIC4gJyIgZGF0YS10dGlsZT0iUmVxdWVzdCBQcm9wb3NhbCBEZXRhaWxzIj5SZWZlcmVuY2UgTm86JyAuICRxdW90YXRpb24tPnJlbFJlcXVlc3RQcm9wb3NhbC0+cmVmZXJlbmNlX25vIC4gJy5XYXR0aW5nIGZvciBNYW5hZ2VtZW50IGFwcHJvdmFsLjwvc3Bhbj4nOwogICAgICAgICAgICBDcmVhdGVPclVwZGF0ZU5vdGlmaWNhdGlvbigkbWVzc2FnZSwgJ3VucmVhZCcsICcnLCBnZXRNYW5hZ2VySW5mbygnTWFuYWdlbWVudCcsIG51bGwsIHRydWUpLCAnc2VuZC10by1tYW5hZ2VyJyk7CgogICAgICAgICAgICByZXR1cm4gJHRoaXMtPnJlZGlyZWN0QmFja1dpdGhTdWNjZXNzKCdTdWNjZXNzZnVsbHkgc2VuZCB0byBNYW5hZ2VtZW50LicsICdwbXMuZXN0aW1hdGUuaW5kZXgnKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigiU29ycnkhIFlvdSBkb24ndCBoYXZlIHRoZSBhY2Nlc3MgdG8gdG8gdGhpcy4iKTsKICAgIH0KCiAgICAvKioKICAgICAqIERpc3BsYXkgYSBsaXN0aW5nIG9mIHRoZSByZXNvdXJjZS4KICAgICAqCiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwoKICAgIHB1YmxpYyBmdW5jdGlvbiBhbmFseXNpc0luZGV4SGVhZGVyQ29sdW1ucygkdmFsdWUgPSAnJykKICAgIHsKICAgICAgICByZXR1cm4gYXJyYXkoCiAgICAgICAgICAgIFsnU0wnLCAnU0wnXSwKICAgICAgICAgICAgWydDU19udW1iZXInLCAnQ1NfbnVtYmVyJywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsncmVxdWlzaXRpb25zJywgJ3JlcXVpc2l0aW9ucycsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3Byb2R1Y3RzJywgJ3Byb2R1Y3RzJywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsnc3VwcGxpZXJzJywgJ3N1cHBsaWVycycsICd0ZXh0LWxlZnQnXSwKICAgICAgICAgICAgWydhcHByb3ZhbHMnLCAnYXBwcm92YWxzJywgJ3RleHQtbGVmdCddLAogICAgICAgICAgICBbJ29wdGlvbnMnLCAnb3B0aW9ucycsICd0ZXh0LWNlbnRlciddLAogICAgICAgICk7CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIGFuYWx5c2lzSW5kZXgoKQogICAgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgICRxdW90YXRpb25zID0gUXVvdGF0aW9uczo6d2l0aChbCiAgICAgICAgICAgICAgICAncmVsUmVxdWVzdFByb3Bvc2FsLnJlcXVlc3RQcm9wb3NhbERldGFpbHMucHJvZHVjdC5hdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGUnLAogICAgICAgICAgICAgICAgJ3JlbFJlcXVlc3RQcm9wb3NhbC5yZXF1ZXN0UHJvcG9zYWxSZXF1aXNpdGlvbi5yZWxSZXF1aXNpdGlvbicsCiAgICAgICAgICAgICAgICAncmVsU2VsZlF1b3RhdGlvblN1cHBsaWVyQnlQcm9wb3NhbElkLnJlbFN1cHBsaWVycycsCiAgICAgICAgICAgICAgICAncmVsUmVxdWVzdFByb3Bvc2FsLmFwcHJvdmFscy51c2VyJwogICAgICAgICAgICBdKQogICAgICAgICAgICAtPndoZW4oIWF1dGgoKS0+dXNlcigpLT5oYXNBbnlSb2xlKFsnUHVyY2hhc2UtRGVwYXJ0bWVudCcsICdBdWRpdCcsICdCaWxsaW5nJywgJ01hbmFnZW1lbnQnLCAnQWNjb3VudHMnXSksIGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUmVxdWVzdFByb3Bvc2FsLnJlcXVlc3RQcm9wb3NhbFJlcXVpc2l0aW9uLnJlbFJlcXVpc2l0aW9uJywgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnYXNzaWduZWRfdXNlcl9pZCcsIGF1dGgoKS0+dXNlcigpLT5pZCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT53aGVyZUhhcygncmVsUmVxdWVzdFByb3Bvc2FsLnJlcXVlc3RQcm9wb3NhbFJlcXVpc2l0aW9uLnJlbFJlcXVpc2l0aW9uJywgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSW4oJ2hyX3VuaXRfaWQnLCBhdXRoKCktPnVzZXIoKS0+cHJpb3JpdGllcy0+cGx1Y2soJ2hyX3VuaXRfaWQnKS0+dG9BcnJheSgpKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT53aGVyZSgnc3RhdHVzJywgJ2FjdGl2ZScpCiAgICAgICAgICAgIC0+d2hlcmVEb2VzbnRIYXZlKCdyZWxTZWxmUXVvdGF0aW9uU3VwcGxpZXJCeVByb3Bvc2FsSWQnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUluKCdpc19hcHByb3ZlZCcsIFsnYXBwcm92ZWQnLCAnaGFsdCddKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT53aGVuKGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdQdXJjaGFzZS1EZXBhcnRtZW50JyksIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSW4oJ2lzX2FwcHJvdmVkJywgWydwZW5kaW5nJywgJ3ByZS1wcm9jZXNzaW5nJywgJ3Byb2Nlc3NpbmcnLF0pOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPndoZW4oYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ1B1cmNoYXNlLUVtcGxveWVlJyksIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSW4oJ2lzX2FwcHJvdmVkJywgWydwZW5kaW5nJywgJ3ByZS1wcm9jZXNzaW5nJywgJ3Byb2Nlc3NpbmcnLF0pOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPmdyb3VwQnkoJ3JlcXVlc3RfcHJvcG9zYWxfaWQnKQogICAgICAgICAgICAtPndoZW4oIWRhdGF0YWJsZU9yZGVyaW5nKCksIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyYnkoJ2lkJywgJ2Rlc2MnKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBpZiAocmVxdWVzdCgpLT5hamF4KCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBEYXRhVGFibGVzOjpvZigkcXVvdGF0aW9ucykKICAgICAgICAgICAgICAgICAgICAtPmFkZEluZGV4Q29sdW1uKCkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignQ1NfbnVtYmVyJywgZnVuY3Rpb24gKCRxdW90YXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIG9uY2xpY2s9Im9wZW5Nb2RhbCgnIC4gJHF1b3RhdGlvbi0+cmVsUmVxdWVzdFByb3Bvc2FsLT5pZCAuICcpIiAgY2xhc3M9ImJ0biBidG4tbGluayI+JyAuICRxdW90YXRpb24tPnJlbFJlcXVlc3RQcm9wb3NhbC0+cmVmZXJlbmNlX25vIC4gJzwvYT4nOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ0NTX251bWJlcicsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxSZXF1ZXN0UHJvcG9zYWwnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdyZWZlcmVuY2Vfbm8nLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdDU19udW1iZXInLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgUmVxdWVzdFByb3Bvc2FsOjpzZWxlY3QoJ3JlcXVlc3RfcHJvcG9zYWxzLnJlZmVyZW5jZV9ubycpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCdyZXF1ZXN0X3Byb3Bvc2Fscy5pZCcsICdxdW90YXRpb25zLnJlcXVlc3RfcHJvcG9zYWxfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT50YWtlKDEpCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbigncmVxdWlzaXRpb25zJywgZnVuY3Rpb24gKCRxdW90YXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9ucyA9ICcnOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRxdW90YXRpb24tPnJlbFJlcXVlc3RQcm9wb3NhbC0+cmVxdWVzdFByb3Bvc2FsUmVxdWlzaXRpb24tPmNvdW50KCkgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JlYWNoICgkcXVvdGF0aW9uLT5yZWxSZXF1ZXN0UHJvcG9zYWwtPnJlcXVlc3RQcm9wb3NhbFJlcXVpc2l0aW9uIGFzICRrZXkgPT4gJHJlcXVpc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9ucyAuPSAoJGtleSA+IDAgPyAnLCAnIDogJycpIC4gJzxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgZGF0YS1zcmM9IicgLiByb3V0ZSgncG1zLnJlcXVpc2l0aW9uLmxpc3Qudmlldy5zaG93JywgJHJlcXVpc2l0aW9uLT5yZWxSZXF1aXNpdGlvbi0+aWQpIC4gJyIgY2xhc3M9InRleHQtcHJpbWFyeSByZXF1aXNpdGlvbiBtLTEgcm91bmRlZCBzaG93UmVxdWlzdGlvbkRldGFpbHMiIG9uY2xpY2s9InJlcXVpc3Rpb25EZXRhaWxzKCQodGhpcykpIj4nIC4gJHJlcXVpc2l0aW9uLT5yZWxSZXF1aXNpdGlvbi0+cmVmZXJlbmNlX25vIC4gJzwvYT4nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHJlcXVpc2l0aW9uczsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdyZXF1aXNpdGlvbnMnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlSGFzKCdyZWxSZXF1ZXN0UHJvcG9zYWwucmVxdWVzdFByb3Bvc2FsUmVxdWlzaXRpb24ucmVsUmVxdWlzaXRpb24nLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgncmVmZXJlbmNlX25vJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbigncmVxdWlzaXRpb25zJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwbGVhc2VTb3J0TWUoJHF1ZXJ5LCAkb3JkZXIsIFJlcXVlc3RQcm9wb3NhbDo6c2VsZWN0KCdyZXF1aXNpdGlvbnMucmVmZXJlbmNlX25vJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbigncmVxdWlzaXRpb25zJywgJ3JlcXVpc2l0aW9ucy5pZCcsICc9JywgJ3JlcXVlc3RfcHJvcG9zYWxfcmVxdWlzaXRpb25zLnJlcXVpc2l0aW9uX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbigncmVxdWVzdF9wcm9wb3NhbF9yZXF1aXNpdGlvbnMnLCAncmVxdWVzdF9wcm9wb3NhbF9yZXF1aXNpdGlvbnMucmVxdWVzdF9wcm9wb3NhbF9pZCcsICc9JywgJ3JlcXVlc3RfcHJvcG9zYWxzLmlkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3JlcXVlc3RfcHJvcG9zYWxzLmlkJywgJ3F1b3RhdGlvbnMucmVxdWVzdF9wcm9wb3NhbF9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdwcm9kdWN0cycsIGZ1bmN0aW9uICgkcXVvdGF0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRwcm9kdWN0cyA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICAkc2wgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICAkYXJyYXkgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRxdW90YXRpb24tPnJlbFJlcXVlc3RQcm9wb3NhbC0+cmVxdWVzdFByb3Bvc2FsRGV0YWlscy0+Y291bnQoKSA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRxdW90YXRpb24tPnJlbFJlcXVlc3RQcm9wb3NhbC0+cmVxdWVzdFByb3Bvc2FsRGV0YWlscyBhcyAka2V5ID0+ICRwcm9kdWN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzc2V0KCRwcm9kdWN0LT5wcm9kdWN0LT5pZCkgJiYgIWluX2FycmF5KCRwcm9kdWN0LT5wcm9kdWN0LT5pZCwgJGFycmF5KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc2wrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHByb2R1Y3RzIC49ICgkc2wgPiAxID8gJywgJyA6ICcnKSAuICRwcm9kdWN0LT5wcm9kdWN0LT5uYW1lIC4gJyAnIC4gZ2V0UHJvZHVjdEF0dHJpYnV0ZXNGYXN0ZXIoJHByb2R1Y3QtPnByb2R1Y3QpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcnJheV9wdXNoKCRhcnJheSwgJHByb2R1Y3QtPnByb2R1Y3QtPmlkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcHJvZHVjdHM7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbigncHJvZHVjdHMnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZShmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZShmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVlc3RQcm9wb3NhbC5yZXF1ZXN0UHJvcG9zYWxEZXRhaWxzLnByb2R1Y3QnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+b3JXaGVyZShmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxSZXF1ZXN0UHJvcG9zYWwucmVxdWVzdFByb3Bvc2FsRGV0YWlscy5wcm9kdWN0LmF0dHJpYnV0ZXMuYXR0cmlidXRlT3B0aW9uJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5vcldoZXJlSGFzKCdyZWxSZXF1ZXN0UHJvcG9zYWwucmVxdWVzdFByb3Bvc2FsRGV0YWlscy5wcm9kdWN0LmF0dHJpYnV0ZXMuYXR0cmlidXRlT3B0aW9uLmF0dHJpYnV0ZScsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbigncHJvZHVjdHMnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgUmVxdWVzdFByb3Bvc2FsOjpzZWxlY3QoJ3Byb2R1Y3RzLm5hbWUnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdwcm9kdWN0cycsICdwcm9kdWN0cy5pZCcsICc9JywgJ3JlcXVlc3RfcHJvcG9zYWxfZGV0YWlscy5wcm9kdWN0X2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbigncmVxdWVzdF9wcm9wb3NhbF9kZXRhaWxzJywgJ3JlcXVlc3RfcHJvcG9zYWxfZGV0YWlscy5yZXF1ZXN0X3Byb3Bvc2FsX2lkJywgJz0nLCAncmVxdWVzdF9wcm9wb3NhbHMuaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdyZXF1ZXN0X3Byb3Bvc2FsX3JlcXVpc2l0aW9ucycsICdyZXF1ZXN0X3Byb3Bvc2FsX3JlcXVpc2l0aW9ucy5yZXF1ZXN0X3Byb3Bvc2FsX2lkJywgJz0nLCAncmVxdWVzdF9wcm9wb3NhbHMuaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbigncmVxdWVzdF9wcm9wb3NhbHMuaWQnLCAncXVvdGF0aW9ucy5yZXF1ZXN0X3Byb3Bvc2FsX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+dGFrZSgxKQogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3N1cHBsaWVycycsIGZ1bmN0aW9uICgkcXVvdGF0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRzdXBwbGllcnMgPSAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yZWFjaCAoY29sbGVjdCgkcXVvdGF0aW9uLT5yZWxTZWxmUXVvdGF0aW9uU3VwcGxpZXJCeVByb3Bvc2FsSWQpIGFzICRrZXkgPT4gJHN1cHBsaWVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNzZXQoJHN1cHBsaWVyLT5yZWxTdXBwbGllcnMtPmlkKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzdXBwbGllcnMgLj0gJzxidXR0b24gY2xhc3M9ImJ0biBidG4teHMgYnRuLScgLiAoJHN1cHBsaWVyLT5yZWNvbW1lbmRhdGlvbiA9PSAneWVzJyA/ICdzdWNjZXNzJyA6ICdwcmltYXJ5JykgLiAnIj4nIC4gJHN1cHBsaWVyLT5yZWxTdXBwbGllcnMtPm5hbWUgLiAnICgnIC4gJHN1cHBsaWVyLT5yZWxTdXBwbGllcnMtPmNvZGUgLiAnKSBbJyAuIHVjd29yZHMoJHN1cHBsaWVyLT5pc19hcHByb3ZlZCkgLiAnXTwvYnV0dG9uPiZuYnNwOyc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRzdXBwbGllcnM7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbignc3VwcGxpZXJzJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFNlbGZRdW90YXRpb25TdXBwbGllckJ5UHJvcG9zYWxJZCcsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSW4oJ2lzX2FwcHJvdmVkJywgKGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdQdXJjaGFzZS1EZXBhcnRtZW50JykgPyBbJ3BlbmRpbmcnLCAncHJlLXByb2Nlc3NpbmcnXSA6IFsncGVuZGluZycsICdwcmUtcHJvY2Vzc2luZyddKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlSGFzKCdyZWxTZWxmUXVvdGF0aW9uU3VwcGxpZXJCeVByb3Bvc2FsSWQucmVsU3VwcGxpZXJzJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5vcldoZXJlKCdjb2RlJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ3N1cHBsaWVycycsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBTdXBwbGllcnM6OnNlbGVjdCgnc3VwcGxpZXJzLm5hbWUnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbignc3VwcGxpZXJzLmlkJywgJ3F1b3RhdGlvbnMuc3VwcGxpZXJfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT50YWtlKDEpCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfSkKCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2FwcHJvdmFscycsIGZ1bmN0aW9uICgkcXVvdGF0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRhcHByb3ZhbHMgPSAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoaXNzZXQoJHF1b3RhdGlvbi0+cmVsUmVxdWVzdFByb3Bvc2FsLT5hcHByb3ZhbHNbMF0pKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRxdW90YXRpb24tPnJlbFJlcXVlc3RQcm9wb3NhbC0+YXBwcm92YWxzIGFzICRrZXkgPT4gJGFwcHJvdmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFwcHJvdmFscyAuPSAnPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi14cyBidG4tJyAuICgkYXBwcm92YWwtPnJlc3BvbnNlID09ICdwZW5kaW5nJyA/ICd3YXJuaW5nJyA6ICgkYXBwcm92YWwtPnJlc3BvbnNlID09ICdhcHByb3ZlZCcgPyAnc3VjY2VzcycgOiAnZGFuZ2VyJykpIC4gJyI+JyAuICRhcHByb3ZhbC0+dXNlci0+bmFtZSAuICcgWycgLiB1Y3dvcmRzKCRhcHByb3ZhbC0+cmVzcG9uc2UpIC4gJ108L2J1dHRvbj4mbmJzcDsnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGFwcHJvdmFsczsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdhcHByb3ZhbHMnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUmVxdWVzdFByb3Bvc2FsLmFwcHJvdmFscy51c2VyJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5vcldoZXJlSGFzKCdyZWxSZXF1ZXN0UHJvcG9zYWwuYXBwcm92YWxzJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdzdGF0dXMnLCAnTElLRScsICclJyAuIHN0cnRvbG93ZXIoJGtleXdvcmQpIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCgogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdvcHRpb25zJywgZnVuY3Rpb24gKCRxdW90YXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgJG9wdGlvbnMgPSAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbGxlY3QoJHF1b3RhdGlvbi0+cmVsU2VsZlF1b3RhdGlvblN1cHBsaWVyQnlQcm9wb3NhbElkKS0+d2hlcmVJbignaXNfYXBwcm92ZWQnLCAoYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ1B1cmNoYXNlLURlcGFydG1lbnQnKSA/IFsncHJvY2Vzc2luZycsICdhcHByb3ZlZCcsICdoYWx0J10gOiBbJ3Byb2Nlc3NpbmcnLCAnYXBwcm92ZWQnLCAnaGFsdCddKSktPmNvdW50KCkgPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJG9wdGlvbnMgLj0gJzxhIGhyZWY9IicgLiByb3V0ZSgncG1zLnF1b3RhdGlvbi5xdW90YXRpb25zLmNzLmNvbXBhcmUubGlzdCcsICRxdW90YXRpb24tPnJlcXVlc3RfcHJvcG9zYWxfaWQpIC4gJyIgIHRpdGxlPSJDb21wYXJlIFByb2Nlc3MgQW5hbHlzaXMiICBjbGFzcz0iYnRuIGJ0bi1zdWNjZXNzIGJ0bi14cyI+PGkgY2xhc3M9ImxhcyBsYS1saXN0Ij48L2k+PC9hPic7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICRvcHRpb25zIC49ICc8YSB0YXJnZXQ9Il9ibGFuayIgaHJlZj0iJyAuIHJvdXRlKCdwbXMucXVvdGF0aW9uLmNzLmhpc3RvcnknLCAkcXVvdGF0aW9uLT5yZXF1ZXN0X3Byb3Bvc2FsX2lkKSAuICciIGNsYXNzPSJidG4gYnRuLXdhcm5pbmcgYnRuLXhzIG1sLTEiIHRpdGxlPSJDUyBIaXN0b3J5Ij48aSBjbGFzcz0ibGFzIGxhLWhpc3RvcnkiPjwvaT48L2E+JzsKCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkb3B0aW9uczsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+cmF3Q29sdW1ucyhbJ0NTX251bWJlcicsICdyZXF1aXNpdGlvbnMnLCAnc3VwcGxpZXJzJywgJ2FwcHJvdmFscycsICdvcHRpb25zJ10pCiAgICAgICAgICAgICAgICAgICAgLT50b0pzb24oKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnF1b3RhdGlvbi5hbmFseXNpcy1pbmRleCcsIFsKICAgICAgICAgICAgICAgICd0aXRsZScgPT4gJ1F1b3RhdGlvbnMgQW5hbHlzaXMnLAogICAgICAgICAgICAgICAgJ2hlYWRlckNvbHVtbnMnID0+ICR0aGlzLT5hbmFseXNpc0luZGV4SGVhZGVyQ29sdW1ucygpCiAgICAgICAgICAgIF0pOwogICAgICAgIH0gY2F0Y2ggKFxUaHJvd2FibGUgJHRoKSB7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBxdW90YXRpb25JdGVtcygkcXVvdGF0aW9uX2lkKQogICAgewogICAgICAgICR0aXRsZSA9ICJRdW90YXRpb24gd2lzZSBpdGVtcyI7CiAgICAgICAgJHF1b3RhdGlvbnMgPSBRdW90YXRpb25zOjp3aXRoKFsKICAgICAgICAgICAgJ3JlbFN1cHBsaWVycy5TdXBwbGllclJhdGluZ3MnLAogICAgICAgICAgICAncmVsU3VwcGxpZXJQYXltZW50VGVybScsCiAgICAgICAgICAgICdyZWxSZXF1ZXN0UHJvcG9zYWwuY3JlYXRlZEJ5JywKICAgICAgICAgICAgJ2V4Y2hhbmdlUmF0ZS5jdXJyZW5jeScsCiAgICAgICAgICAgICdyZWxRdW90YXRpb25JdGVtcy5yZWxQcm9kdWN0LnByb2R1Y3RVbml0JywKICAgICAgICAgICAgJ3JlbFF1b3RhdGlvbkl0ZW1zLnJlbFByb2R1Y3QuY2F0ZWdvcnkuY2F0ZWdvcnknLAogICAgICAgICAgICAncmVsUXVvdGF0aW9uSXRlbXMucmVsUHJvZHVjdC5hdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGUnLAogICAgICAgIF0pLT53aGVyZSgnaWQnLCAkcXVvdGF0aW9uX2lkKS0+d2hlcmUoJ3N0YXR1cycsICdhY3RpdmUnKS0+Zmlyc3QoKTsKCiAgICAgICAgJHJlcXVpc2l0aW9uSXRlbXMgPSBSZXF1aXNpdGlvbkl0ZW06OndpdGgoWwogICAgICAgICAgICAnYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24uYXR0cmlidXRlJwogICAgICAgIF0pCiAgICAgICAgLT53aGVyZUhhcygncmVxdWlzaXRpb24ucmVxdWVzdFByb3Bvc2FsUmVxdWlzaXRpb24nLCBmdW5jdGlvbigkcXVlcnkpIHVzZSgkcXVvdGF0aW9ucyl7CiAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdyZXF1ZXN0X3Byb3Bvc2FsX2lkJywgJHF1b3RhdGlvbnMtPnJlcXVlc3RfcHJvcG9zYWxfaWQpOwogICAgICAgIH0pCiAgICAgICAgLT5nZXQoKTsKCiAgICAgICAgJHN5c3RlbUN1cnJlbmN5ID0gc3lzdGVtQ3VycmVuY3koKTsKICAgICAgICAkZXhjaGFuZ2VSYXRlID0gZXhjaGFuZ2VSYXRlKCRxdW90YXRpb25zLT5leGNoYW5nZVJhdGUsICRzeXN0ZW1DdXJyZW5jeS0+aWQpOwogICAgICAgICRzYW1lID0gKCRxdW90YXRpb25zLT5leGNoYW5nZVJhdGUtPmN1cnJlbmN5X2lkID09ICRzeXN0ZW1DdXJyZW5jeS0+aWQgPyB0cnVlIDogZmFsc2UpOwogICAgICAgICRhcHByb3ZlZCA9IHJlcXVlc3QoKS0+aGFzKCdhcHByb3ZlZCcpOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5xdW90YXRpb24uaXRlbS1zaG93JywgY29tcGFjdCgncXVvdGF0aW9ucycsICd0aXRsZScsICdzeXN0ZW1DdXJyZW5jeScsICdleGNoYW5nZVJhdGUnLCAnc2FtZScsICdhcHByb3ZlZCcsICdyZXF1aXNpdGlvbkl0ZW1zJykpOwogICAgICAgIH0gY2F0Y2ggKFxUaHJvd2FibGUgJHRoKSB7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKCiAgICAvKioKICAgICAqIERpc3BsYXkgdGhlIHNwZWNpZmllZCByZXNvdXJjZS4KICAgICAqCiAgICAgKiBAcGFyYW0gaW50ICRpZAogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXEpzb25SZXNwb25zZQogICAgICovCgogICAgcHVibGljIGZ1bmN0aW9uIHF1b3RhdGlvbkdlbmVyYXRlKCRwcm9wb3NhbF9pZCkKICAgIHsKICAgICAgICBpZiAocmVxdWVzdCgpLT5oYXMoJ2dldC1zdXBwbGllci1pbmZvJykpIHsKICAgICAgICAgICAgJHN1cHBsaWVyID0gU3VwcGxpZXJzOjp3aXRoKFsKICAgICAgICAgICAgICAgICdjdXJyZW5jaWVzJwogICAgICAgICAgICBdKS0+ZmluZChyZXF1ZXN0KCktPmdldCgnc3VwcGxpZXJfaWQnKSk7CiAgICAgICAgICAgICRjdXJyZW5jaWVzID0gQ3VycmVuY3lUeXBlOjp3aXRoKFsKICAgICAgICAgICAgICAgICdjdXJyZW5jaWVzJyA9PiBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRzdXBwbGllcikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSW4oJ2lkJywgaXNzZXQoJHN1cHBsaWVyLT5pZCkgPyAkc3VwcGxpZXItPmN1cnJlbmNpZXMtPnBsdWNrKCdpZCcpLT50b0FycmF5KCkgOiBbXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIF0pLT5nZXQoKTsKCiAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAgICAgICAgICdjdXJyZW5jaWVzJyA9PiAkY3VycmVuY2llcywKICAgICAgICAgICAgXSk7CiAgICAgICAgfQoKICAgICAgICAkdGl0bGUgPSAnQ1MgR2VuZXJhdGUnOwoKICAgICAgICAkcmVxdWVzdFByb3Bvc2FsID0gUmVxdWVzdFByb3Bvc2FsOjp3aGVyZSgnaWQnLCAkcHJvcG9zYWxfaWQpCiAgICAgICAgLT53aXRoKFsKICAgICAgICAgICAgJ3JlcXVlc3RQcm9wb3NhbFJlcXVpc2l0aW9uLnJlbFJlcXVpc2l0aW9uLlVuaXQnLAogICAgICAgICAgICAnZGVmaW5lVG9TdXBwbGllci5zdXBwbGllci5zdXBwbGVpZXJDdXJyZW5jaWVzJywKICAgICAgICAgICAgJ2NyZWF0ZWRCeScsCiAgICAgICAgICAgICdyZXF1ZXN0UHJvcG9zYWxEZXRhaWxzLnByb2R1Y3QuY2F0ZWdvcnkuY2F0ZWdvcnknLAogICAgICAgICAgICAncmVxdWVzdFByb3Bvc2FsRGV0YWlscy5wcm9kdWN0LnByb2R1Y3RVbml0JywKICAgICAgICAgICAgJ3JlcXVlc3RQcm9wb3NhbERldGFpbHMucHJvZHVjdC5hdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGUnLAogICAgICAgIF0pCiAgICAgICAgLT5maXJzdCgpOwoKICAgICAgICAkcmVxdWlzaXRpb25JdGVtcyA9IFJlcXVpc2l0aW9uSXRlbTo6d2l0aChbCiAgICAgICAgICAgICdhdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGUnCiAgICAgICAgXSkKICAgICAgICAtPndoZXJlSGFzKCdyZXF1aXNpdGlvbi5yZXF1ZXN0UHJvcG9zYWxSZXF1aXNpdGlvbicsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRyZXF1ZXN0UHJvcG9zYWwpewogICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgncmVxdWVzdF9wcm9wb3NhbF9pZCcsICRyZXF1ZXN0UHJvcG9zYWwtPmlkKTsKICAgICAgICB9KQogICAgICAgIC0+Z2V0KCk7CgogICAgICAgICRjbHVlID0gJ0dSUCc7CiAgICAgICAgJHVuaXRzID0gXEFwcFxNb2RlbHNcSHJcVW5pdDo6d2hlcmVJbignaHJfdW5pdF9pZCcsICRyZXF1ZXN0UHJvcG9zYWwtPnJlcXVlc3RQcm9wb3NhbFJlcXVpc2l0aW9uLT5wbHVjaygncmVsUmVxdWlzaXRpb24uaHJfdW5pdF9pZCcpKS0+Z2V0KCk7CiAgICAgICAgaWYgKCR1bml0cy0+Y291bnQoKSA9PSAxKSB7CiAgICAgICAgICAgICRjbHVlID0gJHVuaXRzWzBdLT5ocl91bml0X3Nob3J0X25hbWU7CiAgICAgICAgfQoKICAgICAgICAkcHJlZml4ID0gJ1FHLScgLiBkYXRlKCd5Jywgc3RydG90aW1lKGRhdGUoJ1ktbS1kJykpKSAuICctJyAuICRjbHVlIC4gJy0nOwogICAgICAgICRyZWZObyA9IHVuaXF1ZUNvZGUoMTUsICRwcmVmaXgsICdxdW90YXRpb25zJywgJ2lkJyk7CiAgICAgICAgdHJ5IHsKCiAgICAgICAgICAgICRzdXBwbGllclBheW1lbnRUZXJtcyA9IHN1cHBsaWVyUGF5bWVudFRlcm0oKTsKICAgICAgICAgICAgJHF1b3RhdGlvblN1cHBsaWVyID0gUXVvdGF0aW9uczo6d2hlcmUoJ3JlcXVlc3RfcHJvcG9zYWxfaWQnLCAkcHJvcG9zYWxfaWQpLT5zZWxlY3QoJ3N1cHBsaWVyX2lkJyktPmdldCgpOwoKICAgICAgICAgICAgJHF1b3RhdGlvblN1cHBsaWVyQXJyYXkgPSBhcnJheSgpOwogICAgICAgICAgICBmb3JlYWNoICgkcXVvdGF0aW9uU3VwcGxpZXIgYXMgJHZhbHVlcykgewogICAgICAgICAgICAgICAgYXJyYXlfcHVzaCgkcXVvdGF0aW9uU3VwcGxpZXJBcnJheSwgJHZhbHVlcy0+c3VwcGxpZXJfaWQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoJHJlcXVlc3RQcm9wb3NhbC0+ZGVmaW5lVG9TdXBwbGllci0+d2hlcmVOb3RJbignc3VwcGxpZXJfaWQnLCAkcXVvdGF0aW9uU3VwcGxpZXJBcnJheSktPmNvdW50KCkgPD0gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlZGlyZWN0KCdwbXMvcmZwL3JlcXVlc3QtcHJvcG9zYWwnKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgJGN1cnJlbmN5VHlwZXMgPSBDdXJyZW5jeVR5cGU6OndoZXJlSGFzKCdjdXJyZW5jaWVzLnN1cHBsaWVycycsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJHJlcXVlc3RQcm9wb3NhbCwgJHF1b3RhdGlvblN1cHBsaWVyQXJyYXkpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSW4oJ3N1cHBsaWVyX2lkJywgJHJlcXVlc3RQcm9wb3NhbC0+ZGVmaW5lVG9TdXBwbGllci0+d2hlcmVOb3RJbignc3VwcGxpZXJfaWQnLCAkcXVvdGF0aW9uU3VwcGxpZXJBcnJheSktPnBsdWNrKCdzdXBwbGllcl9pZCcpLT50b0FycmF5KCkpOwogICAgICAgICAgICB9KS0+Z2V0KCk7CgogICAgICAgICAgICAkcGF5bWVudFRlcm1zID0gUGF5bWVudFRlcm06OmFsbCgpOwoKICAgICAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnF1b3RhdGlvbi5jcmVhdGUnLCBjb21wYWN0KCd0aXRsZScsICdyZXF1ZXN0UHJvcG9zYWwnLCAncHJvcG9zYWxfaWQnLCAncmVmTm8nLCAnc3VwcGxpZXJQYXltZW50VGVybXMnLCAncXVvdGF0aW9uU3VwcGxpZXJBcnJheScsICdjdXJyZW5jeVR5cGVzJywgJ3BheW1lbnRUZXJtcycsICdyZXF1aXNpdGlvbkl0ZW1zJykpOwoKICAgICAgICB9IGNhdGNoIChcVGhyb3dhYmxlICR0aCkgewogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFN0b3JlIGEgbmV3bHkgY3JlYXRlZCByZXNvdXJjZSBpbiBzdG9yYWdlLgogICAgICoKICAgICAqIEBwYXJhbSBcSWxsdW1pbmF0ZVxIdHRwXFJlcXVlc3QgJHJlcXVlc3QKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZWRpcmVjdFJlc3BvbnNlCiAgICAgKi8KCiAgICBwdWJsaWMgZnVuY3Rpb24gc3RvcmUoUmVxdWVzdCAkcmVxdWVzdCkKICAgIHsKICAgICAgICAkcmVxdWVzdC0+dmFsaWRhdGUoWwogICAgICAgICAgICAnY3VycmVuY3lfaWQnID0+IFsncmVxdWlyZWQnXSwKICAgICAgICAgICAgJ2RlbGl2ZXJ5X2RhdGUnID0+IFsncmVxdWlyZWQnXSwKICAgICAgICAgICAgJ3F1b3RhdGlvbl9kYXRlJyA9PiBbJ3JlcXVpcmVkJywgJ2RhdGUnXSwKICAgICAgICAgICAgJ3JlZmVyZW5jZV9ubycgPT4gJ3JlcXVpcmVkfG1heDoxNXx1bmlxdWU6cXVvdGF0aW9ucycsCiAgICAgICAgICAgICJzdXBwbGllcl9pZCIgPT4gInJlcXVpcmVkfGV4aXN0czpzdXBwbGllcnMsaWQiLAogICAgICAgICAgICAicmVxdWVzdF9wcm9wb3NhbF9pZCIgPT4gInJlcXVpcmVkIiwKICAgICAgICAgICAgInJlcXVlc3RfcHJvcG9zYWxfaWQuKiIgPT4gImV4aXN0czpyZXF1ZXN0X3Byb3Bvc2FscyxpZCIsCiAgICAgICAgICAgICdzdW1fb2Zfc3VidG90YWwnID0+ICdyZXF1aXJlZCcsCiAgICAgICAgICAgICdkaXNjb3VudCcgPT4gJ251bGxhYmxlJywKICAgICAgICAgICAgJ3ZhdCcgPT4gJ251bGxhYmxlJywKICAgICAgICAgICAgJ2dyb3NzX3ByaWNlJyA9PiAncmVxdWlyZWQnLAogICAgICAgICAgICAndHlwZScgPT4gJ3JlcXVpcmVkfGluOm9ubGluZSxtYW51YWwnLAogICAgICAgICAgICAndmFsaWRhdGlvbl9kYXlzJyA9PiAncmVxdWlyZWQnLAoKICAgICAgICAgICAgJ3BheW1lbnRfdGVybV9pZCcgPT4gJ3JlcXVpcmVkJywKICAgICAgICAgICAgJ3BheW1lbnRfcGVyY2VudGFnZXMnID0+ICdyZXF1aXJlZCcsCiAgICAgICAgICAgICdwYXltZW50X3BlcmNlbnRhZ2VzLionID0+ICdyZXF1aXJlZCcsCiAgICAgICAgICAgIC8vICdwYXltZW50X2R1cmF0aW9ucycgPT4gJ3JlcXVpcmVkJywKICAgICAgICAgICAgLy8gJ3BheW1lbnRfZHVyYXRpb25zLionID0+ICdyZXF1aXJlZCcsCiAgICAgICAgICAgICdwYXltZW50X3R5cGVzJyA9PiAncmVxdWlyZWQnLAogICAgICAgICAgICAncGF5bWVudF90eXBlcy4qJyA9PiAncmVxdWlyZWQnLAogICAgICAgICAgICAncGF5bWVudF9tb2RlcycgPT4gJ3JlcXVpcmVkJywKICAgICAgICAgICAgJ3BheW1lbnRfbW9kZXMuKicgPT4gJ3JlcXVpcmVkJywKICAgICAgICBdKTsKCiAgICAgICAgJHR5cGUgPSAkcmVxdWVzdC0+dHlwZTsKICAgICAgICAkbW9kYWwgPSBRdW90YXRpb25zOjp3aGVyZShbCiAgICAgICAgICAgICdzdXBwbGllcl9pZCcgPT4gJHJlcXVlc3QtPnN1cHBsaWVyX2lkLAogICAgICAgICAgICAncmVxdWVzdF9wcm9wb3NhbF9pZCcgPT4gJHJlcXVlc3QtPnJlcXVlc3RfcHJvcG9zYWxfaWQsCiAgICAgICAgICAgICd0eXBlJyA9PiAkdHlwZQogICAgICAgIF0pLT5maXJzdCgpOwoKICAgICAgICBpZiAoIWVtcHR5KCRtb2RhbCkpIHsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCdBbHJlYWR5IGdlbmVyYXRlIGEgcXVvdGF0aW9uIHVzaW5nIHRoaXMgc3VwcGxpZXIhIScpOwogICAgICAgIH0KCiAgICAgICAgREI6OmJlZ2luVHJhbnNhY3Rpb24oKTsKICAgICAgICB0cnkgewoKICAgICAgICAgICAgJHF1b3RhdGlvbkZpbGVQYXRoID0gbnVsbDsKICAgICAgICAgICAgaWYgKCRyZXF1ZXN0LT5oYXNGaWxlKCdxdW90YXRpb25fZmlsZScpKSB7CiAgICAgICAgICAgICAgICAkcXVvdGF0aW9uRmlsZVBhdGggPSAkdGhpcy0+ZmlsZVVwbG9hZCgkcmVxdWVzdC0+ZmlsZSgncXVvdGF0aW9uX2ZpbGUnKSwgJ3VwbG9hZC9xdW90YXRpb24vcGRmLWZpbGUnKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgJHRlY2huaWNhbEZpbGVQYXRoID0gbnVsbDsKICAgICAgICAgICAgaWYgKCRyZXF1ZXN0LT5oYXNGaWxlKCd0ZWNobmljYWxfc3BlY2lmaWNhdGlvbl9maWxlJykpIHsKICAgICAgICAgICAgICAgICR0ZWNobmljYWxGaWxlUGF0aCA9ICR0aGlzLT5maWxlVXBsb2FkKCRyZXF1ZXN0LT5maWxlKCd0ZWNobmljYWxfc3BlY2lmaWNhdGlvbl9maWxlJyksICd1cGxvYWQvcXVvdGF0aW9uL3RlY2huaWNhbC1maWxlJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICRzbCA9IDA7CiAgICAgICAgICAgICRzdXBwbGllcl9wYXltZW50X3Rlcm1zX2lkID0gMDsKICAgICAgICAgICAgaWYoaXNzZXQoJHJlcXVlc3QtPnBheW1lbnRfcGVyY2VudGFnZXNbMF0pKXsKICAgICAgICAgICAgICAgIGZvcmVhY2goJHJlcXVlc3QtPnBheW1lbnRfcGVyY2VudGFnZXMgYXMgJGtleSA9PiAkdmFsdWUpewogICAgICAgICAgICAgICAgICAgICRzdXBwbGllclBheW1lbnRUZXJtID0gU3VwcGxpZXJQYXltZW50VGVybTo6Y3JlYXRlKFsKICAgICAgICAgICAgICAgICAgICAgICAgJ3N1cHBsaWVyX2lkJyA9PiAkcmVxdWVzdC0+c3VwcGxpZXJfaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICdwYXltZW50X3Rlcm1faWQnID0+ICRyZXF1ZXN0LT5wYXltZW50X3Rlcm1faWQsCiAgICAgICAgICAgICAgICAgICAgICAgICdwYXltZW50X3BlcmNlbnQnID0+ICRyZXF1ZXN0LT5wYXltZW50X3BlcmNlbnRhZ2VzWyRrZXldLAogICAgICAgICAgICAgICAgICAgICAgICAnZGF5X2R1cmF0aW9uJyA9PiAxLAogICAgICAgICAgICAgICAgICAgICAgICAvLyAnZGF5X2R1cmF0aW9uJyA9PiAkcmVxdWVzdC0+cGF5bWVudF9kdXJhdGlvbnNbJGtleV0sCiAgICAgICAgICAgICAgICAgICAgICAgICd0eXBlJyA9PiAkcmVxdWVzdC0+cGF5bWVudF90eXBlc1ska2V5XSwKICAgICAgICAgICAgICAgICAgICAgICAgJ3BheW1lbnRfbW9kZScgPT4gJHJlcXVlc3QtPnBheW1lbnRfbW9kZXNbJGtleV0sCiAgICAgICAgICAgICAgICAgICAgICAgICdwYXJlbnRfaWQnID0+IGlzc2V0KCRwYXJlbnQtPmlkKSA/ICRwYXJlbnQtPmlkIDogMCwKICAgICAgICAgICAgICAgICAgICAgICAgJ3NvdXJjZScgPT4gJ2NzJywKICAgICAgICAgICAgICAgICAgICBdKTsKCiAgICAgICAgICAgICAgICAgICAgJHNsKys7CgogICAgICAgICAgICAgICAgICAgIGlmKCRzbCA9PSAxKXsKICAgICAgICAgICAgICAgICAgICAgICAgJHBhcmVudCA9ICRzdXBwbGllclBheW1lbnRUZXJtOwogICAgICAgICAgICAgICAgICAgICAgICAkc3VwcGxpZXJfcGF5bWVudF90ZXJtc19pZCA9ICRzdXBwbGllclBheW1lbnRUZXJtLT5pZDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICAkcXVvdGF0aW9uID0gUXVvdGF0aW9uczo6Y3JlYXRlKFsKICAgICAgICAgICAgICAgICdzdXBwbGllcl9pZCcgPT4gJHJlcXVlc3QtPnN1cHBsaWVyX2lkLAogICAgICAgICAgICAgICAgJ3JlcXVlc3RfcHJvcG9zYWxfaWQnID0+ICRyZXF1ZXN0LT5yZXF1ZXN0X3Byb3Bvc2FsX2lkLAogICAgICAgICAgICAgICAgJ3JlZmVyZW5jZV9ubycgPT4gJHJlcXVlc3QtPnJlZmVyZW5jZV9ubywKICAgICAgICAgICAgICAgICdxdW90YXRpb25fZGF0ZScgPT4gZGF0ZSgnWS1tLWQnLCBzdHJ0b3RpbWUoJHJlcXVlc3QtPnF1b3RhdGlvbl9kYXRlKSksCiAgICAgICAgICAgICAgICAnZXhjaGFuZ2VfcmF0ZV9pZCcgPT4gZ2V0RXhjaGFuZ2VSYXRlcygkcmVxdWVzdC0+Y3VycmVuY3lfaWQpWydyYXRlJ10tPmlkLAogICAgICAgICAgICAgICAgJ3RvdGFsX3ByaWNlJyA9PiAkcmVxdWVzdC0+c3VtX29mX3N1YnRvdGFsLAogICAgICAgICAgICAgICAgJ2Rpc2NvdW50JyA9PiAkcmVxdWVzdC0+ZGlzY291bnQsCiAgICAgICAgICAgICAgICAndmF0JyA9PiBjb2xsZWN0KCRyZXF1ZXN0LT5zdWJfdG90YWxfdmF0X3ByaWNlKS0+c3VtKCksCiAgICAgICAgICAgICAgICAnZ3Jvc3NfcHJpY2UnID0+ICRyZXF1ZXN0LT5ncm9zc19wcmljZSwKICAgICAgICAgICAgICAgICd2YWxpZGF0aW9uX2RheXMnID0+ICRyZXF1ZXN0LT52YWxpZGF0aW9uX2RheXMsCiAgICAgICAgICAgICAgICAnc3RhdHVzJyA9PiAnYWN0aXZlJywKICAgICAgICAgICAgICAgICd0eXBlJyA9PiAkdHlwZSwKICAgICAgICAgICAgICAgICdxdW90YXRpb25fZmlsZScgPT4gJHF1b3RhdGlvbkZpbGVQYXRoLAogICAgICAgICAgICAgICAgJ3RlY2huaWNhbF9zcGVjaWZpY2F0aW9uX2ZpbGUnID0+ICR0ZWNobmljYWxGaWxlUGF0aCwKICAgICAgICAgICAgICAgICdkZWxpdmVyeV9kYXRlJyA9PiBpc3NldCgkcmVxdWVzdC0+ZGVsaXZlcnlfZGF0ZSkgPyAkcmVxdWVzdC0+ZGVsaXZlcnlfZGF0ZSA6IGRhdGUoJ1ktbS1kJyksCiAgICAgICAgICAgICAgICAnc3VwcGxpZXJfcGF5bWVudF90ZXJtc19pZCcgPT4gJHN1cHBsaWVyX3BheW1lbnRfdGVybXNfaWQsCiAgICAgICAgICAgIF0pOwoKICAgICAgICAgICAgJHJlcXVpc2l0aW9uSXRlbXMgPSBSZXF1aXNpdGlvbkl0ZW06OndpdGgoWwogICAgICAgICAgICAgICAgJ2F0dHJpYnV0ZXMuYXR0cmlidXRlT3B0aW9uLmF0dHJpYnV0ZScKICAgICAgICAgICAgXSkKICAgICAgICAgICAgLT53aGVyZUhhcygncmVxdWlzaXRpb24ucmVxdWVzdFByb3Bvc2FsUmVxdWlzaXRpb24nLCBmdW5jdGlvbigkcXVlcnkpIHVzZSgkcmVxdWVzdCl7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgncmVxdWVzdF9wcm9wb3NhbF9pZCcsICRyZXF1ZXN0LT5yZXF1ZXN0X3Byb3Bvc2FsX2lkKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT5nZXQoKTsKCiAgICAgICAgICAgIGZvcmVhY2ggKCRyZXF1ZXN0LT5wcm9kdWN0X2lkIGFzICRpID0+ICR1aWQpIHsKCiAgICAgICAgICAgICAgICAkaXRlbVRlY2huaWNhbEZpbGVQYXRoID0gbnVsbDsKICAgICAgICAgICAgICAgIGlmICgkcmVxdWVzdC0+aGFzRmlsZSgnaXRlbV90ZWNobmljYWxfc3BlY2lmaWNhdGlvbl9maWxlLicgLiAkdWlkKSkgewogICAgICAgICAgICAgICAgICAgICRpdGVtVGVjaG5pY2FsRmlsZVBhdGggPSAkdGhpcy0+ZmlsZVVwbG9hZCgkcmVxdWVzdC0+ZmlsZSgnaXRlbV90ZWNobmljYWxfc3BlY2lmaWNhdGlvbl9maWxlLicgLiAkdWlkKSwgJ3VwbG9hZC9xdW90YXRpb24vaXRlbS10ZWNobmljYWwtZmlsZScpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICRxdW90YXRpb25JdGVtc0lucHV0W10gPSBbCiAgICAgICAgICAgICAgICAgICAgJ3VpZCcgPT4gJHVpZCwKICAgICAgICAgICAgICAgICAgICAncXVvdGF0aW9uX2lkJyA9PiAkcXVvdGF0aW9uLT5pZCwKICAgICAgICAgICAgICAgICAgICAncHJvZHVjdF9pZCcgPT4gJHJlcXVpc2l0aW9uSXRlbXMtPndoZXJlKCd1aWQnLCAkdWlkKS0+Zmlyc3QoKS0+cHJvZHVjdF9pZCwKICAgICAgICAgICAgICAgICAgICAnZGVzY3JpcHRpb24nID0+ICRyZXF1ZXN0LT5wcm9kdWN0X2Rlc2NyaXB0aW9uWyR1aWRdLAogICAgICAgICAgICAgICAgICAgICd1bml0X3ByaWNlJyA9PiAkcmVxdWVzdC0+dW5pdF9wcmljZVskdWlkXSwKICAgICAgICAgICAgICAgICAgICAncXR5JyA9PiAkcmVxdWVzdC0+cXR5WyR1aWRdLAogICAgICAgICAgICAgICAgICAgICdzdWJfdG90YWxfcHJpY2UnID0+ICRyZXF1ZXN0LT5zdWJfdG90YWxfcHJpY2VbJHVpZF0sCiAgICAgICAgICAgICAgICAgICAgJ2Rpc2NvdW50JyA9PiAkcmVxdWVzdC0+aXRlbV9kaXNjb3VudF9wZXJjZW50WyR1aWRdID09IG51bGwgPyAwIDogJHJlcXVlc3QtPml0ZW1fZGlzY291bnRfcGVyY2VudFskdWlkXSwKICAgICAgICAgICAgICAgICAgICAnZGlzY291bnRfYW1vdW50JyA9PiAkcmVxdWVzdC0+aXRlbV9kaXNjb3VudF9hbW91bnRbJHVpZF0sCiAgICAgICAgICAgICAgICAgICAgJ3ZhdF90eXBlJyA9PiAkcmVxdWVzdC0+cHJvZHVjdF92YXRfdHlwZVskdWlkXSwKICAgICAgICAgICAgICAgICAgICAndmF0X3BlcmNlbnRhZ2UnID0+ICRyZXF1ZXN0LT5wcm9kdWN0X3ZhdFskdWlkXSwKICAgICAgICAgICAgICAgICAgICAndmF0JyA9PiAkcmVxdWVzdC0+c3ViX3RvdGFsX3ZhdF9wcmljZVskdWlkXSwKICAgICAgICAgICAgICAgICAgICAndG90YWxfcHJpY2UnID0+ICgkcmVxdWVzdC0+c3ViX3RvdGFsX3ByaWNlWyR1aWRdIC0gJHJlcXVlc3QtPml0ZW1fZGlzY291bnRfYW1vdW50WyR1aWRdKSArICgkcmVxdWVzdC0+cHJvZHVjdF92YXRfdHlwZVskdWlkXSA9PSAnZXhjbHVzaXZlJyA/ICRyZXF1ZXN0LT5zdWJfdG90YWxfdmF0X3ByaWNlWyR1aWRdIDogMCksCiAgICAgICAgICAgICAgICAgICAgJ2NyZWF0ZWRfYXQnID0+IGRhdGUoJ1ktbS1kIEg6aTpzJyksCiAgICAgICAgICAgICAgICAgICAgJ3RlY2huaWNhbF9zcGVjaWZpY2F0aW9uX2ZpbGUnID0+ICRpdGVtVGVjaG5pY2FsRmlsZVBhdGgsCiAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICB9CgogICAgICAgICAgICBRdW90YXRpb25zSXRlbXM6Omluc2VydCgkcXVvdGF0aW9uSXRlbXNJbnB1dCk7CgogICAgICAgICAgICAvLyBpZiAoIWlzX251bGwoJHJlcXVlc3QtPnBheW1lbnRfdGVybV9pZCkpIHsKICAgICAgICAgICAgLy8gICAgICR0aGlzLT5zdG9yZVN1cHBsaWVyUGF5bWVudFRlcm0oJHF1b3RhdGlvbi0+aWQsICRyZXF1ZXN0KTsKICAgICAgICAgICAgLy8gfQoKICAgICAgICAgICAgREI6OmNvbW1pdCgpOwogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoU3VjY2VzcygnQ1MgR2VuZXJhdGVkIFN1Y2Nlc3NmdWxseScpOwogICAgICAgIH0gY2F0Y2ggKFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgREI6OnJvbGxiYWNrKCk7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBzdG9yZVN1cHBsaWVyUGF5bWVudFRlcm0oJHF1b3RhdGlvbklkLCAkcmVxdWVzdCkKICAgIHsKICAgICAgICBTdXBwbGllclBheW1lbnRUZXJtOjpjcmVhdGUoCiAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICdxdW90YXRpb25faWQnID0+ICRxdW90YXRpb25JZCwKICAgICAgICAgICAgICAgICdzdXBwbGllcl9pZCcgPT4gJHJlcXVlc3QtPnN1cHBsaWVyX2lkLAogICAgICAgICAgICAgICAgJ3BheW1lbnRfdGVybV9pZCcgPT4gJHJlcXVlc3QtPnBheW1lbnRfdGVybV9pZCwKICAgICAgICAgICAgICAgICdwYXltZW50X3BlcmNlbnQnID0+ICRyZXF1ZXN0LT5wYXltZW50X3BlcmNlbnQgPz8gMCwKICAgICAgICAgICAgICAgICdyZW1hcmtzJyA9PiAkcmVxdWVzdC0+cmVtYXJrcywKICAgICAgICAgICAgXQogICAgICAgICk7CiAgICB9CgogICAgLyoqCiAgICAgKiBFZGl0IGFuIGV4aXN0aW5nIHJlc291cmNlIGluIHN0b3JhZ2UuCiAgICAgKgogICAgICogQHBhcmFtICRpZAogICAgICovCgogICAgcHVibGljIGZ1bmN0aW9uIGVkaXQoJGlkKQogICAgewogICAgICAgICR0aXRsZSA9ICdRdW90YXRpb24gRWRpdCc7CiAgICAgICAgdHJ5IHsKCiAgICAgICAgICAgICRxdW90YXRpb24gPSBRdW90YXRpb25zOjp3aXRoKFsKICAgICAgICAgICAgICAgICdyZWxSZXF1ZXN0UHJvcG9zYWwnLAogICAgICAgICAgICAgICAgJ3JlbFN1cHBsaWVycy5jdXJyZW5jaWVzJywKICAgICAgICAgICAgICAgICdleGNoYW5nZVJhdGUuY3VycmVuY3knLAogICAgICAgICAgICAgICAgJ2hpc3RvcmllcycsCiAgICAgICAgICAgICAgICAncmVsUXVvdGF0aW9uSXRlbXMucmVsUHJvZHVjdCcsCgogICAgICAgICAgICAgICAgJ3JlbFN1cHBsaWVyUGF5bWVudFRlcm0nCiAgICAgICAgICAgIF0pCiAgICAgICAgICAgIC0+d2hlcmVOb3RJbigndHlwZScsIFsnZGlyZWN0LXB1cmNoYXNlJ10pCiAgICAgICAgICAgIC0+d2hlcmVJbignaXNfYXBwcm92ZWQnLCBbJ3ByZS1wcm9jZXNzaW5nJywgJ3BlbmRpbmcnXSkKICAgICAgICAgICAgLT53aGVyZSgnaWQnLCAkaWQpCiAgICAgICAgICAgIC0+Zmlyc3QoKTsKCiAgICAgICAgICAgICRyZXF1aXNpdGlvbkl0ZW1zID0gUmVxdWlzaXRpb25JdGVtOjp3aXRoKFsKICAgICAgICAgICAgICAgICdhdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGUnCiAgICAgICAgICAgIF0pCiAgICAgICAgICAgIC0+d2hlcmVIYXMoJ3JlcXVpc2l0aW9uLnJlcXVlc3RQcm9wb3NhbFJlcXVpc2l0aW9uJywgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJHF1b3RhdGlvbil7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgncmVxdWVzdF9wcm9wb3NhbF9pZCcsICRxdW90YXRpb24tPnJlcXVlc3RfcHJvcG9zYWxfaWQpOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPmdldCgpOwoKICAgICAgICAgICAgJGFkZGl0aW9uYWxUZXJtcyA9IFN1cHBsaWVyUGF5bWVudFRlcm06OndoZXJlKCdpZCcsICRxdW90YXRpb24tPnJlbFN1cHBsaWVyUGF5bWVudFRlcm0tPmlkKS0+b3JXaGVyZSgncGFyZW50X2lkJywgJHF1b3RhdGlvbi0+cmVsU3VwcGxpZXJQYXltZW50VGVybS0+aWQpLT5nZXQoKTsKCiAgICAgICAgICAgICRjdXJyZW5jaWVzID0gQ3VycmVuY3lUeXBlOjp3aXRoKFsKICAgICAgICAgICAgICAgICdjdXJyZW5jaWVzJyA9PiBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRxdW90YXRpb24pIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUluKCdpZCcsIGlzc2V0KCRxdW90YXRpb24tPnJlbFN1cHBsaWVycy0+Y3VycmVuY2llcykgPyAkcXVvdGF0aW9uLT5yZWxTdXBwbGllcnMtPmN1cnJlbmNpZXMtPnBsdWNrKCdpZCcpLT50b0FycmF5KCkgOiBbXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIF0pLT5nZXQoKTsKCiAgICAgICAgICAgICRwYXltZW50VGVybXMgPSBQYXltZW50VGVybTo6YWxsKCk7CgogICAgICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMucXVvdGF0aW9uLmVkaXQnLCBjb21wYWN0KCd0aXRsZScsICdxdW90YXRpb24nLCAnYWRkaXRpb25hbFRlcm1zJywgJ2N1cnJlbmNpZXMnLCAncGF5bWVudFRlcm1zJywgJ3JlcXVpc2l0aW9uSXRlbXMnKSk7CgogICAgICAgIH0gY2F0Y2ggKFxFeGNlcHRpb24gJGUpIHsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCRlLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KCiAgICB9CgogICAgLyoqCiAgICAgKiBVcGRhdGUgYW4gZXhpc3RpbmcgY3JlYXRlZCByZXNvdXJjZSBpbiBzdG9yYWdlLgogICAgICoKICAgICAqIEBwYXJhbSBcSWxsdW1pbmF0ZVxIdHRwXFJlcXVlc3QgJHJlcXVlc3QKICAgICAqIEBwYXJhbSBcSWxsdW1pbmF0ZVxIdHRwXFJlcXVlc3QgJGlkCiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVkaXJlY3RSZXNwb25zZQogICAgICovCgogICAgcHVibGljIGZ1bmN0aW9uIHVwZGF0ZShSZXF1ZXN0ICRyZXF1ZXN0LCAkaWQpCiAgICB7CiAgICAgICAgJHJlcXVlc3QtPnZhbGlkYXRlKFsKICAgICAgICAgICAgJ2N1cnJlbmN5X2lkJyA9PiBbJ3JlcXVpcmVkJ10sCiAgICAgICAgICAgIC8vICdzdXBwbGllcl9wYXltZW50X3Rlcm1zX2lkJyA9PiBbJ3JlcXVpcmVkJ10sCiAgICAgICAgICAgICdkZWxpdmVyeV9kYXRlJyA9PiBbJ3JlcXVpcmVkJ10sCiAgICAgICAgICAgICdxdW90YXRpb25fZGF0ZScgPT4gWydyZXF1aXJlZCcsICdkYXRlJ10sCiAgICAgICAgICAgICJyZXF1ZXN0X3Byb3Bvc2FsX2lkIiA9PiAicmVxdWlyZWQiLAogICAgICAgICAgICAnc3VtX29mX3N1YnRvdGFsJyA9PiAncmVxdWlyZWQnLAogICAgICAgICAgICAnZGlzY291bnQnID0+ICdudWxsYWJsZScsCiAgICAgICAgICAgICd2YXQnID0+ICdudWxsYWJsZScsCiAgICAgICAgICAgICdncm9zc19wcmljZScgPT4gJ3JlcXVpcmVkJywKICAgICAgICAgICAgJ3R5cGUnID0+ICdyZXF1aXJlZHxpbjpvbmxpbmUsbWFudWFsJywKICAgICAgICAgICAgJ3ZhbGlkYXRpb25fZGF5cycgPT4gJ3JlcXVpcmVkJywKCiAgICAgICAgICAgICdwYXltZW50X3Rlcm1faWQnID0+ICdyZXF1aXJlZCcsCiAgICAgICAgICAgICdwYXltZW50X3BlcmNlbnRhZ2VzJyA9PiAncmVxdWlyZWQnLAogICAgICAgICAgICAncGF5bWVudF9wZXJjZW50YWdlcy4qJyA9PiAncmVxdWlyZWQnLAogICAgICAgICAgICAvLyAncGF5bWVudF9kdXJhdGlvbnMnID0+ICdyZXF1aXJlZCcsCiAgICAgICAgICAgIC8vICdwYXltZW50X2R1cmF0aW9ucy4qJyA9PiAncmVxdWlyZWQnLAogICAgICAgICAgICAncGF5bWVudF90eXBlcycgPT4gJ3JlcXVpcmVkJywKICAgICAgICAgICAgJ3BheW1lbnRfdHlwZXMuKicgPT4gJ3JlcXVpcmVkJywKICAgICAgICAgICAgJ3BheW1lbnRfbW9kZXMnID0+ICdyZXF1aXJlZCcsCiAgICAgICAgICAgICdwYXltZW50X21vZGVzLionID0+ICdyZXF1aXJlZCcsCiAgICAgICAgXSk7CgogICAgICAgICRtb2RhbCA9IFF1b3RhdGlvbnM6OmZpbmRPckZhaWwoJGlkKTsKCiAgICAgICAgaWYgKCEkbW9kYWwpIHsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCdRdW90YXRpb24gbm90IGZvdW5kISEnKTsKICAgICAgICB9CgogICAgICAgIERCOjpiZWdpblRyYW5zYWN0aW9uKCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgJHRoaXMtPnF1b3RhdGlvbkhpc3RvcnlTdG9yZSgkbW9kYWwpOwoKICAgICAgICAgICAgJHF1b3RhdGlvbkZpbGVQYXRoID0gJG1vZGFsLT5xdW90YXRpb25fZmlsZTsKICAgICAgICAgICAgaWYgKCRyZXF1ZXN0LT5oYXNGaWxlKCdxdW90YXRpb25fZmlsZScpKSB7CiAgICAgICAgICAgICAgICAkcXVvdGF0aW9uRmlsZVBhdGggPSAkdGhpcy0+ZmlsZVVwbG9hZCgkcmVxdWVzdC0+ZmlsZSgncXVvdGF0aW9uX2ZpbGUnKSwgJ3VwbG9hZC9xdW90YXRpb24vcGRmLWZpbGUnKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgJHRlY2huaWNhbEZpbGVQYXRoID0gJG1vZGFsLT50ZWNobmljYWxfc3BlY2lmaWNhdGlvbl9maWxlOwogICAgICAgICAgICBpZiAoJHJlcXVlc3QtPmhhc0ZpbGUoJ3RlY2huaWNhbF9zcGVjaWZpY2F0aW9uX2ZpbGUnKSkgewogICAgICAgICAgICAgICAgJHRlY2huaWNhbEZpbGVQYXRoID0gJHRoaXMtPmZpbGVVcGxvYWQoJHJlcXVlc3QtPmZpbGUoJ3RlY2huaWNhbF9zcGVjaWZpY2F0aW9uX2ZpbGUnKSwgJ3VwbG9hZC9xdW90YXRpb24vdGVjaG5pY2FsLWZpbGUnKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgJHNsID0gMDsKICAgICAgICAgICAgJHN1cHBsaWVyX3BheW1lbnRfdGVybXNfaWQgPSAwOwogICAgICAgICAgICBpZihpc3NldCgkcmVxdWVzdC0+cGF5bWVudF9wZXJjZW50YWdlc1swXSkpewogICAgICAgICAgICAgICAgZm9yZWFjaCgkcmVxdWVzdC0+cGF5bWVudF9wZXJjZW50YWdlcyBhcyAka2V5ID0+ICR2YWx1ZSl7CiAgICAgICAgICAgICAgICAgICAgJHN1cHBsaWVyUGF5bWVudFRlcm0gPSBTdXBwbGllclBheW1lbnRUZXJtOjpjcmVhdGUoWwogICAgICAgICAgICAgICAgICAgICAgICAnc3VwcGxpZXJfaWQnID0+ICRyZXF1ZXN0LT5zdXBwbGllcl9pZCwKICAgICAgICAgICAgICAgICAgICAgICAgJ3BheW1lbnRfdGVybV9pZCcgPT4gJHJlcXVlc3QtPnBheW1lbnRfdGVybV9pZCwKICAgICAgICAgICAgICAgICAgICAgICAgJ3BheW1lbnRfcGVyY2VudCcgPT4gJHJlcXVlc3QtPnBheW1lbnRfcGVyY2VudGFnZXNbJGtleV0sCiAgICAgICAgICAgICAgICAgICAgICAgICdkYXlfZHVyYXRpb24nID0+IDEsCiAgICAgICAgICAgICAgICAgICAgICAgIC8vICdkYXlfZHVyYXRpb24nID0+ICRyZXF1ZXN0LT5wYXltZW50X2R1cmF0aW9uc1ska2V5XSwKICAgICAgICAgICAgICAgICAgICAgICAgJ3R5cGUnID0+ICRyZXF1ZXN0LT5wYXltZW50X3R5cGVzWyRrZXldLAogICAgICAgICAgICAgICAgICAgICAgICAncGF5bWVudF9tb2RlJyA9PiAkcmVxdWVzdC0+cGF5bWVudF9tb2Rlc1ska2V5XSwKICAgICAgICAgICAgICAgICAgICAgICAgJ3BhcmVudF9pZCcgPT4gaXNzZXQoJHBhcmVudC0+aWQpID8gJHBhcmVudC0+aWQgOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAnc291cmNlJyA9PiAnY3MnLAogICAgICAgICAgICAgICAgICAgIF0pOwoKICAgICAgICAgICAgICAgICAgICAkc2wrKzsKCiAgICAgICAgICAgICAgICAgICAgaWYoJHNsID09IDEpewogICAgICAgICAgICAgICAgICAgICAgICAkcGFyZW50ID0gJHN1cHBsaWVyUGF5bWVudFRlcm07CiAgICAgICAgICAgICAgICAgICAgICAgICRzdXBwbGllcl9wYXltZW50X3Rlcm1zX2lkID0gJHN1cHBsaWVyUGF5bWVudFRlcm0tPmlkOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgJHF1b3RhdGlvbiA9ICRtb2RhbC0+dXBkYXRlKFsKICAgICAgICAgICAgICAgICdzdXBwbGllcl9pZCcgPT4gJHJlcXVlc3QtPnN1cHBsaWVyX2lkLAogICAgICAgICAgICAgICAgJ3F1b3RhdGlvbl9kYXRlJyA9PiBkYXRlKCdZLW0tZCcsIHN0cnRvdGltZSgkcmVxdWVzdC0+cXVvdGF0aW9uX2RhdGUpKSwKICAgICAgICAgICAgICAgICdleGNoYW5nZV9yYXRlX2lkJyA9PiBnZXRFeGNoYW5nZVJhdGVzKCRyZXF1ZXN0LT5jdXJyZW5jeV9pZClbJ3JhdGUnXS0+aWQsCiAgICAgICAgICAgICAgICAndG90YWxfcHJpY2UnID0+ICRyZXF1ZXN0LT5zdW1fb2Zfc3VidG90YWwsCiAgICAgICAgICAgICAgICAnZGlzY291bnQnID0+ICRyZXF1ZXN0LT5kaXNjb3VudCwKICAgICAgICAgICAgICAgICd2YXQnID0+IGNvbGxlY3QoJHJlcXVlc3QtPnN1Yl90b3RhbF92YXRfcHJpY2UpLT5zdW0oKSwKICAgICAgICAgICAgICAgICdncm9zc19wcmljZScgPT4gJHJlcXVlc3QtPmdyb3NzX3ByaWNlLAogICAgICAgICAgICAgICAgJ3ZhbGlkYXRpb25fZGF5cycgPT4gJHJlcXVlc3QtPnZhbGlkYXRpb25fZGF5cywKICAgICAgICAgICAgICAgICdzdGF0dXMnID0+ICdhY3RpdmUnLAogICAgICAgICAgICAgICAgJ3F1b3RhdGlvbl9maWxlJyA9PiAkcXVvdGF0aW9uRmlsZVBhdGgsCiAgICAgICAgICAgICAgICAndGVjaG5pY2FsX3NwZWNpZmljYXRpb25fZmlsZScgPT4gJHRlY2huaWNhbEZpbGVQYXRoLAogICAgICAgICAgICAgICAgJ2RlbGl2ZXJ5X2RhdGUnID0+IGlzc2V0KCRyZXF1ZXN0LT5kZWxpdmVyeV9kYXRlKSA/ICRyZXF1ZXN0LT5kZWxpdmVyeV9kYXRlIDogZGF0ZSgnWS1tLWQnKSwKICAgICAgICAgICAgICAgICdzdXBwbGllcl9wYXltZW50X3Rlcm1zX2lkJyA9PiAkc3VwcGxpZXJfcGF5bWVudF90ZXJtc19pZCwKICAgICAgICAgICAgXSk7CgogICAgICAgICAgICBmb3JlYWNoICgkbW9kYWwtPnJlbFF1b3RhdGlvbkl0ZW1zIGFzICRpID0+ICRpdGVtKSB7CiAgICAgICAgICAgICAgICAkaXRlbVRlY2huaWNhbEZpbGVQYXRoID0gJGl0ZW0tPnRlY2huaWNhbF9zcGVjaWZpY2F0aW9uX2ZpbGU7CiAgICAgICAgICAgICAgICBpZiAoJHJlcXVlc3QtPmhhc0ZpbGUoJ2l0ZW1fdGVjaG5pY2FsX3NwZWNpZmljYXRpb25fZmlsZS4nIC4gJGl0ZW0tPmlkKSkgewogICAgICAgICAgICAgICAgICAgICRpdGVtVGVjaG5pY2FsRmlsZVBhdGggPSAkdGhpcy0+ZmlsZVVwbG9hZCgkcmVxdWVzdC0+ZmlsZSgnaXRlbV90ZWNobmljYWxfc3BlY2lmaWNhdGlvbl9maWxlLicgLiAkaXRlbS0+aWQpLCAndXBsb2FkL3F1b3RhdGlvbi9pdGVtLXRlY2huaWNhbC1maWxlJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgJGl0ZW0tPnVwZGF0ZShbCiAgICAgICAgICAgICAgICAgICAgJ3Byb2R1Y3RfaWQnID0+ICRpdGVtLT5wcm9kdWN0X2lkLAogICAgICAgICAgICAgICAgICAgICdkZXNjcmlwdGlvbicgPT4gJHJlcXVlc3QtPnByb2R1Y3RfZGVzY3JpcHRpb25bJGl0ZW0tPmlkXSwKICAgICAgICAgICAgICAgICAgICAndW5pdF9wcmljZScgPT4gJHJlcXVlc3QtPnVuaXRfcHJpY2VbJGl0ZW0tPmlkXSwKICAgICAgICAgICAgICAgICAgICAncXR5JyA9PiAkcmVxdWVzdC0+cXR5WyRpdGVtLT5pZF0sCiAgICAgICAgICAgICAgICAgICAgJ3N1Yl90b3RhbF9wcmljZScgPT4gJHJlcXVlc3QtPnN1Yl90b3RhbF9wcmljZVskaXRlbS0+aWRdLAogICAgICAgICAgICAgICAgICAgICdkaXNjb3VudCcgPT4gJHJlcXVlc3QtPml0ZW1fZGlzY291bnRfcGVyY2VudFskaXRlbS0+aWRdID09IG51bGwgPyAwIDogJHJlcXVlc3QtPml0ZW1fZGlzY291bnRfcGVyY2VudFskaXRlbS0+aWRdLAogICAgICAgICAgICAgICAgICAgICdkaXNjb3VudF9hbW91bnQnID0+ICRyZXF1ZXN0LT5pdGVtX2Rpc2NvdW50X2Ftb3VudFskaXRlbS0+aWRdLAogICAgICAgICAgICAgICAgICAgICd2YXRfdHlwZScgPT4gJHJlcXVlc3QtPnByb2R1Y3RfdmF0X3R5cGVbJGl0ZW0tPmlkXSwKICAgICAgICAgICAgICAgICAgICAndmF0X3BlcmNlbnRhZ2UnID0+ICRyZXF1ZXN0LT5wcm9kdWN0X3ZhdFskaXRlbS0+aWRdLAogICAgICAgICAgICAgICAgICAgICd2YXQnID0+ICRyZXF1ZXN0LT5zdWJfdG90YWxfdmF0X3ByaWNlWyRpdGVtLT5pZF0sCiAgICAgICAgICAgICAgICAgICAgJ3RvdGFsX3ByaWNlJyA9PiAoJHJlcXVlc3QtPnN1Yl90b3RhbF9wcmljZVskaXRlbS0+aWRdIC0gJHJlcXVlc3QtPml0ZW1fZGlzY291bnRfYW1vdW50WyRpdGVtLT5pZF0pICsgKCRyZXF1ZXN0LT5wcm9kdWN0X3ZhdF90eXBlWyRpdGVtLT5pZF0gPT0gJ2V4Y2x1c2l2ZScgPyAkcmVxdWVzdC0+c3ViX3RvdGFsX3ZhdF9wcmljZVskaXRlbS0+aWRdIDogMCksCiAgICAgICAgICAgICAgICAgICAgJ3VwZGF0ZWRfYXQnID0+IGRhdGUoJ1ktbS1kIEg6aTpzJyksCiAgICAgICAgICAgICAgICAgICAgJ3RlY2huaWNhbF9zcGVjaWZpY2F0aW9uX2ZpbGUnID0+ICRpdGVtVGVjaG5pY2FsRmlsZVBhdGgsCiAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgREI6OmNvbW1pdCgpOwogICAgICAgICAgICByZXR1cm4gJHRoaXMtPnJlZGlyZWN0QmFja1dpdGhTdWNjZXNzKCdRdW90YXRpb24gVXBkYXRlZCBTdWNjZXNzZnVsbHknLCAncG1zLnF1b3RhdGlvbi5xdW90YXRpb25zLmluZGV4Jyk7CiAgICAgICAgfSBjYXRjaCAoXFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgREI6OnJvbGxiYWNrKCk7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBxdW90YXRpb25IaXN0b3J5U3RvcmUoJG1vZGVsKQogICAgewogICAgICAgICRxdW90YXRpb25IaXN0b3J5ID0gUXVvdGF0aW9uSGlzdG9yeTo6Y3JlYXRlKFsKICAgICAgICAgICAgJ3F1b3RhdGlvbl9pZCcgPT4gJG1vZGVsLT5pZCwKICAgICAgICAgICAgJ3N1cHBsaWVyX3BheW1lbnRfdGVybXNfaWQnID0+ICRtb2RlbC0+c3VwcGxpZXJfcGF5bWVudF90ZXJtc19pZCwKICAgICAgICAgICAgJ3F1b3RhdGlvbl9kYXRlJyA9PiAkbW9kZWwtPnF1b3RhdGlvbl9kYXRlLAogICAgICAgICAgICAnZXhjaGFuZ2VfcmF0ZV9pZCcgPT4gJG1vZGVsLT5leGNoYW5nZV9yYXRlX2lkLAogICAgICAgICAgICAndG90YWxfcHJpY2UnID0+ICRtb2RlbC0+dG90YWxfcHJpY2UsCiAgICAgICAgICAgICdkaXNjb3VudCcgPT4gJG1vZGVsLT5kaXNjb3VudCwKICAgICAgICAgICAgJ3ZhdCcgPT4gJG1vZGVsLT52YXQsCiAgICAgICAgICAgICdncm9zc19wcmljZScgPT4gJG1vZGVsLT5ncm9zc19wcmljZSwKICAgICAgICAgICAgJ3ZhbGlkYXRpb25fZGF5cycgPT4gJG1vZGVsLT52YWxpZGF0aW9uX2RheXMsCiAgICAgICAgICAgICdzdGF0dXMnID0+ICRtb2RlbC0+c3RhdHVzLAogICAgICAgICAgICAndHlwZScgPT4gJG1vZGVsLT50eXBlLAogICAgICAgICAgICAncXVvdGF0aW9uX2ZpbGUnID0+ICRtb2RlbC0+cXVvdGF0aW9uX2ZpbGUsCiAgICAgICAgICAgICdyZW1hcmtzJyA9PiAkbW9kZWwtPnJlbWFya3MsCiAgICAgICAgICAgICdub3RlJyA9PiAkbW9kZWwtPm5vdGUsCiAgICAgICAgICAgICdkZWxpdmVyeV9kYXRlJyA9PiAkbW9kZWwtPmRlbGl2ZXJ5X2RhdGUsCiAgICAgICAgICAgICd0ZWNobmljYWxfc3BlY2lmaWNhdGlvbl9maWxlJyA9PiAkbW9kZWwtPnRlY2huaWNhbF9zcGVjaWZpY2F0aW9uX2ZpbGUsCiAgICAgICAgXSk7CgogICAgICAgIGZvcmVhY2ggKCRtb2RlbC0+cmVsUXVvdGF0aW9uSXRlbXMgYXMgJGkgPT4gJGl0ZW0pIHsKCiAgICAgICAgICAgICRxdW90YXRpb25JdGVtc0lucHV0W10gPSBbCiAgICAgICAgICAgICAgICAncXVvdGF0aW9uX2hpc3RvcnlfaWQnID0+ICRxdW90YXRpb25IaXN0b3J5LT5pZCwKICAgICAgICAgICAgICAgICd1aWQnID0+ICRpdGVtLT51aWQsCiAgICAgICAgICAgICAgICAncHJvZHVjdF9pZCcgPT4gJGl0ZW0tPnByb2R1Y3RfaWQsCiAgICAgICAgICAgICAgICAnZGVzY3JpcHRpb24nID0+ICRpdGVtLT5kZXNjcmlwdGlvbiwKICAgICAgICAgICAgICAgICd1bml0X3ByaWNlJyA9PiAkaXRlbS0+dW5pdF9wcmljZSwKICAgICAgICAgICAgICAgICdxdHknID0+ICRpdGVtLT5xdHksCiAgICAgICAgICAgICAgICAnc3ViX3RvdGFsX3ByaWNlJyA9PiAkaXRlbS0+c3ViX3RvdGFsX3ByaWNlLAogICAgICAgICAgICAgICAgJ2Rpc2NvdW50JyA9PiAkaXRlbS0+ZGlzY291bnQsCiAgICAgICAgICAgICAgICAnZGlzY291bnRfYW1vdW50JyA9PiAkaXRlbS0+ZGlzY291bnRfYW1vdW50LAogICAgICAgICAgICAgICAgJ3ZhdF90eXBlJyA9PiAkaXRlbS0+dmF0X3R5cGUsCiAgICAgICAgICAgICAgICAndmF0X3BlcmNlbnRhZ2UnID0+ICRpdGVtLT52YXRfcGVyY2VudGFnZSwKICAgICAgICAgICAgICAgICd2YXQnID0+ICRpdGVtLT52YXQsCiAgICAgICAgICAgICAgICAndG90YWxfcHJpY2UnID0+ICRpdGVtLT50b3RhbF9wcmljZSwKICAgICAgICAgICAgICAgICdjcmVhdGVkX2J5JyA9PiAkcXVvdGF0aW9uSGlzdG9yeS0+Y3JlYXRlZF9ieSwKICAgICAgICAgICAgICAgICd1cGRhdGVkX2J5JyA9PiAkcXVvdGF0aW9uSGlzdG9yeS0+dXBkYXRlZF9ieSwKICAgICAgICAgICAgICAgICdjcmVhdGVkX2F0JyA9PiBkYXRlKCdZLW0tZCBoOmknKSwKICAgICAgICAgICAgICAgICd0ZWNobmljYWxfc3BlY2lmaWNhdGlvbl9maWxlJyA9PiAkaXRlbS0+dGVjaG5pY2FsX3NwZWNpZmljYXRpb25fZmlsZSwKICAgICAgICAgICAgXTsKICAgICAgICB9CgogICAgICAgIC8vUXVvdGF0aW9uIGl0ZW1zIGluc2VydC4KICAgICAgICBRdW90YXRpb25IaXN0b3J5SXRlbTo6aW5zZXJ0KCRxdW90YXRpb25JdGVtc0lucHV0KTsKCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBEaXNwbGF5IGEgbGlzdGluZyBvZiB0aGUgcmVzb3VyY2UuCiAgICAgKgogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KICAgIHB1YmxpYyBmdW5jdGlvbiBjb21wYXJlR3JpZFZpZXcoJHJlcXVlc3RfcHJvcG9zYWxfaWQpCiAgICB7CiAgICAgICAgdHJ5IHsKCiAgICAgICAgICAgICR0aXRsZSA9ICdRdW90YXRpb25zIENvbXBhcmUgQW5hbHlzaXMnOwogICAgICAgICAgICAkcXVvdGF0aW9ucyA9IFF1b3RhdGlvbnM6OndoZXJlKCdzdGF0dXMnLCAnYWN0aXZlJykKICAgICAgICAgICAgICAgIC0+d2hlcmUoJ2lzX2FwcHJvdmVkJywgJ3BlbmRpbmcnKQogICAgICAgICAgICAgICAgLT53aGVyZSgncmVxdWVzdF9wcm9wb3NhbF9pZCcsICRyZXF1ZXN0X3Byb3Bvc2FsX2lkKQogICAgICAgICAgICAgICAgLT5vcmRlcmJ5KCdncm9zc19wcmljZScsICdhc2MnKQogICAgICAgICAgICAgICAgLT5nZXQoKTsKCiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5xdW90YXRpb24uX2NvbXBhcmUyJywgY29tcGFjdCgndGl0bGUnLCAncXVvdGF0aW9ucycpKTsKCiAgICAgICAgfSBjYXRjaCAoXFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CgogICAgfQoKICAgIC8qKgogICAgICogRGlzcGxheSBhIGxpc3Rpbmcgb2YgdGhlIHJlc291cmNlLgogICAgICoKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCgogICAgcHVibGljIGZ1bmN0aW9uIGNvbXBhcmVMaXN0VmlldygkcmVxdWVzdF9wcm9wb3NhbF9pZCkKICAgIHsKICAgICAgICB0cnkgewogICAgICAgICAgICAkdGl0bGUgPSAnUXVvdGF0aW9ucyBDb21wYXJlIEFuYWx5c2lzJzsKICAgICAgICAgICAgJHF1b3RhdGlvbnMgPSBRdW90YXRpb25zOjp3aGVyZSgnc3RhdHVzJywgJ2FjdGl2ZScpCiAgICAgICAgICAgIC0+d2l0aChbCiAgICAgICAgICAgICAgICAnZXhjaGFuZ2VSYXRlLmN1cnJlbmN5JywKICAgICAgICAgICAgICAgICdyZWxSZXF1ZXN0UHJvcG9zYWwuY3JlYXRlZEJ5JywKICAgICAgICAgICAgICAgICdyZWxTdXBwbGllcnMucmVsUGF5bWVudFRlcm1zJywKICAgICAgICAgICAgICAgICdyZWxTdXBwbGllcnMuU3VwcGxpZXJSYXRpbmdzJywKICAgICAgICAgICAgICAgICdleGNoYW5nZVJhdGUuY3VycmVuY3knLAogICAgICAgICAgICAgICAgJ3JlbFF1b3RhdGlvbkl0ZW1zLnJlbFByb2R1Y3QucHJvZHVjdFVuaXQnLAogICAgICAgICAgICAgICAgJ3JlbFF1b3RhdGlvbkl0ZW1zLnJlbFByb2R1Y3QuY2F0ZWdvcnkuY2F0ZWdvcnknLAogICAgICAgICAgICAgICAgJ3JlbFF1b3RhdGlvbkl0ZW1zLnJlbFByb2R1Y3QuYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24uYXR0cmlidXRlJwogICAgICAgICAgICBdKQogICAgICAgICAgICAtPndoZXJlSW4oJ2lzX2FwcHJvdmVkJywgKGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdQdXJjaGFzZS1EZXBhcnRtZW50JykgPyBbJ3BlbmRpbmcnLCAncHJlLXByb2Nlc3NpbmcnXSA6IFsncGVuZGluZycsICdwcmUtcHJvY2Vzc2luZyddKSkKICAgICAgICAgICAgLT53aGVyZSgncmVxdWVzdF9wcm9wb3NhbF9pZCcsICRyZXF1ZXN0X3Byb3Bvc2FsX2lkKQogICAgICAgICAgICAtPm9yZGVyYnkoJ2dyb3NzX3ByaWNlJywgJ2FzYycpCiAgICAgICAgICAgIC0+Z2V0KCk7CgogICAgICAgICAgICAkcmVxdWlzaXRpb25JdGVtcyA9IFJlcXVpc2l0aW9uSXRlbTo6d2l0aChbCiAgICAgICAgICAgICAgICAnYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24uYXR0cmlidXRlJwogICAgICAgICAgICBdKQogICAgICAgICAgICAtPndoZXJlSGFzKCdyZXF1aXNpdGlvbi5yZXF1ZXN0UHJvcG9zYWxSZXF1aXNpdGlvbicsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRyZXF1ZXN0X3Byb3Bvc2FsX2lkKXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdyZXF1ZXN0X3Byb3Bvc2FsX2lkJywgJHJlcXVlc3RfcHJvcG9zYWxfaWQpOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPmdldCgpOwoKICAgICAgICAgICAgJHN5c3RlbUN1cnJlbmN5ID0gc3lzdGVtQ3VycmVuY3koKTsKICAgICAgICAgICAgaWYgKGlzc2V0KCRxdW90YXRpb25zWzBdKSkgewogICAgICAgICAgICAgICAgJGFwcHJvdmVycyA9IFVzZXI6OnJvbGUoWydEZXBhcnRtZW50LUhlYWQnLCAnTWFuYWdlbWVudCddKQogICAgICAgICAgICAgICAgLT53aGVyZUhhcygncHJpb3JpdGllcycsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRxdW90YXRpb25zKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnaHJfdW5pdF9pZCcsICRxdW90YXRpb25zLT5maXJzdCgpLT5yZWxSZXF1ZXN0UHJvcG9zYWwtPnJlcXVlc3RQcm9wb3NhbFJlcXVpc2l0aW9uLT5maXJzdCgpLT5yZWxSZXF1aXNpdGlvbi0+aHJfdW5pdF9pZCk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5nZXQoKTsKICAgICAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5xdW90YXRpb24uX2NvbXBhcmUnLCBjb21wYWN0KCd0aXRsZScsICdxdW90YXRpb25zJywgJ3N5c3RlbUN1cnJlbmN5JywgJ2FwcHJvdmVycycsICdyZXF1aXNpdGlvbkl0ZW1zJykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBiYWNrKCk7CiAgICAgICAgfSBjYXRjaCAoXFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBEaXNwbGF5IGEgbGlzdGluZyBvZiB0aGUgcmVzb3VyY2UuCiAgICAgKgogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KCiAgICBwdWJsaWMgZnVuY3Rpb24gY29tcGFyZVN0b3JlKFJlcXVlc3QgJHJlcXVlc3QpCiAgICB7CiAgICAgICAgaWYgKCFpc3NldCgkcmVxdWVzdC0+cXVvdGF0aW9uX2lkWzBdKSkgewogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gZmFsc2UsCiAgICAgICAgICAgICAgICAnbWVzc2FnZScgPT4gIlBsZWFzZSBjaG9vc2UgYXQgbGVhc3Qgb25lIHF1b3RhdGlvbiB0byBzZW5kIHRvIHRoZSBNYW5hZ2VtZW50LiIsCiAgICAgICAgICAgIF0pOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFpc3NldCgkcmVxdWVzdC0+YXBwcm92ZXJzWzBdKSkgewogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gZmFsc2UsCiAgICAgICAgICAgICAgICAnbWVzc2FnZScgPT4gIlBsZWFzZSBjaG9vc2UgYXQgbGVhc3Qgb25lIEFwcHJvdmVycy4iLAogICAgICAgICAgICBdKTsKICAgICAgICB9CgogICAgICAgIERCOjpiZWdpblRyYW5zYWN0aW9uKCk7CiAgICAgICAgdHJ5IHsKCiAgICAgICAgICAgIGZvcmVhY2ggKCRyZXF1ZXN0LT5xdW90YXRpb25faWQgYXMgJGtleSA9PiAkcXVvdGF0aW9uX2lkKSB7CiAgICAgICAgICAgICAgICAkbW9kYWwgPSBRdW90YXRpb25zOjp3aXRoKFsKICAgICAgICAgICAgICAgICAgICAncmVsUXVvdGF0aW9uSXRlbXMnCiAgICAgICAgICAgICAgICBdKQogICAgICAgICAgICAgICAgLT53aGVyZShbCiAgICAgICAgICAgICAgICAgICAgJ2lkJyA9PiAkcXVvdGF0aW9uX2lkLAogICAgICAgICAgICAgICAgICAgICdyZXF1ZXN0X3Byb3Bvc2FsX2lkJyA9PiAkcmVxdWVzdC0+cmVxdWVzdF9wcm9wb3NhbF9pZAogICAgICAgICAgICAgICAgXSkKICAgICAgICAgICAgICAgIC0+d2hlcmVJbignaXNfYXBwcm92ZWQnLCAoYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ1B1cmNoYXNlLURlcGFydG1lbnQnKSA/IFsncGVuZGluZycsICdwcmUtcHJvY2Vzc2luZyddIDogWydwZW5kaW5nJywgJ3ByZS1wcm9jZXNzaW5nJ10pKQogICAgICAgICAgICAgICAgLT5maXJzdCgpOwoKICAgICAgICAgICAgICAgIGlmIChpc3NldCgkbW9kYWwpKSB7CiAgICAgICAgICAgICAgICAgICAgJG1vZGFsLT5yZWNvbW1lbmRhdGlvbiA9IGluX2FycmF5KCRtb2RhbC0+aWQsIGlzc2V0KCRyZXF1ZXN0LT5xdW90YXRpb25fcmVjb21tZW5kYXRpb25zWzBdKSA/ICRyZXF1ZXN0LT5xdW90YXRpb25fcmVjb21tZW5kYXRpb25zIDogW10pID8gJ3llcycgOiAnbm8nOwogICAgICAgICAgICAgICAgICAgICRtb2RhbC0+aXNfYXBwcm92ZWQgPSAncHJvY2Vzc2luZyc7CiAgICAgICAgICAgICAgICAgICAgJG1vZGFsLT5ub3RlID0gJHJlcXVlc3QtPm5vdGVbJHF1b3RhdGlvbl9pZF07CgogICAgICAgICAgICAgICAgICAgIGlmKCRtb2RhbC0+c2F2ZSgpKXsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoJG1vZGFsLT5yZWxRdW90YXRpb25JdGVtcy0+Y291bnQoKSA+IDApewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yZWFjaCgkbW9kYWwtPnJlbFF1b3RhdGlvbkl0ZW1zIGFzICRrZXkgPT4gJGl0ZW0pewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRpdGVtLT5yZWNvbW1lbmRlZF9xdWFudGl0eSA9ICRyZXF1ZXN0LT5yZWNvbW1lbmRhdGlvbnNbJGl0ZW0tPmlkXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkaXRlbS0+c2F2ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZihpc3NldCgkcmVxdWVzdC0+YXBwcm92ZXJzWzBdKSl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcHJpb3JpdHkgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yZWFjaCgkcmVxdWVzdC0+YXBwcm92ZXJzIGFzICRrZXkgPT4gJHVzZXJfaWQpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhcHByb3ZhbCA9IFJlcXVlc3RQcm9wb3NhbEFwcHJvdmFsOjp3aGVyZShbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdyZXF1ZXN0X3Byb3Bvc2FsX2lkJyA9PiAkcmVxdWVzdC0+cmVxdWVzdF9wcm9wb3NhbF9pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3VzZXJfaWQnID0+ICR1c2VyX2lkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0pLT5maXJzdCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCFpc3NldCgkYXBwcm92YWwpKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHByaW9yaXR5Kys7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFJlcXVlc3RQcm9wb3NhbEFwcHJvdmFsOjpjcmVhdGUoWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3JlcXVlc3RfcHJvcG9zYWxfaWQnID0+ICRyZXF1ZXN0LT5yZXF1ZXN0X3Byb3Bvc2FsX2lkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3VzZXJfaWQnID0+ICR1c2VyX2lkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3ByaW9yaXR5JyA9PiAkcHJpb3JpdHksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAncmVzcG9uc2UnID0+ICdwZW5kaW5nJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ1B1cmNoYXNlLUVtcGxveWVlJykpIHsKICAgICAgICAgICAgICAgICRtZXNzYWdlID0gJzxzcGFuIGNsYXNzPSJub3RpZmljYXRpb24tbGlua3MiIGRhdGEtc3JjPSInIC4gdXJsKCdwbXMvcXVvdGF0aW9uL2NzLWNvbXBhcmUtdmlldy1ub3RpZmljYXRpb24vJyAuICRyZXF1ZXN0LT5yZXF1ZXN0X3Byb3Bvc2FsX2lkKSAuICciIGRhdGEtdGl0bGU9IlF1b3RhdGlvbiBDUyI+UmVmZXJlbmNlIE5vOicgLiAkbW9kYWwtPnJlZmVyZW5jZV9ubyAuICcuIFdhdHRpbmcgZm9yIFB1cmNoYXNlIEFwcHJvdmFsLjwvc3Bhbj4nOwoKICAgICAgICAgICAgICAgIENyZWF0ZU9yVXBkYXRlTm90aWZpY2F0aW9uKCRtZXNzYWdlLCAndW5yZWFkJywgJycsIGdldE1hbmFnZXJJbmZvKCdQdXJjaGFzZS1EZXBhcnRtZW50JywgbnVsbCwgdHJ1ZSksICdzZW5kLXRvLXB1cmNoYXNlLWRlcGFydG1lbnQnKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICRtZXNzYWdlID0gJzxzcGFuIGNsYXNzPSJub3RpZmljYXRpb24tbGlua3MiIGRhdGEtc3JjPSInIC4gdXJsKCdwbXMvcXVvdGF0aW9uL2NzLWNvbXBhcmUtdmlldy1ub3RpZmljYXRpb24vJyAuICRyZXF1ZXN0LT5yZXF1ZXN0X3Byb3Bvc2FsX2lkKSAuICciIGRhdGEtdGl0bGU9IlF1b3RhdGlvbiBDUyI+UmVmZXJlbmNlIE5vOicgLiAkbW9kYWwtPnJlZmVyZW5jZV9ubyAuICcuIFdhdHRpbmcgZm9yIE1hbmFnZW1lbnQgQXBwcm92YWwuPC9zcGFuPic7CiAgICAgICAgICAgICAgICBDcmVhdGVPclVwZGF0ZU5vdGlmaWNhdGlvbigkbWVzc2FnZSwgJ3VucmVhZCcsICcnLCAkcmVxdWVzdC0+YXBwcm92ZXJzLCAnc2VuZC10by1tYW5hZ2VyJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIERCOjpjb21taXQoKTsKCiAgICAgICAgICAgIHNlc3Npb24oKS0+Zmxhc2goJ2FsZXJ0LXR5cGUnLCAnc3VjY2VzcycpOwogICAgICAgICAgICBzZXNzaW9uKCktPmZsYXNoKCdtZXNzYWdlJywgJ1N1Y2Nlc3NmdWxseSBTZW5kIGZvciBhcHByb3ZhbCcpOwogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gdHJ1ZSwKICAgICAgICAgICAgICAgICd1cmwnID0+IHJvdXRlKCdwbXMucXVvdGF0aW9uLnF1b3RhdGlvbnMuY3MuYW5hbHlzaXMnKSwKICAgICAgICAgICAgXSk7CgogICAgICAgIH0gY2F0Y2ggKFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgREI6OnJvbGxiYWNrKCk7CiAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiBmYWxzZSwKICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAkdGgtPmdldE1lc3NhZ2UoKSwKICAgICAgICAgICAgXSk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogRGlzcGxheSBhIGxpc3Rpbmcgb2YgdGhlIHJlc291cmNlLgogICAgICoKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCiAgICBwdWJsaWMgZnVuY3Rpb24gYXBwcm92YWxIZWFkZXJDb2x1bW5zKCR2YWx1ZSA9ICcnKQogICAgewogICAgICAgIHJldHVybiBhcnJheSgKICAgICAgICAgICAgWydTTCcsICdTTCddLAogICAgICAgICAgICBbJ0NTX251bWJlcicsICdDU19udW1iZXInLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydyZXF1aXNpdGlvbnMnLCAncmVxdWlzaXRpb25zJywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsncHJvZHVjdHMnLCAncHJvZHVjdHMnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydzdXBwbGllcnMnLCAnc3VwcGxpZXInLCAndGV4dC1sZWZ0J10sCiAgICAgICAgICAgIFsnc3RhdHVzJywgJ3N0YXR1cycsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ2FwcHJvdmFscycsICdhcHByb3ZhbHMnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydhY3Rpb25zJywgJ2FjdGlvbnMnLCAndGV4dC1jZW50ZXIgYWN0aW9uJ10KICAgICAgICApOwogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBhcHByb3ZhbExpc3QoKQogICAgewogICAgICAgICR0aXRsZSA9ICdRdW90YXRpb25zIFJlcXVlc3QgRm9yIEFwcHJvdmVkJzsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgJHF1b3RhdGlvbnMgPSBRdW90YXRpb25zOjp3aXRoKFsKICAgICAgICAgICAgICAgICdyZWxRdW90YXRpb25JdGVtcycsCiAgICAgICAgICAgICAgICAncmVsUmVxdWVzdFByb3Bvc2FsJywKICAgICAgICAgICAgICAgICdyZWxTdXBwbGllcnMnLAogICAgICAgICAgICAgICAgJ2V4Y2hhbmdlUmF0ZS5jdXJyZW5jeScsCiAgICAgICAgICAgICAgICAncmVsU2VsZlF1b3RhdGlvblN1cHBsaWVyQnlQcm9wb3NhbElkLnJlbFN1cHBsaWVycycsCiAgICAgICAgICAgICAgICAncmVsUmVxdWVzdFByb3Bvc2FsLmFwcHJvdmFscy51c2VyJywKCiAgICAgICAgICAgICAgICAncmVsUmVxdWVzdFByb3Bvc2FsLnJlcXVlc3RQcm9wb3NhbFJlcXVpc2l0aW9uLnJlbFJlcXVpc2l0aW9uJywKICAgICAgICAgICAgICAgICdyZWxSZXF1ZXN0UHJvcG9zYWwucmVxdWVzdFByb3Bvc2FsRGV0YWlscy5wcm9kdWN0LmF0dHJpYnV0ZXMuYXR0cmlidXRlT3B0aW9uLmF0dHJpYnV0ZScKICAgICAgICAgICAgXSkKICAgICAgICAgICAgLT53aGVyZUhhcygncmVsUmVxdWVzdFByb3Bvc2FsLmFwcHJvdmFscycsIGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUluKCdyZXNwb25zZScsIFsncGVuZGluZycsICdkZW5pZWQnXSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlKCd1c2VyX2lkJywgYXV0aCgpLT51c2VyKCktPmlkKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT53aGVyZShbCiAgICAgICAgICAgICAgICAnc3RhdHVzJyA9PiAnYWN0aXZlJywKICAgICAgICAgICAgICAgICdpc19wb19nZW5lcmF0ZScgPT4gJ25vJywKICAgICAgICAgICAgXSkKICAgICAgICAgICAgLT53aGVyZSgnaXNfYXBwcm92ZWQnLCAncHJvY2Vzc2luZycpCiAgICAgICAgICAgIC0+d2hlcmVEb2VzbnRIYXZlKCdyZWxSZXF1ZXN0UHJvcG9zYWwucmVsUXVvdGF0aW9ucycsIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdpc19hcHByb3ZlZCcsICdhcHByb3ZlZCcpOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPndoZXJlTm90SW4oJ3R5cGUnLCBbJ2RpcmVjdC1wdXJjaGFzZSddKQogICAgICAgICAgICAtPndoZW4oIWRhdGF0YWJsZU9yZGVyaW5nKCksIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyYnkoJ2lkJywgJ2Rlc2MnKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT5ncm91cEJ5KCdyZXF1ZXN0X3Byb3Bvc2FsX2lkJyk7CgogICAgICAgICAgICAkYXBwcm92YWxSYW5nZSA9IEF1dGg6OnVzZXIoKS0+cmVsQXBwcm92YWxSYW5nZTsKCiAgICAgICAgICAgIGlmIChyZXF1ZXN0KCktPmFqYXgoKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIERhdGFUYWJsZXM6Om9mKCRxdW90YXRpb25zKQogICAgICAgICAgICAgICAgICAgIC0+YWRkSW5kZXhDb2x1bW4oKQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdDU19udW1iZXInLCBmdW5jdGlvbiAoJHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgY2xhc3M9ImJ0biBidG4tbGluayIgb25jbGljaz0icmVxdWVzdFByb3Bvc2FsRGV0YWlscygnIC4gJHZhbHVlcy0+cmVsUmVxdWVzdFByb3Bvc2FsLT5pZCAuICcpIj4nIC4gKGlzc2V0KCR2YWx1ZXMtPnJlbFJlcXVlc3RQcm9wb3NhbC0+cmVmZXJlbmNlX25vKSA/ICR2YWx1ZXMtPnJlbFJlcXVlc3RQcm9wb3NhbC0+cmVmZXJlbmNlX25vIDogJycpIC4gJzwvYT4nOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ0NTX251bWJlcicsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxSZXF1ZXN0UHJvcG9zYWwnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdyZWZlcmVuY2Vfbm8nLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdDU19udW1iZXInLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgUmVxdWVzdFByb3Bvc2FsOjpzZWxlY3QoJ3JlcXVlc3RfcHJvcG9zYWxzLnJlZmVyZW5jZV9ubycpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCdyZXF1ZXN0X3Byb3Bvc2Fscy5pZCcsICdxdW90YXRpb25zLnJlcXVlc3RfcHJvcG9zYWxfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT50YWtlKDEpCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbigncmVxdWlzaXRpb25zJywgZnVuY3Rpb24gKCRxdW90YXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9ucyA9ICcnOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRxdW90YXRpb24tPnJlbFJlcXVlc3RQcm9wb3NhbC0+cmVxdWVzdFByb3Bvc2FsUmVxdWlzaXRpb24tPmNvdW50KCkgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JlYWNoICgkcXVvdGF0aW9uLT5yZWxSZXF1ZXN0UHJvcG9zYWwtPnJlcXVlc3RQcm9wb3NhbFJlcXVpc2l0aW9uIGFzICRrZXkgPT4gJHJlcXVpc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9ucyAuPSAoJGtleSA+IDAgPyAnLCAnIDogJycpIC4gJzxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgZGF0YS1zcmM9IicgLiByb3V0ZSgncG1zLnJlcXVpc2l0aW9uLmxpc3Qudmlldy5zaG93JywgJHJlcXVpc2l0aW9uLT5yZWxSZXF1aXNpdGlvbi0+aWQpIC4gJyIgY2xhc3M9InRleHQtcHJpbWFyeSByZXF1aXNpdGlvbiBtLTEgcm91bmRlZCBzaG93UmVxdWlzdGlvbkRldGFpbHMiIG9uY2xpY2s9InJlcXVpc3Rpb25EZXRhaWxzKCQodGhpcykpIj4nIC4gJHJlcXVpc2l0aW9uLT5yZWxSZXF1aXNpdGlvbi0+cmVmZXJlbmNlX25vIC4gJzwvYT4nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHJlcXVpc2l0aW9uczsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdyZXF1aXNpdGlvbnMnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlSGFzKCdyZWxSZXF1ZXN0UHJvcG9zYWwucmVxdWVzdFByb3Bvc2FsUmVxdWlzaXRpb24ucmVsUmVxdWlzaXRpb24nLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgncmVmZXJlbmNlX25vJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbigncmVxdWlzaXRpb25zJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwbGVhc2VTb3J0TWUoJHF1ZXJ5LCAkb3JkZXIsIFJlcXVlc3RQcm9wb3NhbDo6c2VsZWN0KCdyZXF1aXNpdGlvbnMucmVmZXJlbmNlX25vJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbigncmVxdWlzaXRpb25zJywgJ3JlcXVpc2l0aW9ucy5pZCcsICc9JywgJ3JlcXVlc3RfcHJvcG9zYWxfcmVxdWlzaXRpb25zLnJlcXVpc2l0aW9uX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbigncmVxdWVzdF9wcm9wb3NhbF9yZXF1aXNpdGlvbnMnLCAncmVxdWVzdF9wcm9wb3NhbF9yZXF1aXNpdGlvbnMucmVxdWVzdF9wcm9wb3NhbF9pZCcsICc9JywgJ3JlcXVlc3RfcHJvcG9zYWxzLmlkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3JlcXVlc3RfcHJvcG9zYWxzLmlkJywgJ3F1b3RhdGlvbnMucmVxdWVzdF9wcm9wb3NhbF9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdwcm9kdWN0cycsIGZ1bmN0aW9uICgkcXVvdGF0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRwcm9kdWN0cyA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICAkc2wgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHF1b3RhdGlvbi0+cmVsUmVxdWVzdFByb3Bvc2FsLT5yZXF1ZXN0UHJvcG9zYWxEZXRhaWxzLT5jb3VudCgpID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yZWFjaCAoJHF1b3RhdGlvbi0+cmVsUmVxdWVzdFByb3Bvc2FsLT5yZXF1ZXN0UHJvcG9zYWxEZXRhaWxzIGFzICRrZXkgPT4gJHByb2R1Y3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNzZXQoJHByb2R1Y3QtPnByb2R1Y3QtPm5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzbCsrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcHJvZHVjdHMgLj0gKCRzbCA+IDEgPyAnLCAnIDogJycpIC4gJHByb2R1Y3QtPnByb2R1Y3QtPm5hbWUgLiAnICcgLiBnZXRQcm9kdWN0QXR0cmlidXRlc0Zhc3RlcigkcHJvZHVjdC0+cHJvZHVjdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHByb2R1Y3RzOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3Byb2R1Y3RzJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxSZXF1ZXN0UHJvcG9zYWwucmVxdWVzdFByb3Bvc2FsRGV0YWlscy5wcm9kdWN0JywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPm9yV2hlcmUoZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUmVxdWVzdFByb3Bvc2FsLnJlcXVlc3RQcm9wb3NhbERldGFpbHMucHJvZHVjdC5hdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbicsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+b3JXaGVyZUhhcygncmVsUmVxdWVzdFByb3Bvc2FsLnJlcXVlc3RQcm9wb3NhbERldGFpbHMucHJvZHVjdC5hdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGUnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ3Byb2R1Y3RzJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwbGVhc2VTb3J0TWUoJHF1ZXJ5LCAkb3JkZXIsIFJlcXVlc3RQcm9wb3NhbDo6c2VsZWN0KCdwcm9kdWN0cy5uYW1lJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbigncHJvZHVjdHMnLCAncHJvZHVjdHMuaWQnLCAnPScsICdyZXF1ZXN0X3Byb3Bvc2FsX2RldGFpbHMucHJvZHVjdF9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ3JlcXVlc3RfcHJvcG9zYWxfZGV0YWlscycsICdyZXF1ZXN0X3Byb3Bvc2FsX2RldGFpbHMucmVxdWVzdF9wcm9wb3NhbF9pZCcsICc9JywgJ3JlcXVlc3RfcHJvcG9zYWxzLmlkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbigncmVxdWVzdF9wcm9wb3NhbF9yZXF1aXNpdGlvbnMnLCAncmVxdWVzdF9wcm9wb3NhbF9yZXF1aXNpdGlvbnMucmVxdWVzdF9wcm9wb3NhbF9pZCcsICc9JywgJ3JlcXVlc3RfcHJvcG9zYWxzLmlkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3JlcXVlc3RfcHJvcG9zYWxzLmlkJywgJ3F1b3RhdGlvbnMucmVxdWVzdF9wcm9wb3NhbF9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdzdXBwbGllcnMnLCBmdW5jdGlvbiAoJHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICAkZGF0YSA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHZhbHVlcy0+cmVsU2VsZlF1b3RhdGlvblN1cHBsaWVyQnlQcm9wb3NhbElkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JlYWNoICgkdmFsdWVzLT5yZWxTZWxmUXVvdGF0aW9uU3VwcGxpZXJCeVByb3Bvc2FsSWQtPndoZXJlTm90SW4oJ2lzX2FwcHJvdmVkJywgWydwZW5kaW5nJywgJ2FwcHJvdmVkJywgJ2hhbHQnXSkgYXMgJHN1cHBsaWVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzc2V0KCRzdXBwbGllci0+cmVsU3VwcGxpZXJzLT5uYW1lKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZGF0YSAuPSAnPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1zbSBidG4teHMgbS0xICcgLiAoJHN1cHBsaWVyLT5pc19hcHByb3ZlZCA9PSAnaGFsdCcgPyAnIGJ0bi13YXJuaW5nJyA6ICgkc3VwcGxpZXItPnJlY29tbWVuZGF0aW9uID09ICd5ZXMnID8gJ2J0bi1zdWNjZXNzJyA6ICdidG4tZGFyaycpKSAuICciPicgLiAkc3VwcGxpZXItPnJlbFN1cHBsaWVycy0+bmFtZSAuICcgKCcgLiAkc3VwcGxpZXItPnJlbFN1cHBsaWVycy0+Y29kZSAuICcpPC9idXR0b24+JzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkZGF0YTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdzdXBwbGllcnMnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsU3VwcGxpZXJzJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ3N1cHBsaWVycycsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBTdXBwbGllcnM6OnNlbGVjdCgnc3VwcGxpZXJzLm5hbWUnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbignc3VwcGxpZXJzLmlkJywgJ3F1b3RhdGlvbnMuc3VwcGxpZXJfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT50YWtlKDEpCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignc3RhdHVzJywgZnVuY3Rpb24gKCR2YWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHN0YXR1cyA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICAkYXBwcm92ZWRDb3VudCA9IFF1b3RhdGlvbnM6OndoZXJlKCdyZXF1ZXN0X3Byb3Bvc2FsX2lkJywgJHZhbHVlcy0+cmVxdWVzdF9wcm9wb3NhbF9pZCktPndoZXJlKCdpc19hcHByb3ZlZCcsICdhcHByb3ZlZCcpLT5jb3VudCgpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJGFwcHJvdmVkQ291bnQgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc3RhdHVzIC49ICc8YSBjbGFzcz0iYnRuIGJ0bi14cyBidG4tc3VjY2VzcyI+QXBwcm92ZWQgKCcgLiAkYXBwcm92ZWRDb3VudCAuICcgU3VwcGxpZXIpPC9hPic7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc3RhdHVzIC49ICc8YSBjbGFzcz0iYnRuIGJ0bi14cyBidG4td2FybmluZyI+V2FpdGluZyBmb3IgQXBwcm92YWw8L2E+JzsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRzdGF0dXM7CiAgICAgICAgICAgICAgICAgICAgfSkKCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2FwcHJvdmFscycsIGZ1bmN0aW9uICgkcXVvdGF0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRhcHByb3ZhbHMgPSAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoaXNzZXQoJHF1b3RhdGlvbi0+cmVsUmVxdWVzdFByb3Bvc2FsLT5hcHByb3ZhbHNbMF0pKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRxdW90YXRpb24tPnJlbFJlcXVlc3RQcm9wb3NhbC0+YXBwcm92YWxzIGFzICRrZXkgPT4gJGFwcHJvdmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFwcHJvdmFscyAuPSAnPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi14cyBidG4tJyAuICgkYXBwcm92YWwtPnJlc3BvbnNlID09ICdwZW5kaW5nJyA/ICd3YXJuaW5nJyA6ICgkYXBwcm92YWwtPnJlc3BvbnNlID09ICdhcHByb3ZlZCcgPyAnc3VjY2VzcycgOiAnZGFuZ2VyJykpIC4gJyI+JyAuICRhcHByb3ZhbC0+dXNlci0+bmFtZSAuICcgWycgLiB1Y3dvcmRzKCRhcHByb3ZhbC0+cmVzcG9uc2UpIC4gJ108L2J1dHRvbj4mbmJzcDsnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGFwcHJvdmFsczsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdhcHByb3ZhbHMnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUmVxdWVzdFByb3Bvc2FsLmFwcHJvdmFscy51c2VyJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5vcldoZXJlSGFzKCdyZWxSZXF1ZXN0UHJvcG9zYWwuYXBwcm92YWxzJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdzdGF0dXMnLCAnTElLRScsICclJyAuIHN0cnRvbG93ZXIoJGtleXdvcmQpIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCgogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdhY3Rpb25zJywgZnVuY3Rpb24gKCR2YWx1ZXMpIHVzZSAoJGFwcHJvdmFsUmFuZ2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJG15QXBwcm92YWwgPSAkdmFsdWVzLT5yZWxSZXF1ZXN0UHJvcG9zYWwtPmFwcHJvdmFscy0+d2hlcmVJbigncmVzcG9uc2UnLCBbJ3BlbmRpbmcnLCAnZGVuaWVkJ10pLT53aGVyZSgndXNlcl9pZCcsIGF1dGgoKS0+dXNlcigpLT5pZCktPmZpcnN0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICRhdmFpbGFibGUgPSAoaXNzZXQoJG15QXBwcm92YWwtPmlkKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICRhdmFpbGFibGUgPSAkYXZhaWxhYmxlID8gKCR2YWx1ZXMtPnJlbFJlcXVlc3RQcm9wb3NhbC0+YXBwcm92YWxzLT53aGVyZUluKCdyZXNwb25zZScsIFsncGVuZGluZycsICdkZW5pZWQnXSktPndoZXJlKCdwcmlvcml0eScsICc8JywgJG15QXBwcm92YWwtPnByaW9yaXR5KS0+Y291bnQoKSA9PSAwKSA6IGZhbHNlOwoKICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgPSAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgJGNvdW50ID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzc2V0KCRhcHByb3ZhbFJhbmdlWzBdKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yZWFjaCAoJGFwcHJvdmFsUmFuZ2UgYXMgJHJhbmdlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRyYW5nZS0+bWluX2Ftb3VudCA8PSAkdmFsdWVzLT5yZWxRdW90YXRpb25JdGVtcy0+c3VtKCd0b3RhbF9wcmljZScpICYmICRyYW5nZS0+bWF4X2Ftb3VudCA+PSAkdmFsdWVzLT5yZWxRdW90YXRpb25JdGVtcy0+c3VtKCd0b3RhbF9wcmljZScpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRjb3VudCsrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJGNvdW50ID49IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHZhbHVlcy0+cmVsU2VsZlF1b3RhdGlvblN1cHBsaWVyQnlQcm9wb3NhbElkLT53aGVyZUluKCdpc19hcHByb3ZlZCcsIFsnYXBwcm92ZWQnLCAnaGFsdCddKS0+Y291bnQoKSA9PSAwICYmICRhdmFpbGFibGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxhIGhyZWY9IicgLiByb3V0ZSgncG1zLnF1b3RhdGlvbi5xdW90YXRpb25zLmNzLmNvbXBhcmUudmlldycsIFsnaWQnID0+ICR2YWx1ZXMtPnJlcXVlc3RfcHJvcG9zYWxfaWQsICdzbHVnJyA9PiAnbGlzdCddKSAuICc/dHlwZT1yZnAiICB0aXRsZT0iQ29tcGFyZSBQcm9jZXNzIEFuYWx5c2lzIiAgY2xhc3M9ImJ0biBidG4tc3VjY2VzcyBidG4teHMiPjxpIGNsYXNzPSJsYXMgbGEtbGlzdCI+PC9pPjwvYT4nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxhIHRpdGxlPSJPdXQgb2YgQXBwcm92YWwgUmFuZ2UiICBjbGFzcz0iYnRuIGJ0bi1kYW5nZXIgYnRuLXhzIj48aSBjbGFzcz0ibGFzIGxhLWJhbiI+PC9pPjwvYT4nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCR2YWx1ZXMtPnJlbFNlbGZRdW90YXRpb25TdXBwbGllckJ5UHJvcG9zYWxJZC0+d2hlcmVJbignaXNfYXBwcm92ZWQnLCBbJ2FwcHJvdmVkJywgJ2hhbHQnXSktPmNvdW50KCkgPT0gMCAmJiAkYXZhaWxhYmxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxhIGhyZWY9IicgLiByb3V0ZSgncG1zLnF1b3RhdGlvbi5xdW90YXRpb25zLmNzLmNvbXBhcmUudmlldycsIFsnaWQnID0+ICR2YWx1ZXMtPnJlcXVlc3RfcHJvcG9zYWxfaWQsICdzbHVnJyA9PiAnbGlzdCddKSAuICc/dHlwZT1yZnAiICB0aXRsZT0iQ29tcGFyZSBQcm9jZXNzIEFuYWx5c2lzIiAgY2xhc3M9ImJ0biBidG4tc3VjY2VzcyBidG4teHMiPjxpIGNsYXNzPSJsYXMgbGEtbGlzdCI+PC9pPjwvYT4nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnPGEgdGFyZ2V0PSJfYmxhbmsiIGhyZWY9IicgLiByb3V0ZSgncG1zLnF1b3RhdGlvbi5jcy5oaXN0b3J5JywgJHZhbHVlcy0+cmVxdWVzdF9wcm9wb3NhbF9pZCkgLiAnIiBjbGFzcz0iYnRuIGJ0bi13YXJuaW5nIGJ0bi14cyBtbC0xIiB0aXRsZT0iQ1MgSGlzdG9yeSI+PGkgY2xhc3M9ImxhcyBsYS1oaXN0b3J5Ij48L2k+PC9hPic7CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGFjdGlvbnM7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPnJhd0NvbHVtbnMoWydDU19udW1iZXInLCAncmVxdWlzaXRpb25zJywgJ3N1cHBsaWVycycsICdzdGF0dXMnLCAnYXBwcm92YWxzJywgJ2FjdGlvbnMnXSkKICAgICAgICAgICAgICAgICAgICAtPm1ha2UodHJ1ZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5xdW90YXRpb24uYXBwcm92YWwtaW5kZXgnLCBbCiAgICAgICAgICAgICAgICAndGl0bGUnID0+ICR0aXRsZSwKICAgICAgICAgICAgICAgICdoZWFkZXJDb2x1bW5zJyA9PiAkdGhpcy0+YXBwcm92YWxIZWFkZXJDb2x1bW5zKCkKICAgICAgICAgICAgXSk7CgogICAgICAgIH0gY2F0Y2ggKFxUaHJvd2FibGUgJHRoKSB7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogRGlzcGxheSBhIGxpc3Rpbmcgb2YgdGhlIHJlc291cmNlLgogICAgICoKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCgogICAgcHVibGljIGZ1bmN0aW9uIGVzdGltYXRlQXBwcm92YWxMaXN0KCkKICAgIHsKICAgICAgICAkdGl0bGUgPSAnRXN0aW1hdGUgUmVxdWVzdCBGb3IgQXBwcm92ZWQnOwoKICAgICAgICB0cnkgewogICAgICAgICAgICAkcXVvdGF0aW9ucyA9IFF1b3RhdGlvbnM6OndpdGgoWwogICAgICAgICAgICAgICAgJ3JlbFF1b3RhdGlvbkl0ZW1zJywKICAgICAgICAgICAgICAgICdyZWxSZXF1ZXN0UHJvcG9zYWwnLAogICAgICAgICAgICAgICAgJ3JlbFN1cHBsaWVycycsCiAgICAgICAgICAgICAgICAnZXhjaGFuZ2VSYXRlLmN1cnJlbmN5JywKICAgICAgICAgICAgICAgICdyZWxTZWxmUXVvdGF0aW9uU3VwcGxpZXJCeVByb3Bvc2FsSWQucmVsU3VwcGxpZXJzJwogICAgICAgICAgICBdKQogICAgICAgICAgICAtPndoZW4oIWF1dGgoKS0+dXNlcigpLT5oYXNBbnlSb2xlKFsnUHVyY2hhc2UtRGVwYXJ0bWVudCcsICdBdWRpdCcsICdCaWxsaW5nJywgJ01hbmFnZW1lbnQnLCAnQWNjb3VudHMnLCAnRGVwYXJ0bWVudC1IZWFkJ10pLCBmdW5jdGlvbigkcXVlcnkpewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVlc3RQcm9wb3NhbC5yZXF1ZXN0UHJvcG9zYWxSZXF1aXNpdGlvbi5yZWxSZXF1aXNpdGlvbicsIGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2Fzc2lnbmVkX3VzZXJfaWQnLCBhdXRoKCktPnVzZXIoKS0+aWQpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+d2hlcmVIYXMoJ3JlbFJlcXVlc3RQcm9wb3NhbC5yZXF1ZXN0UHJvcG9zYWxSZXF1aXNpdGlvbi5yZWxSZXF1aXNpdGlvbicsIGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUluKCdocl91bml0X2lkJywgYXV0aCgpLT51c2VyKCktPnByaW9yaXRpZXMtPnBsdWNrKCdocl91bml0X2lkJyktPnRvQXJyYXkoKSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+d2hlcmUoWwogICAgICAgICAgICAgICAgJ3N0YXR1cycgPT4gJ2FjdGl2ZScsCiAgICAgICAgICAgICAgICAnaXNfcG9fZ2VuZXJhdGUnID0+ICdubycsCiAgICAgICAgICAgIF0pCiAgICAgICAgICAgIC0+d2hlcmUoJ2lzX2FwcHJvdmVkJywgJ3Byb2Nlc3NpbmcnKQogICAgICAgICAgICAtPndoZXJlKCd0eXBlJywgJ2RpcmVjdC1wdXJjaGFzZScpOwoKICAgICAgICAgICAgJGFwcHJvdmFsUmFuZ2UgPSBBdXRoOjp1c2VyKCktPnJlbEFwcHJvdmFsUmFuZ2U7CgogICAgICAgICAgICBpZiAocmVxdWVzdCgpLT5hamF4KCkpIHsKICAgICAgICAgICAgICAgICRvcHRpb25zID0gWwogICAgICAgICAgICAgICAgICAgICdNYW5hZ2VtZW50JyA9PiBhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnTWFuYWdlbWVudCcpLAogICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgIHJldHVybiBEYXRhVGFibGVzOjpvZigkcXVvdGF0aW9ucykKICAgICAgICAgICAgICAgICAgICAtPmFkZEluZGV4Q29sdW1uKCkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignQ1NfbnVtYmVyJywgZnVuY3Rpb24gKCR2YWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIGNsYXNzPSJidG4gYnRuLWxpbmsiIG9uY2xpY2s9InJlcXVlc3RQcm9wb3NhbERldGFpbHMoJyAuICR2YWx1ZXMtPnJlbFJlcXVlc3RQcm9wb3NhbC0+aWQgLiAnKSI+JyAuIChpc3NldCgkdmFsdWVzLT5yZWxSZXF1ZXN0UHJvcG9zYWwtPnJlZmVyZW5jZV9ubykgPyAkdmFsdWVzLT5yZWxSZXF1ZXN0UHJvcG9zYWwtPnJlZmVyZW5jZV9ubyA6ICcnKSAuICc8L2E+JzsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdDU19udW1iZXInLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUmVxdWVzdFByb3Bvc2FsJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgncmVmZXJlbmNlX25vJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbignQ1NfbnVtYmVyJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwbGVhc2VTb3J0TWUoJHF1ZXJ5LCAkb3JkZXIsIFJlcXVlc3RQcm9wb3NhbDo6c2VsZWN0KCdyZXF1ZXN0X3Byb3Bvc2Fscy5yZWZlcmVuY2Vfbm8nKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbigncmVxdWVzdF9wcm9wb3NhbHMuaWQnLCAncXVvdGF0aW9ucy5yZXF1ZXN0X3Byb3Bvc2FsX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+dGFrZSgxKQogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0pCgogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdyZXF1aXNpdGlvbnMnLCBmdW5jdGlvbiAoJHF1b3RhdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb25zID0gJyc7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHF1b3RhdGlvbi0+cmVsUmVxdWVzdFByb3Bvc2FsLT5yZXF1ZXN0UHJvcG9zYWxSZXF1aXNpdGlvbi0+Y291bnQoKSA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRxdW90YXRpb24tPnJlbFJlcXVlc3RQcm9wb3NhbC0+cmVxdWVzdFByb3Bvc2FsUmVxdWlzaXRpb24gYXMgJGtleSA9PiAkcmVxdWlzaXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb25zIC49ICgka2V5ID4gMCA/ICcsICcgOiAnJykgLiAnPGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiBkYXRhLXNyYz0iJyAuIHJvdXRlKCdwbXMucmVxdWlzaXRpb24ubGlzdC52aWV3LnNob3cnLCAkcmVxdWlzaXRpb24tPnJlbFJlcXVpc2l0aW9uLT5pZCkgLiAnIiBjbGFzcz0idGV4dC1wcmltYXJ5IHJlcXVpc2l0aW9uIG0tMSByb3VuZGVkIHNob3dSZXF1aXN0aW9uRGV0YWlscyIgb25jbGljaz0icmVxdWlzdGlvbkRldGFpbHMoJCh0aGlzKSkiPicgLiAkcmVxdWlzaXRpb24tPnJlbFJlcXVpc2l0aW9uLT5yZWZlcmVuY2Vfbm8gLiAnPC9hPic7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcmVxdWlzaXRpb25zOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3JlcXVpc2l0aW9ucycsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVlc3RQcm9wb3NhbC5yZXF1ZXN0UHJvcG9zYWxSZXF1aXNpdGlvbi5yZWxSZXF1aXNpdGlvbicsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdyZWZlcmVuY2Vfbm8nLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdyZXF1aXNpdGlvbnMnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgUmVxdWVzdFByb3Bvc2FsOjpzZWxlY3QoJ3JlcXVpc2l0aW9ucy5yZWZlcmVuY2Vfbm8nKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdyZXF1aXNpdGlvbnMnLCAncmVxdWlzaXRpb25zLmlkJywgJz0nLCAncmVxdWVzdF9wcm9wb3NhbF9yZXF1aXNpdGlvbnMucmVxdWlzaXRpb25faWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdyZXF1ZXN0X3Byb3Bvc2FsX3JlcXVpc2l0aW9ucycsICdyZXF1ZXN0X3Byb3Bvc2FsX3JlcXVpc2l0aW9ucy5yZXF1ZXN0X3Byb3Bvc2FsX2lkJywgJz0nLCAncmVxdWVzdF9wcm9wb3NhbHMuaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbigncmVxdWVzdF9wcm9wb3NhbHMuaWQnLCAncXVvdGF0aW9ucy5yZXF1ZXN0X3Byb3Bvc2FsX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+dGFrZSgxKQogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3Byb2R1Y3RzJywgZnVuY3Rpb24gKCRxdW90YXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHByb2R1Y3RzID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgICRzbCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICRhcnJheSA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHF1b3RhdGlvbi0+cmVsUmVxdWVzdFByb3Bvc2FsLT5yZXF1ZXN0UHJvcG9zYWxEZXRhaWxzLT5jb3VudCgpID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yZWFjaCAoJHF1b3RhdGlvbi0+cmVsUmVxdWVzdFByb3Bvc2FsLT5yZXF1ZXN0UHJvcG9zYWxEZXRhaWxzIGFzICRrZXkgPT4gJHByb2R1Y3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNzZXQoJHByb2R1Y3QtPnByb2R1Y3QtPmlkKSAmJiAhaW5fYXJyYXkoJHByb2R1Y3QtPnByb2R1Y3QtPmlkLCAkYXJyYXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzbCsrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcHJvZHVjdHMgLj0gKCRzbCA+IDEgPyAnLCAnIDogJycpIC4gJHByb2R1Y3QtPnByb2R1Y3QtPm5hbWUgLiAnICcgLiBnZXRQcm9kdWN0QXR0cmlidXRlc0Zhc3RlcigkcHJvZHVjdC0+cHJvZHVjdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5X3B1c2goJGFycmF5LCAkcHJvZHVjdC0+cHJvZHVjdC0+aWQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRwcm9kdWN0czsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdwcm9kdWN0cycsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUmVxdWVzdFByb3Bvc2FsLnJlcXVlc3RQcm9wb3NhbERldGFpbHMucHJvZHVjdCcsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPm9yV2hlcmUoZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxSZXF1ZXN0UHJvcG9zYWwucmVxdWVzdFByb3Bvc2FsRGV0YWlscy5wcm9kdWN0LmF0dHJpYnV0ZXMuYXR0cmlidXRlT3B0aW9uJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5vcldoZXJlSGFzKCdyZWxSZXF1ZXN0UHJvcG9zYWwucmVxdWVzdFByb3Bvc2FsRGV0YWlscy5wcm9kdWN0LmF0dHJpYnV0ZXMuYXR0cmlidXRlT3B0aW9uLmF0dHJpYnV0ZScsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbigncHJvZHVjdHMnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgUmVxdWVzdFByb3Bvc2FsOjpzZWxlY3QoJ3Byb2R1Y3RzLm5hbWUnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdwcm9kdWN0cycsICdwcm9kdWN0cy5pZCcsICc9JywgJ3JlcXVlc3RfcHJvcG9zYWxfZGV0YWlscy5wcm9kdWN0X2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbigncmVxdWVzdF9wcm9wb3NhbF9kZXRhaWxzJywgJ3JlcXVlc3RfcHJvcG9zYWxfZGV0YWlscy5yZXF1ZXN0X3Byb3Bvc2FsX2lkJywgJz0nLCAncmVxdWVzdF9wcm9wb3NhbHMuaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdyZXF1ZXN0X3Byb3Bvc2FsX3JlcXVpc2l0aW9ucycsICdyZXF1ZXN0X3Byb3Bvc2FsX3JlcXVpc2l0aW9ucy5yZXF1ZXN0X3Byb3Bvc2FsX2lkJywgJz0nLCAncmVxdWVzdF9wcm9wb3NhbHMuaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbigncmVxdWVzdF9wcm9wb3NhbHMuaWQnLCAncXVvdGF0aW9ucy5yZXF1ZXN0X3Byb3Bvc2FsX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+dGFrZSgxKQogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3N1cHBsaWVycycsIGZ1bmN0aW9uICgkcXVvdGF0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRzdXBwbGllcnMgPSAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yZWFjaCAoY29sbGVjdCgkcXVvdGF0aW9uLT5yZWxTZWxmUXVvdGF0aW9uU3VwcGxpZXJCeVByb3Bvc2FsSWQpIGFzICRrZXkgPT4gJHN1cHBsaWVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNzZXQoJHN1cHBsaWVyLT5yZWxTdXBwbGllcnMtPmlkKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzdXBwbGllcnMgLj0gJzxidXR0b24gY2xhc3M9ImJ0biBidG4teHMgYnRuLScgLiAoJHN1cHBsaWVyLT5yZWNvbW1lbmRhdGlvbiA9PSAneWVzJyA/ICdzdWNjZXNzJyA6ICdwcmltYXJ5JykgLiAnIj4nIC4gJHN1cHBsaWVyLT5yZWxTdXBwbGllcnMtPm5hbWUgLiAnICgnIC4gJHN1cHBsaWVyLT5yZWxTdXBwbGllcnMtPmNvZGUgLiAnKSBbJyAuIHVjd29yZHMoJHN1cHBsaWVyLT5pc19hcHByb3ZlZCkgLiAnXTwvYnV0dG9uPiZuYnNwOyc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRzdXBwbGllcnM7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbignc3VwcGxpZXJzJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFNlbGZRdW90YXRpb25TdXBwbGllckJ5UHJvcG9zYWxJZCcsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSW4oJ2lzX2FwcHJvdmVkJywgKGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdQdXJjaGFzZS1EZXBhcnRtZW50JykgPyBbJ3BlbmRpbmcnLCAncHJlLXByb2Nlc3NpbmcnXSA6IFsncGVuZGluZycsICdwcmUtcHJvY2Vzc2luZyddKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlSGFzKCdyZWxTZWxmUXVvdGF0aW9uU3VwcGxpZXJCeVByb3Bvc2FsSWQucmVsU3VwcGxpZXJzJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5vcldoZXJlKCdjb2RlJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ3N1cHBsaWVycycsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBTdXBwbGllcnM6OnNlbGVjdCgnc3VwcGxpZXJzLm5hbWUnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbignc3VwcGxpZXJzLmlkJywgJ3F1b3RhdGlvbnMuc3VwcGxpZXJfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT50YWtlKDEpCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfSkKCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2FwcHJvdmFscycsIGZ1bmN0aW9uICgkcXVvdGF0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRhcHByb3ZhbHMgPSAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoaXNzZXQoJHF1b3RhdGlvbi0+cmVsUmVxdWVzdFByb3Bvc2FsLT5hcHByb3ZhbHNbMF0pKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRxdW90YXRpb24tPnJlbFJlcXVlc3RQcm9wb3NhbC0+YXBwcm92YWxzIGFzICRrZXkgPT4gJGFwcHJvdmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFwcHJvdmFscyAuPSAnPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi14cyBidG4tJyAuICgkYXBwcm92YWwtPnJlc3BvbnNlID09ICdwZW5kaW5nJyA/ICd3YXJuaW5nJyA6ICgkYXBwcm92YWwtPnJlc3BvbnNlID09ICdhcHByb3ZlZCcgPyAnc3VjY2VzcycgOiAnZGFuZ2VyJykpIC4gJyI+JyAuICRhcHByb3ZhbC0+dXNlci0+bmFtZSAuICcgWycgLiB1Y3dvcmRzKCRhcHByb3ZhbC0+cmVzcG9uc2UpIC4gJ108L2J1dHRvbj4mbmJzcDsnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGFwcHJvdmFsczsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdhcHByb3ZhbHMnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUmVxdWVzdFByb3Bvc2FsLmFwcHJvdmFscy51c2VyJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5vcldoZXJlSGFzKCdyZWxSZXF1ZXN0UHJvcG9zYWwuYXBwcm92YWxzJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdzdGF0dXMnLCAnTElLRScsICclJyAuIHN0cnRvbG93ZXIoJGtleXdvcmQpIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgCgogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdzdGF0dXMnLCBmdW5jdGlvbiAoJHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICAkc3RhdHVzID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgICRhcHByb3ZlZENvdW50ID0gUXVvdGF0aW9uczo6d2hlcmUoJ3JlcXVlc3RfcHJvcG9zYWxfaWQnLCAkdmFsdWVzLT5yZXF1ZXN0X3Byb3Bvc2FsX2lkKS0+d2hlcmUoJ2lzX2FwcHJvdmVkJywgJ2FwcHJvdmVkJyktPmNvdW50KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkYXBwcm92ZWRDb3VudCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzdGF0dXMgLj0gJzxhIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi1zdWNjZXNzIj5BcHByb3ZlZCBPbmNlPC9hPic7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc3RhdHVzIC49ICc8YSBjbGFzcz0iYnRuIGJ0bi14cyBidG4td2FybmluZyI+V2FpdGluZyBmb3IgQXBwcm92YWw8L2E+JzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHN0YXR1czsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdhY3Rpb25zJywgZnVuY3Rpb24gKCR2YWx1ZXMpIHVzZSAoJGFwcHJvdmFsUmFuZ2UsICRvcHRpb25zKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAkbXlBcHByb3ZhbCA9ICR2YWx1ZXMtPnJlbFJlcXVlc3RQcm9wb3NhbC0+YXBwcm92YWxzLT53aGVyZUluKCdyZXNwb25zZScsIFsncGVuZGluZycsICdkZW5pZWQnXSktPndoZXJlKCd1c2VyX2lkJywgYXV0aCgpLT51c2VyKCktPmlkKS0+Zmlyc3QoKTsKICAgICAgICAgICAgICAgICAgICAgICAgJGF2YWlsYWJsZSA9IChpc3NldCgkbXlBcHByb3ZhbC0+aWQpKTsKICAgICAgICAgICAgICAgICAgICAgICAgJGF2YWlsYWJsZSA9ICRhdmFpbGFibGUgPyAoJHZhbHVlcy0+cmVsUmVxdWVzdFByb3Bvc2FsLT5hcHByb3ZhbHMtPndoZXJlSW4oJ3Jlc3BvbnNlJywgWydwZW5kaW5nJywgJ2RlbmllZCddKS0+d2hlcmUoJ3ByaW9yaXR5JywgJzwnLCAkbXlBcHByb3ZhbC0+cHJpb3JpdHkpLT5jb3VudCgpID09IDApIDogZmFsc2U7CgogICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICAkY291bnQgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNzZXQoJGFwcHJvdmFsUmFuZ2VbMF0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JlYWNoICgkYXBwcm92YWxSYW5nZSBhcyAkcmFuZ2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHJhbmdlLT5taW5fYW1vdW50IDw9ICR2YWx1ZXMtPnJlbFF1b3RhdGlvbkl0ZW1zLT5zdW0oJ3RvdGFsX3ByaWNlJykgJiYgJHJhbmdlLT5tYXhfYW1vdW50ID49ICR2YWx1ZXMtPnJlbFF1b3RhdGlvbkl0ZW1zLT5zdW0oJ3RvdGFsX3ByaWNlJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGNvdW50Kys7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkY291bnQgPj0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmICgkb3B0aW9uc1snTWFuYWdlbWVudCddICYmICRhdmFpbGFibGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJGF2YWlsYWJsZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnPGEgaHJlZj0iJyAuIHJvdXRlKCdwbXMucXVvdGF0aW9uLnF1b3RhdGlvbnMuY3MuY29tcGFyZS52aWV3JywgWydpZCcgPT4gJHZhbHVlcy0+cmVxdWVzdF9wcm9wb3NhbF9pZCwgJ3NsdWcnID0+ICdsaXN0J10pIC4gJz90eXBlPWRpcmVjdC1wdXJjaGFzZSIgIHRpdGxlPSJDb21wYXJlIFByb2Nlc3MgQW5hbHlzaXMiICBjbGFzcz0iYnRuIGJ0bi1zdWNjZXNzIGJ0bi14cyI+PGkgY2xhc3M9ImxhcyBsYS1saXN0Ij48L2k+PC9hPic7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnPGEgdGl0bGU9Ik91dCBvZiBBcHByb3ZhbCBSYW5nZSIgIGNsYXNzPSJidG4gYnRuLWRhbmdlciBidG4teHMiPjxpIGNsYXNzPSJsYXMgbGEtYmFuIj48L2k+PC9hPic7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiAoJG9wdGlvbnNbJ01hbmFnZW1lbnQnXSAmJiAkYXZhaWxhYmxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJGF2YWlsYWJsZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICc8YSBocmVmPSInIC4gcm91dGUoJ3Btcy5xdW90YXRpb24ucXVvdGF0aW9ucy5jcy5jb21wYXJlLnZpZXcnLCBbJ2lkJyA9PiAkdmFsdWVzLT5yZXF1ZXN0X3Byb3Bvc2FsX2lkLCAnc2x1ZycgPT4gJ2xpc3QnXSkgLiAnP3R5cGU9ZGlyZWN0LXB1cmNoYXNlIiAgdGl0bGU9IkNvbXBhcmUgUHJvY2VzcyBBbmFseXNpcyIgIGNsYXNzPSJidG4gYnRuLXN1Y2Nlc3MgYnRuLXhzIj48aSBjbGFzcz0ibGFzIGxhLWxpc3QiPjwvaT48L2E+JzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxhIHRhcmdldD0iX19ibGFuayIgaHJlZj0iJyAuIHJvdXRlKCdwbXMucXVvdGF0aW9uLmNzLmhpc3RvcnknLCAkdmFsdWVzLT5yZXF1ZXN0X3Byb3Bvc2FsX2lkKSAuICciIGNsYXNzPSJidG4gYnRuLXdhcm5pbmcgYnRuLXhzIG1sLTEiIHRpdGxlPSIgQ1MgSGlzdG9yeSI+PGkgY2xhc3M9ImxhcyBsYS1oaXN0b3J5Ij48L2k+PC9hPic7CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGFjdGlvbnM7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPnJhd0NvbHVtbnMoWydDU19udW1iZXInLCAnc3VwcGxpZXJzJywgJ3N0YXR1cycsICdhY3Rpb25zJywgJ3JlcXVpc2l0aW9ucycsICdwcm9kdWN0cycsICdhcHByb3ZhbHMnXSkKICAgICAgICAgICAgICAgICAgICAtPm1ha2UodHJ1ZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5xdW90YXRpb24uZXN0aW1hdGUtaW5kZXgnLCBbJ3RpdGxlJyA9PiAkdGl0bGUsICdoZWFkZXJDb2x1bW5zJyA9PiAkdGhpcy0+YXBwcm92YWxIZWFkZXJDb2x1bW5zKCldKTsKCiAgICAgICAgfSBjYXRjaCAoXFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBEaXNwbGF5IGEgbGlzdGluZyBvZiB0aGUgcmVzb3VyY2UuCiAgICAgKgogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KCiAgICBwdWJsaWMgZnVuY3Rpb24gY29tcGFyZVZpZXcoJGlkLCAkc2x1ZykKICAgIHsKICAgICAgICBpZihyZXF1ZXN0KCktPmhhcygnZ2V0LXByb2R1Y3QtbG9ncycpKXsKICAgICAgICAgICAgJGFwcHJvdmFscyA9IFJlcXVlc3RQcm9wb3NhbEFwcHJvdmFsOjp3aXRoKFsKICAgICAgICAgICAgICAgICd1c2VyJwogICAgICAgICAgICBdKQogICAgICAgICAgICAtPndoZXJlKCdyZXF1ZXN0X3Byb3Bvc2FsX2lkJywgcmVxdWVzdCgpLT5nZXQoJ3JlcXVlc3RfcHJvcG9zYWxfaWQnKSkKICAgICAgICAgICAgLT53aGVyZUluKCdyZXNwb25zZScsIFsnYXBwcm92ZWQnLCAnZGVuaWVkJ10pCiAgICAgICAgICAgIC0+Z2V0KCk7CiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5xdW90YXRpb24ubG9ncycsIFsKICAgICAgICAgICAgICAgICdhcHByb3ZhbHMnID0+ICRhcHByb3ZhbHMsCiAgICAgICAgICAgICAgICAnc3VwcGxpZXJzJyA9PiBTdXBwbGllcnM6OndoZXJlSGFzKCdyZWxRdW90YXRpb25zJywgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgncmVxdWVzdF9wcm9wb3NhbF9pZCcsIHJlcXVlc3QoKS0+Z2V0KCdyZXF1ZXN0X3Byb3Bvc2FsX2lkJykpOwogICAgICAgICAgICAgICAgfSktPmdldCgpLAogICAgICAgICAgICAgICAgJ3VpZCcgPT4gcmVxdWVzdCgpLT5nZXQoJ3VpZCcpCiAgICAgICAgICAgIF0pOwogICAgICAgIH0KCiAgICAgICAgJHRpdGxlID0gJ1F1b3RhdGlvbnMgQ29tcGFyZSBBbmFseXNpcyc7CiAgICAgICAgJHJlcXVlc3RQcm9wb3NhbElkID0gJGlkOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgICRxdW90YXRpb25zID0gUXVvdGF0aW9uczo6d2l0aChbCiAgICAgICAgICAgICAgICAncmVsUmVxdWVzdFByb3Bvc2FsLmNyZWF0ZWRCeScsCiAgICAgICAgICAgICAgICAncmVsU3VwcGxpZXJzLlN1cHBsaWVyUmF0aW5ncycsCiAgICAgICAgICAgICAgICAnZXhjaGFuZ2VSYXRlLmN1cnJlbmN5JywKICAgICAgICAgICAgICAgICdyZWxTdXBwbGllcnMnLAogICAgICAgICAgICAgICAgJ3JlbFF1b3RhdGlvbkl0ZW1zLnJlbFByb2R1Y3QuY2F0ZWdvcnkuY2F0ZWdvcnknLAogICAgICAgICAgICAgICAgJ3JlbFF1b3RhdGlvbkl0ZW1zLnJlbFByb2R1Y3QucHJvZHVjdFVuaXQnLAogICAgICAgICAgICAgICAgJ3JlbFF1b3RhdGlvbkl0ZW1zLnJlbFByb2R1Y3QuYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24uYXR0cmlidXRlJywKICAgICAgICAgICAgXSkKICAgICAgICAgICAgLT53aGVyZShbCiAgICAgICAgICAgICAgICAnc3RhdHVzJyA9PiAnYWN0aXZlJywKICAgICAgICAgICAgICAgICdyZXF1ZXN0X3Byb3Bvc2FsX2lkJyA9PiAkaWQKICAgICAgICAgICAgXSkKICAgICAgICAgICAgLT53aGVyZUluKCdpc19hcHByb3ZlZCcsIFsncHJvY2Vzc2luZycsICdoYWx0J10pCiAgICAgICAgICAgIC0+b3JkZXJieSgnZ3Jvc3NfcHJpY2UnLCAnYXNjJykKICAgICAgICAgICAgLT5nZXQoKTsKCiAgICAgICAgICAgICRyZXF1aXNpdGlvbkl0ZW1zID0gUmVxdWlzaXRpb25JdGVtOjp3aXRoKFsKICAgICAgICAgICAgICAgICdhdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGUnCiAgICAgICAgICAgIF0pCiAgICAgICAgICAgIC0+d2hlcmVIYXMoJ3JlcXVpc2l0aW9uLnJlcXVlc3RQcm9wb3NhbFJlcXVpc2l0aW9uJywgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJHJlcXVlc3RQcm9wb3NhbElkKXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdyZXF1ZXN0X3Byb3Bvc2FsX2lkJywgJHJlcXVlc3RQcm9wb3NhbElkKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT5nZXQoKTsKCiAgICAgICAgICAgICRzeXN0ZW1DdXJyZW5jeSA9IHN5c3RlbUN1cnJlbmN5KCk7CgogICAgICAgICAgICBpZiAoJHNsdWcgPT0gJ2xpc3QnKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMucXVvdGF0aW9uLl9jb21wYXJlX3ZpZXdfbGlzdCcsIGNvbXBhY3QoJ3RpdGxlJywgJ3F1b3RhdGlvbnMnLCAncmVxdWVzdFByb3Bvc2FsSWQnLCAnc3lzdGVtQ3VycmVuY3knLCAncmVxdWlzaXRpb25JdGVtcycpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5xdW90YXRpb24uX2NvbXBhcmVfdmlld19ncmlkJywgY29tcGFjdCgndGl0bGUnLCAncXVvdGF0aW9ucycsICdyZXF1ZXN0UHJvcG9zYWxJZCcsICdyZXF1aXNpdGlvbkl0ZW1zJykpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoXFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBEaXNwbGF5IGEgbGlzdGluZyBvZiB0aGUgcmVzb3VyY2UuCiAgICAgKgogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KCiAgICBwdWJsaWMgZnVuY3Rpb24gY29tcGFyZVZpZXdOb3RpZmljYXRpb24oJGlkKQogICAgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgICRxdW90YXRpb25zID0gUXVvdGF0aW9uczo6d2l0aChbCiAgICAgICAgICAgICAgICAncmVsUmVxdWVzdFByb3Bvc2FsLmNyZWF0ZWRCeScsCiAgICAgICAgICAgICAgICAncmVsU3VwcGxpZXJzLlN1cHBsaWVyUmF0aW5ncycsCiAgICAgICAgICAgICAgICAnZXhjaGFuZ2VSYXRlLmN1cnJlbmN5JywKICAgICAgICAgICAgICAgICdyZWxRdW90YXRpb25JdGVtcy5yZWxQcm9kdWN0LnByb2R1Y3RVbml0JywKICAgICAgICAgICAgICAgICdyZWxRdW90YXRpb25JdGVtcy5yZWxQcm9kdWN0LmNhdGVnb3J5LmNhdGVnb3J5JywKICAgICAgICAgICAgICAgICdyZWxRdW90YXRpb25JdGVtcy5yZWxQcm9kdWN0LmF0dHJpYnV0ZXMuYXR0cmlidXRlT3B0aW9uLmF0dHJpYnV0ZScsCiAgICAgICAgICAgIF0pLT53aGVyZShbCiAgICAgICAgICAgICAgICAnc3RhdHVzJyA9PiAnYWN0aXZlJywKICAgICAgICAgICAgICAgICdyZXF1ZXN0X3Byb3Bvc2FsX2lkJyA9PiAkaWQKICAgICAgICAgICAgXSkKICAgICAgICAgICAgICAgIC0+d2hlcmVOb3RJbignaXNfYXBwcm92ZWQnLCBbJ3BlbmRpbmcnXSkKICAgICAgICAgICAgICAgIC0+b3JkZXJieSgnZ3Jvc3NfcHJpY2UnLCAnYXNjJyktPmdldCgpOwoKICAgICAgICAgICAgJHN5c3RlbUN1cnJlbmN5ID0gc3lzdGVtQ3VycmVuY3koKTsKCiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5xdW90YXRpb24uX2NvbXBhcmVfdmlld19saXN0X25vdGlmaWNhdGlvbicsIGNvbXBhY3QoJ3F1b3RhdGlvbnMnLCAnc3lzdGVtQ3VycmVuY3knKSk7CiAgICAgICAgfSBjYXRjaCAoXFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgcmV0dXJuICR0aC0+Z2V0TWVzc2FnZSgpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIERpc3BsYXkgYSBsaXN0aW5nIG9mIHRoZSByZXNvdXJjZS4KICAgICAqCiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwoKICAgIHB1YmxpYyBmdW5jdGlvbiBjb21wYXJlVmlld1BkZlZpZXcoJGlkKQogICAgewogICAgICAgIGlmKHJlcXVlc3QoKS0+aGFzKCdnZXQtcHJvZHVjdC1sb2dzJykpewogICAgICAgICAgICAkYXBwcm92YWxzID0gUmVxdWVzdFByb3Bvc2FsQXBwcm92YWw6OndpdGgoWwogICAgICAgICAgICAgICAgJ3VzZXInCiAgICAgICAgICAgIF0pCiAgICAgICAgICAgIC0+d2hlcmUoJ3JlcXVlc3RfcHJvcG9zYWxfaWQnLCByZXF1ZXN0KCktPmdldCgncmVxdWVzdF9wcm9wb3NhbF9pZCcpKQogICAgICAgICAgICAtPndoZXJlSW4oJ3Jlc3BvbnNlJywgWydhcHByb3ZlZCcsICdkZW5pZWQnXSkKICAgICAgICAgICAgLT5nZXQoKTsKICAgICAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnF1b3RhdGlvbi5sb2dzJywgWwogICAgICAgICAgICAgICAgJ2FwcHJvdmFscycgPT4gJGFwcHJvdmFscywKICAgICAgICAgICAgICAgICdzdXBwbGllcnMnID0+IFN1cHBsaWVyczo6d2hlcmVIYXMoJ3JlbFF1b3RhdGlvbnMnLCBmdW5jdGlvbigkcXVlcnkpewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdyZXF1ZXN0X3Byb3Bvc2FsX2lkJywgcmVxdWVzdCgpLT5nZXQoJ3JlcXVlc3RfcHJvcG9zYWxfaWQnKSk7CiAgICAgICAgICAgICAgICB9KS0+Z2V0KCksCiAgICAgICAgICAgICAgICAndWlkJyA9PiByZXF1ZXN0KCktPmdldCgndWlkJykKICAgICAgICAgICAgXSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHRyeSB7CiAgICAgICAgICAgICRxdW90YXRpb25zID0gUXVvdGF0aW9uczo6d2l0aChbCiAgICAgICAgICAgICAgICAncmVsUmVxdWVzdFByb3Bvc2FsLmNyZWF0ZWRCeScsCiAgICAgICAgICAgICAgICAncmVsU3VwcGxpZXJzLlN1cHBsaWVyUmF0aW5ncycsCiAgICAgICAgICAgICAgICAnZXhjaGFuZ2VSYXRlLmN1cnJlbmN5JywKICAgICAgICAgICAgICAgICdyZWxRdW90YXRpb25JdGVtcy5yZWxQcm9kdWN0LnByb2R1Y3RVbml0JywKICAgICAgICAgICAgICAgICdyZWxRdW90YXRpb25JdGVtcy5yZWxQcm9kdWN0LmNhdGVnb3J5LmNhdGVnb3J5JywKICAgICAgICAgICAgICAgICdyZWxRdW90YXRpb25JdGVtcy5yZWxQcm9kdWN0LmF0dHJpYnV0ZXMuYXR0cmlidXRlT3B0aW9uLmF0dHJpYnV0ZScsCiAgICAgICAgICAgICAgICAncmVsUmVxdWVzdFByb3Bvc2FsLmFwcHJvdmFscy51c2VyJwogICAgICAgICAgICBdKS0+d2hlcmUoWwogICAgICAgICAgICAgICAgJ3N0YXR1cycgPT4gJ2FjdGl2ZScsCiAgICAgICAgICAgICAgICAncmVxdWVzdF9wcm9wb3NhbF9pZCcgPT4gJGlkCiAgICAgICAgICAgIF0pCiAgICAgICAgICAgIC0+d2hlcmVOb3RJbignaXNfYXBwcm92ZWQnLCBbJ3BlbmRpbmcnXSkKICAgICAgICAgICAgLT5vcmRlcmJ5KCdncm9zc19wcmljZScsICdhc2MnKQogICAgICAgICAgICAtPmdldCgpOwoKICAgICAgICAgICAgJHJlcXVpc2l0aW9uSXRlbXMgPSBSZXF1aXNpdGlvbkl0ZW06OndpdGgoWwogICAgICAgICAgICAgICAgJ2F0dHJpYnV0ZXMuYXR0cmlidXRlT3B0aW9uLmF0dHJpYnV0ZScKICAgICAgICAgICAgXSkKICAgICAgICAgICAgLT53aGVyZUhhcygncmVxdWlzaXRpb24ucmVxdWVzdFByb3Bvc2FsUmVxdWlzaXRpb24nLCBmdW5jdGlvbigkcXVlcnkpIHVzZSgkaWQpewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ3JlcXVlc3RfcHJvcG9zYWxfaWQnLCAkaWQpOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPmdldCgpOwoKICAgICAgICAgICAgJHN5c3RlbUN1cnJlbmN5ID0gc3lzdGVtQ3VycmVuY3koKTsKCiAgICAgICAgICAgICRxdW90YXRpb25JbmZvID0gW107CiAgICAgICAgICAgIGlmIChpc3NldCgkcXVvdGF0aW9uc1swXSkpIHsKICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRxdW90YXRpb25zIGFzICRxdW90YXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAkaXRlbXMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAkcV9zdCA9IDA7CiAgICAgICAgICAgICAgICAgICAgJHFfZXN0ID0gMDsKICAgICAgICAgICAgICAgICAgICAkcV9kID0gMDsKICAgICAgICAgICAgICAgICAgICAkcV9lZCA9IDA7CiAgICAgICAgICAgICAgICAgICAgJHFfdiA9IDA7CiAgICAgICAgICAgICAgICAgICAgJHFfdl9leCA9IDA7CiAgICAgICAgICAgICAgICAgICAgJHFfZXYgPSAwOwogICAgICAgICAgICAgICAgICAgICRxX2V2X2V4ID0gMDsKICAgICAgICAgICAgICAgICAgICAkdGhpc0V4Y2hhbmdlUmF0ZSA9IGV4Y2hhbmdlUmF0ZSgkcXVvdGF0aW9uLT5leGNoYW5nZVJhdGUsICRzeXN0ZW1DdXJyZW5jeS0+aWQpOwogICAgICAgICAgICAgICAgICAgIGlmIChpc3NldCgkcXVvdGF0aW9uLT5yZWxRdW90YXRpb25JdGVtc1swXSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yZWFjaCAoJHF1b3RhdGlvbi0+cmVsUXVvdGF0aW9uSXRlbXMgYXMgJGl0ZW0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzdCA9ICRpdGVtLT5hcHByb3ZlZF9xdHkgKiAkaXRlbS0+dW5pdF9wcmljZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRlc3QgPSAkc3QgKiAkdGhpc0V4Y2hhbmdlUmF0ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZCA9ICRzdCA+IDAgJiYgJGl0ZW0tPmRpc2NvdW50ID4gMCA/ICRzdCAqICgkaXRlbS0+ZGlzY291bnQgLyAxMDApIDogMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRlZCA9ICRkICogJHRoaXNFeGNoYW5nZVJhdGU7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFmdGVyID0gJHN0IC0gJGQ7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHYgPSAkaXRlbS0+dmF0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV2ID0gJHYgKiAkdGhpc0V4Y2hhbmdlUmF0ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcV9zdCArPSAkc3Q7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcV9lc3QgKz0gJGVzdDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxX2QgKz0gJGQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcV9lZCArPSAkZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcV92ICs9ICR2OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHFfdl9leCArPSAoJGl0ZW0tPnZhdF90eXBlID09ICdleGNsdXNpdmUnID8gJHYgOiAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxX2V2ICs9ICRldjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxX2V2X2V4ICs9ICgkaXRlbS0+dmF0X3R5cGUgPT0gJ2V4Y2x1c2l2ZScgPyAkZXYgOiAwKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkaXRlbXNbJGl0ZW0tPnVpZF0gPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2FwcHJvdmVkX3F0eScgPT4gJGl0ZW0tPmFwcHJvdmVkX3F0eSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAndW5pdF9wcmljZScgPT4gJGl0ZW0tPnVuaXRfcHJpY2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3N1Yl90b3RhbCcgPT4gJHN0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdleGNoYW5nZV9zdWJfdG90YWwnID0+ICRlc3QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAkcXVvdGF0aW9uSW5mb1skcXVvdGF0aW9uLT5pZF0gPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICdpdGVtcycgPT4gJGl0ZW1zLAogICAgICAgICAgICAgICAgICAgICAgICAnc3ViX3RvdGFsJyA9PiAkcV9zdCwKICAgICAgICAgICAgICAgICAgICAgICAgJ2V4Y2hhbmdlX3N1Yl90b3RhbCcgPT4gJHFfZXN0LAogICAgICAgICAgICAgICAgICAgICAgICAnZGlzY291bnQnID0+ICRxX2QsCiAgICAgICAgICAgICAgICAgICAgICAgICdleGNoYW5nZV9kaXNjb3VudCcgPT4gJHFfZWQsCiAgICAgICAgICAgICAgICAgICAgICAgICd2YXQnID0+ICRxX3YsCiAgICAgICAgICAgICAgICAgICAgICAgICdleGNoYW5nZV92YXQnID0+ICRxX2V2LAogICAgICAgICAgICAgICAgICAgICAgICAnZ3Jvc3MnID0+ICRxX3N0IC0gJHFfZCArICRxX3ZfZXgsCiAgICAgICAgICAgICAgICAgICAgICAgICdleGNoYW5nZV9ncm9zcycgPT4gJHFfZXN0IC0gJHFfZWQgKyAkcV9ldl9leCwKICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAkdGl0bGUgPSAiQ1MgVmlldyI7CiAgICAgICAgICAgICRwdXJjaGFzZU9yZGVySWQgPSAkaWQ7CgogICAgICAgICAgICBpZiAocmVxdWVzdCgpLT5oYXMoJ2Rvd25sb2FkcGRmJykpIHsKICAgICAgICAgICAgICAgIHJldHVybiB2aWV3TVBERigncG1zLmJhY2tlbmQucGFnZXMucXVvdGF0aW9uLmNvbXBhcmVfdmlld19saXN0X3BkZl9kb3dubG9hZCcsIFsKICAgICAgICAgICAgICAgICAgICAndGl0bGUnID0+ICR0aXRsZSwKICAgICAgICAgICAgICAgICAgICAncXVvdGF0aW9ucycgPT4gJHF1b3RhdGlvbnMsCiAgICAgICAgICAgICAgICAgICAgJ3N5c3RlbUN1cnJlbmN5JyA9PiAkc3lzdGVtQ3VycmVuY3ksCiAgICAgICAgICAgICAgICAgICAgJ3F1b3RhdGlvbkluZm8nID0+ICRxdW90YXRpb25JbmZvLAogICAgICAgICAgICAgICAgICAgICdyZXF1aXNpdGlvbkl0ZW1zJyA9PiAkcmVxdWlzaXRpb25JdGVtcwogICAgICAgICAgICAgICAgXSwgJHRpdGxlLCAkdGl0bGUsICdhMycsICdMJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5xdW90YXRpb24uY29tcGFyZV92aWV3X2xpc3RfcGRmJywgY29tcGFjdCgncXVvdGF0aW9ucycsICdzeXN0ZW1DdXJyZW5jeScsICd0aXRsZScsICdwdXJjaGFzZU9yZGVySWQnLCAncXVvdGF0aW9uSW5mbycsICdyZXF1aXNpdGlvbkl0ZW1zJykpOwogICAgICAgIH0gY2F0Y2ggKFxUaHJvd2FibGUgJHRoKSB7CiAgICAgICAgICAgIHJldHVybiAkdGgtPmdldE1lc3NhZ2UoKTsKICAgICAgICB9CiAgICB9CgoKICAgIC8qKgogICAgICogRGlzcGxheSBhIGxpc3Rpbmcgb2YgdGhlIHJlc291cmNlLgogICAgICoKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxKc29uUmVzcG9uc2UKICAgICAqLwoKICAgIHB1YmxpYyBmdW5jdGlvbiBhcHByb3ZlZChSZXF1ZXN0ICRyZXF1ZXN0KQogICAgewogICAgICAgICRpdGVtcyA9IGFycmF5X2tleXMoY29sbGVjdCgkcmVxdWVzdC0+aXRlbV9xdWFudGl0aWVzKS0+ZmlsdGVyKGZ1bmN0aW9uIChpbnQgJHZhbHVlLCBpbnQgJGtleSkgewogICAgICAgICAgICByZXR1cm4gJHZhbHVlID4gMDsKICAgICAgICB9KS0+YWxsKCkpOwoKICAgICAgICBEQjo6YmVnaW5UcmFuc2FjdGlvbigpOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgICRwcm9wb3NhbCA9IFJlcXVlc3RQcm9wb3NhbDo6d2l0aChbCiAgICAgICAgICAgICAgICAncmVxdWVzdFByb3Bvc2FsRGV0YWlscycsICdyZWxRdW90YXRpb25zJwogICAgICAgICAgICBdKQogICAgICAgICAgICAtPmZpbmRPckZhaWwoJHJlcXVlc3QtPnJlcXVlc3RfcHJvcG9zYWxfaWQpOwoKICAgICAgICAgICAgJHF1b3RhdGlvbkl0ZW1zID0gUXVvdGF0aW9uc0l0ZW1zOjp3aXRoKFsKICAgICAgICAgICAgICAgICdyZWxRdW90YXRpb24ucmVsUmVxdWVzdFByb3Bvc2FsJwogICAgICAgICAgICBdKQogICAgICAgICAgICAtPndoZXJlSW4oJ2lkJywgJGl0ZW1zKQogICAgICAgICAgICAtPmdldCgpOwogICAgICAgICAgICAkcXVvdGF0aW9ucyA9IFtdOwogICAgICAgICAgICAkcmVmZXJlbmNlcyA9IFtdOwogICAgICAgICAgICBpZiAoJHF1b3RhdGlvbkl0ZW1zLT5jb3VudCgpID4gMCkgewogICAgICAgICAgICAgICAgZm9yZWFjaCAoJHF1b3RhdGlvbkl0ZW1zIGFzICRrZXkgPT4gJHF1b3RhdGlvbkl0ZW0pIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNzZXQoJHJlcXVlc3QtPml0ZW1fcXVhbnRpdGllc1skcXVvdGF0aW9uSXRlbS0+aWRdKSAmJiAkcmVxdWVzdC0+aXRlbV9xdWFudGl0aWVzWyRxdW90YXRpb25JdGVtLT5pZF0gPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRxdW90YXRpb25JdGVtLT5pc19hcHByb3ZlZCA9ICdhcHByb3ZlZCc7CiAgICAgICAgICAgICAgICAgICAgICAgICRxdW90YXRpb25JdGVtLT5hcHByb3ZlZF9xdHkgPSAkcmVxdWVzdC0+aXRlbV9xdWFudGl0aWVzWyRxdW90YXRpb25JdGVtLT5pZF07CiAgICAgICAgICAgICAgICAgICAgICAgICRxdW90YXRpb25JdGVtLT5zYXZlKCk7CgogICAgICAgICAgICAgICAgICAgICAgICBSZXF1ZXN0UHJvcG9zYWxBcHByb3ZhbDo6d2hlcmUoWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3JlcXVlc3RfcHJvcG9zYWxfaWQnID0+ICRxdW90YXRpb25JdGVtLT5yZWxRdW90YXRpb24tPnJlcXVlc3RfcHJvcG9zYWxfaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAndXNlcl9pZCcgPT4gYXV0aCgpLT51c2VyKCktPmlkLAogICAgICAgICAgICAgICAgICAgICAgICBdKQogICAgICAgICAgICAgICAgICAgICAgICAtPnVwZGF0ZShbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAncmVzcG9uc2UnID0+ICdhcHByb3ZlZCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbG9ncycgPT4ganNvbl9lbmNvZGUoUXVvdGF0aW9uczo6d2l0aChbJ3JlbFF1b3RhdGlvbkl0ZW1zJ10pLT53aGVyZUluKCdpZCcsICRxdW90YXRpb25JdGVtcy0+cGx1Y2soJ3F1b3RhdGlvbl9pZCcpLT50b0FycmF5KCkpLT5nZXQoKSksCiAgICAgICAgICAgICAgICAgICAgICAgIF0pOwoKICAgICAgICAgICAgICAgICAgICAgICAgJGNvdW50ID0gUmVxdWVzdFByb3Bvc2FsQXBwcm92YWw6OndoZXJlKCdyZXF1ZXN0X3Byb3Bvc2FsX2lkJywgJHF1b3RhdGlvbkl0ZW0tPnJlbFF1b3RhdGlvbi0+cmVxdWVzdF9wcm9wb3NhbF9pZCktPndoZXJlSW4oJ3Jlc3BvbnNlJywgWydwZW5kaW5nJywgJ2RlbmllZCddKS0+Y291bnQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoJGNvdW50ID09IDApewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1b3RhdGlvbkl0ZW0tPnJlbFF1b3RhdGlvbi0+aXNfYXBwcm92ZWQgPSAnYXBwcm92ZWQnOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAkcXVvdGF0aW9uSXRlbS0+cmVsUXVvdGF0aW9uLT5yZW1hcmtzID0gJHJlcXVlc3QtPnJlbWFya3M7CiAgICAgICAgICAgICAgICAgICAgICAgICRxdW90YXRpb25JdGVtLT5yZWxRdW90YXRpb24tPnNhdmUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCRjb3VudCA9PSAwKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5X3B1c2goJHJlZmVyZW5jZXMsICRxdW90YXRpb25JdGVtLT5yZWxRdW90YXRpb24tPnJlZmVyZW5jZV9ubyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcnJheV9wdXNoKCRxdW90YXRpb25zLCAkcXVvdGF0aW9uSXRlbS0+cmVsUXVvdGF0aW9uLT5pZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICRjb3VudCA9IFJlcXVlc3RQcm9wb3NhbEFwcHJvdmFsOjp3aGVyZSgncmVxdWVzdF9wcm9wb3NhbF9pZCcsICRxdW90YXRpb25JdGVtLT5yZWxRdW90YXRpb24tPnJlcXVlc3RfcHJvcG9zYWxfaWQpLT53aGVyZUluKCdyZXNwb25zZScsIFsncGVuZGluZycsICdkZW5pZWQnXSktPmNvdW50KCk7CiAgICAgICAgICAgIGlmKCRjb3VudCA9PSAwKXsKICAgICAgICAgICAgICAgICRxdW90YXRpb25zID0gUXVvdGF0aW9uczo6d2hlcmVJbignaWQnLCAkcXVvdGF0aW9ucykKICAgICAgICAgICAgICAgIC0+d2hlcmUoJ3R5cGUnLCAnZGlyZWN0LXB1cmNoYXNlJykKICAgICAgICAgICAgICAgIC0+Z2V0KCk7CiAgICAgICAgICAgICAgICBpZiAoaXNzZXQoJHF1b3RhdGlvbnNbMF0pKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yZWFjaCAoJHF1b3RhdGlvbnMgYXMgJGtleSA9PiAkcXVvdGF0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRwdXJjaGFzZU9yZGVyID0gJHRoaXMtPmRpcmVjdFB1cmNoYXNlU3RvcmUoJHF1b3RhdGlvbiwgJHJlcXVlc3QtPmNvc3RfY2VudHJlX2lkKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRwdXJjaGFzZU9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkbWVzc2FnZSA9ICc8c3BhbiBjbGFzcz0ibm90aWZpY2F0aW9uLWxpbmtzIiBkYXRhLXNyYz0iJyAuIHJvdXRlKCdwbXMucHVyY2hhc2Uub3JkZXItbGlzdC5zaG93JywgJHB1cmNoYXNlT3JkZXItPmlkKSAuICc/dmlldyIgZGF0YS10aXRsZT0iUHVyY2hhc2UgT3JkZXIgRGV0YWlscyI+UmVmZXJlbmNlIE5vOicgLiAkcHVyY2hhc2VPcmRlci0+cmVmZXJlbmNlX25vIC4gJy4gUmVxdWVzdCBmb3IgY2FzaCBhcHByb3ZlZC48L3NwYW4+JzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIENyZWF0ZU9yVXBkYXRlTm90aWZpY2F0aW9uKCRtZXNzYWdlLCAndW5yZWFkJywgJycsIGdldE1hbmFnZXJJbmZvKCdBY2NvdW50cycsIG51bGwsIHRydWUpLCAnc2VuZC10by1hY2NvdW50cycpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAoKICAgICAgICAgICAgaWYoaXNzZXQoJHJlZmVyZW5jZXNbMF0pKXsKICAgICAgICAgICAgICAgICRtZXNzYWdlID0gJzxzcGFuIGNsYXNzPSJub3RpZmljYXRpb24tbGlua3MiIGRhdGEtc3JjPSInIC4gdXJsKCdwbXMvcXVvdGF0aW9uL2NzLWNvbXBhcmUtdmlldy1ub3RpZmljYXRpb24vJyAuICRyZXF1ZXN0LT5yZXF1ZXN0X3Byb3Bvc2FsX2lkKSAuICciIGRhdGEtdGl0bGU9IlF1b3RhdGlvbiBDUyI+UmVmZXJlbmNlcyAoJyAuIGltcGxvZGUoJywgJywgJHJlZmVyZW5jZXMpIC4gJykgQXBwcm92ZWQgQnkgTWFuYWdlbWVudC48L3NwYW4+JzsKICAgICAgICAgICAgICAgIENyZWF0ZU9yVXBkYXRlTm90aWZpY2F0aW9uKCRtZXNzYWdlLCAndW5yZWFkJywgJycsIGdldE1hbmFnZXJJbmZvKCdQdXJjaGFzZS1EZXBhcnRtZW50JywgbnVsbCwgdHJ1ZSksICdzZW50LXRvLXB1cmNoYXNlJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIERCOjpjb21taXQoKTsKICAgICAgICAgICAgc2Vzc2lvbigpLT5mbGFzaCgnYWxlcnQtdHlwZScsICdzdWNjZXNzJyk7CiAgICAgICAgICAgIHNlc3Npb24oKS0+Zmxhc2goJ21lc3NhZ2UnLCAnQ1MgYXBwcm92ZWQgc3VjY2Vzc2Z1bGx5LicpOwogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gdHJ1ZSwKICAgICAgICAgICAgICAgICd1cmwnID0+IChpc3NldCgkcHJvcG9zYWwtPnJlbFF1b3RhdGlvbnNbMF0tPnR5cGUpICYmICRwcm9wb3NhbC0+cmVsUXVvdGF0aW9uc1swXS0+dHlwZSA9PSAnZGlyZWN0LXB1cmNoYXNlJyA/IHJvdXRlKCdwbXMucXVvdGF0aW9uLnF1b3RhdGlvbnMuZXN0aW1hdGUuYXBwcm92YWwubGlzdCcpIDogcm91dGUoJ3Btcy5xdW90YXRpb24uYXBwcm92YWwubGlzdCcpKQogICAgICAgICAgICBdKTsKICAgICAgICB9IGNhdGNoIChUaHJvd2FibGUgJHRoKSB7CiAgICAgICAgICAgIERCOjpyb2xsYmFjaygpOwogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gZmFsc2UsCiAgICAgICAgICAgICAgICAnbWVzc2FnZScgPT4gJHRoLT5nZXRNZXNzYWdlKCkKICAgICAgICAgICAgXSk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogRGlzcGxheSBhIGxpc3Rpbmcgb2YgdGhlIHJlc291cmNlLgogICAgICoKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCgoKICAgIHB1YmxpYyBmdW5jdGlvbiByZWplY3RBbGwoJGlkKQogICAgewoKICAgICAgICAkdHlwZSA9IChyZXF1ZXN0KCktPmhhcygndHlwZScpKSA/IHJlcXVlc3QoKS0+Z2V0KCd0eXBlJykgOiAnJzsKCiAgICAgICAgREI6OmJlZ2luVHJhbnNhY3Rpb24oKTsKICAgICAgICB0cnkgewogICAgICAgICAgICAkcHJvcG9zYWwgPSBSZXF1ZXN0UHJvcG9zYWw6OmZpbmRPckZhaWwoJGlkKTsKCiAgICAgICAgICAgICRxdW90YXRpb24gPSBRdW90YXRpb25zOjp3aGVyZSgncmVxdWVzdF9wcm9wb3NhbF9pZCcsICRpZCkKICAgICAgICAgICAgLT53aGVyZSgnaXNfcG9fZ2VuZXJhdGUnLCAnbm8nKQogICAgICAgICAgICAtPndoZXJlTm90SW4oJ2lzX2FwcHJvdmVkJywgWydwZW5kaW5nJ10pCiAgICAgICAgICAgIC0+d2hlbigkdHlwZSA9PSAnZGlyZWN0LXB1cmNoYXNlJywgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ3R5cGUnLCAnZGlyZWN0LXB1cmNoYXNlJyk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+d2hlbigkdHlwZSAhPSAnZGlyZWN0LXB1cmNoYXNlJywgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVOb3RJbigndHlwZScsIFsnZGlyZWN0LXB1cmNoYXNlJ10pOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPnVwZGF0ZShbCiAgICAgICAgICAgICAgICAnaXNfYXBwcm92ZWQnID0+ICdoYWx0JwogICAgICAgICAgICBdKTsKCiAgICAgICAgICAgIFJlcXVlc3RQcm9wb3NhbEFwcHJvdmFsOjp3aGVyZShbCiAgICAgICAgICAgICAgICAncmVxdWVzdF9wcm9wb3NhbF9pZCcgPT4gJHByb3Bvc2FsLT5pZCwKICAgICAgICAgICAgICAgICd1c2VyX2lkJyA9PiBhdXRoKCktPnVzZXIoKS0+aWQsCiAgICAgICAgICAgIF0pCiAgICAgICAgICAgIC0+dXBkYXRlKFsgCiAgICAgICAgICAgICAgICAncmVzcG9uc2UnID0+ICdkZW5pZWQnLAogICAgICAgICAgICAgICAgJ3VwZGF0ZWRfYnknID0+IGF1dGgoKS0+dXNlcigpLT5pZAogICAgICAgICAgICBdKTsKCiAgICAgICAgICAgICRtZXNzYWdlID0gJzxzcGFuIGNsYXNzPSJub3RpZmljYXRpb24tbGlua3MiIGRhdGEtc3JjPSInIC4gdXJsKCdwbXMvcXVvdGF0aW9uL2NzLWNvbXBhcmUtdmlldy1ub3RpZmljYXRpb24vJyAuICRpZCkgLiAnIiBkYXRhLXRpdGxlPSJRdW90YXRpb24gQ1MiPlJlZmVyZW5jZSBObzonIC4gJHByb3Bvc2FsLT5yZWZlcmVuY2Vfbm8gLiAnLiBSZWplY3RlZCBBbGwgQnkgTWFuYWdlbWVudC48L3NwYW4+JzsKCiAgICAgICAgICAgIENyZWF0ZU9yVXBkYXRlTm90aWZpY2F0aW9uKCRtZXNzYWdlLCAndW5yZWFkJywgJycsIGdldE1hbmFnZXJJbmZvKCdQdXJjaGFzZS1EZXBhcnRtZW50JywgbnVsbCwgdHJ1ZSksICdzZW50LXRvLXB1cmNoYXNlJyk7CgogICAgICAgICAgICBEQjo6Y29tbWl0KCk7CgogICAgICAgICAgICBpZiAoJHR5cGUgPT0gJ2RpcmVjdC1wdXJjaGFzZScpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkdGhpcy0+cmVkaXJlY3RCYWNrV2l0aFN1Y2Nlc3MoJ1N1Y2Nlc3NmdWxseSBSZWplY3RlZCEhJywgJ3Btcy5xdW90YXRpb24ucXVvdGF0aW9ucy5lc3RpbWF0ZS5yZWplY3QubGlzdCcpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gJHRoaXMtPnJlZGlyZWN0QmFja1dpdGhTdWNjZXNzKCdTdWNjZXNzZnVsbHkgUmVqZWN0ZWQhIScsICdwbXMucXVvdGF0aW9uLnF1b3RhdGlvbnMucmVqZWN0Lmxpc3QnKTsKCiAgICAgICAgfSBjYXRjaCAoVGhyb3dhYmxlICR0aCkgewogICAgICAgICAgICBEQjo6cm9sbGJhY2soKTsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBEaXNwbGF5IGEgbGlzdGluZyBvZiB0aGUgcmVzb3VyY2UuCiAgICAgKgogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KCiAgICBwdWJsaWMgZnVuY3Rpb24gZGlyZWN0UHVyY2hhc2VTdG9yZSgkcXVvdGF0aW9uLCAkY29zdF9jZW50cmVfaWQpCiAgICB7CiAgICAgICAgJHJlcXVpc2l0aW9uID0gaXNzZXQoJHF1b3RhdGlvbi0+cmVsUmVxdWVzdFByb3Bvc2FsLT5yZXF1ZXN0UHJvcG9zYWxSZXF1aXNpdGlvblswXSkgPyAkcXVvdGF0aW9uLT5yZWxSZXF1ZXN0UHJvcG9zYWwtPnJlcXVlc3RQcm9wb3NhbFJlcXVpc2l0aW9uWzBdLT5yZWxSZXF1aXNpdGlvbiA6IGZhbHNlOwoKICAgICAgICBpZiAoJHJlcXVpc2l0aW9uKSB7CgogICAgICAgICAgICAkcHJlZml4ID0gJ0lKTy0nIC4gZGF0ZSgneScsIHN0cnRvdGltZShkYXRlKCdZLW0tZCcpKSkgLiAnLScgLiB1bml0TmFtZSgkcmVxdWlzaXRpb24tPmhyX3VuaXRfaWQpLT5ocl91bml0X3Nob3J0X25hbWUgLiAnLSc7CiAgICAgICAgICAgICRyZWZObyA9IHVuaXF1ZUNvZGUoMTcsICRwcmVmaXgsICdwdXJjaGFzZV9vcmRlcnMnLCAnaWQnKTsKCiAgICAgICAgICAgICRwb19kYXRhID0gbmV3IFB1cmNoYXNlT3JkZXIoKTsKICAgICAgICAgICAgJHBvX2RhdGEtPnF1b3RhdGlvbl9pZCA9ICRxdW90YXRpb24tPmlkOwogICAgICAgICAgICAkcG9fZGF0YS0+aHJfdW5pdF9pZCA9ICRyZXF1aXNpdGlvbi0+aHJfdW5pdF9pZDsKICAgICAgICAgICAgJHBvX2RhdGEtPnJlZmVyZW5jZV9ubyA9ICRyZWZObzsKICAgICAgICAgICAgJHBvX2RhdGEtPnBvX2RhdGUgPSBkYXRlKCdZLW0tZCBoOmk6cycpOwogICAgICAgICAgICAkcG9fZGF0YS0+cmVtYXJrcyA9ICRxdW90YXRpb24tPnJlbWFya3M7CiAgICAgICAgICAgICRwb19kYXRhLT5jb3N0X2NlbnRyZV9pZCA9ICRjb3N0X2NlbnRyZV9pZDsKICAgICAgICAgICAgJHBvX2RhdGEtPnNhdmUoKTsKCiAgICAgICAgICAgICRwb1N1YlRvdGFsID0gMDsKICAgICAgICAgICAgJHBvVmF0ID0gMDsKICAgICAgICAgICAgJHBvR3Jvc3NUb3RhbCA9IDA7CgogICAgICAgICAgICAkY29sbGVjdFByb2R1Y3RJZCA9IFtdOwogICAgICAgICAgICBpZiAoJHF1b3RhdGlvbi0+cmVsUXVvdGF0aW9uSXRlbXMtPndoZXJlKCdpc19hcHByb3ZlZCcsICdhcHByb3ZlZCcpLT5jb3VudCgpID4gMCkgewogICAgICAgICAgICAgICAgZm9yZWFjaCAoJHF1b3RhdGlvbi0+cmVsUXVvdGF0aW9uSXRlbXMtPndoZXJlKCdpc19hcHByb3ZlZCcsICdhcHByb3ZlZCcpIGFzICRrZXkgPT4gJHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICRkaXNjb3VudCA9ICgkdmFsdWVzLT5kaXNjb3VudCA+IDAgPyAkdmFsdWVzLT51bml0X3ByaWNlICogKCR2YWx1ZXMtPmRpc2NvdW50IC8gMTAwKSA6IDApOwogICAgICAgICAgICAgICAgICAgICR1bml0X3ByaWNlID0gc3lzdGVtRG91YmxlVmFsdWUoJHZhbHVlcy0+dW5pdF9wcmljZSAtICRkaXNjb3VudCk7CgogICAgICAgICAgICAgICAgICAgICRwb1F0eSA9ICR2YWx1ZXMtPmFwcHJvdmVkX3F0eTsKICAgICAgICAgICAgICAgICAgICAkc3ViVG90YWwgPSAkdW5pdF9wcmljZSAqICRwb1F0eTsKICAgICAgICAgICAgICAgICAgICAkcG9TdWJUb3RhbCArPSAkc3ViVG90YWw7CgogICAgICAgICAgICAgICAgICAgICR2YXRBbW91bnQgPSBzeXN0ZW1Eb3VibGVWYWx1ZSgkdmFsdWVzLT52YXRfcGVyY2VudGFnZSA+IDAgPyAkc3ViVG90YWwgKiAoJHZhbHVlcy0+dmF0X3BlcmNlbnRhZ2UgLyAxMDApIDogMCk7CiAgICAgICAgICAgICAgICAgICAgJHBvVmF0ICs9ICR2YXRBbW91bnQ7CgogICAgICAgICAgICAgICAgICAgICRncm9zc1RvdGFsID0gc3lzdGVtRG91YmxlVmFsdWUoJHN1YlRvdGFsICsgKCR2YWx1ZXMtPnZhdF90eXBlICE9ICdpbmNsdXNpdmUnID8gJHZhdEFtb3VudCA6IDApKTsKICAgICAgICAgICAgICAgICAgICAkcG9Hcm9zc1RvdGFsICs9ICRncm9zc1RvdGFsOwoKICAgICAgICAgICAgICAgICAgICAkcG9faXRlbXMgPSBuZXcgUHVyY2hhc2VPcmRlckl0ZW0oKTsKICAgICAgICAgICAgICAgICAgICAkcG9faXRlbXMtPnBvX2lkID0gJHBvX2RhdGEtPmlkOwogICAgICAgICAgICAgICAgICAgICRwb19pdGVtcy0+dWlkID0gJHZhbHVlcy0+dWlkOwogICAgICAgICAgICAgICAgICAgICRwb19pdGVtcy0+cHJvZHVjdF9pZCA9ICR2YWx1ZXMtPnByb2R1Y3RfaWQ7CiAgICAgICAgICAgICAgICAgICAgJHBvX2l0ZW1zLT51bml0X3ByaWNlID0gJHVuaXRfcHJpY2U7CiAgICAgICAgICAgICAgICAgICAgJHBvX2l0ZW1zLT5xdHkgPSAkcG9RdHk7CiAgICAgICAgICAgICAgICAgICAgJHBvX2l0ZW1zLT5zdWJfdG90YWxfcHJpY2UgPSAkc3ViVG90YWw7CiAgICAgICAgICAgICAgICAgICAgJHBvX2l0ZW1zLT5kaXNjb3VudF9wZXJjZW50YWdlID0gMDsKICAgICAgICAgICAgICAgICAgICAkcG9faXRlbXMtPmRpc2NvdW50ID0gMDsKICAgICAgICAgICAgICAgICAgICAkcG9faXRlbXMtPnZhdF9wZXJjZW50YWdlID0gJHZhbHVlcy0+dmF0X3BlcmNlbnRhZ2U7CiAgICAgICAgICAgICAgICAgICAgJHBvX2l0ZW1zLT52YXRfdHlwZSA9ICR2YWx1ZXMtPnZhdF90eXBlOwogICAgICAgICAgICAgICAgICAgICRwb19pdGVtcy0+dmF0ID0gJHZhdEFtb3VudDsKICAgICAgICAgICAgICAgICAgICAkcG9faXRlbXMtPnRvdGFsX3ByaWNlID0gJGdyb3NzVG90YWw7CiAgICAgICAgICAgICAgICAgICAgJHBvX2l0ZW1zLT5zYXZlKCk7CgogICAgICAgICAgICAgICAgICAgIGFycmF5X3B1c2goJGNvbGxlY3RQcm9kdWN0SWQsICR2YWx1ZXMtPnVpZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vVXBkYXRlIFB1cmNoYXNlIE9yZGVyCiAgICAgICAgICAgICRwb19kYXRhLT51cGRhdGUoWwogICAgICAgICAgICAgICAgJ3RvdGFsX3ByaWNlJyA9PiAkcG9TdWJUb3RhbCwKICAgICAgICAgICAgICAgICdkaXNjb3VudCcgPT4gMCwKICAgICAgICAgICAgICAgICd2YXQnID0+ICRwb1ZhdCwKICAgICAgICAgICAgICAgICdncm9zc19wcmljZScgPT4gJHBvR3Jvc3NUb3RhbCwKICAgICAgICAgICAgXSk7CgogICAgICAgICAgICBpZiAoJHF1b3RhdGlvbi0+cmVsU3VwcGxpZXJQYXltZW50VGVybS0+dHlwZSA9PSAncGFpZCcpIHsKICAgICAgICAgICAgICAgIC8vQWRkIFN1cHBsaWVyIFBheW1lbnRzCiAgICAgICAgICAgICAgICAkcGF5X2Ftb3VudCA9ICgkcXVvdGF0aW9uLT5yZWxTdXBwbGllclBheW1lbnRUZXJtLT5wYXltZW50X3BlcmNlbnQgPiAwID8gKCRwb0dyb3NzVG90YWwgKiAoJHF1b3RhdGlvbi0+cmVsU3VwcGxpZXJQYXltZW50VGVybS0+cGF5bWVudF9wZXJjZW50IC8gMTAwKSkgOiAwKTsKICAgICAgICAgICAgICAgIGlmICgkcGF5X2Ftb3VudCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAkZHVyYXRpb25fZGF0ZSA9ICRxdW90YXRpb24tPnJlbFN1cHBsaWVyUGF5bWVudFRlcm0tPmRheV9kdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICAkcGF5X2RhdGUgPSBkYXRlKCdZLW0tZCBoOmk6cycsIHN0cnRvdGltZSgnKycgLiAkZHVyYXRpb25fZGF0ZSAuICcgZGF5Jywgc3RydG90aW1lKCRwb19kYXRhLT5wb19kYXRlKSkpOwogICAgICAgICAgICAgICAgICAgIC8vUGF5bWVudCBkYXRlIGJhc2VkIG9uIGFkdmFuY2UgJiBkdWUKICAgICAgICAgICAgICAgICAgICAkc3VwcGxpZXJfcGF5bWVudCA9IG5ldyBTdXBwbGllclBheW1lbnQoKTsKICAgICAgICAgICAgICAgICAgICAkc3VwcGxpZXJfcGF5bWVudC0+c3VwcGxpZXJfaWQgPSAkcXVvdGF0aW9uLT5zdXBwbGllcl9pZDsKICAgICAgICAgICAgICAgICAgICAkc3VwcGxpZXJfcGF5bWVudC0+cHVyY2hhc2Vfb3JkZXJfaWQgPSAkcG9fZGF0YS0+aWQ7CiAgICAgICAgICAgICAgICAgICAgJHN1cHBsaWVyX3BheW1lbnQtPnRyYW5zZWN0aW9uX2RhdGUgPSBkYXRlKCdZLW0tZCBoOmk6cycpOwogICAgICAgICAgICAgICAgICAgICRzdXBwbGllcl9wYXltZW50LT50cmFuc2VjdGlvbl90eXBlID0gJ3B1cmNoYXNlJzsKICAgICAgICAgICAgICAgICAgICAkc3VwcGxpZXJfcGF5bWVudC0+ZXhjaGFuZ2VfcmF0ZV9pZCA9ICRxdW90YXRpb24tPmV4Y2hhbmdlX3JhdGVfaWQ7CiAgICAgICAgICAgICAgICAgICAgJHN1cHBsaWVyX3BheW1lbnQtPmJpbGxfbnVtYmVyID0gJHBvX2RhdGEtPnJlZmVyZW5jZV9ubzsKICAgICAgICAgICAgICAgICAgICAkc3VwcGxpZXJfcGF5bWVudC0+cGF5X2Ftb3VudCA9ICRwYXlfYW1vdW50OwogICAgICAgICAgICAgICAgICAgICRzdXBwbGllcl9wYXltZW50LT5wYXlfZGF0ZSA9ICRwYXlfZGF0ZTsKICAgICAgICAgICAgICAgICAgICAkc3VwcGxpZXJfcGF5bWVudC0+YmlsbF90eXBlID0gJ3BvLWFkdmFuY2UnOwogICAgICAgICAgICAgICAgICAgICRzdXBwbGllcl9wYXltZW50LT5zYXZlKCk7CgogICAgICAgICAgICAgICAgICAgIC8vTm90aWZpY2F0aW9uIHNlbmQgdG8gYWNjb3VudHMKICAgICAgICAgICAgICAgICAgICAkbWVzc2FnZSA9ICc8c3BhbiBjbGFzcz0ibm90aWZpY2F0aW9uLWxpbmtzIiAgZGF0YS10aXRsZT0iUHVyY2hhc2UgT3JkZXIgRGV0YWlscyI+UmVmZXJlbmNlIE5vOicgLiAkcG9fZGF0YS0+cmVmZXJlbmNlX25vIC4gJy4gQSBQTyBoYXMgYmVlbiBzdWJtaXR0ZWQgd2l0aCBhbiBhZHZhbmNlIGFtb3VudCBvZiBUSyAnIC4gJHN1cHBsaWVyX3BheW1lbnQtPnBheV9hbW91bnQgLiAnPC9zcGFuPic7CgogICAgICAgICAgICAgICAgICAgIENyZWF0ZU9yVXBkYXRlTm90aWZpY2F0aW9uKCRtZXNzYWdlLCAndW5yZWFkJywgJycsIGdldE1hbmFnZXJJbmZvKCdBY2NvdW50cycsIG51bGwsIHRydWUpLCAnc2VuZC10by1hY2NvdW50cycpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvL1VwZGF0ZSByZXF1aXNpdGlvbgogICAgICAgICAgICAkcmVxdWlzaXRpb24tPml0ZW1zKCktPndoZXJlSW4oJ3VpZCcsICRjb2xsZWN0UHJvZHVjdElkKS0+d2hlcmUoJ2lzX3NlbmQnLCAneWVzJykKICAgICAgICAgICAgLT53aGVyZSgncG9fZ2VuZXJhdGUnLCAnbm8nKQogICAgICAgICAgICAtPnVwZGF0ZShbCiAgICAgICAgICAgICAgICAncG9fZ2VuZXJhdGUnID0+ICd5ZXMnCiAgICAgICAgICAgIF0pOwogICAgICAgICAgICAvL3VwZGF0ZSBxdW90YXRpb24KICAgICAgICAgICAgJHF1b3RhdGlvbi0+dXBkYXRlKFsKICAgICAgICAgICAgICAgICdpc19wb19nZW5lcmF0ZScgPT4gJ3llcycKICAgICAgICAgICAgXSk7CgogICAgICAgICAgICAkdW5jb21tb24gPSBDYXRlZ29yeTo6ZG9lc250SGF2ZSgnY2F0ZWdvcnknKS0+d2hlcmUoJ3R5cGUnLCAndW5jb21tb24nKQogICAgICAgICAgICAtPndoZXJlSGFzKCdzdWJDYXRlZ29yeS5wcm9kdWN0cycsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJHJlcXVpc2l0aW9uKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnaWQnLCAkcmVxdWlzaXRpb24tPml0ZW1zLT5wbHVjaygncHJvZHVjdF9pZCcpLT50b0FycmF5KCkpOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPmNvdW50KCk7CgogICAgICAgICAgICBQdXJjaGFzZU9yZGVyUmVxdWlzaXRpb246OnVwZGF0ZU9yQ3JlYXRlKFsKICAgICAgICAgICAgICAgICdwdXJjaGFzZV9vcmRlcl9pZCcgPT4gJHBvX2RhdGEtPmlkLAogICAgICAgICAgICAgICAgJ3JlcXVpc2l0aW9uX2lkJyA9PiAkcmVxdWlzaXRpb24tPmlkLAogICAgICAgICAgICBdLCBbCiAgICAgICAgICAgICAgICAnaHJfZGVwYXJ0bWVudF9pZCcgPT4gJHVuY29tbW9uID4gMCA/ICRyZXF1aXNpdGlvbi0+cmVsVXNlcnNMaXN0LT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCA6IDAsCiAgICAgICAgICAgIF0pOwoKICAgICAgICAgICAgLy9SZXF1aXNpdGlvbiB0cmFja2luZyB3aXRoIHJlcXVpc2l0aW9uIGlkCiAgICAgICAgICAgIFJlcXVpc2l0aW9uVHJhY2tpbmc6OnN0b3JlUmVxdWlzaXRpb25UcmFja2luZygkcmVxdWlzaXRpb24tPmlkLCAnUE8tSXNzdWUnKTsKCiAgICAgICAgICAgIHJldHVybiAkcG9fZGF0YTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKCiAgICB9CgogICAgLyoqCiAgICAgKiBEaXNwbGF5IHRoZSBzcGVjaWZpZWQgcmVzb3VyY2UuCiAgICAgKgogICAgICogQHBhcmFtIGludCAkaWQKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCgogICAgcHVibGljIGZ1bmN0aW9uIHRvZ2dsZVF1b3RhdGlvblN0YXR1cyhSZXF1ZXN0ICRyZXF1ZXN0KQogICAgewogICAgICAgICRxdW90YXRpb24gPSBRdW90YXRpb25zOjp3aGVyZSgnaWQnLCAkcmVxdWVzdC0+aWQpLT5maXJzdCgpOwoKICAgICAgICBpZiAoaXNzZXQoJHF1b3RhdGlvbi0+aWQpKSB7CiAgICAgICAgICAgICRuZXdTdGF0dXMgPSAkcmVxdWVzdC0+c3RhdHVzOwogICAgICAgICAgICAkbmV3VGV4dCA9ICRuZXdTdGF0dXMgPT0gJ2FwcHJvdmVkJyA/ICdBcHByb3ZlZCcgOiAoKCRuZXdTdGF0dXMgPT0gJ2hhbHQnKSA/ICdIYWx0JyA6ICdQZW5kaW5nJyk7CiAgICAgICAgICAgICR1cGRhdGUgPSAkcXVvdGF0aW9uLT51cGRhdGUoWydpc19hcHByb3ZlZCcgPT4gJG5ld1N0YXR1cywgJ3VwZGF0ZWRfYXQnID0+IGRhdGUoJ1ktbS1kIEg6aTpzJyksICd1cGRhdGVkX2J5JyA9PiBBdXRoOjp1c2VyKCktPmlkXSk7CiAgICAgICAgICAgIGlmICgkdXBkYXRlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnID0+IHRydWUsCiAgICAgICAgICAgICAgICAgICAgJ25ld190ZXh0JyA9PiAkbmV3VGV4dCwKICAgICAgICAgICAgICAgICAgICAnbWVzc2FnZScgPT4gJ0RhdGEgaGFzIGJlZW4gdXBkYXRlZCEnCiAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gZmFsc2UsCiAgICAgICAgICAgICAgICAnbWVzc2FnZScgPT4gJ1NvbWV0aGluZyBXZW50IFdyb25nIScKICAgICAgICAgICAgXSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAgICAgJ3N1Y2Nlc3MnID0+IGZhbHNlLAogICAgICAgICAgICAnbWVzc2FnZScgPT4gJ0RhdGEgbm90IGZvdW5kIScKICAgICAgICBdKTsKICAgIH0KCiAgICAvKioKICAgICAqIERpc3BsYXkgYSBsaXN0aW5nIG9mIHRoZSByZXNvdXJjZS4KICAgICAqCiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwoKCiAgICBwdWJsaWMgZnVuY3Rpb24gaGFsdFN0YXR1cyhSZXF1ZXN0ICRyZXF1ZXN0KQogICAgewogICAgICAgICRxdW90YXRpb24gPSBRdW90YXRpb25zOjpmaW5kT3JGYWlsKCRyZXF1ZXN0LT5pZCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgJHF1b3RhdGlvbi0+dXBkYXRlKFsKICAgICAgICAgICAgICAgICdyZW1hcmtzJyA9PiAkcmVxdWVzdC0+cmVtYXJrcywKICAgICAgICAgICAgICAgICdpc19hcHByb3ZlZCcgPT4gJ2hhbHQnLAogICAgICAgICAgICAgICAgJ3VwZGF0ZWRfYXQnID0+IGRhdGUoJ1ktbS1kIEg6aTpzJyksCiAgICAgICAgICAgICAgICAndXBkYXRlZF9ieScgPT4gQXV0aDo6dXNlcigpLT5pZAogICAgICAgICAgICBdKTsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aFN1Y2Nlc3MoJ1F1b3RhdGlvbiBTdWNjZXNzZnVsbHkgSGFsdCEhJyk7CiAgICAgICAgfSBjYXRjaCAoXFRocm93YWJsZSAkdGgpIHsKCiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogRGlzcGxheSBhIGxpc3Rpbmcgb2YgdGhlIHJlc291cmNlLgogICAgICoKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCgogICAgcHVibGljIGZ1bmN0aW9uIHNlYXJjaChSZXF1ZXN0ICRyZXF1ZXN0KQogICAgewogICAgICAgICRyZXNwb25zZSA9IFtdOwoKICAgICAgICAkZnJvbV9kYXRlID0gZGF0ZSgnWS1tLWQnLCBzdHJ0b3RpbWUoJHJlcXVlc3QtPmZyb21fZGF0ZSkpOwogICAgICAgICR0b19kYXRlID0gZGF0ZSgnWS1tLWQnLCBzdHJ0b3RpbWUoJHJlcXVlc3QtPnRvX2RhdGUpKTsKCiAgICAgICAgJGlzX2FwcHJvdmVkID0gJHJlcXVlc3QtPmlzX2FwcHJvdmVkOwogICAgICAgICRpc19wb19nZW5lcmF0ZSA9ICRyZXF1ZXN0LT5pc19wb19nZW5lcmF0ZTsKCiAgICAgICAgJGRhdGFzID0gUXVvdGF0aW9uczo6d2hlcmVEYXRlKCdxdW90YXRpb25fZGF0ZScsICc+PScsICRmcm9tX2RhdGUpCiAgICAgICAgICAgIC0+d2hlcmVEYXRlKCdxdW90YXRpb25fZGF0ZScsICc8PScsICR0b19kYXRlKQogICAgICAgICAgICAtPndoZW4oJGlzX2FwcHJvdmVkLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRpc19hcHByb3ZlZCkgewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2lzX2FwcHJvdmVkJywgJGlzX2FwcHJvdmVkKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT53aGVuKCRpc19wb19nZW5lcmF0ZSwgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgkaXNfcG9fZ2VuZXJhdGUpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdpc19wb19nZW5lcmF0ZScsICRpc19wb19nZW5lcmF0ZSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+d2hlcmUoJ3N0YXR1cycsICdhY3RpdmUnKQogICAgICAgICAgICAtPndoZXJlKCd0eXBlJywgJyE9JywgJ2RpcmVjdC1wdXJjaGFzZScpCiAgICAgICAgICAgIC0+b3JkZXJCeSgnaWQnLCAnZGVzYycpCiAgICAgICAgICAgIC0+cGFnaW5hdGUoMTAwKTsKCiAgICAgICAgJHF1b3RhdGlvbkxpc3QgPSBbXTsKICAgICAgICBmb3JlYWNoICgkZGF0YXMgYXMgJGRhdGEpIHsKICAgICAgICAgICAgZm9yZWFjaCAoQXV0aDo6dXNlcigpLT5yZWxBcHByb3ZhbFJhbmdlIGFzICRyYW5nZSkgewogICAgICAgICAgICAgICAgaWYgKCRyYW5nZS0+bWluX2Ftb3VudCA8PSAkZGF0YS0+cmVsUXVvdGF0aW9uSXRlbXMtPnN1bSgndG90YWxfcHJpY2UnKSAmJiAkcmFuZ2UtPm1heF9hbW91bnQgPj0gJGRhdGEtPnJlbFF1b3RhdGlvbkl0ZW1zLT5zdW0oJ3RvdGFsX3ByaWNlJykpIHsKICAgICAgICAgICAgICAgICAgICAkcXVvdGF0aW9uTGlzdFtdID0gJGRhdGE7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgJHF1b3RhdGlvbkxpc3QgPSAkdGhpcy0+cGFnaW5hdGUoJHF1b3RhdGlvbkxpc3QsIDEwMCk7CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmIChjb3VudCgkcXVvdGF0aW9uTGlzdCkgPiAwKSB7CiAgICAgICAgICAgICAgICAkYm9keSA9IFxJbGx1bWluYXRlXFN1cHBvcnRcRmFjYWRlc1xWaWV3OjptYWtlKCdwbXMuYmFja2VuZC5wYWdlcy5xdW90YXRpb24uX3F1b3RhdGlvbi1saXN0LXNlYXJjaCcsCiAgICAgICAgICAgICAgICAgICAgWydxdW90YXRpb25MaXN0JyA9PiAkcXVvdGF0aW9uTGlzdF0pOwogICAgICAgICAgICAgICAgJGNvbnRlbnRzID0gJGJvZHktPnJlbmRlcigpOwoKICAgICAgICAgICAgICAgICRyZXNwb25zZVsncmVzdWx0J10gPSAnc3VjY2Vzcyc7CiAgICAgICAgICAgICAgICAkcmVzcG9uc2VbJ2JvZHknXSA9ICRjb250ZW50czsKICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgICAkcmVzcG9uc2VbJ3Jlc3VsdCddID0gJ2Vycm9yJzsKICAgICAgICAgICAgICAgICRyZXNwb25zZVsnbWVzc2FnZSddID0gJ0RhdGEgbm90IGZvdW5kLiEhJzsKICAgICAgICAgICAgfQoKICAgICAgICB9IGNhdGNoIChcVGhyb3dhYmxlICR0aCkgewogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuICRyZXNwb25zZTsKICAgIH0KCiAgICAvKioKICAgICAqIERpc3BsYXkgYSBsaXN0aW5nIG9mIHRoZSByZXNvdXJjZS4KICAgICAqCiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwoKICAgIHB1YmxpYyBmdW5jdGlvbiBncExpc3RIZWFkZXJDb2x1bW5zKCR2YWx1ZSA9ICcnKQogICAgewogICAgICAgIHJldHVybiBhcnJheSgKICAgICAgICAgICAgWydTTCcsICdTTCddLAogICAgICAgICAgICBbJ2RhdGUnLCAncXVvdGF0aW9uX2RhdGUnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydkZWxpdmVyeV9kYXRlJywgJ2RlbGl2ZXJ5X2RhdGUnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydDU19udW1iZXInLCAnQ1NfbnVtYmVyJywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsncmVxdWlzaXRpb25zJywgJ3JlcXVpc2l0aW9ucycsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3Byb2R1Y3RzJywgJ3Byb2R1Y3RzJywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsncmVmZXJlbmNlX25vJywgJ3JlZmVyZW5jZV9ubyddLAogICAgICAgICAgICBbJ3N1cHBsaWVyJywgJ3N1cHBsaWVyJywgJ3RleHQtbGVmdCddLAogICAgICAgICAgICBbJ2FwcHJvdmFscycsICdhcHByb3ZhbHMnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydhY3Rpb25zJywgJ2FjdGlvbnMnLCAndGV4dC1jZW50ZXIgYWN0aW9uJ10KICAgICAgICApOwogICAgfQoKICAgIC8qKgogICAgICogRGlzcGxheSBhIGxpc3Rpbmcgb2YgdGhlIHJlc291cmNlLgogICAgICoKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCgogICAgcHVibGljIGZ1bmN0aW9uIGdlbmVyYXRlUG9MaXN0KCkKICAgIHsKICAgICAgICAkdGl0bGUgPSAnUXVvdGF0aW9ucyBBcHByb3ZlZCBMaXN0JzsKCiAgICAgICAgdHJ5IHsKCiAgICAgICAgICAgICRxdW90YXRpb25MaXN0ID0gUXVvdGF0aW9uczo6d2l0aChbCiAgICAgICAgICAgICAgICAncmVsUmVxdWVzdFByb3Bvc2FsLmFwcHJvdmFscy51c2VyJywKICAgICAgICAgICAgICAgICdyZWxTdXBwbGllcnMnLAogICAgICAgICAgICAgICAgJ3JlbFNlbGZRdW90YXRpb25TdXBwbGllckJ5UHJvcG9zYWxJZC5yZWxTdXBwbGllcnMnLAogICAgICAgICAgICAgICAgJ2V4Y2hhbmdlUmF0ZS5jdXJyZW5jeScKICAgICAgICAgICAgXSkKICAgICAgICAgICAgLT53aGVyZUhhcygncmVsU3VwcGxpZXJzJywgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlTm90SW4oJ25hbWUnLCBpZ25vcmVTdXBwbGllcnMoKSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+d2hlbihhdXRoKCktPnVzZXIoKS0+aGFzUm9sZShbJ1B1cmNoYXNlLURlcGFydG1lbnQnLCAnUHVyY2hhc2UtRW1wbG95ZWUnXSksIGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUmVxdWVzdFByb3Bvc2FsLnJlcXVlc3RQcm9wb3NhbFJlcXVpc2l0aW9uLnJlbFJlcXVpc2l0aW9uJywgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnYXNzaWduZWRfdXNlcl9pZCcsIGF1dGgoKS0+dXNlcigpLT5pZCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT53aGVyZUhhcygncmVsUmVxdWVzdFByb3Bvc2FsLnJlcXVlc3RQcm9wb3NhbFJlcXVpc2l0aW9uLnJlbFJlcXVpc2l0aW9uJywgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSW4oJ2hyX3VuaXRfaWQnLCBhdXRoKCktPnVzZXIoKS0+cHJpb3JpdGllcy0+cGx1Y2soJ2hyX3VuaXRfaWQnKS0+dG9BcnJheSgpKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT53aGVyZShbCiAgICAgICAgICAgICAgICAnc3RhdHVzJyA9PiAnYWN0aXZlJywKICAgICAgICAgICAgICAgICdpc19hcHByb3ZlZCcgPT4gJ2FwcHJvdmVkJywKICAgICAgICAgICAgICAgICdpc19wb19nZW5lcmF0ZScgPT4gJ25vJwogICAgICAgICAgICBdKQogICAgICAgICAgICAtPndoZXJlTm90SW4oJ3R5cGUnLCBbJ2RpcmVjdC1wdXJjaGFzZSddKQogICAgICAgICAgICAtPndoZW4oIWRhdGF0YWJsZU9yZGVyaW5nKCksIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyYnkoJ2lkJywgJ2Rlc2MnKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAkb3B0aW9ucyA9IFsKICAgICAgICAgICAgICAgICdxdW90YXRpb24taGFsdCcgPT4gYXV0aCgpLT51c2VyKCktPmhhc1Blcm1pc3Npb25UbygncXVvdGF0aW9uLWhhbHQnKSwKICAgICAgICAgICAgICAgICdnZW5lcmF0ZS1wbycgPT4gYXV0aCgpLT51c2VyKCktPmhhc1Blcm1pc3Npb25UbygnZ2VuZXJhdGUtcG8nKQogICAgICAgICAgICBdOwoKICAgICAgICAgICAgaWYgKHJlcXVlc3QoKS0+YWpheCgpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gRGF0YVRhYmxlczo6b2YoJHF1b3RhdGlvbkxpc3QpCiAgICAgICAgICAgICAgICAgICAgLT5hZGRJbmRleENvbHVtbigpCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2RhdGUnLCBmdW5jdGlvbiAoJHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGF0ZSgnWS1tLWQnLCBzdHJ0b3RpbWUoJHZhbHVlcy0+cXVvdGF0aW9uX2RhdGUpKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdkYXRlJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ3F1b3RhdGlvbl9kYXRlJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdkYXRlJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyQnkoJ3F1b3RhdGlvbl9kYXRlJywgJG9yZGVyKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdkZWxpdmVyeV9kYXRlJywgZnVuY3Rpb24gKCR2YWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICFlbXB0eSgkdmFsdWVzLT5kZWxpdmVyeV9kYXRlKSA/IGRhdGUoJ1ktbS1kJywgc3RydG90aW1lKCR2YWx1ZXMtPmRlbGl2ZXJ5X2RhdGUpKSA6ICcnOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ2RlbGl2ZXJ5X2RhdGUnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnZGVsaXZlcnlfZGF0ZScsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbignZGVsaXZlcnlfZGF0ZScsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT5vcmRlckJ5KCdkZWxpdmVyeV9kYXRlJywgJG9yZGVyKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdDU19udW1iZXInLCBmdW5jdGlvbiAoJHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgY2xhc3M9ImJ0biBidG4tbGluayIgb25jbGljaz0icmVxdWVzdFByb3Bvc2FsRGV0YWlscygnIC4gJHZhbHVlcy0+cmVsUmVxdWVzdFByb3Bvc2FsLT5pZCAuICcpIj4nIC4gKGlzc2V0KCR2YWx1ZXMtPnJlbFJlcXVlc3RQcm9wb3NhbC0+cmVmZXJlbmNlX25vKSA/ICR2YWx1ZXMtPnJlbFJlcXVlc3RQcm9wb3NhbC0+cmVmZXJlbmNlX25vIDogJycpIC4gJzwvYT4nOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ0NTX251bWJlcicsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxSZXF1ZXN0UHJvcG9zYWwnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdyZWZlcmVuY2Vfbm8nLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdDU19udW1iZXInLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgUmVxdWVzdFByb3Bvc2FsOjpzZWxlY3QoJ3JlcXVlc3RfcHJvcG9zYWxzLnJlZmVyZW5jZV9ubycpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCdyZXF1ZXN0X3Byb3Bvc2Fscy5pZCcsICdxdW90YXRpb25zLnJlcXVlc3RfcHJvcG9zYWxfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT50YWtlKDEpCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbigncmVxdWlzaXRpb25zJywgZnVuY3Rpb24gKCRxdW90YXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9ucyA9ICcnOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRxdW90YXRpb24tPnJlbFJlcXVlc3RQcm9wb3NhbC0+cmVxdWVzdFByb3Bvc2FsUmVxdWlzaXRpb24tPmNvdW50KCkgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JlYWNoICgkcXVvdGF0aW9uLT5yZWxSZXF1ZXN0UHJvcG9zYWwtPnJlcXVlc3RQcm9wb3NhbFJlcXVpc2l0aW9uIGFzICRrZXkgPT4gJHJlcXVpc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9ucyAuPSAoJGtleSA+IDAgPyAnLCAnIDogJycpIC4gJzxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgZGF0YS1zcmM9IicgLiByb3V0ZSgncG1zLnJlcXVpc2l0aW9uLmxpc3Qudmlldy5zaG93JywgJHJlcXVpc2l0aW9uLT5yZWxSZXF1aXNpdGlvbi0+aWQpIC4gJyIgY2xhc3M9InRleHQtcHJpbWFyeSByZXF1aXNpdGlvbiBtLTEgcm91bmRlZCBzaG93UmVxdWlzdGlvbkRldGFpbHMiIG9uY2xpY2s9InJlcXVpc3Rpb25EZXRhaWxzKCQodGhpcykpIj4nIC4gJHJlcXVpc2l0aW9uLT5yZWxSZXF1aXNpdGlvbi0+cmVmZXJlbmNlX25vIC4gJzwvYT4nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHJlcXVpc2l0aW9uczsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdyZXF1aXNpdGlvbnMnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlSGFzKCdyZWxSZXF1ZXN0UHJvcG9zYWwucmVxdWVzdFByb3Bvc2FsUmVxdWlzaXRpb24ucmVsUmVxdWlzaXRpb24nLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgncmVmZXJlbmNlX25vJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbigncmVxdWlzaXRpb25zJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwbGVhc2VTb3J0TWUoJHF1ZXJ5LCAkb3JkZXIsIFJlcXVlc3RQcm9wb3NhbDo6c2VsZWN0KCdyZXF1aXNpdGlvbnMucmVmZXJlbmNlX25vJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbigncmVxdWlzaXRpb25zJywgJ3JlcXVpc2l0aW9ucy5pZCcsICc9JywgJ3JlcXVlc3RfcHJvcG9zYWxfcmVxdWlzaXRpb25zLnJlcXVpc2l0aW9uX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbigncmVxdWVzdF9wcm9wb3NhbF9yZXF1aXNpdGlvbnMnLCAncmVxdWVzdF9wcm9wb3NhbF9yZXF1aXNpdGlvbnMucmVxdWVzdF9wcm9wb3NhbF9pZCcsICc9JywgJ3JlcXVlc3RfcHJvcG9zYWxzLmlkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3JlcXVlc3RfcHJvcG9zYWxzLmlkJywgJ3F1b3RhdGlvbnMucmVxdWVzdF9wcm9wb3NhbF9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdwcm9kdWN0cycsIGZ1bmN0aW9uICgkcXVvdGF0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRwcm9kdWN0cyA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICAkc2wgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICAkYXJyYXkgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRxdW90YXRpb24tPnJlbFJlcXVlc3RQcm9wb3NhbC0+cmVxdWVzdFByb3Bvc2FsRGV0YWlscy0+Y291bnQoKSA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRxdW90YXRpb24tPnJlbFJlcXVlc3RQcm9wb3NhbC0+cmVxdWVzdFByb3Bvc2FsRGV0YWlscyBhcyAka2V5ID0+ICRwcm9kdWN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoIWluX2FycmF5KCRwcm9kdWN0LT5wcm9kdWN0LT5pZCwgJGFycmF5KSl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzbCsrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcHJvZHVjdHMgLj0gKCRzbCA+IDEgPyAnLCAnIDogJycpIC4gJHByb2R1Y3QtPnByb2R1Y3QtPm5hbWUgLiAnICcgLiBnZXRQcm9kdWN0QXR0cmlidXRlc0Zhc3RlcigkcHJvZHVjdC0+cHJvZHVjdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5X3B1c2goJGFycmF5LCAkcHJvZHVjdC0+cHJvZHVjdC0+aWQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRwcm9kdWN0czsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdwcm9kdWN0cycsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUmVxdWVzdFByb3Bvc2FsLnJlcXVlc3RQcm9wb3NhbERldGFpbHMucHJvZHVjdCcsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5vcldoZXJlKGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVlc3RQcm9wb3NhbC5yZXF1ZXN0UHJvcG9zYWxEZXRhaWxzLnByb2R1Y3QuYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24nLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPm9yV2hlcmVIYXMoJ3JlbFJlcXVlc3RQcm9wb3NhbC5yZXF1ZXN0UHJvcG9zYWxEZXRhaWxzLnByb2R1Y3QuYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24uYXR0cmlidXRlJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdwcm9kdWN0cycsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBSZXF1ZXN0UHJvcG9zYWw6OnNlbGVjdCgncHJvZHVjdHMubmFtZScpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ3Byb2R1Y3RzJywgJ3Byb2R1Y3RzLmlkJywgJz0nLCAncmVxdWVzdF9wcm9wb3NhbF9kZXRhaWxzLnByb2R1Y3RfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdyZXF1ZXN0X3Byb3Bvc2FsX2RldGFpbHMnLCAncmVxdWVzdF9wcm9wb3NhbF9kZXRhaWxzLnJlcXVlc3RfcHJvcG9zYWxfaWQnLCAnPScsICdyZXF1ZXN0X3Byb3Bvc2Fscy5pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ3JlcXVlc3RfcHJvcG9zYWxfcmVxdWlzaXRpb25zJywgJ3JlcXVlc3RfcHJvcG9zYWxfcmVxdWlzaXRpb25zLnJlcXVlc3RfcHJvcG9zYWxfaWQnLCAnPScsICdyZXF1ZXN0X3Byb3Bvc2Fscy5pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCdyZXF1ZXN0X3Byb3Bvc2Fscy5pZCcsICdxdW90YXRpb25zLnJlcXVlc3RfcHJvcG9zYWxfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT50YWtlKDEpCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbigncmVmZXJlbmNlX25vJywgZnVuY3Rpb24gKCR2YWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIG9uY2xpY2s9Im9wZW5Nb2RhbCgnIC4gJHZhbHVlcy0+aWQgLiAnKSIgIGNsYXNzPSJidG4gYnRuLWxpbmsiPicgLiAkdmFsdWVzLT5yZWZlcmVuY2Vfbm8gLiAnPC9hPic7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbigncmVmZXJlbmNlX25vJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ3JlZmVyZW5jZV9ubycsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3N1cHBsaWVyJywgZnVuY3Rpb24gKCR2YWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8YnV0dG9uIGNsYXNzPSJidG4gYnRuLXNtIGJ0bi14cyBtci0xICcgLiAoJHZhbHVlcy0+aXNfYXBwcm92ZWQgPT0gJ2hhbHQnID8gJyBidG4td2FybmluZycgOiAnYnRuLXN1Y2Nlc3MnKSAuICciPicgLiAkdmFsdWVzLT5yZWxTdXBwbGllcnMtPm5hbWUgLiAnICgnIC4gJHZhbHVlcy0+cmVsU3VwcGxpZXJzLT5jb2RlIC4gJyk8L2J1dHRvbj4nOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3N1cHBsaWVyJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFN1cHBsaWVycycsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKS0+b3JXaGVyZSgnY29kZScsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ3N1cHBsaWVyJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwbGVhc2VTb3J0TWUoJHF1ZXJ5LCAkb3JkZXIsIFN1cHBsaWVyczo6c2VsZWN0KCdzdXBwbGllcnMubmFtZScpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCdzdXBwbGllcnMuaWQnLCAncXVvdGF0aW9ucy5zdXBwbGllcl9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9KQoKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignYXBwcm92YWxzJywgZnVuY3Rpb24gKCRxdW90YXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGFwcHJvdmFscyA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICBpZihpc3NldCgkcXVvdGF0aW9uLT5yZWxSZXF1ZXN0UHJvcG9zYWwtPmFwcHJvdmFsc1swXSkpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yZWFjaCAoJHF1b3RhdGlvbi0+cmVsUmVxdWVzdFByb3Bvc2FsLT5hcHByb3ZhbHMgYXMgJGtleSA9PiAkYXBwcm92YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYXBwcm92YWxzIC49ICc8YnV0dG9uIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi0nIC4gKCRhcHByb3ZhbC0+cmVzcG9uc2UgPT0gJ3BlbmRpbmcnID8gJ3dhcm5pbmcnIDogKCRhcHByb3ZhbC0+cmVzcG9uc2UgPT0gJ2FwcHJvdmVkJyA/ICdzdWNjZXNzJyA6ICdkYW5nZXInKSkgLiAnIG1iLTEiPicgLiAkYXBwcm92YWwtPnVzZXItPm5hbWUgLiAnIFsnIC4gdWN3b3JkcygkYXBwcm92YWwtPnJlc3BvbnNlKSAuICddPC9idXR0b24+Jm5ic3A7JzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRhcHByb3ZhbHM7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbignYXBwcm92YWxzJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVlc3RQcm9wb3NhbC5hcHByb3ZhbHMudXNlcicsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+b3JXaGVyZUhhcygncmVsUmVxdWVzdFByb3Bvc2FsLmFwcHJvdmFscycsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnc3RhdHVzJywgJ0xJS0UnLCAnJScgLiBzdHJ0b2xvd2VyKCRrZXl3b3JkKSAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KQoKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignYWN0aW9ucycsIGZ1bmN0aW9uICgkdmFsdWVzKSB1c2UgKCRvcHRpb25zKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zID0gJyc7CgogICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnPGRpdiBjbGFzcz0iYnRuLWdyb3VwIj48YnV0dG9uIGNsYXNzPSJidG4gZHJvcGRvd24tdG9nZ2xlIiBkYXRhLXRvZ2dsZT0iZHJvcGRvd24iPjxzcGFuIGlkPSJzdGF0dXNOYW1lJyAuICR2YWx1ZXMtPmlkIC4gJyI+JyAuIHVjZmlyc3QoJHZhbHVlcy0+aXNfYXBwcm92ZWQpIC4gJzwvc3Bhbj48L2J1dHRvbj48dWwgY2xhc3M9ImRyb3Bkb3duLW1lbnUiPic7CgogICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnPGxpPjxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgb25jbGljaz0ib3Blbk1vZGFsKCcgLiAkdmFsdWVzLT5pZCAuICcpIj5TaG93PC9hPjwvbGk+JzsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkdmFsdWVzLT5pc19hcHByb3ZlZCA9PT0gJ2FwcHJvdmVkJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRvcHRpb25zWydxdW90YXRpb24taGFsdCddKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxsaT48YSBjbGFzcz0icmVxdWlzaXRpb25BcHByb3ZlZEJ0biIgb25jbGljaz0icmVxdWlzaXRpb25BcHByb3ZlZEJ0bigkKHRoaXMpKSIgZGF0YS1pZD0iJyAuICR2YWx1ZXMtPmlkIC4gJyIgZGF0YS1zdGF0dXM9ImhhbHQiPkhhbHQ8L2E+PC9saT4nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkb3B0aW9uc1snZ2VuZXJhdGUtcG8nXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICc8bGk+PGEgaHJlZj0iJyAuIHJvdXRlKCdwbXMucXVvdGF0aW9uLmdlbmVyYXRlLnBvLnByb2Nlc3MnLCAkdmFsdWVzLT5pZCkgLiAnIj5HZW5lcmF0ZSBQTzwvYT48L2xpPic7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCR2YWx1ZXMtPnJlbFB1cmNoYXNlT3JkZXIpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICc8bGk+PGEgY2xhc3M9ImNvbXBsZXRlUXVvdGF0aW9uIiBvbmNsaWNrPSJjb21wbGV0ZVF1b3RhdGlvbigkKHRoaXMpKSIgZGF0YS1pZD0iJyAuICR2YWx1ZXMtPmlkIC4gJyIgZGF0YS1zdGF0dXM9ImNvbXBsZXRlUXVvdGF0aW9uIj5Db21wbGV0ZTwvYT48L2xpPic7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnPGxpPjxhIHRhcmdldD0iX19ibGFuayIgaHJlZj0iJyAuIHVybCgncG1zL3F1b3RhdGlvbi9jcy1jb21wYXJlLXZpZXctcGRmLycgLiAkdmFsdWVzLT5yZXF1ZXN0X3Byb3Bvc2FsX2lkKSAuICciIGRhdGEtdGl0bGU9IlF1b3RhdGlvbiBDUyI+Q1MgVmlldzwvYT48L2xpPic7CgogICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnPGxpPjxhIHRhcmdldD0iX19ibGFuayIgaHJlZj0iJyAuIHJvdXRlKCdwbXMucXVvdGF0aW9uLmNzLmhpc3RvcnknLCAkdmFsdWVzLT5yZXF1ZXN0X3Byb3Bvc2FsX2lkKSAuICciIGRhdGEtdGl0bGU9IlF1b3RhdGlvbiBDUyI+Q1MgSGlzdG9yeTwvYT48L2xpPic7CgogICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnPC91bD48L2Rpdj4nOwoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRhY3Rpb25zOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5yYXdDb2x1bW5zKFsnQ1NfbnVtYmVyJywgJ3JlcXVpc2l0aW9ucycsICdzdXBwbGllcicsICdyZWZlcmVuY2Vfbm8nLCAnYXBwcm92YWxzJywgJ2FjdGlvbnMnXSkKICAgICAgICAgICAgICAgICAgICAtPm1ha2UodHJ1ZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5xdW90YXRpb24uZ2VuZXJhdGUtcG8tbGlzdCcsIFsndGl0bGUnID0+ICR0aXRsZSwgJ2hlYWRlckNvbHVtbnMnID0+ICR0aGlzLT5ncExpc3RIZWFkZXJDb2x1bW5zKCldKTsKCiAgICAgICAgfSBjYXRjaCAoXFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBEaXNwbGF5IGEgbGlzdGluZyBvZiB0aGUgcmVzb3VyY2UuCiAgICAgKgogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KCiAgICBwdWJsaWMgZnVuY3Rpb24gcXVvdGF0aW9uUmVqZWN0TGlzdCgpCiAgICB7CiAgICAgICAgJHRpdGxlID0gJ1F1b3RhdGlvbnMgUmVqZWN0ZWQgTGlzdCc7CgogICAgICAgIHRyeSB7CgogICAgICAgICAgICAkcXVvdGF0aW9uTGlzdCA9IFF1b3RhdGlvbnM6OndpdGgoWwogICAgICAgICAgICAgICAgJ3JlbFJlcXVlc3RQcm9wb3NhbCcsCiAgICAgICAgICAgICAgICAncmVsU2VsZlF1b3RhdGlvblN1cHBsaWVyQnlQcm9wb3NhbElkLnJlbFN1cHBsaWVycycsCiAgICAgICAgICAgICAgICAncmVsU3VwcGxpZXJzJywKICAgICAgICAgICAgICAgICdyZWxSZXF1ZXN0UHJvcG9zYWwuYXBwcm92YWxzLnVzZXInLAoKICAgICAgICAgICAgICAgICdyZWxSZXF1ZXN0UHJvcG9zYWwucmVxdWVzdFByb3Bvc2FsUmVxdWlzaXRpb24ucmVsUmVxdWlzaXRpb24nLAogICAgICAgICAgICAgICAgJ3JlbFJlcXVlc3RQcm9wb3NhbC5yZXF1ZXN0UHJvcG9zYWxEZXRhaWxzLnByb2R1Y3QuYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24uYXR0cmlidXRlJwogICAgICAgICAgICBdKQogICAgICAgICAgICAtPndoZW4oIWF1dGgoKS0+dXNlcigpLT5oYXNBbnlSb2xlKFsnUHVyY2hhc2UtRGVwYXJ0bWVudCcsICdBdWRpdCcsICdCaWxsaW5nJywgJ01hbmFnZW1lbnQnLCAnQWNjb3VudHMnXSksIGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUmVxdWVzdFByb3Bvc2FsLnJlcXVlc3RQcm9wb3NhbFJlcXVpc2l0aW9uLnJlbFJlcXVpc2l0aW9uJywgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnYXNzaWduZWRfdXNlcl9pZCcsIGF1dGgoKS0+dXNlcigpLT5pZCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT53aGVyZShbCiAgICAgICAgICAgICAgICAnc3RhdHVzJyA9PiAnYWN0aXZlJywgJ2lzX2FwcHJvdmVkJyA9PiAnaGFsdCcsICdpc19wb19nZW5lcmF0ZScgPT4gJ25vJwogICAgICAgICAgICBdKQogICAgICAgICAgICAtPndoZXJlKCd0eXBlJywgJyE9JywgJ2RpcmVjdC1wdXJjaGFzZScpCiAgICAgICAgICAgIC0+d2hlbighZGF0YXRhYmxlT3JkZXJpbmcoKSwgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+b3JkZXJieSgnaWQnLCAnZGVzYycpOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPmdyb3VwQnkoJ3JlcXVlc3RfcHJvcG9zYWxfaWQnKTsKCiAgICAgICAgICAgIGlmIChyZXF1ZXN0KCktPmFqYXgoKSkgewogICAgICAgICAgICAgICAgJG9wdGlvbnMgPSBbCiAgICAgICAgICAgICAgICAgICAgJ3F1b3RhdGlvbi1oYWx0JyA9PiBhdXRoKCktPnVzZXIoKS0+aGFzUGVybWlzc2lvblRvKCdxdW90YXRpb24taGFsdCcpCiAgICAgICAgICAgICAgICBdOwoKICAgICAgICAgICAgICAgIHJldHVybiBEYXRhVGFibGVzOjpvZigkcXVvdGF0aW9uTGlzdCkKICAgICAgICAgICAgICAgICAgICAtPmFkZEluZGV4Q29sdW1uKCkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignZGF0ZScsIGZ1bmN0aW9uICgkdmFsdWVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkYXRlKCdZLW0tZCcsIHN0cnRvdGltZSgkdmFsdWVzLT5xdW90YXRpb25fZGF0ZSkpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ2RhdGUnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgncXVvdGF0aW9uX2RhdGUnLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ2RhdGUnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+b3JkZXJCeSgncXVvdGF0aW9uX2RhdGUnLCAkb3JkZXIpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2RlbGl2ZXJ5X2RhdGUnLCBmdW5jdGlvbiAoJHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gIWVtcHR5KCR2YWx1ZXMtPmRlbGl2ZXJ5X2RhdGUpID8gZGF0ZSgnWS1tLWQnLCBzdHJ0b3RpbWUoJHZhbHVlcy0+ZGVsaXZlcnlfZGF0ZSkpIDogJyc7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbignZGVsaXZlcnlfZGF0ZScsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdkZWxpdmVyeV9kYXRlJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdkZWxpdmVyeV9kYXRlJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyQnkoJ2RlbGl2ZXJ5X2RhdGUnLCAkb3JkZXIpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ0NTX251bWJlcicsIGZ1bmN0aW9uICgkdmFsdWVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnPGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiBjbGFzcz0iYnRuIGJ0bi1saW5rIiBvbmNsaWNrPSJyZXF1ZXN0UHJvcG9zYWxEZXRhaWxzKCcgLiAkdmFsdWVzLT5yZWxSZXF1ZXN0UHJvcG9zYWwtPmlkIC4gJykiPicgLiAoaXNzZXQoJHZhbHVlcy0+cmVsUmVxdWVzdFByb3Bvc2FsLT5yZWZlcmVuY2Vfbm8pID8gJHZhbHVlcy0+cmVsUmVxdWVzdFByb3Bvc2FsLT5yZWZlcmVuY2Vfbm8gOiAnJykgLiAnPC9hPic7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbignQ1NfbnVtYmVyJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVlc3RQcm9wb3NhbCcsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ3JlZmVyZW5jZV9ubycsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ0NTX251bWJlcicsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBSZXF1ZXN0UHJvcG9zYWw6OnNlbGVjdCgncmVxdWVzdF9wcm9wb3NhbHMucmVmZXJlbmNlX25vJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3JlcXVlc3RfcHJvcG9zYWxzLmlkJywgJ3F1b3RhdGlvbnMucmVxdWVzdF9wcm9wb3NhbF9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdyZWZlcmVuY2Vfbm8nLCBmdW5jdGlvbiAoJHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgb25jbGljaz0ib3Blbk1vZGFsKCcgLiAkdmFsdWVzLT5pZCAuICcpIiAgY2xhc3M9ImJ0biBidG4tbGluayI+JyAuICR2YWx1ZXMtPnJlZmVyZW5jZV9ubyAuICc8L2E+JzsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdyZWZlcmVuY2Vfbm8nLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgncmVmZXJlbmNlX25vJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignc3VwcGxpZXInLCBmdW5jdGlvbiAoJHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICAkZGF0YSA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHZhbHVlcy0+cmVsU2VsZlF1b3RhdGlvblN1cHBsaWVyQnlQcm9wb3NhbElkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JlYWNoICgkdmFsdWVzLT5yZWxTZWxmUXVvdGF0aW9uU3VwcGxpZXJCeVByb3Bvc2FsSWQtPndoZXJlKCdpc19hcHByb3ZlZCcsICdoYWx0JykgYXMgJHN1cHBsaWVyKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRkYXRhIC49ICc8YnV0dG9uIGNsYXNzPSJidG4gYnRuLXNtIGJ0bi14cyBtci0xICcgLiAoJHN1cHBsaWVyLT5pc19hcHByb3ZlZCA9PSAnaGFsdCcgPyAnIGJ0bi13YXJuaW5nJyA6ICdidG4tc3VjY2VzcycpIC4gJyI+JyAuICRzdXBwbGllci0+cmVsU3VwcGxpZXJzLT5uYW1lIC4gJyAoJyAuICRzdXBwbGllci0+cmVsU3VwcGxpZXJzLT5jb2RlIC4gJyk8L2J1dHRvbj4nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGRhdGE7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbignc3VwcGxpZXInLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsU3VwcGxpZXJzJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpLT5vcldoZXJlKCdjb2RlJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbignc3VwcGxpZXInLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgU3VwcGxpZXJzOjpzZWxlY3QoJ3N1cHBsaWVycy5uYW1lJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3N1cHBsaWVycy5pZCcsICdxdW90YXRpb25zLnN1cHBsaWVyX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+dGFrZSgxKQogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0pCgogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdyZXF1aXNpdGlvbnMnLCBmdW5jdGlvbiAoJHF1b3RhdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb25zID0gJyc7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHF1b3RhdGlvbi0+cmVsUmVxdWVzdFByb3Bvc2FsLT5yZXF1ZXN0UHJvcG9zYWxSZXF1aXNpdGlvbi0+Y291bnQoKSA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRxdW90YXRpb24tPnJlbFJlcXVlc3RQcm9wb3NhbC0+cmVxdWVzdFByb3Bvc2FsUmVxdWlzaXRpb24gYXMgJGtleSA9PiAkcmVxdWlzaXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb25zIC49ICgka2V5ID4gMCA/ICcsICcgOiAnJykgLiAnPGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiBkYXRhLXNyYz0iJyAuIHJvdXRlKCdwbXMucmVxdWlzaXRpb24ubGlzdC52aWV3LnNob3cnLCAkcmVxdWlzaXRpb24tPnJlbFJlcXVpc2l0aW9uLT5pZCkgLiAnIiBjbGFzcz0idGV4dC1wcmltYXJ5IHJlcXVpc2l0aW9uIG0tMSByb3VuZGVkIHNob3dSZXF1aXN0aW9uRGV0YWlscyIgb25jbGljaz0icmVxdWlzdGlvbkRldGFpbHMoJCh0aGlzKSkiPicgLiAkcmVxdWlzaXRpb24tPnJlbFJlcXVpc2l0aW9uLT5yZWZlcmVuY2Vfbm8gLiAnPC9hPic7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcmVxdWlzaXRpb25zOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3JlcXVpc2l0aW9ucycsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVlc3RQcm9wb3NhbC5yZXF1ZXN0UHJvcG9zYWxSZXF1aXNpdGlvbi5yZWxSZXF1aXNpdGlvbicsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdyZWZlcmVuY2Vfbm8nLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdyZXF1aXNpdGlvbnMnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgUmVxdWVzdFByb3Bvc2FsOjpzZWxlY3QoJ3JlcXVpc2l0aW9ucy5yZWZlcmVuY2Vfbm8nKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdyZXF1aXNpdGlvbnMnLCAncmVxdWlzaXRpb25zLmlkJywgJz0nLCAncmVxdWVzdF9wcm9wb3NhbF9yZXF1aXNpdGlvbnMucmVxdWlzaXRpb25faWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdyZXF1ZXN0X3Byb3Bvc2FsX3JlcXVpc2l0aW9ucycsICdyZXF1ZXN0X3Byb3Bvc2FsX3JlcXVpc2l0aW9ucy5yZXF1ZXN0X3Byb3Bvc2FsX2lkJywgJz0nLCAncmVxdWVzdF9wcm9wb3NhbHMuaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbigncmVxdWVzdF9wcm9wb3NhbHMuaWQnLCAncXVvdGF0aW9ucy5yZXF1ZXN0X3Byb3Bvc2FsX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+dGFrZSgxKQogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3Byb2R1Y3RzJywgZnVuY3Rpb24gKCRxdW90YXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHByb2R1Y3RzID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgICRzbCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkcXVvdGF0aW9uLT5yZWxSZXF1ZXN0UHJvcG9zYWwtPnJlcXVlc3RQcm9wb3NhbERldGFpbHMtPmNvdW50KCkgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JlYWNoICgkcXVvdGF0aW9uLT5yZWxSZXF1ZXN0UHJvcG9zYWwtPnJlcXVlc3RQcm9wb3NhbERldGFpbHMgYXMgJGtleSA9PiAkcHJvZHVjdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc3NldCgkcHJvZHVjdC0+cHJvZHVjdC0+bmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHNsKys7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRwcm9kdWN0cyAuPSAoJHNsID4gMSA/ICcsICcgOiAnJykgLiAkcHJvZHVjdC0+cHJvZHVjdC0+bmFtZSAuICcgJyAuIGdldFByb2R1Y3RBdHRyaWJ1dGVzRmFzdGVyKCRwcm9kdWN0LT5wcm9kdWN0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcHJvZHVjdHM7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbigncHJvZHVjdHMnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZShmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZShmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVlc3RQcm9wb3NhbC5yZXF1ZXN0UHJvcG9zYWxEZXRhaWxzLnByb2R1Y3QnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+b3JXaGVyZShmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxSZXF1ZXN0UHJvcG9zYWwucmVxdWVzdFByb3Bvc2FsRGV0YWlscy5wcm9kdWN0LmF0dHJpYnV0ZXMuYXR0cmlidXRlT3B0aW9uJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5vcldoZXJlSGFzKCdyZWxSZXF1ZXN0UHJvcG9zYWwucmVxdWVzdFByb3Bvc2FsRGV0YWlscy5wcm9kdWN0LmF0dHJpYnV0ZXMuYXR0cmlidXRlT3B0aW9uLmF0dHJpYnV0ZScsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbigncHJvZHVjdHMnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgUmVxdWVzdFByb3Bvc2FsOjpzZWxlY3QoJ3Byb2R1Y3RzLm5hbWUnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdwcm9kdWN0cycsICdwcm9kdWN0cy5pZCcsICc9JywgJ3JlcXVlc3RfcHJvcG9zYWxfZGV0YWlscy5wcm9kdWN0X2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbigncmVxdWVzdF9wcm9wb3NhbF9kZXRhaWxzJywgJ3JlcXVlc3RfcHJvcG9zYWxfZGV0YWlscy5yZXF1ZXN0X3Byb3Bvc2FsX2lkJywgJz0nLCAncmVxdWVzdF9wcm9wb3NhbHMuaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdyZXF1ZXN0X3Byb3Bvc2FsX3JlcXVpc2l0aW9ucycsICdyZXF1ZXN0X3Byb3Bvc2FsX3JlcXVpc2l0aW9ucy5yZXF1ZXN0X3Byb3Bvc2FsX2lkJywgJz0nLCAncmVxdWVzdF9wcm9wb3NhbHMuaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbigncmVxdWVzdF9wcm9wb3NhbHMuaWQnLCAncXVvdGF0aW9ucy5yZXF1ZXN0X3Byb3Bvc2FsX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+dGFrZSgxKQogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0pCgogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdhcHByb3ZhbHMnLCBmdW5jdGlvbiAoJHF1b3RhdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAkYXBwcm92YWxzID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGlzc2V0KCRxdW90YXRpb24tPnJlbFJlcXVlc3RQcm9wb3NhbC0+YXBwcm92YWxzWzBdKSl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JlYWNoICgkcXVvdGF0aW9uLT5yZWxSZXF1ZXN0UHJvcG9zYWwtPmFwcHJvdmFscyBhcyAka2V5ID0+ICRhcHByb3ZhbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhcHByb3ZhbHMgLj0gJzxidXR0b24gY2xhc3M9ImJ0biBidG4teHMgYnRuLScgLiAoJGFwcHJvdmFsLT5yZXNwb25zZSA9PSAncGVuZGluZycgPyAnd2FybmluZycgOiAoJGFwcHJvdmFsLT5yZXNwb25zZSA9PSAnYXBwcm92ZWQnID8gJ3N1Y2Nlc3MnIDogJ2RhbmdlcicpKSAuICciPicgLiAkYXBwcm92YWwtPnVzZXItPm5hbWUgLiAnIFsnIC4gdWN3b3JkcygkYXBwcm92YWwtPnJlc3BvbnNlKSAuICddPC9idXR0b24+Jm5ic3A7JzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRhcHByb3ZhbHM7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbignYXBwcm92YWxzJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVlc3RQcm9wb3NhbC5hcHByb3ZhbHMudXNlcicsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+b3JXaGVyZUhhcygncmVsUmVxdWVzdFByb3Bvc2FsLmFwcHJvdmFscycsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnc3RhdHVzJywgJ0xJS0UnLCAnJScgLiBzdHJ0b2xvd2VyKCRrZXl3b3JkKSAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KQoKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignYWN0aW9ucycsIGZ1bmN0aW9uICgkdmFsdWVzKSB1c2UgKCRvcHRpb25zKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAkbXlBcHByb3ZhbCA9ICR2YWx1ZXMtPnJlbFJlcXVlc3RQcm9wb3NhbC0+YXBwcm92YWxzLT53aGVyZUluKCdyZXNwb25zZScsIFsncGVuZGluZycsICdkZW5pZWQnXSktPndoZXJlKCd1c2VyX2lkJywgYXV0aCgpLT51c2VyKCktPmlkKS0+Zmlyc3QoKTsKICAgICAgICAgICAgICAgICAgICAgICAgJGF2YWlsYWJsZSA9IChpc3NldCgkbXlBcHByb3ZhbC0+aWQpKTsKICAgICAgICAgICAgICAgICAgICAgICAgJGF2YWlsYWJsZSA9ICRhdmFpbGFibGUgPyAoJHZhbHVlcy0+cmVsUmVxdWVzdFByb3Bvc2FsLT5hcHByb3ZhbHMtPndoZXJlSW4oJ3Jlc3BvbnNlJywgWydwZW5kaW5nJywgJ2RlbmllZCddKS0+d2hlcmUoJ3ByaW9yaXR5JywgJzwnLCAkbXlBcHByb3ZhbC0+cHJpb3JpdHkpLT5jb3VudCgpID09IDApIDogZmFsc2U7CgogICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyA9ICcnOwoKICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxkaXYgY2xhc3M9ImJ0bi1ncm91cCI+PGJ1dHRvbiBjbGFzcz0iYnRuIGRyb3Bkb3duLXRvZ2dsZSIgZGF0YS10b2dnbGU9ImRyb3Bkb3duIj48c3BhbiBpZD0ic3RhdHVzTmFtZScgLiAkdmFsdWVzLT5pZCAuICciPicgLiB1Y2ZpcnN0KCR2YWx1ZXMtPmlzX2FwcHJvdmVkKSAuICc8L3NwYW4+PC9idXR0b24+PHVsIGNsYXNzPSJkcm9wZG93bi1tZW51Ij4nOwoKICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxsaT48YSB0YXJnZXQ9Il9fYmxhbmsiIGhyZWY9IicgLiB1cmwoJ3Btcy9xdW90YXRpb24vY3MtY29tcGFyZS12aWV3LXBkZi8nIC4gJHZhbHVlcy0+cmVxdWVzdF9wcm9wb3NhbF9pZCkgLiAnIiBkYXRhLXRpdGxlPSJRdW90YXRpb24gQ1MiPkNTIFZpZXc8L2E+PC9saT4nOwoKICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxsaT48YSB0YXJnZXQ9Il9fYmxhbmsiIGhyZWY9IicgLiByb3V0ZSgncG1zLnF1b3RhdGlvbi5jcy5oaXN0b3J5JywgJHZhbHVlcy0+cmVxdWVzdF9wcm9wb3NhbF9pZCkgLiAnIiBkYXRhLXRpdGxlPSJRdW90YXRpb24gQ1MiPkNTIEhpc3Rvcnk8L2E+PC9saT4nOwoKICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzwvdWw+PC9kaXY+JzsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkb3B0aW9uc1sncXVvdGF0aW9uLWhhbHQnXSAmJiAkYXZhaWxhYmxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnPGEgaHJlZj0iJyAuIHJvdXRlKCdwbXMucXVvdGF0aW9uLnF1b3RhdGlvbnMuY3MuY29tcGFyZS52aWV3JywgWydpZCcgPT4gJHZhbHVlcy0+cmVsUmVxdWVzdFByb3Bvc2FsLT5pZCwgJ3NsdWcnID0+ICdsaXN0J10pIC4gJz90eXBlPXJmcCIgIHRpdGxlPSJDb21wYXJlIFByb2Nlc3MgQW5hbHlzaXMiIGNsYXNzPSJidG4gYnRuLXN1Y2Nlc3MgYnRuLXhzIj48aSBjbGFzcz0ibGFzIGxhLWxpc3QiPjwvaT48L2E+JzsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRhY3Rpb25zOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5yYXdDb2x1bW5zKFsnQ1NfbnVtYmVyJywgJ3N1cHBsaWVyJywgJ3JlZmVyZW5jZV9ubycsICdyZXF1aXNpdGlvbnMnLCAnYXBwcm92YWxzJywgJ2FjdGlvbnMnXSkKICAgICAgICAgICAgICAgICAgICAtPm1ha2UodHJ1ZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5xdW90YXRpb24ucmVqZWN0ZWQtbGlzdCcsIFsndGl0bGUnID0+ICR0aXRsZSwgJ2hlYWRlckNvbHVtbnMnID0+ICR0aGlzLT5ncExpc3RIZWFkZXJDb2x1bW5zKCldKTsKCiAgICAgICAgfSBjYXRjaCAoXFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBEaXNwbGF5IGEgbGlzdGluZyBvZiB0aGUgcmVzb3VyY2UuCiAgICAgKgogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KCiAgICBwdWJsaWMgZnVuY3Rpb24gZXN0aW1hdGVSZWplY3RMaXN0KCkKICAgIHsKICAgICAgICAkdGl0bGUgPSAnRXN0aW1hdGUgUmVqZWN0ZWQgTGlzdCc7CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgICRxdW90YXRpb25MaXN0ID0gUXVvdGF0aW9uczo6d2l0aChbCiAgICAgICAgICAgICAgICAncmVsUXVvdGF0aW9uSXRlbXMnLAogICAgICAgICAgICAgICAgJ3JlbFJlcXVlc3RQcm9wb3NhbCcsCiAgICAgICAgICAgICAgICAncmVsU3VwcGxpZXJzJywKICAgICAgICAgICAgICAgICdleGNoYW5nZVJhdGUuY3VycmVuY3knLAogICAgICAgICAgICAgICAgJ3JlbFNlbGZRdW90YXRpb25TdXBwbGllckJ5UHJvcG9zYWxJZC5yZWxTdXBwbGllcnMnCiAgICAgICAgICAgIF0pCiAgICAgICAgICAgICAgICAtPndoZXJlKFsKICAgICAgICAgICAgICAgICAgICAnc3RhdHVzJyA9PiAnYWN0aXZlJywKICAgICAgICAgICAgICAgICAgICAnaXNfYXBwcm92ZWQnID0+ICdoYWx0JywKICAgICAgICAgICAgICAgICAgICAnaXNfcG9fZ2VuZXJhdGUnID0+ICdubycKICAgICAgICAgICAgICAgIF0pCiAgICAgICAgICAgICAgICAtPndoZXJlSGFzKCdyZWxSZXF1ZXN0UHJvcG9zYWwucmVxdWVzdFByb3Bvc2FsUmVxdWlzaXRpb24ucmVsUmVxdWlzaXRpb24nLCBmdW5jdGlvbigkcXVlcnkpewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSW4oJ2hyX3VuaXRfaWQnLCBhdXRoKCktPnVzZXIoKS0+cHJpb3JpdGllcy0+cGx1Y2soJ2hyX3VuaXRfaWQnKS0+dG9BcnJheSgpKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPndoZXJlKCd0eXBlJywgJ2RpcmVjdC1wdXJjaGFzZScpCiAgICAgICAgICAgICAgICAtPndoZW4oIWRhdGF0YWJsZU9yZGVyaW5nKCksIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT5vcmRlcmJ5KCdpZCcsICdkZXNjJyk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGlmIChyZXF1ZXN0KCktPmFqYXgoKSkgewogICAgICAgICAgICAgICAgJG9wdGlvbnMgPSBbCiAgICAgICAgICAgICAgICAgICAgJ3F1b3RhdGlvbi1oYWx0JyA9PiBhdXRoKCktPnVzZXIoKS0+aGFzUGVybWlzc2lvblRvKCdxdW90YXRpb24taGFsdCcpCiAgICAgICAgICAgICAgICBdOwoKICAgICAgICAgICAgICAgIHJldHVybiBEYXRhVGFibGVzOjpvZigkcXVvdGF0aW9uTGlzdCkKICAgICAgICAgICAgICAgICAgICAtPmFkZEluZGV4Q29sdW1uKCkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignZGF0ZScsIGZ1bmN0aW9uICgkdmFsdWVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkYXRlKCdZLW0tZCcsIHN0cnRvdGltZSgkdmFsdWVzLT5xdW90YXRpb25fZGF0ZSkpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ2RhdGUnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdxdW90YXRpb25fZGF0ZScsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbignZGF0ZScsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT5vcmRlckJ5KCdxdW90YXRpb25fZGF0ZScsICRvcmRlcik7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignZGVsaXZlcnlfZGF0ZScsIGZ1bmN0aW9uICgkdmFsdWVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAhZW1wdHkoJHZhbHVlcy0+ZGVsaXZlcnlfZGF0ZSkgPyBkYXRlKCdZLW0tZCcsIHN0cnRvdGltZSgkdmFsdWVzLT5kZWxpdmVyeV9kYXRlKSkgOiAnJzsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdkZWxpdmVyeV9kYXRlJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnZGVsaXZlcnlfZGF0ZScsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbignZGVsaXZlcnlfZGF0ZScsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT5vcmRlckJ5KCdkZWxpdmVyeV9kYXRlJywgJG9yZGVyKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdDU19udW1iZXInLCBmdW5jdGlvbiAoJHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgY2xhc3M9ImJ0biBidG4tbGluayIgb25jbGljaz0icmVxdWVzdFByb3Bvc2FsRGV0YWlscygnIC4gJHZhbHVlcy0+cmVsUmVxdWVzdFByb3Bvc2FsLT5pZCAuICcpIj4nIC4gKGlzc2V0KCR2YWx1ZXMtPnJlbFJlcXVlc3RQcm9wb3NhbC0+cmVmZXJlbmNlX25vKSA/ICR2YWx1ZXMtPnJlbFJlcXVlc3RQcm9wb3NhbC0+cmVmZXJlbmNlX25vIDogJycpIC4gJzwvYT4nOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ0NTX251bWJlcicsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxSZXF1ZXN0UHJvcG9zYWwnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdyZWZlcmVuY2Vfbm8nLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdDU19udW1iZXInLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgUmVxdWVzdFByb3Bvc2FsOjpzZWxlY3QoJ3JlcXVlc3RfcHJvcG9zYWxzLnJlZmVyZW5jZV9ubycpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCdyZXF1ZXN0X3Byb3Bvc2Fscy5pZCcsICdxdW90YXRpb25zLnJlcXVlc3RfcHJvcG9zYWxfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT50YWtlKDEpCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbigncmVxdWlzaXRpb25zJywgZnVuY3Rpb24gKCRxdW90YXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9ucyA9ICcnOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRxdW90YXRpb24tPnJlbFJlcXVlc3RQcm9wb3NhbC0+cmVxdWVzdFByb3Bvc2FsUmVxdWlzaXRpb24tPmNvdW50KCkgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JlYWNoICgkcXVvdGF0aW9uLT5yZWxSZXF1ZXN0UHJvcG9zYWwtPnJlcXVlc3RQcm9wb3NhbFJlcXVpc2l0aW9uIGFzICRrZXkgPT4gJHJlcXVpc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9ucyAuPSAoJGtleSA+IDAgPyAnLCAnIDogJycpIC4gJzxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgZGF0YS1zcmM9IicgLiByb3V0ZSgncG1zLnJlcXVpc2l0aW9uLmxpc3Qudmlldy5zaG93JywgJHJlcXVpc2l0aW9uLT5yZWxSZXF1aXNpdGlvbi0+aWQpIC4gJyIgY2xhc3M9InRleHQtcHJpbWFyeSByZXF1aXNpdGlvbiBtLTEgcm91bmRlZCBzaG93UmVxdWlzdGlvbkRldGFpbHMiIG9uY2xpY2s9InJlcXVpc3Rpb25EZXRhaWxzKCQodGhpcykpIj4nIC4gJHJlcXVpc2l0aW9uLT5yZWxSZXF1aXNpdGlvbi0+cmVmZXJlbmNlX25vIC4gJzwvYT4nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHJlcXVpc2l0aW9uczsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdyZXF1aXNpdGlvbnMnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlSGFzKCdyZWxSZXF1ZXN0UHJvcG9zYWwucmVxdWVzdFByb3Bvc2FsUmVxdWlzaXRpb24ucmVsUmVxdWlzaXRpb24nLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgncmVmZXJlbmNlX25vJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbigncmVxdWlzaXRpb25zJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwbGVhc2VTb3J0TWUoJHF1ZXJ5LCAkb3JkZXIsIFJlcXVlc3RQcm9wb3NhbDo6c2VsZWN0KCdyZXF1aXNpdGlvbnMucmVmZXJlbmNlX25vJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbigncmVxdWlzaXRpb25zJywgJ3JlcXVpc2l0aW9ucy5pZCcsICc9JywgJ3JlcXVlc3RfcHJvcG9zYWxfcmVxdWlzaXRpb25zLnJlcXVpc2l0aW9uX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbigncmVxdWVzdF9wcm9wb3NhbF9yZXF1aXNpdGlvbnMnLCAncmVxdWVzdF9wcm9wb3NhbF9yZXF1aXNpdGlvbnMucmVxdWVzdF9wcm9wb3NhbF9pZCcsICc9JywgJ3JlcXVlc3RfcHJvcG9zYWxzLmlkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3JlcXVlc3RfcHJvcG9zYWxzLmlkJywgJ3F1b3RhdGlvbnMucmVxdWVzdF9wcm9wb3NhbF9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdwcm9kdWN0cycsIGZ1bmN0aW9uICgkcXVvdGF0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRwcm9kdWN0cyA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHF1b3RhdGlvbi0+cmVsUmVxdWVzdFByb3Bvc2FsLT5yZXF1ZXN0UHJvcG9zYWxEZXRhaWxzLT5jb3VudCgpID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yZWFjaCAoJHF1b3RhdGlvbi0+cmVsUmVxdWVzdFByb3Bvc2FsLT5yZXF1ZXN0UHJvcG9zYWxEZXRhaWxzIGFzICRrZXkgPT4gJHByb2R1Y3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcHJvZHVjdHMgLj0gKCRrZXkgPiAwID8gJywgJyA6ICcnKSAuICRwcm9kdWN0LT5wcm9kdWN0LT5uYW1lIC4gJyAnIC4gZ2V0UHJvZHVjdEF0dHJpYnV0ZXNGYXN0ZXIoJHByb2R1Y3QtPnByb2R1Y3QpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHByb2R1Y3RzOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3Byb2R1Y3RzJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxSZXF1ZXN0UHJvcG9zYWwucmVxdWVzdFByb3Bvc2FsRGV0YWlscy5wcm9kdWN0JywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPm9yV2hlcmUoZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUmVxdWVzdFByb3Bvc2FsLnJlcXVlc3RQcm9wb3NhbERldGFpbHMucHJvZHVjdC5hdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbicsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+b3JXaGVyZUhhcygncmVsUmVxdWVzdFByb3Bvc2FsLnJlcXVlc3RQcm9wb3NhbERldGFpbHMucHJvZHVjdC5hdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGUnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ3Byb2R1Y3RzJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwbGVhc2VTb3J0TWUoJHF1ZXJ5LCAkb3JkZXIsIFJlcXVlc3RQcm9wb3NhbDo6c2VsZWN0KCdwcm9kdWN0cy5uYW1lJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbigncHJvZHVjdHMnLCAncHJvZHVjdHMuaWQnLCAnPScsICdyZXF1ZXN0X3Byb3Bvc2FsX2RldGFpbHMucHJvZHVjdF9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ3JlcXVlc3RfcHJvcG9zYWxfZGV0YWlscycsICdyZXF1ZXN0X3Byb3Bvc2FsX2RldGFpbHMucmVxdWVzdF9wcm9wb3NhbF9pZCcsICc9JywgJ3JlcXVlc3RfcHJvcG9zYWxzLmlkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbigncmVxdWVzdF9wcm9wb3NhbF9yZXF1aXNpdGlvbnMnLCAncmVxdWVzdF9wcm9wb3NhbF9yZXF1aXNpdGlvbnMucmVxdWVzdF9wcm9wb3NhbF9pZCcsICc9JywgJ3JlcXVlc3RfcHJvcG9zYWxzLmlkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3JlcXVlc3RfcHJvcG9zYWxzLmlkJywgJ3F1b3RhdGlvbnMucmVxdWVzdF9wcm9wb3NhbF9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdyZWZlcmVuY2Vfbm8nLCBmdW5jdGlvbiAoJHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgb25jbGljaz0ib3Blbk1vZGFsKCcgLiAkdmFsdWVzLT5pZCAuICcpIiAgY2xhc3M9ImJ0biBidG4tbGluayI+JyAuICR2YWx1ZXMtPnJlZmVyZW5jZV9ubyAuICc8L2E+JzsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdyZWZlcmVuY2Vfbm8nLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgncmVmZXJlbmNlX25vJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7OwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3N1cHBsaWVyJywgZnVuY3Rpb24gKCR2YWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGRhdGEgPSAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCR2YWx1ZXMtPnJlbFNlbGZRdW90YXRpb25TdXBwbGllckJ5UHJvcG9zYWxJZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yZWFjaCAoJHZhbHVlcy0+cmVsU2VsZlF1b3RhdGlvblN1cHBsaWVyQnlQcm9wb3NhbElkLT53aGVyZSgnaXNfYXBwcm92ZWQnLCAnaGFsdCcpIGFzICRzdXBwbGllcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRkYXRhIC49ICc8YnV0dG9uIGNsYXNzPSJidG4gYnRuLXNtIGJ0bi14cyBtci0xICcgLiAoJHN1cHBsaWVyLT5pc19hcHByb3ZlZCA9PSAnaGFsdCcgPyAnIGJ0bi13YXJuaW5nJyA6ICdidG4tc3VjY2VzcycpIC4gJyI+JyAuICRzdXBwbGllci0+cmVsU3VwcGxpZXJzLT5uYW1lIC4gJyAoJyAuICRzdXBwbGllci0+cmVsU3VwcGxpZXJzLT5jb2RlIC4gJyk8L2J1dHRvbj4nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkZGF0YTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdzdXBwbGllcicsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxTdXBwbGllcnMnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyktPm9yV2hlcmUoJ2NvZGUnLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdzdXBwbGllcicsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBTdXBwbGllcnM6OnNlbGVjdCgnc3VwcGxpZXJzLm5hbWUnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbignc3VwcGxpZXJzLmlkJywgJ3F1b3RhdGlvbnMuc3VwcGxpZXJfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT50YWtlKDEpCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfSkKCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2FwcHJvdmFscycsIGZ1bmN0aW9uICgkcXVvdGF0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRhcHByb3ZhbHMgPSAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoaXNzZXQoJHF1b3RhdGlvbi0+cmVsUmVxdWVzdFByb3Bvc2FsLT5hcHByb3ZhbHNbMF0pKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRxdW90YXRpb24tPnJlbFJlcXVlc3RQcm9wb3NhbC0+YXBwcm92YWxzIGFzICRrZXkgPT4gJGFwcHJvdmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFwcHJvdmFscyAuPSAnPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi14cyBidG4tJyAuICgkYXBwcm92YWwtPnJlc3BvbnNlID09ICdwZW5kaW5nJyA/ICd3YXJuaW5nJyA6ICgkYXBwcm92YWwtPnJlc3BvbnNlID09ICdhcHByb3ZlZCcgPyAnc3VjY2VzcycgOiAnZGFuZ2VyJykpIC4gJyI+JyAuICRhcHByb3ZhbC0+dXNlci0+bmFtZSAuICcgWycgLiB1Y3dvcmRzKCRhcHByb3ZhbC0+cmVzcG9uc2UpIC4gJ108L2J1dHRvbj4mbmJzcDsnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGFwcHJvdmFsczsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdhcHByb3ZhbHMnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUmVxdWVzdFByb3Bvc2FsLmFwcHJvdmFscy51c2VyJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5vcldoZXJlSGFzKCdyZWxSZXF1ZXN0UHJvcG9zYWwuYXBwcm92YWxzJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdzdGF0dXMnLCAnTElLRScsICclJyAuIHN0cnRvbG93ZXIoJGtleXdvcmQpIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCgogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdhY3Rpb25zJywgZnVuY3Rpb24gKCR2YWx1ZXMpIHVzZSAoJG9wdGlvbnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJG15QXBwcm92YWwgPSAkdmFsdWVzLT5yZWxSZXF1ZXN0UHJvcG9zYWwtPmFwcHJvdmFscy0+d2hlcmVJbigncmVzcG9uc2UnLCBbJ3BlbmRpbmcnLCAnZGVuaWVkJ10pLT53aGVyZSgndXNlcl9pZCcsIGF1dGgoKS0+dXNlcigpLT5pZCktPmZpcnN0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICRhdmFpbGFibGUgPSAoaXNzZXQoJG15QXBwcm92YWwtPmlkKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICRhdmFpbGFibGUgPSAkYXZhaWxhYmxlID8gKCR2YWx1ZXMtPnJlbFJlcXVlc3RQcm9wb3NhbC0+YXBwcm92YWxzLT53aGVyZUluKCdyZXNwb25zZScsIFsncGVuZGluZycsICdkZW5pZWQnXSktPndoZXJlKCdwcmlvcml0eScsICc8JywgJG15QXBwcm92YWwtPnByaW9yaXR5KS0+Y291bnQoKSA9PSAwKSA6IGZhbHNlOwoKICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgPSAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCR2YWx1ZXMtPnJlbFNlbGZRdW90YXRpb25TdXBwbGllckJ5UHJvcG9zYWxJZC0+d2hlcmVJbignaXNfYXBwcm92ZWQnLCBbJ2FwcHJvdmVkJ10pLT5jb3VudCgpID09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICc8ZGl2IGNsYXNzPSJidG4tZ3JvdXAiPjxidXR0b24gY2xhc3M9ImJ0biBkcm9wZG93bi10b2dnbGUiIGRhdGEtdG9nZ2xlPSJkcm9wZG93biI+PHNwYW4gaWQ9InN0YXR1c05hbWUnIC4gJHZhbHVlcy0+aWQgLiAnIj4nIC4gdWNmaXJzdCgkdmFsdWVzLT5pc19hcHByb3ZlZCkgLiAnPC9zcGFuPjwvYnV0dG9uPjx1bCBjbGFzcz0iZHJvcGRvd24tbWVudSI+JzsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnPGxpPjxhIHRhcmdldD0iX19ibGFuayIgaHJlZj0iJyAuIHVybCgncG1zL3F1b3RhdGlvbi9jcy1jb21wYXJlLXZpZXctcGRmLycgLiAkdmFsdWVzLT5yZXF1ZXN0X3Byb3Bvc2FsX2lkKSAuICciIGRhdGEtdGl0bGU9IlF1b3RhdGlvbiBDUyI+Q1MgVmlldzwvYT48L2xpPic7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxsaT48YSB0YXJnZXQ9Il9fYmxhbmsiIGhyZWY9IicgLiByb3V0ZSgncG1zLnF1b3RhdGlvbi5jcy5oaXN0b3J5JywgJHZhbHVlcy0+cmVxdWVzdF9wcm9wb3NhbF9pZCkgLiAnIiBkYXRhLXRpdGxlPSJRdW90YXRpb24gQ1MiPkNTIEhpc3Rvcnk8L2E+PC9saT4nOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICc8L3VsPjwvZGl2Pic7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRvcHRpb25zWydxdW90YXRpb24taGFsdCddICYmICRhdmFpbGFibGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnPGEgaHJlZj0iJyAuIHJvdXRlKCdwbXMucXVvdGF0aW9uLnF1b3RhdGlvbnMuY3MuY29tcGFyZS52aWV3JywgWydpZCcgPT4gJHZhbHVlcy0+cmVsUmVxdWVzdFByb3Bvc2FsLT5pZCwgJ3NsdWcnID0+ICdsaXN0J10pIC4gJz90eXBlPWRpcmVjdC1wdXJjaGFzZSIgIHRpdGxlPSJDb21wYXJlIFByb2Nlc3MgQW5hbHlzaXMiIGNsYXNzPSJidG4gYnRuLXN1Y2Nlc3MgYnRuLXhzIj48aSBjbGFzcz0ibGFzIGxhLWxpc3QiPjwvaT48L2E+JzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGFjdGlvbnM7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPnJhd0NvbHVtbnMoWydDU19udW1iZXInLCAnc3VwcGxpZXInLCAncmVmZXJlbmNlX25vJywgJ2FjdGlvbnMnLCAncmVxdWlzaXRpb25zJywgJ3Byb2R1Y3RzJywgJ2FwcHJvdmFscyddKQogICAgICAgICAgICAgICAgICAgIC0+bWFrZSh0cnVlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnF1b3RhdGlvbi5lc3RpbWF0ZS1yZWplY3RlZC1saXN0JywgWyd0aXRsZScgPT4gJHRpdGxlLCAnaGVhZGVyQ29sdW1ucycgPT4gJHRoaXMtPmdwTGlzdEhlYWRlckNvbHVtbnMoKV0pOwoKICAgICAgICB9IGNhdGNoIChcVGhyb3dhYmxlICR0aCkgewogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIERpc3BsYXkgYSBsaXN0aW5nIG9mIHRoZSByZXNvdXJjZS4KICAgICAqCiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVkaXJlY3RSZXNwb25zZQogICAgICovCgogICAgcHVibGljIGZ1bmN0aW9uIGdlbmVyYXRlUG9Qcm9jZXNzKCRpZCkKICAgIHsKICAgICAgICAkdGl0bGUgPSAnR2VuZXJhdGUgUHVyY2hhc2UgT3JkZXInOwogICAgICAgICRxdW90YXRpb24gPSBRdW90YXRpb25zOjp3aXRoKFsKICAgICAgICAgICAgJ3JlbFF1b3RhdGlvbkl0ZW1zJywKICAgICAgICAgICAgJ3JlbFJlcXVlc3RQcm9wb3NhbC5yZXF1ZXN0UHJvcG9zYWxSZXF1aXNpdGlvbicsCiAgICAgICAgICAgICdyZWxTdXBwbGllcnMnCiAgICAgICAgXSktPndoZXJlKFsKICAgICAgICAgICAgJ3N0YXR1cycgPT4gJ2FjdGl2ZScsCiAgICAgICAgICAgICdpc19hcHByb3ZlZCcgPT4gJ2FwcHJvdmVkJywKICAgICAgICAgICAgJ2lzX3BvX2dlbmVyYXRlJyA9PiAnbm8nCiAgICAgICAgXSktPmZpbmRPckZhaWwoJGlkKTsKICAgICAgICAkcmVxdWlzaXRpb25JdGVtcyA9IFJlcXVpc2l0aW9uSXRlbTo6d2l0aChbCiAgICAgICAgICAgICdhdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGUnCiAgICAgICAgXSkKICAgICAgICAtPndoZXJlSGFzKCdyZXF1aXNpdGlvbi5yZXF1ZXN0UHJvcG9zYWxSZXF1aXNpdGlvbicsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRxdW90YXRpb24pewogICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgncmVxdWVzdF9wcm9wb3NhbF9pZCcsICRxdW90YXRpb24tPnJlcXVlc3RfcHJvcG9zYWxfaWQpOwogICAgICAgIH0pCiAgICAgICAgLT5nZXQoKTsKCiAgICAgICAgJHVuY29tbW9uID0gQ2F0ZWdvcnk6OndoZXJlSGFzKCdzdWJDYXRlZ29yeS5wcm9kdWN0cycsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJHF1b3RhdGlvbikgewogICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUluKCdpZCcsICRxdW90YXRpb24tPnJlbFF1b3RhdGlvbkl0ZW1zLT5wbHVjaygncHJvZHVjdF9pZCcpLT50b0FycmF5KCkpOwogICAgICAgIH0pLT53aGVyZSgndHlwZScsICd1bmNvbW1vbicpLT5jb3VudCgpOwoKICAgICAgICAkcmVxdWlzaXRpb25zID0gUmVxdWlzaXRpb246OndpdGgoWwogICAgICAgICAgICAncmVsVXNlcnNMaXN0LmVtcGxveWVlJwogICAgICAgIF0pCiAgICAgICAgLT53aGVyZUhhcygncmVxdWVzdFByb3Bvc2FsUmVxdWlzaXRpb24ucmVsUmVxdWVzdFByb3Bvc2FsLnJlbFF1b3RhdGlvbnMnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRxdW90YXRpb24pIHsKICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2lkJywgJHF1b3RhdGlvbi0+aWQpOwogICAgICAgIH0pCiAgICAgICAgLT53aGVyZUhhcygnaXRlbXMnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRxdW90YXRpb24pIHsKICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVJbigncHJvZHVjdF9pZCcsICRxdW90YXRpb24tPnJlbFF1b3RhdGlvbkl0ZW1zLT53aGVyZSgnaXNfYXBwcm92ZWQnLCAnYXBwcm92ZWQnKS0+cGx1Y2soJ3Byb2R1Y3RfaWQnKS0+dG9BcnJheSgpKTsKICAgICAgICB9KQogICAgICAgIC0+Z2V0KCk7CgogICAgICAgICR1bml0X2lkcyA9ICRyZXF1aXNpdGlvbnMtPnBsdWNrKCdocl91bml0X2lkJyktPnRvQXJyYXkoKTsKICAgICAgICAkZGVwYXJ0bWVudF9pZHMgPSBbXTsKICAgICAgICBpZiAoJHJlcXVpc2l0aW9ucy0+Y291bnQoKSA+IDApIHsKICAgICAgICAgICAgZm9yZWFjaCAoJHJlcXVpc2l0aW9ucyBhcyAka2V5ID0+ICRyZXF1aXNpdGlvbikgewogICAgICAgICAgICAgICAgYXJyYXlfcHVzaCgkZGVwYXJ0bWVudF9pZHMsICRyZXF1aXNpdGlvbi0+cmVsVXNlcnNMaXN0LT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRyeSB7CgogICAgICAgICAgICAkdW5pdHMgPSBVbml0Ojp3aGVyZUluKCdocl91bml0X2lkJywgJHVuaXRfaWRzKS0+Z2V0KCk7CiAgICAgICAgICAgICRkZXBhcnRtZW50cyA9IERlcGFydG1lbnQ6OndoZXJlSW4oJ2hyX2RlcGFydG1lbnRfaWQnLCAkZGVwYXJ0bWVudF9pZHMpLT5nZXQoKTsKCiAgICAgICAgICAgICRzeXN0ZW1DdXJyZW5jeSA9IHN5c3RlbUN1cnJlbmN5KCk7CiAgICAgICAgICAgICRjdXJyZW5jeSA9ICRxdW90YXRpb24tPmV4Y2hhbmdlUmF0ZS0+Y3VycmVuY3ktPmNvZGU7CiAgICAgICAgICAgICRleGNoYW5nZVJhdGUgPSBleGNoYW5nZVJhdGUoJHF1b3RhdGlvbi0+ZXhjaGFuZ2VSYXRlLCAkc3lzdGVtQ3VycmVuY3ktPmlkKTsKICAgICAgICAgICAgJHNhbWUgPSAoJHN5c3RlbUN1cnJlbmN5LT5pZCA9PSAkcXVvdGF0aW9uLT5leGNoYW5nZVJhdGUtPmN1cnJlbmN5X2lkID8gdHJ1ZSA6IGZhbHNlKTsKCiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5xdW90YXRpb24uZ2VuZXJhdGUtcG8tcHJvY2VzcycsIGNvbXBhY3QoJ3RpdGxlJywgJ3F1b3RhdGlvbicsICd1bml0cycsICdkZXBhcnRtZW50cycsICd1bmNvbW1vbicsICdzeXN0ZW1DdXJyZW5jeScsICdleGNoYW5nZVJhdGUnLCAnY3VycmVuY3knLCAnc2FtZScsICdyZXF1aXNpdGlvbkl0ZW1zJykpOwoKICAgICAgICB9IGNhdGNoIChcVGhyb3dhYmxlICR0aCkgewogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIERpc3BsYXkgYSBsaXN0aW5nIG9mIHRoZSByZXNvdXJjZS4KICAgICAqCiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwoKICAgIHB1YmxpYyBmdW5jdGlvbiB1bml0V2lzZVJlcXVpc2l0aW9uKCR1bml0SWQsICRxdW90YXRpb25JZCkKICAgIHsKICAgICAgICB0cnkgewoKICAgICAgICAgICAgJHByb2R1Y3RJZHMgPSBRdW90YXRpb25zSXRlbXM6OndoZXJlKCdxdW90YXRpb25faWQnLCAkcXVvdGF0aW9uSWQpLT53aGVyZSgnaXNfcG9fZ2VuZXJhdGUnLCAnbm8nKQogICAgICAgICAgICAgICAgLT5wbHVjaygncHJvZHVjdF9pZCcpLT50b0FycmF5KCk7CgogICAgICAgICAgICAkYXJyYXkxID0gUmVxdWlzaXRpb246OndoZXJlKFsKICAgICAgICAgICAgICAgICdocl91bml0X2lkJyA9PiAkdW5pdElkLAogICAgICAgICAgICAgICAgJ2lzX3BvX2dlbmVyYXRlJyA9PiAnbm8nLAogICAgICAgICAgICAgICAgJ2lzX3NlbmRfdG9fcmZwJyA9PiAneWVzJywKICAgICAgICAgICAgICAgICdkZWxpdmVyeV9zdGF0dXMnID0+ICdyZnAnLAogICAgICAgICAgICAgICAgJ2FwcHJvdmVkX2lkJyA9PiAxLAogICAgICAgICAgICAgICAgJ3N0YXR1cycgPT4gMSwKICAgICAgICAgICAgXSkKICAgICAgICAgICAgICAgIC0+d2hlcmVIYXMoJ3JlcXVpc2l0aW9uSXRlbXMnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRwcm9kdWN0SWRzKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2lzX3NlbmQnLCAneWVzJykKICAgICAgICAgICAgICAgICAgICAgICAgLy8gLT53aGVyZSgncG9fZ2VuZXJhdGUnLCAnbm8nKQogICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlSW4oJ3Byb2R1Y3RfaWQnLCAkcHJvZHVjdElkcyk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT53aGVyZUhhcygncmVxdWVzdFByb3Bvc2FsUmVxdWlzaXRpb24ucmVsUmVxdWVzdFByb3Bvc2FsLnJlbFF1b3RhdGlvbnMnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRxdW90YXRpb25JZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdpZCcsICRxdW90YXRpb25JZCk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT53aGVuKHJlcXVlc3QoKS0+Z2V0KCd1bmNvbW1vbicpID4gMCwgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxVc2Vyc0xpc3QuZW1wbG95ZWUnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdhc19kZXBhcnRtZW50X2lkJywgcmVxdWVzdCgpLT5nZXQoJ2hyX2RlcGFydG1lbnRfaWQnKSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5wbHVjaygnaWQnKS0+dG9BcnJheSgpOwoKICAgICAgICAgICAgJGFycmF5MiA9IFJlcXVpc2l0aW9uOjp3aGVyZShbCiAgICAgICAgICAgICAgICAnaHJfdW5pdF9pZCcgPT4gJHVuaXRJZCwKICAgICAgICAgICAgICAgICdhcHByb3ZlZF9pZCcgPT4gMSwKICAgICAgICAgICAgICAgICdzdGF0dXMnID0+IDEsCiAgICAgICAgICAgICAgICAnaXNfcG9fZ2VuZXJhdGUnID0+ICdubycsCiAgICAgICAgICAgICAgICAnaXNfc2VuZF90b19yZnAnID0+ICd5ZXMnLAogICAgICAgICAgICAgICAgJ3JlcXVlc3Rfc3RhdHVzJyA9PiAnc2VuZF9yZnAnLAogICAgICAgICAgICAgICAgJ2RlbGl2ZXJ5X3N0YXR1cycgPT4gJ3BhcnRpYWwtZGVsaXZlcmVkJywKICAgICAgICAgICAgXSkKICAgICAgICAgICAgICAgIC0+d2hlcmVIYXMoJ3JlcXVpc2l0aW9uSXRlbXMnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRwcm9kdWN0SWRzKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2lzX3NlbmQnLCAneWVzJykKICAgICAgICAgICAgICAgICAgICAgICAgLy8gLT53aGVyZSgncG9fZ2VuZXJhdGUnLCAnbm8nKQogICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlSW4oJ3Byb2R1Y3RfaWQnLCAkcHJvZHVjdElkcyk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT53aGVyZUhhcygncmVxdWVzdFByb3Bvc2FsUmVxdWlzaXRpb24ucmVsUmVxdWVzdFByb3Bvc2FsLnJlbFF1b3RhdGlvbnMnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRxdW90YXRpb25JZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdpZCcsICRxdW90YXRpb25JZCk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT53aGVuKHJlcXVlc3QoKS0+Z2V0KCd1bmNvbW1vbicpID4gMCwgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxVc2Vyc0xpc3QuZW1wbG95ZWUnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdhc19kZXBhcnRtZW50X2lkJywgcmVxdWVzdCgpLT5nZXQoJ2hyX2RlcGFydG1lbnRfaWQnKSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5wbHVjaygnaWQnKS0+dG9BcnJheSgpOwoKICAgICAgICAgICAgJGFycmF5ID0gYXJyYXlfdW5pcXVlKGFycmF5X21lcmdlKCRhcnJheTEsICRhcnJheTIpKTsKCiAgICAgICAgICAgIHJldHVybiBSZXF1aXNpdGlvbjo6d2hlcmVJbignaWQnLCAkYXJyYXkpLT5nZXQoWydpZCcsICdyZWZlcmVuY2Vfbm8nXSk7CgogICAgICAgIH0gY2F0Y2ggKFxUaHJvd2FibGUgJHRoKSB7CiAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIGdldENvc3RDZW50cmVzKFJlcXVlc3QgJHJlcXVlc3QpCiAgICB7CiAgICAgICAgJHJlcXVpc2l0aW9ucyA9IFJlcXVpc2l0aW9uOjp3aXRoKFsKICAgICAgICAgICAgJ3JlbFVzZXJzTGlzdC5lbXBsb3llZScsCiAgICAgICAgXSkKICAgICAgICAtPndoZXJlSW4oJ2lkJywgJHJlcXVlc3QtPnJlcXVpc2l0aW9ucykKICAgICAgICAtPmdldCgpOwogICAgICAgICRkZXBhcnRtZW50cyA9IFtdOwogICAgICAgIGlmIChpc3NldCgkcmVxdWlzaXRpb25zWzBdKSkgewogICAgICAgICAgICBmb3JlYWNoICgkcmVxdWlzaXRpb25zIGFzICRrZXkgPT4gJHJlcXVpc2l0aW9uKSB7CiAgICAgICAgICAgICAgICBhcnJheV9wdXNoKCRkZXBhcnRtZW50cywgJHJlcXVpc2l0aW9uLT5yZWxVc2Vyc0xpc3QtPmVtcGxveWVlLT5hc19kZXBhcnRtZW50X2lkKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgJGNvc3RDZW50cmVzID0gQ29zdENlbnRyZTo6d2l0aChbCiAgICAgICAgICAgICdwcm9maXRDZW50cmUuY29tcGFueScKICAgICAgICBdKQogICAgICAgIC0+d2hlcmUoJ2hyX3VuaXRfaWQnLCAkcmVxdWVzdC0+aHJfdW5pdF9pZCkKICAgICAgICAtPndoZXJlKGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGRlcGFydG1lbnRzLCAkcmVxdWlzaXRpb25zKXsKICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgkZGVwYXJ0bWVudHMsICRyZXF1aXNpdGlvbnMpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGRlcGFydG1lbnRzLCAkcmVxdWlzaXRpb25zKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVJbignaHJfZGVwYXJ0bWVudF9pZCcsICRkZXBhcnRtZW50cyk7CiAgICAgICAgICAgICAgICB9KS0+b3JXaGVyZSgnaHJfZGVwYXJ0bWVudF9pZCcsIDApOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPm9yV2hlcmUoZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgkZGVwYXJ0bWVudHMsICRyZXF1aXNpdGlvbnMpewogICAgICAgICAgICAgICAgcmV0dXJuICAkcXVlcnktPndoZXJlSW4oJ2lkJywgJHJlcXVpc2l0aW9ucy0+cGx1Y2soJ3JlbFVzZXJzTGlzdC5jb3N0X2NlbnRyZV9pZCcpLT50b0FycmF5KCkpOwogICAgICAgICAgICB9KTsKICAgICAgICB9KQogICAgICAgIC0+Z2V0KCk7CgogICAgICAgICRjZW50cmVzID0gJyc7CiAgICAgICAgaWYgKGlzc2V0KCRjb3N0Q2VudHJlc1swXSkpIHsKICAgICAgICAgICAgZm9yZWFjaCAoJGNvc3RDZW50cmVzIGFzICRrZXkgPT4gJGNvc3RDZW50cmUpIHsKICAgICAgICAgICAgICAgICRjZW50cmVzIC49ICc8b3B0aW9uIHZhbHVlPSInIC4gJGNvc3RDZW50cmUtPmlkIC4gJyI+WycgLiAkY29zdENlbnRyZS0+Y29kZSAuICddICcgLgogICAgICAgICAgICAgICAgICAgICRjb3N0Q2VudHJlLT5uYW1lIC4gJyAoJyAuICRjb3N0Q2VudHJlLT5wcm9maXRDZW50cmUtPmNvbXBhbnktPm5hbWUgLiAnKTwvb3B0aW9uPic7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiAkY2VudHJlczsKICAgIH0KCiAgICAvKioKICAgICAqIERpc3BsYXkgYSBsaXN0aW5nIG9mIHRoZSByZXNvdXJjZS4KICAgICAqCiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwoKICAgIHB1YmxpYyBmdW5jdGlvbiByZXF1aXNpdGlvbldpc2VJdGVtc1F0eShSZXF1ZXN0ICRyZXF1ZXN0KQogICAgewogICAgICAgIHRyeSB7CgogICAgICAgICAgICAkaXRlbXMgPSBRdW90YXRpb25zSXRlbXM6OndoZXJlKCdxdW90YXRpb25faWQnLCAkcmVxdWVzdC0+cXVvdGF0aW9uSWQpLT5nZXQoKTsKICAgICAgICAgICAgJGRhdGEgPSBbXTsKICAgICAgICAgICAgaWYgKGlzc2V0KCRpdGVtc1swXSkpIHsKICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRpdGVtcyBhcyAka2V5ID0+ICRpdGVtKSB7CiAgICAgICAgICAgICAgICAgICAgJHF0eSA9IFJlcXVpc2l0aW9uSXRlbTo6d2hlcmVJbigncmVxdWlzaXRpb25faWQnLCAkcmVxdWVzdC0+cmVxdWlzaXRpb25JZCkKICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZSgncHJvZHVjdF9pZCcsICRpdGVtLT5wcm9kdWN0X2lkKQogICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlKCdpc19zZW5kJywgJ3llcycpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmUoJ3BvX2dlbmVyYXRlJywgJ25vJykKICAgICAgICAgICAgICAgICAgICAgICAgLT5zdW0oJ3F0eScpOwoKICAgICAgICAgICAgICAgICAgICAkZGVsaXZlcnlRdHkgPSBSZXF1aXNpdGlvbkl0ZW06OndoZXJlSW4oJ3JlcXVpc2l0aW9uX2lkJywgJHJlcXVlc3QtPnJlcXVpc2l0aW9uSWQpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmUoJ3Byb2R1Y3RfaWQnLCAkaXRlbS0+cHJvZHVjdF9pZCkKICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZSgnaXNfc2VuZCcsICd5ZXMnKQogICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlKCdwb19nZW5lcmF0ZScsICdubycpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+c3VtKCdkZWxpdmVyeV9xdHknKTsKCiAgICAgICAgICAgICAgICAgICAgJGRhdGFbJGl0ZW0tPmlkXSA9ICRpdGVtLT5hcHByb3ZlZF9xdHkgLSAkZGVsaXZlcnlRdHk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiAkZGF0YTsKICAgICAgICB9IGNhdGNoIChcVGhyb3dhYmxlICR0aCkgewogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCiAgICBwdWJsaWMgZnVuY3Rpb24gZ2VuZXJhdGVQb1N0b3JlKFJlcXVlc3QgJHJlcXVlc3QpCiAgICB7CiAgICAgICAgJHRoaXMtPnZhbGlkYXRlKCRyZXF1ZXN0LCBbCiAgICAgICAgICAgICdxdW90YXRpb25faWQnID0+ICdyZXF1aXJlZCcsCiAgICAgICAgICAgICdwb19xdHknID0+ICdyZXF1aXJlZCcsCiAgICAgICAgICAgICdyZXF1aXNpdGlvbl9pZCcgPT4gJ3JlcXVpcmVkJywKICAgICAgICAgICAgJ2hyX3VuaXRfaWQnID0+ICdyZXF1aXJlZCcsCiAgICAgICAgICAgICdjb3N0X2NlbnRyZV9pZCcgPT4gJ3JlcXVpcmVkJywKICAgICAgICBdKTsKCiAgICAgICAgJGZpbHRlclBvUXR5ID0gYXJyYXlfZGlmZigkcmVxdWVzdC0+cG9fcXR5LCBbMF0pOwogICAgICAgICRjb2xsZWN0UHJvZHVjdElkID0gYXJyYXlfa2V5cygkZmlsdGVyUG9RdHkpOwogICAgICAgIGlmIChhcnJheV9zdW0oJGZpbHRlclBvUXR5KSA8PSAwKSB7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcignUGxlYXNlIHBvIHF0eSBjYW4gbm90IGJlIDAnKTsKICAgICAgICB9CgogICAgICAgICRtb2RhbCA9IFF1b3RhdGlvbnM6OndoZXJlKCdpZCcsICRyZXF1ZXN0LT5xdW90YXRpb25faWQpLT5maXJzdCgpOwogICAgICAgICRwcmVmaXggPSAnUE8tJyAuIGRhdGUoJ3knLCBzdHJ0b3RpbWUoZGF0ZSgnWS1tLWQnKSkpIC4gJy0nIC4gdW5pdE5hbWUoJHJlcXVlc3QtPmhyX3VuaXRfaWQpLT5ocl91bml0X3Nob3J0X25hbWUgLiAnLSc7CiAgICAgICAgJHJlZk5vID0gdW5pcXVlQ29kZSgxNiwgJHByZWZpeCwgJ3B1cmNoYXNlX29yZGVycycsICdpZCcpOwoKICAgICAgICBEQjo6YmVnaW5UcmFuc2FjdGlvbigpOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgICRwb19kYXRhID0gbmV3IFB1cmNoYXNlT3JkZXIoKTsKICAgICAgICAgICAgJHBvX2RhdGEtPnF1b3RhdGlvbl9pZCA9ICRtb2RhbC0+aWQ7CiAgICAgICAgICAgICRwb19kYXRhLT5ocl91bml0X2lkID0gJHJlcXVlc3QtPmhyX3VuaXRfaWQ7CiAgICAgICAgICAgICRwb19kYXRhLT5yZWZlcmVuY2Vfbm8gPSAkcmVmTm87CiAgICAgICAgICAgICRwb19kYXRhLT5wb19kYXRlID0gZGF0ZSgnWS1tLWQnLCBzdHJ0b3RpbWUoJHJlcXVlc3QtPnBvX2RhdGUpKTsKICAgICAgICAgICAgJHBvX2RhdGEtPnJlbWFya3MgPSAkcmVxdWVzdC0+cmVtYXJrczsKICAgICAgICAgICAgJHBvX2RhdGEtPnRlcm1zID0gJHJlcXVlc3QtPnRlcm1zOwogICAgICAgICAgICAkcG9fZGF0YS0+Y29zdF9jZW50cmVfaWQgPSAkcmVxdWVzdC0+Y29zdF9jZW50cmVfaWQ7CiAgICAgICAgICAgICRwb19kYXRhLT5zYXZlKCk7CgogICAgICAgICAgICAkcG9TdWJUb3RhbCA9IDA7CiAgICAgICAgICAgICRwb1ZhdCA9IDA7CiAgICAgICAgICAgICRwb0dyb3NzVG90YWwgPSAwOwoKICAgICAgICAgICAgJGl0ZW1zID0gUXVvdGF0aW9uc0l0ZW1zOjp3aGVyZSgncXVvdGF0aW9uX2lkJywgJG1vZGFsLT5pZCkKICAgICAgICAgICAgLT53aGVyZUluKCd1aWQnLCAkY29sbGVjdFByb2R1Y3RJZCkKICAgICAgICAgICAgLT53aGVyZSgnaXNfYXBwcm92ZWQnLCAnYXBwcm92ZWQnKQogICAgICAgICAgICAtPmdldCgpOwogICAgICAgICAgICBmb3JlYWNoICgkaXRlbXMgYXMgJGtleSA9PiAkdmFsdWVzKSB7CiAgICAgICAgICAgICAgICAkZGlzY291bnRfYW1vdW50ID0gJHZhbHVlcy0+dW5pdF9wcmljZSA+IDAgJiYgJHZhbHVlcy0+YXBwcm92ZWRfcXR5ID4gMCAmJiAkcmVxdWVzdC0+ZGlzY291bnRfcGVyY2VudGFnZVskdmFsdWVzLT5pZF0gPiAwID8gKCR2YWx1ZXMtPnVuaXRfcHJpY2UqJHZhbHVlcy0+YXBwcm92ZWRfcXR5KSooJHJlcXVlc3QtPmRpc2NvdW50X3BlcmNlbnRhZ2VbJHZhbHVlcy0+aWRdLzEwMCkgOiAwOwogICAgICAgICAgICAgICAgJGFmdGVyX2Rpc2NvdW50ID0gKCR2YWx1ZXMtPnVuaXRfcHJpY2UqJHZhbHVlcy0+YXBwcm92ZWRfcXR5KS0kZGlzY291bnRfYW1vdW50OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAkdmFsdWVzLT5kaXNjb3VudCA9ICRyZXF1ZXN0LT5kaXNjb3VudF9wZXJjZW50YWdlWyR2YWx1ZXMtPmlkXTsKICAgICAgICAgICAgICAgICR2YWx1ZXMtPmRpc2NvdW50X2Ftb3VudCA9ICRkaXNjb3VudF9hbW91bnQ7CiAgICAgICAgICAgICAgICAkdmFsdWVzLT52YXRfcGVyY2VudGFnZSA9ICRyZXF1ZXN0LT52YXRfcGVyY2VudGFnZVskdmFsdWVzLT5pZF07CiAgICAgICAgICAgICAgICAkdmFsdWVzLT52YXQgPSAkYWZ0ZXJfZGlzY291bnQgPiAwICYmICRyZXF1ZXN0LT52YXRfcGVyY2VudGFnZVskdmFsdWVzLT5pZF0gPiAwID8gJGFmdGVyX2Rpc2NvdW50KigkcmVxdWVzdC0+dmF0X3BlcmNlbnRhZ2VbJHZhbHVlcy0+aWRdLzEwMCkgOiAwOwogICAgICAgICAgICAgICAgJHZhbHVlcy0+c2F2ZSgpOwoKICAgICAgICAgICAgICAgICRkaXNjb3VudGVkID0gKCR2YWx1ZXMtPmRpc2NvdW50ID4gMCA/ICgkdmFsdWVzLT51bml0X3ByaWNlICogKCR2YWx1ZXMtPmRpc2NvdW50IC8gMTAwKSkgOiAwKTsKICAgICAgICAgICAgICAgICR1bml0X3ByaWNlID0gKCR2YWx1ZXMtPnVuaXRfcHJpY2UgLSAkZGlzY291bnRlZCk7CgogICAgICAgICAgICAgICAgJHBvUXR5ID0gJGZpbHRlclBvUXR5WyR2YWx1ZXMtPnVpZF07CiAgICAgICAgICAgICAgICAkc3ViVG90YWwgPSAkdW5pdF9wcmljZSAqICRwb1F0eTsKICAgICAgICAgICAgICAgICRwb1N1YlRvdGFsICs9ICRzdWJUb3RhbDsKCiAgICAgICAgICAgICAgICBpZigkdmFsdWVzLT52YXRfdHlwZSA9PSAnaW5jbHVzaXZlJyl7CiAgICAgICAgICAgICAgICAgICAgJHZhdEFtb3VudCA9ICgkdmFsdWVzLT52YXRfcGVyY2VudGFnZSA+IDAgJiYgJHN1YlRvdGFsID4gMCA/ICgoJHN1YlRvdGFsKiR2YWx1ZXMtPnZhdF9wZXJjZW50YWdlKS8oMTAwKyR2YWx1ZXMtPnZhdF9wZXJjZW50YWdlKSkgOiAwKTsKICAgICAgICAgICAgICAgICAgICAkZ3Jvc3NUb3RhbCA9ICRzdWJUb3RhbDsKICAgICAgICAgICAgICAgIH1lbHNlIGlmKCR2YWx1ZXMtPnZhdF90eXBlID09ICdleGNsdXNpdmUnKXsKICAgICAgICAgICAgICAgICAgICAkdmF0QW1vdW50ID0gKCR2YWx1ZXMtPnZhdF9wZXJjZW50YWdlID4gMCAmJiAkc3ViVG90YWwgPiAwID8gKCRzdWJUb3RhbCAqICgkdmFsdWVzLT52YXRfcGVyY2VudGFnZSAvIDEwMCkpIDogMCk7CiAgICAgICAgICAgICAgICAgICAgJGdyb3NzVG90YWwgPSAoJHN1YlRvdGFsICsgJHZhdEFtb3VudCk7CiAgICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICAgICAkdmF0QW1vdW50ID0gMDsKICAgICAgICAgICAgICAgICAgICAkZ3Jvc3NUb3RhbCA9ICRzdWJUb3RhbDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAkcG9WYXQgKz0gJHZhdEFtb3VudDsKICAgICAgICAgICAgICAgICRwb0dyb3NzVG90YWwgKz0gJGdyb3NzVG90YWw7CgogICAgICAgICAgICAgICAgJHBvX2l0ZW1zID0gbmV3IFB1cmNoYXNlT3JkZXJJdGVtKCk7CiAgICAgICAgICAgICAgICAkcG9faXRlbXMtPnBvX2lkID0gJHBvX2RhdGEtPmlkOwogICAgICAgICAgICAgICAgJHBvX2l0ZW1zLT51aWQgPSAkdmFsdWVzLT51aWQ7CiAgICAgICAgICAgICAgICAkcG9faXRlbXMtPnByb2R1Y3RfaWQgPSAkdmFsdWVzLT5wcm9kdWN0X2lkOwogICAgICAgICAgICAgICAgJHBvX2l0ZW1zLT51bml0X3ByaWNlID0gJHVuaXRfcHJpY2U7CiAgICAgICAgICAgICAgICAkcG9faXRlbXMtPnF0eSA9ICRwb1F0eTsKICAgICAgICAgICAgICAgICRwb19pdGVtcy0+c3ViX3RvdGFsX3ByaWNlID0gJHN1YlRvdGFsOwogICAgICAgICAgICAgICAgJHBvX2l0ZW1zLT5kaXNjb3VudF9wZXJjZW50YWdlID0gMDsKICAgICAgICAgICAgICAgICRwb19pdGVtcy0+ZGlzY291bnQgPSAwOwogICAgICAgICAgICAgICAgJHBvX2l0ZW1zLT52YXRfdHlwZSA9ICR2YWx1ZXMtPnZhdF90eXBlOwogICAgICAgICAgICAgICAgJHBvX2l0ZW1zLT52YXRfcGVyY2VudGFnZSA9ICR2YWx1ZXMtPnZhdF9wZXJjZW50YWdlOwogICAgICAgICAgICAgICAgJHBvX2l0ZW1zLT52YXQgPSAkdmF0QW1vdW50OwogICAgICAgICAgICAgICAgJHBvX2l0ZW1zLT50b3RhbF9wcmljZSA9ICRncm9zc1RvdGFsOwogICAgICAgICAgICAgICAgJHBvX2l0ZW1zLT5zYXZlKCk7CgogICAgICAgICAgICAgICAgJHZhbHVlcy0+aXNfcG9fZ2VuZXJhdGUgPSAneWVzJzsKICAgICAgICAgICAgICAgICR2YWx1ZXMtPnNhdmUoKTsKCiAgICAgICAgICAgICAgICAvL3VwZGF0ZSBsYXRlc3QgcHJvZHVjdCBwcmljZQogICAgICAgICAgICAgICAgbGF0ZXN0UHJvZHVjdFByaWNlVXBkYXRlKCR2YWx1ZXMtPnByb2R1Y3RfaWQsICR1bml0X3ByaWNlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy9VcGRhdGUgUHVyY2hhc2UgT3JkZXIKICAgICAgICAgICAgUHVyY2hhc2VPcmRlcjo6d2hlcmUoJ2lkJywgJHBvX2RhdGEtPmlkKS0+dXBkYXRlKFsKICAgICAgICAgICAgICAgICd0b3RhbF9wcmljZScgPT4gUHVyY2hhc2VPcmRlckl0ZW06OndoZXJlKCdwb19pZCcsICRwb19kYXRhLT5pZCktPnN1bSgnc3ViX3RvdGFsX3ByaWNlJyksCiAgICAgICAgICAgICAgICAnZGlzY291bnQnID0+IDAsCiAgICAgICAgICAgICAgICAndmF0JyA9PiBQdXJjaGFzZU9yZGVySXRlbTo6d2hlcmUoJ3BvX2lkJywgJHBvX2RhdGEtPmlkKS0+c3VtKCd2YXQnKSwKICAgICAgICAgICAgICAgICdncm9zc19wcmljZScgPT4gUHVyY2hhc2VPcmRlckl0ZW06OndoZXJlKCdwb19pZCcsICRwb19kYXRhLT5pZCktPnN1bSgndG90YWxfcHJpY2UnKSwKICAgICAgICAgICAgXSk7CgogICAgICAgICAgICBpZiAoJG1vZGFsLT5yZWxTdXBwbGllclBheW1lbnRUZXJtLT50eXBlID09ICdwYWlkJykgewogICAgICAgICAgICAgICAgLy9BZGQgU3VwcGxpZXIgUHlhbWVudHMKICAgICAgICAgICAgICAgICRkdXJhdGlvbl9kYXRlID0gJG1vZGFsLT5yZWxTdXBwbGllclBheW1lbnRUZXJtLT5kYXlfZHVyYXRpb247CiAgICAgICAgICAgICAgICAkcGF5X2RhdGUgPSBkYXRlKCdZLW0tZCBoOmk6cycsIHN0cnRvdGltZSgnKycgLiAkZHVyYXRpb25fZGF0ZSAuICcgZGF5Jywgc3RydG90aW1lKCRwb19kYXRhLT5wb19kYXRlKSkpOwogICAgICAgICAgICAgICAgLy9QYXltZW50IGRhdGUgYmFzZWQgb24gYWR2YW5jZSAmIGR1ZQogICAgICAgICAgICAgICAgJHBheV9hbW91bnQgPSAoJG1vZGFsLT5yZWxTdXBwbGllclBheW1lbnRUZXJtLT5wYXltZW50X3BlcmNlbnQgPiAwICYmICRwb0dyb3NzVG90YWwgPiAwID8gKCRtb2RhbC0+cmVsU3VwcGxpZXJQYXltZW50VGVybS0+cGF5bWVudF9wZXJjZW50ICogJHBvR3Jvc3NUb3RhbCkgLyAxMDAgOiAwKTsKICAgICAgICAgICAgICAgIGlmICgkcGF5X2Ftb3VudCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAkc3VwcGxpZXJfcGF5bWVudCA9IG5ldyBTdXBwbGllclBheW1lbnQoKTsKICAgICAgICAgICAgICAgICAgICAkc3VwcGxpZXJfcGF5bWVudC0+c3VwcGxpZXJfaWQgPSAkbW9kYWwtPnN1cHBsaWVyX2lkOwogICAgICAgICAgICAgICAgICAgICRzdXBwbGllcl9wYXltZW50LT5wdXJjaGFzZV9vcmRlcl9pZCA9ICRwb19kYXRhLT5pZDsKICAgICAgICAgICAgICAgICAgICAkc3VwcGxpZXJfcGF5bWVudC0+dHJhbnNlY3Rpb25fZGF0ZSA9IGRhdGUoJ1ktbS1kIGg6aTpzJyk7CiAgICAgICAgICAgICAgICAgICAgJHN1cHBsaWVyX3BheW1lbnQtPnRyYW5zZWN0aW9uX3R5cGUgPSAncHVyY2hhc2UnOwogICAgICAgICAgICAgICAgICAgICRzdXBwbGllcl9wYXltZW50LT5leGNoYW5nZV9yYXRlX2lkID0gJG1vZGFsLT5leGNoYW5nZV9yYXRlX2lkOwogICAgICAgICAgICAgICAgICAgICRzdXBwbGllcl9wYXltZW50LT5iaWxsX251bWJlciA9ICRwb19kYXRhLT5yZWZlcmVuY2Vfbm87CiAgICAgICAgICAgICAgICAgICAgJHN1cHBsaWVyX3BheW1lbnQtPnBheV9hbW91bnQgPSAkcGF5X2Ftb3VudDsKICAgICAgICAgICAgICAgICAgICAkc3VwcGxpZXJfcGF5bWVudC0+cGF5X2RhdGUgPSAkcGF5X2RhdGU7CiAgICAgICAgICAgICAgICAgICAgJHN1cHBsaWVyX3BheW1lbnQtPmJpbGxfdHlwZSA9ICdwby1hZHZhbmNlJzsKICAgICAgICAgICAgICAgICAgICAkc3VwcGxpZXJfcGF5bWVudC0+c2F2ZSgpOwoKICAgICAgICAgICAgICAgICAgICAvL05vdGlmaWNhdGlvbiBzZW5kIHRvIGFjY291bnRzCiAgICAgICAgICAgICAgICAgICAgJG1lc3NhZ2UgPSAnPHNwYW4gY2xhc3M9Im5vdGlmaWNhdGlvbi1saW5rcyIgIGRhdGEtdGl0bGU9IlB1cmNoYXNlIE9yZGVyIERldGFpbHMiPlJlZmVyZW5jZSBObzonIC4gJHBvX2RhdGEtPnJlZmVyZW5jZV9ubyAuICcuIEEgUE8gaGFzIGJlZW4gc3VibWl0dGVkIHdpdGggYW4gYWR2YW5jZSBhbW91bnQgb2YgVEsgJyAuICRzdXBwbGllcl9wYXltZW50LT5wYXlfYW1vdW50IC4gJzwvc3Bhbj4nOwoKICAgICAgICAgICAgICAgICAgICBDcmVhdGVPclVwZGF0ZU5vdGlmaWNhdGlvbigkbWVzc2FnZSwgJ3VucmVhZCcsICcnLCBnZXRNYW5hZ2VySW5mbygnQWNjb3VudHMnLCBudWxsLCB0cnVlKSwgJ3NlbmQtdG8tYWNjb3VudHMnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy9VcGRhdGUgcmVxdWlzaXRpb24KICAgICAgICAgICAgUmVxdWlzaXRpb25JdGVtOjp3aGVyZUluKCdyZXF1aXNpdGlvbl9pZCcsICRyZXF1ZXN0LT5yZXF1aXNpdGlvbl9pZCkKICAgICAgICAgICAgLT53aGVyZUluKCd1aWQnLCAkY29sbGVjdFByb2R1Y3RJZCkKICAgICAgICAgICAgLT53aGVyZSgnaXNfc2VuZCcsICd5ZXMnKQogICAgICAgICAgICAtPndoZXJlKCdwb19nZW5lcmF0ZScsICdubycpCiAgICAgICAgICAgIC0+dXBkYXRlKFsKICAgICAgICAgICAgICAgICdwb19nZW5lcmF0ZScgPT4gJ3llcycKICAgICAgICAgICAgXSk7CgogICAgICAgICAgICBpZiAoaXNzZXQoJHJlcXVlc3QtPnJlcXVpc2l0aW9uX2lkWzBdKSkgewogICAgICAgICAgICAgICAgZm9yZWFjaCAoJHJlcXVlc3QtPnJlcXVpc2l0aW9uX2lkIGFzICRrZXkgPT4gJHJlcXVpc2l0aW9uX2lkKSB7CiAgICAgICAgICAgICAgICAgICAgUHVyY2hhc2VPcmRlclJlcXVpc2l0aW9uOjp1cGRhdGVPckNyZWF0ZShbCiAgICAgICAgICAgICAgICAgICAgICAgICdwdXJjaGFzZV9vcmRlcl9pZCcgPT4gJHBvX2RhdGEtPmlkLAogICAgICAgICAgICAgICAgICAgICAgICAncmVxdWlzaXRpb25faWQnID0+ICRyZXF1aXNpdGlvbl9pZCwKICAgICAgICAgICAgICAgICAgICBdLCBbCiAgICAgICAgICAgICAgICAgICAgICAgICdocl9kZXBhcnRtZW50X2lkJyA9PiBpc3NldCgkcmVxdWVzdC0+aHJfZGVwYXJ0bWVudF9pZCkgPyAkcmVxdWVzdC0+aHJfZGVwYXJ0bWVudF9pZCA6IDAsCiAgICAgICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgICAgICAgICAgLy9SZXF1aXNpdGlvbiB0cmFja2luZyB3aXRoIHJlcXVpc2l0b24gaWQKICAgICAgICAgICAgICAgICAgICBSZXF1aXNpdGlvblRyYWNraW5nOjpzdG9yZVJlcXVpc2l0aW9uVHJhY2tpbmcoJHJlcXVpc2l0aW9uX2lkLCAnUE8tSXNzdWUnKTsKCiAgICAgICAgICAgICAgICAgICAgLy9Ob3RpZmljYXRpb24gZ2VuZXJhdGUKICAgICAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb25Vc2VyID0gUmVxdWlzaXRpb246OndoZXJlKCdpZCcsICRyZXF1aXNpdGlvbl9pZCktPmZpcnN0KCk7CiAgICAgICAgICAgICAgICAgICAgJG1lc3NhZ2UgPSAnPHNwYW4gY2xhc3M9Im5vdGlmaWNhdGlvbi1saW5rcyIgIGRhdGEtdGl0bGU9IlB1cmNoYXNlIE9yZGVyIERldGFpbHMiPlBPIFJlZmVyZW5jZSBObyAjJyAuICRwb19kYXRhLT5yZWZlcmVuY2Vfbm8gLiAnLiBBIFBPIGhhcyBiZWVuIElzc3VlZCBhZ2FpbnN0IHlvdXIgcmVxdWlzaXRpb24gIycgLiAkcmVxdWlzaXRpb25Vc2VyLT5yZWZlcmVuY2Vfbm8gLiAnPC9zcGFuPic7CiAgICAgICAgICAgICAgICAgICAgQ3JlYXRlT3JVcGRhdGVOb3RpZmljYXRpb24oJG1lc3NhZ2UsICd1bnJlYWQnLCAnJywgWyRyZXF1aXNpdGlvblVzZXItPmF1dGhvcl9pZF0sICdyZXF1aXNpdGlvbicpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAkYXJyYXkgPSBbXTsKCiAgICAgICAgICAgIC8vUE8gR2VuZXJhdGUgRXF1YWxseSBkaXN0cmlidXRlCiAgICAgICAgICAgIGlmIChpc3NldCgkcmVxdWVzdC0+cHJvZHVjdF9pZFswXSkpIHsKICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRyZXF1ZXN0LT5wcm9kdWN0X2lkIGFzICRrZXkgPT4gJHVpZCkgewogICAgICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbl9xdHkgPSAoaXNzZXQoJHJlcXVlc3QtPnJlcXVpc2l0aW9uX3F0eVskdWlkXSkgPyAkcmVxdWVzdC0+cmVxdWlzaXRpb25fcXR5WyR1aWRdIDogMCk7CiAgICAgICAgICAgICAgICAgICAgJHBvX3F0eSA9IChpc3NldCgkcmVxdWVzdC0+cG9fcXR5WyR1aWRdKSA/ICRyZXF1ZXN0LT5wb19xdHlbJHVpZF0gOiAwKTsKICAgICAgICAgICAgICAgICAgICAkcGVyY2VudGFnZSA9ICgkcmVxdWlzaXRpb25fcXR5ID4gMCAmJiAkcG9fcXR5ID4gMCA/ICgoJHBvX3F0eSAvICRyZXF1aXNpdGlvbl9xdHkpICogMTAwKSA6IDApOwoKICAgICAgICAgICAgICAgICAgICBpZiAoaXNzZXQoJHJlcXVlc3QtPnJlcXVpc2l0aW9uX2lkWzBdKSkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3JlYWNoICgkcmVxdWVzdC0+cmVxdWlzaXRpb25faWQgYXMgJGtleSA9PiAkcmVxdWlzaXRpb25faWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbkl0ZW1zID0gUmVxdWlzaXRpb25JdGVtOjp3aGVyZSgncmVxdWlzaXRpb25faWQnLCAkcmVxdWlzaXRpb25faWQpLT53aGVyZSgndWlkJywgJHVpZCktPmdldCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzc2V0KCRyZXF1aXNpdGlvbkl0ZW1zWzBdKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRyZXF1aXNpdGlvbkl0ZW1zIGFzICRrZXkgPT4gJHJlcXVpc2l0aW9uSXRlbSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHBvX3F0eSA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR0aGlzX3BvX3F0eSA9IHJvdW5kKCgkcGVyY2VudGFnZSA+IDAgPyAoJHJlcXVpc2l0aW9uSXRlbS0+cXR5ICogKCRwZXJjZW50YWdlIC8gMTAwKSkgOiAwKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkdGhpc19wb19xdHkgPSAoJHRoaXNfcG9fcXR5ID4gJHBvX3F0eSA/ICRwb19xdHkgOiAkdGhpc19wb19xdHkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbkl0ZW0tPnB1cmNoYXNlX3F0eSA9ICR0aGlzX3BvX3F0eTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbkl0ZW0tPnNhdmUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcG9fcXR5ID0gKCRwb19xdHkgLSAkdGhpc19wb19xdHkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHBvX3F0eSA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbkl0ZW0gPSBSZXF1aXNpdGlvbkl0ZW06OndoZXJlKCdyZXF1aXNpdGlvbl9pZCcsICRyZXF1aXNpdGlvbl9pZCktPndoZXJlKCd1aWQnLCAkdWlkKS0+Zmlyc3QoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbkl0ZW0tPnB1cmNoYXNlX3F0eSA9ICgkcmVxdWlzaXRpb25JdGVtLT5wdXJjaGFzZV9xdHkgKyByb3VuZCgkcG9fcXR5KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb25JdGVtLT5zYXZlKCk7CgogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgoKICAgICAgICAgICAgJG1pbGVzdG9uZXMgPSBbXTsKICAgICAgICAgICAgaWYoaXNzZXQoJHJlcXVlc3QtPm1pbGVzdG9uZV9uYW1lc1swXSkpewogICAgICAgICAgICAgICAgZm9yZWFjaCgkcmVxdWVzdC0+bWlsZXN0b25lX25hbWVzIGFzICRrZXkgPT4gJG1pbGVzdG9uZSl7CiAgICAgICAgICAgICAgICAgICAgYXJyYXlfcHVzaCgkbWlsZXN0b25lcywgWwogICAgICAgICAgICAgICAgICAgICAgICAncHVyY2hhc2Vfb3JkZXJfaWQnID0+ICRwb19kYXRhLT5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgJ25hbWUnID0+ICRyZXF1ZXN0LT5taWxlc3RvbmVfbmFtZXNbJGtleV0sCiAgICAgICAgICAgICAgICAgICAgICAgICdwZXJjZW50YWdlJyA9PiAkcmVxdWVzdC0+bWlsZXN0b25lX3BlcmNlbnRhZ2VzWyRrZXldLAogICAgICAgICAgICAgICAgICAgIF0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKGlzc2V0KCRtaWxlc3RvbmVzWzBdKSl7CiAgICAgICAgICAgICAgICBQdXJjaGFzZU9yZGVyTWlsZXN0b25lOjppbnNlcnQoJG1pbGVzdG9uZXMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBEQjo6Y29tbWl0KCk7CgogICAgICAgICAgICByZXR1cm4gJHRoaXMtPnJlZGlyZWN0QmFja1dpdGhTdWNjZXNzKCdQdXJjaGFzZSBPcmRlciBoYXMgYmVlbiBnZW5lcmF0ZWQgc3VjY2Vzc2Z1bGx5IScsICdwbXMucHVyY2hhc2Uub3JkZXItaW5kZXgnKTsKCiAgICAgICAgfSBjYXRjaCAoXFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgREI6OnJvbGxiYWNrKCk7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBiYWNrKCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBEaXNwbGF5IGEgbGlzdGluZyBvZiB0aGUgcmVzb3VyY2UuCiAgICAgKgogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KCiAgICBwdWJsaWMgZnVuY3Rpb24gY29tcGxldGVRdW90YXRpb24oUmVxdWVzdCAkcmVxdWVzdCkKICAgIHsKICAgICAgICAkcmVzcG9uc2UgPSBbXTsKICAgICAgICAkZGF0YSA9IFF1b3RhdGlvbnM6OndoZXJlKCdpZCcsICRyZXF1ZXN0LT5xdW90YXRpb25faWQpLT5maXJzdCgpOwogICAgICAgIC8vU3RhcnQgdHJhbnNhY3Rpb24KICAgICAgICBEQjo6YmVnaW5UcmFuc2FjdGlvbigpOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmICghZW1wdHkoJGRhdGEpKSB7CiAgICAgICAgICAgICAgICAkZGF0YS0+aXNfcG9fZ2VuZXJhdGUgPSAneWVzJzsKICAgICAgICAgICAgICAgICRkYXRhLT5zYXZlKCk7CiAgICAgICAgICAgICAgICAvL0NvbW1pdCBkYXRhCiAgICAgICAgICAgICAgICBEQjo6Y29tbWl0KCk7CgogICAgICAgICAgICAgICAgJHJlc3BvbnNlWydyZXN1bHQnXSA9ICdzdWNjZXNzJzsKICAgICAgICAgICAgICAgICRyZXNwb25zZVsnbWVzc2FnZSddID0gJ1N1Y2Nlc3NmdWxseSBDb21wbGV0ZSBUaGlzIFF1b3RhdGlvbiEhJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICRyZXNwb25zZVsncmVzdWx0J10gPSAnZXJyb3InOwogICAgICAgICAgICAgICAgJHJlc3BvbnNlWydtZXNzYWdlJ10gPSAnRGF0YSBub3QgZm91bmQuISEnOwogICAgICAgICAgICB9CgogICAgICAgIH0gY2F0Y2ggKFxUaHJvd2FibGUgJHRoKSB7CiAgICAgICAgICAgIC8vSWYgcHJvY2VzcyBoYXMgYW55IHByb2JsZW0gdGhlbiByb2xsYmFjayB0aGUgZGF0YQogICAgICAgICAgICBEQjo6cm9sbGJhY2soKTsKICAgICAgICAgICAgJHJlc3BvbnNlWydyZXN1bHQnXSA9ICdlcnJvcic7CiAgICAgICAgICAgICRyZXNwb25zZVsnbWVzc2FnZSddID0gJHRoLT5nZXRNZXNzYWdlKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiAkcmVzcG9uc2U7CiAgICB9CgogICAgLyoqCiAgICAgKiBEaXNwbGF5IHRoZSBzcGVjaWZpZWQgcmVzb3VyY2UuCiAgICAgKgogICAgICogQHBhcmFtIGludCAkaWQKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCgoKICAgIHB1YmxpYyBmdW5jdGlvbiBwcm9wb3NhbERldGFpbHNWaWV3KCRpZCkKICAgIHsKICAgICAgICAkdGl0bGUgPSAnUmVxdWVzdHMgUHJvcG9zYWwgRGV0YWlscyc7CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgICRyZXF1ZXN0UHJvcG9zYWwgPSBSZXF1ZXN0UHJvcG9zYWw6OndpdGgoWwogICAgICAgICAgICAgICAgJ2RlZmluZVRvU3VwcGxpZXInLAogICAgICAgICAgICAgICAgJ3JlcXVlc3RQcm9wb3NhbERldGFpbHMucHJvZHVjdC5jYXRlZ29yeS5jYXRlZ29yeScsCiAgICAgICAgICAgICAgICAncmVxdWVzdFByb3Bvc2FsRGV0YWlscy5wcm9kdWN0LnByb2R1Y3RVbml0JywKICAgICAgICAgICAgICAgICdyZXF1ZXN0UHJvcG9zYWxEZXRhaWxzLnByb2R1Y3QuYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24uYXR0cmlidXRlJywKICAgICAgICAgICAgICAgICdjcmVhdGVkQnknCiAgICAgICAgICAgIF0pLT5maW5kT3JGYWlsKCRpZCk7CgogICAgICAgICAgICAkcmVxdWlzaXRpb25JdGVtcyA9IFJlcXVpc2l0aW9uSXRlbTo6d2l0aChbCiAgICAgICAgICAgICAgICAnYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24uYXR0cmlidXRlJwogICAgICAgICAgICBdKQogICAgICAgICAgICAtPndoZXJlSGFzKCdyZXF1aXNpdGlvbi5yZXF1ZXN0UHJvcG9zYWxSZXF1aXNpdGlvbicsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRyZXF1ZXN0UHJvcG9zYWwpewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ3JlcXVlc3RfcHJvcG9zYWxfaWQnLCAkcmVxdWVzdFByb3Bvc2FsLT5pZCk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+Z2V0KCk7CgogICAgICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMucmZwLnJlcXVlc3QtcHJvcG9zYWwtZGV0YWlscycsIGNvbXBhY3QoJ3RpdGxlJywgJ3JlcXVlc3RQcm9wb3NhbCcsICdyZXF1aXNpdGlvbkl0ZW1zJykpOwogICAgICAgIH0gY2F0Y2ggKFxUaHJvd2FibGUgJHRoKSB7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogRGlzcGxheSB0aGUgc3BlY2lmaWVkIHJlc291cmNlLgogICAgICoKICAgICAqIEBwYXJhbSBpbnQgJGlkCiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwoKICAgIHB1YmxpYyBmdW5jdGlvbiBjc0hpc3RvcnkoJGlkKQogICAgewogICAgICAgIHRyeSB7CgogICAgICAgICAgICAkdGl0bGUgPSAiQ1MgSGlzdG9yeSI7CiAgICAgICAgICAgICRwcm9wb3NhbHMgPSBSZXF1ZXN0UHJvcG9zYWw6OndpdGgoJ3JlbFF1b3RhdGlvbnMnKS0+d2hlcmUoJ2lkJywgJGlkKS0+b3JkZXJieSgnaWQnLCAnZGVzYycpLT5maXJzdCgpOwoKICAgICAgICAgICAgaWYgKGNvdW50KCRwcm9wb3NhbHMtPnJlbFF1b3RhdGlvbnMpID4gMCkgewogICAgICAgICAgICAgICAgJHB1cmNoYXNlID0gJHByb3Bvc2Fscy0+cmVsUXVvdGF0aW9ucygpLT53aXRoKCdyZWxQdXJjaGFzZU9yZGVyJyktPmZpcnN0KCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICRwdXJjaGFzZU9yZGVyID0gaXNzZXQoJHB1cmNoYXNlKSA/ICghZW1wdHkoJHB1cmNoYXNlLT5yZWxQdXJjaGFzZU9yZGVyKSA/ICRwdXJjaGFzZS0+cmVsUHVyY2hhc2VPcmRlciA6ICcnKSA6ICcnOwoKICAgICAgICAgICAgaWYgKCFlbXB0eSgkcHVyY2hhc2VPcmRlcikpIHsKICAgICAgICAgICAgICAgICRiaWxsTWFuYWdlID0gUHVyY2hhc2VPcmRlcjo6d2l0aChbCiAgICAgICAgICAgICAgICAgICAgJ3JlbEdvb2RSZWNlaXZlTm90ZScsCiAgICAgICAgICAgICAgICAgICAgJ3JlbEdvb2RzUmVjZWl2ZWRJdGVtU3RvY2tJbicsCiAgICAgICAgICAgICAgICAgICAgJ3JlbFF1b3RhdGlvbi5yZWxTdXBwbGllcnMnLAogICAgICAgICAgICAgICAgICAgICdyZWxRdW90YXRpb24uZXhjaGFuZ2VSYXRlLmN1cnJlbmN5JywKICAgICAgICAgICAgICAgICAgICAncmVsUHVyY2hhc2VPcmRlckl0ZW1zJywKICAgICAgICAgICAgICAgICAgICAncmVsUG9BdHRhY2htZW50JwogICAgICAgICAgICAgICAgXSkKICAgICAgICAgICAgICAgICAgICAtPndoZXJlKCdpc19zZW5kJywgJ3llcycpCiAgICAgICAgICAgICAgICAgICAgLT53aGVyZUhhcygncmVsR29vZFJlY2VpdmVOb3RlJywgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlUmF3KCdwdXJjaGFzZV9vcmRlcnMuaWQ9Z29vZHNfcmVjZWl2ZWRfbm90ZXMucHVyY2hhc2Vfb3JkZXJfaWQnKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+d2hlcmVIYXMoJ3JlbEdvb2RzUmVjZWl2ZWRJdGVtU3RvY2tJbicsIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2lzX2dybl9jb21wbGV0ZScsICd5ZXMnKS0+d2hlcmUoJ3RvdGFsX2Ftb3VudCcsICc+JywgMCk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPndoZXJlKCdpZCcsICRwdXJjaGFzZU9yZGVyLT5pZCkKICAgICAgICAgICAgICAgICAgICAtPmZpcnN0KCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAkYmlsbE1hbmFnZSA9ICcnOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMucmZwLnJmcC1oaXN0b3J5JywgY29tcGFjdCgndGl0bGUnLCAncHVyY2hhc2VPcmRlcicsICdwcm9wb3NhbHMnLCAnYmlsbE1hbmFnZScpKTsKICAgICAgICB9IGNhdGNoIChcVGhyb3dhYmxlICR0aCkgewogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoV2FybmluZygkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKCiAgICBwdWJsaWMgZnVuY3Rpb24gYmFyZ2FpbkhlYWRlckNvbHVtbnMoJHZhbHVlID0gJycpCiAgICB7CiAgICAgICAgcmV0dXJuIGFycmF5KAogICAgICAgICAgICBbJ1NMJywgJ1NMJ10sCiAgICAgICAgICAgIFsncXVvdGF0aW9uX2RhdGUnLCAncXVvdGF0aW9uX2RhdGUnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydyZWZlcmVuY2Vfbm8nLCAncmVmZXJlbmNlX25vJywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsnc3VwcGxpZXInLCAnc3VwcGxpZXInLCAndGV4dC1sZWZ0J10sCiAgICAgICAgICAgIFsnY3VycmVuY3knLCAnY3VycmVuY3knLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWyd0b3RhbF9wcmljZScsICd0b3RhbF9wcmljZScsICd0ZXh0LXJpZ2h0J10sCiAgICAgICAgICAgIFsnZGlzY291bnQnLCAnZGlzY291bnQnLCAndGV4dC1yaWdodCddLAogICAgICAgICAgICBbJ3ZhdCcsICd2YXQnLCAndGV4dC1yaWdodCddLAogICAgICAgICAgICBbJ2dyb3NzX3ByaWNlJywgJ2dyb3NzX3ByaWNlJywgJ3RleHQtcmlnaHQnXSwKICAgICAgICAgICAgWydhY3Rpb25zJywgJ2FjdGlvbnMnLCAndGV4dC1jZW50ZXInXQogICAgICAgICk7CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIGJhcmdhaW5IaXN0b3J5KCRpZCkKICAgIHsKICAgICAgICAkdGl0bGUgPSAnUXVvdGF0aW9ucyBMaXN0JzsKICAgICAgICB0cnkgewoKICAgICAgICAgICAgJHF1b3RhdGlvbnMgPSBRdW90YXRpb25IaXN0b3J5Ojp3aXRoKFsKICAgICAgICAgICAgICAgICdxdW90YXRpb24ucmVsUmVxdWVzdFByb3Bvc2FsJywKICAgICAgICAgICAgICAgICdxdW90YXRpb24ucmVsU3VwcGxpZXJzJywKICAgICAgICAgICAgICAgICdxdW90YXRpb24uZXhjaGFuZ2VSYXRlLmN1cnJlbmN5JywKICAgICAgICAgICAgXSkKICAgICAgICAgICAgICAgIC0+d2hlcmUoJ3F1b3RhdGlvbl9pZCcsICRpZCkKICAgICAgICAgICAgICAgIC0+d2hlbighZGF0YXRhYmxlT3JkZXJpbmcoKSwgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyYnkoJ2lkJywgJ2Rlc2MnKTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgaWYgKHJlcXVlc3QoKS0+YWpheCgpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gRGF0YVRhYmxlczo6b2YoJHF1b3RhdGlvbnMpCiAgICAgICAgICAgICAgICAgICAgLT5hZGRJbmRleENvbHVtbigpCiAgICAgICAgICAgICAgICAgICAgLT5lZGl0Q29sdW1uKCdxdW90YXRpb25fZGF0ZScsIGZ1bmN0aW9uICgkdmFsdWVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkYXRlKCdZLW0tZCcsIHN0cnRvdGltZSgkdmFsdWVzLT5xdW90YXRpb25fZGF0ZSkpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3F1b3RhdGlvbl9kYXRlJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgncXVvdGF0aW9uX2RhdGUnLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ3F1b3RhdGlvbl9kYXRlJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyQnkoJ3F1b3RhdGlvbl9kYXRlJywgJG9yZGVyKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdyZWZlcmVuY2Vfbm8nLCBmdW5jdGlvbiAoJHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgb25jbGljaz0ib3Blbk1vZGFsKCcgLiAkdmFsdWVzLT5pZCAuICcpIiAgY2xhc3M9ImJ0biBidG4tbGluayI+JyAuICR2YWx1ZXMtPnF1b3RhdGlvbi0+cmVmZXJlbmNlX25vIC4gJzwvYT4nOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3JlZmVyZW5jZV9ubycsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdxdW90YXRpb24nLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdyZWZlcmVuY2Vfbm8nLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignc3VwcGxpZXInLCBmdW5jdGlvbiAoJHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHZhbHVlcy0+cXVvdGF0aW9uLT5yZWxTdXBwbGllcnMtPm5hbWUgLiAnICgnIC4gJHZhbHVlcy0+cXVvdGF0aW9uLT5yZWxTdXBwbGllcnMtPmNvZGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC4gJyknOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3N1cHBsaWVyJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3F1b3RhdGlvbi5yZWxTdXBwbGllcnMnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2N1cnJlbmN5JywgZnVuY3Rpb24gKCR2YWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzc2V0KCR2YWx1ZXMtPnF1b3RhdGlvbi0+ZXhjaGFuZ2VSYXRlLT5jdXJyZW5jeS0+Y29kZSkgPwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHZhbHVlcy0+ZXhjaGFuZ2VSYXRlLT5jdXJyZW5jeS0+Y29kZSA6ICcnOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ2N1cnJlbmN5JywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3F1b3RhdGlvbi5leGNoYW5nZVJhdGUuY3VycmVuY3knLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdjb2RlJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5lZGl0Q29sdW1uKCd0b3RhbF9wcmljZScsIGZ1bmN0aW9uICgkdmFsdWVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudW1iZXJfZm9ybWF0KCR2YWx1ZXMtPnRvdGFsX3ByaWNlLCAyKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZWRpdENvbHVtbignZ3Jvc3NfcHJpY2UnLCBmdW5jdGlvbiAoJHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVtYmVyX2Zvcm1hdCgkdmFsdWVzLT5ncm9zc19wcmljZSwgMik7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmVkaXRDb2x1bW4oJ3N0YXR1cycsIGZ1bmN0aW9uICgkdmFsdWVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB1Y2ZpcnN0KCR2YWx1ZXMtPnN0YXR1cyk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmVkaXRDb2x1bW4oJ3R5cGUnLCBmdW5jdGlvbiAoJHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdWNmaXJzdCgkdmFsdWVzLT50eXBlKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdhY3Rpb25zJywgZnVuY3Rpb24gKCR2YWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgPSAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgb25jbGljaz0ib3Blbk1vZGFsKCcgLiAkdmFsdWVzLT5pZCAuICcpIiAgY2xhc3M9ImJ0biBidG4teHMgYnRuLWluZm8iPjxpIGNsYXNzPSJsYXMgbGEtZXllIj48L2k+PC9hPic7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkYWN0aW9uczsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+cmF3Q29sdW1ucyhbJ3JlZmVyZW5jZV9ubycsICdhY3Rpb25zJ10pCiAgICAgICAgICAgICAgICAgICAgLT5tYWtlKHRydWUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMucXVvdGF0aW9uLmJhcmdhaW4taGlzdG9yeScsIFsKICAgICAgICAgICAgICAgICd0aXRsZScgPT4gJHRpdGxlLAogICAgICAgICAgICAgICAgJ2hlYWRlckNvbHVtbnMnID0+ICR0aGlzLT5iYXJnYWluSGVhZGVyQ29sdW1ucygpCiAgICAgICAgICAgIF0pOwogICAgICAgIH0gY2F0Y2ggKFxUaHJvd2FibGUgJHRoKSB7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBxdW90YXRpb25IaXN0b3J5SXRlbXMoJGlkKQogICAgewogICAgICAgICR0aXRsZSA9ICJRdW90YXRpb24gd2lzZSBpdGVtcyI7CiAgICAgICAgJHF1b3RhdGlvbiA9IFF1b3RhdGlvbkhpc3Rvcnk6OndpdGgoWwogICAgICAgICAgICAncXVvdGF0aW9uJywKICAgICAgICAgICAgJ2l0ZW1zLnJlbFByb2R1Y3QuYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24uYXR0cmlidXRlJwogICAgICAgIF0pLT5maW5kT3JGYWlsKCRpZCk7CgogICAgICAgICRyZXF1aXNpdGlvbkl0ZW1zID0gUmVxdWlzaXRpb25JdGVtOjp3aXRoKFsKICAgICAgICAgICAgJ2F0dHJpYnV0ZXMuYXR0cmlidXRlT3B0aW9uLmF0dHJpYnV0ZScKICAgICAgICBdKQogICAgICAgIC0+d2hlcmVIYXMoJ3JlcXVpc2l0aW9uLnJlcXVlc3RQcm9wb3NhbFJlcXVpc2l0aW9uJywgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJHF1b3RhdGlvbil7CiAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdyZXF1ZXN0X3Byb3Bvc2FsX2lkJywgJHF1b3RhdGlvbi0+cXVvdGF0aW9uLT5yZXF1ZXN0X3Byb3Bvc2FsX2lkKTsKICAgICAgICB9KQogICAgICAgIC0+Z2V0KCk7CgogICAgICAgICRzeXN0ZW1DdXJyZW5jeSA9IHN5c3RlbUN1cnJlbmN5KCk7CiAgICAgICAgJGV4Y2hhbmdlUmF0ZSA9IGV4Y2hhbmdlUmF0ZSgkcXVvdGF0aW9uLT5xdW90YXRpb24tPmV4Y2hhbmdlUmF0ZSwgJHN5c3RlbUN1cnJlbmN5LT5pZCk7CiAgICAgICAgJHNhbWUgPSAoJHF1b3RhdGlvbi0+cXVvdGF0aW9uLT5leGNoYW5nZVJhdGUtPmN1cnJlbmN5X2lkID09ICRzeXN0ZW1DdXJyZW5jeS0+aWQgPyB0cnVlIDogZmFsc2UpOwoKICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMucXVvdGF0aW9uLmhpc3RvcnktaXRlbS1zaG93JywgY29tcGFjdCgncXVvdGF0aW9uJywgJ3RpdGxlJywgJ3N5c3RlbUN1cnJlbmN5JywnZXhjaGFuZ2VSYXRlJywgJ3NhbWUnLCAncmVxdWlzaXRpb25JdGVtcycpKTsKICAgICAgICB9IGNhdGNoIChcVGhyb3dhYmxlICR0aCkgewogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCn0K