<?php
bolt_decrypt( __FILE__ , 'dXKDpE'); return 0;
##!!!##CgpuYW1lc3BhY2UgQXBwXEh0dHBcQ29udHJvbGxlcnNcUG1zOwoKdXNlIEFwcFxIdHRwXENvbnRyb2xsZXJzXENvbnRyb2xsZXI7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xJbnZlbnRvcnlNb2RlbHNcSW52ZW50b3J5QWN0aW9uQ29udHJvbDsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFByb2R1Y3Q7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xXYXJlaG91c2VzOwp1c2UgSWxsdW1pbmF0ZVxIdHRwXFJlcXVlc3Q7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xQdXJjaGFzZVxQdXJjaGFzZU9yZGVyOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUHVyY2hhc2VcUHVyY2hhc2VPcmRlckl0ZW07CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xHcm5cR29vZHNSZWNlaXZlZE5vdGU7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xHcm5cR29vZHNSZWNlaXZlZEl0ZW07CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xHcm5cR29vZHNSZWNlaXZlZEl0ZW1TdG9ja0luOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUHVyY2hhc2VSZXR1cm47CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xQdXJjaGFzZVJldHVybkdhdGVPdXQ7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xQdXJjaGFzZVxQdXJjaGFzZU9yZGVyUmVxdWlzaXRpb247CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xSZXF1aXNpdGlvbkl0ZW07CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xSZXF1aXNpdGlvblRyYWNraW5nOwp1c2UgSWxsdW1pbmF0ZVxTdXBwb3J0XEZhY2FkZXNcTWFpbDsKdXNlIERCLCBBdXRoLCBEYXRhVGFibGVzOwoKY2xhc3MgU2VydmljZUNvbmZpcm1hdGlvbkNvbnRyb2xsZXIgZXh0ZW5kcyBDb250cm9sbGVyCnsKICAgIHB1YmxpYyBmdW5jdGlvbiBoZWFkZXJDb2x1bW5zKCR2YWx1ZSA9ICcnKQogICAgewogICAgICAgIHJldHVybiAkYXJyYXkgPSBhcnJheSgKICAgICAgICAgICAgWydTTCcsICdTTCddLAogICAgICAgICAgICBbJ2FwcHJvdmFsX2RhdGUnLCAnYXBwcm92YWxfZGF0ZScsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3JlZmVyZW5jZV9ubycsICdyZWZlcmVuY2Vfbm8nLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydzdXBwbGllcicsICdzdXBwbGllcicsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3F1b3RhdGlvbl9yZWZfbm8nLCAncXVvdGF0aW9uX3JlZl9ubycsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3NlcnZpY2VzJywgJ3NlcnZpY2VzJ10sCiAgICAgICAgICAgIC8vIFsndG90YWxfcHJpY2UnLCAndG90YWxfcHJpY2UnLCAndGV4dC1yaWdodCddLCAKICAgICAgICAgICAgLy8gWyd2YXQnLCAndmF0JywgJ3RleHQtcmlnaHQnXSwKICAgICAgICAgICAgLy8gWydncm9zc19wcmljZScsICdncm9zc19wcmljZScsICd0ZXh0LXJpZ2h0J10sCiAgICAgICAgICAgIFsnYWN0aW9ucycsICdhY3Rpb25zJywgJ3RleHQtY2VudGVyJywgJ3dpZHRoOjE1JSddCiAgICAgICAgKTsKICAgIH0KCiAgICAvKioKICAgICAqIERpc3BsYXkgYSBsaXN0aW5nIG9mIHRoZSByZXNvdXJjZS4KICAgICAqCiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwogICAgcHVibGljIGZ1bmN0aW9uIGluZGV4KFJlcXVlc3QgJHJlcXVlc3QpCiAgICB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgJHRpdGxlID0gJ1NlcnZpY2UgQ29uZmlybWF0aW9uJzsKICAgICAgICAgICAgJHB1cmNoYXNlT3JkZXJzID0gUHVyY2hhc2VPcmRlcjo6d2l0aChbCiAgICAgICAgICAgICAgICAncmVsUHVyY2hhc2VPcmRlckl0ZW1zLnJlbFByb2R1Y3QnLAogICAgICAgICAgICAgICAgJ3JlbEdvb2RSZWNlaXZlTm90ZS5yZWxHb29kc1JlY2VpdmVkSXRlbXMnLAogICAgICAgICAgICAgICAgJ3JlbFF1b3RhdGlvbicsCiAgICAgICAgICAgICAgICAncHVyY2hhc2VPcmRlclJlcXVpc2l0aW9ucy5yZXF1aXNpdGlvbi5yZXF1aXNpdGlvbkl0ZW1zLnByb2R1Y3QnCiAgICAgICAgICAgIF0pCi8vICAgICAgICAgICAgICAgIC0+d2hlbighYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ0dhdGUgUGVybWlzc2lvbicpLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7Ci8vICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVuKGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdEZXBhcnRtZW50LUhlYWQnKSAmJiAhYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ1N0b3JlLU1hbmFnZXInKSwgZnVuY3Rpb24gKCRxdWVyeSkgewovLyAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdwdXJjaGFzZU9yZGVyUmVxdWlzaXRpb25zJywgZnVuY3Rpb24gKCRxdWVyeSkgewovLyAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUluKCdocl9kZXBhcnRtZW50X2lkJywgYXV0aCgpLT51c2VyKCktPnByaW9yaXRpZXMtPnBsdWNrKCdocl9kZXBhcnRtZW50X2lkJyktPnRvQXJyYXkoKSk7Ci8vICAgICAgICAgICAgICAgICAgICAgICAgfSk7Ci8vICAgICAgICAgICAgICAgICAgICB9KQovLyAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlbighYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ0RlcGFydG1lbnQtSGVhZCcpIHx8IGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdTdG9yZS1NYW5hZ2VyJyksIGZ1bmN0aW9uICgkcXVlcnkpIHsKLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3B1cmNoYXNlT3JkZXJSZXF1aXNpdGlvbnMnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7Ci8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnaHJfZGVwYXJ0bWVudF9pZCcsIDApOwovLyAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKLy8gICAgICAgICAgICAgICAgICAgICAgICB9KTsKLy8gICAgICAgICAgICAgICAgfSkKLy8gICAgICAgICAgICAgICAgLT53aGVuKGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdHYXRlIFBlcm1pc3Npb24nKSwgZnVuY3Rpb24gKCRxdWVyeSkgewovLyAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVJbignaHJfdW5pdF9pZCcsIGF1dGgoKS0+dXNlcigpLT5wcmlvcml0aWVzLT5wbHVjaygnaHJfdW5pdF9pZCcpLT50b0FycmF5KCkpOwovLyAgICAgICAgICAgICAgICB9KQoKLy8gICAgICAgICAgICAtPndoZXJlSGFzKCdyZWxRdW90YXRpb24nLCBmdW5jdGlvbigkcXVlcnkpewovLyAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZU5vdEluKCd0eXBlJyxbJ2RpcmVjdC1wdXJjaGFzZSddKTsKLy8gICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT53aGVyZUhhcygncHVyY2hhc2VPcmRlclJlcXVpc2l0aW9ucy5yZXF1aXNpdGlvbicsIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnYXV0aG9yX2lkJywgYXV0aCgpLT51c2VyKCktPmlkKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPndoZXJlSGFzKCdwdXJjaGFzZU9yZGVyUmVxdWlzaXRpb25zLnJlcXVpc2l0aW9uLnJlcXVpc2l0aW9uSXRlbXMucHJvZHVjdCcsIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnaXNfc2VydmljZScsIDEpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+d2hlcmVJbignaXNfc2VuZCcsIFsneWVzJ10pCiAgICAgICAgICAgICAgICAtPmdldCgpOwoKICAgICAgICAgICAgJGlkcyA9IFtdOwogICAgICAgICAgICBpZiAoJHB1cmNoYXNlT3JkZXJzLT5jb3VudCgpID4gMCkgewogICAgICAgICAgICAgICAgZm9yZWFjaCAoJHB1cmNoYXNlT3JkZXJzIGFzICRrZXkgPT4gJHB1cmNoYXNlT3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoJHB1cmNoYXNlT3JkZXItPnJlbFB1cmNoYXNlT3JkZXJJdGVtcy0+Y291bnQoKSA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yZWFjaCAoJHB1cmNoYXNlT3JkZXItPnJlbFB1cmNoYXNlT3JkZXJJdGVtcyBhcyAka2V5ID0+ICRpdGVtKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJGl0ZW0tPnJlbFByb2R1Y3QtPmlzX3NlcnZpY2UgPT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRyZWNlaXZlZF9xdHkgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkcHVyY2hhc2VPcmRlci0+cmVsR29vZFJlY2VpdmVOb3RlLT5jb3VudCgpID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JlYWNoICgkcHVyY2hhc2VPcmRlci0+cmVsR29vZFJlY2VpdmVOb3RlIGFzICRrZXkgPT4gJGdybikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHJlY2VpdmVkX3F0eSArPSAkZ3JuLT5yZWxHb29kc1JlY2VpdmVkSXRlbXMtPndoZXJlKCdwcm9kdWN0X2lkJywgJGl0ZW0tPnByb2R1Y3RfaWQpLT5zdW0oJ3JlY2VpdmVkX3F0eScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJGl0ZW0tPnF0eSA+ICRyZWNlaXZlZF9xdHkgJiYgIWluX2FycmF5KCRwdXJjaGFzZU9yZGVyLT5pZCwgJGlkcykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXlfcHVzaCgkaWRzLCAkcHVyY2hhc2VPcmRlci0+aWQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgJHB1cmNoYXNlT3JkZXJzID0gUHVyY2hhc2VPcmRlcjo6d2hlcmVJbignaWQnLCAkaWRzKQogICAgICAgICAgICAgICAgLT53aXRoKFsKICAgICAgICAgICAgICAgICAgICAncmVsUXVvdGF0aW9uLnJlbFN1cHBsaWVycycsCiAgICAgICAgICAgICAgICAgICAgJ3JlbFF1b3RhdGlvbi5leGNoYW5nZVJhdGUuY3VycmVuY3knLAogICAgICAgICAgICAgICAgICAgICdyZWxQb0F0dGFjaG1lbnQnLAogICAgICAgICAgICAgICAgICAgICdyZWxTdXBwbGllclBheW1lbnRzJywKICAgICAgICAgICAgICAgICAgICAncmVsUHVyY2hhc2VPcmRlckl0ZW1zLnJlbFByb2R1Y3QuYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24uYXR0cmlidXRlJywKICAgICAgICAgICAgICAgICAgICAncmVsR29vZFJlY2VpdmVOb3RlLnJlbEdvb2RzUmVjZWl2ZWRJdGVtcycKICAgICAgICAgICAgICAgIF0pCiAgICAgICAgICAgICAgICAtPndoZW4oIWRhdGF0YWJsZU9yZGVyaW5nKCksIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT5vcmRlcmJ5KCdpZCcsICdkZXNjJyk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGlmIChyZXF1ZXN0KCktPmFqYXgoKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIERhdGFUYWJsZXM6Om9mKCRwdXJjaGFzZU9yZGVycykKICAgICAgICAgICAgICAgICAgICAtPmFkZEluZGV4Q29sdW1uKCkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignYXBwcm92YWxfZGF0ZScsIGZ1bmN0aW9uICgkcG8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRhdGUoJ1ktbS1kJywgc3RydG90aW1lKCRwby0+cG9fZGF0ZSkpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ2FwcHJvdmFsX2RhdGUnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdwb19kYXRlJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdhcHByb3ZhbF9kYXRlJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyQnkoJ3BvX2RhdGUnLCAkb3JkZXIpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5lZGl0Q29sdW1uKCdyZWZlcmVuY2Vfbm8nLCBmdW5jdGlvbiAoJHBvKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnPGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiBvbmNsaWNrPSJwdXJjaGFzZU9yZGVyRGV0YWlscygkKHRoaXMpKSIgY2xhc3M9ImJ0biBidG4tbGluayIgZGF0YS1zcmM9IicgLiByb3V0ZSgncG1zLnB1cmNoYXNlLm9yZGVyLWxpc3Quc2hvdycsICRwby0+aWQpIC4gJyI+JyAuICRwby0+cmVmZXJlbmNlX25vIC4gJzwvYT4nOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3N1cHBsaWVyJywgZnVuY3Rpb24gKCRwbykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNzZXQoJHBvLT5yZWxRdW90YXRpb24tPnJlbFN1cHBsaWVycykgPyAoaXNzZXQoJHBvLT5yZWxRdW90YXRpb24tPnJlbFN1cHBsaWVycy0+bmFtZSkgPyAkcG8tPnJlbFF1b3RhdGlvbi0+cmVsU3VwcGxpZXJzLT5uYW1lIC4gJyAoJyAuICRwby0+cmVsUXVvdGF0aW9uLT5yZWxTdXBwbGllcnMtPmNvZGUgLiAnKScgOiAnJykgOiAnJzsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdzdXBwbGllcicsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxRdW90YXRpb24ucmVsU3VwcGxpZXJzJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5vcldoZXJlKCdjb2RlJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbignc3VwcGxpZXInLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgUXVvdGF0aW9uczo6c2VsZWN0KCdzdXBwbGllcnMubmFtZScpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ3N1cHBsaWVycycsICdzdXBwbGllcnMuaWQnLCAnPScsICdxdW90YXRpb25zLnN1cHBsaWVyX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3F1b3RhdGlvbnMuaWQnLCAncHVyY2hhc2Vfb3JkZXJzLnF1b3RhdGlvbl9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdxdW90YXRpb25fcmVmX25vJywgZnVuY3Rpb24gKCRwbykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNzZXQoJHBvLT5yZWxRdW90YXRpb24tPnJlZmVyZW5jZV9ubykgPyAkcG8tPnJlbFF1b3RhdGlvbi0+cmVmZXJlbmNlX25vIDogJyc7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbigncXVvdGF0aW9uX3JlZl9ubycsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxRdW90YXRpb24nLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdyZWZlcmVuY2Vfbm8nLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdxdW90YXRpb25fcmVmX25vJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwbGVhc2VTb3J0TWUoJHF1ZXJ5LCAkb3JkZXIsIFF1b3RhdGlvbnM6OnNlbGVjdCgncXVvdGF0aW9ucy5yZWZlcmVuY2Vfbm8nKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbigncXVvdGF0aW9ucy5pZCcsICdwdXJjaGFzZV9vcmRlcnMucXVvdGF0aW9uX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+dGFrZSgxKQogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3NlcnZpY2VzJywgZnVuY3Rpb24gKCRwbykgewogICAgICAgICAgICAgICAgICAgICAgICAkc2VydmljZXMgPSAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgJGNvdW50ID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRwby0+cmVsUHVyY2hhc2VPcmRlckl0ZW1zLT5jb3VudCgpID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yZWFjaCAoJHBvLT5yZWxQdXJjaGFzZU9yZGVySXRlbXMgYXMgJGtleSA9PiAkaXRlbSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkaXRlbS0+cmVsUHJvZHVjdC0+aXNfc2VydmljZSA9PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRjb3VudCsrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc2VydmljZXMgLj0gKCRjb3VudCA+IDEgPyAnLCAnIDogJycpIC4gJGl0ZW0tPnJlbFByb2R1Y3QtPm5hbWUgLiAnICcgLiBnZXRQcm9kdWN0QXR0cmlidXRlc0Zhc3RlcigkaXRlbS0+cmVsUHJvZHVjdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHNlcnZpY2VzOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3NlcnZpY2VzJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFB1cmNoYXNlT3JkZXJJdGVtcy5yZWxQcm9kdWN0JywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+b3JXaGVyZShmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFB1cmNoYXNlT3JkZXJJdGVtcy5yZWxQcm9kdWN0LmF0dHJpYnV0ZXMuYXR0cmlidXRlT3B0aW9uJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5vcldoZXJlSGFzKCdyZWxQdXJjaGFzZU9yZGVySXRlbXMucmVsUHJvZHVjdC5hdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGUnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdzZXJ2aWNlcycsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBQdXJjaGFzZU9yZGVySXRlbTo6c2VsZWN0KCdwcm9kdWN0cy5uYW1lJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbigncHJvZHVjdHMnLCAncHJvZHVjdHMuaWQnLCAnPScsICdwdXJjaGFzZV9vcmRlcl9pdGVtcy5wcm9kdWN0X2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3B1cmNoYXNlX29yZGVyX2l0ZW1zLmlkJywgJ3B1cmNoYXNlX29yZGVycy5pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC8vIC0+ZWRpdENvbHVtbigndG90YWxfcHJpY2UnLCBmdW5jdGlvbigkcG8pewogICAgICAgICAgICAgICAgICAgIC8vICAgICByZXR1cm4gKChpc3NldCgkcG8tPnJlbFF1b3RhdGlvbi0+ZXhjaGFuZ2VSYXRlLT5jdXJyZW5jeS0+c3ltYm9sKT8kcG8tPnJlbFF1b3RhdGlvbi0+ZXhjaGFuZ2VSYXRlLT5jdXJyZW5jeS0+c3ltYm9sOicnKS4nICcuc3lzdGVtTW9uZXlGb3JtYXQoJHBvLT50b3RhbF9wcmljZSkpOwogICAgICAgICAgICAgICAgICAgIC8vIH0pCiAgICAgICAgICAgICAgICAgICAgLy8gLT5lZGl0Q29sdW1uKCd2YXQnLCBmdW5jdGlvbigkcG8pewogICAgICAgICAgICAgICAgICAgIC8vICAgICByZXR1cm4gKChpc3NldCgkcG8tPnJlbFF1b3RhdGlvbi0+ZXhjaGFuZ2VSYXRlLT5jdXJyZW5jeS0+c3ltYm9sKT8kcG8tPnJlbFF1b3RhdGlvbi0+ZXhjaGFuZ2VSYXRlLT5jdXJyZW5jeS0+c3ltYm9sOicnKS4nICcuc3lzdGVtTW9uZXlGb3JtYXQoJHBvLT52YXQpKTsKICAgICAgICAgICAgICAgICAgICAvLyB9KQogICAgICAgICAgICAgICAgICAgIC8vIC0+ZWRpdENvbHVtbignZ3Jvc3NfcHJpY2UnLCBmdW5jdGlvbigkcG8pewogICAgICAgICAgICAgICAgICAgIC8vICAgICByZXR1cm4gKChpc3NldCgkcG8tPnJlbFF1b3RhdGlvbi0+ZXhjaGFuZ2VSYXRlLT5jdXJyZW5jeS0+c3ltYm9sKT8kcG8tPnJlbFF1b3RhdGlvbi0+ZXhjaGFuZ2VSYXRlLT5jdXJyZW5jeS0+c3ltYm9sOicnKSAuJyAnLnN5c3RlbU1vbmV5Rm9ybWF0KCRwby0+Z3Jvc3NfcHJpY2UpKTsKICAgICAgICAgICAgICAgICAgICAvLyB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdhY3Rpb25zJywgZnVuY3Rpb24gKCRwbykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxhIGhyZWY9IicgLiB1cmwoJ3Btcy9ncm4vc2VydmljZS1jb25maXJtYXRpb24vJyAuICRwby0+aWQpIC4gJyIgIHRpdGxlPSJTZXJ2aWNlIENvbmZpcm1hdGlvbiIgY2xhc3M9ImJ0biBidG4teHMgYnRuLXN1Y2Nlc3MgbS0xIj48aSBjbGFzcz0ibGFzIGxhLWNoZWNrIj48L2k+Jm5ic3A7Q29uZmlybTwvYT4nOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5yYXdDb2x1bW5zKFsncmVmZXJlbmNlX25vJywgJ3N1cHBsaWVyJywgJ3RvdGFsX3ByaWNlJywgJ3ZhdCcsICdncm9zc19wcmljZScsICdhY3Rpb25zJ10pCiAgICAgICAgICAgICAgICAgICAgLT5tYWtlKHRydWUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMuc2VydmljZS5pbmRleCcsIFsKICAgICAgICAgICAgICAgICd0aXRsZScgPT4gJHRpdGxlLAogICAgICAgICAgICAgICAgJ2hlYWRlckNvbHVtbnMnID0+ICR0aGlzLT5oZWFkZXJDb2x1bW5zKCkKICAgICAgICAgICAgXSk7CiAgICAgICAgfSBjYXRjaCAoXFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIHNob3coJGlkKQogICAgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgICRwdXJjaGFzZU9yZGVyID0gUHVyY2hhc2VPcmRlcjo6d2l0aChbCiAgICAgICAgICAgICAgICAncmVsUXVvdGF0aW9uLnJlbFN1cHBsaWVycycsCiAgICAgICAgICAgICAgICAncmVsR29vZFJlY2VpdmVOb3RlJywKICAgICAgICAgICAgICAgICdyZWxRdW90YXRpb24uZXhjaGFuZ2VSYXRlLmN1cnJlbmN5JywKICAgICAgICAgICAgICAgICdyZWxQb0F0dGFjaG1lbnQnLAogICAgICAgICAgICAgICAgJ3JlbFN1cHBsaWVyUGF5bWVudHMnLAoKICAgICAgICAgICAgICAgICdyZWxRdW90YXRpb24ucmVsUXVvdGF0aW9uSXRlbXMucmVsUHJvZHVjdC5hdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGUnLAogICAgICAgICAgICBdKQovLyAgICAgICAgICAgICAgICAtPndoZXJlSGFzKCdyZWxRdW90YXRpb24nLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7Ci8vICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZU5vdEluKCd0eXBlJywgWydkaXJlY3QtcHVyY2hhc2UnXSk7Ci8vICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPndoZXJlSGFzKCdwdXJjaGFzZU9yZGVyUmVxdWlzaXRpb25zLnJlcXVpc2l0aW9uLnJlcXVpc2l0aW9uSXRlbXMucHJvZHVjdCcsIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnaXNfc2VydmljZScsIDEpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+d2hlcmVJbignaXNfc2VuZCcsIFsneWVzJ10pCiAgICAgICAgICAgICAgICAtPndoZXJlKCdpZCcsICRpZCkKICAgICAgICAgICAgICAgIC0+Zmlyc3QoKTsKCiAgICAgICAgICAgICRyZXF1aXNpdGlvbkl0ZW1zID0gUmVxdWlzaXRpb25JdGVtOjp3aXRoKFsKICAgICAgICAgICAgICAgICdhdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGUnCiAgICAgICAgICAgIF0pCiAgICAgICAgICAgICAgICAtPndoZXJlSGFzKCdyZXF1aXNpdGlvbi5yZXF1ZXN0UHJvcG9zYWxSZXF1aXNpdGlvbi5yZWxSZXF1ZXN0UHJvcG9zYWwnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRwdXJjaGFzZU9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ3JlcXVlc3RfcHJvcG9zYWxfaWQnLCAkcHVyY2hhc2VPcmRlci0+cmVsUXVvdGF0aW9uLT5yZXF1ZXN0X3Byb3Bvc2FsX2lkKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmdyb3VwQnkoJ3Byb2R1Y3RfaWQnKQogICAgICAgICAgICAgICAgLT5nZXQoKTsKCiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5zZXJ2aWNlLmNvbmZpcm1hdGlvbicsIFsKICAgICAgICAgICAgICAgICd0aXRsZScgPT4gJ1NlcnZpY2UgQ29uZmlybWF0aW9uIGZvciAjJyAuICRwdXJjaGFzZU9yZGVyLT5yZWZlcmVuY2Vfbm8sCiAgICAgICAgICAgICAgICAncHVyY2hhc2VPcmRlcicgPT4gJHB1cmNoYXNlT3JkZXIsCiAgICAgICAgICAgICAgICAncmVxdWlzaXRpb25JdGVtcycgPT4gJHJlcXVpc2l0aW9uSXRlbXMKICAgICAgICAgICAgXSk7CiAgICAgICAgfSBjYXRjaCAoXFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIHVwZGF0ZShSZXF1ZXN0ICRyZXF1ZXN0LCAkcHVyY2hhc2Vfb3JkZXJfaWQpCiAgICB7CiAgICAgICAgJHJlcXVlc3QtPnZhbGlkYXRlKFsKICAgICAgICAgICAgJ2RhdGUnID0+ICdyZXF1aXJlZCcsCiAgICAgICAgICAgICdyZWNlaXZlZF9xdHknID0+ICdyZXF1aXJlZCcsCiAgICAgICAgICAgICdyZWNlaXZlZF9xdHkuKicgPT4gJ3JlcXVpcmVkJywKICAgICAgICAgICAgLy8gJ2NoYWxsYW4nID0+ICdyZXF1aXJlZCcsCiAgICAgICAgXSk7CgogICAgICAgIERCOjpiZWdpblRyYW5zYWN0aW9uKCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKGFycmF5X3N1bShhcnJheV92YWx1ZXMoJHJlcXVlc3QtPnJlY2VpdmVkX3F0eSkpIDw9IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgJ21lc3NhZ2UnID0+ICJQbGVhc2UgZW50ZXIgc29tZSBxdWFudGl0eSBvZiBzZXJ2aWNlIGZvciBjb25maXJtYXRpb24uIgogICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICRwdXJjaGFzZU9yZGVyID0gUHVyY2hhc2VPcmRlcjo6d2hlcmVIYXMoJ3B1cmNoYXNlT3JkZXJSZXF1aXNpdGlvbnMucmVxdWlzaXRpb24ucmVxdWlzaXRpb25JdGVtcy5wcm9kdWN0JywgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2lzX3NlcnZpY2UnLCAxKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+d2hlcmUoJ2lzX3NlbmQnLCAneWVzJykKICAgICAgICAgICAgICAgIC0+d2hlcmUoJ2lkJywgJHB1cmNoYXNlX29yZGVyX2lkKQogICAgICAgICAgICAgICAgLT5maXJzdCgpOwoKICAgICAgICAgICAgJHN0b2NrSW5zID0gW107CgogICAgICAgICAgICAkdG90YWxfcHJpY2UgPSAwOwogICAgICAgICAgICAkdG90YWxfdmF0ID0gMDsKICAgICAgICAgICAgJGV4Y2x1c2l2ZV92YXQgPSAwOwogICAgICAgICAgICBpZiAoJHB1cmNoYXNlT3JkZXItPnJlbFB1cmNoYXNlT3JkZXJJdGVtcy0+d2hlcmVJbignaWQnLCBhcnJheV9rZXlzKCRyZXF1ZXN0LT5yZWNlaXZlZF9xdHkpKS0+Y291bnQoKSA+IDApIHsKICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRwdXJjaGFzZU9yZGVyLT5yZWxQdXJjaGFzZU9yZGVySXRlbXMtPndoZXJlSW4oJ2lkJywgYXJyYXlfa2V5cygkcmVxdWVzdC0+cmVjZWl2ZWRfcXR5KSkgYXMgJGtleSA9PiAkaXRlbSkgewogICAgICAgICAgICAgICAgICAgIGlmIChpc3NldCgkcmVxdWVzdC0+cmVjZWl2ZWRfcXR5WyRpdGVtLT5pZF0pICYmICRyZXF1ZXN0LT5yZWNlaXZlZF9xdHlbJGl0ZW0tPmlkXSA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHByaWNlID0gJGl0ZW0tPnVuaXRfcHJpY2UgKiAkcmVxdWVzdC0+cmVjZWl2ZWRfcXR5WyRpdGVtLT5pZF07CiAgICAgICAgICAgICAgICAgICAgICAgICR0b3RhbF9wcmljZSArPSAkcHJpY2U7CiAgICAgICAgICAgICAgICAgICAgICAgICR0b3RhbF92YXQgKz0gKCRpdGVtLT52YXRfcGVyY2VudGFnZSA+IDAgJiYgJHByaWNlID4gMCA/ICgkcHJpY2UgKiAoJGl0ZW0tPnZhdF9wZXJjZW50YWdlIC8gMTAwKSkgOiAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2x1c2l2ZV92YXQgKz0gKCRpdGVtLT52YXRfcGVyY2VudGFnZSA+IDAgJiYgJHByaWNlID4gMCAmJiAkaXRlbS0+dmF0X3R5cGUgPT0gJ2V4Y2x1c2l2ZScgPyAoJHByaWNlICogKCRpdGVtLT52YXRfcGVyY2VudGFnZSAvIDEwMCkpIDogMCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAkY2hhbGxhbkZpbGUgPSAnJzsKICAgICAgICAgICAgLy8gaWYgKCRyZXF1ZXN0LT5oYXNGaWxlKCdjaGFsbGFuX2ZpbGUnKSl7CiAgICAgICAgICAgIC8vICAgICAkY2hhbGxhbkZpbGUgPSAkdGhpcy0+ZmlsZVVwbG9hZCgkcmVxdWVzdC0+ZmlsZSgnY2hhbGxhbl9maWxlJyksICd1cGxvYWQvZ3JuL2NoYWxsYW4tZmlsZScpOwogICAgICAgICAgICAvLyB9CgogICAgICAgICAgICAkZ29vZHNSZWNlaXZlZE5vdGUgPSBHb29kc1JlY2VpdmVkTm90ZTo6Y3JlYXRlKFsKICAgICAgICAgICAgICAgICdwdXJjaGFzZV9vcmRlcl9pZCcgPT4gJHB1cmNoYXNlT3JkZXItPmlkLAogICAgICAgICAgICAgICAgJ3JlZmVyZW5jZV9ubycgPT4gdW5pcXVlQ29kZSgyMCwgKCdHQVRFLUlOLScgLiBkYXRlKCd5Jywgc3RydG90aW1lKCRyZXF1ZXN0LT5kYXRlKSkgLiAnLScgLiAkcHVyY2hhc2VPcmRlci0+VW5pdC0+aHJfdW5pdF9zaG9ydF9uYW1lIC4gJy0nKSwgJ2dvb2RzX3JlY2VpdmVkX25vdGVzJywgJ2lkJyksCiAgICAgICAgICAgICAgICAnZ3JuX3JlZmVyZW5jZV9ubycgPT4gdW5pcXVlQ29kZSgxNiwgKCdHUk4tJyAuIGRhdGUoJ3knLCBzdHJ0b3RpbWUoJHJlcXVlc3QtPmRhdGUpKSAuICctU1NMWi0nKSwgJ2dvb2RzX3JlY2VpdmVkX25vdGVzJywgJ2lkJyksCiAgICAgICAgICAgICAgICAnY2hhbGxhbicgPT4gJ3NlcnZpY2UtY29uZmlybWF0aW9uJywKICAgICAgICAgICAgICAgICdjaGFsbGFuX2ZpbGUnID0+ICcnLAogICAgICAgICAgICAgICAgJ3RvdGFsX3ByaWNlJyA9PiAkdG90YWxfcHJpY2UsCiAgICAgICAgICAgICAgICAnZGlzY291bnQnID0+IDAsCiAgICAgICAgICAgICAgICAndmF0JyA9PiAkdG90YWxfdmF0LAogICAgICAgICAgICAgICAgJ2dyb3NzX3ByaWNlJyA9PiAkdG90YWxfcHJpY2UgKyAkZXhjbHVzaXZlX3ZhdCwKICAgICAgICAgICAgICAgICdyZWNlaXZlZF9kYXRlJyA9PiBkYXRlKCdZLW0tZCcsIHN0cnRvdGltZSgkcmVxdWVzdC0+ZGF0ZSkpLAogICAgICAgICAgICAgICAgJ2RlbGl2ZXJ5X2J5JyA9PiBhdXRoKCktPnVzZXIoKS0+aWQsCiAgICAgICAgICAgICAgICAncmVjZWl2ZV9ieScgPT4gYXV0aCgpLT51c2VyKCktPmlkLAogICAgICAgICAgICAgICAgJ25vdGUgJyA9PiAkcmVxdWVzdC0+bm90ZSwKICAgICAgICAgICAgICAgICdjcmVhdGVkX2J5JyA9PiBhdXRoKCktPnVzZXIoKS0+aWQsCiAgICAgICAgICAgICAgICAncmVjZWl2ZWRfc3RhdHVzJyA9PiAnZnVsbCcKICAgICAgICAgICAgXSk7CgogICAgICAgICAgICBpZiAoJHB1cmNoYXNlT3JkZXItPnJlbFB1cmNoYXNlT3JkZXJJdGVtcy0+d2hlcmVJbignaWQnLCBhcnJheV9rZXlzKCRyZXF1ZXN0LT5yZWNlaXZlZF9xdHkpKS0+Y291bnQoKSA+IDApIHsKICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRwdXJjaGFzZU9yZGVyLT5yZWxQdXJjaGFzZU9yZGVySXRlbXMtPndoZXJlSW4oJ2lkJywgYXJyYXlfa2V5cygkcmVxdWVzdC0+cmVjZWl2ZWRfcXR5KSkgYXMgJGtleSA9PiAkaXRlbSkgewogICAgICAgICAgICAgICAgICAgICRxdHkgPSBpc3NldCgkcmVxdWVzdC0+cmVjZWl2ZWRfcXR5WyRpdGVtLT5pZF0pID8gJHJlcXVlc3QtPnJlY2VpdmVkX3F0eVskaXRlbS0+aWRdIDogMDsKICAgICAgICAgICAgICAgICAgICAkc3ViX3RvdGFsID0gJGl0ZW0tPnVuaXRfcHJpY2UgKiAkcXR5OwogICAgICAgICAgICAgICAgICAgICR2YXQgPSAoJGl0ZW0tPnZhdF9wZXJjZW50YWdlID4gMCAmJiAkc3ViX3RvdGFsID4gMCA/ICgkc3ViX3RvdGFsICogKCRpdGVtLT52YXRfcGVyY2VudGFnZSAvIDEwMCkpIDogMCk7CiAgICAgICAgICAgICAgICAgICAgJGV4Y2x1c2l2ZV92YXQgPSAoJGl0ZW0tPnZhdF9wZXJjZW50YWdlID4gMCAmJiAkc3ViX3RvdGFsID4gMCAmJiAkaXRlbS0+dmF0X3R5cGUgPT0gJ2V4Y2x1c2l2ZScgPyAoJHN1Yl90b3RhbCAqICgkaXRlbS0+dmF0X3BlcmNlbnRhZ2UgLyAxMDApKSA6IDApOwogICAgICAgICAgICAgICAgICAgICRnb29kc1JlY2VpdmVkSXRlbSA9IEdvb2RzUmVjZWl2ZWRJdGVtOjpjcmVhdGUoWwogICAgICAgICAgICAgICAgICAgICAgICAnZ29vZHNfcmVjZWl2ZWRfbm90ZV9pZCcgPT4gJGdvb2RzUmVjZWl2ZWROb3RlLT5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgJ3Byb2R1Y3RfaWQnID0+ICRpdGVtLT5wcm9kdWN0X2lkLAogICAgICAgICAgICAgICAgICAgICAgICAndW5pdF9hbW91bnQnID0+ICRpdGVtLT51bml0X3ByaWNlLAogICAgICAgICAgICAgICAgICAgICAgICAncXR5JyA9PiAkcXR5LAogICAgICAgICAgICAgICAgICAgICAgICAnc3ViX3RvdGFsJyA9PiAkc3ViX3RvdGFsLAogICAgICAgICAgICAgICAgICAgICAgICAnZGlzY291bnRfcGVyY2VudGFnZScgPT4gMCwKICAgICAgICAgICAgICAgICAgICAgICAgJ2Rpc2NvdW50JyA9PiAwLAogICAgICAgICAgICAgICAgICAgICAgICAndmF0X3R5cGUnID0+ICRpdGVtLT52YXRfdHlwZSwKICAgICAgICAgICAgICAgICAgICAgICAgJ3ZhdF9wZXJjZW50YWdlJyA9PiAkaXRlbS0+dmF0X3BlcmNlbnRhZ2UsCiAgICAgICAgICAgICAgICAgICAgICAgICd2YXQnID0+ICR2YXQsCiAgICAgICAgICAgICAgICAgICAgICAgICd0b3RhbF9hbW91bnQnID0+ICRzdWJfdG90YWwgKyAkZXhjbHVzaXZlX3ZhdCwKICAgICAgICAgICAgICAgICAgICAgICAgJ3F1YWxpdHlfZW5zdXJlJyA9PiAnYXBwcm92ZWQnLAogICAgICAgICAgICAgICAgICAgICAgICAncmVjZWl2ZWRfcXR5JyA9PiAkcXR5LAogICAgICAgICAgICAgICAgICAgICAgICAndXBkYXRlZF9hdCcgPT4gZGF0ZSgnWS1tLWQgSDppOnMnKSwKICAgICAgICAgICAgICAgICAgICAgICAgJ3VwZGF0ZWRfYnknID0+IGF1dGgoKS0+dXNlcigpLT5pZAogICAgICAgICAgICAgICAgICAgIF0pOwoKICAgICAgICAgICAgICAgICAgICAkc3RvY2tJbiA9IEdvb2RzUmVjZWl2ZWRJdGVtU3RvY2tJbjo6Y3JlYXRlKFsKICAgICAgICAgICAgICAgICAgICAgICAgJ3B1cmNoYXNlX29yZGVyX2lkJyA9PiAkcHVyY2hhc2VPcmRlci0+aWQsCiAgICAgICAgICAgICAgICAgICAgICAgICdnb29kc19yZWNlaXZlZF9pdGVtX2lkJyA9PiAkZ29vZHNSZWNlaXZlZEl0ZW0tPmlkLAogICAgICAgICAgICAgICAgICAgICAgICAncmVmZXJlbmNlX25vJyA9PiB1bmlxdWVDb2RlKDE4LCAoJ1FFLUFQLScgLiBkYXRlKCd5Jywgc3RydG90aW1lKCRyZXF1ZXN0LT5kYXRlKSkgLiAnLScgLiAoYXV0aCgpLT51c2VyKCktPmVtcGxveWVlLT51bml0LT5ocl91bml0X3Nob3J0X25hbWUpIC4gJy0nKSwgJ2dvb2RzX3JlY2VpdmVkX2l0ZW1zX3N0b2NrX2luJywgJ2lkJyksCiAgICAgICAgICAgICAgICAgICAgICAgICd1bml0X2Ftb3VudCcgPT4gJGl0ZW0tPnVuaXRfcHJpY2UsCiAgICAgICAgICAgICAgICAgICAgICAgICdyZWNlaXZlZF9xdHknID0+ICRxdHksCiAgICAgICAgICAgICAgICAgICAgICAgICdzdWJfdG90YWwnID0+ICRzdWJfdG90YWwsCiAgICAgICAgICAgICAgICAgICAgICAgICdkaXNjb3VudF9wZXJjZW50YWdlJyA9PiAwLAogICAgICAgICAgICAgICAgICAgICAgICAnZGlzY291bnQnID0+IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICd2YXRfdHlwZScgPT4gJGl0ZW0tPnZhdF90eXBlLAogICAgICAgICAgICAgICAgICAgICAgICAndmF0X3BlcmNlbnRhZ2UnID0+ICRpdGVtLT52YXRfcGVyY2VudGFnZSwKICAgICAgICAgICAgICAgICAgICAgICAgJ3ZhdCcgPT4gJHZhdCwKICAgICAgICAgICAgICAgICAgICAgICAgJ3RvdGFsX2Ftb3VudCcgPT4gJHN1Yl90b3RhbCArICRleGNsdXNpdmVfdmF0LAogICAgICAgICAgICAgICAgICAgICAgICAnaXNfZ3JuX2NvbXBsZXRlJyA9PiAneWVzJywKICAgICAgICAgICAgICAgICAgICAgICAgJ3dhcmVob3VzZV9pZCcgPT4gYXV0aCgpLT51c2VyKCktPnJlbFVzZXJzV2FyZWhvdXNlLT5wbHVjaygnaWQnKS0+dG9BcnJheSgpWzBdLAogICAgICAgICAgICAgICAgICAgIF0pOwoKICAgICAgICAgICAgICAgICAgICBhcnJheV9wdXNoKCRzdG9ja0lucywgJHN0b2NrSW4tPmlkKTsKCiAgICAgICAgICAgICAgICAgICAgJHRoaXMtPnVwZGF0ZVFDUXVhbnRpdHkoJGdvb2RzUmVjZWl2ZWRJdGVtLT5pZCwgJHF0eSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICRlbnRyeSA9ICR0aGlzLT5ydW5MZWRnZXJRdWVyaWVzKCRzdG9ja0lucywgJGdvb2RzUmVjZWl2ZWROb3RlLCAkcmVxdWVzdC0+ZGF0ZSk7CiAgICAgICAgICAgIGlmICgkZW50cnlbJ3N1Y2Nlc3MnXSkgewogICAgICAgICAgICAgICAgXEFwcFxNb2RlbHNcUG1zTW9kZWxzXFB1cmNoYXNlXFB1cmNoYXNlT3JkZXJFbnRyeTo6dXBkYXRlT3JDcmVhdGUoWwogICAgICAgICAgICAgICAgICAgICdzdXBwbGllcl9pZCcgPT4gJHB1cmNoYXNlT3JkZXItPnJlbFF1b3RhdGlvbi0+c3VwcGxpZXJfaWQsCiAgICAgICAgICAgICAgICAgICAgJ3B1cmNoYXNlX29yZGVyX2lkJyA9PiAkcHVyY2hhc2VPcmRlci0+aWQsCiAgICAgICAgICAgICAgICAgICAgJ3R5cGUnID0+ICdncm4nLAogICAgICAgICAgICAgICAgICAgICdlbnRyeV9pZCcgPT4gJGVudHJ5WydlbnRyeSddWydpZCddLAogICAgICAgICAgICAgICAgXSwgWwogICAgICAgICAgICAgICAgICAgICd1cGRhdGVkX2F0JyA9PiBkYXRlKCdZLW0tZCBIOmk6cycpCiAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGlzc2V0KCRzdG9ja0luc1swXSkpIHsKICAgICAgICAgICAgICAgICRwcm9qZWN0ID0gaXNzZXQoJGdvb2RzUmVjZWl2ZWROb3RlLT5yZWxQdXJjaGFzZU9yZGVyLT5wdXJjaGFzZU9yZGVyUmVxdWlzaXRpb25zWzBdLT5yZXF1aXNpdGlvbi0+cHJvamVjdFRhc2stPmlkKTsKICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRzdG9ja0lucyBhcyAka2V5ID0+ICRzdG9ja19pbl9pZCkgewogICAgICAgICAgICAgICAgICAgICRzdG9ja0luID0gR29vZHNSZWNlaXZlZEl0ZW1TdG9ja0luOjp3aGVyZSgnaWQnLCAkc3RvY2tfaW5faWQpLT53aGVyZSgnaXNfZ3JuX2NvbXBsZXRlJywgJ3llcycpLT5maXJzdCgpOwogICAgICAgICAgICAgICAgICAgICRjYXBpdGFsaXplID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAoJHByb2plY3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRzdG9ja0luLT5yZWxHb29kc1JlY2VpdmVkSXRlbXMtPnJlbFByb2R1Y3QtPmlzX2N3aXAgPT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGNhcGl0YWxpemUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkc3RvY2tJbi0+cmVsR29vZHNSZWNlaXZlZEl0ZW1zLT5yZWxQcm9kdWN0LT5pc19maXhlZF9hc3NldCA9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkY2FwaXRhbGl6ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoJGNhcGl0YWxpemUgJiYgJHN0b2NrSW4tPnJlY2VpdmVkX3F0eSA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGJhdGNoID0gRml4ZWRBc3NldEJhdGNoOjpjcmVhdGUoWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2dvb2RzX3JlY2VpdmVkX2l0ZW1zX3N0b2NrX2luX2lkJyA9PiAkc3RvY2tJbi0+aWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnYmF0Y2gnID0+IHVuaXF1ZUNvZGVXaXRob3V0UHJlZml4KDgsICdmaXhlZF9hc3NldF9iYXRjaGVzJywgJ2JhdGNoJyksCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2RlcHJlY2lhdGlvbl9tZXRob2RfaWQnID0+ICRzdG9ja0luLT5yZWxHb29kc1JlY2VpdmVkSXRlbXMtPnJlbFByb2R1Y3QtPmRlcHJlY2lhdGlvbl9tZXRob2RfaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnYmFzZV9yYXRlJyA9PiAkc3RvY2tJbi0+cmVsR29vZHNSZWNlaXZlZEl0ZW1zLT5yZWxQcm9kdWN0LT5iYXNlX3JhdGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAncmF0ZV9tdWx0aXBsaWVyJyA9PiAkc3RvY2tJbi0+cmVsR29vZHNSZWNlaXZlZEl0ZW1zLT5yZWxQcm9kdWN0LT5yYXRlX211bHRpcGxpZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZGVwcmVjaWF0aW9uX3JhdGUnID0+ICRzdG9ja0luLT5yZWxHb29kc1JlY2VpdmVkSXRlbXMtPnJlbFByb2R1Y3QtPmRlcHJlY2lhdGlvbl9yYXRlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2lzX3llYXJseScgPT4gJHN0b2NrSW4tPnJlbEdvb2RzUmVjZWl2ZWRJdGVtcy0+cmVsUHJvZHVjdC0+aXNfeWVhcmx5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3llYXJzJyA9PiAkc3RvY2tJbi0+cmVsR29vZHNSZWNlaXZlZEl0ZW1zLT5yZWxQcm9kdWN0LT55ZWFycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdpc19vbmV0aW1lJyA9PiAkc3RvY2tJbi0+cmVsR29vZHNSZWNlaXZlZEl0ZW1zLT5yZWxQcm9kdWN0LT5pc19vbmV0aW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2RlcHJlY2lhdGlvbl9zdGFydF9kYXRlJyA9PiBkYXRlKCdZLW0tZCcsIHN0cnRvdGltZSgkc3RvY2tJbi0+dXBkYXRlZF9hdCkpLAogICAgICAgICAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRiYXRjaCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICgkaSA9IDE7ICRpIDw9ICRzdG9ja0luLT5yZWNlaXZlZF9xdHk7ICRpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBGaXhlZEFzc2V0QmF0Y2hJdGVtOjpjcmVhdGUoWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZml4ZWRfYXNzZXRfYmF0Y2hfaWQnID0+ICRiYXRjaC0+aWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdhc3NldF9jb2RlJyA9PiAkYmF0Y2gtPmJhdGNoIC4gJy0nIC4gJGksCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZGVwcmVjaWF0aW9uX21ldGhvZF9pZCcgPT4gJHN0b2NrSW4tPnJlbEdvb2RzUmVjZWl2ZWRJdGVtcy0+cmVsUHJvZHVjdC0+ZGVwcmVjaWF0aW9uX21ldGhvZF9pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2Jhc2VfcmF0ZScgPT4gJHN0b2NrSW4tPnJlbEdvb2RzUmVjZWl2ZWRJdGVtcy0+cmVsUHJvZHVjdC0+YmFzZV9yYXRlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAncmF0ZV9tdWx0aXBsaWVyJyA9PiAkc3RvY2tJbi0+cmVsR29vZHNSZWNlaXZlZEl0ZW1zLT5yZWxQcm9kdWN0LT5yYXRlX211bHRpcGxpZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdkZXByZWNpYXRpb25fcmF0ZScgPT4gJHN0b2NrSW4tPnJlbEdvb2RzUmVjZWl2ZWRJdGVtcy0+cmVsUHJvZHVjdC0+ZGVwcmVjaWF0aW9uX3JhdGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdpc195ZWFybHknID0+ICRzdG9ja0luLT5yZWxHb29kc1JlY2VpdmVkSXRlbXMtPnJlbFByb2R1Y3QtPmlzX3llYXJseSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3llYXJzJyA9PiAkc3RvY2tJbi0+cmVsR29vZHNSZWNlaXZlZEl0ZW1zLT5yZWxQcm9kdWN0LT55ZWFycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2lzX29uZXRpbWUnID0+ICRzdG9ja0luLT5yZWxHb29kc1JlY2VpdmVkSXRlbXMtPnJlbFByb2R1Y3QtPmlzX29uZXRpbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdkZXByZWNpYXRpb25fc3RhcnRfZGF0ZScgPT4gZGF0ZSgnWS1tLWQnLCBzdHJ0b3RpbWUoJHN0b2NrSW4tPnVwZGF0ZWRfYXQpKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKCiAgICAgICAgICAgIGlmICgkcHVyY2hhc2VPcmRlci0+cHVyY2hhc2VPcmRlclJlcXVpc2l0aW9ucy0+Y291bnQoKSA+IDApIHsKICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRwdXJjaGFzZU9yZGVyLT5wdXJjaGFzZU9yZGVyUmVxdWlzaXRpb25zIGFzICRrZXkgPT4gJHB1cmNoYXNlT3JkZXJSZXF1aXNpdGlvbikgewogICAgICAgICAgICAgICAgICAgIFJlcXVpc2l0aW9uVHJhY2tpbmc6OnN0b3JlUmVxdWlzaXRpb25UcmFja2luZygkcHVyY2hhc2VPcmRlclJlcXVpc2l0aW9uLT5yZXF1aXNpdGlvbl9pZCwgJ2RlbGl2ZXJlZCcpOwogICAgICAgICAgICAgICAgICAgIFJlcXVpc2l0aW9uVHJhY2tpbmc6OnN0b3JlUmVxdWlzaXRpb25UcmFja2luZygkcHVyY2hhc2VPcmRlclJlcXVpc2l0aW9uLT5yZXF1aXNpdGlvbl9pZCwgJ3JlY2VpdmVkJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIERCOjpjb21taXQoKTsKICAgICAgICAgICAgc2Vzc2lvbigpLT5mbGFzaCgnYWxlcnQtdHlwZScsICdzdWNjZXNzJyk7CiAgICAgICAgICAgIHNlc3Npb24oKS0+Zmxhc2goJ21lc3NhZ2UnLCAnU2VydmljZSBoYXMgYmVlbiBjb25maXJtZWQgc3VjY2Vzc2Z1bGx5LicpOwogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gdHJ1ZSwKICAgICAgICAgICAgICAgICdzdXBwbGllcl9pZCcgPT4gJHB1cmNoYXNlT3JkZXItPnJlbFF1b3RhdGlvbi0+c3VwcGxpZXJfaWQsCiAgICAgICAgICAgICAgICAnZ3JuX2lkJyA9PiAkZ29vZHNSZWNlaXZlZE5vdGUtPmlkCiAgICAgICAgICAgIF0pOwogICAgICAgIH0gY2F0Y2ggKFxUaHJvd2FibGUgJHRoKSB7CiAgICAgICAgICAgIERCOjpyb2xsYmFjaygpOwogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gZmFsc2UsCiAgICAgICAgICAgICAgICAnbWVzc2FnZScgPT4gJHRoLT5nZXRNZXNzYWdlKCkKICAgICAgICAgICAgXSk7CiAgICAgICAgfQogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiB1cGRhdGVRQ1F1YW50aXR5KCRnb29kc19yZWNlaXZlZF9pdGVtX2lkLCAkcWNfcXR5KQogICAgewogICAgICAgIGlmICgkcWNfcXR5ID4gMCkgewogICAgICAgICAgICAkYXJyYXkgPSBbXTsKCiAgICAgICAgICAgIC8vUE8gR2VuZXJhdGUgRXF1YWxseSBkaXN0cmlidXRlCiAgICAgICAgICAgICRnb29kc1JlY2VpdmVkSXRlbSA9IEdvb2RzUmVjZWl2ZWRJdGVtOjpmaW5kKCRnb29kc19yZWNlaXZlZF9pdGVtX2lkKTsKICAgICAgICAgICAgJHJlcXVpc2l0aW9uX3F0eSA9IFJlcXVpc2l0aW9uSXRlbTo6d2hlcmUoJ3Byb2R1Y3RfaWQnLCAkZ29vZHNSZWNlaXZlZEl0ZW0tPnByb2R1Y3RfaWQpCiAgICAgICAgICAgICAgICAtPndoZXJlSGFzKCdyZXF1aXNpdGlvbi5wdXJjaGFzZU9yZGVycy5wdXJjaGFzZU9yZGVyLnJlbEdvb2RSZWNlaXZlTm90ZScsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGdvb2RzUmVjZWl2ZWRJdGVtKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2lkJywgJGdvb2RzUmVjZWl2ZWRJdGVtLT5nb29kc19yZWNlaXZlZF9ub3RlX2lkKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPnN1bSgncXR5Jyk7CiAgICAgICAgICAgICRwZXJjZW50YWdlID0gKCRyZXF1aXNpdGlvbl9xdHkgPiAwICYmICRxY19xdHkgPiAwID8gKCgkcWNfcXR5IC8gJHJlcXVpc2l0aW9uX3F0eSkgKiAxMDApIDogMCk7CgogICAgICAgICAgICAvL2FycmF5X3B1c2goJGFycmF5LCAkcGVyY2VudGFnZSk7CgogICAgICAgICAgICAkcmVxdWlzaXRpb25zID0gJGdvb2RzUmVjZWl2ZWRJdGVtLT5yZWxHb29kc1JlY2VpdmVkTm90ZS0+cmVsUHVyY2hhc2VPcmRlci0+cHVyY2hhc2VPcmRlclJlcXVpc2l0aW9ucy0+cGx1Y2soJ3JlcXVpc2l0aW9uX2lkJyktPnRvQXJyYXkoKTsKICAgICAgICAgICAgJHJlcXVpc2l0aW9uSXRlbXMgPSBSZXF1aXNpdGlvbkl0ZW06OndoZXJlSW4oJ3JlcXVpc2l0aW9uX2lkJywgJHJlcXVpc2l0aW9ucyktPndoZXJlKCdwcm9kdWN0X2lkJywgJGdvb2RzUmVjZWl2ZWRJdGVtLT5wcm9kdWN0X2lkKS0+Z2V0KCk7CiAgICAgICAgICAgIGlmIChpc3NldCgkcmVxdWlzaXRpb25JdGVtc1swXSkpIHsKICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRyZXF1aXNpdGlvbkl0ZW1zIGFzICRrZXkgPT4gJHJlcXVpc2l0aW9uSXRlbSkgewogICAgICAgICAgICAgICAgICAgIGlmICgkcWNfcXR5ID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAkdGhpc19xY19xdHkgPSByb3VuZCgoJHBlcmNlbnRhZ2UgPiAwID8gKCRyZXF1aXNpdGlvbkl0ZW0tPnF0eSAqICgkcGVyY2VudGFnZSAvIDEwMCkpIDogMCkpOwogICAgICAgICAgICAgICAgICAgICAgICAkdGhpc19xY19xdHkgPSAoJHRoaXNfcWNfcXR5ID4gJHFjX3F0eSA/ICRxY19xdHkgOiAkdGhpc19xY19xdHkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gYXJyYXlfcHVzaCgkYXJyYXksIFsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgICdwZXJjZW50YWdlJyA9PiAkcGVyY2VudGFnZSwKICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgICdyJyA9PiAkcmVxdWlzaXRpb25JdGVtLT5xdHksCiAgICAgICAgICAgICAgICAgICAgICAgIC8vICAgICAncScgPT4gJHRoaXNfcWNfcXR5CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIF0pOwoKICAgICAgICAgICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9uSXRlbS0+cWNfcXR5ID0gJHRoaXNfcWNfcXR5OwogICAgICAgICAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb25JdGVtLT5zYXZlKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAkcWNfcXR5ID0gKCRxY19xdHkgLSAkdGhpc19xY19xdHkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICgkcWNfcXR5ID4gMCkgewogICAgICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbkl0ZW0gPSBSZXF1aXNpdGlvbkl0ZW06OndoZXJlSW4oJ3JlcXVpc2l0aW9uX2lkJywgJHJlcXVpc2l0aW9ucyktPndoZXJlKCdwcm9kdWN0X2lkJywgJGdvb2RzUmVjZWl2ZWRJdGVtLT5wcm9kdWN0X2lkKS0+Zmlyc3QoKTsKICAgICAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb25JdGVtLT5xY19xdHkgPSAoJHJlcXVpc2l0aW9uSXRlbS0+cWNfcXR5ICsgcm91bmQoJHFjX3F0eSkpOwogICAgICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbkl0ZW0tPnNhdmUoKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gYXJyYXlfcHVzaCgkYXJyYXksIFsKICAgICAgICAgICAgICAgICAgICAvLyAgICAgJ3BlcmNlbnRhZ2UnID0+ICRwZXJjZW50YWdlLAogICAgICAgICAgICAgICAgICAgIC8vICAgICAncicgPT4gJHJlcXVpc2l0aW9uSXRlbS0+cXR5LAogICAgICAgICAgICAgICAgICAgIC8vICAgICAncScgPT4gcm91bmQoJHFjX3F0eSksCiAgICAgICAgICAgICAgICAgICAgLy8gICAgICdlJyA9PiB0cnVlCiAgICAgICAgICAgICAgICAgICAgLy8gXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy9QTyBHZW5lcmF0ZSBFcXVhbGx5IGRpc3RyaWJ1dGUKICAgICAgICAgICAgLy9yZXR1cm4gJGFycmF5OwogICAgICAgIH0KICAgIH0KCiAgICBwdWJsaWMgZnVuY3Rpb24gcnVuTGVkZ2VyUXVlcmllcygkaWRzLCAkZ3JuLCAkZGF0ZSkKICAgIHsKICAgICAgICAkYWNjb3VudERlZmF1bHRTZXR0aW5ncyA9IGFjY291bnREZWZhdWx0U2V0dGluZ3MoJ2pzb24nKTsKICAgICAgICAkc3RvY2tJbnMgPSBHb29kc1JlY2VpdmVkSXRlbVN0b2NrSW46OndoZXJlSW4oJ2lkJywgJGlkcyktPndoZXJlKCdpc19ncm5fY29tcGxldGUnLCAneWVzJyktPmdldCgpOwogICAgICAgICRpdGVtcyA9IFtdOwogICAgICAgICRjb3N0X2NlbnRyZV9pZCA9IDA7CiAgICAgICAgaWYgKGlzc2V0KCRzdG9ja0luc1swXSkpIHsKICAgICAgICAgICAgZm9yZWFjaCAoJHN0b2NrSW5zIGFzICRrZXkgPT4gJGl0ZW0pIHsKICAgICAgICAgICAgICAgICRjb3N0X2NlbnRyZV9pZCA9ICRpdGVtLT5yZWxHb29kc1JlY2VpdmVkSXRlbXMtPnJlbEdvb2RzUmVjZWl2ZWROb3RlLT5yZWxQdXJjaGFzZU9yZGVyLT5jb3N0X2NlbnRyZV9pZDsKCiAgICAgICAgICAgICAgICAkZGViaXRfYWNjb3VudCA9ICRhY2NvdW50RGVmYXVsdFNldHRpbmdzWydpbnZlbnRvcnlfYWNjb3VudCddOwogICAgICAgICAgICAgICAgaWYgKGlzc2V0KCRpdGVtLT5yZWxHb29kc1JlY2VpdmVkSXRlbXMtPnJlbFByb2R1Y3QtPmlkKSkgewogICAgICAgICAgICAgICAgICAgIGlmICgkaXRlbS0+cmVsR29vZHNSZWNlaXZlZEl0ZW1zLT5yZWxQcm9kdWN0LT5pc19zZXJ2aWNlID09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGRlYml0X2FjY291bnQgPSAkYWNjb3VudERlZmF1bHRTZXR0aW5nc1snY29nc19hY2NvdW50J107CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkaXRlbS0+cmVsR29vZHNSZWNlaXZlZEl0ZW1zLT5yZWxQcm9kdWN0LT5jb2dzX2FjY291bnRfaWQgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZGViaXRfYWNjb3VudCA9ICRpdGVtLT5yZWxHb29kc1JlY2VpdmVkSXRlbXMtPnJlbFByb2R1Y3QtPmNvZ3NfYWNjb3VudF9pZDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkaXRlbS0+cmVsR29vZHNSZWNlaXZlZEl0ZW1zLT5yZWxQcm9kdWN0LT5pbnZlbnRvcnlfYWNjb3VudF9pZCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRkZWJpdF9hY2NvdW50ID0gJGl0ZW0tPnJlbEdvb2RzUmVjZWl2ZWRJdGVtcy0+cmVsUHJvZHVjdC0+aW52ZW50b3J5X2FjY291bnRfaWQ7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgYXJyYXlfcHVzaCgkaXRlbXMsIFsKICAgICAgICAgICAgICAgICAgICAnY29zdF9jZW50cmVfaWQnID0+ICRjb3N0X2NlbnRyZV9pZCwKICAgICAgICAgICAgICAgICAgICAnY2hhcnRfb2ZfYWNjb3VudF9pZCcgPT4gJGRlYml0X2FjY291bnQsCiAgICAgICAgICAgICAgICAgICAgJ2RlYml0JyA9PiAkaXRlbS0+dG90YWxfYW1vdW50LAogICAgICAgICAgICAgICAgICAgICdjcmVkaXQnID0+IDAsCiAgICAgICAgICAgICAgICAgICAgJ25hcnJhdGlvbicgPT4gJ0dSTiA6OiBJbnZlbnRvcnkgRGViaXQnLAogICAgICAgICAgICAgICAgICAgICd0eXBlJyA9PiAnZ3JuJywKICAgICAgICAgICAgICAgICAgICAnc291cmNlJyA9PiAkaXRlbS0+aWQKICAgICAgICAgICAgICAgIF0pOwoKICAgICAgICAgICAgICAgIGFycmF5X3B1c2goJGl0ZW1zLCBbCiAgICAgICAgICAgICAgICAgICAgJ2Nvc3RfY2VudHJlX2lkJyA9PiAkY29zdF9jZW50cmVfaWQsCiAgICAgICAgICAgICAgICAgICAgLy8gJ2NoYXJ0X29mX2FjY291bnRfaWQnID0+IChpc3NldCgkaXRlbS0+cmVsUHVyY2hhc2VPcmRlci0+cmVsUXVvdGF0aW9uLT5yZWxTdXBwbGllcnMtPnBheWFibGVfYWNjb3VudF9pZCkgJiYgJGl0ZW0tPnJlbFB1cmNoYXNlT3JkZXItPnJlbFF1b3RhdGlvbi0+cmVsU3VwcGxpZXJzLT5wYXlhYmxlX2FjY291bnRfaWQgPiAwID8gJGl0ZW0tPnJlbFB1cmNoYXNlT3JkZXItPnJlbFF1b3RhdGlvbi0+cmVsU3VwcGxpZXJzLT5wYXlhYmxlX2FjY291bnRfaWQgOiAkYWNjb3VudERlZmF1bHRTZXR0aW5nc1snc3VwcGxpZXJfcGF5YWJsZV9hY2NvdW50J10pLAogICAgICAgICAgICAgICAgICAgICdjaGFydF9vZl9hY2NvdW50X2lkJyA9PiAkYWNjb3VudERlZmF1bHRTZXR0aW5nc1snZ3Jpcl9hY2NvdW50J10sCiAgICAgICAgICAgICAgICAgICAgJ2RlYml0JyA9PiAwLAogICAgICAgICAgICAgICAgICAgICdjcmVkaXQnID0+ICRpdGVtLT50b3RhbF9hbW91bnQsCiAgICAgICAgICAgICAgICAgICAgJ25hcnJhdGlvbicgPT4gJ0dSTiA6OiBHUi9JUiBDcmVkaXQnLAogICAgICAgICAgICAgICAgICAgICd0eXBlJyA9PiAnZ3JuJywKICAgICAgICAgICAgICAgICAgICAnc291cmNlJyA9PiAkaXRlbS0+aWQKICAgICAgICAgICAgICAgIF0pOwoKICAgICAgICAgICAgICAgIC8vIGFycmF5X3B1c2goJGl0ZW1zLCBbCiAgICAgICAgICAgICAgICAvLyAgICAgJ2Nvc3RfY2VudHJlX2lkJyA9PiAyLAogICAgICAgICAgICAgICAgLy8gICAgICdjaGFydF9vZl9hY2NvdW50X2lkJyA9PiAoaXNzZXQoJGl0ZW0tPnJlbFB1cmNoYXNlT3JkZXItPnJlbFF1b3RhdGlvbi0+cmVsU3VwcGxpZXJzLT5wYXlhYmxlX2Rpc2NvdW50X2lkKSAmJiAkaXRlbS0+cmVsUHVyY2hhc2VPcmRlci0+cmVsUXVvdGF0aW9uLT5yZWxTdXBwbGllcnMtPnBheWFibGVfZGlzY291bnRfaWQgPiAwID8gJGl0ZW0tPnJlbFB1cmNoYXNlT3JkZXItPnJlbFF1b3RhdGlvbi0+cmVsU3VwcGxpZXJzLT5wYXlhYmxlX2Rpc2NvdW50X2lkIDogJGFjY291bnREZWZhdWx0U2V0dGluZ3NbJ3N1cHBsaWVyX3BheWFibGVfZGlzY291bnRfYWNjb3VudCddKSwKICAgICAgICAgICAgICAgIC8vICAgICAnZGViaXQnID0+ICRpdGVtLT5kaXNjb3VudCwKICAgICAgICAgICAgICAgIC8vICAgICAnY3JlZGl0JyA9PiAwLAogICAgICAgICAgICAgICAgLy8gICAgICduYXJyYXRpb24nID0+ICdHUk4gOjogU3VwcGxpZXIgRGlzY291bnQgUGF5YWJsZSBEZWJpdCcsCiAgICAgICAgICAgICAgICAvLyBdKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHNhdmVMZWRnZXJFbnRyaWVzKDUsIGRhdGUoJ1ktbS1kIEg6aTpzJywgc3RydG90aW1lKCRkYXRlIC4gJyAnIC4gZGF0ZSgnSDppOnMnKSkpLCAxLCAnJywgJ0dSTicsICRpdGVtcywgJGdybi0+cmVsUHVyY2hhc2VPcmRlci0+cmVsUXVvdGF0aW9uLT5leGNoYW5nZV9yYXRlX2lkLCAwLCAwLCAwLCBnZXRDb3N0Q2VudHJlQ29tcGFueSgkY29zdF9jZW50cmVfaWQpLCBmYWxzZSwgJ2pzb24nKTsKICAgIH0KfQo=