<?php
bolt_decrypt( __FILE__ , 'p25hVk'); return 0;
##!!!##CgpuYW1lc3BhY2UgQXBwXEh0dHBcQ29udHJvbGxlcnNcUG1zOwoKdXNlIEFwcFxIdHRwXENvbnRyb2xsZXJzXENvbnRyb2xsZXI7CnVzZSBBcHBcTW9kZWxzXEZpeGVkQXNzZXRzXEZpeGVkQXNzZXRCYXRjaDsKdXNlIEFwcFxNb2RlbHNcRml4ZWRBc3NldHNcRml4ZWRBc3NldEJhdGNoSXRlbTsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXEdyblxHb29kc1JlY2VpdmVkSXRlbTsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXEdyblxHb29kc1JlY2VpdmVkSXRlbVN0b2NrSW47CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xHcm5cR29vZHNSZWNlaXZlZE5vdGU7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xQdXJjaGFzZVxQdXJjaGFzZU9yZGVyOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUHVyY2hhc2VcUHVyY2hhc2VPcmRlckVudHJ5Owp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUHVyY2hhc2VcUHVyY2hhc2VPcmRlckl0ZW07CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xSZXF1aXNpdGlvbkl0ZW07CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xSZXF1aXNpdGlvblRyYWNraW5nOwp1c2UgSWxsdW1pbmF0ZVxIdHRwXFJlcXVlc3Q7CnVzZSBJbGx1bWluYXRlXFN1cHBvcnRcRmFjYWRlc1xEQjsKdXNlIFlhanJhXERhdGFUYWJsZXNcRmFjYWRlc1xEYXRhVGFibGVzOwoKY2xhc3MgU2VydmljZUNvbmZpcm1hdGlvbkNvbnRyb2xsZXIgZXh0ZW5kcyBDb250cm9sbGVyCnsKICAgIHB1YmxpYyBmdW5jdGlvbiBoZWFkZXJDb2x1bW5zKCR2YWx1ZSA9ICcnKQogICAgewogICAgICAgIHJldHVybiAkYXJyYXkgPSBhcnJheSgKICAgICAgICAgICAgWydTTCcsICdTTCddLAogICAgICAgICAgICBbJ2FwcHJvdmFsX2RhdGUnLCAnYXBwcm92YWxfZGF0ZScsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3JlZmVyZW5jZV9ubycsICdyZWZlcmVuY2Vfbm8nLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydzdXBwbGllcicsICdzdXBwbGllcicsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3F1b3RhdGlvbl9yZWZfbm8nLCAncXVvdGF0aW9uX3JlZl9ubycsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3NlcnZpY2VzJywgJ3NlcnZpY2VzJ10sCiAgICAgICAgICAgIC8vIFsndG90YWxfcHJpY2UnLCAndG90YWxfcHJpY2UnLCAndGV4dC1yaWdodCddLCAKICAgICAgICAgICAgLy8gWyd2YXQnLCAndmF0JywgJ3RleHQtcmlnaHQnXSwKICAgICAgICAgICAgLy8gWydncm9zc19wcmljZScsICdncm9zc19wcmljZScsICd0ZXh0LXJpZ2h0J10sCiAgICAgICAgICAgIFsnYWN0aW9ucycsICdhY3Rpb25zJywgJ3RleHQtY2VudGVyJywgJ3dpZHRoOjE1JSddCiAgICAgICAgKTsKICAgIH0KICAgIAogICAgLyoqCiAgICAgKiBEaXNwbGF5IGEgbGlzdGluZyBvZiB0aGUgcmVzb3VyY2UuCiAgICAgKgogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KICAgIHB1YmxpYyBmdW5jdGlvbiBpbmRleChSZXF1ZXN0ICRyZXF1ZXN0KQogICAgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgICR0aXRsZSA9ICdTZXJ2aWNlIENvbmZpcm1hdGlvbic7CiAgICAgICAgICAgICRwdXJjaGFzZU9yZGVycyA9IFB1cmNoYXNlT3JkZXI6OndpdGgoWwogICAgICAgICAgICAgICAgJ3JlbFB1cmNoYXNlT3JkZXJJdGVtcy5yZWxQcm9kdWN0JywKICAgICAgICAgICAgICAgICdyZWxHb29kUmVjZWl2ZU5vdGUucmVsR29vZHNSZWNlaXZlZEl0ZW1zJywKICAgICAgICAgICAgICAgICdyZWxRdW90YXRpb24nLAogICAgICAgICAgICAgICAgJ3B1cmNoYXNlT3JkZXJSZXF1aXNpdGlvbnMucmVxdWlzaXRpb24ucmVxdWlzaXRpb25JdGVtcy5wcm9kdWN0JwogICAgICAgICAgICBdKQovLyAgICAgICAgICAgICAgICAtPndoZW4oIWF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdHYXRlIFBlcm1pc3Npb24nKSwgZnVuY3Rpb24gKCRxdWVyeSkgewovLyAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlbihhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnRGVwYXJ0bWVudC1IZWFkJykgJiYgIWF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdTdG9yZS1NYW5hZ2VyJyksIGZ1bmN0aW9uICgkcXVlcnkpIHsKLy8gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncHVyY2hhc2VPcmRlclJlcXVpc2l0aW9ucycsIGZ1bmN0aW9uICgkcXVlcnkpIHsKLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVJbignaHJfZGVwYXJ0bWVudF9pZCcsIGF1dGgoKS0+dXNlcigpLT5wcmlvcml0aWVzLT5wbHVjaygnaHJfZGVwYXJ0bWVudF9pZCcpLT50b0FycmF5KCkpOwovLyAgICAgICAgICAgICAgICAgICAgICAgIH0pOwovLyAgICAgICAgICAgICAgICAgICAgfSkKLy8gICAgICAgICAgICAgICAgICAgICAgICAtPndoZW4oIWF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdEZXBhcnRtZW50LUhlYWQnKSB8fCBhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnU3RvcmUtTWFuYWdlcicpLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7Ci8vICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdwdXJjaGFzZU9yZGVyUmVxdWlzaXRpb25zJywgZnVuY3Rpb24gKCRxdWVyeSkgewovLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2hyX2RlcGFydG1lbnRfaWQnLCAwKTsKLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7Ci8vICAgICAgICAgICAgICAgICAgICAgICAgfSk7Ci8vICAgICAgICAgICAgICAgIH0pCi8vICAgICAgICAgICAgICAgIC0+d2hlbihhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnR2F0ZSBQZXJtaXNzaW9uJyksIGZ1bmN0aW9uICgkcXVlcnkpIHsKLy8gICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSW4oJ2hyX3VuaXRfaWQnLCBhdXRoKCktPnVzZXIoKS0+cHJpb3JpdGllcy0+cGx1Y2soJ2hyX3VuaXRfaWQnKS0+dG9BcnJheSgpKTsKLy8gICAgICAgICAgICAgICAgfSkKCi8vICAgICAgICAgICAgLT53aGVyZUhhcygncmVsUXVvdGF0aW9uJywgZnVuY3Rpb24oJHF1ZXJ5KXsKLy8gICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVOb3RJbigndHlwZScsWydkaXJlY3QtcHVyY2hhc2UnXSk7Ci8vICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+d2hlcmVIYXMoJ3B1cmNoYXNlT3JkZXJSZXF1aXNpdGlvbnMucmVxdWlzaXRpb24nLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2F1dGhvcl9pZCcsIGF1dGgoKS0+dXNlcigpLT5pZCk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT53aGVyZUhhcygncHVyY2hhc2VPcmRlclJlcXVpc2l0aW9ucy5yZXF1aXNpdGlvbi5yZXF1aXNpdGlvbkl0ZW1zLnByb2R1Y3QnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2lzX3NlcnZpY2UnLCAxKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPndoZXJlSW4oJ2lzX3NlbmQnLCBbJ3llcyddKQogICAgICAgICAgICAgICAgLT5nZXQoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgICRpZHMgPSBbXTsKICAgICAgICAgICAgaWYgKCRwdXJjaGFzZU9yZGVycy0+Y291bnQoKSA+IDApIHsKICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRwdXJjaGFzZU9yZGVycyBhcyAka2V5ID0+ICRwdXJjaGFzZU9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCRwdXJjaGFzZU9yZGVyLT5yZWxQdXJjaGFzZU9yZGVySXRlbXMtPmNvdW50KCkgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRwdXJjaGFzZU9yZGVyLT5yZWxQdXJjaGFzZU9yZGVySXRlbXMgYXMgJGtleSA9PiAkaXRlbSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRpdGVtLT5yZWxQcm9kdWN0LT5pc19zZXJ2aWNlID09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcmVjZWl2ZWRfcXR5ID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHB1cmNoYXNlT3JkZXItPnJlbEdvb2RSZWNlaXZlTm90ZS0+Y291bnQoKSA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yZWFjaCAoJHB1cmNoYXNlT3JkZXItPnJlbEdvb2RSZWNlaXZlTm90ZSBhcyAka2V5ID0+ICRncm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRyZWNlaXZlZF9xdHkgKz0gJGdybi0+cmVsR29vZHNSZWNlaXZlZEl0ZW1zLT53aGVyZSgncHJvZHVjdF9pZCcsICRpdGVtLT5wcm9kdWN0X2lkKS0+c3VtKCdyZWNlaXZlZF9xdHknKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJGl0ZW0tPnF0eSA+ICRyZWNlaXZlZF9xdHkgJiYgIWluX2FycmF5KCRwdXJjaGFzZU9yZGVyLT5pZCwgJGlkcykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXlfcHVzaCgkaWRzLCAkcHVyY2hhc2VPcmRlci0+aWQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgJHB1cmNoYXNlT3JkZXJzID0gUHVyY2hhc2VPcmRlcjo6d2hlcmVJbignaWQnLCAkaWRzKQogICAgICAgICAgICAgICAgLT53aXRoKFsKICAgICAgICAgICAgICAgICAgICAncmVsUXVvdGF0aW9uLnJlbFN1cHBsaWVycycsCiAgICAgICAgICAgICAgICAgICAgJ3JlbFF1b3RhdGlvbi5leGNoYW5nZVJhdGUuY3VycmVuY3knLAogICAgICAgICAgICAgICAgICAgICdyZWxQb0F0dGFjaG1lbnQnLAogICAgICAgICAgICAgICAgICAgICdyZWxTdXBwbGllclBheW1lbnRzJywKICAgICAgICAgICAgICAgICAgICAncmVsUHVyY2hhc2VPcmRlckl0ZW1zLnJlbFByb2R1Y3QuYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24uYXR0cmlidXRlJywKICAgICAgICAgICAgICAgICAgICAncmVsR29vZFJlY2VpdmVOb3RlLnJlbEdvb2RzUmVjZWl2ZWRJdGVtcycKICAgICAgICAgICAgICAgIF0pCiAgICAgICAgICAgICAgICAtPndoZW4oIWRhdGF0YWJsZU9yZGVyaW5nKCksIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT5vcmRlcmJ5KCdpZCcsICdkZXNjJyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChyZXF1ZXN0KCktPmFqYXgoKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIERhdGFUYWJsZXM6Om9mKCRwdXJjaGFzZU9yZGVycykKICAgICAgICAgICAgICAgICAgICAtPmFkZEluZGV4Q29sdW1uKCkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignYXBwcm92YWxfZGF0ZScsIGZ1bmN0aW9uICgkcG8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRhdGUoJ1ktbS1kJywgc3RydG90aW1lKCRwby0+cG9fZGF0ZSkpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ2FwcHJvdmFsX2RhdGUnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdwb19kYXRlJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdhcHByb3ZhbF9kYXRlJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyQnkoJ3BvX2RhdGUnLCAkb3JkZXIpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5lZGl0Q29sdW1uKCdyZWZlcmVuY2Vfbm8nLCBmdW5jdGlvbiAoJHBvKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnPGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiBvbmNsaWNrPSJwdXJjaGFzZU9yZGVyRGV0YWlscygkKHRoaXMpKSIgY2xhc3M9ImJ0biBidG4tbGluayIgZGF0YS1zcmM9IicgLiByb3V0ZSgncG1zLnB1cmNoYXNlLm9yZGVyLWxpc3Quc2hvdycsICRwby0+aWQpIC4gJyI+JyAuICRwby0+cmVmZXJlbmNlX25vIC4gJzwvYT4nOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3N1cHBsaWVyJywgZnVuY3Rpb24gKCRwbykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNzZXQoJHBvLT5yZWxRdW90YXRpb24tPnJlbFN1cHBsaWVycykgPyAoaXNzZXQoJHBvLT5yZWxRdW90YXRpb24tPnJlbFN1cHBsaWVycy0+bmFtZSkgPyAkcG8tPnJlbFF1b3RhdGlvbi0+cmVsU3VwcGxpZXJzLT5uYW1lIC4gJyAoJyAuICRwby0+cmVsUXVvdGF0aW9uLT5yZWxTdXBwbGllcnMtPmNvZGUgLiAnKScgOiAnJykgOiAnJzsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdzdXBwbGllcicsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxRdW90YXRpb24ucmVsU3VwcGxpZXJzJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5vcldoZXJlKCdjb2RlJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbignc3VwcGxpZXInLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgUXVvdGF0aW9uczo6c2VsZWN0KCdzdXBwbGllcnMubmFtZScpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ3N1cHBsaWVycycsICdzdXBwbGllcnMuaWQnLCAnPScsICdxdW90YXRpb25zLnN1cHBsaWVyX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3F1b3RhdGlvbnMuaWQnLCAncHVyY2hhc2Vfb3JkZXJzLnF1b3RhdGlvbl9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdxdW90YXRpb25fcmVmX25vJywgZnVuY3Rpb24gKCRwbykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNzZXQoJHBvLT5yZWxRdW90YXRpb24tPnJlZmVyZW5jZV9ubykgPyAkcG8tPnJlbFF1b3RhdGlvbi0+cmVmZXJlbmNlX25vIDogJyc7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbigncXVvdGF0aW9uX3JlZl9ubycsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxRdW90YXRpb24nLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdyZWZlcmVuY2Vfbm8nLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdxdW90YXRpb25fcmVmX25vJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwbGVhc2VTb3J0TWUoJHF1ZXJ5LCAkb3JkZXIsIFF1b3RhdGlvbnM6OnNlbGVjdCgncXVvdGF0aW9ucy5yZWZlcmVuY2Vfbm8nKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbigncXVvdGF0aW9ucy5pZCcsICdwdXJjaGFzZV9vcmRlcnMucXVvdGF0aW9uX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+dGFrZSgxKQogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3NlcnZpY2VzJywgZnVuY3Rpb24gKCRwbykgewogICAgICAgICAgICAgICAgICAgICAgICAkc2VydmljZXMgPSAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgJGNvdW50ID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRwby0+cmVsUHVyY2hhc2VPcmRlckl0ZW1zLT5jb3VudCgpID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yZWFjaCAoJHBvLT5yZWxQdXJjaGFzZU9yZGVySXRlbXMgYXMgJGtleSA9PiAkaXRlbSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkaXRlbS0+cmVsUHJvZHVjdC0+aXNfc2VydmljZSA9PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRjb3VudCsrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc2VydmljZXMgLj0gKCRjb3VudCA+IDEgPyAnLCAnIDogJycpIC4gJGl0ZW0tPnJlbFByb2R1Y3QtPm5hbWUgLiAnICcgLiBnZXRQcm9kdWN0QXR0cmlidXRlc0Zhc3RlcigkaXRlbS0+cmVsUHJvZHVjdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHNlcnZpY2VzOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3NlcnZpY2VzJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFB1cmNoYXNlT3JkZXJJdGVtcy5yZWxQcm9kdWN0JywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+b3JXaGVyZShmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFB1cmNoYXNlT3JkZXJJdGVtcy5yZWxQcm9kdWN0LmF0dHJpYnV0ZXMuYXR0cmlidXRlT3B0aW9uJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5vcldoZXJlSGFzKCdyZWxQdXJjaGFzZU9yZGVySXRlbXMucmVsUHJvZHVjdC5hdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGUnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdzZXJ2aWNlcycsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBQdXJjaGFzZU9yZGVySXRlbTo6c2VsZWN0KCdwcm9kdWN0cy5uYW1lJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbigncHJvZHVjdHMnLCAncHJvZHVjdHMuaWQnLCAnPScsICdwdXJjaGFzZV9vcmRlcl9pdGVtcy5wcm9kdWN0X2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3B1cmNoYXNlX29yZGVyX2l0ZW1zLmlkJywgJ3B1cmNoYXNlX29yZGVycy5pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC8vIC0+ZWRpdENvbHVtbigndG90YWxfcHJpY2UnLCBmdW5jdGlvbigkcG8pewogICAgICAgICAgICAgICAgICAgIC8vICAgICByZXR1cm4gKChpc3NldCgkcG8tPnJlbFF1b3RhdGlvbi0+ZXhjaGFuZ2VSYXRlLT5jdXJyZW5jeS0+c3ltYm9sKT8kcG8tPnJlbFF1b3RhdGlvbi0+ZXhjaGFuZ2VSYXRlLT5jdXJyZW5jeS0+c3ltYm9sOicnKS4nICcuc3lzdGVtTW9uZXlGb3JtYXQoJHBvLT50b3RhbF9wcmljZSkpOwogICAgICAgICAgICAgICAgICAgIC8vIH0pCiAgICAgICAgICAgICAgICAgICAgLy8gLT5lZGl0Q29sdW1uKCd2YXQnLCBmdW5jdGlvbigkcG8pewogICAgICAgICAgICAgICAgICAgIC8vICAgICByZXR1cm4gKChpc3NldCgkcG8tPnJlbFF1b3RhdGlvbi0+ZXhjaGFuZ2VSYXRlLT5jdXJyZW5jeS0+c3ltYm9sKT8kcG8tPnJlbFF1b3RhdGlvbi0+ZXhjaGFuZ2VSYXRlLT5jdXJyZW5jeS0+c3ltYm9sOicnKS4nICcuc3lzdGVtTW9uZXlGb3JtYXQoJHBvLT52YXQpKTsKICAgICAgICAgICAgICAgICAgICAvLyB9KQogICAgICAgICAgICAgICAgICAgIC8vIC0+ZWRpdENvbHVtbignZ3Jvc3NfcHJpY2UnLCBmdW5jdGlvbigkcG8pewogICAgICAgICAgICAgICAgICAgIC8vICAgICByZXR1cm4gKChpc3NldCgkcG8tPnJlbFF1b3RhdGlvbi0+ZXhjaGFuZ2VSYXRlLT5jdXJyZW5jeS0+c3ltYm9sKT8kcG8tPnJlbFF1b3RhdGlvbi0+ZXhjaGFuZ2VSYXRlLT5jdXJyZW5jeS0+c3ltYm9sOicnKSAuJyAnLnN5c3RlbU1vbmV5Rm9ybWF0KCRwby0+Z3Jvc3NfcHJpY2UpKTsKICAgICAgICAgICAgICAgICAgICAvLyB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdhY3Rpb25zJywgZnVuY3Rpb24gKCRwbykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxhIGhyZWY9IicgLiB1cmwoJ3Btcy9ncm4vc2VydmljZS1jb25maXJtYXRpb24vJyAuICRwby0+aWQpIC4gJyIgIHRpdGxlPSJTZXJ2aWNlIENvbmZpcm1hdGlvbiIgY2xhc3M9ImJ0biBidG4teHMgYnRuLXN1Y2Nlc3MgbS0xIj48aSBjbGFzcz0ibGFzIGxhLWNoZWNrIj48L2k+Jm5ic3A7Q29uZmlybTwvYT4nOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5yYXdDb2x1bW5zKFsncmVmZXJlbmNlX25vJywgJ3N1cHBsaWVyJywgJ3RvdGFsX3ByaWNlJywgJ3ZhdCcsICdncm9zc19wcmljZScsICdhY3Rpb25zJ10pCiAgICAgICAgICAgICAgICAgICAgLT5tYWtlKHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMuc2VydmljZS5pbmRleCcsIFsKICAgICAgICAgICAgICAgICd0aXRsZScgPT4gJHRpdGxlLAogICAgICAgICAgICAgICAgJ2hlYWRlckNvbHVtbnMnID0+ICR0aGlzLT5oZWFkZXJDb2x1bW5zKCkKICAgICAgICAgICAgXSk7CiAgICAgICAgfSBjYXRjaCAoXFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CiAgICAKICAgIHB1YmxpYyBmdW5jdGlvbiBzaG93KCRpZCkKICAgIHsKICAgICAgICB0cnkgewogICAgICAgICAgICAkcHVyY2hhc2VPcmRlciA9IFB1cmNoYXNlT3JkZXI6OndpdGgoWwogICAgICAgICAgICAgICAgJ3JlbFF1b3RhdGlvbi5yZWxTdXBwbGllcnMnLAogICAgICAgICAgICAgICAgJ3JlbEdvb2RSZWNlaXZlTm90ZScsCiAgICAgICAgICAgICAgICAncmVsUXVvdGF0aW9uLmV4Y2hhbmdlUmF0ZS5jdXJyZW5jeScsCiAgICAgICAgICAgICAgICAncmVsUG9BdHRhY2htZW50JywKICAgICAgICAgICAgICAgICdyZWxTdXBwbGllclBheW1lbnRzJywKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgJ3JlbFF1b3RhdGlvbi5yZWxRdW90YXRpb25JdGVtcy5yZWxQcm9kdWN0LmF0dHJpYnV0ZXMuYXR0cmlidXRlT3B0aW9uLmF0dHJpYnV0ZScsCiAgICAgICAgICAgIF0pCi8vICAgICAgICAgICAgICAgIC0+d2hlcmVIYXMoJ3JlbFF1b3RhdGlvbicsIGZ1bmN0aW9uICgkcXVlcnkpIHsKLy8gICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlTm90SW4oJ3R5cGUnLCBbJ2RpcmVjdC1wdXJjaGFzZSddKTsKLy8gICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+d2hlcmVIYXMoJ3B1cmNoYXNlT3JkZXJSZXF1aXNpdGlvbnMucmVxdWlzaXRpb24ucmVxdWlzaXRpb25JdGVtcy5wcm9kdWN0JywgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdpc19zZXJ2aWNlJywgMSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT53aGVyZUluKCdpc19zZW5kJywgWyd5ZXMnXSkKICAgICAgICAgICAgICAgIC0+d2hlcmUoJ2lkJywgJGlkKQogICAgICAgICAgICAgICAgLT5maXJzdCgpOwogICAgICAgICAgICAKICAgICAgICAgICAgJHJlcXVpc2l0aW9uSXRlbXMgPSBSZXF1aXNpdGlvbkl0ZW06OndpdGgoWwogICAgICAgICAgICAgICAgJ2F0dHJpYnV0ZXMuYXR0cmlidXRlT3B0aW9uLmF0dHJpYnV0ZScKICAgICAgICAgICAgXSkKICAgICAgICAgICAgICAgIC0+d2hlcmVIYXMoJ3JlcXVpc2l0aW9uLnJlcXVlc3RQcm9wb3NhbFJlcXVpc2l0aW9uLnJlbFJlcXVlc3RQcm9wb3NhbCcsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJHB1cmNoYXNlT3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgncmVxdWVzdF9wcm9wb3NhbF9pZCcsICRwdXJjaGFzZU9yZGVyLT5yZWxRdW90YXRpb24tPnJlcXVlc3RfcHJvcG9zYWxfaWQpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+Z3JvdXBCeSgncHJvZHVjdF9pZCcpCiAgICAgICAgICAgICAgICAtPmdldCgpOwogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnNlcnZpY2UuY29uZmlybWF0aW9uJywgWwogICAgICAgICAgICAgICAgJ3RpdGxlJyA9PiAnU2VydmljZSBDb25maXJtYXRpb24gZm9yICMnIC4gJHB1cmNoYXNlT3JkZXItPnJlZmVyZW5jZV9ubywKICAgICAgICAgICAgICAgICdwdXJjaGFzZU9yZGVyJyA9PiAkcHVyY2hhc2VPcmRlciwKICAgICAgICAgICAgICAgICdyZXF1aXNpdGlvbkl0ZW1zJyA9PiAkcmVxdWlzaXRpb25JdGVtcwogICAgICAgICAgICBdKTsKICAgICAgICB9IGNhdGNoIChcVGhyb3dhYmxlICR0aCkgewogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KICAgIAogICAgcHVibGljIGZ1bmN0aW9uIHVwZGF0ZShSZXF1ZXN0ICRyZXF1ZXN0LCAkcHVyY2hhc2Vfb3JkZXJfaWQpCiAgICB7CiAgICAgICAgJHJlcXVlc3QtPnZhbGlkYXRlKFsKICAgICAgICAgICAgJ2RhdGUnID0+ICdyZXF1aXJlZCcsCiAgICAgICAgICAgICdyZWNlaXZlZF9xdHknID0+ICdyZXF1aXJlZHxhcnJheScsCiAgICAgICAgICAgICdyZWNlaXZlZF9xdHkuKicgPT4gJ3JlcXVpcmVkfG51bWVyaWN8bWluOjAnLAogICAgICAgIF0pOwogICAgICAgIAogICAgICAgIERCOjpiZWdpblRyYW5zYWN0aW9uKCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKGFycmF5X3N1bSgkcmVxdWVzdC0+cmVjZWl2ZWRfcXR5KSA8PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnID0+IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAiUGxlYXNlIGVudGVyIHNvbWUgcXVhbnRpdHkgb2Ygc2VydmljZSBmb3IgY29uZmlybWF0aW9uLiIKICAgICAgICAgICAgICAgIF0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAkcHVyY2hhc2VPcmRlciA9IFB1cmNoYXNlT3JkZXI6OndoZXJlSGFzKCdwdXJjaGFzZU9yZGVyUmVxdWlzaXRpb25zLnJlcXVpc2l0aW9uLnJlcXVpc2l0aW9uSXRlbXMucHJvZHVjdCcsIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ2lzX3NlcnZpY2UnLCAxKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+d2hlcmUoJ2lzX3NlbmQnLCAneWVzJykKICAgICAgICAgICAgICAgIC0+d2hlcmUoJ2lkJywgJHB1cmNoYXNlX29yZGVyX2lkKQogICAgICAgICAgICAgICAgLT5maXJzdE9yRmFpbCgpOwogICAgICAgICAgICAKICAgICAgICAgICAgJHJlY2VpdmVkUXR5cyA9ICRyZXF1ZXN0LT5yZWNlaXZlZF9xdHk7CiAgICAgICAgICAgICRwb0l0ZW1zID0gJHB1cmNoYXNlT3JkZXItPnJlbFB1cmNoYXNlT3JkZXJJdGVtcy0+d2hlcmVJbignaWQnLCBhcnJheV9rZXlzKCRyZWNlaXZlZFF0eXMpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgICR0b3RhbF9wcmljZSA9IDA7CiAgICAgICAgICAgICR0b3RhbF92YXQgPSAwOwogICAgICAgICAgICAkZXhjbHVzaXZlX3ZhdCA9IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICBmb3JlYWNoICgkcG9JdGVtcyBhcyAkaXRlbSkgewogICAgICAgICAgICAgICAgJHF0eSA9ICRyZWNlaXZlZFF0eXNbJGl0ZW0tPmlkXSA/PyAwOwogICAgICAgICAgICAgICAgaWYgKCRxdHkgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgJHByaWNlID0gJGl0ZW0tPnVuaXRfcHJpY2UgKiAkcXR5OwogICAgICAgICAgICAgICAgICAgICR2YXQgPSAkaXRlbS0+dmF0X3BlcmNlbnRhZ2UgPiAwID8gJHByaWNlICogKCRpdGVtLT52YXRfcGVyY2VudGFnZSAvIDEwMCkgOiAwOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICR0b3RhbF9wcmljZSArPSAkcHJpY2U7CiAgICAgICAgICAgICAgICAgICAgJHRvdGFsX3ZhdCArPSAkdmF0OwogICAgICAgICAgICAgICAgICAgIGlmICgkaXRlbS0+dmF0X3R5cGUgPT0gJ2V4Y2x1c2l2ZScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2x1c2l2ZV92YXQgKz0gJHZhdDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAkY2hhbGxhbkZpbGUgPSAnJzsKICAgICAgICAgICAgLy8gaWYgKCRyZXF1ZXN0LT5oYXNGaWxlKCdjaGFsbGFuX2ZpbGUnKSl7CiAgICAgICAgICAgIC8vICAgICAkY2hhbGxhbkZpbGUgPSAkdGhpcy0+ZmlsZVVwbG9hZCgkcmVxdWVzdC0+ZmlsZSgnY2hhbGxhbl9maWxlJyksICd1cGxvYWQvZ3JuL2NoYWxsYW4tZmlsZScpOwogICAgICAgICAgICAvLyB9CiAgICAgICAgICAgIAogICAgICAgICAgICAkZ29vZHNSZWNlaXZlZE5vdGUgPSBHb29kc1JlY2VpdmVkTm90ZTo6Y3JlYXRlKFsKICAgICAgICAgICAgICAgICdwdXJjaGFzZV9vcmRlcl9pZCcgPT4gJHB1cmNoYXNlT3JkZXItPmlkLAogICAgICAgICAgICAgICAgJ3JlZmVyZW5jZV9ubycgPT4gdW5pcXVlQ29kZSgyMCwgJ0dBVEUtSU4tJyAuIGRhdGUoJ3knLCBzdHJ0b3RpbWUoJHJlcXVlc3QtPmRhdGUpKSAuICctJyAuICRwdXJjaGFzZU9yZGVyLT5Vbml0LT5ocl91bml0X3Nob3J0X25hbWUgLiAnLScsICdnb29kc19yZWNlaXZlZF9ub3RlcycsICdpZCcpLAogICAgICAgICAgICAgICAgJ2dybl9yZWZlcmVuY2Vfbm8nID0+IHVuaXF1ZUNvZGUoMTYsICdHUk4tJyAuIGRhdGUoJ3knLCBzdHJ0b3RpbWUoJHJlcXVlc3QtPmRhdGUpKSAuICctU1NMWi0nLCAnZ29vZHNfcmVjZWl2ZWRfbm90ZXMnLCAnaWQnKSwKICAgICAgICAgICAgICAgICdjaGFsbGFuJyA9PiAnc2VydmljZS1jb25maXJtYXRpb24nLAogICAgICAgICAgICAgICAgJ2NoYWxsYW5fZmlsZScgPT4gJycsCiAgICAgICAgICAgICAgICAndG90YWxfcHJpY2UnID0+ICR0b3RhbF9wcmljZSwKICAgICAgICAgICAgICAgICdkaXNjb3VudCcgPT4gMCwKICAgICAgICAgICAgICAgICd2YXQnID0+ICR0b3RhbF92YXQsCiAgICAgICAgICAgICAgICAnZ3Jvc3NfcHJpY2UnID0+ICR0b3RhbF9wcmljZSArICRleGNsdXNpdmVfdmF0LAogICAgICAgICAgICAgICAgJ3JlY2VpdmVkX2RhdGUnID0+IGRhdGUoJ1ktbS1kJywgc3RydG90aW1lKCRyZXF1ZXN0LT5kYXRlKSksCiAgICAgICAgICAgICAgICAnZGVsaXZlcnlfYnknID0+IGF1dGgoKS0+aWQoKSwKICAgICAgICAgICAgICAgICdyZWNlaXZlX2J5JyA9PiBhdXRoKCktPmlkKCksCiAgICAgICAgICAgICAgICAnbm90ZScgPT4gJHJlcXVlc3QtPm5vdGUsCiAgICAgICAgICAgICAgICAnY3JlYXRlZF9ieScgPT4gYXV0aCgpLT5pZCgpLAogICAgICAgICAgICAgICAgJ3JlY2VpdmVkX3N0YXR1cycgPT4gJ2Z1bGwnLAogICAgICAgICAgICBdKTsKICAgICAgICAgICAgCiAgICAgICAgICAgICRzdG9ja0lucyA9IFtdOwogICAgICAgICAgICAKICAgICAgICAgICAgZm9yZWFjaCAoJHBvSXRlbXMgYXMgJGl0ZW0pIHsKICAgICAgICAgICAgICAgICRxdHkgPSAkcmVjZWl2ZWRRdHlzWyRpdGVtLT5pZF0gPz8gMDsKICAgICAgICAgICAgICAgIGlmICgkcXR5IDw9IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAkc3ViX3RvdGFsID0gJGl0ZW0tPnVuaXRfcHJpY2UgKiAkcXR5OwogICAgICAgICAgICAgICAgJHZhdCA9ICRpdGVtLT52YXRfcGVyY2VudGFnZSA+IDAgPyAkc3ViX3RvdGFsICogKCRpdGVtLT52YXRfcGVyY2VudGFnZSAvIDEwMCkgOiAwOwogICAgICAgICAgICAgICAgJGV4Y2x1c2l2ZSA9ICRpdGVtLT52YXRfdHlwZSA9PSAnZXhjbHVzaXZlJyA/ICR2YXQgOiAwOwogICAgICAgICAgICAgICAgJHRvdGFsX2Ftb3VudCA9ICRzdWJfdG90YWwgKyAkZXhjbHVzaXZlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAkZ29vZHNSZWNlaXZlZEl0ZW0gPSBHb29kc1JlY2VpdmVkSXRlbTo6Y3JlYXRlKFsKICAgICAgICAgICAgICAgICAgICAnZ29vZHNfcmVjZWl2ZWRfbm90ZV9pZCcgPT4gJGdvb2RzUmVjZWl2ZWROb3RlLT5pZCwKICAgICAgICAgICAgICAgICAgICAncHJvZHVjdF9pZCcgPT4gJGl0ZW0tPnByb2R1Y3RfaWQsCiAgICAgICAgICAgICAgICAgICAgJ3VuaXRfYW1vdW50JyA9PiAkaXRlbS0+dW5pdF9wcmljZSwKICAgICAgICAgICAgICAgICAgICAncXR5JyA9PiAkcXR5LAogICAgICAgICAgICAgICAgICAgICdzdWJfdG90YWwnID0+ICRzdWJfdG90YWwsCiAgICAgICAgICAgICAgICAgICAgJ2Rpc2NvdW50X3BlcmNlbnRhZ2UnID0+IDAsCiAgICAgICAgICAgICAgICAgICAgJ2Rpc2NvdW50JyA9PiAwLAogICAgICAgICAgICAgICAgICAgICd2YXRfdHlwZScgPT4gJGl0ZW0tPnZhdF90eXBlLAogICAgICAgICAgICAgICAgICAgICd2YXRfcGVyY2VudGFnZScgPT4gJGl0ZW0tPnZhdF9wZXJjZW50YWdlLAogICAgICAgICAgICAgICAgICAgICd2YXQnID0+ICR2YXQsCiAgICAgICAgICAgICAgICAgICAgJ3RvdGFsX2Ftb3VudCcgPT4gJHRvdGFsX2Ftb3VudCwKICAgICAgICAgICAgICAgICAgICAncXVhbGl0eV9lbnN1cmUnID0+ICdhcHByb3ZlZCcsCiAgICAgICAgICAgICAgICAgICAgJ3JlY2VpdmVkX3F0eScgPT4gJHF0eSwKICAgICAgICAgICAgICAgICAgICAndXBkYXRlZF9hdCcgPT4gbm93KCksCiAgICAgICAgICAgICAgICAgICAgJ3VwZGF0ZWRfYnknID0+IGF1dGgoKS0+aWQoKSwKICAgICAgICAgICAgICAgIF0pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAkc3RvY2tJbiA9IEdvb2RzUmVjZWl2ZWRJdGVtU3RvY2tJbjo6Y3JlYXRlKFsKICAgICAgICAgICAgICAgICAgICAncHVyY2hhc2Vfb3JkZXJfaWQnID0+ICRwdXJjaGFzZU9yZGVyLT5pZCwKICAgICAgICAgICAgICAgICAgICAnZ29vZHNfcmVjZWl2ZWRfaXRlbV9pZCcgPT4gJGdvb2RzUmVjZWl2ZWRJdGVtLT5pZCwKICAgICAgICAgICAgICAgICAgICAncmVmZXJlbmNlX25vJyA9PiB1bmlxdWVDb2RlKDE4LCAnUUUtQVAtJyAuIGRhdGUoJ3knLCBzdHJ0b3RpbWUoJHJlcXVlc3QtPmRhdGUpKSAuICctJyAuIGF1dGgoKS0+dXNlcigpLT5lbXBsb3llZS0+dW5pdC0+aHJfdW5pdF9zaG9ydF9uYW1lIC4gJy0nLCAnZ29vZHNfcmVjZWl2ZWRfaXRlbXNfc3RvY2tfaW4nLCAnaWQnKSwKICAgICAgICAgICAgICAgICAgICAndW5pdF9hbW91bnQnID0+ICRpdGVtLT51bml0X3ByaWNlLAogICAgICAgICAgICAgICAgICAgICdyZWNlaXZlZF9xdHknID0+ICRxdHksCiAgICAgICAgICAgICAgICAgICAgJ3N1Yl90b3RhbCcgPT4gJHN1Yl90b3RhbCwKICAgICAgICAgICAgICAgICAgICAnZGlzY291bnRfcGVyY2VudGFnZScgPT4gMCwKICAgICAgICAgICAgICAgICAgICAnZGlzY291bnQnID0+IDAsCiAgICAgICAgICAgICAgICAgICAgJ3ZhdF90eXBlJyA9PiAkaXRlbS0+dmF0X3R5cGUsCiAgICAgICAgICAgICAgICAgICAgJ3ZhdF9wZXJjZW50YWdlJyA9PiAkaXRlbS0+dmF0X3BlcmNlbnRhZ2UsCiAgICAgICAgICAgICAgICAgICAgJ3ZhdCcgPT4gJHZhdCwKICAgICAgICAgICAgICAgICAgICAndG90YWxfYW1vdW50JyA9PiAkdG90YWxfYW1vdW50LAogICAgICAgICAgICAgICAgICAgICdpc19ncm5fY29tcGxldGUnID0+ICd5ZXMnLAogICAgICAgICAgICAgICAgICAgICd3YXJlaG91c2VfaWQnID0+IGF1dGgoKS0+dXNlcigpLT5yZWxVc2Vyc1dhcmVob3VzZS0+cGx1Y2soJ2lkJyktPmZpcnN0KCksCiAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgJHRoaXMtPnVwZGF0ZVFDUXVhbnRpdHkoJGdvb2RzUmVjZWl2ZWRJdGVtLT5pZCwgJHF0eSk7CiAgICAgICAgICAgICAgICAkc3RvY2tJbnNbXSA9ICRzdG9ja0luLT5pZDsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgJGVudHJ5ID0gJHRoaXMtPnJ1bkxlZGdlclF1ZXJpZXMoJHN0b2NrSW5zLCAkZ29vZHNSZWNlaXZlZE5vdGUsICRyZXF1ZXN0LT5kYXRlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICgkZW50cnlbJ3N1Y2Nlc3MnXSkgewogICAgICAgICAgICAgICAgUHVyY2hhc2VPcmRlckVudHJ5Ojp1cGRhdGVPckNyZWF0ZShbCiAgICAgICAgICAgICAgICAgICAgJ3N1cHBsaWVyX2lkJyA9PiAkcHVyY2hhc2VPcmRlci0+cmVsUXVvdGF0aW9uLT5zdXBwbGllcl9pZCwKICAgICAgICAgICAgICAgICAgICAncHVyY2hhc2Vfb3JkZXJfaWQnID0+ICRwdXJjaGFzZU9yZGVyLT5pZCwKICAgICAgICAgICAgICAgICAgICAndHlwZScgPT4gJ2dybicsCiAgICAgICAgICAgICAgICAgICAgJ2VudHJ5X2lkJyA9PiAkZW50cnlbJ2VudHJ5J11bJ2lkJ10sCiAgICAgICAgICAgICAgICBdLCBbCiAgICAgICAgICAgICAgICAgICAgJ3VwZGF0ZWRfYXQnID0+IG5vdygpLAogICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFzc2V0IENhcGl0YWxpemF0aW9uCiAgICAgICAgICAgICRwcm9qZWN0SWQgPSBvcHRpb25hbCgKICAgICAgICAgICAgICAgIG9wdGlvbmFsKCRwdXJjaGFzZU9yZGVyLT5wdXJjaGFzZU9yZGVyUmVxdWlzaXRpb25zLT5maXJzdCgpKS0+cmVxdWlzaXRpb24KICAgICAgICAgICAgKS0+cHJvamVjdFRhc2stPmlkID8/IG51bGw7CgogICAgICAgICAgICBmb3JlYWNoICgkc3RvY2tJbnMgYXMgJHN0b2NrX2luX2lkKSB7CiAgICAgICAgICAgICAgICAkc3RvY2tJbiA9IEdvb2RzUmVjZWl2ZWRJdGVtU3RvY2tJbjo6d2l0aCgncmVsR29vZHNSZWNlaXZlZEl0ZW1zLnJlbFByb2R1Y3QnKS0+ZmluZCgkc3RvY2tfaW5faWQpOwoKICAgICAgICAgICAgICAgIGlmICghJHN0b2NrSW4gfHwgJHN0b2NrSW4tPmlzX2dybl9jb21wbGV0ZSAhPT0gJ3llcycpIHsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAkcHJvZHVjdCA9ICRzdG9ja0luLT5yZWxHb29kc1JlY2VpdmVkSXRlbXMtPnJlbFByb2R1Y3Q7CgogICAgICAgICAgICAgICAgLy8gRXhwbGljaXQgYm9vbGVhbjogQ1dJUCBpZiBwcm9qZWN0IGV4aXN0cywgb3RoZXJ3aXNlIGZpeGVkIGFzc2V0CiAgICAgICAgICAgICAgICAkY2FwaXRhbGl6ZSA9ICRwcm9qZWN0SWQKICAgICAgICAgICAgICAgICAgICA/IChib29sKSAkcHJvZHVjdC0+aXNfY3dpcAogICAgICAgICAgICAgICAgICAgIDogKGJvb2wpICRwcm9kdWN0LT5pc19maXhlZF9hc3NldDsKCiAgICAgICAgICAgICAgICBpZiAoJGNhcGl0YWxpemUgJiYgJHN0b2NrSW4tPnJlY2VpdmVkX3F0eSA+IDApIHsKICAgICAgICAgICAgICAgICAgICAkYmF0Y2ggPSBGaXhlZEFzc2V0QmF0Y2g6OmNyZWF0ZShbCiAgICAgICAgICAgICAgICAgICAgICAgICdnb29kc19yZWNlaXZlZF9pdGVtc19zdG9ja19pbl9pZCcgPT4gJHN0b2NrSW4tPmlkLAogICAgICAgICAgICAgICAgICAgICAgICAnYmF0Y2gnID0+IHVuaXF1ZUNvZGVXaXRob3V0UHJlZml4KDgsICdmaXhlZF9hc3NldF9iYXRjaGVzJywgJ2JhdGNoJyksCiAgICAgICAgICAgICAgICAgICAgICAgICdjb3N0X2NlbnRyZV9pZCcgPT4gJHN0b2NrSW4tPnJlbEdvb2RzUmVjZWl2ZWRJdGVtcy0+cmVsR29vZHNSZWNlaXZlZE5vdGUtPnJlbFB1cmNoYXNlT3JkZXItPmNvc3RfY2VudHJlX2lkLAogICAgICAgICAgICAgICAgICAgICAgICAncmVxdWlzaXRpb25fZGVsaXZlcnlfaXRlbV9pZCcgPT4gJHByb2R1Y3QtPmlkLAoKICAgICAgICAgICAgICAgICAgICAgICAgJ2RlcHJlY2lhdGlvbl9tZXRob2RfaWQnID0+ICRwcm9kdWN0LT5kZXByZWNpYXRpb25fbWV0aG9kX2lkLAogICAgICAgICAgICAgICAgICAgICAgICAnYmFzZV9yYXRlJyA9PiAkcHJvZHVjdC0+YmFzZV9yYXRlLAogICAgICAgICAgICAgICAgICAgICAgICAncmF0ZV9tdWx0aXBsaWVyJyA9PiAkcHJvZHVjdC0+cmF0ZV9tdWx0aXBsaWVyLAogICAgICAgICAgICAgICAgICAgICAgICAnZGVwcmVjaWF0aW9uX3JhdGUnID0+ICRwcm9kdWN0LT5kZXByZWNpYXRpb25fcmF0ZSwKICAgICAgICAgICAgICAgICAgICAgICAgJ2lzX3llYXJseScgPT4gKGJvb2wpICRwcm9kdWN0LT5pc195ZWFybHksCiAgICAgICAgICAgICAgICAgICAgICAgICd5ZWFycycgPT4gJHByb2R1Y3QtPnllYXJzLAogICAgICAgICAgICAgICAgICAgICAgICAnaXNfb25ldGltZScgPT4gKGJvb2wpICRwcm9kdWN0LT5pc19vbmV0aW1lLAogICAgICAgICAgICAgICAgICAgICAgICAnZGVwcmVjaWF0aW9uX3N0YXJ0X2RhdGUnID0+ICRzdG9ja0luLT51cGRhdGVkX2F0LT5mb3JtYXQoJ1ktbS1kJyksCiAgICAgICAgICAgICAgICAgICAgXSk7CgogICAgICAgICAgICAgICAgICAgIGZvcmVhY2ggKHJhbmdlKDEsICRzdG9ja0luLT5yZWNlaXZlZF9xdHkpIGFzICRpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIEZpeGVkQXNzZXRCYXRjaEl0ZW06OmNyZWF0ZShbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZml4ZWRfYXNzZXRfYmF0Y2hfaWQnID0+ICRiYXRjaC0+aWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZmluYWxfYXNzZXRfaWQnID0+ICRwcm9kdWN0LT5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdhc3NldF9jb2RlJyA9PiAkYmF0Y2gtPmJhdGNoIC4gJy0nIC4gJGksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZGVwcmVjaWF0aW9uX21ldGhvZF9pZCcgPT4gJHByb2R1Y3QtPmRlcHJlY2lhdGlvbl9tZXRob2RfaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnYmFzZV9yYXRlJyA9PiAkcHJvZHVjdC0+YmFzZV9yYXRlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3JhdGVfbXVsdGlwbGllcicgPT4gJHByb2R1Y3QtPnJhdGVfbXVsdGlwbGllciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdkZXByZWNpYXRpb25fcmF0ZScgPT4gJHByb2R1Y3QtPmRlcHJlY2lhdGlvbl9yYXRlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2lzX3llYXJseScgPT4gKGJvb2wpICRwcm9kdWN0LT5pc195ZWFybHksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAneWVhcnMnID0+ICRwcm9kdWN0LT55ZWFycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdpc19vbmV0aW1lJyA9PiAoYm9vbCkgJHByb2R1Y3QtPmlzX29uZXRpbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZGVwcmVjaWF0aW9uX3N0YXJ0X2RhdGUnID0+ICRzdG9ja0luLT51cGRhdGVkX2F0LT5mb3JtYXQoJ1ktbS1kJyksCiAgICAgICAgICAgICAgICAgICAgICAgIF0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlcXVpc2l0aW9uIHRyYWNraW5nIHVwZGF0ZQogICAgICAgICAgICBmb3JlYWNoICgkcHVyY2hhc2VPcmRlci0+cHVyY2hhc2VPcmRlclJlcXVpc2l0aW9ucyBhcyAkcG9yKSB7CiAgICAgICAgICAgICAgICAkcmVxX2lkID0gJHBvci0+cmVxdWlzaXRpb25faWQ7CiAgICAgICAgICAgICAgICByZXF1aXNpdGlvblRyYWNraW5nSGlzdG9yeSgkcmVxX2lkLCAnZ3JuX2NvbXBsZXRlZCcsICdHUk4gQ29tcGxldGVkJyk7CiAgICAgICAgICAgICAgICByZXF1aXNpdGlvblRyYWNraW5nSGlzdG9yeSgkcmVxX2lkLCAnYWNrbm93bGVkZ2VkX2J5X3JlcXVpc2l0b3InLCAnQWNrbm93bGVkZ2VkIGJ5IFJlcXVpc2l0b3InKTsKICAgICAgICAgICAgICAgIFJlcXVpc2l0aW9uVHJhY2tpbmc6OnN0b3JlUmVxdWlzaXRpb25UcmFja2luZygkcmVxX2lkLCAnZGVsaXZlcmVkJyk7CiAgICAgICAgICAgICAgICBSZXF1aXNpdGlvblRyYWNraW5nOjpzdG9yZVJlcXVpc2l0aW9uVHJhY2tpbmcoJHJlcV9pZCwgJ3JlY2VpdmVkJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIERCOjpjb21taXQoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHNlc3Npb24oKS0+Zmxhc2goJ2FsZXJ0LXR5cGUnLCAnc3VjY2VzcycpOwogICAgICAgICAgICBzZXNzaW9uKCktPmZsYXNoKCdtZXNzYWdlJywgJ1NlcnZpY2UgaGFzIGJlZW4gY29uZmlybWVkIHN1Y2Nlc3NmdWxseS4nKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiB0cnVlLAogICAgICAgICAgICAgICAgJ3N1cHBsaWVyX2lkJyA9PiAkcHVyY2hhc2VPcmRlci0+cmVsUXVvdGF0aW9uLT5zdXBwbGllcl9pZCwKICAgICAgICAgICAgICAgICdncm5faWQnID0+ICRnb29kc1JlY2VpdmVkTm90ZS0+aWQKICAgICAgICAgICAgXSk7CiAgICAgICAgfSBjYXRjaCAoXFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgREI6OnJvbGxiYWNrKCk7CiAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiBmYWxzZSwKICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAkdGgtPmdldE1lc3NhZ2UoKQogICAgICAgICAgICBdKTsKICAgICAgICB9CiAgICB9CiAgICAKICAgIHB1YmxpYyBmdW5jdGlvbiB1cGRhdGVRQ1F1YW50aXR5KCRnb29kc19yZWNlaXZlZF9pdGVtX2lkLCAkcWNfcXR5KQogICAgewogICAgICAgIGlmICgkcWNfcXR5IDw9IDApIHsKICAgICAgICAgICAgcmV0dXJuOyAvLyBOb3RoaW5nIHRvIHVwZGF0ZSBpZiBRQyBxdHkgaXMgemVybyBvciBsZXNzCiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vIEdldCB0aGUgR29vZHNSZWNlaXZlZEl0ZW0KICAgICAgICAkZ29vZHNSZWNlaXZlZEl0ZW0gPSBHb29kc1JlY2VpdmVkSXRlbTo6ZmluZCgkZ29vZHNfcmVjZWl2ZWRfaXRlbV9pZCk7CiAgICAgICAgCiAgICAgICAgaWYgKCEkZ29vZHNSZWNlaXZlZEl0ZW0pIHsKICAgICAgICAgICAgcmV0dXJuOyAvLyBGYWlsLXNhZmUgaWYgbm90IGZvdW5kCiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vIENhbGN1bGF0ZSB0b3RhbCByZXF1aXNpdGlvbiBxdWFudGl0eSBmb3IgdGhpcyBwcm9kdWN0IGFuZCBHUk4KICAgICAgICAkcmVxdWlzaXRpb25fcXR5ID0gUmVxdWlzaXRpb25JdGVtOjp3aGVyZSgncHJvZHVjdF9pZCcsICRnb29kc1JlY2VpdmVkSXRlbS0+cHJvZHVjdF9pZCkKICAgICAgICAgICAgLT53aGVyZUhhcygncmVxdWlzaXRpb24ucHVyY2hhc2VPcmRlcnMucHVyY2hhc2VPcmRlci5yZWxHb29kUmVjZWl2ZU5vdGUnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRnb29kc1JlY2VpdmVkSXRlbSkgewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2lkJywgJGdvb2RzUmVjZWl2ZWRJdGVtLT5nb29kc19yZWNlaXZlZF9ub3RlX2lkKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT5zdW0oJ3F0eScpOwogICAgICAgIAogICAgICAgICRwZXJjZW50YWdlID0gKCRyZXF1aXNpdGlvbl9xdHkgPiAwICYmICRxY19xdHkgPiAwKSA/ICgkcWNfcXR5IC8gJHJlcXVpc2l0aW9uX3F0eSkgKiAxMDAgOiAwOwogICAgICAgIAogICAgICAgIC8vIEdldCByZWxhdGVkIHJlcXVpc2l0aW9ucwogICAgICAgICRyZXF1aXNpdGlvbnMgPSAkZ29vZHNSZWNlaXZlZEl0ZW0tPnJlbEdvb2RzUmVjZWl2ZWROb3RlLT5yZWxQdXJjaGFzZU9yZGVyLT5wdXJjaGFzZU9yZGVyUmVxdWlzaXRpb25zCiAgICAgICAgICAgIC0+cGx1Y2soJ3JlcXVpc2l0aW9uX2lkJykKICAgICAgICAgICAgLT50b0FycmF5KCk7CiAgICAgICAgCiAgICAgICAgLy8gRmV0Y2ggbWF0Y2hpbmcgUmVxdWlzaXRpb25JdGVtcwogICAgICAgICRyZXF1aXNpdGlvbkl0ZW1zID0gUmVxdWlzaXRpb25JdGVtOjp3aGVyZUluKCdyZXF1aXNpdGlvbl9pZCcsICRyZXF1aXNpdGlvbnMpCiAgICAgICAgICAgIC0+d2hlcmUoJ3Byb2R1Y3RfaWQnLCAkZ29vZHNSZWNlaXZlZEl0ZW0tPnByb2R1Y3RfaWQpCiAgICAgICAgICAgIC0+Z2V0KCk7CiAgICAgICAgCiAgICAgICAgaWYgKCRyZXF1aXNpdGlvbkl0ZW1zLT5pc0VtcHR5KCkpIHsKICAgICAgICAgICAgcmV0dXJuOyAvLyBObyByZXF1aXNpdGlvbiBpdGVtcyBmb3VuZAogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBEaXN0cmlidXRlIFFDIHF1YW50aXR5IGFjcm9zcyByZXF1aXNpdGlvbiBpdGVtcyBwcm9wb3J0aW9uYWxseQogICAgICAgIGZvcmVhY2ggKCRyZXF1aXNpdGlvbkl0ZW1zIGFzICRyZXF1aXNpdGlvbkl0ZW0pIHsKICAgICAgICAgICAgaWYgKCRxY19xdHkgPD0gMCkgYnJlYWs7CiAgICAgICAgICAgIAogICAgICAgICAgICAkdGhpc19xY19xdHkgPSByb3VuZCgoJHBlcmNlbnRhZ2UgPiAwKSA/ICgkcmVxdWlzaXRpb25JdGVtLT5xdHkgKiAoJHBlcmNlbnRhZ2UgLyAxMDApKSA6IDApOwogICAgICAgICAgICAkdGhpc19xY19xdHkgPSBtaW4oJHRoaXNfcWNfcXR5LCAkcWNfcXR5KTsKICAgICAgICAgICAgCiAgICAgICAgICAgICRyZXF1aXNpdGlvbkl0ZW0tPnFjX3F0eSA9ICR0aGlzX3FjX3F0eTsKICAgICAgICAgICAgJHJlcXVpc2l0aW9uSXRlbS0+c2F2ZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgJHFjX3F0eSAtPSAkdGhpc19xY19xdHk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vIERpc3RyaWJ1dGUgYW55IHJlbWFpbmluZyBRQyBxdHkgdG8gdGhlIGZpcnN0IHJlcXVpc2l0aW9uIGl0ZW0KICAgICAgICBpZiAoJHFjX3F0eSA+IDApIHsKICAgICAgICAgICAgJGZpcnN0SXRlbSA9ICRyZXF1aXNpdGlvbkl0ZW1zLT5maXJzdCgpOwogICAgICAgICAgICAkZmlyc3RJdGVtLT5xY19xdHkgKz0gcm91bmQoJHFjX3F0eSk7CiAgICAgICAgICAgICRmaXJzdEl0ZW0tPnNhdmUoKTsKICAgICAgICB9CiAgICB9CiAgICAKICAgIAogICAgcHVibGljIGZ1bmN0aW9uIHJ1bkxlZGdlclF1ZXJpZXMoJGlkcywgJGdybiwgJGRhdGUpCiAgICB7CiAgICAgICAgJGFjY291bnREZWZhdWx0U2V0dGluZ3MgPSBhY2NvdW50RGVmYXVsdFNldHRpbmdzKCdqc29uJyk7CiAgICAgICAgJHN0b2NrSW5zID0gR29vZHNSZWNlaXZlZEl0ZW1TdG9ja0luOjp3aGVyZUluKCdpZCcsICRpZHMpLT53aGVyZSgnaXNfZ3JuX2NvbXBsZXRlJywgJ3llcycpLT53aXRoKFsKICAgICAgICAgICAgJ3JlbEdvb2RzUmVjZWl2ZWRJdGVtcy5yZWxHb29kc1JlY2VpdmVkTm90ZS5yZWxQdXJjaGFzZU9yZGVyJywKICAgICAgICAgICAgJ3JlbEdvb2RzUmVjZWl2ZWRJdGVtcy5yZWxQcm9kdWN0JwogICAgICAgIF0pLT5nZXQoKTsKICAgICAgICAKICAgICAgICAkaXRlbXMgPSBbXTsKICAgICAgICAkY29zdF9jZW50cmVfaWQgPSAwOwogICAgICAgIAogICAgICAgIGlmICgkc3RvY2tJbnMtPmlzTm90RW1wdHkoKSkgewogICAgICAgICAgICBmb3JlYWNoICgkc3RvY2tJbnMgYXMgJGl0ZW0pIHsKICAgICAgICAgICAgICAgICRwdXJjaGFzZU9yZGVyID0gJGl0ZW0tPnJlbEdvb2RzUmVjZWl2ZWRJdGVtcy0+cmVsR29vZHNSZWNlaXZlZE5vdGUtPnJlbFB1cmNoYXNlT3JkZXI7CiAgICAgICAgICAgICAgICAkcHJvZHVjdCA9ICRpdGVtLT5yZWxHb29kc1JlY2VpdmVkSXRlbXMtPnJlbFByb2R1Y3Q7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICRjb3N0X2NlbnRyZV9pZCA9ICRwdXJjaGFzZU9yZGVyLT5jb3N0X2NlbnRyZV9pZCA/PyAwOwogICAgICAgICAgICAgICAgJHRvdGFsX2Ftb3VudCA9ICRpdGVtLT50b3RhbF9hbW91bnQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERldGVybWluZSBEZWJpdCBBY2NvdW50CiAgICAgICAgICAgICAgICAkZGViaXRfYWNjb3VudCA9ICRhY2NvdW50RGVmYXVsdFNldHRpbmdzWydpbnZlbnRvcnlfYWNjb3VudCddOwogICAgICAgICAgICAgICAgaWYgKCRwcm9kdWN0LT5pc19zZXJ2aWNlID8/IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgJGRlYml0X2FjY291bnQgPSAkcHJvZHVjdC0+Y29nc19hY2NvdW50X2lkID4gMCA/ICRwcm9kdWN0LT5jb2dzX2FjY291bnRfaWQgOiAkYWNjb3VudERlZmF1bHRTZXR0aW5nc1snY29nc19hY2NvdW50J107CiAgICAgICAgICAgICAgICB9IGVsc2VpZiAoJHByb2R1Y3QtPmludmVudG9yeV9hY2NvdW50X2lkID4gMCkgewogICAgICAgICAgICAgICAgICAgICRkZWJpdF9hY2NvdW50ID0gJHByb2R1Y3QtPmludmVudG9yeV9hY2NvdW50X2lkOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBEZWJpdCBMaW5lCiAgICAgICAgICAgICAgICAkaXRlbXNbXSA9IFsKICAgICAgICAgICAgICAgICAgICAnY29zdF9jZW50cmVfaWQnID0+ICRjb3N0X2NlbnRyZV9pZCwKICAgICAgICAgICAgICAgICAgICAnY2hhcnRfb2ZfYWNjb3VudF9pZCcgPT4gJGRlYml0X2FjY291bnQsCiAgICAgICAgICAgICAgICAgICAgJ2RlYml0JyA9PiAkdG90YWxfYW1vdW50LAogICAgICAgICAgICAgICAgICAgICdjcmVkaXQnID0+IDAsCiAgICAgICAgICAgICAgICAgICAgJ25hcnJhdGlvbicgPT4gJ0dSTiA6OiBJbnZlbnRvcnkgRGViaXQnLAogICAgICAgICAgICAgICAgICAgICd0eXBlJyA9PiAnZ3JuJywKICAgICAgICAgICAgICAgICAgICAnc291cmNlJyA9PiAkaXRlbS0+aWQKICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENyZWRpdCBMaW5lIChHUi9JUiBBY2NvdW50KQogICAgICAgICAgICAgICAgJGl0ZW1zW10gPSBbCiAgICAgICAgICAgICAgICAgICAgJ2Nvc3RfY2VudHJlX2lkJyA9PiAkY29zdF9jZW50cmVfaWQsCiAgICAgICAgICAgICAgICAgICAgJ2NoYXJ0X29mX2FjY291bnRfaWQnID0+ICRhY2NvdW50RGVmYXVsdFNldHRpbmdzWydncmlyX2FjY291bnQnXSwKICAgICAgICAgICAgICAgICAgICAnZGViaXQnID0+IDAsCiAgICAgICAgICAgICAgICAgICAgJ2NyZWRpdCcgPT4gJHRvdGFsX2Ftb3VudCwKICAgICAgICAgICAgICAgICAgICAnbmFycmF0aW9uJyA9PiAnR1JOIDo6IEdSL0lSIENyZWRpdCcsCiAgICAgICAgICAgICAgICAgICAgJ3R5cGUnID0+ICdncm4nLAogICAgICAgICAgICAgICAgICAgICdzb3VyY2UnID0+ICRpdGVtLT5pZAogICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICAkbGVkZ2VyRGF0ZVRpbWUgPSBkYXRlKCdZLW0tZCBIOmk6cycsIHN0cnRvdGltZSgiJGRhdGUgIiAuIG5vdygpLT5mb3JtYXQoJ0g6aTpzJykpKTsKICAgICAgICAkZXhjaGFuZ2VfcmF0ZV9pZCA9ICRncm4tPnJlbFB1cmNoYXNlT3JkZXItPnJlbFF1b3RhdGlvbi0+ZXhjaGFuZ2VfcmF0ZV9pZCA/PyBudWxsOwogICAgICAgICRjb21wYW55X2lkID0gZ2V0Q29zdENlbnRyZUNvbXBhbnkoJGNvc3RfY2VudHJlX2lkKTsKICAgICAgICAKICAgICAgICByZXR1cm4gc2F2ZUxlZGdlckVudHJpZXMoCiAgICAgICAgICAgIDUsICAgICAgICAgICAgICAgICAgICAgLy8gTW9kdWxlIElEIChlLmcuLCA1ID0gSW52ZW50b3J5KQogICAgICAgICAgICAkbGVkZ2VyRGF0ZVRpbWUsICAgICAgIC8vIExlZGdlciBEYXRlCiAgICAgICAgICAgIDEsICAgICAgICAgICAgICAgICAgICAgLy8gU3RhdHVzICgxID0gYXBwcm92ZWQpCiAgICAgICAgICAgICcnLCAgICAgICAgICAgICAgICAgICAgLy8gUmVtYXJrcwogICAgICAgICAgICAnR1JOJywgICAgICAgICAgICAgICAgIC8vIFJlZmVyZW5jZQogICAgICAgICAgICAkaXRlbXMsICAgICAgICAgICAgICAgIC8vIExlZGdlciBJdGVtcwogICAgICAgICAgICAkZXhjaGFuZ2VfcmF0ZV9pZCwgICAgIC8vIEV4Y2hhbmdlIFJhdGUgSUQKICAgICAgICAgICAgMCwgMCwgMCwgICAgICAgICAgICAgICAvLyBEZWJpdCwgQ3JlZGl0LCBBZGp1c3RtZW50CiAgICAgICAgICAgICRjb21wYW55X2lkLCAgICAgICAgICAgLy8gQ29tcGFueSBJRCAoZnJvbSBhIGNvc3QgY2VudHJlKQogICAgICAgICAgICBmYWxzZSwgICAgICAgICAgICAgICAgIC8vIGlzX3JldmVyc2FsCiAgICAgICAgICAgICdqc29uJyAgICAgICAgICAgICAgICAgLy8gUmVzcG9uc2UgZm9ybWF0CiAgICAgICAgKTsKICAgIH0KICAgIAp9Cg==