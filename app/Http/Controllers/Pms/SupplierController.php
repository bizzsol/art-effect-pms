<?php
bolt_decrypt( __FILE__ , 'ZTmi9C'); return 0;
##!!!##CgpuYW1lc3BhY2UgQXBwXEh0dHBcQ29udHJvbGxlcnNcUG1zOwoKdXNlIEFwcFxIdHRwXENvbnRyb2xsZXJzXENvbnRyb2xsZXI7CnVzZSBBcHBcTW9kZWxzXE1lcmNoXFN1cHBsaWVyOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcR3JuXEdvb2RzUmVjZWl2ZWROb3RlOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUGF5bWVudFRlcm07CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xTdXBwbGllclBheW1lbnRUZXJtOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcU3VwcGxpZXJSYXRpbmdzOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcU3VwcGxpZXJzOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcU3VwcGxpZXJBZGRyZXNzOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcU3VwcGxpZXJCYW5rQWNjb3VudDsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFN1cHBsaWVyQ29udGFjdFBlcnNvbjsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFN1cHBsaWVyTG9nOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUHJvZHVjdDsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXENhdGVnb3J5Owp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcU3VwcGxpZXJMZWRnZXJzOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcQWNjb3VudHNcQ2hhcnRPZkFjY291bnQ7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xBY2NvdW50c1xDdXJyZW5jeTsKCnVzZSBJbGx1bWluYXRlXEh0dHBcUmVxdWVzdDsKdXNlIElsbHVtaW5hdGVcU3VwcG9ydFxGYWNhZGVzXFNjaGVtYTsKdXNlIERCLCBWaWV3LCBEYXRhVGFibGVzOwoKY2xhc3MgU3VwcGxpZXJDb250cm9sbGVyIGV4dGVuZHMgQ29udHJvbGxlcgp7ICAgCgogICAgcHVibGljIGZ1bmN0aW9uIGhlYWRlckNvbHVtbnMoJHZhbHVlPScnKQogICAgewogICAgICAgICRyb3dzID0gIGFycmF5KAogICAgICAgICAgICBbJ1NMJywgJ1NMJ10sCiAgICAgICAgICAgIFsnY29kZScsICdjb2RlJ10sCiAgICAgICAgICAgIFsnbmFtZScsICduYW1lJ10sCiAgICAgICAgICAgIFsncHJvZHVjdF9jYXRlZ29yaWVzJywgJ3Byb2R1Y3RfY2F0ZWdvcmllcycsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ2NvcnBvcmF0ZV9hZGRyZXNzJywgJ2NvcnBvcmF0ZV9hZGRyZXNzJywgJ3RleHQtbGVmdCddLCAKICAgICAgICAgICAgWydjb250YWN0X3BlcnNvbl9uYW1lJywgJ2NvbnRhY3RfcGVyc29uX25hbWUnLCAndGV4dC1sZWZ0J10sCiAgICAgICAgICAgIFsnbW9iaWxlX25vJywgJ21vYmlsZV9ubycsICd0ZXh0LWxlZnQnXSwgCiAgICAgICAgICAgIFsnY2xvc2luZ19iYWxhbmNlJywgJ2Nsb3NpbmdfYmFsYW5jZScsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ2FwcHJvdmFsJywgJ2FwcHJvdmFsJywgJ3RleHQtY2VudGVyIHB1cmNoYXNlLWFjdGlvbnMnXSwKICAgICAgICAgICAgWydzdGF0dXMnLCAnc3RhdHVzJywgJ3RleHQtY2VudGVyIG1hbmFnZW1lbnQtYWN0aW9ucyddLCAKICAgICAgICAgICAgWydhY3Rpb25zJywgJ2FjdGlvbnMnLCAndGV4dC1jZW50ZXInXQogICAgICAgICk7CgogICAgICAgIGlmICghcmVxdWVzdCgpLT5oYXMoJ3Byb2R1Y3RzJykpIHsKICAgICAgICAgICAgdW5zZXQoJHJvd3NbN10pOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBpZiAoYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ0FjY291bnRzJykpIHsKICAgICAgICAgICAgdW5zZXQoJHJvd3NbOF0pOwogICAgICAgICAgICB1bnNldCgkcm93c1s5XSk7CiAgICAgICAgICAgIHVuc2V0KCRyb3dzWzEwXSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gJHJvd3M7CiAgICB9CiAgICAvKioKICAgICAqIERpc3BsYXkgYSBsaXN0aW5nIG9mIHRoZSByZXNvdXJjZS4KICAgICAqCiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwogICAgcHVibGljIGZ1bmN0aW9uIGluZGV4KCkKICAgIHsKICAgICAgICAvKgogICAgICAgIGlmKHJlcXVlc3QoKS0+aGFzKCdnZW5lcmF0ZS1zdXBwbGllci1jdXJyZW5jaWVzJykpewogICAgICAgICAgICBmb3JlYWNoKFN1cHBsaWVyczo6ZG9lc250SGF2ZSgnc3VwcGxlaWVyQ3VycmVuY2llcycpLT5nZXQoKSBhcyAka2V5ID0+ICRzdXBwbGllcil7CiAgICAgICAgICAgICAgICBcQXBwXE1vZGVsc1xQbXNNb2RlbHNcU3VwcGxpZXJDdXJyZW5jeTo6Y3JlYXRlKFsKICAgICAgICAgICAgICAgICAgICAnc3VwcGxpZXJfaWQnID0+ICRzdXBwbGllci0+aWQsCiAgICAgICAgICAgICAgICAgICAgJ2N1cnJlbmN5X2lkJyA9PiAxLAogICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgKi8KCiAgICAgICAgLyoKICAgICAgICBpZihyZXF1ZXN0KCktPmhhcygnZ2VuZXJhdGUtc3VwcGxpZXItY29kZXMnKSl7CiAgICAgICAgICAgIGZvcmVhY2goU3VwcGxpZXJzOjp3aGVyZU51bGwoJ2NvZGUnKS0+Z2V0KCkgYXMgJGtleSA9PiAkc3VwcGxpZXIpewogICAgICAgICAgICAgICAgJHN1cHBsaWVyLT5jb2RlID0gJHRoaXMtPnN1cHBsaWVyQ29kZSgkc3VwcGxpZXIpOwogICAgICAgICAgICAgICAgJHN1cHBsaWVyLT5zYXZlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgKi8KCiAgICAgICAgLyoKICAgICAgICBpZihyZXF1ZXN0KCktPmhhcygndXBkYXRlLXByb2R1Y3RzLWZvci1pbnRlcm5hbC1qb2Itb3JkZXInKSl7CiAgICAgICAgICAgIHVwZGF0ZVN1cHBsaWVyUHJvZHVjdHMoMTIpOwogICAgICAgIH0KICAgICAgICAqLyAKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgJG9wdGlvbnMgPSBbCiAgICAgICAgICAgICAgICAnUHVyY2hhc2UtRW1wbG95ZWUnID0+IGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdQdXJjaGFzZS1FbXBsb3llZScpLAogICAgICAgICAgICAgICAgJ1B1cmNoYXNlLURlcGFydG1lbnQnID0+IGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdQdXJjaGFzZS1EZXBhcnRtZW50JyksCiAgICAgICAgICAgICAgICAnTWFuYWdlbWVudCcgPT4gYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ01hbmFnZW1lbnQnKSwKICAgICAgICAgICAgICAgICdBY2NvdW50cycgPT4gYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ0FjY291bnRzJyksCiAgICAgICAgICAgICAgICAnUHVyY2hhc2UtRW1wbG95ZWUnID0+IGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdQdXJjaGFzZS1FbXBsb3llZScpLAogICAgICAgICAgICAgICAgJ3N1cHBsaWVyLWVkaXQnID0+IGF1dGgoKS0+dXNlcigpLT5oYXNQZXJtaXNzaW9uVG8oJ3N1cHBsaWVyLWVkaXQnKSwKICAgICAgICAgICAgICAgICdzdXBwbGllci1kZWxldGUnID0+IGF1dGgoKS0+dXNlcigpLT5oYXNQZXJtaXNzaW9uVG8oJ3N1cHBsaWVyLWRlbGV0ZScpLAogICAgICAgICAgICBdOwoKICAgICAgICAgICAgJHRpdGxlID0gJ1N1cHBsaWVycyc7CiAgICAgICAgICAgICRzdXBwbGllcnMgPSBTdXBwbGllcnM6OndpdGgoWwogICAgICAgICAgICAgICAgJ3Byb2R1Y3RzLmNhdGVnb3J5LmNhdGVnb3J5JywgJ2FkZHJlc3NlcycsICdjb250YWN0UGVyc29ucycsICdzdXBwbGllckNsb3NpbmdCYWxhbmNlJywgJ3JlbFF1b3RhdGlvbnMnCiAgICAgICAgICAgIF0pCiAgICAgICAgICAgIC0+d2hlbigkb3B0aW9uc1snUHVyY2hhc2UtRW1wbG95ZWUnXSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlTm90SW4oJ2FwcHJvdmVkX2J5JywgWydwdXJjaGFzZS1kZWNsaW5lZCcsICdtYW5hZ2VtZW50LWRlY2xpbmVkJ10pOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPndoZW4oJG9wdGlvbnNbJ1B1cmNoYXNlLURlcGFydG1lbnQnXSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSW4oJ2FwcHJvdmVkX2J5JywgWydzZW50LXRvLXB1cmNoYXNlJywgJ3B1cmNoYXNlLWFwcHJvdmVkJywgJ21hbmFnZW1lbnQtYXBwcm92ZWQnXSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+d2hlbigkb3B0aW9uc1snTWFuYWdlbWVudCddLCBmdW5jdGlvbigkcXVlcnkpewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVJbignYXBwcm92ZWRfYnknLCBbJ3B1cmNoYXNlLWFwcHJvdmVkJywgJ21hbmFnZW1lbnQtYXBwcm92ZWQnXSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+d2hlbigkb3B0aW9uc1snQWNjb3VudHMnXSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPmhhcygncmVsUGF5bWVudHMucmVsU3VwcGxpZXJMZWRnZXJzJyk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+d2hlbighZGF0YXRhYmxlT3JkZXJpbmcoKSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyYnkoJ2lkJywgJ2Rlc2MnKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIC8vIC0+d2hlcmVOb3RJbignaWQnLFsxMiwxM10pCiAgICAgICAgICAgIC8vIC0+d2hlcmUoJ2lkJywgJz4nLCAxMCk7CgogICAgICAgICAgICAkY2F0ZWdvcmllcyA9IGNvbGxlY3QoQ2F0ZWdvcnk6OndpdGgoJ3N1YkNhdGVnb3J5JyktPndoZXJlSGFzKCdzdWJDYXRlZ29yeScpLT5nZXQoKSk7CiAgICAgICAgICAgICRzdWJDYXRlZ29yaWVzID0gY29sbGVjdChDYXRlZ29yeTo6d2hlcmVIYXMoJ2NhdGVnb3J5JyktPmdldCgpKTsKCiAgICAgICAgICAgIGlmIChyZXF1ZXN0KCktPmFqYXgoKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIERhdGF0YWJsZXM6Om9mKCRzdXBwbGllcnMpCiAgICAgICAgICAgICAgICAtPmFkZEluZGV4Q29sdW1uKCkKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdwcm9kdWN0X2NhdGVnb3JpZXMnLCBmdW5jdGlvbigkc3VwcGxpZXIpIHVzZSgkY2F0ZWdvcmllcywgJHN1YkNhdGVnb3JpZXMpewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkY2F0ZWdvcmllcy0+d2hlcmVJbignaWQnLCAkc3ViQ2F0ZWdvcmllcy0+d2hlcmVJbignaWQnLCAkc3VwcGxpZXItPnByb2R1Y3RzLT5wbHVjaygnY2F0ZWdvcnlfaWQnKS0+dG9BcnJheSgpKS0+cGx1Y2soJ3BhcmVudF9pZCcpLT50b0FycmF5KCkpLT5wbHVjaygnbmFtZScpLT5pbXBsb2RlKCcsICcpOwogICAgICAgICAgICAgICAgICAgIC8vIHJldHVybiBDYXRlZ29yeTo6d2hlcmVIYXMoJ3N1YkNhdGVnb3J5JywgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJHN1cHBsaWVyKXsKICAgICAgICAgICAgICAgICAgICAvLyAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVJbignaWQnLCAkc3VwcGxpZXItPnByb2R1Y3RzLT5wbHVjaygnY2F0ZWdvcnlfaWQnKS0+dG9BcnJheSgpKTsKICAgICAgICAgICAgICAgICAgICAvLyB9KS0+cGx1Y2soJ25hbWUnKS0+aW1wbG9kZSgnLCAnKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbigncHJvZHVjdF9jYXRlZ29yaWVzJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncHJvZHVjdHMuY2F0ZWdvcnkuY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJyk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2NvcnBvcmF0ZV9hZGRyZXNzJywgZnVuY3Rpb24oJHN1cHBsaWVyKXsKICAgICAgICAgICAgICAgICAgICAgJGFkZHJlc3MgPSAnJzsKICAgICAgICAgICAgICAgICAgICAgJGNvcnBvcmF0ZUFkZHJlc3MgPSAkc3VwcGxpZXItPmFkZHJlc3Nlcy0+d2hlcmUoJ3R5cGUnLCAnY29ycG9yYXRlJyk7CiAgICAgICAgICAgICAgICAgICAgIGlmKGlzc2V0KCRjb3Jwb3JhdGVBZGRyZXNzWzBdLT5pZCkpewogICAgICAgICAgICAgICAgICAgICAgICAkYWRkcmVzcyAuPSAkY29ycG9yYXRlQWRkcmVzc1swXS0+dmlsbGFnZS4nICcuJGNvcnBvcmF0ZUFkZHJlc3NbMF0tPnJvYWQuJywgJy4kY29ycG9yYXRlQWRkcmVzc1swXS0+Y2l0eS4nLScuJGNvcnBvcmF0ZUFkZHJlc3NbMF0tPnppcC4nLCAnLiRjb3Jwb3JhdGVBZGRyZXNzWzBdLT5jb3VudHJ5IC4nPGJyPicuICRjb3Jwb3JhdGVBZGRyZXNzWzBdLT5hZGRyZXNzOwogICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHJldHVybiAgJGFkZHJlc3M7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ2NvcnBvcmF0ZV9hZGRyZXNzJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygnYWRkcmVzc2VzJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ3JvYWQnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmUoJ3R5cGUnLCAnY29ycG9yYXRlJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5vcldoZXJlKGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRrZXl3b3JkKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnemlwJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPm9yV2hlcmUoJ2NvdW50cnknLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+b3JXaGVyZSgnYWRkcmVzcycsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5vcldoZXJlKCd2aWxsYWdlJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2NvbnRhY3RfcGVyc29uX25hbWUnLCBmdW5jdGlvbigkc3VwcGxpZXIpewogICAgICAgICAgICAgICAgICAgICRjb250YWN0UGVyc29uID0gJyc7CgogICAgICAgICAgICAgICAgICAgICRjb250YWN0UGVyc29uU2FsZXMgPSAkc3VwcGxpZXItPmNvbnRhY3RQZXJzb25zLT53aGVyZSgndHlwZScsICdzYWxlcycpOwoKICAgICAgICAgICAgICAgICAgICBpZihpc3NldCgkY29udGFjdFBlcnNvblNhbGVzWzBdLT5pZCkpewogICAgICAgICAgICAgICAgICAgICAgICAkY29udGFjdFBlcnNvbiAuPSAkY29udGFjdFBlcnNvblNhbGVzWzBdLT5uYW1lOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICAkY29udGFjdFBlcnNvbjsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbignY29udGFjdF9wZXJzb25fbmFtZScsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ2NvbnRhY3RQZXJzb25zJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdtb2JpbGVfbm8nLCBmdW5jdGlvbigkc3VwcGxpZXIpewogICAgICAgICAgICAgICAgICAgICRjb250YWN0UGVyc29uID0gJyc7CgogICAgICAgICAgICAgICAgICAgICRjb250YWN0UGVyc29uU2FsZXMgPSAkc3VwcGxpZXItPmNvbnRhY3RQZXJzb25zLT53aGVyZSgndHlwZScsICdzYWxlcycpOwoKICAgICAgICAgICAgICAgICAgICBpZihpc3NldCgkY29udGFjdFBlcnNvblNhbGVzWzBdLT5pZCkpewogICAgICAgICAgICAgICAgICAgICAgICAkY29udGFjdFBlcnNvbiAuPSAkY29udGFjdFBlcnNvblNhbGVzWzBdLT5tb2JpbGU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICByZXR1cm4gICRjb250YWN0UGVyc29uOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdtb2JpbGVfbm8nLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdjb250YWN0UGVyc29ucycsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdtb2JpbGUnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdjbG9zaW5nX2JhbGFuY2UnLCBmdW5jdGlvbigkc3VwcGxpZXIpIHVzZSgkb3B0aW9ucyl7CiAgICAgICAgICAgICAgICAgICAgaWYoJG9wdGlvbnNbJ0FjY291bnRzJ10pewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNzZXQoJHN1cHBsaWVyLT5zdXBwbGllckNsb3NpbmdCYWxhbmNlLT5jbG9zaW5nX2JhbGFuY2UpID8gJHN1cHBsaWVyLT5zdXBwbGllckNsb3NpbmdCYWxhbmNlLT5jbG9zaW5nX2JhbGFuY2UgOiAwOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2FwcHJvdmFsJywgZnVuY3Rpb24oJHN1cHBsaWVyKSB1c2UoJG9wdGlvbnMpewogICAgICAgICAgICAgICAgICAgICRzdXBwbGllclN0YXR1cyA9IHN1cHBsaWVyU3RhdHVzKCRzdXBwbGllcik7CiAgICAgICAgICAgICAgICAgICAgJGFwcHJvdmFscyA9ICcnOwogICAgICAgICAgICAgICAgICAgIGlmKCEkb3B0aW9uc1snQWNjb3VudHMnXSl7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkc3VwcGxpZXJTdGF0dXNbJ2FwcHJvdmFsJ10gJiYgKCRvcHRpb25zWydQdXJjaGFzZS1EZXBhcnRtZW50J10gfHwgJG9wdGlvbnNbJ01hbmFnZW1lbnQnXSkpCiAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYXBwcm92YWxzIC49ICc8YSBjbGFzcz0iYnRuIGJ0bi14cyBidG4tJy4kc3VwcGxpZXJTdGF0dXNbJ2FwcHJvdmVkX2NsYXNzJ10gLiciIGRhdGEtYXBwcm92ZWQtYnk9IicuJHN1cHBsaWVyLT5hcHByb3ZlZF9ieSAuJyIgZGF0YS1zdGF0dXM9IicuJHN1cHBsaWVyLT5zdGF0dXMuJyIgIGRhdGEtd2hpY2g9ImFwcHJvdmFsIiBkYXRhLXN1cHBsaWVyLWlkPSInLiRzdXBwbGllci0+aWQuJyIgb25jbGljaz0idG9nZ2xlU3VwcGxpZXJTdGF0dXMoJCh0aGlzKSkiPjxpIGNsYXNzPSInLiAkc3VwcGxpZXJTdGF0dXNbJ2FwcHJvdmVkX2ljb24nXSAuJyI+PC9pPiZuYnNwOycuICRzdXBwbGllclN0YXR1c1snYXBwcm92ZWRfdGV4dCddIC4nPC9hPic7CiAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhcHByb3ZhbHMgLj0gJzxhIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi0nLiRzdXBwbGllclN0YXR1c1snYXBwcm92ZWRfY2xhc3MnXSAuJyIgZGF0YS1hcHByb3ZlZC1ieT0iJy4kc3VwcGxpZXItPmFwcHJvdmVkX2J5IC4nIiBkYXRhLXN0YXR1cz0iJy4kc3VwcGxpZXItPnN0YXR1cy4nIiAgZGF0YS13aGljaD0iYXBwcm92YWwiIGRhdGEtc3VwcGxpZXItaWQ9IicuJHN1cHBsaWVyLT5pZC4nIiA+PGkgY2xhc3M9IicuICRzdXBwbGllclN0YXR1c1snYXBwcm92ZWRfaWNvbiddIC4nIj48L2k+Jm5ic3A7Jy4gJHN1cHBsaWVyU3RhdHVzWydhcHByb3ZlZF90ZXh0J10gLic8L2E+JzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGFwcHJvdmFsczsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmVkaXRDb2x1bW4oJ3N0YXR1cycsIGZ1bmN0aW9uKCRzdXBwbGllcikgdXNlKCRvcHRpb25zKXsKICAgICAgICAgICAgICAgICAgICAkc3RhdHVzID0gJyc7CgogICAgICAgICAgICAgICAgICAgIGlmKCEkb3B0aW9uc1snQWNjb3VudHMnXSl7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmKCRvcHRpb25zWydNYW5hZ2VtZW50J10gJiYgJHN1cHBsaWVyLT5hcHByb3ZlZF9ieSA9PSAibWFuYWdlbWVudC1hcHByb3ZlZCIpewogICAgICAgICAgICAgICAgICAgICAgICBpZigkc3VwcGxpZXItPmFwcHJvdmVkX2J5ID09ICJtYW5hZ2VtZW50LWFwcHJvdmVkIil7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc3RhdHVzIC49ICc8YSBjbGFzcz0iYnRuIGJ0bi0nLigkc3VwcGxpZXItPnN0YXR1cyA9PSAiQWN0aXZlIiA/ICJzdWNjZXNzIiA6ICJkYW5nZXIiKS4nIGJ0bi1ibG9jayBidG4teHMiIGRhdGEtYXBwcm92ZWQtYnk9IicuICRzdXBwbGllci0+YXBwcm92ZWRfYnkgLiciIGRhdGEtc3RhdHVzPSInLiAkc3VwcGxpZXItPnN0YXR1cyAuJyIgZGF0YS13aGljaD0ic3RhdHVzIiBkYXRhLXN1cHBsaWVyLWlkPSInLiAkc3VwcGxpZXItPmlkIC4nIiBvbmNsaWNrPSJ0b2dnbGVTdXBwbGllclN0YXR1cygkKHRoaXMpKSIgPjxpIGNsYXNzPSInLiAoJHN1cHBsaWVyLT5zdGF0dXMgPT0gIkFjdGl2ZSIgPyAibGFyIGxhLWNoZWNrLWNpcmNsZSIgOiAibGEgbGEtYmFuIikuJyI+PC9pPiZuYnNwOycuICgkc3VwcGxpZXItPnN0YXR1cyA9PSAiQWN0aXZlIiA/ICJBY3RpdmUiIDogIlBlbmRpbmciICkuJzwvYT4nOwogICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzdGF0dXMgLj0gJzxhIGNsYXNzPSJidG4gYnRuLScuICgkc3VwcGxpZXItPnN0YXR1cyA9PSAiQWN0aXZlIiA/ICJzdWNjZXNzIiA6ICJkYW5nZXIiICkuJyBidG4tYmxvY2sgYnRuLXhzIiBkYXRhLWFwcHJvdmVkLWJ5PSInLiAkc3VwcGxpZXItPmFwcHJvdmVkX2J5IC4nIiBkYXRhLXN0YXR1cz0iJy4gJHN1cHBsaWVyLT5zdGF0dXMgLiciIGRhdGEtd2hpY2g9InN0YXR1cyIgZGF0YS1zdXBwbGllci1pZD0iJy4gJHN1cHBsaWVyLT5pZCAuJyIgb25jbGljaz0idG9nZ2xlU3VwcGxpZXJTdGF0dXMoJCh0aGlzKSkiID48aSBjbGFzcz0iJy4gKCRzdXBwbGllci0+c3RhdHVzID09ICJBY3RpdmUiID8gImxhciBsYS1jaGVjay1jaXJjbGUiIDogImxhIGxhLWJhbiIgKS4nIj48L2k+Jm5ic3A7Jy4gKCRzdXBwbGllci0+c3RhdHVzID09ICJBY3RpdmUiID8gIkFjdGl2ZSIgOiAiUGVuZGluZyIpIC4nPC9hPic7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRzdGF0dXM7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2FjdGlvbnMnLCBmdW5jdGlvbigkc3VwcGxpZXIpIHVzZSgkb3B0aW9ucyl7CiAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgPSAnJzsKCiAgICAgICAgICAgICAgICAgICAgaWYoISRvcHRpb25zWydBY2NvdW50cyddKXsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCRvcHRpb25zWydzdXBwbGllci1lZGl0J10pewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxhIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi1zdWNjZXNzIHJvdW5kZWQtY2lyY2xlIG0tMSIgaHJlZj0iJy5yb3V0ZSgncG1zLnN1cHBsaWVyLmVkaXQnLCAkc3VwcGxpZXItPmlkKS4nIj48aSBjbGFzcz0ibGEgbGEtZWRpdCI+PC9pPjwvYT4nOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPScgPGEgaHJlZj0iJy4gcm91dGUoJ3Btcy5zdXBwbGllci5wcm9maWxlJywgJHN1cHBsaWVyLT5pZCkgLiciIGNsYXNzPSJidG4gYnRuLWluZm8gbS0xIGJ0bi14cyI+PGkgY2xhc3M9ImxhcyBsYS11c2VyIj48L2k+PC9hPic7CgogICAgICAgICAgICAgICAgICAgICAgICBpZigkc3VwcGxpZXItPmRlbGV0YWJsZSA9PSAneWVzJyAmJiAhZnJlZXplU3VwcGxpZXIoJHN1cHBsaWVyKSAmJiAkb3B0aW9uc1snc3VwcGxpZXItZGVsZXRlJ10pewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgY2xhc3M9ImJ0biBidG4teHMgYnRuLWRhbmdlciBtLTEiIGRhdGEtc3JjPSInLnJvdXRlKCdwbXMuc3VwcGxpZXIuZGVzdHJveScsICRzdXBwbGllci0+aWQpLiciIG9uY2xpY2s9ImRlbGV0ZUZyb21DUlVEKCQodGhpcykpIj48aSBjbGFzcz0ibGEgbGEtdHJhc2giPjwvaT48L2E+JzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRhY3Rpb25zOwoKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPnJhd0NvbHVtbnMoWydjb3Jwb3JhdGVfYWRkcmVzcycsJ3Byb2R1Y3RfY2F0ZWdvcmllcycsJ2FwcHJvdmFsJywnc3RhdHVzJywgJ2FjdGlvbnMnXSkKICAgICAgICAgICAgICAgIC0+bWFrZSh0cnVlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnN1cHBsaWVycy5pbmRleCcsIFsKICAgICAgICAgICAgICAgICd0aXRsZScgPT4kdGl0bGUsCiAgICAgICAgICAgICAgICAnaGVhZGVyQ29sdW1ucycgPT4gJHRoaXMtPmhlYWRlckNvbHVtbnMoKQogICAgICAgICAgICBdKTsKICAgICAgICB9Y2F0Y2ggKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIHNob3dEZWNsaW5lU3VwcGxpZXJzKCkKICAgIHsKICAgICAgICB0cnkgewoKICAgICAgICAgICAgJHRpdGxlID0gJ0RlY2xpbmUgU3VwcGxpZXJzJzsKICAgICAgICAgICAgJHN1cHBsaWVycyA9IFN1cHBsaWVyczo6d2hlbihhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnUHVyY2hhc2UtRW1wbG95ZWUnKSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdjcmVhdGVkX2J5JyxhdXRoKCktPnVzZXIoKS0+aWQpCiAgICAgICAgICAgICAgICAtPndoZXJlSW4oJ2FwcHJvdmVkX2J5JywgWydwdXJjaGFzZS1kZWNsaW5lZCcsICdtYW5hZ2VtZW50LWRlY2xpbmVkJ10pOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPndoZW4oYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ1B1cmNoYXNlLURlcGFydG1lbnQnKSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSW4oJ2FwcHJvdmVkX2J5JywgWydwdXJjaGFzZS1kZWNsaW5lZCcsICdtYW5hZ2VtZW50LWRlY2xpbmVkJ10pOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPndoZW4oYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ01hbmFnZW1lbnQnKSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdhcHByb3ZlZF9ieScsICdtYW5hZ2VtZW50LWRlY2xpbmVkJyk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+d2hlbihhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnQWNjb3VudHMnKSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPmhhcygncmVsUGF5bWVudHMucmVsU3VwcGxpZXJMZWRnZXJzJyk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+d2hlbighZGF0YXRhYmxlT3JkZXJpbmcoKSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyYnkoJ2lkJywgJ2Rlc2MnKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAkZGVjbGluZSA9IHRydWU7CgogICAgICAgICAgICAgaWYgKHJlcXVlc3QoKS0+YWpheCgpKSB7CiAgICAgICAgICAgIHJldHVybiBEYXRhdGFibGVzOjpvZigkc3VwcGxpZXJzKQogICAgICAgICAgICAtPmFkZEluZGV4Q29sdW1uKCkKICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3Byb2R1Y3RfY2F0ZWdvcmllcycsIGZ1bmN0aW9uKCRzdXBwbGllcil7CiAgICAgICAgICAgICAgICByZXR1cm4gQ2F0ZWdvcnk6OndoZXJlSGFzKCdzdWJDYXRlZ29yeScsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRzdXBwbGllcil7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVJbignaWQnLCBDYXRlZ29yeTo6d2hlcmVIYXMoJ3Byb2R1Y3RzJywgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJHN1cHBsaWVyKXsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVJbignaWQnLCAkc3VwcGxpZXItPnByb2R1Y3RzLT5wbHVjaygnaWQnKS0+dG9BcnJheSgpKTsKICAgICAgICAgICAgICAgICAgICB9KS0+cGx1Y2soJ2lkJyktPnRvQXJyYXkoKSk7CiAgICAgICAgICAgICAgICB9KS0+cGx1Y2soJ25hbWUnKS0+aW1wbG9kZSgnLCAnKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3Byb2R1Y3RfY2F0ZWdvcmllcycsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncHJvZHVjdHMuY2F0ZWdvcnkuY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPmZpbHRlckNvbHVtbignY29ycG9yYXRlX2FkZHJlc3MnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ2FkZHJlc3NlcycsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ3JvYWQnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpCiAgICAgICAgICAgICAgICAgICAgLT5vcldoZXJlKCd6aXAnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpCiAgICAgICAgICAgICAgICAgICAgLT5vcldoZXJlKCdjb3VudHJ5JywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKQogICAgICAgICAgICAgICAgICAgIC0+b3JXaGVyZSgnYWRkcmVzcycsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJykKICAgICAgICAgICAgICAgICAgICAtPm9yV2hlcmUoJ3ZpbGxhZ2UnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdjb250YWN0X3BlcnNvbl9uYW1lJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdjb250YWN0UGVyc29ucycsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdjb3Jwb3JhdGVfYWRkcmVzcycsIGZ1bmN0aW9uKCRzdXBwbGllcil7CiAgICAgICAgICAgICAgICAkYWRkcmVzcyA9ICcnOwogICAgICAgICAgICAgICAgJGNvcnBvcmF0ZUFkZHJlc3MgPSBcQXBwXE1vZGVsc1xQbXNNb2RlbHNcU3VwcGxpZXJBZGRyZXNzOjp3aGVyZShbJ3N1cHBsaWVyX2lkJyA9PiAkc3VwcGxpZXItPmlkLCAndHlwZScgPT4gJ2NvcnBvcmF0ZSddKS0+Zmlyc3QoKTsKCiAgICAgICAgICAgICAgICBpZihpc3NldCgkY29ycG9yYXRlQWRkcmVzcy0+aWQpKXsKICAgICAgICAgICAgICAgICAgICAkYWRkcmVzcyAuPSAkY29ycG9yYXRlQWRkcmVzcy0+dmlsbGFnZS4nICcuJGNvcnBvcmF0ZUFkZHJlc3MtPnJvYWQuJywgJy4kY29ycG9yYXRlQWRkcmVzcy0+Y2l0eS4nLScuJGNvcnBvcmF0ZUFkZHJlc3MtPnppcC4nLCAnLiRjb3Jwb3JhdGVBZGRyZXNzLT5jb3VudHJ5IC4nPGJyPicuICRjb3Jwb3JhdGVBZGRyZXNzLT5hZGRkcmVzczsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gICRhZGRyZXNzOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPmFkZENvbHVtbignY29udGFjdF9wZXJzb25fbmFtZScsIGZ1bmN0aW9uKCRzdXBwbGllcil7CiAgICAgICAgICAgICAgICAkY29udGFjdFBlcnNvbiA9ICcnOwoKICAgICAgICAgICAgICAgICRjb250YWN0UGVyc29uU2FsZXMgPSBcQXBwXE1vZGVsc1xQbXNNb2RlbHNcU3VwcGxpZXJDb250YWN0UGVyc29uOjp3aGVyZShbJ3N1cHBsaWVyX2lkJyA9PiBpc3NldCgkc3VwcGxpZXItPmlkKSA/ICRzdXBwbGllci0+aWQgOiAwLCAndHlwZScgPT4gJ3NhbGVzJ10pLT5maXJzdCgpOwoKICAgICAgICAgICAgICAgIGlmKGlzc2V0KCRjb250YWN0UGVyc29uU2FsZXMtPmlkKSl7CiAgICAgICAgICAgICAgICAgICAgJGNvbnRhY3RQZXJzb24gLj0gJGNvbnRhY3RQZXJzb25TYWxlcy0+bmFtZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gICRjb250YWN0UGVyc29uOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPmFkZENvbHVtbignbW9iaWxlX25vJywgZnVuY3Rpb24oJHN1cHBsaWVyKXsKICAgICAgICAgICAgICAgICRjb250YWN0UGVyc29uID0gJyc7CgogICAgICAgICAgICAgICAgJGNvbnRhY3RQZXJzb25TYWxlcyA9IFxBcHBcTW9kZWxzXFBtc01vZGVsc1xTdXBwbGllckNvbnRhY3RQZXJzb246OndoZXJlKFsnc3VwcGxpZXJfaWQnID0+IGlzc2V0KCRzdXBwbGllci0+aWQpID8gJHN1cHBsaWVyLT5pZCA6IDAsICd0eXBlJyA9PiAnc2FsZXMnXSktPmZpcnN0KCk7CgogICAgICAgICAgICAgICAgaWYoaXNzZXQoJGNvbnRhY3RQZXJzb25TYWxlcy0+aWQpKXsKICAgICAgICAgICAgICAgICAgICAkY29udGFjdFBlcnNvbiAuPSAkY29udGFjdFBlcnNvblNhbGVzLT5tb2JpbGU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuICAkY29udGFjdFBlcnNvbjsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdtb2JpbGVfbm8nLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ2NvbnRhY3RQZXJzb25zJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnbW9iaWxlJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPmFkZENvbHVtbignY2xvc2luZ19iYWxhbmNlJywgZnVuY3Rpb24oJHN1cHBsaWVyKXsKICAgICAgICAgICAgICAgIGlmKGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdBY2NvdW50cycpKXsKICAgICAgICAgICAgICAgICAgICAkbGVkZ2VyID0gU3VwcGxpZXJMZWRnZXJzOjp3aGVyZUhhcygncmVsU3VwcGxpZXJQYXltZW50JywgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJHN1cHBsaWVyKXsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ3N1cHBsaWVyX2lkJywgJHN1cHBsaWVyLT5pZCk7CiAgICAgICAgICAgICAgICAgICAgfSktPm9yZGVyQnkoJ2lkJywgJ2Rlc2MnKS0+Zmlyc3QoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNzZXQoJGxlZGdlci0+aWQpID8gJGxlZGdlci0+Y2xvc2luZ19iYWxhbmNlIDogJyc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdhcHByb3ZhbCcsIGZ1bmN0aW9uKCRzdXBwbGllcil7CiAgICAgICAgICAgICAgICAkc3VwcGxpZXJTdGF0dXMgPSBzdXBwbGllclN0YXR1cygkc3VwcGxpZXIpOwogICAgICAgICAgICAgICAgJGFwcHJvdmFscyA9ICcnOwogICAgICAgICAgICAgICAgaWYoIWF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdBY2NvdW50cycpKXsKICAgICAgICAgICAgICAgICAgICBpZiAoJHN1cHBsaWVyU3RhdHVzWydhcHByb3ZhbCddICYmIChhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnUHVyY2hhc2UtRGVwYXJ0bWVudCcpIHx8IGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdNYW5hZ2VtZW50JykpKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGFwcHJvdmFscyAuPSAnPGEgY2xhc3M9ImJ0biBidG4teHMgYnRuLScuJHN1cHBsaWVyU3RhdHVzWydhcHByb3ZlZF9jbGFzcyddIC4nIiBkYXRhLWFwcHJvdmVkLWJ5PSInLiRzdXBwbGllci0+YXBwcm92ZWRfYnkgLiciIGRhdGEtc3RhdHVzPSInLiRzdXBwbGllci0+c3RhdHVzLiciICBkYXRhLXdoaWNoPSJhcHByb3ZhbCIgZGF0YS1zdXBwbGllci1pZD0iJy4kc3VwcGxpZXItPmlkLiciIG9uY2xpY2s9InRvZ2dsZVN1cHBsaWVyU3RhdHVzKCQodGhpcykpIj48aSBjbGFzcz0iJy4gJHN1cHBsaWVyU3RhdHVzWydhcHByb3ZlZF9pY29uJ10gLiciPjwvaT4mbmJzcDsnLiAkc3VwcGxpZXJTdGF0dXNbJ2FwcHJvdmVkX3RleHQnXSAuJzwvYT4nOwogICAgICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgICAgICAkYXBwcm92YWxzIC49ICc8YSBjbGFzcz0iYnRuIGJ0bi14cyBidG4tJy4kc3VwcGxpZXJTdGF0dXNbJ2FwcHJvdmVkX2NsYXNzJ10gLiciIGRhdGEtYXBwcm92ZWQtYnk9IicuJHN1cHBsaWVyLT5hcHByb3ZlZF9ieSAuJyIgZGF0YS1zdGF0dXM9IicuJHN1cHBsaWVyLT5zdGF0dXMuJyIgIGRhdGEtd2hpY2g9ImFwcHJvdmFsIiBkYXRhLXN1cHBsaWVyLWlkPSInLiRzdXBwbGllci0+aWQuJyIgPjxpIGNsYXNzPSInLiAkc3VwcGxpZXJTdGF0dXNbJ2FwcHJvdmVkX2ljb24nXSAuJyI+PC9pPiZuYnNwOycuJHN1cHBsaWVyU3RhdHVzWydhcHByb3ZlZF90ZXh0J10uJzwvYT4nOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiAkYXBwcm92YWxzOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPmVkaXRDb2x1bW4oJ3N0YXR1cycsIGZ1bmN0aW9uKCRzdXBwbGllcil7CiAgICAgICAgICAgICAgICAkc3RhdHVzID0gJyc7CgogICAgICAgICAgICAgICAgaWYoIWF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdBY2NvdW50cycpKXsKICAgICAgICAgICAgICAgICAgICAvLyBpZihhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnTWFuYWdlbWVudCcpICYmICRzdXBwbGllci0+YXBwcm92ZWRfYnkgPT0gIm1hbmFnZW1lbnQtYXBwcm92ZWQiKXsKICAgICAgICAgICAgICAgICAgICBpZigkc3VwcGxpZXItPmFwcHJvdmVkX2J5ID09ICJtYW5hZ2VtZW50LWFwcHJvdmVkIil7CiAgICAgICAgICAgICAgICAgICAgICAgICRzdGF0dXMgLj0gJzxhIGNsYXNzPSJidG4gYnRuLScuKCRzdXBwbGllci0+c3RhdHVzID09ICJBY3RpdmUiID8gInN1Y2Nlc3MiIDogImRhbmdlciIpLicgYnRuLWJsb2NrIGJ0bi14cyIgZGF0YS1hcHByb3ZlZC1ieT0iJy4gJHN1cHBsaWVyLT5hcHByb3ZlZF9ieSAuJyIgZGF0YS1zdGF0dXM9IicuICRzdXBwbGllci0+c3RhdHVzIC4nIiBkYXRhLXdoaWNoPSJzdGF0dXMiIGRhdGEtc3VwcGxpZXItaWQ9IicuICRzdXBwbGllci0+aWQgLiciIG9uY2xpY2s9InRvZ2dsZVN1cHBsaWVyU3RhdHVzKCQodGhpcykpIiA+PGkgY2xhc3M9IicuICgkc3VwcGxpZXItPnN0YXR1cyA9PSAiQWN0aXZlIiA/ICJsYXIgbGEtY2hlY2stY2lyY2xlIiA6ICJsYSBsYS1iYW4iKS4nIj48L2k+Jm5ic3A7Jy4gKCRzdXBwbGllci0+c3RhdHVzID09ICJBY3RpdmUiID8gIkFjdGl2ZSIgOiAiUGVuZGluZyIgKS4nPC9hPic7CiAgICAgICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgICAgICRzdGF0dXMgLj0gJzxhIGNsYXNzPSJidG4gYnRuLScuICgkc3VwcGxpZXItPnN0YXR1cyA9PSAiQWN0aXZlIiA/ICJzdWNjZXNzIiA6ICJkYW5nZXIiICkuJyBidG4tYmxvY2sgYnRuLXhzIiBkYXRhLWFwcHJvdmVkLWJ5PSInLiAkc3VwcGxpZXItPmFwcHJvdmVkX2J5IC4nIiBkYXRhLXN0YXR1cz0iJy4gJHN1cHBsaWVyLT5zdGF0dXMgLiciIGRhdGEtd2hpY2g9InN0YXR1cyIgZGF0YS1zdXBwbGllci1pZD0iJy4gJHN1cHBsaWVyLT5pZCAuJyIgb25jbGljaz0idG9nZ2xlU3VwcGxpZXJTdGF0dXMoJCh0aGlzKSkiID48aSBjbGFzcz0iJy4gKCRzdXBwbGllci0+c3RhdHVzID09ICJBY3RpdmUiID8gImxhciBsYS1jaGVjay1jaXJjbGUiIDogImxhIGxhLWJhbiIgKS4nIj48L2k+Jm5ic3A7Jy4gKCRzdXBwbGllci0+c3RhdHVzID09ICJBY3RpdmUiID8gIkFjdGl2ZSIgOiAiUGVuZGluZyIpIC4nPC9hPic7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuICRzdGF0dXM7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdhY3Rpb25zJywgZnVuY3Rpb24oJHN1cHBsaWVyKXsKICAgICAgICAgICAgICAgICRhY3Rpb25zID0gJyc7CgogICAgICAgICAgICAgICAgaWYoIWF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdBY2NvdW50cycpKXsKCiAgICAgICAgICAgICAgICAgICAgaWYoYXV0aCgpLT51c2VyKCktPmhhc1Blcm1pc3Npb25Ubygnc3VwcGxpZXItZWRpdCcpKXsKICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxhIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi1zdWNjZXNzIHJvdW5kZWQtY2lyY2xlIG1sLTIiIGhyZWY9Iicucm91dGUoJ3Btcy5zdXBwbGllci5lZGl0JywgJHN1cHBsaWVyLT5pZCkuJyI+PGkgY2xhc3M9ImxhIGxhLWVkaXQiPjwvaT48L2E+JzsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49JyA8YSBocmVmPSInLiByb3V0ZSgncG1zLnN1cHBsaWVyLnByb2ZpbGUnLCAkc3VwcGxpZXItPmlkKSAuJyIgY2xhc3M9ImJ0biBidG4taW5mbyBtbC0yIGJ0bi14cyI+PGkgY2xhc3M9ImxhcyBsYS11c2VyIj48L2k+PC9hPic7CgogICAgICAgICAgICAgICAgICAgIGlmKCRzdXBwbGllci0+ZGVsZXRhYmxlID09ICd5ZXMnKXsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoYXV0aCgpLT51c2VyKCktPmhhc1Blcm1pc3Npb25Ubygnc3VwcGxpZXItZGVsZXRlJykpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgY2xhc3M9ImJ0biBidG4teHMgYnRuLWRhbmdlciBtbC0yIiBkYXRhLXNyYz0iJy5yb3V0ZSgncG1zLnN1cHBsaWVyLmRlc3Ryb3knLCAkc3VwcGxpZXItPmlkKS4nIiBvbmNsaWNrPSJkZWxldGVGcm9tQ1JVRCgkKHRoaXMpKSI+PGkgY2xhc3M9ImxhIGxhLXRyYXNoIj48L2k+PC9hPic7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuICRhY3Rpb25zOwoKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT5yYXdDb2x1bW5zKFsnY29ycG9yYXRlX2FkZHJlc3MnLCdwcm9kdWN0X2NhdGVnb3JpZXMnLCdhcHByb3ZhbCcsJ3N0YXR1cycsICdhY3Rpb25zJ10pCiAgICAgICAgICAgIC0+bWFrZSh0cnVlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnN1cHBsaWVycy5pbmRleCcsIFsKICAgICAgICAgICAgJ3RpdGxlJyA9PiR0aXRsZSwKICAgICAgICAgICAgJ2RlY2xpbmUnID0+JGRlY2xpbmUsCiAgICAgICAgICAgICdoZWFkZXJDb2x1bW5zJyA9PiAkdGhpcy0+aGVhZGVyQ29sdW1ucygpCiAgICAgICAgXSk7CgogICAgICAgIH1jYXRjaCAoXFRocm93YWJsZSAkdGgpewogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFNob3cgdGhlIGZvcm0gZm9yIGNyZWF0aW5nIGEgbmV3IHJlc291cmNlLgogICAgICoKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCiAgICBwdWJsaWMgZnVuY3Rpb24gY3JlYXRlKCkKICAgIHsKICAgICAgICB0cnkgewogICAgICAgICAgICAkZGF0YSA9IFsKICAgICAgICAgICAgICAgICd0aXRsZScgPT4gJ0NyZWF0ZSBOZXcgU3VwcGxpZXInLAogICAgICAgICAgICAgICAgJ2N1cnJlbmNpZXMnID0+IEN1cnJlbmN5OjphbGwoKSwKICAgICAgICAgICAgICAgICdwYXltZW50VGVybXMnID0+IFBheW1lbnRUZXJtOjpvcmRlckJ5KCdpZCcsJ0RFU0MnKS0+Z2V0KCksCiAgICAgICAgICAgICAgICAnc3ViQ2F0ZWdvcmllcycgPT4gQ2F0ZWdvcnk6OndpdGgoJ2NhdGVnb3J5JyktPmhhcygnY2F0ZWdvcnknKS0+b3JkZXJCeSgnbmFtZScsICdhc2MnKS0+Z2V0KCksCiAgICAgICAgICAgIF07CgogICAgICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMuc3VwcGxpZXJzLmNyZWF0ZScsICRkYXRhKTsKICAgICAgICB9Y2F0Y2ggKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBTdG9yZSBhIG5ld2x5IGNyZWF0ZWQgcmVzb3VyY2UgaW4gc3RvcmFnZS4KICAgICAqCiAgICAgKiBAcGFyYW0gIFxJbGx1bWluYXRlXEh0dHBcUmVxdWVzdCAgJHJlcXVlc3QKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCiAgICBwdWJsaWMgZnVuY3Rpb24gc3RvcmUoUmVxdWVzdCAkcmVxdWVzdCkKICAgIHsKICAgICAgICAkdGhpcy0+dmFsaWRhdGUoJHJlcXVlc3QsIFsKICAgICAgICAgICAgJ25hbWUnID0+IFsncmVxdWlyZWQnLCAnc3RyaW5nJywgJ21heDoyNTUnXSwKICAgICAgICAgICAgJ2VtYWlsJyA9PiBbJ251bGxhYmxlJywgJ3N0cmluZycsICdtYXg6MjU1JywgJ2VtYWlsJ10sCiAgICAgICAgICAgICdwaG9uZScgPT4gWydudWxsYWJsZScsICdzdHJpbmcnLCAnbWF4OjE0JywgJ3JlZ2V4Oi9eKFswLTlcc1wtXCtcKFwpXSopJC8nXSwKICAgICAgICAgICAgJ21vYmlsZV9ubycgPT4gWydudWxsYWJsZScsICdzdHJpbmcnLCAnbWF4OjE0JywgJ3JlZ2V4Oi9eKFswLTlcc1wtXCtcKFwpXSopJC8nXSwKICAgICAgICAgICAgJ3Rlcm1fY29uZGl0aW9uJyA9PiBbJ251bGxhYmxlJ10sCiAgICAgICAgICAgICdwYXltZW50X3Rlcm1faWQnID0+IFsnYXJyYXknLCdtaW46MSddLAoKICAgICAgICAgICAgJ3RyYWRlJyA9PiBbJ3JlcXVpcmVkJywgJ3N0cmluZycsICdtYXg6MjU1J10sCiAgICAgICAgICAgICd0aW4nID0+IFsnbnVsbGFibGUnLCAnc3RyaW5nJywgJ21heDoyNTUnXSwKICAgICAgICAgICAgJ3ZhdCcgPT4gWydudWxsYWJsZScsICdzdHJpbmcnLCAnbWF4OjI1NSddLAogICAgICAgICAgICAnb3duZXJfbmFtZScgPT4gWydudWxsYWJsZScsICdzdHJpbmcnLCAnbWF4OjI1NSddLAogICAgICAgICAgICAnb3duZXJfbmlkJyA9PiBbJ251bGxhYmxlJywgJ3N0cmluZycsICdtYXg6MjU1J10sCiAgICAgICAgICAgICdvd25lcl9jb250YWN0X25vJyA9PiBbJ251bGxhYmxlJywgJ3N0cmluZycsICdtYXg6MjU1J10sCiAgICAgICAgICAgICdjdXJyZW5jaWVzJyA9PiAncmVxdWlyZWQnLAogICAgICAgICAgICAnY3VycmVuY2llcy4qJyA9PiAncmVxdWlyZWQnLAogICAgICAgIF0pOwoKICAgICAgICBpZigkcmVxdWVzdC0+aGFzRmlsZSgnYXV0aF9wZXJzb25fbGV0dGVyX2ZpbGUnKSl7CiAgICAgICAgICAgICR0aGlzLT52YWxpZGF0ZSgkcmVxdWVzdCwgWwogICAgICAgICAgICAgICAgJ2F1dGhfcGVyc29uX2xldHRlcl9maWxlJyA9PiBbJ21pbWVzOnBkZixwbmcnLCAnbWF4OjIwNDgnXSwKICAgICAgICAgICAgXSk7CiAgICAgICAgfQoKICAgICAgICBpZigkcmVxdWVzdC0+aGFzRmlsZSgnb3duZXJfcGhvdG9fZmlsZScpKXsKICAgICAgICAgICAgJHRoaXMtPnZhbGlkYXRlKCRyZXF1ZXN0LCBbCiAgICAgICAgICAgICAgICAnb3duZXJfcGhvdG9fZmlsZScgPT4gWydtaW1lczpqcGVnLGpwZyxwbmcsZ2lmJywgJ21heDozMDcyJ10sCiAgICAgICAgICAgIF0pOwogICAgICAgIH0KCiAgICAgICAgREI6OmJlZ2luVHJhbnNhY3Rpb24oKTsKICAgICAgICB0cnkgewoKICAgICAgICAgICAgJHRlcm1QZXJjZW50YWdlcyA9IFtdOwogICAgICAgICAgICBpZihpc3NldCgkcmVxdWVzdC0+cGF5bWVudF90ZXJtX2lkWzBdKSl7CiAgICAgICAgICAgICAgICBmb3JlYWNoKCRyZXF1ZXN0LT5wYXltZW50X3Rlcm1faWQgYXMgJGtleSA9PiAkcGF5bWVudF90ZXJtX2lkKXsKICAgICAgICAgICAgICAgICAgICBpZighaXNzZXQoJHRlcm1QZXJjZW50YWdlc1skcGF5bWVudF90ZXJtX2lkXSkpewogICAgICAgICAgICAgICAgICAgICAgICAkdGVybVBlcmNlbnRhZ2VzWyRwYXltZW50X3Rlcm1faWRdID0gMDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgJHRlcm1QZXJjZW50YWdlc1skcGF5bWVudF90ZXJtX2lkXSArPSAkcmVxdWVzdC0+cGF5bWVudF9wZXJjZW50WyRrZXldOwoKICAgICAgICAgICAgICAgICAgICBpZigkdGVybVBlcmNlbnRhZ2VzWyRwYXltZW50X3Rlcm1faWRdID4gMTAwKXsKICAgICAgICAgICAgICAgICAgICAgICAgJHBheW1lbnRUZXJtID0gUGF5bWVudFRlcm06OmZpbmQoJHBheW1lbnRfdGVybV9pZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAnUGF5bWVudCBUZXJtICMnLiRwYXltZW50VGVybS0+dGVybS4nIHRvdGFsIHBlcmNlbnRhZ2VzIGhhdmUgYmVlbiBleGNlZWRlZCB0byAnLiR0ZXJtUGVyY2VudGFnZXNbJHBheW1lbnRfdGVybV9pZF0uJyUhJywKICAgICAgICAgICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAkaW5wdXRzID0gJHJlcXVlc3QtPmFsbCgpOwoKICAgICAgICAgICAgJHN1cHBsaWVyID0gU3VwcGxpZXJzOjpjcmVhdGUoJGlucHV0cyk7CiAgICAgICAgICAgICRzdXBwbGllci0+c3RhdHVzID0gJ0luYWN0aXZlJzsKICAgICAgICAgICAgJHN1cHBsaWVyLT5jb2RlID0gJHRoaXMtPnN1cHBsaWVyQ29kZSgkc3VwcGxpZXIpOwogICAgICAgICAgICAkc3VwcGxpZXItPnNhdmUoKTsKCiAgICAgICAgICAgICRzdXBwbGllci0+cHJvZHVjdHMoKS0+c3luYyhQcm9kdWN0Ojp3aGVyZUluKCdjYXRlZ29yeV9pZCcsIGlzc2V0KCRyZXF1ZXN0LT5zdWJfY2F0ZWdvcmllc1swXSkgPyAkcmVxdWVzdC0+c3ViX2NhdGVnb3JpZXMgOiBbXSktPnBsdWNrKCdpZCcpLT50b0FycmF5KCkpOwogICAgICAgICAgICAkc3VwcGxpZXItPmN1cnJlbmNpZXMoKS0+c3luYygkcmVxdWVzdC0+Y3VycmVuY2llcyk7CgogICAgICAgICAgICBpZiAoaXNzZXQoJHJlcXVlc3QtPnBheW1lbnRfdGVybV9pZFswXSkpIHsKICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRyZXF1ZXN0LT5wYXltZW50X3Rlcm1faWQgYXMgJGtleSA9PiAkcGF5bWVudF90ZXJtX2lkKXsKICAgICAgICAgICAgICAgICAgICAkcGFyZW50ID0gU3VwcGxpZXJQYXltZW50VGVybTo6d2hlcmUoWwogICAgICAgICAgICAgICAgICAgICAgICAnc3VwcGxpZXJfaWQnID0+ICRzdXBwbGllci0+aWQsCiAgICAgICAgICAgICAgICAgICAgICAgICdwYXltZW50X3Rlcm1faWQnID0+ICRwYXltZW50X3Rlcm1faWQKICAgICAgICAgICAgICAgICAgICBdKS0+Zmlyc3QoKTsKCiAgICAgICAgICAgICAgICAgICAgU3VwcGxpZXJQYXltZW50VGVybTo6Y3JlYXRlKFsKICAgICAgICAgICAgICAgICAgICAgICAgJ3N1cHBsaWVyX2lkJyA9PiAkc3VwcGxpZXItPmlkLAogICAgICAgICAgICAgICAgICAgICAgICAncGF5bWVudF90ZXJtX2lkJyA9PiAkcGF5bWVudF90ZXJtX2lkLAogICAgICAgICAgICAgICAgICAgICAgICAncGF5bWVudF9wZXJjZW50JyA9PiAkcmVxdWVzdC0+cGF5bWVudF9wZXJjZW50WyRrZXldLAogICAgICAgICAgICAgICAgICAgICAgICAnZGF5X2R1cmF0aW9uJyA9PiAkcmVxdWVzdC0+ZGF5X2R1cmF0aW9uWyRrZXldLAogICAgICAgICAgICAgICAgICAgICAgICAndHlwZScgPT4gJHJlcXVlc3QtPnR5cGVbJGtleV0sCiAgICAgICAgICAgICAgICAgICAgICAgICdwYXJlbnRfaWQnID0+IGlzc2V0KCRwYXJlbnQtPmlkKSA/ICRwYXJlbnQtPmlkIDogMCwKICAgICAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYoJHJlcXVlc3QtPmhhc0ZpbGUoJ2F1dGhfcGVyc29uX2xldHRlcl9maWxlJykpewogICAgICAgICAgICAgICAgJHN1cHBsaWVyLT5hdXRoX3BlcnNvbl9sZXR0ZXIgPSAkdGhpcy0+ZmlsZVVwbG9hZCgkcmVxdWVzdC0+ZmlsZSgnYXV0aF9wZXJzb25fbGV0dGVyX2ZpbGUnKSwgJ3VwbG9hZC9zdXBwbGllci1hdXRob3JpemF0aW9uLWxldHRlcicpOwogICAgICAgICAgICAgICAgJHN1cHBsaWVyLT5zYXZlKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmKCRyZXF1ZXN0LT5oYXNGaWxlKCdvd25lcl9waG90b19maWxlJykpewogICAgICAgICAgICAgICAgJHN1cHBsaWVyLT5vd25lcl9waG90byA9ICR0aGlzLT5maWxlVXBsb2FkKCRyZXF1ZXN0LT5maWxlKCdvd25lcl9waG90b19maWxlJyksICd1cGxvYWQvc3VwcGxpZXItb3duZXItcGhvdG8nLCB0cnVlKTsKICAgICAgICAgICAgICAgICRzdXBwbGllci0+c2F2ZSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAkbWVzc2FnZSA9ICc8c3BhbiBjbGFzcz0ibm90aWZpY2F0aW9uLWxpbmtzIiBkYXRhLXNyYz0iJy5yb3V0ZSgncG1zLnN1cHBsaWVyLnByb2ZpbGUnLCRzdXBwbGllci0+aWQpLic/dmlldyIgZGF0YS10aXRsZT0iU3VwcGxpZXJzIERldGFpbHMiPlN1cHBsaWVyOicuJHN1cHBsaWVyLT5uYW1lLicuV2F0dGluZyBmb3IgQXBwcm92YWwuPC9zcGFuPic7CgogICAgICAgICAgICBDcmVhdGVPclVwZGF0ZU5vdGlmaWNhdGlvbigkbWVzc2FnZSwndW5yZWFkJywnJyxnZXRNYW5hZ2VySW5mbygnUHVyY2hhc2UtRGVwYXJ0bWVudCcpLCdzZW5kLXRvLXB1cmNoYXNlJywnJyk7CgogICAgICAgICAgICBEQjo6Y29tbWl0KCk7CgogICAgICAgICAgICAkbm90aWZpY2F0aW9uID0gWwogICAgICAgICAgICAgICAgJ21lc3NhZ2UnID0+ICdBIHN1cHBsaWVyIGhhcyBiZWVuIGNyZWF0ZWQgc3VjY2Vzc2Z1bGx5JywKICAgICAgICAgICAgICAgICdhbGVydC10eXBlJyA9PiAnc3VjY2VzcycKICAgICAgICAgICAgXTsKCiAgICAgICAgICAgIHNlc3Npb24oKS0+Zmxhc2goJ21lc3NhZ2UnLCAiQSBzdXBwbGllciBoYXMgYmVlbiBjcmVhdGVkIHN1Y2Nlc3NmdWxseSIpOwogICAgICAgICAgICBzZXNzaW9uKCktPmZsYXNoKCdhbGVydC10eXBlJywgInN1Y2Nlc3MiKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnID0+IHRydWUsCiAgICAgICAgICAgICAgICAndXJsJyA9PiB1cmwoJ3Btcy9zdXBwbGllci8nLiRzdXBwbGllci0+aWQuJy9lZGl0JykKICAgICAgICAgICAgXSk7CiAgICAgICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgIERCOjpyb2xsYmFjaygpOwogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gZmFsc2UsCiAgICAgICAgICAgICAgICAnbWVzc2FnZScgPT4gJHRoLT5nZXRNZXNzYWdlKCkKICAgICAgICAgICAgXSk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogRGlzcGxheSB0aGUgc3BlY2lmaWVkIHJlc291cmNlLgogICAgICoKICAgICAqIEBwYXJhbSAgaW50ICAkaWQKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCiAgICBwdWJsaWMgZnVuY3Rpb24gc2hvdyhTdXBwbGllcnMgJHN1cHBsaWVyKQogICAgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgICRzdXBwbGllci0+c3JjID0gcm91dGUoJ3Btcy5zdXBwbGllci51cGRhdGUnLCRzdXBwbGllci0+aWQpOwogICAgICAgICAgICAkc3VwcGxpZXItPnJlcV90eXBlID0gJ3B1dCc7CiAgICAgICAgICAgICRkYXRhID0gWwogICAgICAgICAgICAgICAgJ3N0YXR1cycgPT4gJ3N1Y2Nlc3MnLAogICAgICAgICAgICAgICAgJ2luZm8nID0+ICRzdXBwbGllcgogICAgICAgICAgICBdOwoKICAgICAgICAgICAgLy9yZXR1cm4gJHN1cHBsaWVyOwogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbigkZGF0YSk7CiAgICAgICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgICRkYXRhID0gWwogICAgICAgICAgICAgICAgJ3N0YXR1cycgPT4gbnVsbCwKICAgICAgICAgICAgICAgICdpbmZvJyA9PiAkdGgtPmdldE1lc3NhZ2UoKQogICAgICAgICAgICBdOwogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbigkZGF0YSk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogU2hvdyB0aGUgZm9ybSBmb3IgZWRpdGluZyB0aGUgc3BlY2lmaWVkIHJlc291cmNlLgogICAgICoKICAgICAqIEBwYXJhbSAgaW50ICAkaWQKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCiAgICBwdWJsaWMgZnVuY3Rpb24gZWRpdCgkaWQpCiAgICB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgJHN1cHBsaWVyID0gU3VwcGxpZXJzOjp3aXRoKFsKICAgICAgICAgICAgICAgICdwcm9kdWN0cycsCiAgICAgICAgICAgICAgICAncmVsUXVvdGF0aW9ucycsCiAgICAgICAgICAgICAgICAncmVsUGF5bWVudFRlcm1zJywKICAgICAgICAgICAgICAgICdwYXlhYmxlQWNjb3VudCcsCiAgICAgICAgICAgICAgICAncGF5YWJsZVB1cmNoYXNlQWNjb3VudCcsCiAgICAgICAgICAgICAgICAncGF5YWJsZURpc2NvdW50QWNjb3VudCcsCiAgICAgICAgICAgICAgICAnYWR2YW5jZUFjY291bnQnLAogICAgICAgICAgICAgICAgJ2N1cnJlbmNpZXMnLAogICAgICAgICAgICAgICAgJ3N1cHBsZWllckN1cnJlbmNpZXMnCiAgICAgICAgICAgIF0pLT5maW5kT3JGYWlsKCRpZCk7CiAgICAgICAgICAgICRkYXRhID0gWwogICAgICAgICAgICAgICAgJ3RpdGxlJyA9PiAnVXBkYXRlIFN1cHBsaWVyIEluZm9ybWF0aW9uJywKICAgICAgICAgICAgICAgICdjdXJyZW5jaWVzJyA9PiBDdXJyZW5jeTo6YWxsKCksCiAgICAgICAgICAgICAgICAncGF5bWVudFRlcm1zJyA9PiBQYXltZW50VGVybTo6b3JkZXJCeSgnaWQnLCdERVNDJyktPnNlbGVjdCgnaWQnLCd0ZXJtJyktPmdldCgpLAogICAgICAgICAgICAgICAgJ3N1cHBsaWVyJyA9PiAkc3VwcGxpZXIsCiAgICAgICAgICAgICAgICAnY29ycG9yYXRlQWRkcmVzcycgPT4gU3VwcGxpZXJBZGRyZXNzOjp3aGVyZShbJ3N1cHBsaWVyX2lkJyA9PiAkaWQsICd0eXBlJyA9PiAnY29ycG9yYXRlJ10pLT5maXJzdCgpLAogICAgICAgICAgICAgICAgJ2ZhY3RvcnlBZGRyZXNzJyA9PiBTdXBwbGllckFkZHJlc3M6OndoZXJlKFsnc3VwcGxpZXJfaWQnID0+ICRpZCwgJ3R5cGUnID0+ICdmYWN0b3J5J10pLT5maXJzdCgpLAogICAgICAgICAgICAgICAgJ2NvbnRhY3RQZXJzb25TYWxlcycgPT4gU3VwcGxpZXJDb250YWN0UGVyc29uOjp3aGVyZShbJ3N1cHBsaWVyX2lkJyA9PiAkaWQsICd0eXBlJyA9PiAnc2FsZXMnXSktPmZpcnN0KCksCiAgICAgICAgICAgICAgICAnY29udGFjdFBlcnNvbkFmdGVyU2FsZXMnID0+IFN1cHBsaWVyQ29udGFjdFBlcnNvbjo6d2hlcmUoWydzdXBwbGllcl9pZCcgPT4gJGlkLCAndHlwZScgPT4gJ2FmdGVyLXNhbGVzJ10pLT5maXJzdCgpLAogICAgICAgICAgICAgICAgJ2JhbmtBY2NvdW50JyA9PiBTdXBwbGllckJhbmtBY2NvdW50Ojp3aGVyZShbJ3N1cHBsaWVyX2lkJyA9PiAkaWRdKS0+Zmlyc3QoKSwKICAgICAgICAgICAgICAgICdzdWJDYXRlZ29yaWVzJyA9PiBDYXRlZ29yeTo6d2l0aCgnY2F0ZWdvcnknKS0+aGFzKCdjYXRlZ29yeScpLT5vcmRlckJ5KCduYW1lJywgJ2FzYycpLT5nZXQoKSwKICAgICAgICAgICAgICAgICdzZWxlY3RlZFN1YkNhdGVnb3JpZXMnID0+IENhdGVnb3J5Ojp3aGVyZUhhcygncHJvZHVjdHMnLCBmdW5jdGlvbigkcXVlcnkpIHVzZSgkc3VwcGxpZXIpewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSW4oJ2lkJywgXERCOjp0YWJsZSgncHJvZHVjdHNfc3VwcGxpZXInKS0+d2hlcmUoJ3N1cHBsaWVyX2lkJywgJHN1cHBsaWVyLT5pZCktPnBsdWNrKCdwcm9kdWN0X2lkJyktPnRvQXJyYXkoKSk7CiAgICAgICAgICAgICAgICB9KS0+b3JkZXJCeSgnbmFtZScsICdhc2MnKS0+cGx1Y2soJ2lkJyktPnRvQXJyYXkoKSwKICAgICAgICAgICAgICAgICdwcm9kdWN0cycgPT4gUHJvZHVjdDo6d2l0aChbCiAgICAgICAgICAgICAgICAgICAgJ3Byb2R1Y3RVbml0JywKICAgICAgICAgICAgICAgICAgICAnY2F0ZWdvcnkuY2F0ZWdvcnknLAogICAgICAgICAgICAgICAgICAgICdhdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGUnLAogICAgICAgICAgICAgICAgXSktPndoZXJlSW4oJ2lkJywgJHN1cHBsaWVyLT5wcm9kdWN0cy0+cGx1Y2soJ2lkJyktPnRvQXJyYXkoKSktPmdldCgpLAogICAgICAgICAgICAgICAgJ2ZyZWV6ZVN1cHBsaWVyJyA9PiBmcmVlemVTdXBwbGllcigkc3VwcGxpZXIpLAogICAgICAgICAgICAgICAgJ2FjY291bnREZWZhdWx0U2V0dGluZ3MnID0+IGFjY291bnREZWZhdWx0U2V0dGluZ3MoJ2pzb24nKQogICAgICAgICAgICBdOwogICAgICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMuc3VwcGxpZXJzLmVkaXQnLCAkZGF0YSk7CiAgICAgICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogVXBkYXRlIHRoZSBzcGVjaWZpZWQgcmVzb3VyY2UgaW4gc3RvcmFnZS4KICAgICAqCiAgICAgKiBAcGFyYW0gIFxJbGx1bWluYXRlXEh0dHBcUmVxdWVzdCAgJHJlcXVlc3QKICAgICAqIEBwYXJhbSAgaW50ICAkaWQKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCiAgICBwdWJsaWMgZnVuY3Rpb24gdXBkYXRlKFJlcXVlc3QgJHJlcXVlc3QsIFN1cHBsaWVycyAkc3VwcGxpZXIpCiAgICB7CiAgICAgICAgaWYocmVxdWVzdCgpLT5oYXMoJ2Zvcm0tdHlwZScpICYmIHJlcXVlc3QoKS0+Z2V0KCdmb3JtLXR5cGUnKSA9PSAiYmFzaWMiKXsKICAgICAgICAgICAgaWYoIWZyZWV6ZVN1cHBsaWVyKCRzdXBwbGllcikpewogICAgICAgICAgICAgICAgJHJlcXVlc3QtPnZhbGlkYXRlKFsKICAgICAgICAgICAgICAgICAgICAnbmFtZScgPT4gWydyZXF1aXJlZCcsICdzdHJpbmcnLCAnbWF4OjI1NSddLAogICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgICRyZXF1ZXN0LT52YWxpZGF0ZShbCiAgICAgICAgICAgICAgICAnZW1haWwnID0+IFsnbnVsbGFibGUnLCAnc3RyaW5nJywgJ21heDoyNTUnLCAnZW1haWwnXSwKICAgICAgICAgICAgICAgICdwaG9uZScgPT4gWydudWxsYWJsZScsICdzdHJpbmcnLCAnbWF4OjE0JywgJ3JlZ2V4Oi9eKFswLTlcc1wtXCtcKFwpXSopJC8nXSwKICAgICAgICAgICAgICAgICdtb2JpbGVfbm8nID0+IFsnbnVsbGFibGUnLCAnc3RyaW5nJywgJ21heDoxNCcsICdyZWdleDovXihbMC05XHNcLVwrXChcKV0qKSQvJ10sCiAgICAgICAgICAgICAgICAndGVybV9jb25kaXRpb24nID0+IFsnbnVsbGFibGUnXSwKICAgICAgICAgICAgICAgICdwYXltZW50X3Rlcm1faWQnID0+IFsnYXJyYXknLCdtaW46MSddLAoKICAgICAgICAgICAgICAgICd0cmFkZScgPT4gWydyZXF1aXJlZCcsICdzdHJpbmcnLCAnbWF4OjI1NSddLAogICAgICAgICAgICAgICAgJ3RpbicgPT4gWydudWxsYWJsZScsICdzdHJpbmcnLCAnbWF4OjI1NSddLAogICAgICAgICAgICAgICAgJ3ZhdCcgPT4gWydudWxsYWJsZScsICdzdHJpbmcnLCAnbWF4OjI1NSddLAogICAgICAgICAgICAgICAgJ293bmVyX25hbWUnID0+IFsnbnVsbGFibGUnLCAnc3RyaW5nJywgJ21heDoyNTUnXSwKICAgICAgICAgICAgICAgICdvd25lcl9uaWQnID0+IFsnbnVsbGFibGUnLCAnc3RyaW5nJywgJ21heDoyNTUnXSwKICAgICAgICAgICAgICAgICdvd25lcl9jb250YWN0X25vJyA9PiBbJ251bGxhYmxlJywgJ3N0cmluZycsICdtYXg6MjU1J10sCiAgICAgICAgICAgICAgICAnY3VycmVuY2llcycgPT4gWydyZXF1aXJlZCddLAogICAgICAgICAgICAgICAgJ2N1cnJlbmNpZXMuKicgPT4gWydyZXF1aXJlZCddLAogICAgICAgICAgICBdKTsKCiAgICAgICAgICAgIGlmKCRyZXF1ZXN0LT5oYXNGaWxlKCdhdXRoX3BlcnNvbl9sZXR0ZXJfZmlsZScpKXsKICAgICAgICAgICAgICAgICRyZXF1ZXN0LT52YWxpZGF0ZShbCiAgICAgICAgICAgICAgICAgICAgJ2F1dGhfcGVyc29uX2xldHRlcl9maWxlJyA9PiBbJ21pbWVzOnBkZixwbmcnLCAnbWF4OjIwNDgnXSwKICAgICAgICAgICAgICAgIF0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZigkcmVxdWVzdC0+aGFzRmlsZSgnb3duZXJfcGhvdG9fZmlsZScpKXsKICAgICAgICAgICAgICAgICRyZXF1ZXN0LT52YWxpZGF0ZShbCiAgICAgICAgICAgICAgICAgICAgJ293bmVyX3Bob3RvX2ZpbGUnID0+IFsnbWltZXM6anBlZyxqcGcscG5nLGdpZicsICdtYXg6MzA3MiddLAogICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIERCOjpiZWdpblRyYW5zYWN0aW9uKCk7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAkdGVybVBlcmNlbnRhZ2VzID0gW107CiAgICAgICAgICAgICAgICBpZihpc3NldCgkcmVxdWVzdC0+b2xkX3BheW1lbnRfdGVybV9pZCkgJiYgaXNfYXJyYXkoJHJlcXVlc3QtPm9sZF9wYXltZW50X3Rlcm1faWQpICYmIGNvdW50KCRyZXF1ZXN0LT5vbGRfcGF5bWVudF90ZXJtX2lkKSl7CiAgICAgICAgICAgICAgICAgICAgZm9yZWFjaCgkcmVxdWVzdC0+b2xkX3BheW1lbnRfdGVybV9pZCBhcyAka2V5ID0+ICRwYXltZW50X3Rlcm1faWQpewogICAgICAgICAgICAgICAgICAgICAgICBpZighaXNzZXQoJHRlcm1QZXJjZW50YWdlc1skcGF5bWVudF90ZXJtX2lkXSkpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHRlcm1QZXJjZW50YWdlc1skcGF5bWVudF90ZXJtX2lkXSA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgJHRlcm1QZXJjZW50YWdlc1skcGF5bWVudF90ZXJtX2lkXSArPSAkcmVxdWVzdC0+b2xkX3BheW1lbnRfcGVyY2VudFska2V5XTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCR0ZXJtUGVyY2VudGFnZXNbJHBheW1lbnRfdGVybV9pZF0gPiAxMDApewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHBheW1lbnRUZXJtID0gUGF5bWVudFRlcm06OmZpbmQoJHBheW1lbnRfdGVybV9pZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnID0+IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAnUGF5bWVudCBUZXJtICMnLiRwYXltZW50VGVybS0+dGVybS4nIHRvdGFsIHBlcmNlbnRhZ2VzIGhhdmUgYmVlbiBleGNlZWRlZCB0byAnLiR0ZXJtUGVyY2VudGFnZXNbJHBheW1lbnRfdGVybV9pZF0uJyUhJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmKGlzc2V0KCRyZXF1ZXN0LT5wYXltZW50X3Rlcm1faWRbMF0pKXsKICAgICAgICAgICAgICAgICAgICBmb3JlYWNoKCRyZXF1ZXN0LT5wYXltZW50X3Rlcm1faWQgYXMgJGtleSA9PiAkcGF5bWVudF90ZXJtX2lkKXsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoIWlzc2V0KCR0ZXJtUGVyY2VudGFnZXNbJHBheW1lbnRfdGVybV9pZF0pKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICR0ZXJtUGVyY2VudGFnZXNbJHBheW1lbnRfdGVybV9pZF0gPSAwOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICR0ZXJtUGVyY2VudGFnZXNbJHBheW1lbnRfdGVybV9pZF0gKz0gJHJlcXVlc3QtPnBheW1lbnRfcGVyY2VudFska2V5XTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCR0ZXJtUGVyY2VudGFnZXNbJHBheW1lbnRfdGVybV9pZF0gPiAxMDApewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHBheW1lbnRUZXJtID0gUGF5bWVudFRlcm06OmZpbmQoJHBheW1lbnRfdGVybV9pZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnID0+IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAnUGF5bWVudCBUZXJtICMnLiRwYXltZW50VGVybS0+dGVybS4nIHRvdGFsIHBlcmNlbnRhZ2VzIGhhdmUgYmVlbiBleGNlZWRlZCB0byAnLiR0ZXJtUGVyY2VudGFnZXNbJHBheW1lbnRfdGVybV9pZF0uJyUhJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAkaW5wdXRzID0gJHJlcXVlc3QtPmFsbCgpOwogICAgICAgICAgICAgICAgJHN1cHBsaWVyLT51cGRhdGUoJGlucHV0cyk7CgogICAgICAgICAgICAgICAgJHN1cHBsaWVyLT5wcm9kdWN0cygpLT5zeW5jKFByb2R1Y3Q6OndoZXJlSW4oJ2NhdGVnb3J5X2lkJywgaXNzZXQoJHJlcXVlc3QtPnN1Yl9jYXRlZ29yaWVzWzBdKSA/ICRyZXF1ZXN0LT5zdWJfY2F0ZWdvcmllcyA6IFtdKS0+cGx1Y2soJ2lkJyktPnRvQXJyYXkoKSk7CiAgICAgICAgICAgICAgICAkc3VwcGxpZXItPmN1cnJlbmNpZXMoKS0+c3luYygkcmVxdWVzdC0+Y3VycmVuY2llcyk7CgogICAgICAgICAgICAgICAgaWYoJHJlcXVlc3QtPmhhc0ZpbGUoJ2F1dGhfcGVyc29uX2xldHRlcl9maWxlJykpewogICAgICAgICAgICAgICAgICAgIGlmKCFlbXB0eSgkc3VwcGxpZXItPmF1dGhfcGVyc29uX2xldHRlcikpewogICAgICAgICAgICAgICAgICAgICAgICB1bmxpbmsocHVibGljX3BhdGgoJHN1cHBsaWVyLT5hdXRoX3BlcnNvbl9sZXR0ZXIpKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICRzdXBwbGllci0+YXV0aF9wZXJzb25fbGV0dGVyID0gJHRoaXMtPmZpbGVVcGxvYWQoJHJlcXVlc3QtPmZpbGUoJ2F1dGhfcGVyc29uX2xldHRlcl9maWxlJyksICd1cGxvYWQvc3VwcGxpZXItYXV0aG9yaXphdGlvbi1sZXR0ZXInKTsKICAgICAgICAgICAgICAgICAgICAkc3VwcGxpZXItPnNhdmUoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZigkcmVxdWVzdC0+aGFzRmlsZSgnb3duZXJfcGhvdG9fZmlsZScpKXsKICAgICAgICAgICAgICAgICAgICBpZighZW1wdHkoJHN1cHBsaWVyLT5vd25lcl9waG90bykpewogICAgICAgICAgICAgICAgICAgICAgICB1bmxpbmsocHVibGljX3BhdGgoJHN1cHBsaWVyLT5vd25lcl9waG90bykpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgJHN1cHBsaWVyLT5vd25lcl9waG90byA9ICR0aGlzLT5maWxlVXBsb2FkKCRyZXF1ZXN0LT5maWxlKCdvd25lcl9waG90b19maWxlJyksICd1cGxvYWQvc3VwcGxpZXItb3duZXItcGhvdG8nLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICAkc3VwcGxpZXItPnNhdmUoKTsKICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgaWYgKGlzc2V0KCRyZXF1ZXN0LT5vbGRfcGF5bWVudF90ZXJtX2lkKSAmJiBpc19hcnJheSgkcmVxdWVzdC0+b2xkX3BheW1lbnRfdGVybV9pZCkgJiYgY291bnQoJHJlcXVlc3QtPm9sZF9wYXltZW50X3Rlcm1faWQpID4gMCkgewogICAgICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRyZXF1ZXN0LT5vbGRfcGF5bWVudF90ZXJtX2lkIGFzICRvYmVqY3RfaWQgPT4gJHBheW1lbnRfdGVybV9pZCl7CiAgICAgICAgICAgICAgICAgICAgICAgICRwYXJlbnQgPSBTdXBwbGllclBheW1lbnRUZXJtOjp3aGVyZShbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnc3VwcGxpZXJfaWQnID0+ICRzdXBwbGllci0+aWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAncGF5bWVudF90ZXJtX2lkJyA9PiAkcGF5bWVudF90ZXJtX2lkCiAgICAgICAgICAgICAgICAgICAgICAgIF0pCiAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmUoJ2lkJywgJzwnLCAkb2JlamN0X2lkKQogICAgICAgICAgICAgICAgICAgICAgICAtPmZpcnN0KCk7CgogICAgICAgICAgICAgICAgICAgICAgICBTdXBwbGllclBheW1lbnRUZXJtOjp3aGVyZSgnaWQnLCAkb2JlamN0X2lkKQogICAgICAgICAgICAgICAgICAgICAgICAtPnVwZGF0ZShbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAncGF5bWVudF90ZXJtX2lkJyA9PiAkcGF5bWVudF90ZXJtX2lkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3BheW1lbnRfcGVyY2VudCcgPT4gJHJlcXVlc3QtPm9sZF9wYXltZW50X3BlcmNlbnRbJG9iZWpjdF9pZF0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZGF5X2R1cmF0aW9uJyA9PiAkcmVxdWVzdC0+b2xkX2RheV9kdXJhdGlvblskb2JlamN0X2lkXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICd0eXBlJyA9PiAkcmVxdWVzdC0+b2xkX3R5cGVbJG9iZWpjdF9pZF0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAncGFyZW50X2lkJyA9PiBpc3NldCgkcGFyZW50LT5pZCkgPyAkcGFyZW50LT5pZCA6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgIF0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoaXNzZXQoJHJlcXVlc3QtPnBheW1lbnRfdGVybV9pZFswXSkpIHsKICAgICAgICAgICAgICAgICAgICBmb3JlYWNoICgkcmVxdWVzdC0+cGF5bWVudF90ZXJtX2lkIGFzICRrZXkgPT4gJHBheW1lbnRfdGVybV9pZCl7CiAgICAgICAgICAgICAgICAgICAgICAgICRwYXJlbnQgPSBTdXBwbGllclBheW1lbnRUZXJtOjp3aGVyZShbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnc3VwcGxpZXJfaWQnID0+ICRzdXBwbGllci0+aWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAncGF5bWVudF90ZXJtX2lkJyA9PiAkcGF5bWVudF90ZXJtX2lkCiAgICAgICAgICAgICAgICAgICAgICAgIF0pLT5maXJzdCgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgU3VwcGxpZXJQYXltZW50VGVybTo6Y3JlYXRlKFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdzdXBwbGllcl9pZCcgPT4gJHN1cHBsaWVyLT5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdwYXltZW50X3Rlcm1faWQnID0+ICRwYXltZW50X3Rlcm1faWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAncGF5bWVudF9wZXJjZW50JyA9PiAkcmVxdWVzdC0+cGF5bWVudF9wZXJjZW50WyRrZXldLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2RheV9kdXJhdGlvbicgPT4gJHJlcXVlc3QtPmRheV9kdXJhdGlvblska2V5XSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICd0eXBlJyA9PiAkcmVxdWVzdC0+dHlwZVska2V5XSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdwYXJlbnRfaWQnID0+IGlzc2V0KCRwYXJlbnQtPmlkKSA/ICRwYXJlbnQtPmlkIDogMCwKICAgICAgICAgICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIERCOjpjb21taXQoKTsKCiAgICAgICAgICAgICAgICBzZXNzaW9uKCktPmZsYXNoKCdtZXNzYWdlJywgJ0Egc3VwcGxpZXIgaGFzIGJlZW4gdXBkYXRlZCBzdWNjZXNzZnVsbHknKTsKICAgICAgICAgICAgICAgIHNlc3Npb24oKS0+Zmxhc2goJ2FsZXJ0LXR5cGUnLCAnc3VjY2VzcycpOwogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiB0cnVlLAogICAgICAgICAgICAgICAgICAgICd1cmwnID0+IHVybCgncG1zL3N1cHBsaWVyLycuJHN1cHBsaWVyLT5pZC4nL2VkaXQ/dGFiPScucmVxdWVzdCgpLT5nZXQoJ2Zvcm0tdHlwZScpKQogICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgIH1jYXRjaCAoXFRocm93YWJsZSAkdGgpewogICAgICAgICAgICAgICAgREI6OnJvbGxiYWNrKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnID0+IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAkdGgtPmdldE1lc3NhZ2UoKQogICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmKHJlcXVlc3QoKS0+aGFzKCdmb3JtLXR5cGUnKSAmJiByZXF1ZXN0KCktPmdldCgnZm9ybS10eXBlJykgPT0gImFkZHJlc3MiKXsKICAgICAgICAgICAgJHZhbGlkYXRvciA9IFxWYWxpZGF0b3I6Om1ha2UoJHJlcXVlc3QtPmFsbCgpLCBbCiAgICAgICAgICAgICAgICAnY29ycG9yYXRlX3JvYWQnID0+IFsncmVxdWlyZWQnLCAnc3RyaW5nJywgJ21heDoyNTUnXSwKICAgICAgICAgICAgICAgICdjb3Jwb3JhdGVfY2l0eScgPT4gWydyZXF1aXJlZCcsICdzdHJpbmcnLCAnbWF4OjI1NSddLAogICAgICAgICAgICAgICAgJ2NvcnBvcmF0ZV96aXAnID0+IFsncmVxdWlyZWQnLCAnc3RyaW5nJywgJ21heDoyNTUnXSwKICAgICAgICAgICAgICAgICdjb3Jwb3JhdGVfY291bnRyeScgPT4gWydyZXF1aXJlZCcsICdzdHJpbmcnLCAnbWF4OjI1NSddLAogICAgICAgICAgICAgICAgLy8gJ2ZhY3Rvcnlfcm9hZCcgPT4gWydyZXF1aXJlZCcsICdzdHJpbmcnLCAnbWF4OjI1NSddLAogICAgICAgICAgICAgICAgLy8gJ2ZhY3RvcnlfY2l0eScgPT4gWydyZXF1aXJlZCcsICdzdHJpbmcnLCAnbWF4OjI1NSddLAogICAgICAgICAgICAgICAgLy8gJ2ZhY3RvcnlfemlwJyA9PiBbJ3JlcXVpcmVkJywgJ3N0cmluZycsICdtYXg6MjU1J10sCiAgICAgICAgICAgICAgICAvLyAnZmFjdG9yeV9jb3VudHJ5JyA9PiBbJ3JlcXVpcmVkJywgJ3N0cmluZycsICdtYXg6MjU1J10sCiAgICAgICAgICAgIF0pOwoKICAgICAgICAgICAgaWYgKCEkdmFsaWRhdG9yLT5wYXNzZXMoKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlZGlyZWN0KCdwbXMvc3VwcGxpZXIvJy4kc3VwcGxpZXItPmlkLicvZWRpdD90YWI9Jy5yZXF1ZXN0KCktPmdldCgnZm9ybS10eXBlJykpLT53aXRoRXJyb3JzKCR2YWxpZGF0b3IpOwogICAgICAgICAgICAgICAgOwogICAgICAgICAgICB9CgogICAgICAgICAgICBEQjo6YmVnaW5UcmFuc2FjdGlvbigpOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgU3VwcGxpZXJBZGRyZXNzOjp1cGRhdGVPckNyZWF0ZShbCiAgICAgICAgICAgICAgICAgICAgJ3N1cHBsaWVyX2lkJyA9PiAkc3VwcGxpZXItPmlkLAogICAgICAgICAgICAgICAgICAgICd0eXBlJyA9PiAnY29ycG9yYXRlJywKICAgICAgICAgICAgICAgIF0sWwogICAgICAgICAgICAgICAgICAgICdyb2FkJyA9PiAkcmVxdWVzdC0+Y29ycG9yYXRlX3JvYWQsCiAgICAgICAgICAgICAgICAgICAgJ3ZpbGxhZ2UnID0+ICRyZXF1ZXN0LT5jb3Jwb3JhdGVfdmlsbGFnZSwKICAgICAgICAgICAgICAgICAgICAnY2l0eScgPT4gJHJlcXVlc3QtPmNvcnBvcmF0ZV9jaXR5LAogICAgICAgICAgICAgICAgICAgICdjb3VudHJ5JyA9PiAkcmVxdWVzdC0+Y29ycG9yYXRlX2NvdW50cnksCiAgICAgICAgICAgICAgICAgICAgJ3ppcCcgPT4gJHJlcXVlc3QtPmNvcnBvcmF0ZV96aXAsCiAgICAgICAgICAgICAgICAgICAgJ2FkZHJlc3MnID0+ICRyZXF1ZXN0LT5jb3Jwb3JhdGVfYWRkcmVzcyAKICAgICAgICAgICAgICAgIF0pOwoKICAgICAgICAgICAgICAgIFN1cHBsaWVyQWRkcmVzczo6dXBkYXRlT3JDcmVhdGUoWwogICAgICAgICAgICAgICAgICAgICdzdXBwbGllcl9pZCcgPT4gJHN1cHBsaWVyLT5pZCwKICAgICAgICAgICAgICAgICAgICAndHlwZScgPT4gJ2ZhY3RvcnknLAogICAgICAgICAgICAgICAgXSxbCiAgICAgICAgICAgICAgICAgICAgJ3JvYWQnID0+ICRyZXF1ZXN0LT5mYWN0b3J5X3JvYWQsCiAgICAgICAgICAgICAgICAgICAgJ3ZpbGxhZ2UnID0+ICRyZXF1ZXN0LT5mYWN0b3J5X3ZpbGxhZ2UsCiAgICAgICAgICAgICAgICAgICAgJ2NpdHknID0+ICRyZXF1ZXN0LT5mYWN0b3J5X2NpdHksCiAgICAgICAgICAgICAgICAgICAgJ2NvdW50cnknID0+ICRyZXF1ZXN0LT5mYWN0b3J5X2NvdW50cnksCiAgICAgICAgICAgICAgICAgICAgJ3ppcCcgPT4gJHJlcXVlc3QtPmZhY3RvcnlfemlwLAogICAgICAgICAgICAgICAgICAgICdhZGRyZXNzJyA9PiAkcmVxdWVzdC0+ZmFjdG9yeV9hZGRyZXNzIAogICAgICAgICAgICAgICAgXSk7CgogICAgICAgICAgICAgICAgREI6OmNvbW1pdCgpOwogICAgICAgICAgICB9Y2F0Y2ggKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgICAgIERCOjpyb2xsYmFjaygpOwogICAgICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYocmVxdWVzdCgpLT5oYXMoJ2Zvcm0tdHlwZScpICYmIHJlcXVlc3QoKS0+Z2V0KCdmb3JtLXR5cGUnKSA9PSAiY29udGFjdC1wZXJzb24iKXsKICAgICAgICAgICAgJHZhbGlkYXRvciA9IFxWYWxpZGF0b3I6Om1ha2UoJHJlcXVlc3QtPmFsbCgpLCBbCiAgICAgICAgICAgICAgICAnY29udGFjdF9wZXJzb25fc2FsZXNfbmFtZScgPT4gWydyZXF1aXJlZCcsICdzdHJpbmcnLCAnbWF4OjI1NSddLAogICAgICAgICAgICAgICAgJ2NvbnRhY3RfcGVyc29uX3NhbGVzX2Rlc2lnbmF0aW9uJyA9PiBbJ3JlcXVpcmVkJywgJ3N0cmluZycsICdtYXg6MjU1J10sCiAgICAgICAgICAgICAgICAnY29udGFjdF9wZXJzb25fc2FsZXNfbW9iaWxlJyA9PiBbJ3JlcXVpcmVkJywgJ3N0cmluZycsICdtYXg6MjU1J10sCiAgICAgICAgICAgICAgICAnY29udGFjdF9wZXJzb25fYWZ0ZXJfc2FsZXNfbmFtZScgPT4gWydyZXF1aXJlZCcsICdzdHJpbmcnLCAnbWF4OjI1NSddLAogICAgICAgICAgICAgICAgJ2NvbnRhY3RfcGVyc29uX2FmdGVyX3NhbGVzX2Rlc2lnbmF0aW9uJyA9PiBbJ3JlcXVpcmVkJywgJ3N0cmluZycsICdtYXg6MjU1J10sCiAgICAgICAgICAgICAgICAnY29udGFjdF9wZXJzb25fYWZ0ZXJfc2FsZXNfbW9iaWxlJyA9PiBbJ3JlcXVpcmVkJywgJ3N0cmluZycsICdtYXg6MjU1J10sCiAgICAgICAgICAgIF0pOwoKICAgICAgICAgICAgaWYgKCEkdmFsaWRhdG9yLT5wYXNzZXMoKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlZGlyZWN0KCdwbXMvc3VwcGxpZXIvJy4kc3VwcGxpZXItPmlkLicvZWRpdD90YWI9Jy5yZXF1ZXN0KCktPmdldCgnZm9ybS10eXBlJykpLT53aXRoRXJyb3JzKCR2YWxpZGF0b3IpOwogICAgICAgICAgICAgICAgOwogICAgICAgICAgICB9CgogICAgICAgICAgICBEQjo6YmVnaW5UcmFuc2FjdGlvbigpOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgU3VwcGxpZXJDb250YWN0UGVyc29uOjp1cGRhdGVPckNyZWF0ZShbCiAgICAgICAgICAgICAgICAgICAgJ3N1cHBsaWVyX2lkJyA9PiAkc3VwcGxpZXItPmlkLAogICAgICAgICAgICAgICAgICAgICd0eXBlJyA9PiAnc2FsZXMnLAogICAgICAgICAgICAgICAgXSxbCiAgICAgICAgICAgICAgICAgICAgJ25hbWUnID0+ICRyZXF1ZXN0LT5jb250YWN0X3BlcnNvbl9zYWxlc19uYW1lLAogICAgICAgICAgICAgICAgICAgICdkZXNpZ25hdGlvbicgPT4gJHJlcXVlc3QtPmNvbnRhY3RfcGVyc29uX3NhbGVzX2Rlc2lnbmF0aW9uLAogICAgICAgICAgICAgICAgICAgICdtb2JpbGUnID0+ICRyZXF1ZXN0LT5jb250YWN0X3BlcnNvbl9zYWxlc19tb2JpbGUsCiAgICAgICAgICAgICAgICAgICAgJ2VtYWlsJyA9PiAkcmVxdWVzdC0+Y29udGFjdF9wZXJzb25fc2FsZXNfZW1haWwKICAgICAgICAgICAgICAgIF0pOwoKICAgICAgICAgICAgICAgIFN1cHBsaWVyQ29udGFjdFBlcnNvbjo6dXBkYXRlT3JDcmVhdGUoWwogICAgICAgICAgICAgICAgICAgICdzdXBwbGllcl9pZCcgPT4gJHN1cHBsaWVyLT5pZCwKICAgICAgICAgICAgICAgICAgICAndHlwZScgPT4gJ2FmdGVyLXNhbGVzJywKICAgICAgICAgICAgICAgIF0sWwogICAgICAgICAgICAgICAgICAgICduYW1lJyA9PiAkcmVxdWVzdC0+Y29udGFjdF9wZXJzb25fYWZ0ZXJfc2FsZXNfbmFtZSwKICAgICAgICAgICAgICAgICAgICAnZGVzaWduYXRpb24nID0+ICRyZXF1ZXN0LT5jb250YWN0X3BlcnNvbl9hZnRlcl9zYWxlc19kZXNpZ25hdGlvbiwKICAgICAgICAgICAgICAgICAgICAnbW9iaWxlJyA9PiAkcmVxdWVzdC0+Y29udGFjdF9wZXJzb25fYWZ0ZXJfc2FsZXNfbW9iaWxlLAogICAgICAgICAgICAgICAgICAgICdlbWFpbCcgPT4gJHJlcXVlc3QtPmNvbnRhY3RfcGVyc29uX2FmdGVyX3NhbGVzX2VtYWlsCiAgICAgICAgICAgICAgICBdKTsKCiAgICAgICAgICAgICAgICBEQjo6Y29tbWl0KCk7CiAgICAgICAgICAgIH1jYXRjaCAoXFRocm93YWJsZSAkdGgpewogICAgICAgICAgICAgICAgREI6OnJvbGxiYWNrKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZihyZXF1ZXN0KCktPmhhcygnZm9ybS10eXBlJykgJiYgcmVxdWVzdCgpLT5nZXQoJ2Zvcm0tdHlwZScpID09ICJiYW5rLWFjY291bnQiKXsKICAgICAgICAgICAgJHZhbGlkYXRvciA9IFxWYWxpZGF0b3I6Om1ha2UoJHJlcXVlc3QtPmFsbCgpLCBbCiAgICAgICAgICAgICAgICAnYmFua19hY2NvdW50X25hbWUnID0+IFsncmVxdWlyZWQnLCAnc3RyaW5nJywgJ21heDoyNTUnXSwKICAgICAgICAgICAgICAgICdiYW5rX2FjY291bnRfbnVtYmVyJyA9PiBbJ3JlcXVpcmVkJywgJ3N0cmluZycsICdtYXg6MjU1J10sCiAgICAgICAgICAgICAgICAnYmFua19zd2lmdF9jb2RlJyA9PiBbJ3JlcXVpcmVkJywgJ3N0cmluZycsICdtYXg6MjU1J10sCiAgICAgICAgICAgICAgICAnYmFua19uYW1lJyA9PiBbJ3JlcXVpcmVkJywgJ3N0cmluZycsICdtYXg6MjU1J10sCiAgICAgICAgICAgICAgICAnYmFua19icmFuY2gnID0+IFsncmVxdWlyZWQnLCAnc3RyaW5nJywgJ21heDoyNTUnXSwKICAgICAgICAgICAgXSk7CgogICAgICAgICAgICBpZiAoISR2YWxpZGF0b3ItPnBhc3NlcygpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVkaXJlY3QoJ3Btcy9zdXBwbGllci8nLiRzdXBwbGllci0+aWQuJy9lZGl0P3RhYj0nLnJlcXVlc3QoKS0+Z2V0KCdmb3JtLXR5cGUnKSktPndpdGhFcnJvcnMoJHZhbGlkYXRvcik7CiAgICAgICAgICAgICAgICA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmKCRyZXF1ZXN0LT5oYXNGaWxlKCdiYW5rX3NlY3VyaXR5X2NoZWNrX2ZpbGUnKSl7CiAgICAgICAgICAgICAgICAkdmFsaWRhdG9yID0gXFZhbGlkYXRvcjo6bWFrZSgkcmVxdWVzdC0+YWxsKCksIFsKICAgICAgICAgICAgICAgICAgICAnYmFua19zZWN1cml0eV9jaGVja19maWxlJyA9PiBbJ21pbWVzOnBkZixwbmcnLCAnbWF4OjIwNDgnXSwKICAgICAgICAgICAgICAgIF0pOwoKICAgICAgICAgICAgICAgIGlmICghJHZhbGlkYXRvci0+cGFzc2VzKCkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVkaXJlY3QoJ3Btcy9zdXBwbGllci8nLiRzdXBwbGllci0+aWQuJy9lZGl0P3RhYj0nLnJlcXVlc3QoKS0+Z2V0KCdmb3JtLXR5cGUnKSktPndpdGhFcnJvcnMoJHZhbGlkYXRvcik7CiAgICAgICAgICAgICAgICAgICAgOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBEQjo6YmVnaW5UcmFuc2FjdGlvbigpOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgJGJhbmtBY2NvdW50ID0gU3VwcGxpZXJCYW5rQWNjb3VudDo6dXBkYXRlT3JDcmVhdGUoWwogICAgICAgICAgICAgICAgICAgICdzdXBwbGllcl9pZCcgPT4gJHN1cHBsaWVyLT5pZCwKICAgICAgICAgICAgICAgIF0sWwogICAgICAgICAgICAgICAgICAgICdhY2NvdW50X25hbWUnID0+ICRyZXF1ZXN0LT5iYW5rX2FjY291bnRfbmFtZSwKICAgICAgICAgICAgICAgICAgICAnYWNjb3VudF9udW1iZXInID0+ICRyZXF1ZXN0LT5iYW5rX2FjY291bnRfbnVtYmVyLAogICAgICAgICAgICAgICAgICAgICdzd2lmdF9jb2RlJyA9PiAkcmVxdWVzdC0+YmFua19zd2lmdF9jb2RlLAogICAgICAgICAgICAgICAgICAgICdiYW5rX25hbWUnID0+ICRyZXF1ZXN0LT5iYW5rX25hbWUsCiAgICAgICAgICAgICAgICAgICAgJ2JyYW5jaCcgPT4gJHJlcXVlc3QtPmJhbmtfYnJhbmNoLAogICAgICAgICAgICAgICAgICAgICdjdXJyZW5jeScgPT4gJHJlcXVlc3QtPmJhbmtfY3VycmVuY3ksCiAgICAgICAgICAgICAgICBdKTsKCiAgICAgICAgICAgICAgICBpZigkcmVxdWVzdC0+aGFzRmlsZSgnYmFua19zZWN1cml0eV9jaGVja19maWxlJykpewogICAgICAgICAgICAgICAgICAgIGlmKCFlbXB0eSgkYmFua0FjY291bnQtPnNlY3VyaXR5X2NoZWNrKSl7CiAgICAgICAgICAgICAgICAgICAgICAgIHVubGluayhwdWJsaWNfcGF0aCgkYmFua0FjY291bnQtPnNlY3VyaXR5X2NoZWNrKSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAkYmFua0FjY291bnQtPnNlY3VyaXR5X2NoZWNrID0gJHRoaXMtPmZpbGVVcGxvYWQoJHJlcXVlc3QtPmZpbGUoJ2Jhbmtfc2VjdXJpdHlfY2hlY2tfZmlsZScpLCAndXBsb2FkL2JhbmstZ3VhcmFudGVlLXNlY3VyaXR5LWNoZWNrJyk7CiAgICAgICAgICAgICAgICAgICAgJGJhbmtBY2NvdW50LT5zYXZlKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgREI6OmNvbW1pdCgpOwogICAgICAgICAgICB9Y2F0Y2ggKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgICAgIERCOjpyb2xsYmFjaygpOwogICAgICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYocmVxdWVzdCgpLT5oYXMoJ2Zvcm0tdHlwZScpICYmIHJlcXVlc3QoKS0+Z2V0KCdmb3JtLXR5cGUnKSA9PSAibGVkZ2VycyIpewogICAgICAgICAgICAvKgogICAgICAgICAgICAkdmFsaWRhdG9yID0gXFZhbGlkYXRvcjo6bWFrZSgkcmVxdWVzdC0+YWxsKCksIFsKICAgICAgICAgICAgICAgICdsZWRnZXJfbmFtZScgPT4gWydyZXF1aXJlZCddLAogICAgICAgICAgICAgICAgJ2xlZGdlcl90eXBlJyA9PiBbJ3JlcXVpcmVkJ10sCiAgICAgICAgICAgICAgICAnb3BlbmluZ19iYWxhbmNlJyA9PiBbJ3JlcXVpcmVkJ10sCiAgICAgICAgICAgIF0pOwoKICAgICAgICAgICAgaWYgKCEkdmFsaWRhdG9yLT5wYXNzZXMoKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlZGlyZWN0KCdwbXMvc3VwcGxpZXIvJy4kc3VwcGxpZXItPmlkLicvZWRpdD90YWI9Jy5yZXF1ZXN0KCktPmdldCgnZm9ybS10eXBlJykpLT53aXRoRXJyb3JzKCR2YWxpZGF0b3IpOwogICAgICAgICAgICAgICAgOwogICAgICAgICAgICB9CgogICAgICAgICAgICBEQjo6YmVnaW5UcmFuc2FjdGlvbigpOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgJGFjY291bnREZWZhdWx0U2V0dGluZ3MgPSBhY2NvdW50RGVmYXVsdFNldHRpbmdzKCdqc29uJyk7CiAgICAgICAgICAgICAgICAvLyBzYXZlR0xGb3JPYmplY3RzKCRzdXBwbGllciwgJHN1cHBsaWVyLT5wYXlhYmxlQWNjb3VudCwgJHJlcXVlc3QsICdwYXlhYmxlX2FjY291bnRfaWQnLCAkYWNjb3VudERlZmF1bHRTZXR0aW5nc1snc3VwcGxpZXJfcGF5YWJsZSddKTsKICAgICAgICAgICAgICAgIC8vIHNhdmVHTEZvck9iamVjdHMoJHN1cHBsaWVyLCAkc3VwcGxpZXItPnBheWFibGVQdXJjaGFzZUFjY291bnQsICRyZXF1ZXN0LCAncGF5YWJsZV9wdXJjaGFzZV9pZCcsICRhY2NvdW50RGVmYXVsdFNldHRpbmdzWydzdXBwbGllcl9wYXlhYmxlX3B1cmNoYXNlJ10pOwogICAgICAgICAgICAgICAgLy8gc2F2ZUdMRm9yT2JqZWN0cygkc3VwcGxpZXIsICRzdXBwbGllci0+cGF5YWJsZURpc2NvdW50QWNjb3VudCwgJHJlcXVlc3QsICdwYXlhYmxlX2Rpc2NvdW50X2lkJywgJGFjY291bnREZWZhdWx0U2V0dGluZ3NbJ3N1cHBsaWVyX3BheWFibGVfZGlzY291bnQnXSk7CiAgICAgICAgICAgICAgICAvLyBzYXZlR0xGb3JPYmplY3RzKCRzdXBwbGllciwgJHN1cHBsaWVyLT5hZHZhbmNlQWNjb3VudCwgJHJlcXVlc3QsICdhZHZhbmNlX2FjY291bnRfaWQnLCAkYWNjb3VudERlZmF1bHRTZXR0aW5nc1snc3VwcGxpZXJfYWR2YW5jZSddKTsKCiAgICAgICAgICAgICAgICBEQjo6Y29tbWl0KCk7CiAgICAgICAgICAgIH1jYXRjaCAoXFRocm93YWJsZSAkdGgpewogICAgICAgICAgICAgICAgREI6OnJvbGxiYWNrKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgICovCgogICAgICAgICAgICAkdmFsaWRhdG9yID0gXFZhbGlkYXRvcjo6bWFrZSgkcmVxdWVzdC0+YWxsKCksIFsKICAgICAgICAgICAgICAgICdwYXlhYmxlX2FjY291bnRfaWQnID0+IFsncmVxdWlyZWQnXSwKICAgICAgICAgICAgICAgICdhZHZhbmNlX2FjY291bnRfaWQnID0+IFsncmVxdWlyZWQnXSwKICAgICAgICAgICAgXSk7CgogICAgICAgICAgICBpZiAoISR2YWxpZGF0b3ItPnBhc3NlcygpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVkaXJlY3QoJ3Btcy9zdXBwbGllci8nLiRzdXBwbGllci0+aWQuJy9lZGl0P3RhYj0nLnJlcXVlc3QoKS0+Z2V0KCdmb3JtLXR5cGUnKSktPndpdGhFcnJvcnMoJHZhbGlkYXRvcik7CiAgICAgICAgICAgICAgICA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIERCOjpiZWdpblRyYW5zYWN0aW9uKCk7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAkc3VwcGxpZXItPnBheWFibGVfYWNjb3VudF9pZCA9ICRyZXF1ZXN0LT5wYXlhYmxlX2FjY291bnRfaWQ7CiAgICAgICAgICAgICAgICAkc3VwcGxpZXItPmFkdmFuY2VfYWNjb3VudF9pZCA9ICRyZXF1ZXN0LT5hZHZhbmNlX2FjY291bnRfaWQ7CiAgICAgICAgICAgICAgICAkc3VwcGxpZXItPnNhdmUoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgREI6OmNvbW1pdCgpOwogICAgICAgICAgICB9Y2F0Y2ggKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgICAgIERCOjpyb2xsYmFjaygpOwogICAgICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgJG5vdGlmaWNhdGlvbiA9IFsKICAgICAgICAgICAgJ21lc3NhZ2UnID0+ICdBIHN1cHBsaWVyIGhhcyBiZWVuIHVwZGF0ZWQgc3VjY2Vzc2Z1bGx5JywKICAgICAgICAgICAgJ2FsZXJ0LXR5cGUnID0+ICdzdWNjZXNzJwogICAgICAgIF07CiAgICAgICAgcmV0dXJuIHJlZGlyZWN0KCdwbXMvc3VwcGxpZXIvJy4kc3VwcGxpZXItPmlkLicvZWRpdD90YWI9Jy5yZXF1ZXN0KCktPmdldCgnZm9ybS10eXBlJykpLT53aXRoKCRub3RpZmljYXRpb24pOwogICAgfQoKICAgIC8qKgogICAgICogUmVtb3ZlIHRoZSBzcGVjaWZpZWQgcmVzb3VyY2UgZnJvbSBzdG9yYWdlLgogICAgICoKICAgICAqIEBwYXJhbSAgaW50ICAkaWQKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCiAgICBwdWJsaWMgZnVuY3Rpb24gZGVzdHJveSgkaWQpCiAgICB7CiAgICAgICAgREI6OmJlZ2luVHJhbnNhY3Rpb24oKTsKICAgICAgICB0cnkgewogICAgICAgICAgICAkc3VwcGxpZXIgPSBTdXBwbGllcnM6OmZpbmQoJGlkKTsKICAgICAgICAgICAgaWYoJHN1cHBsaWVyLT5kZWxldGFibGUgPT0gJ25vJyB8fCBmcmVlemVTdXBwbGllcigkc3VwcGxpZXIpKXsKICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgJ21lc3NhZ2UnID0+ICRzdXBwbGllci0+bmFtZS4iICgiLiRzdXBwbGllci0+Y29kZS4iKSBDYW5ub3QgYmUgZGVsZXRlZCEiCiAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgJGJhbmtBY2NvdW50ID0gU3VwcGxpZXJCYW5rQWNjb3VudDo6d2hlcmUoJ3N1cHBsaWVyX2lkJywgJHN1cHBsaWVyLT5pZCktPmZpcnN0KCk7CiAgICAgICAgICAgIGlmKGlzc2V0KCRiYW5rQWNjb3VudC0+aWQpICYmICFlbXB0eSgkYmFua0FjY291bnQtPnNlY3VyaXR5X2NoZWNrKSAmJiBmaWxlX2V4aXN0cyhwdWJsaWNfcGF0aCgkYmFua0FjY291bnQtPnNlY3VyaXR5X2NoZWNrKSkpewogICAgICAgICAgICAgICAgdW5saW5rKHB1YmxpY19wYXRoKCRiYW5rQWNjb3VudC0+c2VjdXJpdHlfY2hlY2spKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgJGRlbGV0ZSA9IFN1cHBsaWVyczo6ZmluZCgkaWQpLT5kZWxldGUoKTsKICAgICAgICAgICAgXERCOjp0YWJsZSgncHJvZHVjdHNfc3VwcGxpZXInKS0+d2hlcmUoJ3N1cHBsaWVyX2lkJywgJGlkKS0+ZGVsZXRlKCk7CiAgICAgICAgICAgIFxEQjo6dGFibGUoJ3N1cHBsaWVyX2N1cnJlbmNpZXMnKS0+d2hlcmUoJ3N1cHBsaWVyX2lkJywgJGlkKS0+ZGVsZXRlKCk7CiAgICAgICAgICAgIFxEQjo6dGFibGUoJ3N1cHBsaWVyX3BheW1lbnRfdGVybXMnKS0+d2hlcmUoJ3N1cHBsaWVyX2lkJywgJGlkKS0+ZGVsZXRlKCk7CiAgICAgICAgICAgIGlmKCRkZWxldGUpewogICAgICAgICAgICAgICAgaWYoIWVtcHR5KCRzdXBwbGllci0+YXV0aF9wZXJzb25fbGV0dGVyKSAmJiBmaWxlX2V4aXN0cyhwdWJsaWNfcGF0aCgkc3VwcGxpZXItPmF1dGhfcGVyc29uX2xldHRlcikpKXsKICAgICAgICAgICAgICAgICAgICB1bmxpbmsocHVibGljX3BhdGgoJHN1cHBsaWVyLT5hdXRoX3BlcnNvbl9sZXR0ZXIpKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZighZW1wdHkoJHN1cHBsaWVyLT5vd25lcl9waG90bykgJiYgZmlsZV9leGlzdHMocHVibGljX3BhdGgoJHN1cHBsaWVyLT5vd25lcl9waG90bykpKXsKICAgICAgICAgICAgICAgICAgICB1bmxpbmsocHVibGljX3BhdGgoJHN1cHBsaWVyLT5vd25lcl9waG90bykpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBEQjo6Y29tbWl0KCk7CiAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiB0cnVlLAogICAgICAgICAgICAgICAgJ21lc3NhZ2UnID0+ICJTdXBwbGllciBoYXMgYmVlbiBkZWxldGVkIHN1Y2Nlc3NmdWxseSIKICAgICAgICAgICAgXSk7CiAgICAgICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgIERCOjpyb2xsYmFjaygpOwogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gZmFsc2UsCiAgICAgICAgICAgICAgICAnbWVzc2FnZScgPT4gJHRoLT5nZXRNZXNzYWdlKCkKICAgICAgICAgICAgXSk7CiAgICAgICAgfQogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBzaG93U3VwcGxpZXJQcm9maWxlKCRpZCl7CgogICAgICAgICRkYXRhID0gWwogICAgICAgICAgICAndGl0bGUnID0+ICdTdXBwbGllciBQcm9maWxlIEluZm9ybWF0aW9uJywKICAgICAgICAgICAgJ3N1cHBsaWVyJyA9PiBTdXBwbGllcnM6OmZpbmRPckZhaWwoJGlkKSwKICAgICAgICAgICAgJ2NvcnBvcmF0ZUFkZHJlc3MnID0+IFN1cHBsaWVyQWRkcmVzczo6d2hlcmUoWydzdXBwbGllcl9pZCcgPT4gJGlkLCAndHlwZScgPT4gJ2NvcnBvcmF0ZSddKS0+Zmlyc3QoKSwKICAgICAgICAgICAgJ2ZhY3RvcnlBZGRyZXNzJyA9PiBTdXBwbGllckFkZHJlc3M6OndoZXJlKFsnc3VwcGxpZXJfaWQnID0+ICRpZCwgJ3R5cGUnID0+ICdmYWN0b3J5J10pLT5maXJzdCgpLAogICAgICAgICAgICAnY29udGFjdFBlcnNvblNhbGVzJyA9PiBTdXBwbGllckNvbnRhY3RQZXJzb246OndoZXJlKFsnc3VwcGxpZXJfaWQnID0+ICRpZCwgJ3R5cGUnID0+ICdzYWxlcyddKS0+Zmlyc3QoKSwKICAgICAgICAgICAgJ2NvbnRhY3RQZXJzb25BZnRlclNhbGVzJyA9PiBTdXBwbGllckNvbnRhY3RQZXJzb246OndoZXJlKFsnc3VwcGxpZXJfaWQnID0+ICRpZCwgJ3R5cGUnID0+ICdhZnRlci1zYWxlcyddKS0+Zmlyc3QoKSwKICAgICAgICAgICAgJ2JhbmtBY2NvdW50JyA9PiBTdXBwbGllckJhbmtBY2NvdW50Ojp3aGVyZShbJ3N1cHBsaWVyX2lkJyA9PiAkaWRdKS0+Zmlyc3QoKSwKICAgICAgICAgICAgJ2xvZ3MnID0+IFN1cHBsaWVyTG9nOjp3aGVyZSgnc3VwcGxpZXJfaWQnLCAkaWQpLT5vcmRlckJ5KCdpZCcsICdkZXNjJyktPmdldCgpLAogICAgICAgICAgICAnYWNjb3VudERlZmF1bHRTZXR0aW5ncycgPT4gYWNjb3VudERlZmF1bHRTZXR0aW5ncygnanNvbicpLAogICAgICAgIF07CgogICAgICAgIGlmKHJlcXVlc3QoKS0+aGFzKCd2aWV3JykpewogICAgICAgICAgICAkYm9keSA9IFZpZXc6Om1ha2UoJ3Btcy5iYWNrZW5kLnBhZ2VzLnN1cHBsaWVycy5zdXBwbGllci12aWV3JywkZGF0YSk7CiAgICAgICAgICAgIHJldHVybiAkYm9keS0+cmVuZGVyKCk7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5zdXBwbGllcnMucHJvZmlsZScsICRkYXRhKTsKICAgICAgICB9CgogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBzaG93U3VwcGxpZXJSYXRpbmdGcm9tKCRzdXBwbGllcklkLCRncm5JZCl7CgogICAgICRzdXBwbGllckNyaXRlcmlhQ29sdW1ucz1zdXBwbGllckNyaXRlcmlhQ29sdW1ucygpOwoKICAgICAkc3VwcGxpZXJEYXRhID0gU3VwcGxpZXJzOjp3aXRoKCdyZWxQYXltZW50VGVybXMnLCdyZWxQYXltZW50VGVybXMucmVsUGF5bWVudFRlcm0nLCdTdXBwbGllclJhdGluZ3MnKS0+ZmluZE9yRmFpbCgkc3VwcGxpZXJJZCk7CiAgICAgJGdybiA9IEdvb2RzUmVjZWl2ZWROb3RlOjpmaW5kT3JGYWlsKCRncm5JZCk7CiAgICAgJHRpdGxlID0gIkdpdmUgcmF0aW5nIHRvIHN1cHBsaWVyIHRoZSAoICRzdXBwbGllckRhdGEtPm5hbWUgKSI7CgogICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5zdXBwbGllcnMucmF0aW5nJywgY29tcGFjdCgndGl0bGUnLCAnc3VwcGxpZXJEYXRhJywnc3VwcGxpZXJDcml0ZXJpYUNvbHVtbnMnLCdncm4nKSk7CgogfQoKIHB1YmxpYyBmdW5jdGlvbiBzdG9yZVN1cHBsaWVyUmF0aW5nKFJlcXVlc3QgJHJlcXVlc3QpewoKICAgIERCOjpiZWdpblRyYW5zYWN0aW9uKCk7CiAgICB0cnkgewoKICAgICAgICAkZ3JuPUdvb2RzUmVjZWl2ZWROb3RlOjpmaW5kT3JGYWlsKCRyZXF1ZXN0LT5ncm5faWQpOwogICAgICAgICRzdXBwbGllcj1TdXBwbGllcnM6OmZpbmRPckZhaWwoJHJlcXVlc3QtPnN1cHBsaWVyX2lkKTsKICAgICAgICAkdG90YWxDb2x1bW4gPSBDb2x1bW5Db3VudCgnc3VwcGxpZXJfcmF0dGluZ3MnKTsKICAgICAgICAkdG90YWxTY29yZSA9MDsKCiAgICAgICAgJHJhdGluZ0lucHV0PVtdOwogICAgICAgIGZvcmVhY2ggKCRyZXF1ZXN0LT5yYXRpbmcgYXMgJGtleT0+JHJhdGUpewoKICAgICAgICAgICAgJHJhdGluZ0lucHV0WyRrZXldPSRyZXF1ZXN0LT5yYXRpbmdbJGtleV0/PzA7CiAgICAgICAgICAgICR0b3RhbFNjb3JlKz0kcmF0aW5nSW5wdXRbJGtleV07CiAgICAgICAgfQoKICAgICAgICAvLyBpZiAoJGdybi0+aXNfc3VwcGxpZXJfcmF0aW5nPT0neWVzJyl7CiAgICAgICAgLy8gICAgIHJldHVybiAkdGhpcy0+cmVkaXJlY3RCYWNrV2l0aFdhcm5pbmcoJ1N1cHBsaWVyIFJhdGluZyBBbHJlYWR5IFN1Ym1pdCcsJ3Btcy5zdG9ja2luLmdybi5saXN0Jyk7CiAgICAgICAgLy8gfQogICAgICAgIAogICAgICAgIGlmICgkdG90YWxTY29yZTw9MCl7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhXYXJuaW5nKCdSYXRpbmcgaXMgZW1wdHknKTsKICAgICAgICB9CgogICAgICAgICRyYXRpbmdJbnB1dFsnY3JlYXRlZF9ieSddPVxBdXRoOjp1c2VyKCktPmlkOwogICAgICAgICRyYXRpbmdJbnB1dFsnc3VwcGxpZXJfaWQnXT0kcmVxdWVzdC0+c3VwcGxpZXJfaWQ7CiAgICAgICAgJHJhdGluZ0lucHV0Wyd0b3RhbF9zY29yZSddPSR0b3RhbFNjb3JlLyR0b3RhbENvbHVtbjsKICAgICAgICAkcmF0aW5nSW5wdXRbJ2tleSddPSRyZXF1ZXN0LT5rZXk7CiAgICAgICAgJHJhdGluZ0lucHV0Wyd2YWx1ZSddPSRyZXF1ZXN0LT52YWx1ZTsKICAgICAgICAkcmF0aW5nSW5wdXRbJ3R5cGUnXT0kcmVxdWVzdC0+dHlwZTsKCiAgICAgICAgU3VwcGxpZXJSYXRpbmdzOjpjcmVhdGUoJHJhdGluZ0lucHV0KTsKCiAgICAgICAgJGdybi0+dXBkYXRlKFsnaXNfc3VwcGxpZXJfcmF0aW5nJz0+J3llcyddKTsKICAgICAgICBEQjo6Y29tbWl0KCk7CgogICAgICAgIHJldHVybiAkdGhpcy0+dXJsUmVkaXJlY3RCYWNrKCdTdXBwbGllciBSYXRpbmcgaXMgc3VjY2Vzc2Z1bCcsJy9wbXMnLCdzdWNjZXNzJyk7CgogICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgREI6OnJvbGxiYWNrKCk7CiAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgfQoKfQoKcHVibGljIGZ1bmN0aW9uIHRvZ2dsZSgkaWQpCnsKICAgICRtZXNzYWdlID0gJyc7CiAgICAkbWVzc2FnZUZvck1hbmFnZW1lbnQgPSAnJzsKCiAgICAkc3VwcGxpZXIgPSBTdXBwbGllcnM6OmZpbmQoJGlkKTsKICAgICRhcHByb3ZlZF9ieSA9ICRzdXBwbGllci0+YXBwcm92ZWRfYnk7CiAgICAkc3RhdHVzID0gJHN1cHBsaWVyLT5zdGF0dXM7CgogICAgaWYocmVxdWVzdCgpLT5nZXQoJ3doaWNoJykgPT0gImFwcHJvdmFsIil7CiAgICAgICAgJGFwcHJvdmVkX2J5ID0gKHJlcXVlc3QoKS0+Z2V0KCd2YWx1ZScpID09ICJjb25maXJtIiA/IChhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnUHVyY2hhc2UtRGVwYXJ0bWVudCcpID8gJ3B1cmNoYXNlLWFwcHJvdmVkJyA6ICdtYW5hZ2VtZW50LWFwcHJvdmVkJykgOiAoYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ1B1cmNoYXNlLURlcGFydG1lbnQnKSA/ICdwdXJjaGFzZS1kZWNsaW5lZCcgOiAnbWFuYWdlbWVudC1kZWNsaW5lZCcpKTsKCiAgICAgICAgaWYocmVxdWVzdCgpLT5nZXQoJ3ZhbHVlJykgPT0gImNvbmZpcm0iKXsKICAgICAgICAgICAgJG1lc3NhZ2VGb3JNYW5hZ2VtZW50ID0gJzxzcGFuIGNsYXNzPSJub3RpZmljYXRpb24tbGlua3MiIGRhdGEtc3JjPSInLnJvdXRlKCdwbXMuc3VwcGxpZXIucHJvZmlsZScsJHN1cHBsaWVyLT5pZCkuJz92aWV3IiBkYXRhLXRpdGxlPSJTdXBwbGllcnMgRGV0YWlscyI+U3VwcGxpZXI6Jy4kc3VwcGxpZXItPm5hbWUuJy5BIFN1cHBsaWVyICcuKHJlcXVlc3QoKS0+Z2V0KCd2YWx1ZScpID09ICJjb25maXJtIiA/ICdBcHByb3ZlZCcgOiAnRGVjbGluZWQnKS4nIGJ5ICcuKGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdQdXJjaGFzZS1EZXBhcnRtZW50JykgPyAnUHVyY2hhc2UgRGVwYXJ0bWVudCcgOiAnTWFuYWdlbWVudCcpLicuPC9zcGFuPic7CiAgICAgICAgfQogICAgfWVsc2VpZihyZXF1ZXN0KCktPmdldCgnd2hpY2gnKSA9PSAic3RhdHVzIil7CiAgICAgICAgJHN0YXR1cyA9IChyZXF1ZXN0KCktPmdldCgndmFsdWUnKSA9PSAiY29uZmlybSIgPyAiQWN0aXZlIiA6ICJJbmFjdGl2ZSIpOwoKICAgICAgICBpZihyZXF1ZXN0KCktPmdldCgndmFsdWUnKSA9PSAiY29uZmlybSIpewogICAgICAgICAgICAkbWVzc2FnZSA9ICc8c3BhbiBjbGFzcz0ibm90aWZpY2F0aW9uLWxpbmtzIiBkYXRhLXNyYz0iJy5yb3V0ZSgncG1zLnN1cHBsaWVyLnByb2ZpbGUnLCRzdXBwbGllci0+aWQpLic/dmlldyIgZGF0YS10aXRsZT0iU3VwcGxpZXJzIERldGFpbHMiPlN1cHBsaWVyOicuJHN1cHBsaWVyLT5uYW1lLicuQSBTdXBwbGllciAnLihyZXF1ZXN0KCktPmdldCgndmFsdWUnKSA9PSAiY29uZmlybSIgPyAiQ29uZmlybWVkIiA6ICJEZWNsaW5lZCIpLicgYnkgTWFuYWdlbWVudDwvc3Bhbj4nOwogICAgICAgIH0KICAgIH0KCiAgICAkc3VwcGxpZXItPmFwcHJvdmVkX2J5ID0gJGFwcHJvdmVkX2J5OwogICAgJHN1cHBsaWVyLT5zdGF0dXMgPSAkc3RhdHVzOwogICAgJHN1cHBsaWVyLT5zYXZlKCk7CgogICAgaWYoJHN1cHBsaWVyLT5hcHByb3ZlZF9ieSA9PSAnbWFuYWdlbWVudC1hcHByb3ZlZCcpewogICAgICAgICRzdXBwbGllci0+c3RhdHVzID0gJ0FjdGl2ZSc7CiAgICAgICAgJHN1cHBsaWVyLT5zYXZlKCk7CiAgICB9CgogICAgaWYoJHN1cHBsaWVyLT5hcHByb3ZlZF9ieSA9PSAnbWFuYWdlbWVudC1kZWNsaW5lZCcpewogICAgICAgICRzdXBwbGllci0+c3RhdHVzID0gJ0luYWN0aXZlJzsKICAgICAgICAkc3VwcGxpZXItPnNhdmUoKTsKICAgIH0KCgogICAgaWYoc3RybGVuKCRtZXNzYWdlKSA+IDEwKXsKICAgICAgICBDcmVhdGVPclVwZGF0ZU5vdGlmaWNhdGlvbigkbWVzc2FnZSwgJ3VucmVhZCcsJycsIGdldE1hbmFnZXJJbmZvKCdQdXJjaGFzZS1EZXBhcnRtZW50JyksICAnc2VudC10by1wdXJjaGFzZScsICcnKTsKCiAgICAgICAgQ3JlYXRlT3JVcGRhdGVOb3RpZmljYXRpb24oICRtZXNzYWdlLCAndW5yZWFkJywgJycsICRzdXBwbGllci0+Y3JlYXRlZF9ieSwncmVxdWlzaXRpb24nLCAnJyk7CiAgICB9CgogICAgaWYoc3RybGVuKCRtZXNzYWdlRm9yTWFuYWdlbWVudCkgPiAxMCl7CiAgICAgICAgQ3JlYXRlT3JVcGRhdGVOb3RpZmljYXRpb24oICRtZXNzYWdlRm9yTWFuYWdlbWVudCwgJ3VucmVhZCcsICcnLCBnZXRNYW5hZ2VySW5mbygnTWFuYWdlbWVudCcpLCdzZW5kLXRvLW1hbmFnZXInLCAnJyk7CiAgICB9CgogICAgJHN1cHBsaWVyU3RhdHVzID0gc3VwcGxpZXJTdGF0dXMoJHN1cHBsaWVyKTsKICAgICRhcHByb3ZhbF9idXR0b24gPSAnPGEgY2xhc3M9ImJ0biBidG4teHMgYnRuLScuJHN1cHBsaWVyU3RhdHVzWydhcHByb3ZlZF9jbGFzcyddLiciIGRhdGEtYXBwcm92ZWQtYnk9IicuJHN1cHBsaWVyLT5hcHByb3ZlZF9ieS4nIiBkYXRhLXN0YXR1cz0iJy4kc3VwcGxpZXItPnN0YXR1cy4nIiAgZGF0YS13aGljaD0iYXBwcm92YWwiIGRhdGEtc3VwcGxpZXItaWQ9IicuJHN1cHBsaWVyLT5pZC4nIiAnLigoJHN1cHBsaWVyU3RhdHVzWydhcHByb3ZhbCddICYmIChhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnUHVyY2hhc2UtRGVwYXJ0bWVudCcpIHx8IGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdNYW5hZ2VtZW50JykpKSA/ICdvbmNsaWNrPSJ0b2dnbGVTdXBwbGllclN0YXR1cygkKHRoaXMpKSInIDogJycpLic+PGkgY2xhc3M9IicuJHN1cHBsaWVyU3RhdHVzWydhcHByb3ZlZF9pY29uJ10uJyI+PC9pPiZuYnNwOycuJHN1cHBsaWVyU3RhdHVzWydhcHByb3ZlZF90ZXh0J10uJzwvYT4nOwogICAgJHN0YXR1c19idXR0b24gPSAnPGEgY2xhc3M9ImJ0biBidG4tJy4oJHN1cHBsaWVyLT5zdGF0dXMgPT0gIkFjdGl2ZSIgPyAic3VjY2VzcyIgOiAiZGFuZ2VyIikuJyBidG4tYmxvY2sgYnRuLXhzIiBkYXRhLWFwcHJvdmVkLWJ5PSInLiRzdXBwbGllci0+YXBwcm92ZWRfYnkuJyIgZGF0YS1zdGF0dXM9IicuJHN1cHBsaWVyLT5zdGF0dXMuJyIgZGF0YS13aGljaD0ic3RhdHVzIiBkYXRhLXN1cHBsaWVyLWlkPSInLiRzdXBwbGllci0+aWQuJyIgJy4oYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ01hbmFnZW1lbnQnKSAmJiAkc3VwcGxpZXItPmFwcHJvdmVkX2J5ID09ICJtYW5hZ2VtZW50LWFwcHJvdmVkIiA/ICdvbmNsaWNrPSJ0b2dnbGVTdXBwbGllclN0YXR1cygkKHRoaXMpKSInIDogJycpLic+PGkgY2xhc3M9IicuKCRzdXBwbGllci0+c3RhdHVzID09ICJBY3RpdmUiID8gImxhciBsYS1jaGVjay1jaXJjbGUiIDogImxhIGxhLWJhbiIpLiciPjwvaT4mbmJzcDsnLigkc3VwcGxpZXItPnN0YXR1cyA9PSAiQWN0aXZlIiA/ICJBY3RpdmUiIDogIlBlbmRpbmciKS4nPC9hPic7CiAgICAKCiAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgJ21lc3NhZ2UnID0+ICJTdXBwbGllciBoYXMgYmVlbiAiLihyZXF1ZXN0KCktPmdldCgndmFsdWUnKSA9PSAiY29uZmlybSIgPyAiQXBwcm92ZWQiIDogIkRlY2xpbmVkIikuIiBzdWNjZXNzZnVsbHkiLAogICAgICAgICdhcHByb3ZhbF9idXR0b24nID0+ICRhcHByb3ZhbF9idXR0b24sCiAgICAgICAgJ3N0YXR1c19idXR0b24nID0+ICRzdGF0dXNfYnV0dG9uLAogICAgXSk7Cn0KCi8vIHB1YmxpYyBmdW5jdGlvbiB0b2dnbGVGb3JBcHByb3ZhbCgkaWQpCi8vIHsKLy8gICAgICRzdXBwbGllciA9IFN1cHBsaWVyczo6ZmluZCgkaWQpOwovLyAgICAgJHN1cHBsaWVyLT5hcHByb3ZlZF9ieSA9ICgkc3VwcGxpZXItPnN0YXR1cyA9PSAicHVyY2hhc2UiID8gInVzZXJzIiA6ICJwdXJjaGFzZSIpOwovLyAgICAgJHN1cHBsaWVyLT5zYXZlKCk7CgovLyAgICAgJG1lc3NhZ2U9ICc8c3BhbiBjbGFzcz0ibm90aWZpY2F0aW9uLWxpbmtzIiBkYXRhLXNyYz0iJy5yb3V0ZSgncG1zLnN1cHBsaWVyLnByb2ZpbGUnLCRzdXBwbGllci0+aWQpLic/dmlldyIgZGF0YS10aXRsZT0iU3VwcGxpZXJzIERldGFpbHMiPlN1cHBsaWVyOicuJHN1cHBsaWVyLT5uYW1lLicuQSBTdXBwbGllciBBcHByb3ZlZCBieSBQdXJjaGFzZSxXYXR0aW5nIGZvciBBcHByb3ZhbC48L3NwYW4+JzsKCgovLyAgICAgQ3JlYXRlT3JVcGRhdGVOb3RpZmljYXRpb24oJycsZ2V0TWFuYWdlckluZm8oJ01hbmFnZW1lbnQnKSwkbWVzc2FnZSwndW5yZWFkJywnc2VuZC10by1tYW5hZ2VyJywnJyk7CgovLyAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwovLyAgICAgICAgICdtZXNzYWdlJyA9PiAiU3VwcGxpZXIgaGFzIGJlZW4gIi4oJHN1cHBsaWVyLT5hcHByb3ZlZF9ieSA9PSAicHVyY2hhc2UiID8gIkFwcHJvdmVkIiA6ICJEZWNsaW5lZCIpLiIgc3VjY2Vzc2Z1bGx5IiwKLy8gICAgICAgICAnc3RhdHVzJyA9PiAkc3VwcGxpZXItPnN0YXR1cywKLy8gICAgICAgICAnYXBwcm92ZWRfYnknID0+ICRzdXBwbGllci0+YXBwcm92ZWRfYnksCi8vICAgICBdKTsKLy8gfQoKcHVibGljIGZ1bmN0aW9uIGNyZWF0ZVN1cHBsaWVyTG9nKCRzdXBwbGllcl9pZCkKewogICAgJGRhdGEgPSBbCiAgICAgICAgJ3N1cHBsaWVyX2lkJyA9PiAkc3VwcGxpZXJfaWQKICAgIF07CgogICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnN1cHBsaWVycy5sb2dzLmNyZWF0ZScsICRkYXRhKTsKfQoKcHVibGljIGZ1bmN0aW9uIHNhdmVTdXBwbGllckxvZyhSZXF1ZXN0ICRyZXF1ZXN0LCAkc3VwcGxpZXJfaWQpCnsKICAgICRyZXF1ZXN0LT52YWxpZGF0ZShbCiAgICAgICAgJ2RhdGUnID0+ICdyZXF1aXJlZCcsCiAgICAgICAgJ3RvcGljJyA9PiAncmVxdWlyZWQnLAogICAgICAgICdsb2cnID0+ICdyZXF1aXJlZCcsCiAgICBdKTsKCiAgICBEQjo6YmVnaW5UcmFuc2FjdGlvbigpOwogICAgdHJ5ewogICAgICAgICRsb2cgPSBzYXZlU3VwcGxpZXJMb2coJHN1cHBsaWVyX2lkLCAkcmVxdWVzdC0+ZGF0ZSwgJHJlcXVlc3QtPnRvcGljLCAkcmVxdWVzdC0+bG9nKTsKCiAgICAgICAgaWYoJGxvZyl7CiAgICAgICAgICAgIERCOjpjb21taXQoKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnID0+IHRydWUKICAgICAgICAgICAgXSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICdzdWNjZXNzJyA9PiBmYWxzZQogICAgICAgIF0pOwogICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgREI6OnJvbGxiYWNrKCk7CiAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAnc3VjY2VzcycgPT4gZmFsc2UsCiAgICAgICAgICAgICdtZXNzYWdlJyA9PiAkdGgtPmdldE1lc3NhZ2UoKQogICAgICAgIF0pOwogICAgfQp9CgpwdWJsaWMgZnVuY3Rpb24gZWRpdFN1cHBsaWVyTG9nKCRsb2dfaWQpCnsKICAgICRkYXRhID0gWwogICAgICAgICdsb2cnID0+IFN1cHBsaWVyTG9nOjpmaW5kKCRsb2dfaWQpCiAgICBdOwoKICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5zdXBwbGllcnMubG9ncy5lZGl0JywgJGRhdGEpOwp9CgpwdWJsaWMgZnVuY3Rpb24gdXBkYXRlU3VwcGxpZXJMb2coUmVxdWVzdCAkcmVxdWVzdCwgJGxvZ19pZCkKewogICAgJHJlcXVlc3QtPnZhbGlkYXRlKFsKICAgICAgICAnZGF0ZScgPT4gJ3JlcXVpcmVkJywKICAgICAgICAndG9waWMnID0+ICdyZXF1aXJlZCcsCiAgICAgICAgJ2xvZycgPT4gJ3JlcXVpcmVkJywKICAgIF0pOwoKICAgIERCOjpiZWdpblRyYW5zYWN0aW9uKCk7CiAgICB0cnl7CiAgICAgICAgJGxvZyA9IFN1cHBsaWVyTG9nOjpmaW5kKCRsb2dfaWQpOwogICAgICAgICRsb2cgPSBzYXZlU3VwcGxpZXJMb2coJGxvZy0+c3VwcGxpZXJfaWQsICRyZXF1ZXN0LT5kYXRlLCAkcmVxdWVzdC0+dG9waWMsICRyZXF1ZXN0LT5sb2csICRsb2ctPmlkKTsKCiAgICAgICAgaWYoJGxvZyl7CiAgICAgICAgICAgIERCOjpjb21taXQoKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnID0+IHRydWUKICAgICAgICAgICAgXSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICdzdWNjZXNzJyA9PiBmYWxzZQogICAgICAgIF0pOwogICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgREI6OnJvbGxiYWNrKCk7CiAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAnc3VjY2VzcycgPT4gZmFsc2UsCiAgICAgICAgICAgICdtZXNzYWdlJyA9PiAkdGgtPmdldE1lc3NhZ2UoKQogICAgICAgIF0pOwogICAgfQp9CgpwdWJsaWMgZnVuY3Rpb24gZGVsZXRlU3VwcGxpZXJMb2coJGxvZ19pZCkKewogICAgREI6OmJlZ2luVHJhbnNhY3Rpb24oKTsKICAgIHRyeXsKICAgICAgICAkbG9nID0gU3VwcGxpZXJMb2c6OmZpbmQoJGxvZ19pZCktPmRlbGV0ZSgpOwoKICAgICAgICBpZigkbG9nKXsKICAgICAgICAgICAgREI6OmNvbW1pdCgpOwogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gdHJ1ZSwKICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAnTG9nIGhhcyBiZWVuIGRlbGV0ZWQnCiAgICAgICAgICAgIF0pOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAnc3VjY2VzcycgPT4gZmFsc2UsCiAgICAgICAgICAgICdtZXNzYWdlJyA9PiAnU29tZXRoaW5nIHdlbnQgd3JvbmchJwogICAgICAgIF0pOwogICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgREI6OnJvbGxiYWNrKCk7CiAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAnc3VjY2VzcycgPT4gZmFsc2UsCiAgICAgICAgICAgICdtZXNzYWdlJyA9PiAkdGgtPmdldE1lc3NhZ2UoKQogICAgICAgIF0pOwogICAgfQp9CgoKcHVibGljIGZ1bmN0aW9uIGNhdGVnb3J5V2lzZVByb2R1Y3RzKFJlcXVlc3QgJHJlcXVlc3QpCnsKICAgICRwcm9kdWN0cyA9IFByb2R1Y3Q6OndpdGgoWwogICAgICAgICdhdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGUnCiAgICBdKQogICAgLT53aGVyZUluKCdjYXRlZ29yeV9pZCcsICRyZXF1ZXN0LT5zdWJfY2F0ZWdvcmllcykKICAgIC0+d2hlcmUoJ3N0YXR1cycsICdhcHByb3ZlZCcpLT5nZXQoKTsKICAgICRkYXRhID0gJyc7CiAgICBpZihpc3NldCgkcHJvZHVjdHNbMF0pKXsKICAgICAgICBmb3JlYWNoKCRwcm9kdWN0cyBhcyAka2V5ID0+ICRwcm9kdWN0KXsKICAgICAgICAgICAgJHNlbGVjdGVkID0gKGlzc2V0KCRyZXF1ZXN0LT5zZWxlY3RlZF9wcm9kdWN0c1swXSkgPyAoaW5fYXJyYXkoJHByb2R1Y3QtPmlkLCAkcmVxdWVzdC0+c2VsZWN0ZWRfcHJvZHVjdHMpID8gJ3NlbGVjdGVkJyA6ICcnKSA6ICcnKTsKICAgICAgICAgICAgJGRhdGEgLj0gJzxvcHRpb24gdmFsdWU9IicuJHByb2R1Y3QtPmlkLiciICcuJHNlbGVjdGVkLic+Jy4kcHJvZHVjdC0+bmFtZS4nICcuZ2V0UHJvZHVjdEF0dHJpYnV0ZXNGYXN0ZXIoJHByb2R1Y3QpLic8L29wdGlvbj4nOwogICAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gJGRhdGE7Cgp9CgpwdWJsaWMgZnVuY3Rpb24gc3VwcGxpZXJDb2RlKCRzdXBwbGllciA9IGZhbHNlKQp7CiAgICAkY291bnQgPSBTdXBwbGllcnM6OndoZW4oJHN1cHBsaWVyLCBmdW5jdGlvbigkcXVlcnkpIHVzZSgkc3VwcGxpZXIpewogICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdpZCcsICc8JywgJHN1cHBsaWVyLT5pZCkKICAgICAgICAtPndoZXJlKERCOjpyYXcoJ3N1YnN0cihgY3JlYXRlZF9hdGAsIDEsIDQpJyksIGRhdGUoJ1knLCBzdHJ0b3RpbWUoJHN1cHBsaWVyLT5jcmVhdGVkX2F0KSkpOwogICAgfSkKICAgIC0+d2hlbighJHN1cHBsaWVyLCBmdW5jdGlvbigkcXVlcnkpewogICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKERCOjpyYXcoJ3N1YnN0cihgY3JlYXRlZF9hdGAsIDEsIDQpJyksIGRhdGUoJ1knKSk7CiAgICB9KQogICAgLT5jb3VudCgpOwoKICAgIHJldHVybiAoJHN1cHBsaWVyID8gZGF0ZSgneScsIHN0cnRvdGltZSgkc3VwcGxpZXItPmNyZWF0ZWRfYXQpKSA6IGRhdGUoJ3knKSkuc3ByaW50ZigiJTA0ZCIsICRjb3VudCsxKTsKfQoKfQo=