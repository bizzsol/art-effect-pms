<?php
bolt_decrypt( __FILE__ , 'Fpy3HV'); return 0;
##!!!##CgpuYW1lc3BhY2UgQXBwXEh0dHBcQ29udHJvbGxlcnNcUG1zOwoKdXNlIEFwcFxIdHRwXENvbnRyb2xsZXJzXENvbnRyb2xsZXI7CnVzZSBBcHBcTW9kZWxzXE1lcmNoXFN1cHBsaWVyOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcR3JuXEdvb2RzUmVjZWl2ZWROb3RlOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUGF5bWVudFRlcm07CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xTdXBwbGllclBheW1lbnRUZXJtOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcU3VwcGxpZXJSYXRpbmdzOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcU3VwcGxpZXJzOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcU3VwcGxpZXJBZGRyZXNzOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcU3VwcGxpZXJCYW5rQWNjb3VudDsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFN1cHBsaWVyQ29udGFjdFBlcnNvbjsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFN1cHBsaWVyTG9nOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUHJvZHVjdDsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXENhdGVnb3J5Owp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcU3VwcGxpZXJMZWRnZXJzOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcQWNjb3VudHNcQ2hhcnRPZkFjY291bnQ7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xBY2NvdW50c1xDdXJyZW5jeTsKdXNlIEFwcFxNb2RlbHNcSHJcVW5pdDsKdXNlIEFwcFxNb2RlbHNcSHJcRGVwYXJ0bWVudDsKCnVzZSBJbGx1bWluYXRlXEh0dHBcUmVxdWVzdDsKdXNlIElsbHVtaW5hdGVcU3VwcG9ydFxGYWNhZGVzXFNjaGVtYTsKdXNlIERCLCBWaWV3LCBEYXRhVGFibGVzOwoKY2xhc3MgU3VwcGxpZXJDb250cm9sbGVyIGV4dGVuZHMgQ29udHJvbGxlcgp7ICAgCgogICAgcHVibGljIGZ1bmN0aW9uIGhlYWRlckNvbHVtbnMoJHZhbHVlPScnKQogICAgewogICAgICAgICRyb3dzID0gIGFycmF5KAogICAgICAgICAgICBbJ1NMJywgJ1NMJ10sCiAgICAgICAgICAgIFsnY29kZScsICdjb2RlJ10sCiAgICAgICAgICAgIFsnbmFtZScsICduYW1lJ10sCiAgICAgICAgICAgIFsncHJvZHVjdF9jYXRlZ29yaWVzJywgJ3Byb2R1Y3RfY2F0ZWdvcmllcycsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ2NvcnBvcmF0ZV9hZGRyZXNzJywgJ2NvcnBvcmF0ZV9hZGRyZXNzJywgJ3RleHQtbGVmdCddLCAKICAgICAgICAgICAgWydjb250YWN0X3BlcnNvbl9uYW1lJywgJ2NvbnRhY3RfcGVyc29uX25hbWUnLCAndGV4dC1sZWZ0J10sCiAgICAgICAgICAgIFsnbW9iaWxlX25vJywgJ21vYmlsZV9ubycsICd0ZXh0LWxlZnQnXSwgCiAgICAgICAgICAgIFsnY2xvc2luZ19iYWxhbmNlJywgJ2Nsb3NpbmdfYmFsYW5jZScsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ2FwcHJvdmFsJywgJ2FwcHJvdmFsJywgJ3RleHQtY2VudGVyIHB1cmNoYXNlLWFjdGlvbnMnXSwKICAgICAgICAgICAgWydzdGF0dXMnLCAnc3RhdHVzJywgJ3RleHQtY2VudGVyIG1hbmFnZW1lbnQtYWN0aW9ucyddLCAKICAgICAgICAgICAgWydhY3Rpb25zJywgJ2FjdGlvbnMnLCAndGV4dC1jZW50ZXInXQogICAgICAgICk7CgogICAgICAgIGlmICghcmVxdWVzdCgpLT5oYXMoJ3Byb2R1Y3RzJykpIHsKICAgICAgICAgICAgdW5zZXQoJHJvd3NbN10pOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBpZiAoYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ0FjY291bnRzJykpIHsKICAgICAgICAgICAgdW5zZXQoJHJvd3NbOF0pOwogICAgICAgICAgICB1bnNldCgkcm93c1s5XSk7CiAgICAgICAgICAgIHVuc2V0KCRyb3dzWzEwXSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gJHJvd3M7CiAgICB9CiAgICAvKioKICAgICAqIERpc3BsYXkgYSBsaXN0aW5nIG9mIHRoZSByZXNvdXJjZS4KICAgICAqCiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwogICAgcHVibGljIGZ1bmN0aW9uIGluZGV4KCkKICAgIHsKICAgICAgICAvKgogICAgICAgIGlmKHJlcXVlc3QoKS0+aGFzKCdnZW5lcmF0ZS1zdXBwbGllci1jdXJyZW5jaWVzJykpewogICAgICAgICAgICBmb3JlYWNoKFN1cHBsaWVyczo6ZG9lc250SGF2ZSgnc3VwcGxlaWVyQ3VycmVuY2llcycpLT5nZXQoKSBhcyAka2V5ID0+ICRzdXBwbGllcil7CiAgICAgICAgICAgICAgICBcQXBwXE1vZGVsc1xQbXNNb2RlbHNcU3VwcGxpZXJDdXJyZW5jeTo6Y3JlYXRlKFsKICAgICAgICAgICAgICAgICAgICAnc3VwcGxpZXJfaWQnID0+ICRzdXBwbGllci0+aWQsCiAgICAgICAgICAgICAgICAgICAgJ2N1cnJlbmN5X2lkJyA9PiAxLAogICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgKi8KCiAgICAgICAgLyoKICAgICAgICBpZihyZXF1ZXN0KCktPmhhcygnZ2VuZXJhdGUtc3VwcGxpZXItY29kZXMnKSl7CiAgICAgICAgICAgIGZvcmVhY2goU3VwcGxpZXJzOjp3aGVyZU51bGwoJ2NvZGUnKS0+Z2V0KCkgYXMgJGtleSA9PiAkc3VwcGxpZXIpewogICAgICAgICAgICAgICAgJHN1cHBsaWVyLT5jb2RlID0gJHRoaXMtPnN1cHBsaWVyQ29kZSgkc3VwcGxpZXIpOwogICAgICAgICAgICAgICAgJHN1cHBsaWVyLT5zYXZlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgKi8KCiAgICAgICAgLyoKICAgICAgICBpZihyZXF1ZXN0KCktPmhhcygndXBkYXRlLXByb2R1Y3RzLWZvci1pbnRlcm5hbC1qb2Itb3JkZXInKSl7CiAgICAgICAgICAgIHVwZGF0ZVN1cHBsaWVyUHJvZHVjdHMoMTIpOwogICAgICAgIH0KICAgICAgICAqLyAKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgJG9wdGlvbnMgPSBbCiAgICAgICAgICAgICAgICAnUHVyY2hhc2UtRW1wbG95ZWUnID0+IGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdQdXJjaGFzZS1FbXBsb3llZScpLAogICAgICAgICAgICAgICAgJ1B1cmNoYXNlLURlcGFydG1lbnQnID0+IGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdQdXJjaGFzZS1EZXBhcnRtZW50JyksCiAgICAgICAgICAgICAgICAnTWFuYWdlbWVudCcgPT4gYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ01hbmFnZW1lbnQnKSwKICAgICAgICAgICAgICAgICdBY2NvdW50cycgPT4gYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ0FjY291bnRzJyksCiAgICAgICAgICAgICAgICAnUHVyY2hhc2UtRW1wbG95ZWUnID0+IGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdQdXJjaGFzZS1FbXBsb3llZScpLAogICAgICAgICAgICAgICAgJ3N1cHBsaWVyLWVkaXQnID0+IGF1dGgoKS0+dXNlcigpLT5oYXNQZXJtaXNzaW9uVG8oJ3N1cHBsaWVyLWVkaXQnKSwKICAgICAgICAgICAgICAgICdzdXBwbGllci1kZWxldGUnID0+IGF1dGgoKS0+dXNlcigpLT5oYXNQZXJtaXNzaW9uVG8oJ3N1cHBsaWVyLWRlbGV0ZScpLAogICAgICAgICAgICBdOwoKICAgICAgICAgICAgJHRpdGxlID0gJ1N1cHBsaWVycyc7CiAgICAgICAgICAgICRzdXBwbGllcnMgPSBTdXBwbGllcnM6OndpdGgoWwogICAgICAgICAgICAgICAgJ3Byb2R1Y3RzLmNhdGVnb3J5LmNhdGVnb3J5JywgJ2FkZHJlc3NlcycsICdjb250YWN0UGVyc29ucycsICdzdXBwbGllckNsb3NpbmdCYWxhbmNlJywgJ3JlbFF1b3RhdGlvbnMnCiAgICAgICAgICAgIF0pCiAgICAgICAgICAgIC0+d2hlbigkb3B0aW9uc1snUHVyY2hhc2UtRW1wbG95ZWUnXSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlTm90SW4oJ2FwcHJvdmVkX2J5JywgWydwdXJjaGFzZS1kZWNsaW5lZCcsICdtYW5hZ2VtZW50LWRlY2xpbmVkJ10pOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPndoZW4oJG9wdGlvbnNbJ1B1cmNoYXNlLURlcGFydG1lbnQnXSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSW4oJ2FwcHJvdmVkX2J5JywgWydzZW50LXRvLXB1cmNoYXNlJywgJ3B1cmNoYXNlLWFwcHJvdmVkJywgJ21hbmFnZW1lbnQtYXBwcm92ZWQnXSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+d2hlbigkb3B0aW9uc1snTWFuYWdlbWVudCddLCBmdW5jdGlvbigkcXVlcnkpewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVJbignYXBwcm92ZWRfYnknLCBbJ3B1cmNoYXNlLWFwcHJvdmVkJywgJ21hbmFnZW1lbnQtYXBwcm92ZWQnXSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+d2hlbigkb3B0aW9uc1snQWNjb3VudHMnXSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPmhhcygncmVsUGF5bWVudHMucmVsU3VwcGxpZXJMZWRnZXJzJyk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+d2hlbighZGF0YXRhYmxlT3JkZXJpbmcoKSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyYnkoJ2lkJywgJ2Rlc2MnKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIC8vIC0+d2hlcmVOb3RJbignaWQnLFsxMiwxM10pCiAgICAgICAgICAgIC8vIC0+d2hlcmUoJ2lkJywgJz4nLCAxMCk7CgogICAgICAgICAgICAkY2F0ZWdvcmllcyA9IGNvbGxlY3QoQ2F0ZWdvcnk6OndpdGgoJ3N1YkNhdGVnb3J5JyktPndoZXJlSGFzKCdzdWJDYXRlZ29yeScpLT5nZXQoKSk7CiAgICAgICAgICAgICRzdWJDYXRlZ29yaWVzID0gY29sbGVjdChDYXRlZ29yeTo6d2hlcmVIYXMoJ2NhdGVnb3J5JyktPmdldCgpKTsKCiAgICAgICAgICAgIGlmIChyZXF1ZXN0KCktPmFqYXgoKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIERhdGF0YWJsZXM6Om9mKCRzdXBwbGllcnMpCiAgICAgICAgICAgICAgICAtPmFkZEluZGV4Q29sdW1uKCkKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdwcm9kdWN0X2NhdGVnb3JpZXMnLCBmdW5jdGlvbigkc3VwcGxpZXIpIHVzZSgkY2F0ZWdvcmllcywgJHN1YkNhdGVnb3JpZXMpewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkY2F0ZWdvcmllcy0+d2hlcmVJbignaWQnLCAkc3ViQ2F0ZWdvcmllcy0+d2hlcmVJbignaWQnLCAkc3VwcGxpZXItPnByb2R1Y3RzLT5wbHVjaygnY2F0ZWdvcnlfaWQnKS0+dG9BcnJheSgpKS0+cGx1Y2soJ3BhcmVudF9pZCcpLT50b0FycmF5KCkpLT5wbHVjaygnbmFtZScpLT5pbXBsb2RlKCcsICcpOwogICAgICAgICAgICAgICAgICAgIC8vIHJldHVybiBDYXRlZ29yeTo6d2hlcmVIYXMoJ3N1YkNhdGVnb3J5JywgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJHN1cHBsaWVyKXsKICAgICAgICAgICAgICAgICAgICAvLyAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVJbignaWQnLCAkc3VwcGxpZXItPnByb2R1Y3RzLT5wbHVjaygnY2F0ZWdvcnlfaWQnKS0+dG9BcnJheSgpKTsKICAgICAgICAgICAgICAgICAgICAvLyB9KS0+cGx1Y2soJ25hbWUnKS0+aW1wbG9kZSgnLCAnKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbigncHJvZHVjdF9jYXRlZ29yaWVzJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncHJvZHVjdHMuY2F0ZWdvcnkuY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJyk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2NvcnBvcmF0ZV9hZGRyZXNzJywgZnVuY3Rpb24oJHN1cHBsaWVyKXsKICAgICAgICAgICAgICAgICAgICAgJGFkZHJlc3MgPSAnJzsKICAgICAgICAgICAgICAgICAgICAgJGNvcnBvcmF0ZUFkZHJlc3MgPSAkc3VwcGxpZXItPmFkZHJlc3Nlcy0+d2hlcmUoJ3R5cGUnLCAnY29ycG9yYXRlJyk7CiAgICAgICAgICAgICAgICAgICAgIGlmKGlzc2V0KCRjb3Jwb3JhdGVBZGRyZXNzWzBdLT5pZCkpewogICAgICAgICAgICAgICAgICAgICAgICAkYWRkcmVzcyAuPSAkY29ycG9yYXRlQWRkcmVzc1swXS0+dmlsbGFnZS4nICcuJGNvcnBvcmF0ZUFkZHJlc3NbMF0tPnJvYWQuJywgJy4kY29ycG9yYXRlQWRkcmVzc1swXS0+Y2l0eS4nLScuJGNvcnBvcmF0ZUFkZHJlc3NbMF0tPnppcC4nLCAnLiRjb3Jwb3JhdGVBZGRyZXNzWzBdLT5jb3VudHJ5IC4nPGJyPicuICRjb3Jwb3JhdGVBZGRyZXNzWzBdLT5hZGRyZXNzOwogICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHJldHVybiAgJGFkZHJlc3M7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ2NvcnBvcmF0ZV9hZGRyZXNzJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygnYWRkcmVzc2VzJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ3JvYWQnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmUoJ3R5cGUnLCAnY29ycG9yYXRlJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5vcldoZXJlKGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRrZXl3b3JkKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnemlwJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPm9yV2hlcmUoJ2NvdW50cnknLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+b3JXaGVyZSgnYWRkcmVzcycsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5vcldoZXJlKCd2aWxsYWdlJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2NvbnRhY3RfcGVyc29uX25hbWUnLCBmdW5jdGlvbigkc3VwcGxpZXIpewogICAgICAgICAgICAgICAgICAgICRjb250YWN0UGVyc29uID0gJyc7CgogICAgICAgICAgICAgICAgICAgICRjb250YWN0UGVyc29uU2FsZXMgPSAkc3VwcGxpZXItPmNvbnRhY3RQZXJzb25zLT53aGVyZSgndHlwZScsICdzYWxlcycpOwoKICAgICAgICAgICAgICAgICAgICBpZihpc3NldCgkY29udGFjdFBlcnNvblNhbGVzWzBdLT5pZCkpewogICAgICAgICAgICAgICAgICAgICAgICAkY29udGFjdFBlcnNvbiAuPSAkY29udGFjdFBlcnNvblNhbGVzWzBdLT5uYW1lOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICAkY29udGFjdFBlcnNvbjsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbignY29udGFjdF9wZXJzb25fbmFtZScsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ2NvbnRhY3RQZXJzb25zJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdtb2JpbGVfbm8nLCBmdW5jdGlvbigkc3VwcGxpZXIpewogICAgICAgICAgICAgICAgICAgICRjb250YWN0UGVyc29uID0gJyc7CgogICAgICAgICAgICAgICAgICAgICRjb250YWN0UGVyc29uU2FsZXMgPSAkc3VwcGxpZXItPmNvbnRhY3RQZXJzb25zLT53aGVyZSgndHlwZScsICdzYWxlcycpOwoKICAgICAgICAgICAgICAgICAgICBpZihpc3NldCgkY29udGFjdFBlcnNvblNhbGVzWzBdLT5pZCkpewogICAgICAgICAgICAgICAgICAgICAgICAkY29udGFjdFBlcnNvbiAuPSAkY29udGFjdFBlcnNvblNhbGVzWzBdLT5tb2JpbGU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICByZXR1cm4gICRjb250YWN0UGVyc29uOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdtb2JpbGVfbm8nLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdjb250YWN0UGVyc29ucycsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdtb2JpbGUnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdjbG9zaW5nX2JhbGFuY2UnLCBmdW5jdGlvbigkc3VwcGxpZXIpIHVzZSgkb3B0aW9ucyl7CiAgICAgICAgICAgICAgICAgICAgaWYoJG9wdGlvbnNbJ0FjY291bnRzJ10pewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNzZXQoJHN1cHBsaWVyLT5zdXBwbGllckNsb3NpbmdCYWxhbmNlLT5jbG9zaW5nX2JhbGFuY2UpID8gJHN1cHBsaWVyLT5zdXBwbGllckNsb3NpbmdCYWxhbmNlLT5jbG9zaW5nX2JhbGFuY2UgOiAwOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2FwcHJvdmFsJywgZnVuY3Rpb24oJHN1cHBsaWVyKSB1c2UoJG9wdGlvbnMpewogICAgICAgICAgICAgICAgICAgICRzdXBwbGllclN0YXR1cyA9IHN1cHBsaWVyU3RhdHVzKCRzdXBwbGllcik7CiAgICAgICAgICAgICAgICAgICAgJGFwcHJvdmFscyA9ICcnOwogICAgICAgICAgICAgICAgICAgIGlmKCEkb3B0aW9uc1snQWNjb3VudHMnXSl7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkc3VwcGxpZXJTdGF0dXNbJ2FwcHJvdmFsJ10gJiYgKCRvcHRpb25zWydQdXJjaGFzZS1EZXBhcnRtZW50J10gfHwgJG9wdGlvbnNbJ01hbmFnZW1lbnQnXSkpCiAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYXBwcm92YWxzIC49ICc8YSBjbGFzcz0iYnRuIGJ0bi14cyBidG4tJy4kc3VwcGxpZXJTdGF0dXNbJ2FwcHJvdmVkX2NsYXNzJ10gLiciIGRhdGEtYXBwcm92ZWQtYnk9IicuJHN1cHBsaWVyLT5hcHByb3ZlZF9ieSAuJyIgZGF0YS1zdGF0dXM9IicuJHN1cHBsaWVyLT5zdGF0dXMuJyIgIGRhdGEtd2hpY2g9ImFwcHJvdmFsIiBkYXRhLXN1cHBsaWVyLWlkPSInLiRzdXBwbGllci0+aWQuJyIgb25jbGljaz0idG9nZ2xlU3VwcGxpZXJTdGF0dXMoJCh0aGlzKSkiPjxpIGNsYXNzPSInLiAkc3VwcGxpZXJTdGF0dXNbJ2FwcHJvdmVkX2ljb24nXSAuJyI+PC9pPiZuYnNwOycuICRzdXBwbGllclN0YXR1c1snYXBwcm92ZWRfdGV4dCddIC4nPC9hPic7CiAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhcHByb3ZhbHMgLj0gJzxhIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi0nLiRzdXBwbGllclN0YXR1c1snYXBwcm92ZWRfY2xhc3MnXSAuJyIgZGF0YS1hcHByb3ZlZC1ieT0iJy4kc3VwcGxpZXItPmFwcHJvdmVkX2J5IC4nIiBkYXRhLXN0YXR1cz0iJy4kc3VwcGxpZXItPnN0YXR1cy4nIiAgZGF0YS13aGljaD0iYXBwcm92YWwiIGRhdGEtc3VwcGxpZXItaWQ9IicuJHN1cHBsaWVyLT5pZC4nIiA+PGkgY2xhc3M9IicuICRzdXBwbGllclN0YXR1c1snYXBwcm92ZWRfaWNvbiddIC4nIj48L2k+Jm5ic3A7Jy4gJHN1cHBsaWVyU3RhdHVzWydhcHByb3ZlZF90ZXh0J10gLic8L2E+JzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGFwcHJvdmFsczsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmVkaXRDb2x1bW4oJ3N0YXR1cycsIGZ1bmN0aW9uKCRzdXBwbGllcikgdXNlKCRvcHRpb25zKXsKICAgICAgICAgICAgICAgICAgICAkc3RhdHVzID0gJyc7CgogICAgICAgICAgICAgICAgICAgIGlmKCEkb3B0aW9uc1snQWNjb3VudHMnXSl7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmKCRvcHRpb25zWydNYW5hZ2VtZW50J10gJiYgJHN1cHBsaWVyLT5hcHByb3ZlZF9ieSA9PSAibWFuYWdlbWVudC1hcHByb3ZlZCIpewogICAgICAgICAgICAgICAgICAgICAgICBpZigkc3VwcGxpZXItPmFwcHJvdmVkX2J5ID09ICJtYW5hZ2VtZW50LWFwcHJvdmVkIil7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc3RhdHVzIC49ICc8YSBjbGFzcz0iYnRuIGJ0bi0nLigkc3VwcGxpZXItPnN0YXR1cyA9PSAiQWN0aXZlIiA/ICJzdWNjZXNzIiA6ICJkYW5nZXIiKS4nIGJ0bi1ibG9jayBidG4teHMiIGRhdGEtYXBwcm92ZWQtYnk9IicuICRzdXBwbGllci0+YXBwcm92ZWRfYnkgLiciIGRhdGEtc3RhdHVzPSInLiAkc3VwcGxpZXItPnN0YXR1cyAuJyIgZGF0YS13aGljaD0ic3RhdHVzIiBkYXRhLXN1cHBsaWVyLWlkPSInLiAkc3VwcGxpZXItPmlkIC4nIiBvbmNsaWNrPSJ0b2dnbGVTdXBwbGllclN0YXR1cygkKHRoaXMpKSIgPjxpIGNsYXNzPSInLiAoJHN1cHBsaWVyLT5zdGF0dXMgPT0gIkFjdGl2ZSIgPyAibGFyIGxhLWNoZWNrLWNpcmNsZSIgOiAibGEgbGEtYmFuIikuJyI+PC9pPiZuYnNwOycuICgkc3VwcGxpZXItPnN0YXR1cyA9PSAiQWN0aXZlIiA/ICJBY3RpdmUiIDogIlBlbmRpbmciICkuJzwvYT4nOwogICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzdGF0dXMgLj0gJzxhIGNsYXNzPSJidG4gYnRuLScuICgkc3VwcGxpZXItPnN0YXR1cyA9PSAiQWN0aXZlIiA/ICJzdWNjZXNzIiA6ICJkYW5nZXIiICkuJyBidG4tYmxvY2sgYnRuLXhzIiBkYXRhLWFwcHJvdmVkLWJ5PSInLiAkc3VwcGxpZXItPmFwcHJvdmVkX2J5IC4nIiBkYXRhLXN0YXR1cz0iJy4gJHN1cHBsaWVyLT5zdGF0dXMgLiciIGRhdGEtd2hpY2g9InN0YXR1cyIgZGF0YS1zdXBwbGllci1pZD0iJy4gJHN1cHBsaWVyLT5pZCAuJyIgb25jbGljaz0idG9nZ2xlU3VwcGxpZXJTdGF0dXMoJCh0aGlzKSkiID48aSBjbGFzcz0iJy4gKCRzdXBwbGllci0+c3RhdHVzID09ICJBY3RpdmUiID8gImxhciBsYS1jaGVjay1jaXJjbGUiIDogImxhIGxhLWJhbiIgKS4nIj48L2k+Jm5ic3A7Jy4gKCRzdXBwbGllci0+c3RhdHVzID09ICJBY3RpdmUiID8gIkFjdGl2ZSIgOiAiUGVuZGluZyIpIC4nPC9hPic7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRzdGF0dXM7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2FjdGlvbnMnLCBmdW5jdGlvbigkc3VwcGxpZXIpIHVzZSgkb3B0aW9ucyl7CiAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgPSAnJzsKCiAgICAgICAgICAgICAgICAgICAgaWYoISRvcHRpb25zWydBY2NvdW50cyddKXsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCRvcHRpb25zWydzdXBwbGllci1lZGl0J10pewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxhIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi1zdWNjZXNzIHJvdW5kZWQtY2lyY2xlIG0tMSIgaHJlZj0iJy5yb3V0ZSgncG1zLnN1cHBsaWVyLmVkaXQnLCAkc3VwcGxpZXItPmlkKS4nIj48aSBjbGFzcz0ibGEgbGEtZWRpdCI+PC9pPjwvYT4nOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPScgPGEgaHJlZj0iJy4gcm91dGUoJ3Btcy5zdXBwbGllci5wcm9maWxlJywgJHN1cHBsaWVyLT5pZCkgLiciIGNsYXNzPSJidG4gYnRuLWluZm8gbS0xIGJ0bi14cyI+PGkgY2xhc3M9ImxhcyBsYS11c2VyIj48L2k+PC9hPic7CgogICAgICAgICAgICAgICAgICAgICAgICBpZigkc3VwcGxpZXItPmRlbGV0YWJsZSA9PSAneWVzJyAmJiAhZnJlZXplU3VwcGxpZXIoJHN1cHBsaWVyKSAmJiAkb3B0aW9uc1snc3VwcGxpZXItZGVsZXRlJ10pewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgY2xhc3M9ImJ0biBidG4teHMgYnRuLWRhbmdlciBtLTEiIGRhdGEtc3JjPSInLnJvdXRlKCdwbXMuc3VwcGxpZXIuZGVzdHJveScsICRzdXBwbGllci0+aWQpLiciIG9uY2xpY2s9ImRlbGV0ZUZyb21DUlVEKCQodGhpcykpIj48aSBjbGFzcz0ibGEgbGEtdHJhc2giPjwvaT48L2E+JzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRhY3Rpb25zOwoKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPnJhd0NvbHVtbnMoWydjb3Jwb3JhdGVfYWRkcmVzcycsJ3Byb2R1Y3RfY2F0ZWdvcmllcycsJ2FwcHJvdmFsJywnc3RhdHVzJywgJ2FjdGlvbnMnXSkKICAgICAgICAgICAgICAgIC0+bWFrZSh0cnVlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnN1cHBsaWVycy5pbmRleCcsIFsKICAgICAgICAgICAgICAgICd0aXRsZScgPT4kdGl0bGUsCiAgICAgICAgICAgICAgICAnaGVhZGVyQ29sdW1ucycgPT4gJHRoaXMtPmhlYWRlckNvbHVtbnMoKQogICAgICAgICAgICBdKTsKICAgICAgICB9Y2F0Y2ggKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIHNob3dEZWNsaW5lU3VwcGxpZXJzKCkKICAgIHsKICAgICAgICB0cnkgewoKICAgICAgICAgICAgJHRpdGxlID0gJ0RlY2xpbmUgU3VwcGxpZXJzJzsKICAgICAgICAgICAgJHN1cHBsaWVycyA9IFN1cHBsaWVyczo6d2hlbihhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnUHVyY2hhc2UtRW1wbG95ZWUnKSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdjcmVhdGVkX2J5JyxhdXRoKCktPnVzZXIoKS0+aWQpCiAgICAgICAgICAgICAgICAtPndoZXJlSW4oJ2FwcHJvdmVkX2J5JywgWydwdXJjaGFzZS1kZWNsaW5lZCcsICdtYW5hZ2VtZW50LWRlY2xpbmVkJ10pOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPndoZW4oYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ1B1cmNoYXNlLURlcGFydG1lbnQnKSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSW4oJ2FwcHJvdmVkX2J5JywgWydwdXJjaGFzZS1kZWNsaW5lZCcsICdtYW5hZ2VtZW50LWRlY2xpbmVkJ10pOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPndoZW4oYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ01hbmFnZW1lbnQnKSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdhcHByb3ZlZF9ieScsICdtYW5hZ2VtZW50LWRlY2xpbmVkJyk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+d2hlbihhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnQWNjb3VudHMnKSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPmhhcygncmVsUGF5bWVudHMucmVsU3VwcGxpZXJMZWRnZXJzJyk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+d2hlbighZGF0YXRhYmxlT3JkZXJpbmcoKSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyYnkoJ2lkJywgJ2Rlc2MnKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAkZGVjbGluZSA9IHRydWU7CgogICAgICAgICAgICAgaWYgKHJlcXVlc3QoKS0+YWpheCgpKSB7CiAgICAgICAgICAgIHJldHVybiBEYXRhdGFibGVzOjpvZigkc3VwcGxpZXJzKQogICAgICAgICAgICAtPmFkZEluZGV4Q29sdW1uKCkKICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3Byb2R1Y3RfY2F0ZWdvcmllcycsIGZ1bmN0aW9uKCRzdXBwbGllcil7CiAgICAgICAgICAgICAgICByZXR1cm4gQ2F0ZWdvcnk6OndoZXJlSGFzKCdzdWJDYXRlZ29yeScsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRzdXBwbGllcil7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVJbignaWQnLCBDYXRlZ29yeTo6d2hlcmVIYXMoJ3Byb2R1Y3RzJywgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJHN1cHBsaWVyKXsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVJbignaWQnLCAkc3VwcGxpZXItPnByb2R1Y3RzLT5wbHVjaygnaWQnKS0+dG9BcnJheSgpKTsKICAgICAgICAgICAgICAgICAgICB9KS0+cGx1Y2soJ2lkJyktPnRvQXJyYXkoKSk7CiAgICAgICAgICAgICAgICB9KS0+cGx1Y2soJ25hbWUnKS0+aW1wbG9kZSgnLCAnKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3Byb2R1Y3RfY2F0ZWdvcmllcycsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncHJvZHVjdHMuY2F0ZWdvcnkuY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPmZpbHRlckNvbHVtbignY29ycG9yYXRlX2FkZHJlc3MnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ2FkZHJlc3NlcycsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ3JvYWQnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpCiAgICAgICAgICAgICAgICAgICAgLT5vcldoZXJlKCd6aXAnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpCiAgICAgICAgICAgICAgICAgICAgLT5vcldoZXJlKCdjb3VudHJ5JywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKQogICAgICAgICAgICAgICAgICAgIC0+b3JXaGVyZSgnYWRkcmVzcycsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJykKICAgICAgICAgICAgICAgICAgICAtPm9yV2hlcmUoJ3ZpbGxhZ2UnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdjb250YWN0X3BlcnNvbl9uYW1lJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdjb250YWN0UGVyc29ucycsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdjb3Jwb3JhdGVfYWRkcmVzcycsIGZ1bmN0aW9uKCRzdXBwbGllcil7CiAgICAgICAgICAgICAgICAkYWRkcmVzcyA9ICcnOwogICAgICAgICAgICAgICAgJGNvcnBvcmF0ZUFkZHJlc3MgPSBcQXBwXE1vZGVsc1xQbXNNb2RlbHNcU3VwcGxpZXJBZGRyZXNzOjp3aGVyZShbJ3N1cHBsaWVyX2lkJyA9PiAkc3VwcGxpZXItPmlkLCAndHlwZScgPT4gJ2NvcnBvcmF0ZSddKS0+Zmlyc3QoKTsKCiAgICAgICAgICAgICAgICBpZihpc3NldCgkY29ycG9yYXRlQWRkcmVzcy0+aWQpKXsKICAgICAgICAgICAgICAgICAgICAkYWRkcmVzcyAuPSAkY29ycG9yYXRlQWRkcmVzcy0+dmlsbGFnZS4nICcuJGNvcnBvcmF0ZUFkZHJlc3MtPnJvYWQuJywgJy4kY29ycG9yYXRlQWRkcmVzcy0+Y2l0eS4nLScuJGNvcnBvcmF0ZUFkZHJlc3MtPnppcC4nLCAnLiRjb3Jwb3JhdGVBZGRyZXNzLT5jb3VudHJ5IC4nPGJyPicuICRjb3Jwb3JhdGVBZGRyZXNzLT5hZGRkcmVzczsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gICRhZGRyZXNzOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPmFkZENvbHVtbignY29udGFjdF9wZXJzb25fbmFtZScsIGZ1bmN0aW9uKCRzdXBwbGllcil7CiAgICAgICAgICAgICAgICAkY29udGFjdFBlcnNvbiA9ICcnOwoKICAgICAgICAgICAgICAgICRjb250YWN0UGVyc29uU2FsZXMgPSBcQXBwXE1vZGVsc1xQbXNNb2RlbHNcU3VwcGxpZXJDb250YWN0UGVyc29uOjp3aGVyZShbJ3N1cHBsaWVyX2lkJyA9PiBpc3NldCgkc3VwcGxpZXItPmlkKSA/ICRzdXBwbGllci0+aWQgOiAwLCAndHlwZScgPT4gJ3NhbGVzJ10pLT5maXJzdCgpOwoKICAgICAgICAgICAgICAgIGlmKGlzc2V0KCRjb250YWN0UGVyc29uU2FsZXMtPmlkKSl7CiAgICAgICAgICAgICAgICAgICAgJGNvbnRhY3RQZXJzb24gLj0gJGNvbnRhY3RQZXJzb25TYWxlcy0+bmFtZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gICRjb250YWN0UGVyc29uOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPmFkZENvbHVtbignbW9iaWxlX25vJywgZnVuY3Rpb24oJHN1cHBsaWVyKXsKICAgICAgICAgICAgICAgICRjb250YWN0UGVyc29uID0gJyc7CgogICAgICAgICAgICAgICAgJGNvbnRhY3RQZXJzb25TYWxlcyA9IFxBcHBcTW9kZWxzXFBtc01vZGVsc1xTdXBwbGllckNvbnRhY3RQZXJzb246OndoZXJlKFsnc3VwcGxpZXJfaWQnID0+IGlzc2V0KCRzdXBwbGllci0+aWQpID8gJHN1cHBsaWVyLT5pZCA6IDAsICd0eXBlJyA9PiAnc2FsZXMnXSktPmZpcnN0KCk7CgogICAgICAgICAgICAgICAgaWYoaXNzZXQoJGNvbnRhY3RQZXJzb25TYWxlcy0+aWQpKXsKICAgICAgICAgICAgICAgICAgICAkY29udGFjdFBlcnNvbiAuPSAkY29udGFjdFBlcnNvblNhbGVzLT5tb2JpbGU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuICAkY29udGFjdFBlcnNvbjsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdtb2JpbGVfbm8nLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ2NvbnRhY3RQZXJzb25zJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnbW9iaWxlJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPmFkZENvbHVtbignY2xvc2luZ19iYWxhbmNlJywgZnVuY3Rpb24oJHN1cHBsaWVyKXsKICAgICAgICAgICAgICAgIGlmKGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdBY2NvdW50cycpKXsKICAgICAgICAgICAgICAgICAgICAkbGVkZ2VyID0gU3VwcGxpZXJMZWRnZXJzOjp3aGVyZUhhcygncmVsU3VwcGxpZXJQYXltZW50JywgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJHN1cHBsaWVyKXsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ3N1cHBsaWVyX2lkJywgJHN1cHBsaWVyLT5pZCk7CiAgICAgICAgICAgICAgICAgICAgfSktPm9yZGVyQnkoJ2lkJywgJ2Rlc2MnKS0+Zmlyc3QoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNzZXQoJGxlZGdlci0+aWQpID8gJGxlZGdlci0+Y2xvc2luZ19iYWxhbmNlIDogJyc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdhcHByb3ZhbCcsIGZ1bmN0aW9uKCRzdXBwbGllcil7CiAgICAgICAgICAgICAgICAkc3VwcGxpZXJTdGF0dXMgPSBzdXBwbGllclN0YXR1cygkc3VwcGxpZXIpOwogICAgICAgICAgICAgICAgJGFwcHJvdmFscyA9ICcnOwogICAgICAgICAgICAgICAgaWYoIWF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdBY2NvdW50cycpKXsKICAgICAgICAgICAgICAgICAgICBpZiAoJHN1cHBsaWVyU3RhdHVzWydhcHByb3ZhbCddICYmIChhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnUHVyY2hhc2UtRGVwYXJ0bWVudCcpIHx8IGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdNYW5hZ2VtZW50JykpKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGFwcHJvdmFscyAuPSAnPGEgY2xhc3M9ImJ0biBidG4teHMgYnRuLScuJHN1cHBsaWVyU3RhdHVzWydhcHByb3ZlZF9jbGFzcyddIC4nIiBkYXRhLWFwcHJvdmVkLWJ5PSInLiRzdXBwbGllci0+YXBwcm92ZWRfYnkgLiciIGRhdGEtc3RhdHVzPSInLiRzdXBwbGllci0+c3RhdHVzLiciICBkYXRhLXdoaWNoPSJhcHByb3ZhbCIgZGF0YS1zdXBwbGllci1pZD0iJy4kc3VwcGxpZXItPmlkLiciIG9uY2xpY2s9InRvZ2dsZVN1cHBsaWVyU3RhdHVzKCQodGhpcykpIj48aSBjbGFzcz0iJy4gJHN1cHBsaWVyU3RhdHVzWydhcHByb3ZlZF9pY29uJ10gLiciPjwvaT4mbmJzcDsnLiAkc3VwcGxpZXJTdGF0dXNbJ2FwcHJvdmVkX3RleHQnXSAuJzwvYT4nOwogICAgICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgICAgICAkYXBwcm92YWxzIC49ICc8YSBjbGFzcz0iYnRuIGJ0bi14cyBidG4tJy4kc3VwcGxpZXJTdGF0dXNbJ2FwcHJvdmVkX2NsYXNzJ10gLiciIGRhdGEtYXBwcm92ZWQtYnk9IicuJHN1cHBsaWVyLT5hcHByb3ZlZF9ieSAuJyIgZGF0YS1zdGF0dXM9IicuJHN1cHBsaWVyLT5zdGF0dXMuJyIgIGRhdGEtd2hpY2g9ImFwcHJvdmFsIiBkYXRhLXN1cHBsaWVyLWlkPSInLiRzdXBwbGllci0+aWQuJyIgPjxpIGNsYXNzPSInLiAkc3VwcGxpZXJTdGF0dXNbJ2FwcHJvdmVkX2ljb24nXSAuJyI+PC9pPiZuYnNwOycuJHN1cHBsaWVyU3RhdHVzWydhcHByb3ZlZF90ZXh0J10uJzwvYT4nOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiAkYXBwcm92YWxzOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPmVkaXRDb2x1bW4oJ3N0YXR1cycsIGZ1bmN0aW9uKCRzdXBwbGllcil7CiAgICAgICAgICAgICAgICAkc3RhdHVzID0gJyc7CgogICAgICAgICAgICAgICAgaWYoIWF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdBY2NvdW50cycpKXsKICAgICAgICAgICAgICAgICAgICAvLyBpZihhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnTWFuYWdlbWVudCcpICYmICRzdXBwbGllci0+YXBwcm92ZWRfYnkgPT0gIm1hbmFnZW1lbnQtYXBwcm92ZWQiKXsKICAgICAgICAgICAgICAgICAgICBpZigkc3VwcGxpZXItPmFwcHJvdmVkX2J5ID09ICJtYW5hZ2VtZW50LWFwcHJvdmVkIil7CiAgICAgICAgICAgICAgICAgICAgICAgICRzdGF0dXMgLj0gJzxhIGNsYXNzPSJidG4gYnRuLScuKCRzdXBwbGllci0+c3RhdHVzID09ICJBY3RpdmUiID8gInN1Y2Nlc3MiIDogImRhbmdlciIpLicgYnRuLWJsb2NrIGJ0bi14cyIgZGF0YS1hcHByb3ZlZC1ieT0iJy4gJHN1cHBsaWVyLT5hcHByb3ZlZF9ieSAuJyIgZGF0YS1zdGF0dXM9IicuICRzdXBwbGllci0+c3RhdHVzIC4nIiBkYXRhLXdoaWNoPSJzdGF0dXMiIGRhdGEtc3VwcGxpZXItaWQ9IicuICRzdXBwbGllci0+aWQgLiciIG9uY2xpY2s9InRvZ2dsZVN1cHBsaWVyU3RhdHVzKCQodGhpcykpIiA+PGkgY2xhc3M9IicuICgkc3VwcGxpZXItPnN0YXR1cyA9PSAiQWN0aXZlIiA/ICJsYXIgbGEtY2hlY2stY2lyY2xlIiA6ICJsYSBsYS1iYW4iKS4nIj48L2k+Jm5ic3A7Jy4gKCRzdXBwbGllci0+c3RhdHVzID09ICJBY3RpdmUiID8gIkFjdGl2ZSIgOiAiUGVuZGluZyIgKS4nPC9hPic7CiAgICAgICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgICAgICRzdGF0dXMgLj0gJzxhIGNsYXNzPSJidG4gYnRuLScuICgkc3VwcGxpZXItPnN0YXR1cyA9PSAiQWN0aXZlIiA/ICJzdWNjZXNzIiA6ICJkYW5nZXIiICkuJyBidG4tYmxvY2sgYnRuLXhzIiBkYXRhLWFwcHJvdmVkLWJ5PSInLiAkc3VwcGxpZXItPmFwcHJvdmVkX2J5IC4nIiBkYXRhLXN0YXR1cz0iJy4gJHN1cHBsaWVyLT5zdGF0dXMgLiciIGRhdGEtd2hpY2g9InN0YXR1cyIgZGF0YS1zdXBwbGllci1pZD0iJy4gJHN1cHBsaWVyLT5pZCAuJyIgb25jbGljaz0idG9nZ2xlU3VwcGxpZXJTdGF0dXMoJCh0aGlzKSkiID48aSBjbGFzcz0iJy4gKCRzdXBwbGllci0+c3RhdHVzID09ICJBY3RpdmUiID8gImxhciBsYS1jaGVjay1jaXJjbGUiIDogImxhIGxhLWJhbiIgKS4nIj48L2k+Jm5ic3A7Jy4gKCRzdXBwbGllci0+c3RhdHVzID09ICJBY3RpdmUiID8gIkFjdGl2ZSIgOiAiUGVuZGluZyIpIC4nPC9hPic7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuICRzdGF0dXM7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdhY3Rpb25zJywgZnVuY3Rpb24oJHN1cHBsaWVyKXsKICAgICAgICAgICAgICAgICRhY3Rpb25zID0gJyc7CgogICAgICAgICAgICAgICAgaWYoIWF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdBY2NvdW50cycpKXsKCiAgICAgICAgICAgICAgICAgICAgaWYoYXV0aCgpLT51c2VyKCktPmhhc1Blcm1pc3Npb25Ubygnc3VwcGxpZXItZWRpdCcpKXsKICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxhIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi1zdWNjZXNzIHJvdW5kZWQtY2lyY2xlIG1sLTIiIGhyZWY9Iicucm91dGUoJ3Btcy5zdXBwbGllci5lZGl0JywgJHN1cHBsaWVyLT5pZCkuJyI+PGkgY2xhc3M9ImxhIGxhLWVkaXQiPjwvaT48L2E+JzsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49JyA8YSBocmVmPSInLiByb3V0ZSgncG1zLnN1cHBsaWVyLnByb2ZpbGUnLCAkc3VwcGxpZXItPmlkKSAuJyIgY2xhc3M9ImJ0biBidG4taW5mbyBtbC0yIGJ0bi14cyI+PGkgY2xhc3M9ImxhcyBsYS11c2VyIj48L2k+PC9hPic7CgogICAgICAgICAgICAgICAgICAgIGlmKCRzdXBwbGllci0+ZGVsZXRhYmxlID09ICd5ZXMnKXsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoYXV0aCgpLT51c2VyKCktPmhhc1Blcm1pc3Npb25Ubygnc3VwcGxpZXItZGVsZXRlJykpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgY2xhc3M9ImJ0biBidG4teHMgYnRuLWRhbmdlciBtbC0yIiBkYXRhLXNyYz0iJy5yb3V0ZSgncG1zLnN1cHBsaWVyLmRlc3Ryb3knLCAkc3VwcGxpZXItPmlkKS4nIiBvbmNsaWNrPSJkZWxldGVGcm9tQ1JVRCgkKHRoaXMpKSI+PGkgY2xhc3M9ImxhIGxhLXRyYXNoIj48L2k+PC9hPic7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuICRhY3Rpb25zOwoKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT5yYXdDb2x1bW5zKFsnY29ycG9yYXRlX2FkZHJlc3MnLCdwcm9kdWN0X2NhdGVnb3JpZXMnLCdhcHByb3ZhbCcsJ3N0YXR1cycsICdhY3Rpb25zJ10pCiAgICAgICAgICAgIC0+bWFrZSh0cnVlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnN1cHBsaWVycy5pbmRleCcsIFsKICAgICAgICAgICAgJ3RpdGxlJyA9PiR0aXRsZSwKICAgICAgICAgICAgJ2RlY2xpbmUnID0+JGRlY2xpbmUsCiAgICAgICAgICAgICdoZWFkZXJDb2x1bW5zJyA9PiAkdGhpcy0+aGVhZGVyQ29sdW1ucygpCiAgICAgICAgXSk7CgogICAgICAgIH1jYXRjaCAoXFRocm93YWJsZSAkdGgpewogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFNob3cgdGhlIGZvcm0gZm9yIGNyZWF0aW5nIGEgbmV3IHJlc291cmNlLgogICAgICoKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCiAgICBwdWJsaWMgZnVuY3Rpb24gY3JlYXRlKCkKICAgIHsKICAgICAgICB0cnkgewogICAgICAgICAgICAkZGF0YSA9IFsKICAgICAgICAgICAgICAgICd0aXRsZScgPT4gJ0NyZWF0ZSBOZXcgU3VwcGxpZXInLAogICAgICAgICAgICAgICAgJ2N1cnJlbmNpZXMnID0+IEN1cnJlbmN5OjphbGwoKSwKICAgICAgICAgICAgICAgICdwYXltZW50VGVybXMnID0+IFBheW1lbnRUZXJtOjpvcmRlckJ5KCdpZCcsJ0RFU0MnKS0+Z2V0KCksCiAgICAgICAgICAgICAgICAnc3ViQ2F0ZWdvcmllcycgPT4gQ2F0ZWdvcnk6OmhhcygnY2F0ZWdvcnknKQogICAgICAgICAgICAgICAgLT53aGVyZUhhcygnZGVwYXJ0bWVudHNMaXN0LmRlcGFydG1lbnQnLCBmdW5jdGlvbigkcXVlcnkpewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSW4oJ2hyX2RlcGFydG1lbnRfaWQnLCBhdXRoKCktPnVzZXIoKS0+cHJpb3JpdGllcy0+cGx1Y2soJ2hyX2RlcGFydG1lbnRfaWQnKS0+dG9BcnJheSgpKQogICAgICAgICAgICAgICAgICAgIC0+d2hlcmVJbignaHJfdW5pdF9pZCcsIGF1dGgoKS0+dXNlcigpLT5wcmlvcml0aWVzLT5wbHVjaygnaHJfdW5pdF9pZCcpLT50b0FycmF5KCkpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+b3JkZXJCeSgnbmFtZScsICdhc2MnKQogICAgICAgICAgICAgICAgLT5nZXQoKQogICAgICAgICAgICBdOwoKICAgICAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnN1cHBsaWVycy5jcmVhdGUnLCAkZGF0YSk7CiAgICAgICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogU3RvcmUgYSBuZXdseSBjcmVhdGVkIHJlc291cmNlIGluIHN0b3JhZ2UuCiAgICAgKgogICAgICogQHBhcmFtICBcSWxsdW1pbmF0ZVxIdHRwXFJlcXVlc3QgICRyZXF1ZXN0CiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwogICAgcHVibGljIGZ1bmN0aW9uIHN0b3JlKFJlcXVlc3QgJHJlcXVlc3QpCiAgICB7CiAgICAgICAgJHRoaXMtPnZhbGlkYXRlKCRyZXF1ZXN0LCBbCiAgICAgICAgICAgICduYW1lJyA9PiBbJ3JlcXVpcmVkJywgJ3N0cmluZycsICdtYXg6MjU1J10sCiAgICAgICAgICAgICdlbWFpbCcgPT4gWydudWxsYWJsZScsICdzdHJpbmcnLCAnbWF4OjI1NScsICdlbWFpbCddLAogICAgICAgICAgICAncGhvbmUnID0+IFsnbnVsbGFibGUnLCAnc3RyaW5nJywgJ21heDoxNCcsICdyZWdleDovXihbMC05XHNcLVwrXChcKV0qKSQvJ10sCiAgICAgICAgICAgICdtb2JpbGVfbm8nID0+IFsnbnVsbGFibGUnLCAnc3RyaW5nJywgJ21heDoxNCcsICdyZWdleDovXihbMC05XHNcLVwrXChcKV0qKSQvJ10sCiAgICAgICAgICAgICd0ZXJtX2NvbmRpdGlvbicgPT4gWydudWxsYWJsZSddLAogICAgICAgICAgICAncGF5bWVudF90ZXJtX2lkJyA9PiBbJ2FycmF5JywnbWluOjEnXSwKCiAgICAgICAgICAgICd0cmFkZScgPT4gWydyZXF1aXJlZCcsICdzdHJpbmcnLCAnbWF4OjI1NSddLAogICAgICAgICAgICAndGluJyA9PiBbJ251bGxhYmxlJywgJ3N0cmluZycsICdtYXg6MjU1J10sCiAgICAgICAgICAgICd2YXQnID0+IFsnbnVsbGFibGUnLCAnc3RyaW5nJywgJ21heDoyNTUnXSwKICAgICAgICAgICAgJ293bmVyX25hbWUnID0+IFsnbnVsbGFibGUnLCAnc3RyaW5nJywgJ21heDoyNTUnXSwKICAgICAgICAgICAgJ293bmVyX25pZCcgPT4gWydudWxsYWJsZScsICdzdHJpbmcnLCAnbWF4OjI1NSddLAogICAgICAgICAgICAnb3duZXJfY29udGFjdF9ubycgPT4gWydudWxsYWJsZScsICdzdHJpbmcnLCAnbWF4OjI1NSddLAogICAgICAgICAgICAnY3VycmVuY2llcycgPT4gJ3JlcXVpcmVkJywKICAgICAgICAgICAgJ2N1cnJlbmNpZXMuKicgPT4gJ3JlcXVpcmVkJywKICAgICAgICAgICAgJ2NvZGUnID0+IFsnbnVsbGFibGUnLCAnc3RyaW5nJywgJ21heDoyNTUnLCAndW5pcXVlOnN1cHBsaWVycyxjb2RlJ10sCiAgICAgICAgXSk7CgogICAgICAgIGlmKCRyZXF1ZXN0LT5oYXNGaWxlKCdhdXRoX3BlcnNvbl9sZXR0ZXJfZmlsZScpKXsKICAgICAgICAgICAgJHRoaXMtPnZhbGlkYXRlKCRyZXF1ZXN0LCBbCiAgICAgICAgICAgICAgICAnYXV0aF9wZXJzb25fbGV0dGVyX2ZpbGUnID0+IFsnbWltZXM6cGRmLHBuZycsICdtYXg6MjA0OCddLAogICAgICAgICAgICBdKTsKICAgICAgICB9CgogICAgICAgIGlmKCRyZXF1ZXN0LT5oYXNGaWxlKCdvd25lcl9waG90b19maWxlJykpewogICAgICAgICAgICAkdGhpcy0+dmFsaWRhdGUoJHJlcXVlc3QsIFsKICAgICAgICAgICAgICAgICdvd25lcl9waG90b19maWxlJyA9PiBbJ21pbWVzOmpwZWcsanBnLHBuZyxnaWYnLCAnbWF4OjMwNzInXSwKICAgICAgICAgICAgXSk7CiAgICAgICAgfQoKICAgICAgICBEQjo6YmVnaW5UcmFuc2FjdGlvbigpOwogICAgICAgIHRyeSB7CgogICAgICAgICAgICAkdGVybVBlcmNlbnRhZ2VzID0gW107CiAgICAgICAgICAgIGlmKGlzc2V0KCRyZXF1ZXN0LT5wYXltZW50X3Rlcm1faWRbMF0pKXsKICAgICAgICAgICAgICAgIGZvcmVhY2goJHJlcXVlc3QtPnBheW1lbnRfdGVybV9pZCBhcyAka2V5ID0+ICRwYXltZW50X3Rlcm1faWQpewogICAgICAgICAgICAgICAgICAgIGlmKCFpc3NldCgkdGVybVBlcmNlbnRhZ2VzWyRwYXltZW50X3Rlcm1faWRdKSl7CiAgICAgICAgICAgICAgICAgICAgICAgICR0ZXJtUGVyY2VudGFnZXNbJHBheW1lbnRfdGVybV9pZF0gPSAwOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAkdGVybVBlcmNlbnRhZ2VzWyRwYXltZW50X3Rlcm1faWRdICs9ICRyZXF1ZXN0LT5wYXltZW50X3BlcmNlbnRbJGtleV07CgogICAgICAgICAgICAgICAgICAgIGlmKCR0ZXJtUGVyY2VudGFnZXNbJHBheW1lbnRfdGVybV9pZF0gPiAxMDApewogICAgICAgICAgICAgICAgICAgICAgICAkcGF5bWVudFRlcm0gPSBQYXltZW50VGVybTo6ZmluZCgkcGF5bWVudF90ZXJtX2lkKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnID0+IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ21lc3NhZ2UnID0+ICdQYXltZW50IFRlcm0gIycuJHBheW1lbnRUZXJtLT50ZXJtLicgdG90YWwgcGVyY2VudGFnZXMgaGF2ZSBiZWVuIGV4Y2VlZGVkIHRvICcuJHRlcm1QZXJjZW50YWdlc1skcGF5bWVudF90ZXJtX2lkXS4nJSEnLAogICAgICAgICAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICRpbnB1dHMgPSAkcmVxdWVzdC0+YWxsKCk7CgogICAgICAgICAgICAkc3VwcGxpZXIgPSBTdXBwbGllcnM6OmNyZWF0ZSgkaW5wdXRzKTsKICAgICAgICAgICAgaWYgKGVtcHR5KCRzdXBwbGllci0+Y29kZSkpIHsKICAgICAgICAgICAgICAgICRzdXBwbGllci0+Y29kZSA9ICR0aGlzLT5zdXBwbGllckNvZGUoJHN1cHBsaWVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAkc3VwcGxpZXItPnN0YXR1cyA9ICdJbmFjdGl2ZSc7CiAgICAgICAgICAgIC8vJHN1cHBsaWVyLT5jb2RlID0gJHRoaXMtPnN1cHBsaWVyQ29kZSgkc3VwcGxpZXIpOwogICAgICAgICAgICAkc3VwcGxpZXItPnNhdmUoKTsKCiAgICAgICAgICAgICRzdXBwbGllci0+cHJvZHVjdHMoKS0+c3luYyhQcm9kdWN0Ojp3aGVyZUluKCdjYXRlZ29yeV9pZCcsIGlzc2V0KCRyZXF1ZXN0LT5zdWJfY2F0ZWdvcmllc1swXSkgPyAkcmVxdWVzdC0+c3ViX2NhdGVnb3JpZXMgOiBbXSktPnBsdWNrKCdpZCcpLT50b0FycmF5KCkpOwogICAgICAgICAgICAkc3VwcGxpZXItPmN1cnJlbmNpZXMoKS0+c3luYygkcmVxdWVzdC0+Y3VycmVuY2llcyk7CgogICAgICAgICAgICBpZiAoaXNzZXQoJHJlcXVlc3QtPnBheW1lbnRfdGVybV9pZFswXSkpIHsKICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRyZXF1ZXN0LT5wYXltZW50X3Rlcm1faWQgYXMgJGtleSA9PiAkcGF5bWVudF90ZXJtX2lkKXsKICAgICAgICAgICAgICAgICAgICAkcGFyZW50ID0gU3VwcGxpZXJQYXltZW50VGVybTo6d2hlcmUoWwogICAgICAgICAgICAgICAgICAgICAgICAnc3VwcGxpZXJfaWQnID0+ICRzdXBwbGllci0+aWQsCiAgICAgICAgICAgICAgICAgICAgICAgICdwYXltZW50X3Rlcm1faWQnID0+ICRwYXltZW50X3Rlcm1faWQKICAgICAgICAgICAgICAgICAgICBdKS0+Zmlyc3QoKTsKCiAgICAgICAgICAgICAgICAgICAgU3VwcGxpZXJQYXltZW50VGVybTo6Y3JlYXRlKFsKICAgICAgICAgICAgICAgICAgICAgICAgJ3N1cHBsaWVyX2lkJyA9PiAkc3VwcGxpZXItPmlkLAogICAgICAgICAgICAgICAgICAgICAgICAncGF5bWVudF90ZXJtX2lkJyA9PiAkcGF5bWVudF90ZXJtX2lkLAogICAgICAgICAgICAgICAgICAgICAgICAncGF5bWVudF9wZXJjZW50JyA9PiAkcmVxdWVzdC0+cGF5bWVudF9wZXJjZW50WyRrZXldLAogICAgICAgICAgICAgICAgICAgICAgICAnZGF5X2R1cmF0aW9uJyA9PiAkcmVxdWVzdC0+ZGF5X2R1cmF0aW9uWyRrZXldLAogICAgICAgICAgICAgICAgICAgICAgICAndHlwZScgPT4gJHJlcXVlc3QtPnR5cGVbJGtleV0sCiAgICAgICAgICAgICAgICAgICAgICAgICdwYXJlbnRfaWQnID0+IGlzc2V0KCRwYXJlbnQtPmlkKSA/ICRwYXJlbnQtPmlkIDogMCwKICAgICAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYoJHJlcXVlc3QtPmhhc0ZpbGUoJ2F1dGhfcGVyc29uX2xldHRlcl9maWxlJykpewogICAgICAgICAgICAgICAgJHN1cHBsaWVyLT5hdXRoX3BlcnNvbl9sZXR0ZXIgPSAkdGhpcy0+ZmlsZVVwbG9hZCgkcmVxdWVzdC0+ZmlsZSgnYXV0aF9wZXJzb25fbGV0dGVyX2ZpbGUnKSwgJ3VwbG9hZC9zdXBwbGllci1hdXRob3JpemF0aW9uLWxldHRlcicpOwogICAgICAgICAgICAgICAgJHN1cHBsaWVyLT5zYXZlKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmKCRyZXF1ZXN0LT5oYXNGaWxlKCdvd25lcl9waG90b19maWxlJykpewogICAgICAgICAgICAgICAgJHN1cHBsaWVyLT5vd25lcl9waG90byA9ICR0aGlzLT5maWxlVXBsb2FkKCRyZXF1ZXN0LT5maWxlKCdvd25lcl9waG90b19maWxlJyksICd1cGxvYWQvc3VwcGxpZXItb3duZXItcGhvdG8nLCB0cnVlKTsKICAgICAgICAgICAgICAgICRzdXBwbGllci0+c2F2ZSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAkbWVzc2FnZSA9ICc8c3BhbiBjbGFzcz0ibm90aWZpY2F0aW9uLWxpbmtzIiBkYXRhLXNyYz0iJy5yb3V0ZSgncG1zLnN1cHBsaWVyLnByb2ZpbGUnLCRzdXBwbGllci0+aWQpLic/dmlldyIgZGF0YS10aXRsZT0iU3VwcGxpZXJzIERldGFpbHMiPlN1cHBsaWVyOicuJHN1cHBsaWVyLT5uYW1lLicuV2F0dGluZyBmb3IgQXBwcm92YWwuPC9zcGFuPic7CgogICAgICAgICAgICBDcmVhdGVPclVwZGF0ZU5vdGlmaWNhdGlvbigkbWVzc2FnZSwndW5yZWFkJywnJyxnZXRNYW5hZ2VySW5mbygnUHVyY2hhc2UtRGVwYXJ0bWVudCcsIG51bGwsIHRydWUpLCdzZW5kLXRvLXB1cmNoYXNlJyk7CgogICAgICAgICAgICBEQjo6Y29tbWl0KCk7CgogICAgICAgICAgICAkbm90aWZpY2F0aW9uID0gWwogICAgICAgICAgICAgICAgJ21lc3NhZ2UnID0+ICdBIHN1cHBsaWVyIGhhcyBiZWVuIGNyZWF0ZWQgc3VjY2Vzc2Z1bGx5JywKICAgICAgICAgICAgICAgICdhbGVydC10eXBlJyA9PiAnc3VjY2VzcycKICAgICAgICAgICAgXTsKCiAgICAgICAgICAgIHNlc3Npb24oKS0+Zmxhc2goJ21lc3NhZ2UnLCAiQSBzdXBwbGllciBoYXMgYmVlbiBjcmVhdGVkIHN1Y2Nlc3NmdWxseSIpOwogICAgICAgICAgICBzZXNzaW9uKCktPmZsYXNoKCdhbGVydC10eXBlJywgInN1Y2Nlc3MiKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnID0+IHRydWUsCiAgICAgICAgICAgICAgICAndXJsJyA9PiB1cmwoJ3Btcy9zdXBwbGllci8nLiRzdXBwbGllci0+aWQuJy9lZGl0JykKICAgICAgICAgICAgXSk7CiAgICAgICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgIERCOjpyb2xsYmFjaygpOwogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gZmFsc2UsCiAgICAgICAgICAgICAgICAnbWVzc2FnZScgPT4gJHRoLT5nZXRNZXNzYWdlKCkKICAgICAgICAgICAgXSk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogRGlzcGxheSB0aGUgc3BlY2lmaWVkIHJlc291cmNlLgogICAgICoKICAgICAqIEBwYXJhbSAgaW50ICAkaWQKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCiAgICBwdWJsaWMgZnVuY3Rpb24gc2hvdyhTdXBwbGllcnMgJHN1cHBsaWVyKQogICAgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgICRzdXBwbGllci0+c3JjID0gcm91dGUoJ3Btcy5zdXBwbGllci51cGRhdGUnLCRzdXBwbGllci0+aWQpOwogICAgICAgICAgICAkc3VwcGxpZXItPnJlcV90eXBlID0gJ3B1dCc7CiAgICAgICAgICAgICRkYXRhID0gWwogICAgICAgICAgICAgICAgJ3N0YXR1cycgPT4gJ3N1Y2Nlc3MnLAogICAgICAgICAgICAgICAgJ2luZm8nID0+ICRzdXBwbGllcgogICAgICAgICAgICBdOwoKICAgICAgICAgICAgLy9yZXR1cm4gJHN1cHBsaWVyOwogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbigkZGF0YSk7CiAgICAgICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgICRkYXRhID0gWwogICAgICAgICAgICAgICAgJ3N0YXR1cycgPT4gbnVsbCwKICAgICAgICAgICAgICAgICdpbmZvJyA9PiAkdGgtPmdldE1lc3NhZ2UoKQogICAgICAgICAgICBdOwogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbigkZGF0YSk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogU2hvdyB0aGUgZm9ybSBmb3IgZWRpdGluZyB0aGUgc3BlY2lmaWVkIHJlc291cmNlLgogICAgICoKICAgICAqIEBwYXJhbSAgaW50ICAkaWQKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCiAgICBwdWJsaWMgZnVuY3Rpb24gZWRpdCgkaWQpCiAgICB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgJHN1cHBsaWVyID0gU3VwcGxpZXJzOjp3aXRoKFsKICAgICAgICAgICAgICAgICdwcm9kdWN0cycsCiAgICAgICAgICAgICAgICAncmVsUXVvdGF0aW9ucycsCiAgICAgICAgICAgICAgICAncmVsUGF5bWVudFRlcm1zJywKICAgICAgICAgICAgICAgICdwYXlhYmxlQWNjb3VudCcsCiAgICAgICAgICAgICAgICAncGF5YWJsZVB1cmNoYXNlQWNjb3VudCcsCiAgICAgICAgICAgICAgICAncGF5YWJsZURpc2NvdW50QWNjb3VudCcsCiAgICAgICAgICAgICAgICAnYWR2YW5jZUFjY291bnQnLAogICAgICAgICAgICAgICAgJ2N1cnJlbmNpZXMnLAogICAgICAgICAgICAgICAgJ3N1cHBsZWllckN1cnJlbmNpZXMnCiAgICAgICAgICAgIF0pLT5maW5kT3JGYWlsKCRpZCk7CiAgICAgICAgICAgICRkYXRhID0gWwogICAgICAgICAgICAgICAgJ3RpdGxlJyA9PiAnVXBkYXRlIFN1cHBsaWVyIEluZm9ybWF0aW9uJywKICAgICAgICAgICAgICAgICdjdXJyZW5jaWVzJyA9PiBDdXJyZW5jeTo6YWxsKCksCiAgICAgICAgICAgICAgICAncGF5bWVudFRlcm1zJyA9PiBQYXltZW50VGVybTo6b3JkZXJCeSgnaWQnLCdERVNDJyktPnNlbGVjdCgnaWQnLCd0ZXJtJyktPmdldCgpLAogICAgICAgICAgICAgICAgJ3N1cHBsaWVyJyA9PiAkc3VwcGxpZXIsCiAgICAgICAgICAgICAgICAnY29ycG9yYXRlQWRkcmVzcycgPT4gU3VwcGxpZXJBZGRyZXNzOjp3aGVyZShbJ3N1cHBsaWVyX2lkJyA9PiAkaWQsICd0eXBlJyA9PiAnY29ycG9yYXRlJ10pLT5maXJzdCgpLAogICAgICAgICAgICAgICAgJ2ZhY3RvcnlBZGRyZXNzJyA9PiBTdXBwbGllckFkZHJlc3M6OndoZXJlKFsnc3VwcGxpZXJfaWQnID0+ICRpZCwgJ3R5cGUnID0+ICdmYWN0b3J5J10pLT5maXJzdCgpLAogICAgICAgICAgICAgICAgJ2NvbnRhY3RQZXJzb25TYWxlcycgPT4gU3VwcGxpZXJDb250YWN0UGVyc29uOjp3aGVyZShbJ3N1cHBsaWVyX2lkJyA9PiAkaWQsICd0eXBlJyA9PiAnc2FsZXMnXSktPmZpcnN0KCksCiAgICAgICAgICAgICAgICAnY29udGFjdFBlcnNvbkFmdGVyU2FsZXMnID0+IFN1cHBsaWVyQ29udGFjdFBlcnNvbjo6d2hlcmUoWydzdXBwbGllcl9pZCcgPT4gJGlkLCAndHlwZScgPT4gJ2FmdGVyLXNhbGVzJ10pLT5maXJzdCgpLAogICAgICAgICAgICAgICAgJ2JhbmtBY2NvdW50JyA9PiBTdXBwbGllckJhbmtBY2NvdW50Ojp3aGVyZShbJ3N1cHBsaWVyX2lkJyA9PiAkaWRdKS0+Zmlyc3QoKSwKICAgICAgICAgICAgICAgICdzdWJDYXRlZ29yaWVzJyA9PiBDYXRlZ29yeTo6aGFzKCdjYXRlZ29yeScpCiAgICAgICAgICAgICAgICAtPndoZXJlSGFzKCdkZXBhcnRtZW50c0xpc3QuZGVwYXJ0bWVudCcsIGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVJbignaHJfZGVwYXJ0bWVudF9pZCcsIGF1dGgoKS0+dXNlcigpLT5wcmlvcml0aWVzLT5wbHVjaygnaHJfZGVwYXJ0bWVudF9pZCcpLT50b0FycmF5KCkpCiAgICAgICAgICAgICAgICAgICAgLT53aGVyZUluKCdocl91bml0X2lkJywgYXV0aCgpLT51c2VyKCktPnByaW9yaXRpZXMtPnBsdWNrKCdocl91bml0X2lkJyktPnRvQXJyYXkoKSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5vcmRlckJ5KCduYW1lJywgJ2FzYycpCiAgICAgICAgICAgICAgICAtPmdldCgpLAogICAgICAgICAgICAgICAgJ3NlbGVjdGVkU3ViQ2F0ZWdvcmllcycgPT4gQ2F0ZWdvcnk6OndoZXJlSGFzKCdwcm9kdWN0cycsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRzdXBwbGllcil7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVJbignaWQnLCBcREI6OnRhYmxlKCdwcm9kdWN0c19zdXBwbGllcicpLT53aGVyZSgnc3VwcGxpZXJfaWQnLCAkc3VwcGxpZXItPmlkKS0+cGx1Y2soJ3Byb2R1Y3RfaWQnKS0+dG9BcnJheSgpKTsKICAgICAgICAgICAgICAgIH0pLT5vcmRlckJ5KCduYW1lJywgJ2FzYycpLT5wbHVjaygnaWQnKS0+dG9BcnJheSgpLAogICAgICAgICAgICAgICAgJ3Byb2R1Y3RzJyA9PiBQcm9kdWN0Ojp3aXRoKFsKICAgICAgICAgICAgICAgICAgICAncHJvZHVjdFVuaXQnLAogICAgICAgICAgICAgICAgICAgICdjYXRlZ29yeS5jYXRlZ29yeScsCiAgICAgICAgICAgICAgICAgICAgJ2F0dHJpYnV0ZXMuYXR0cmlidXRlT3B0aW9uLmF0dHJpYnV0ZScsCiAgICAgICAgICAgICAgICBdKS0+d2hlcmVJbignaWQnLCAkc3VwcGxpZXItPnByb2R1Y3RzLT5wbHVjaygnaWQnKS0+dG9BcnJheSgpKS0+Z2V0KCksCiAgICAgICAgICAgICAgICAnZnJlZXplU3VwcGxpZXInID0+IGZyZWV6ZVN1cHBsaWVyKCRzdXBwbGllciksCiAgICAgICAgICAgICAgICAnYWNjb3VudERlZmF1bHRTZXR0aW5ncycgPT4gYWNjb3VudERlZmF1bHRTZXR0aW5ncygnanNvbicpCiAgICAgICAgICAgIF07CiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5zdXBwbGllcnMuZWRpdCcsICRkYXRhKTsKICAgICAgICB9Y2F0Y2ggKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBVcGRhdGUgdGhlIHNwZWNpZmllZCByZXNvdXJjZSBpbiBzdG9yYWdlLgogICAgICoKICAgICAqIEBwYXJhbSAgXElsbHVtaW5hdGVcSHR0cFxSZXF1ZXN0ICAkcmVxdWVzdAogICAgICogQHBhcmFtICBpbnQgICRpZAogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KICAgIHB1YmxpYyBmdW5jdGlvbiB1cGRhdGUoUmVxdWVzdCAkcmVxdWVzdCwgU3VwcGxpZXJzICRzdXBwbGllcikKICAgIHsKICAgICAgICBpZihyZXF1ZXN0KCktPmhhcygnZm9ybS10eXBlJykgJiYgcmVxdWVzdCgpLT5nZXQoJ2Zvcm0tdHlwZScpID09ICJiYXNpYyIpewogICAgICAgICAgICBpZighZnJlZXplU3VwcGxpZXIoJHN1cHBsaWVyKSl7CiAgICAgICAgICAgICAgICAkcmVxdWVzdC0+dmFsaWRhdGUoWwogICAgICAgICAgICAgICAgICAgICduYW1lJyA9PiBbJ3JlcXVpcmVkJywgJ3N0cmluZycsICdtYXg6MjU1J10sCiAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgJHJlcXVlc3QtPnZhbGlkYXRlKFsKICAgICAgICAgICAgICAgICdlbWFpbCcgPT4gWydudWxsYWJsZScsICdzdHJpbmcnLCAnbWF4OjI1NScsICdlbWFpbCddLAogICAgICAgICAgICAgICAgJ3Bob25lJyA9PiBbJ251bGxhYmxlJywgJ3N0cmluZycsICdtYXg6MTQnLCAncmVnZXg6L14oWzAtOVxzXC1cK1woXCldKikkLyddLAogICAgICAgICAgICAgICAgJ21vYmlsZV9ubycgPT4gWydudWxsYWJsZScsICdzdHJpbmcnLCAnbWF4OjE0JywgJ3JlZ2V4Oi9eKFswLTlcc1wtXCtcKFwpXSopJC8nXSwKICAgICAgICAgICAgICAgICd0ZXJtX2NvbmRpdGlvbicgPT4gWydudWxsYWJsZSddLAogICAgICAgICAgICAgICAgJ3BheW1lbnRfdGVybV9pZCcgPT4gWydhcnJheScsJ21pbjoxJ10sCgogICAgICAgICAgICAgICAgJ3RyYWRlJyA9PiBbJ3JlcXVpcmVkJywgJ3N0cmluZycsICdtYXg6MjU1J10sCiAgICAgICAgICAgICAgICAndGluJyA9PiBbJ251bGxhYmxlJywgJ3N0cmluZycsICdtYXg6MjU1J10sCiAgICAgICAgICAgICAgICAndmF0JyA9PiBbJ251bGxhYmxlJywgJ3N0cmluZycsICdtYXg6MjU1J10sCiAgICAgICAgICAgICAgICAnb3duZXJfbmFtZScgPT4gWydudWxsYWJsZScsICdzdHJpbmcnLCAnbWF4OjI1NSddLAogICAgICAgICAgICAgICAgJ293bmVyX25pZCcgPT4gWydudWxsYWJsZScsICdzdHJpbmcnLCAnbWF4OjI1NSddLAogICAgICAgICAgICAgICAgJ293bmVyX2NvbnRhY3Rfbm8nID0+IFsnbnVsbGFibGUnLCAnc3RyaW5nJywgJ21heDoyNTUnXSwKICAgICAgICAgICAgICAgICdjdXJyZW5jaWVzJyA9PiBbJ3JlcXVpcmVkJ10sCiAgICAgICAgICAgICAgICAnY3VycmVuY2llcy4qJyA9PiBbJ3JlcXVpcmVkJ10sCiAgICAgICAgICAgICAgICAnY29kZScgPT4gWydudWxsYWJsZScsICdzdHJpbmcnLCAnbWF4OjI1NScsICd1bmlxdWU6c3VwcGxpZXJzLGNvZGUnXSwKICAgICAgICAgICAgXSk7CgogICAgICAgICAgICBpZigkcmVxdWVzdC0+aGFzRmlsZSgnYXV0aF9wZXJzb25fbGV0dGVyX2ZpbGUnKSl7CiAgICAgICAgICAgICAgICAkcmVxdWVzdC0+dmFsaWRhdGUoWwogICAgICAgICAgICAgICAgICAgICdhdXRoX3BlcnNvbl9sZXR0ZXJfZmlsZScgPT4gWydtaW1lczpwZGYscG5nJywgJ21heDoyMDQ4J10sCiAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYoJHJlcXVlc3QtPmhhc0ZpbGUoJ293bmVyX3Bob3RvX2ZpbGUnKSl7CiAgICAgICAgICAgICAgICAkcmVxdWVzdC0+dmFsaWRhdGUoWwogICAgICAgICAgICAgICAgICAgICdvd25lcl9waG90b19maWxlJyA9PiBbJ21pbWVzOmpwZWcsanBnLHBuZyxnaWYnLCAnbWF4OjMwNzInXSwKICAgICAgICAgICAgICAgIF0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBEQjo6YmVnaW5UcmFuc2FjdGlvbigpOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgJHRlcm1QZXJjZW50YWdlcyA9IFtdOwogICAgICAgICAgICAgICAgaWYoaXNzZXQoJHJlcXVlc3QtPm9sZF9wYXltZW50X3Rlcm1faWQpICYmIGlzX2FycmF5KCRyZXF1ZXN0LT5vbGRfcGF5bWVudF90ZXJtX2lkKSAmJiBjb3VudCgkcmVxdWVzdC0+b2xkX3BheW1lbnRfdGVybV9pZCkpewogICAgICAgICAgICAgICAgICAgIGZvcmVhY2goJHJlcXVlc3QtPm9sZF9wYXltZW50X3Rlcm1faWQgYXMgJGtleSA9PiAkcGF5bWVudF90ZXJtX2lkKXsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoIWlzc2V0KCR0ZXJtUGVyY2VudGFnZXNbJHBheW1lbnRfdGVybV9pZF0pKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICR0ZXJtUGVyY2VudGFnZXNbJHBheW1lbnRfdGVybV9pZF0gPSAwOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICR0ZXJtUGVyY2VudGFnZXNbJHBheW1lbnRfdGVybV9pZF0gKz0gJHJlcXVlc3QtPm9sZF9wYXltZW50X3BlcmNlbnRbJGtleV07CgogICAgICAgICAgICAgICAgICAgICAgICBpZigkdGVybVBlcmNlbnRhZ2VzWyRwYXltZW50X3Rlcm1faWRdID4gMTAwKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRwYXltZW50VGVybSA9IFBheW1lbnRUZXJtOjpmaW5kKCRwYXltZW50X3Rlcm1faWQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbWVzc2FnZScgPT4gJ1BheW1lbnQgVGVybSAjJy4kcGF5bWVudFRlcm0tPnRlcm0uJyB0b3RhbCBwZXJjZW50YWdlcyBoYXZlIGJlZW4gZXhjZWVkZWQgdG8gJy4kdGVybVBlcmNlbnRhZ2VzWyRwYXltZW50X3Rlcm1faWRdLiclIScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZihpc3NldCgkcmVxdWVzdC0+cGF5bWVudF90ZXJtX2lkWzBdKSl7CiAgICAgICAgICAgICAgICAgICAgZm9yZWFjaCgkcmVxdWVzdC0+cGF5bWVudF90ZXJtX2lkIGFzICRrZXkgPT4gJHBheW1lbnRfdGVybV9pZCl7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCFpc3NldCgkdGVybVBlcmNlbnRhZ2VzWyRwYXltZW50X3Rlcm1faWRdKSl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkdGVybVBlcmNlbnRhZ2VzWyRwYXltZW50X3Rlcm1faWRdID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAkdGVybVBlcmNlbnRhZ2VzWyRwYXltZW50X3Rlcm1faWRdICs9ICRyZXF1ZXN0LT5wYXltZW50X3BlcmNlbnRbJGtleV07CgogICAgICAgICAgICAgICAgICAgICAgICBpZigkdGVybVBlcmNlbnRhZ2VzWyRwYXltZW50X3Rlcm1faWRdID4gMTAwKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRwYXltZW50VGVybSA9IFBheW1lbnRUZXJtOjpmaW5kKCRwYXltZW50X3Rlcm1faWQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbWVzc2FnZScgPT4gJ1BheW1lbnQgVGVybSAjJy4kcGF5bWVudFRlcm0tPnRlcm0uJyB0b3RhbCBwZXJjZW50YWdlcyBoYXZlIGJlZW4gZXhjZWVkZWQgdG8gJy4kdGVybVBlcmNlbnRhZ2VzWyRwYXltZW50X3Rlcm1faWRdLiclIScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgJGlucHV0cyA9ICRyZXF1ZXN0LT5hbGwoKTsKICAgICAgICAgICAgICAgICRzdXBwbGllci0+dXBkYXRlKCRpbnB1dHMpOwoKICAgICAgICAgICAgICAgICRzdXBwbGllci0+cHJvZHVjdHMoKS0+c3luYyhQcm9kdWN0Ojp3aGVyZUluKCdjYXRlZ29yeV9pZCcsIGlzc2V0KCRyZXF1ZXN0LT5zdWJfY2F0ZWdvcmllc1swXSkgPyAkcmVxdWVzdC0+c3ViX2NhdGVnb3JpZXMgOiBbXSktPnBsdWNrKCdpZCcpLT50b0FycmF5KCkpOwogICAgICAgICAgICAgICAgJHN1cHBsaWVyLT5jdXJyZW5jaWVzKCktPnN5bmMoJHJlcXVlc3QtPmN1cnJlbmNpZXMpOwoKICAgICAgICAgICAgICAgIGlmKCRyZXF1ZXN0LT5oYXNGaWxlKCdhdXRoX3BlcnNvbl9sZXR0ZXJfZmlsZScpKXsKICAgICAgICAgICAgICAgICAgICBpZighZW1wdHkoJHN1cHBsaWVyLT5hdXRoX3BlcnNvbl9sZXR0ZXIpKXsKICAgICAgICAgICAgICAgICAgICAgICAgdW5saW5rKHB1YmxpY19wYXRoKCRzdXBwbGllci0+YXV0aF9wZXJzb25fbGV0dGVyKSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAkc3VwcGxpZXItPmF1dGhfcGVyc29uX2xldHRlciA9ICR0aGlzLT5maWxlVXBsb2FkKCRyZXF1ZXN0LT5maWxlKCdhdXRoX3BlcnNvbl9sZXR0ZXJfZmlsZScpLCAndXBsb2FkL3N1cHBsaWVyLWF1dGhvcml6YXRpb24tbGV0dGVyJyk7CiAgICAgICAgICAgICAgICAgICAgJHN1cHBsaWVyLT5zYXZlKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYoJHJlcXVlc3QtPmhhc0ZpbGUoJ293bmVyX3Bob3RvX2ZpbGUnKSl7CiAgICAgICAgICAgICAgICAgICAgaWYoIWVtcHR5KCRzdXBwbGllci0+b3duZXJfcGhvdG8pKXsKICAgICAgICAgICAgICAgICAgICAgICAgdW5saW5rKHB1YmxpY19wYXRoKCRzdXBwbGllci0+b3duZXJfcGhvdG8pKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICRzdXBwbGllci0+b3duZXJfcGhvdG8gPSAkdGhpcy0+ZmlsZVVwbG9hZCgkcmVxdWVzdC0+ZmlsZSgnb3duZXJfcGhvdG9fZmlsZScpLCAndXBsb2FkL3N1cHBsaWVyLW93bmVyLXBob3RvJywgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgJHN1cHBsaWVyLT5zYXZlKCk7CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIGlmIChpc3NldCgkcmVxdWVzdC0+b2xkX3BheW1lbnRfdGVybV9pZCkgJiYgaXNfYXJyYXkoJHJlcXVlc3QtPm9sZF9wYXltZW50X3Rlcm1faWQpICYmIGNvdW50KCRyZXF1ZXN0LT5vbGRfcGF5bWVudF90ZXJtX2lkKSA+IDApIHsKICAgICAgICAgICAgICAgICAgICBmb3JlYWNoICgkcmVxdWVzdC0+b2xkX3BheW1lbnRfdGVybV9pZCBhcyAkb2JlamN0X2lkID0+ICRwYXltZW50X3Rlcm1faWQpewogICAgICAgICAgICAgICAgICAgICAgICAkcGFyZW50ID0gU3VwcGxpZXJQYXltZW50VGVybTo6d2hlcmUoWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3N1cHBsaWVyX2lkJyA9PiAkc3VwcGxpZXItPmlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3BheW1lbnRfdGVybV9pZCcgPT4gJHBheW1lbnRfdGVybV9pZAogICAgICAgICAgICAgICAgICAgICAgICBdKQogICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlKCdpZCcsICc8JywgJG9iZWpjdF9pZCkKICAgICAgICAgICAgICAgICAgICAgICAgLT5maXJzdCgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgU3VwcGxpZXJQYXltZW50VGVybTo6d2hlcmUoJ2lkJywgJG9iZWpjdF9pZCkKICAgICAgICAgICAgICAgICAgICAgICAgLT51cGRhdGUoWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3BheW1lbnRfdGVybV9pZCcgPT4gJHBheW1lbnRfdGVybV9pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdwYXltZW50X3BlcmNlbnQnID0+ICRyZXF1ZXN0LT5vbGRfcGF5bWVudF9wZXJjZW50WyRvYmVqY3RfaWRdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2RheV9kdXJhdGlvbicgPT4gJHJlcXVlc3QtPm9sZF9kYXlfZHVyYXRpb25bJG9iZWpjdF9pZF0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAndHlwZScgPT4gJHJlcXVlc3QtPm9sZF90eXBlWyRvYmVqY3RfaWRdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3BhcmVudF9pZCcgPT4gaXNzZXQoJHBhcmVudC0+aWQpID8gJHBhcmVudC0+aWQgOiAwLAogICAgICAgICAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGlzc2V0KCRyZXF1ZXN0LT5wYXltZW50X3Rlcm1faWRbMF0pKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yZWFjaCAoJHJlcXVlc3QtPnBheW1lbnRfdGVybV9pZCBhcyAka2V5ID0+ICRwYXltZW50X3Rlcm1faWQpewogICAgICAgICAgICAgICAgICAgICAgICAkcGFyZW50ID0gU3VwcGxpZXJQYXltZW50VGVybTo6d2hlcmUoWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3N1cHBsaWVyX2lkJyA9PiAkc3VwcGxpZXItPmlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3BheW1lbnRfdGVybV9pZCcgPT4gJHBheW1lbnRfdGVybV9pZAogICAgICAgICAgICAgICAgICAgICAgICBdKS0+Zmlyc3QoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIFN1cHBsaWVyUGF5bWVudFRlcm06OmNyZWF0ZShbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnc3VwcGxpZXJfaWQnID0+ICRzdXBwbGllci0+aWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAncGF5bWVudF90ZXJtX2lkJyA9PiAkcGF5bWVudF90ZXJtX2lkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3BheW1lbnRfcGVyY2VudCcgPT4gJHJlcXVlc3QtPnBheW1lbnRfcGVyY2VudFska2V5XSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdkYXlfZHVyYXRpb24nID0+ICRyZXF1ZXN0LT5kYXlfZHVyYXRpb25bJGtleV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAndHlwZScgPT4gJHJlcXVlc3QtPnR5cGVbJGtleV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAncGFyZW50X2lkJyA9PiBpc3NldCgkcGFyZW50LT5pZCkgPyAkcGFyZW50LT5pZCA6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgIF0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBEQjo6Y29tbWl0KCk7CgogICAgICAgICAgICAgICAgc2Vzc2lvbigpLT5mbGFzaCgnbWVzc2FnZScsICdBIHN1cHBsaWVyIGhhcyBiZWVuIHVwZGF0ZWQgc3VjY2Vzc2Z1bGx5Jyk7CiAgICAgICAgICAgICAgICBzZXNzaW9uKCktPmZsYXNoKCdhbGVydC10eXBlJywgJ3N1Y2Nlc3MnKTsKICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAndXJsJyA9PiB1cmwoJ3Btcy9zdXBwbGllci8nLiRzdXBwbGllci0+aWQuJy9lZGl0P3RhYj0nLnJlcXVlc3QoKS0+Z2V0KCdmb3JtLXR5cGUnKSkKICAgICAgICAgICAgICAgIF0pOwogICAgICAgICAgICB9Y2F0Y2ggKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgICAgIERCOjpyb2xsYmFjaygpOwogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAnbWVzc2FnZScgPT4gJHRoLT5nZXRNZXNzYWdlKCkKICAgICAgICAgICAgICAgIF0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZihyZXF1ZXN0KCktPmhhcygnZm9ybS10eXBlJykgJiYgcmVxdWVzdCgpLT5nZXQoJ2Zvcm0tdHlwZScpID09ICJhZGRyZXNzIil7CiAgICAgICAgICAgICR2YWxpZGF0b3IgPSBcVmFsaWRhdG9yOjptYWtlKCRyZXF1ZXN0LT5hbGwoKSwgWwogICAgICAgICAgICAgICAgJ2NvcnBvcmF0ZV9yb2FkJyA9PiBbJ3JlcXVpcmVkJywgJ3N0cmluZycsICdtYXg6MjU1J10sCiAgICAgICAgICAgICAgICAnY29ycG9yYXRlX2NpdHknID0+IFsncmVxdWlyZWQnLCAnc3RyaW5nJywgJ21heDoyNTUnXSwKICAgICAgICAgICAgICAgICdjb3Jwb3JhdGVfemlwJyA9PiBbJ3JlcXVpcmVkJywgJ3N0cmluZycsICdtYXg6MjU1J10sCiAgICAgICAgICAgICAgICAnY29ycG9yYXRlX2NvdW50cnknID0+IFsncmVxdWlyZWQnLCAnc3RyaW5nJywgJ21heDoyNTUnXSwKICAgICAgICAgICAgICAgIC8vICdmYWN0b3J5X3JvYWQnID0+IFsncmVxdWlyZWQnLCAnc3RyaW5nJywgJ21heDoyNTUnXSwKICAgICAgICAgICAgICAgIC8vICdmYWN0b3J5X2NpdHknID0+IFsncmVxdWlyZWQnLCAnc3RyaW5nJywgJ21heDoyNTUnXSwKICAgICAgICAgICAgICAgIC8vICdmYWN0b3J5X3ppcCcgPT4gWydyZXF1aXJlZCcsICdzdHJpbmcnLCAnbWF4OjI1NSddLAogICAgICAgICAgICAgICAgLy8gJ2ZhY3RvcnlfY291bnRyeScgPT4gWydyZXF1aXJlZCcsICdzdHJpbmcnLCAnbWF4OjI1NSddLAogICAgICAgICAgICBdKTsKCiAgICAgICAgICAgIGlmICghJHZhbGlkYXRvci0+cGFzc2VzKCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiByZWRpcmVjdCgncG1zL3N1cHBsaWVyLycuJHN1cHBsaWVyLT5pZC4nL2VkaXQ/dGFiPScucmVxdWVzdCgpLT5nZXQoJ2Zvcm0tdHlwZScpKS0+d2l0aEVycm9ycygkdmFsaWRhdG9yKTsKICAgICAgICAgICAgICAgIDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgREI6OmJlZ2luVHJhbnNhY3Rpb24oKTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIFN1cHBsaWVyQWRkcmVzczo6dXBkYXRlT3JDcmVhdGUoWwogICAgICAgICAgICAgICAgICAgICdzdXBwbGllcl9pZCcgPT4gJHN1cHBsaWVyLT5pZCwKICAgICAgICAgICAgICAgICAgICAndHlwZScgPT4gJ2NvcnBvcmF0ZScsCiAgICAgICAgICAgICAgICBdLFsKICAgICAgICAgICAgICAgICAgICAncm9hZCcgPT4gJHJlcXVlc3QtPmNvcnBvcmF0ZV9yb2FkLAogICAgICAgICAgICAgICAgICAgICd2aWxsYWdlJyA9PiAkcmVxdWVzdC0+Y29ycG9yYXRlX3ZpbGxhZ2UsCiAgICAgICAgICAgICAgICAgICAgJ2NpdHknID0+ICRyZXF1ZXN0LT5jb3Jwb3JhdGVfY2l0eSwKICAgICAgICAgICAgICAgICAgICAnY291bnRyeScgPT4gJHJlcXVlc3QtPmNvcnBvcmF0ZV9jb3VudHJ5LAogICAgICAgICAgICAgICAgICAgICd6aXAnID0+ICRyZXF1ZXN0LT5jb3Jwb3JhdGVfemlwLAogICAgICAgICAgICAgICAgICAgICdhZGRyZXNzJyA9PiAkcmVxdWVzdC0+Y29ycG9yYXRlX2FkZHJlc3MgCiAgICAgICAgICAgICAgICBdKTsKCiAgICAgICAgICAgICAgICBTdXBwbGllckFkZHJlc3M6OnVwZGF0ZU9yQ3JlYXRlKFsKICAgICAgICAgICAgICAgICAgICAnc3VwcGxpZXJfaWQnID0+ICRzdXBwbGllci0+aWQsCiAgICAgICAgICAgICAgICAgICAgJ3R5cGUnID0+ICdmYWN0b3J5JywKICAgICAgICAgICAgICAgIF0sWwogICAgICAgICAgICAgICAgICAgICdyb2FkJyA9PiAkcmVxdWVzdC0+ZmFjdG9yeV9yb2FkLAogICAgICAgICAgICAgICAgICAgICd2aWxsYWdlJyA9PiAkcmVxdWVzdC0+ZmFjdG9yeV92aWxsYWdlLAogICAgICAgICAgICAgICAgICAgICdjaXR5JyA9PiAkcmVxdWVzdC0+ZmFjdG9yeV9jaXR5LAogICAgICAgICAgICAgICAgICAgICdjb3VudHJ5JyA9PiAkcmVxdWVzdC0+ZmFjdG9yeV9jb3VudHJ5LAogICAgICAgICAgICAgICAgICAgICd6aXAnID0+ICRyZXF1ZXN0LT5mYWN0b3J5X3ppcCwKICAgICAgICAgICAgICAgICAgICAnYWRkcmVzcycgPT4gJHJlcXVlc3QtPmZhY3RvcnlfYWRkcmVzcyAKICAgICAgICAgICAgICAgIF0pOwoKICAgICAgICAgICAgICAgIERCOjpjb21taXQoKTsKICAgICAgICAgICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgICAgICBEQjo6cm9sbGJhY2soKTsKICAgICAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmKHJlcXVlc3QoKS0+aGFzKCdmb3JtLXR5cGUnKSAmJiByZXF1ZXN0KCktPmdldCgnZm9ybS10eXBlJykgPT0gImNvbnRhY3QtcGVyc29uIil7CiAgICAgICAgICAgICR2YWxpZGF0b3IgPSBcVmFsaWRhdG9yOjptYWtlKCRyZXF1ZXN0LT5hbGwoKSwgWwogICAgICAgICAgICAgICAgJ2NvbnRhY3RfcGVyc29uX3NhbGVzX25hbWUnID0+IFsncmVxdWlyZWQnLCAnc3RyaW5nJywgJ21heDoyNTUnXSwKICAgICAgICAgICAgICAgICdjb250YWN0X3BlcnNvbl9zYWxlc19kZXNpZ25hdGlvbicgPT4gWydyZXF1aXJlZCcsICdzdHJpbmcnLCAnbWF4OjI1NSddLAogICAgICAgICAgICAgICAgJ2NvbnRhY3RfcGVyc29uX3NhbGVzX21vYmlsZScgPT4gWydyZXF1aXJlZCcsICdzdHJpbmcnLCAnbWF4OjI1NSddLAogICAgICAgICAgICAgICAgJ2NvbnRhY3RfcGVyc29uX2FmdGVyX3NhbGVzX25hbWUnID0+IFsncmVxdWlyZWQnLCAnc3RyaW5nJywgJ21heDoyNTUnXSwKICAgICAgICAgICAgICAgICdjb250YWN0X3BlcnNvbl9hZnRlcl9zYWxlc19kZXNpZ25hdGlvbicgPT4gWydyZXF1aXJlZCcsICdzdHJpbmcnLCAnbWF4OjI1NSddLAogICAgICAgICAgICAgICAgJ2NvbnRhY3RfcGVyc29uX2FmdGVyX3NhbGVzX21vYmlsZScgPT4gWydyZXF1aXJlZCcsICdzdHJpbmcnLCAnbWF4OjI1NSddLAogICAgICAgICAgICBdKTsKCiAgICAgICAgICAgIGlmICghJHZhbGlkYXRvci0+cGFzc2VzKCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiByZWRpcmVjdCgncG1zL3N1cHBsaWVyLycuJHN1cHBsaWVyLT5pZC4nL2VkaXQ/dGFiPScucmVxdWVzdCgpLT5nZXQoJ2Zvcm0tdHlwZScpKS0+d2l0aEVycm9ycygkdmFsaWRhdG9yKTsKICAgICAgICAgICAgICAgIDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgREI6OmJlZ2luVHJhbnNhY3Rpb24oKTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIFN1cHBsaWVyQ29udGFjdFBlcnNvbjo6dXBkYXRlT3JDcmVhdGUoWwogICAgICAgICAgICAgICAgICAgICdzdXBwbGllcl9pZCcgPT4gJHN1cHBsaWVyLT5pZCwKICAgICAgICAgICAgICAgICAgICAndHlwZScgPT4gJ3NhbGVzJywKICAgICAgICAgICAgICAgIF0sWwogICAgICAgICAgICAgICAgICAgICduYW1lJyA9PiAkcmVxdWVzdC0+Y29udGFjdF9wZXJzb25fc2FsZXNfbmFtZSwKICAgICAgICAgICAgICAgICAgICAnZGVzaWduYXRpb24nID0+ICRyZXF1ZXN0LT5jb250YWN0X3BlcnNvbl9zYWxlc19kZXNpZ25hdGlvbiwKICAgICAgICAgICAgICAgICAgICAnbW9iaWxlJyA9PiAkcmVxdWVzdC0+Y29udGFjdF9wZXJzb25fc2FsZXNfbW9iaWxlLAogICAgICAgICAgICAgICAgICAgICdlbWFpbCcgPT4gJHJlcXVlc3QtPmNvbnRhY3RfcGVyc29uX3NhbGVzX2VtYWlsCiAgICAgICAgICAgICAgICBdKTsKCiAgICAgICAgICAgICAgICBTdXBwbGllckNvbnRhY3RQZXJzb246OnVwZGF0ZU9yQ3JlYXRlKFsKICAgICAgICAgICAgICAgICAgICAnc3VwcGxpZXJfaWQnID0+ICRzdXBwbGllci0+aWQsCiAgICAgICAgICAgICAgICAgICAgJ3R5cGUnID0+ICdhZnRlci1zYWxlcycsCiAgICAgICAgICAgICAgICBdLFsKICAgICAgICAgICAgICAgICAgICAnbmFtZScgPT4gJHJlcXVlc3QtPmNvbnRhY3RfcGVyc29uX2FmdGVyX3NhbGVzX25hbWUsCiAgICAgICAgICAgICAgICAgICAgJ2Rlc2lnbmF0aW9uJyA9PiAkcmVxdWVzdC0+Y29udGFjdF9wZXJzb25fYWZ0ZXJfc2FsZXNfZGVzaWduYXRpb24sCiAgICAgICAgICAgICAgICAgICAgJ21vYmlsZScgPT4gJHJlcXVlc3QtPmNvbnRhY3RfcGVyc29uX2FmdGVyX3NhbGVzX21vYmlsZSwKICAgICAgICAgICAgICAgICAgICAnZW1haWwnID0+ICRyZXF1ZXN0LT5jb250YWN0X3BlcnNvbl9hZnRlcl9zYWxlc19lbWFpbAogICAgICAgICAgICAgICAgXSk7CgogICAgICAgICAgICAgICAgREI6OmNvbW1pdCgpOwogICAgICAgICAgICB9Y2F0Y2ggKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgICAgIERCOjpyb2xsYmFjaygpOwogICAgICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYocmVxdWVzdCgpLT5oYXMoJ2Zvcm0tdHlwZScpICYmIHJlcXVlc3QoKS0+Z2V0KCdmb3JtLXR5cGUnKSA9PSAiYmFuay1hY2NvdW50Iil7CiAgICAgICAgICAgICR2YWxpZGF0b3IgPSBcVmFsaWRhdG9yOjptYWtlKCRyZXF1ZXN0LT5hbGwoKSwgWwogICAgICAgICAgICAgICAgJ2JhbmtfYWNjb3VudF9uYW1lJyA9PiBbJ3JlcXVpcmVkJywgJ3N0cmluZycsICdtYXg6MjU1J10sCiAgICAgICAgICAgICAgICAnYmFua19hY2NvdW50X251bWJlcicgPT4gWydyZXF1aXJlZCcsICdzdHJpbmcnLCAnbWF4OjI1NSddLAogICAgICAgICAgICAgICAgJ2Jhbmtfc3dpZnRfY29kZScgPT4gWydyZXF1aXJlZCcsICdzdHJpbmcnLCAnbWF4OjI1NSddLAogICAgICAgICAgICAgICAgJ2JhbmtfbmFtZScgPT4gWydyZXF1aXJlZCcsICdzdHJpbmcnLCAnbWF4OjI1NSddLAogICAgICAgICAgICAgICAgJ2JhbmtfYnJhbmNoJyA9PiBbJ3JlcXVpcmVkJywgJ3N0cmluZycsICdtYXg6MjU1J10sCiAgICAgICAgICAgIF0pOwoKICAgICAgICAgICAgaWYgKCEkdmFsaWRhdG9yLT5wYXNzZXMoKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlZGlyZWN0KCdwbXMvc3VwcGxpZXIvJy4kc3VwcGxpZXItPmlkLicvZWRpdD90YWI9Jy5yZXF1ZXN0KCktPmdldCgnZm9ybS10eXBlJykpLT53aXRoRXJyb3JzKCR2YWxpZGF0b3IpOwogICAgICAgICAgICAgICAgOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZigkcmVxdWVzdC0+aGFzRmlsZSgnYmFua19zZWN1cml0eV9jaGVja19maWxlJykpewogICAgICAgICAgICAgICAgJHZhbGlkYXRvciA9IFxWYWxpZGF0b3I6Om1ha2UoJHJlcXVlc3QtPmFsbCgpLCBbCiAgICAgICAgICAgICAgICAgICAgJ2Jhbmtfc2VjdXJpdHlfY2hlY2tfZmlsZScgPT4gWydtaW1lczpwZGYscG5nJywgJ21heDoyMDQ4J10sCiAgICAgICAgICAgICAgICBdKTsKCiAgICAgICAgICAgICAgICBpZiAoISR2YWxpZGF0b3ItPnBhc3NlcygpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlZGlyZWN0KCdwbXMvc3VwcGxpZXIvJy4kc3VwcGxpZXItPmlkLicvZWRpdD90YWI9Jy5yZXF1ZXN0KCktPmdldCgnZm9ybS10eXBlJykpLT53aXRoRXJyb3JzKCR2YWxpZGF0b3IpOwogICAgICAgICAgICAgICAgICAgIDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgREI6OmJlZ2luVHJhbnNhY3Rpb24oKTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICRiYW5rQWNjb3VudCA9IFN1cHBsaWVyQmFua0FjY291bnQ6OnVwZGF0ZU9yQ3JlYXRlKFsKICAgICAgICAgICAgICAgICAgICAnc3VwcGxpZXJfaWQnID0+ICRzdXBwbGllci0+aWQsCiAgICAgICAgICAgICAgICBdLFsKICAgICAgICAgICAgICAgICAgICAnYWNjb3VudF9uYW1lJyA9PiAkcmVxdWVzdC0+YmFua19hY2NvdW50X25hbWUsCiAgICAgICAgICAgICAgICAgICAgJ2FjY291bnRfbnVtYmVyJyA9PiAkcmVxdWVzdC0+YmFua19hY2NvdW50X251bWJlciwKICAgICAgICAgICAgICAgICAgICAnc3dpZnRfY29kZScgPT4gJHJlcXVlc3QtPmJhbmtfc3dpZnRfY29kZSwKICAgICAgICAgICAgICAgICAgICAnYmFua19uYW1lJyA9PiAkcmVxdWVzdC0+YmFua19uYW1lLAogICAgICAgICAgICAgICAgICAgICdicmFuY2gnID0+ICRyZXF1ZXN0LT5iYW5rX2JyYW5jaCwKICAgICAgICAgICAgICAgICAgICAnY3VycmVuY3knID0+ICRyZXF1ZXN0LT5iYW5rX2N1cnJlbmN5LAogICAgICAgICAgICAgICAgXSk7CgogICAgICAgICAgICAgICAgaWYoJHJlcXVlc3QtPmhhc0ZpbGUoJ2Jhbmtfc2VjdXJpdHlfY2hlY2tfZmlsZScpKXsKICAgICAgICAgICAgICAgICAgICBpZighZW1wdHkoJGJhbmtBY2NvdW50LT5zZWN1cml0eV9jaGVjaykpewogICAgICAgICAgICAgICAgICAgICAgICB1bmxpbmsocHVibGljX3BhdGgoJGJhbmtBY2NvdW50LT5zZWN1cml0eV9jaGVjaykpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgJGJhbmtBY2NvdW50LT5zZWN1cml0eV9jaGVjayA9ICR0aGlzLT5maWxlVXBsb2FkKCRyZXF1ZXN0LT5maWxlKCdiYW5rX3NlY3VyaXR5X2NoZWNrX2ZpbGUnKSwgJ3VwbG9hZC9iYW5rLWd1YXJhbnRlZS1zZWN1cml0eS1jaGVjaycpOwogICAgICAgICAgICAgICAgICAgICRiYW5rQWNjb3VudC0+c2F2ZSgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIERCOjpjb21taXQoKTsKICAgICAgICAgICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgICAgICBEQjo6cm9sbGJhY2soKTsKICAgICAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmKHJlcXVlc3QoKS0+aGFzKCdmb3JtLXR5cGUnKSAmJiByZXF1ZXN0KCktPmdldCgnZm9ybS10eXBlJykgPT0gImxlZGdlcnMiKXsKICAgICAgICAgICAgLyoKICAgICAgICAgICAgJHZhbGlkYXRvciA9IFxWYWxpZGF0b3I6Om1ha2UoJHJlcXVlc3QtPmFsbCgpLCBbCiAgICAgICAgICAgICAgICAnbGVkZ2VyX25hbWUnID0+IFsncmVxdWlyZWQnXSwKICAgICAgICAgICAgICAgICdsZWRnZXJfdHlwZScgPT4gWydyZXF1aXJlZCddLAogICAgICAgICAgICAgICAgJ29wZW5pbmdfYmFsYW5jZScgPT4gWydyZXF1aXJlZCddLAogICAgICAgICAgICBdKTsKCiAgICAgICAgICAgIGlmICghJHZhbGlkYXRvci0+cGFzc2VzKCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiByZWRpcmVjdCgncG1zL3N1cHBsaWVyLycuJHN1cHBsaWVyLT5pZC4nL2VkaXQ/dGFiPScucmVxdWVzdCgpLT5nZXQoJ2Zvcm0tdHlwZScpKS0+d2l0aEVycm9ycygkdmFsaWRhdG9yKTsKICAgICAgICAgICAgICAgIDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgREI6OmJlZ2luVHJhbnNhY3Rpb24oKTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICRhY2NvdW50RGVmYXVsdFNldHRpbmdzID0gYWNjb3VudERlZmF1bHRTZXR0aW5ncygnanNvbicpOwogICAgICAgICAgICAgICAgLy8gc2F2ZUdMRm9yT2JqZWN0cygkc3VwcGxpZXIsICRzdXBwbGllci0+cGF5YWJsZUFjY291bnQsICRyZXF1ZXN0LCAncGF5YWJsZV9hY2NvdW50X2lkJywgJGFjY291bnREZWZhdWx0U2V0dGluZ3NbJ3N1cHBsaWVyX3BheWFibGUnXSk7CiAgICAgICAgICAgICAgICAvLyBzYXZlR0xGb3JPYmplY3RzKCRzdXBwbGllciwgJHN1cHBsaWVyLT5wYXlhYmxlUHVyY2hhc2VBY2NvdW50LCAkcmVxdWVzdCwgJ3BheWFibGVfcHVyY2hhc2VfaWQnLCAkYWNjb3VudERlZmF1bHRTZXR0aW5nc1snc3VwcGxpZXJfcGF5YWJsZV9wdXJjaGFzZSddKTsKICAgICAgICAgICAgICAgIC8vIHNhdmVHTEZvck9iamVjdHMoJHN1cHBsaWVyLCAkc3VwcGxpZXItPnBheWFibGVEaXNjb3VudEFjY291bnQsICRyZXF1ZXN0LCAncGF5YWJsZV9kaXNjb3VudF9pZCcsICRhY2NvdW50RGVmYXVsdFNldHRpbmdzWydzdXBwbGllcl9wYXlhYmxlX2Rpc2NvdW50J10pOwogICAgICAgICAgICAgICAgLy8gc2F2ZUdMRm9yT2JqZWN0cygkc3VwcGxpZXIsICRzdXBwbGllci0+YWR2YW5jZUFjY291bnQsICRyZXF1ZXN0LCAnYWR2YW5jZV9hY2NvdW50X2lkJywgJGFjY291bnREZWZhdWx0U2V0dGluZ3NbJ3N1cHBsaWVyX2FkdmFuY2UnXSk7CgogICAgICAgICAgICAgICAgREI6OmNvbW1pdCgpOwogICAgICAgICAgICB9Y2F0Y2ggKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgICAgIERCOjpyb2xsYmFjaygpOwogICAgICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAqLwoKICAgICAgICAgICAgJHZhbGlkYXRvciA9IFxWYWxpZGF0b3I6Om1ha2UoJHJlcXVlc3QtPmFsbCgpLCBbCiAgICAgICAgICAgICAgICAncGF5YWJsZV9hY2NvdW50X2lkJyA9PiBbJ3JlcXVpcmVkJ10sCiAgICAgICAgICAgICAgICAnYWR2YW5jZV9hY2NvdW50X2lkJyA9PiBbJ3JlcXVpcmVkJ10sCiAgICAgICAgICAgIF0pOwoKICAgICAgICAgICAgaWYgKCEkdmFsaWRhdG9yLT5wYXNzZXMoKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlZGlyZWN0KCdwbXMvc3VwcGxpZXIvJy4kc3VwcGxpZXItPmlkLicvZWRpdD90YWI9Jy5yZXF1ZXN0KCktPmdldCgnZm9ybS10eXBlJykpLT53aXRoRXJyb3JzKCR2YWxpZGF0b3IpOwogICAgICAgICAgICAgICAgOwogICAgICAgICAgICB9CgogICAgICAgICAgICBEQjo6YmVnaW5UcmFuc2FjdGlvbigpOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgJHN1cHBsaWVyLT5wYXlhYmxlX2FjY291bnRfaWQgPSAkcmVxdWVzdC0+cGF5YWJsZV9hY2NvdW50X2lkOwogICAgICAgICAgICAgICAgJHN1cHBsaWVyLT5hZHZhbmNlX2FjY291bnRfaWQgPSAkcmVxdWVzdC0+YWR2YW5jZV9hY2NvdW50X2lkOwogICAgICAgICAgICAgICAgJHN1cHBsaWVyLT5zYXZlKCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIERCOjpjb21taXQoKTsKICAgICAgICAgICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgICAgICBEQjo6cm9sbGJhY2soKTsKICAgICAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgICRub3RpZmljYXRpb24gPSBbCiAgICAgICAgICAgICdtZXNzYWdlJyA9PiAnQSBzdXBwbGllciBoYXMgYmVlbiB1cGRhdGVkIHN1Y2Nlc3NmdWxseScsCiAgICAgICAgICAgICdhbGVydC10eXBlJyA9PiAnc3VjY2VzcycKICAgICAgICBdOwogICAgICAgIHJldHVybiByZWRpcmVjdCgncG1zL3N1cHBsaWVyLycuJHN1cHBsaWVyLT5pZC4nL2VkaXQ/dGFiPScucmVxdWVzdCgpLT5nZXQoJ2Zvcm0tdHlwZScpKS0+d2l0aCgkbm90aWZpY2F0aW9uKTsKICAgIH0KCiAgICAvKioKICAgICAqIFJlbW92ZSB0aGUgc3BlY2lmaWVkIHJlc291cmNlIGZyb20gc3RvcmFnZS4KICAgICAqCiAgICAgKiBAcGFyYW0gIGludCAgJGlkCiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwogICAgcHVibGljIGZ1bmN0aW9uIGRlc3Ryb3koJGlkKQogICAgewogICAgICAgIERCOjpiZWdpblRyYW5zYWN0aW9uKCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgJHN1cHBsaWVyID0gU3VwcGxpZXJzOjpmaW5kKCRpZCk7CiAgICAgICAgICAgIGlmKCRzdXBwbGllci0+ZGVsZXRhYmxlID09ICdubycgfHwgZnJlZXplU3VwcGxpZXIoJHN1cHBsaWVyKSl7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnID0+IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAkc3VwcGxpZXItPm5hbWUuIiAoIi4kc3VwcGxpZXItPmNvZGUuIikgQ2Fubm90IGJlIGRlbGV0ZWQhIgogICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgICRiYW5rQWNjb3VudCA9IFN1cHBsaWVyQmFua0FjY291bnQ6OndoZXJlKCdzdXBwbGllcl9pZCcsICRzdXBwbGllci0+aWQpLT5maXJzdCgpOwogICAgICAgICAgICBpZihpc3NldCgkYmFua0FjY291bnQtPmlkKSAmJiAhZW1wdHkoJGJhbmtBY2NvdW50LT5zZWN1cml0eV9jaGVjaykgJiYgZmlsZV9leGlzdHMocHVibGljX3BhdGgoJGJhbmtBY2NvdW50LT5zZWN1cml0eV9jaGVjaykpKXsKICAgICAgICAgICAgICAgIHVubGluayhwdWJsaWNfcGF0aCgkYmFua0FjY291bnQtPnNlY3VyaXR5X2NoZWNrKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICRkZWxldGUgPSBTdXBwbGllcnM6OmZpbmQoJGlkKS0+ZGVsZXRlKCk7CiAgICAgICAgICAgIFxEQjo6dGFibGUoJ3Byb2R1Y3RzX3N1cHBsaWVyJyktPndoZXJlKCdzdXBwbGllcl9pZCcsICRpZCktPmRlbGV0ZSgpOwogICAgICAgICAgICBcREI6OnRhYmxlKCdzdXBwbGllcl9jdXJyZW5jaWVzJyktPndoZXJlKCdzdXBwbGllcl9pZCcsICRpZCktPmRlbGV0ZSgpOwogICAgICAgICAgICBcREI6OnRhYmxlKCdzdXBwbGllcl9wYXltZW50X3Rlcm1zJyktPndoZXJlKCdzdXBwbGllcl9pZCcsICRpZCktPmRlbGV0ZSgpOwogICAgICAgICAgICBpZigkZGVsZXRlKXsKICAgICAgICAgICAgICAgIGlmKCFlbXB0eSgkc3VwcGxpZXItPmF1dGhfcGVyc29uX2xldHRlcikgJiYgZmlsZV9leGlzdHMocHVibGljX3BhdGgoJHN1cHBsaWVyLT5hdXRoX3BlcnNvbl9sZXR0ZXIpKSl7CiAgICAgICAgICAgICAgICAgICAgdW5saW5rKHB1YmxpY19wYXRoKCRzdXBwbGllci0+YXV0aF9wZXJzb25fbGV0dGVyKSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYoIWVtcHR5KCRzdXBwbGllci0+b3duZXJfcGhvdG8pICYmIGZpbGVfZXhpc3RzKHB1YmxpY19wYXRoKCRzdXBwbGllci0+b3duZXJfcGhvdG8pKSl7CiAgICAgICAgICAgICAgICAgICAgdW5saW5rKHB1YmxpY19wYXRoKCRzdXBwbGllci0+b3duZXJfcGhvdG8pKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgREI6OmNvbW1pdCgpOwogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gdHJ1ZSwKICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAiU3VwcGxpZXIgaGFzIGJlZW4gZGVsZXRlZCBzdWNjZXNzZnVsbHkiCiAgICAgICAgICAgIF0pOwogICAgICAgIH1jYXRjaCAoXFRocm93YWJsZSAkdGgpewogICAgICAgICAgICBEQjo6cm9sbGJhY2soKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnID0+IGZhbHNlLAogICAgICAgICAgICAgICAgJ21lc3NhZ2UnID0+ICR0aC0+Z2V0TWVzc2FnZSgpCiAgICAgICAgICAgIF0pOwogICAgICAgIH0KICAgIH0KCiAgICBwdWJsaWMgZnVuY3Rpb24gc2hvd1N1cHBsaWVyUHJvZmlsZSgkaWQpewoKICAgICAgICAkZGF0YSA9IFsKICAgICAgICAgICAgJ3RpdGxlJyA9PiAnU3VwcGxpZXIgUHJvZmlsZSBJbmZvcm1hdGlvbicsCiAgICAgICAgICAgICdzdXBwbGllcicgPT4gU3VwcGxpZXJzOjpmaW5kT3JGYWlsKCRpZCksCiAgICAgICAgICAgICdjb3Jwb3JhdGVBZGRyZXNzJyA9PiBTdXBwbGllckFkZHJlc3M6OndoZXJlKFsnc3VwcGxpZXJfaWQnID0+ICRpZCwgJ3R5cGUnID0+ICdjb3Jwb3JhdGUnXSktPmZpcnN0KCksCiAgICAgICAgICAgICdmYWN0b3J5QWRkcmVzcycgPT4gU3VwcGxpZXJBZGRyZXNzOjp3aGVyZShbJ3N1cHBsaWVyX2lkJyA9PiAkaWQsICd0eXBlJyA9PiAnZmFjdG9yeSddKS0+Zmlyc3QoKSwKICAgICAgICAgICAgJ2NvbnRhY3RQZXJzb25TYWxlcycgPT4gU3VwcGxpZXJDb250YWN0UGVyc29uOjp3aGVyZShbJ3N1cHBsaWVyX2lkJyA9PiAkaWQsICd0eXBlJyA9PiAnc2FsZXMnXSktPmZpcnN0KCksCiAgICAgICAgICAgICdjb250YWN0UGVyc29uQWZ0ZXJTYWxlcycgPT4gU3VwcGxpZXJDb250YWN0UGVyc29uOjp3aGVyZShbJ3N1cHBsaWVyX2lkJyA9PiAkaWQsICd0eXBlJyA9PiAnYWZ0ZXItc2FsZXMnXSktPmZpcnN0KCksCiAgICAgICAgICAgICdiYW5rQWNjb3VudCcgPT4gU3VwcGxpZXJCYW5rQWNjb3VudDo6d2hlcmUoWydzdXBwbGllcl9pZCcgPT4gJGlkXSktPmZpcnN0KCksCiAgICAgICAgICAgICdsb2dzJyA9PiBTdXBwbGllckxvZzo6d2hlcmUoJ3N1cHBsaWVyX2lkJywgJGlkKS0+b3JkZXJCeSgnaWQnLCAnZGVzYycpLT5nZXQoKSwKICAgICAgICAgICAgJ2FjY291bnREZWZhdWx0U2V0dGluZ3MnID0+IGFjY291bnREZWZhdWx0U2V0dGluZ3MoJ2pzb24nKSwKICAgICAgICBdOwoKICAgICAgICBpZihyZXF1ZXN0KCktPmhhcygndmlldycpKXsKICAgICAgICAgICAgJGJvZHkgPSBWaWV3OjptYWtlKCdwbXMuYmFja2VuZC5wYWdlcy5zdXBwbGllcnMuc3VwcGxpZXItdmlldycsJGRhdGEpOwogICAgICAgICAgICByZXR1cm4gJGJvZHktPnJlbmRlcigpOwogICAgICAgIH1lbHNlewogICAgICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMuc3VwcGxpZXJzLnByb2ZpbGUnLCAkZGF0YSk7CiAgICAgICAgfQoKICAgIH0KCiAgICBwdWJsaWMgZnVuY3Rpb24gc2hvd1N1cHBsaWVyUmF0aW5nRnJvbSgkc3VwcGxpZXJJZCwkZ3JuSWQpewoKICAgICAkc3VwcGxpZXJDcml0ZXJpYUNvbHVtbnM9c3VwcGxpZXJDcml0ZXJpYUNvbHVtbnMoKTsKCiAgICAgJHN1cHBsaWVyRGF0YSA9IFN1cHBsaWVyczo6d2l0aCgncmVsUGF5bWVudFRlcm1zJywncmVsUGF5bWVudFRlcm1zLnJlbFBheW1lbnRUZXJtJywnU3VwcGxpZXJSYXRpbmdzJyktPmZpbmRPckZhaWwoJHN1cHBsaWVySWQpOwogICAgICRncm4gPSBHb29kc1JlY2VpdmVkTm90ZTo6ZmluZE9yRmFpbCgkZ3JuSWQpOwogICAgICR0aXRsZSA9ICJHaXZlIHJhdGluZyB0byBzdXBwbGllciB0aGUgKCAkc3VwcGxpZXJEYXRhLT5uYW1lICkiOwoKICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMuc3VwcGxpZXJzLnJhdGluZycsIGNvbXBhY3QoJ3RpdGxlJywgJ3N1cHBsaWVyRGF0YScsJ3N1cHBsaWVyQ3JpdGVyaWFDb2x1bW5zJywnZ3JuJykpOwoKIH0KCiBwdWJsaWMgZnVuY3Rpb24gc3RvcmVTdXBwbGllclJhdGluZyhSZXF1ZXN0ICRyZXF1ZXN0KXsKCiAgICBEQjo6YmVnaW5UcmFuc2FjdGlvbigpOwogICAgdHJ5IHsKCiAgICAgICAgJGdybj1Hb29kc1JlY2VpdmVkTm90ZTo6ZmluZE9yRmFpbCgkcmVxdWVzdC0+Z3JuX2lkKTsKICAgICAgICAkc3VwcGxpZXI9U3VwcGxpZXJzOjpmaW5kT3JGYWlsKCRyZXF1ZXN0LT5zdXBwbGllcl9pZCk7CiAgICAgICAgJHRvdGFsQ29sdW1uID0gQ29sdW1uQ291bnQoJ3N1cHBsaWVyX3JhdHRpbmdzJyk7CiAgICAgICAgJHRvdGFsU2NvcmUgPTA7CgogICAgICAgICRyYXRpbmdJbnB1dD1bXTsKICAgICAgICBmb3JlYWNoICgkcmVxdWVzdC0+cmF0aW5nIGFzICRrZXk9PiRyYXRlKXsKCiAgICAgICAgICAgICRyYXRpbmdJbnB1dFska2V5XT0kcmVxdWVzdC0+cmF0aW5nWyRrZXldPz8wOwogICAgICAgICAgICAkdG90YWxTY29yZSs9JHJhdGluZ0lucHV0WyRrZXldOwogICAgICAgIH0KCiAgICAgICAgLy8gaWYgKCRncm4tPmlzX3N1cHBsaWVyX3JhdGluZz09J3llcycpewogICAgICAgIC8vICAgICByZXR1cm4gJHRoaXMtPnJlZGlyZWN0QmFja1dpdGhXYXJuaW5nKCdTdXBwbGllciBSYXRpbmcgQWxyZWFkeSBTdWJtaXQnLCdwbXMuc3RvY2tpbi5ncm4ubGlzdCcpOwogICAgICAgIC8vIH0KICAgICAgICAKICAgICAgICBpZiAoJHRvdGFsU2NvcmU8PTApewogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoV2FybmluZygnUmF0aW5nIGlzIGVtcHR5Jyk7CiAgICAgICAgfQoKICAgICAgICAkcmF0aW5nSW5wdXRbJ2NyZWF0ZWRfYnknXT1cQXV0aDo6dXNlcigpLT5pZDsKICAgICAgICAkcmF0aW5nSW5wdXRbJ3N1cHBsaWVyX2lkJ109JHJlcXVlc3QtPnN1cHBsaWVyX2lkOwogICAgICAgICRyYXRpbmdJbnB1dFsndG90YWxfc2NvcmUnXT0kdG90YWxTY29yZS8kdG90YWxDb2x1bW47CiAgICAgICAgJHJhdGluZ0lucHV0WydrZXknXT0kcmVxdWVzdC0+a2V5OwogICAgICAgICRyYXRpbmdJbnB1dFsndmFsdWUnXT0kcmVxdWVzdC0+dmFsdWU7CiAgICAgICAgJHJhdGluZ0lucHV0Wyd0eXBlJ109JHJlcXVlc3QtPnR5cGU7CgogICAgICAgIFN1cHBsaWVyUmF0aW5nczo6Y3JlYXRlKCRyYXRpbmdJbnB1dCk7CgogICAgICAgICRncm4tPnVwZGF0ZShbJ2lzX3N1cHBsaWVyX3JhdGluZyc9Pid5ZXMnXSk7CiAgICAgICAgREI6OmNvbW1pdCgpOwoKICAgICAgICByZXR1cm4gJHRoaXMtPnVybFJlZGlyZWN0QmFjaygnU3VwcGxpZXIgUmF0aW5nIGlzIHN1Y2Nlc3NmdWwnLCcvcG1zJywnc3VjY2VzcycpOwoKICAgIH1jYXRjaCAoXFRocm93YWJsZSAkdGgpewogICAgICAgIERCOjpyb2xsYmFjaygpOwogICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgIH0KCn0KCnB1YmxpYyBmdW5jdGlvbiB0b2dnbGUoJGlkKQp7CiAgICAkbWVzc2FnZSA9ICcnOwogICAgJG1lc3NhZ2VGb3JNYW5hZ2VtZW50ID0gJyc7CgogICAgJHN1cHBsaWVyID0gU3VwcGxpZXJzOjpmaW5kKCRpZCk7CiAgICAkYXBwcm92ZWRfYnkgPSAkc3VwcGxpZXItPmFwcHJvdmVkX2J5OwogICAgJHN0YXR1cyA9ICRzdXBwbGllci0+c3RhdHVzOwoKICAgIGlmKHJlcXVlc3QoKS0+Z2V0KCd3aGljaCcpID09ICJhcHByb3ZhbCIpewogICAgICAgICRhcHByb3ZlZF9ieSA9IChyZXF1ZXN0KCktPmdldCgndmFsdWUnKSA9PSAiY29uZmlybSIgPyAoYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ1B1cmNoYXNlLURlcGFydG1lbnQnKSA/ICdwdXJjaGFzZS1hcHByb3ZlZCcgOiAnbWFuYWdlbWVudC1hcHByb3ZlZCcpIDogKGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdQdXJjaGFzZS1EZXBhcnRtZW50JykgPyAncHVyY2hhc2UtZGVjbGluZWQnIDogJ21hbmFnZW1lbnQtZGVjbGluZWQnKSk7CgogICAgICAgIGlmKHJlcXVlc3QoKS0+Z2V0KCd2YWx1ZScpID09ICJjb25maXJtIil7CiAgICAgICAgICAgICRtZXNzYWdlRm9yTWFuYWdlbWVudCA9ICc8c3BhbiBjbGFzcz0ibm90aWZpY2F0aW9uLWxpbmtzIiBkYXRhLXNyYz0iJy5yb3V0ZSgncG1zLnN1cHBsaWVyLnByb2ZpbGUnLCRzdXBwbGllci0+aWQpLic/dmlldyIgZGF0YS10aXRsZT0iU3VwcGxpZXJzIERldGFpbHMiPlN1cHBsaWVyOicuJHN1cHBsaWVyLT5uYW1lLicuQSBTdXBwbGllciAnLihyZXF1ZXN0KCktPmdldCgndmFsdWUnKSA9PSAiY29uZmlybSIgPyAnQXBwcm92ZWQnIDogJ0RlY2xpbmVkJykuJyBieSAnLihhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnUHVyY2hhc2UtRGVwYXJ0bWVudCcpID8gJ1B1cmNoYXNlIERlcGFydG1lbnQnIDogJ01hbmFnZW1lbnQnKS4nLjwvc3Bhbj4nOwogICAgICAgIH0KICAgIH1lbHNlaWYocmVxdWVzdCgpLT5nZXQoJ3doaWNoJykgPT0gInN0YXR1cyIpewogICAgICAgICRzdGF0dXMgPSAocmVxdWVzdCgpLT5nZXQoJ3ZhbHVlJykgPT0gImNvbmZpcm0iID8gIkFjdGl2ZSIgOiAiSW5hY3RpdmUiKTsKCiAgICAgICAgaWYocmVxdWVzdCgpLT5nZXQoJ3ZhbHVlJykgPT0gImNvbmZpcm0iKXsKICAgICAgICAgICAgJG1lc3NhZ2UgPSAnPHNwYW4gY2xhc3M9Im5vdGlmaWNhdGlvbi1saW5rcyIgZGF0YS1zcmM9Iicucm91dGUoJ3Btcy5zdXBwbGllci5wcm9maWxlJywkc3VwcGxpZXItPmlkKS4nP3ZpZXciIGRhdGEtdGl0bGU9IlN1cHBsaWVycyBEZXRhaWxzIj5TdXBwbGllcjonLiRzdXBwbGllci0+bmFtZS4nLkEgU3VwcGxpZXIgJy4ocmVxdWVzdCgpLT5nZXQoJ3ZhbHVlJykgPT0gImNvbmZpcm0iID8gIkNvbmZpcm1lZCIgOiAiRGVjbGluZWQiKS4nIGJ5IE1hbmFnZW1lbnQ8L3NwYW4+JzsKICAgICAgICB9CiAgICB9CgogICAgJHN1cHBsaWVyLT5hcHByb3ZlZF9ieSA9ICRhcHByb3ZlZF9ieTsKICAgICRzdXBwbGllci0+c3RhdHVzID0gJHN0YXR1czsKICAgICRzdXBwbGllci0+c2F2ZSgpOwoKICAgIGlmKCRzdXBwbGllci0+YXBwcm92ZWRfYnkgPT0gJ21hbmFnZW1lbnQtYXBwcm92ZWQnKXsKICAgICAgICAkc3VwcGxpZXItPnN0YXR1cyA9ICdBY3RpdmUnOwogICAgICAgICRzdXBwbGllci0+c2F2ZSgpOwogICAgfQoKICAgIGlmKCRzdXBwbGllci0+YXBwcm92ZWRfYnkgPT0gJ21hbmFnZW1lbnQtZGVjbGluZWQnKXsKICAgICAgICAkc3VwcGxpZXItPnN0YXR1cyA9ICdJbmFjdGl2ZSc7CiAgICAgICAgJHN1cHBsaWVyLT5zYXZlKCk7CiAgICB9CgoKICAgIGlmKHN0cmxlbigkbWVzc2FnZSkgPiAxMCl7CiAgICAgICAgQ3JlYXRlT3JVcGRhdGVOb3RpZmljYXRpb24oJG1lc3NhZ2UsICd1bnJlYWQnLCcnLCBnZXRNYW5hZ2VySW5mbygnUHVyY2hhc2UtRGVwYXJ0bWVudCcsIG51bGwsIHRydWUpLCAgJ3NlbnQtdG8tcHVyY2hhc2UnLCAnJyk7CgogICAgICAgIENyZWF0ZU9yVXBkYXRlTm90aWZpY2F0aW9uKCAkbWVzc2FnZSwgJ3VucmVhZCcsICcnLCBbJHN1cHBsaWVyLT5jcmVhdGVkX2J5XSwgJ3JlcXVpc2l0aW9uJyk7CiAgICB9CgogICAgaWYoc3RybGVuKCRtZXNzYWdlRm9yTWFuYWdlbWVudCkgPiAxMCl7CiAgICAgICAgQ3JlYXRlT3JVcGRhdGVOb3RpZmljYXRpb24oICRtZXNzYWdlRm9yTWFuYWdlbWVudCwgJ3VucmVhZCcsICcnLCBnZXRNYW5hZ2VySW5mbygnTWFuYWdlbWVudCcsIG51bGwsIHRydWUpLCdzZW5kLXRvLW1hbmFnZXInKTsKICAgIH0KCiAgICAkc3VwcGxpZXJTdGF0dXMgPSBzdXBwbGllclN0YXR1cygkc3VwcGxpZXIpOwogICAgJGFwcHJvdmFsX2J1dHRvbiA9ICc8YSBjbGFzcz0iYnRuIGJ0bi14cyBidG4tJy4kc3VwcGxpZXJTdGF0dXNbJ2FwcHJvdmVkX2NsYXNzJ10uJyIgZGF0YS1hcHByb3ZlZC1ieT0iJy4kc3VwcGxpZXItPmFwcHJvdmVkX2J5LiciIGRhdGEtc3RhdHVzPSInLiRzdXBwbGllci0+c3RhdHVzLiciICBkYXRhLXdoaWNoPSJhcHByb3ZhbCIgZGF0YS1zdXBwbGllci1pZD0iJy4kc3VwcGxpZXItPmlkLiciICcuKCgkc3VwcGxpZXJTdGF0dXNbJ2FwcHJvdmFsJ10gJiYgKGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdQdXJjaGFzZS1EZXBhcnRtZW50JykgfHwgYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ01hbmFnZW1lbnQnKSkpID8gJ29uY2xpY2s9InRvZ2dsZVN1cHBsaWVyU3RhdHVzKCQodGhpcykpIicgOiAnJykuJz48aSBjbGFzcz0iJy4kc3VwcGxpZXJTdGF0dXNbJ2FwcHJvdmVkX2ljb24nXS4nIj48L2k+Jm5ic3A7Jy4kc3VwcGxpZXJTdGF0dXNbJ2FwcHJvdmVkX3RleHQnXS4nPC9hPic7CiAgICAkc3RhdHVzX2J1dHRvbiA9ICc8YSBjbGFzcz0iYnRuIGJ0bi0nLigkc3VwcGxpZXItPnN0YXR1cyA9PSAiQWN0aXZlIiA/ICJzdWNjZXNzIiA6ICJkYW5nZXIiKS4nIGJ0bi1ibG9jayBidG4teHMiIGRhdGEtYXBwcm92ZWQtYnk9IicuJHN1cHBsaWVyLT5hcHByb3ZlZF9ieS4nIiBkYXRhLXN0YXR1cz0iJy4kc3VwcGxpZXItPnN0YXR1cy4nIiBkYXRhLXdoaWNoPSJzdGF0dXMiIGRhdGEtc3VwcGxpZXItaWQ9IicuJHN1cHBsaWVyLT5pZC4nIiAnLihhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnTWFuYWdlbWVudCcpICYmICRzdXBwbGllci0+YXBwcm92ZWRfYnkgPT0gIm1hbmFnZW1lbnQtYXBwcm92ZWQiID8gJ29uY2xpY2s9InRvZ2dsZVN1cHBsaWVyU3RhdHVzKCQodGhpcykpIicgOiAnJykuJz48aSBjbGFzcz0iJy4oJHN1cHBsaWVyLT5zdGF0dXMgPT0gIkFjdGl2ZSIgPyAibGFyIGxhLWNoZWNrLWNpcmNsZSIgOiAibGEgbGEtYmFuIikuJyI+PC9pPiZuYnNwOycuKCRzdXBwbGllci0+c3RhdHVzID09ICJBY3RpdmUiID8gIkFjdGl2ZSIgOiAiUGVuZGluZyIpLic8L2E+JzsKICAgIAoKICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAnbWVzc2FnZScgPT4gIlN1cHBsaWVyIGhhcyBiZWVuICIuKHJlcXVlc3QoKS0+Z2V0KCd2YWx1ZScpID09ICJjb25maXJtIiA/ICJBcHByb3ZlZCIgOiAiRGVjbGluZWQiKS4iIHN1Y2Nlc3NmdWxseSIsCiAgICAgICAgJ2FwcHJvdmFsX2J1dHRvbicgPT4gJGFwcHJvdmFsX2J1dHRvbiwKICAgICAgICAnc3RhdHVzX2J1dHRvbicgPT4gJHN0YXR1c19idXR0b24sCiAgICBdKTsKfQoKcHVibGljIGZ1bmN0aW9uIGNyZWF0ZVN1cHBsaWVyTG9nKCRzdXBwbGllcl9pZCkKewogICAgJGRhdGEgPSBbCiAgICAgICAgJ3N1cHBsaWVyX2lkJyA9PiAkc3VwcGxpZXJfaWQKICAgIF07CgogICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnN1cHBsaWVycy5sb2dzLmNyZWF0ZScsICRkYXRhKTsKfQoKcHVibGljIGZ1bmN0aW9uIHNhdmVTdXBwbGllckxvZyhSZXF1ZXN0ICRyZXF1ZXN0LCAkc3VwcGxpZXJfaWQpCnsKICAgICRyZXF1ZXN0LT52YWxpZGF0ZShbCiAgICAgICAgJ2RhdGUnID0+ICdyZXF1aXJlZCcsCiAgICAgICAgJ3RvcGljJyA9PiAncmVxdWlyZWQnLAogICAgICAgICdsb2cnID0+ICdyZXF1aXJlZCcsCiAgICBdKTsKCiAgICBEQjo6YmVnaW5UcmFuc2FjdGlvbigpOwogICAgdHJ5ewogICAgICAgICRsb2cgPSBzYXZlU3VwcGxpZXJMb2coJHN1cHBsaWVyX2lkLCAkcmVxdWVzdC0+ZGF0ZSwgJHJlcXVlc3QtPnRvcGljLCAkcmVxdWVzdC0+bG9nKTsKCiAgICAgICAgaWYoJGxvZyl7CiAgICAgICAgICAgIERCOjpjb21taXQoKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnID0+IHRydWUKICAgICAgICAgICAgXSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICdzdWNjZXNzJyA9PiBmYWxzZQogICAgICAgIF0pOwogICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgREI6OnJvbGxiYWNrKCk7CiAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAnc3VjY2VzcycgPT4gZmFsc2UsCiAgICAgICAgICAgICdtZXNzYWdlJyA9PiAkdGgtPmdldE1lc3NhZ2UoKQogICAgICAgIF0pOwogICAgfQp9CgpwdWJsaWMgZnVuY3Rpb24gZWRpdFN1cHBsaWVyTG9nKCRsb2dfaWQpCnsKICAgICRkYXRhID0gWwogICAgICAgICdsb2cnID0+IFN1cHBsaWVyTG9nOjpmaW5kKCRsb2dfaWQpCiAgICBdOwoKICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5zdXBwbGllcnMubG9ncy5lZGl0JywgJGRhdGEpOwp9CgpwdWJsaWMgZnVuY3Rpb24gdXBkYXRlU3VwcGxpZXJMb2coUmVxdWVzdCAkcmVxdWVzdCwgJGxvZ19pZCkKewogICAgJHJlcXVlc3QtPnZhbGlkYXRlKFsKICAgICAgICAnZGF0ZScgPT4gJ3JlcXVpcmVkJywKICAgICAgICAndG9waWMnID0+ICdyZXF1aXJlZCcsCiAgICAgICAgJ2xvZycgPT4gJ3JlcXVpcmVkJywKICAgIF0pOwoKICAgIERCOjpiZWdpblRyYW5zYWN0aW9uKCk7CiAgICB0cnl7CiAgICAgICAgJGxvZyA9IFN1cHBsaWVyTG9nOjpmaW5kKCRsb2dfaWQpOwogICAgICAgICRsb2cgPSBzYXZlU3VwcGxpZXJMb2coJGxvZy0+c3VwcGxpZXJfaWQsICRyZXF1ZXN0LT5kYXRlLCAkcmVxdWVzdC0+dG9waWMsICRyZXF1ZXN0LT5sb2csICRsb2ctPmlkKTsKCiAgICAgICAgaWYoJGxvZyl7CiAgICAgICAgICAgIERCOjpjb21taXQoKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnID0+IHRydWUKICAgICAgICAgICAgXSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICdzdWNjZXNzJyA9PiBmYWxzZQogICAgICAgIF0pOwogICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgREI6OnJvbGxiYWNrKCk7CiAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAnc3VjY2VzcycgPT4gZmFsc2UsCiAgICAgICAgICAgICdtZXNzYWdlJyA9PiAkdGgtPmdldE1lc3NhZ2UoKQogICAgICAgIF0pOwogICAgfQp9CgpwdWJsaWMgZnVuY3Rpb24gZGVsZXRlU3VwcGxpZXJMb2coJGxvZ19pZCkKewogICAgREI6OmJlZ2luVHJhbnNhY3Rpb24oKTsKICAgIHRyeXsKICAgICAgICAkbG9nID0gU3VwcGxpZXJMb2c6OmZpbmQoJGxvZ19pZCktPmRlbGV0ZSgpOwoKICAgICAgICBpZigkbG9nKXsKICAgICAgICAgICAgREI6OmNvbW1pdCgpOwogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gdHJ1ZSwKICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAnTG9nIGhhcyBiZWVuIGRlbGV0ZWQnCiAgICAgICAgICAgIF0pOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAnc3VjY2VzcycgPT4gZmFsc2UsCiAgICAgICAgICAgICdtZXNzYWdlJyA9PiAnU29tZXRoaW5nIHdlbnQgd3JvbmchJwogICAgICAgIF0pOwogICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgREI6OnJvbGxiYWNrKCk7CiAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAnc3VjY2VzcycgPT4gZmFsc2UsCiAgICAgICAgICAgICdtZXNzYWdlJyA9PiAkdGgtPmdldE1lc3NhZ2UoKQogICAgICAgIF0pOwogICAgfQp9CgoKcHVibGljIGZ1bmN0aW9uIGNhdGVnb3J5V2lzZVByb2R1Y3RzKFJlcXVlc3QgJHJlcXVlc3QpCnsKICAgICRwcm9kdWN0cyA9IFByb2R1Y3Q6OndpdGgoWwogICAgICAgICdhdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGUnCiAgICBdKQogICAgLT53aGVyZUluKCdjYXRlZ29yeV9pZCcsICRyZXF1ZXN0LT5zdWJfY2F0ZWdvcmllcykKICAgIC0+d2hlcmUoJ3N0YXR1cycsICdhcHByb3ZlZCcpLT5nZXQoKTsKICAgICRkYXRhID0gJyc7CiAgICBpZihpc3NldCgkcHJvZHVjdHNbMF0pKXsKICAgICAgICBmb3JlYWNoKCRwcm9kdWN0cyBhcyAka2V5ID0+ICRwcm9kdWN0KXsKICAgICAgICAgICAgJHNlbGVjdGVkID0gKGlzc2V0KCRyZXF1ZXN0LT5zZWxlY3RlZF9wcm9kdWN0c1swXSkgPyAoaW5fYXJyYXkoJHByb2R1Y3QtPmlkLCAkcmVxdWVzdC0+c2VsZWN0ZWRfcHJvZHVjdHMpID8gJ3NlbGVjdGVkJyA6ICcnKSA6ICcnKTsKICAgICAgICAgICAgJGRhdGEgLj0gJzxvcHRpb24gdmFsdWU9IicuJHByb2R1Y3QtPmlkLiciICcuJHNlbGVjdGVkLic+Jy4kcHJvZHVjdC0+bmFtZS4nICcuZ2V0UHJvZHVjdEF0dHJpYnV0ZXNGYXN0ZXIoJHByb2R1Y3QpLic8L29wdGlvbj4nOwogICAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gJGRhdGE7Cgp9CgpwdWJsaWMgZnVuY3Rpb24gc3VwcGxpZXJDb2RlKCRzdXBwbGllciA9IGZhbHNlKQp7CiAgICAkY291bnQgPSBTdXBwbGllcnM6OndoZW4oJHN1cHBsaWVyLCBmdW5jdGlvbigkcXVlcnkpIHVzZSgkc3VwcGxpZXIpewogICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdpZCcsICc8JywgJHN1cHBsaWVyLT5pZCkKICAgICAgICAtPndoZXJlKERCOjpyYXcoJ3N1YnN0cihgY3JlYXRlZF9hdGAsIDEsIDQpJyksIGRhdGUoJ1knLCBzdHJ0b3RpbWUoJHN1cHBsaWVyLT5jcmVhdGVkX2F0KSkpOwogICAgfSkKICAgIC0+d2hlbighJHN1cHBsaWVyLCBmdW5jdGlvbigkcXVlcnkpewogICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKERCOjpyYXcoJ3N1YnN0cihgY3JlYXRlZF9hdGAsIDEsIDQpJyksIGRhdGUoJ1knKSk7CiAgICB9KQogICAgLT5jb3VudCgpOwoKICAgIHJldHVybiAoJHN1cHBsaWVyID8gZGF0ZSgneScsIHN0cnRvdGltZSgkc3VwcGxpZXItPmNyZWF0ZWRfYXQpKSA6IGRhdGUoJ3knKSkuc3ByaW50ZigiJTA0ZCIsICRjb3VudCsxKTsKfQoKfQo=