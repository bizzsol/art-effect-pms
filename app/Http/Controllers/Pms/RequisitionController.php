<?php
bolt_decrypt( __FILE__ , 'VCnWVL'); return 0;
##!!!##CgpuYW1lc3BhY2UgQXBwXEh0dHBcQ29udHJvbGxlcnNcUG1zOwoKdXNlIEFwcFxIdHRwXENvbnRyb2xsZXJzXENvbnRyb2xsZXI7Cgp1c2UgQXBwXE1vZGVsc1xNeVByb2plY3RcRGVsaXZlcmFibGVzOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcTWVudVxNZW51Owp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUHJvZHVjdDsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFJlcXVpc2l0aW9uRXhwbGFuYXRpb247CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xSZXF1aXNpdGlvbjsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFJlcXVlc3RQcm9wb3NhbFJlcXVpc2l0aW9uczsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFJlcXVpc2l0aW9uSXRlbUxvZzsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFJlcXVpc2l0aW9uTG9nOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUmVxdWlzaXRpb25UcmFja2luZzsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFJlcXVpc2l0aW9uSXRlbTsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFJlcXVpc2l0aW9uSXRlbUF0dHJpYnV0ZTsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFJlcXVpc2l0aW9uVHlwZTsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXENhdGVnb3J5Owp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcQ2F0ZWdvcnlEZXBhcnRtZW50Owp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcTm90aWZpY2F0aW9uOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUmVxdWlzaXRpb25EZWxpdmVyeTsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFJlcXVpc2l0aW9uRGVsaXZlcnlJdGVtOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcQXR0cmlidXRlOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcQXR0cmlidXRlT3B0aW9uOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcQ2F0ZWdvcnlBdHRyaWJ1dGU7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xSZXF1aXNpdGlvbk5vdGVMb2dzOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUHVyY2hhc2VcUHVyY2hhc2VPcmRlcjsKdXNlIEFwcFxNb2RlbHNcTXlQcm9qZWN0XFByb2plY3Q7CnVzZSBBcHBcTW9kZWxzXE15UHJvamVjdFxQcm9qZWN0VGFzazsKdXNlIElsbHVtaW5hdGVcSHR0cFxSZXF1ZXN0Owp1c2UgTWFhdHdlYnNpdGVcRXhjZWxcRmFjYWRlc1xFeGNlbDsKdXNlIFZpZXc7CnVzZSBBcHBcSHR0cFxSZXF1ZXN0czsKdXNlIElsbHVtaW5hdGVcU3VwcG9ydFxGYWNhZGVzXEF1dGg7CnVzZSBJbGx1bWluYXRlXFN1cHBvcnRcRmFjYWRlc1xEQiwgVmFsaWRhdG9yLCBTdHIsIFlhanJhXERhdGFUYWJsZXNcRmFjYWRlc1xEYXRhVGFibGVzOwp1c2UgQ2FyYm9uXENhcmJvbjsKdXNlIFxBcHBcSW1wb3J0c1xSZXF1aXNpdGlvbkltcG9ydDsKCmNsYXNzIFJlcXVpc2l0aW9uQ29udHJvbGxlciBleHRlbmRzIENvbnRyb2xsZXIKewoKICAgIHB1YmxpYyBmdW5jdGlvbiBoZWFkZXJDb2x1bW5zKCR2YWx1ZSA9ICcnKQogICAgewogICAgICAgICRyb3cgPSBhcnJheSgKICAgICAgICAgICAgWydTTCcsICdTTCddLAogICAgICAgICAgICBbJ3JlZmVyZW5jZV9ubycsICdyZWZlcmVuY2Vfbm8nLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydyZXF1aXNpdGlvbl9kYXRlJywgJ3JlcXVpc2l0aW9uX2RhdGUnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydwcm9kdWN0X2NhdGVnb3J5JywgJ3Byb2R1Y3RfY2F0ZWdvcnknLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydzdGF0dXMnLCAnc3RhdHVzJywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsnYXR0YWNobWVudCcsICdhdHRhY2htZW50JywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsnYWN0aW9ucycsICdhY3Rpb25zJywgJ3RleHQtY2VudGVyJywgJ3dpZHRoOjE1JSddCiAgICAgICAgKTsKCiAgICAgICAgaWYgKGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdFbXBsb3llZScpIHx8IGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdEZXBhcnRtZW50LUhlYWQnKSB8fCBhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnUHVyY2hhc2UtRGVwYXJ0bWVudCcpKSB7CgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHVuc2V0KCRyb3dbNV0pOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuICRyb3c7CiAgICB9CgogICAgLyoqCiAgICAgKiBEaXNwbGF5IGEgbGlzdGluZyBvZiB0aGUgcmVzb3VyY2UuCiAgICAgKgogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KICAgIHB1YmxpYyBmdW5jdGlvbiBpbmRleCgpCiAgICB7CiAgICAgICAgdHJ5IHsKCiAgICAgICAgICAgICRzdGF0dXMgPSByZXF1ZXN0KCktPmhhcygnc3RhdHVzJykgPyByZXF1ZXN0KCktPmdldCgnc3RhdHVzJykgOiAtMTsKICAgICAgICAgICAgJGZyb20gPSByZXF1ZXN0KCktPmhhcygnZnJvbScpID8gcmVxdWVzdCgpLT5nZXQoJ2Zyb20nKSA6IGRhdGUoJ1ktbS0wMScpOwogICAgICAgICAgICAkdG8gPSByZXF1ZXN0KCktPmhhcygndG8nKSA/IHJlcXVlc3QoKS0+Z2V0KCd0bycpIDogZGF0ZSgnWS1tLXQnKTsKICAgICAgICAgICAgJGNhdGVnb3J5X2lkID0gcmVxdWVzdCgpLT5oYXMoJ2NhdGVnb3J5X2lkJykgPyByZXF1ZXN0KCktPmdldCgnY2F0ZWdvcnlfaWQnKSA6IDA7CiAgICAgICAgICAgICRjYXRlZ29yeUlkcyA9IENhdGVnb3J5RGVwYXJ0bWVudDo6d2hlbihpc3NldChhdXRoKCktPnVzZXIoKS0+ZW1wbG95ZWUtPmFzX2RlcGFydG1lbnRfaWQpLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnaHJfZGVwYXJ0bWVudF9pZCcsIGF1dGgoKS0+dXNlcigpLT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCk7CiAgICAgICAgICAgIH0pLT5wbHVjaygnY2F0ZWdvcnlfaWQnKS0+dG9BcnJheSgpOwoKICAgICAgICAgICAgJGNhdGVnb3JpZXMgPSBDYXRlZ29yeTo6ZG9lc250SGF2ZSgnY2F0ZWdvcnknKQogICAgICAgICAgICAgICAgLT53aGVyZUluKCdpZCcsICRjYXRlZ29yeUlkcykKICAgICAgICAgICAgICAgIC0+Z2V0KCk7CgogICAgICAgICAgICAkcmVxdWlzaXRpb25zID0gUmVxdWlzaXRpb246OndpdGgoWydpdGVtcycsICdpdGVtcy5wcm9kdWN0LmNhdGVnb3J5LmNhdGVnb3J5JywgJ3JlcXVpc2l0aW9uTG9ncyddKQogICAgICAgICAgICAgICAgLT53aGVyZSgnYXV0aG9yX2lkJywgYXV0aCgpLT51c2VyKCktPmlkKQogICAgICAgICAgICAgICAgLT53aGVuKHN0cnRvdGltZSgkZnJvbSkgPiAwLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRmcm9tKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVEYXRlKCdyZXF1aXNpdGlvbl9kYXRlJywgJz49JywgJGZyb20pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+d2hlbihzdHJ0b3RpbWUoJHRvKSA+IDAsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJHRvKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVEYXRlKCdyZXF1aXNpdGlvbl9kYXRlJywgJzw9JywgJHRvKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPndoZW4oJHN0YXR1cyA+PSAwLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRzdGF0dXMpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnc3RhdHVzJywgJHN0YXR1cyk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT53aGVuKCRjYXRlZ29yeV9pZCA+IDAsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGNhdGVnb3J5X2lkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ2l0ZW1zLnByb2R1Y3QuY2F0ZWdvcnkuY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRjYXRlZ29yeV9pZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnaWQnLCAkY2F0ZWdvcnlfaWQpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+d2hlbighZW1wdHkocmVxdWVzdCgpLT5nZXQoJ3NlYXJjaF90ZXh0JykpLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgncmVmZXJlbmNlX25vJywgJ0xJS0UnLCAnJScgLiByZXF1ZXN0KCktPmdldCgnc2VhcmNoX3RleHQnKSAuICclJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+b3JXaGVyZSgncmVtYXJrcycsICdMSUtFJywgJyUnIC4gcmVxdWVzdCgpLT5nZXQoJ3NlYXJjaF90ZXh0JykgLiAnJScpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+d2hlbighZGF0YXRhYmxlT3JkZXJpbmcoKSwgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyYnkoJ2lkJywgJ2Rlc2MnKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPndoZXJlKCdhc3Nlc3NtZW50JywgJ25vJykKICAgICAgICAgICAgICAgIC0+d2hlcmVOb3RJbignc3RhdHVzJywgWzJdKTsKCiAgICAgICAgICAgIGlmIChyZXF1ZXN0KCktPmFqYXgoKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIERhdGF0YWJsZXM6Om9mKCRyZXF1aXNpdGlvbnMpCiAgICAgICAgICAgICAgICAgICAgLT5hZGRJbmRleENvbHVtbigpCiAgICAgICAgICAgICAgICAgICAgLT5lZGl0Q29sdW1uKCdyZWZlcmVuY2Vfbm8nLCBmdW5jdGlvbiAoJHJlcXVpc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnPGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiBkYXRhLXNyYz0iJyAuIHJvdXRlKCdwbXMucmVxdWlzaXRpb24ubGlzdC52aWV3LnNob3cnLCAkcmVxdWlzaXRpb24tPmlkKSAuICciIGNsYXNzPSJidG4gYnRuLWxpbmsgcmVxdWlzaXRpb24gbS0xIHJvdW5kZWQgc2hvd1JlcXVpc3Rpb25EZXRhaWxzIiBvbmNsaWNrPSJyZXF1aXN0aW9uRGV0YWlscygkKHRoaXMpKSI+JyAuICRyZXF1aXNpdGlvbi0+cmVmZXJlbmNlX25vIC4gJzwvYT4nOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3JlcXVpc2l0aW9uX2RhdGUnLCBmdW5jdGlvbiAoJHJlcXVpc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkYXRlKCdZLW0tZCcsIHN0cnRvdGltZSgkcmVxdWlzaXRpb24tPnJlcXVpc2l0aW9uX2RhdGUpKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdyZXF1aXNpdGlvbl9kYXRlJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgncmVxdWlzaXRpb25fZGF0ZScsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbigncmVxdWlzaXRpb25fZGF0ZScsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT5vcmRlckJ5KCdyZXF1aXNpdGlvbl9kYXRlJywgJG9yZGVyKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdwcm9kdWN0X2NhdGVnb3J5JywgZnVuY3Rpb24gKCRyZXF1aXNpdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNzZXQoJHJlcXVpc2l0aW9uLT5pdGVtc1swXS0+cHJvZHVjdC0+Y2F0ZWdvcnktPmNhdGVnb3J5LT5uYW1lKSA/ICRyZXF1aXNpdGlvbi0+aXRlbXNbMF0tPnByb2R1Y3QtPmNhdGVnb3J5LT5jYXRlZ29yeS0+bmFtZSA6ICcnOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3Byb2R1Y3RfY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygnaXRlbXMucHJvZHVjdC5jYXRlZ29yeS5jYXRlZ29yeScsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdwcm9kdWN0X2NhdGVnb3J5JywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwbGVhc2VTb3J0TWUoJHF1ZXJ5LCAkb3JkZXIsIFJlcXVpc2l0aW9uSXRlbTo6c2VsZWN0KCdtYWluX2NhdGVnb3J5Lm5hbWUnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdwcm9kdWN0cycsICdwcm9kdWN0cy5pZCcsICc9JywgJ3JlcXVpc2l0aW9uX2l0ZW1zLnByb2R1Y3RfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdjYXRlZ29yaWVzIGFzIHN1Yl9jYXRlZ29yeScsICdzdWJfY2F0ZWdvcnkuaWQnLCAnPScsICdwcm9kdWN0cy5jYXRlZ29yeV9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ2NhdGVnb3JpZXMgYXMgbWFpbl9jYXRlZ29yeScsICdtYWluX2NhdGVnb3J5LmlkJywgJz0nLCAnc3ViX2NhdGVnb3J5LnBhcmVudF9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCdyZXF1aXNpdGlvbl9pdGVtcy5yZXF1aXNpdGlvbl9pZCcsICdyZXF1aXNpdGlvbnMuaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT50YWtlKDEpCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmVkaXRDb2x1bW4oJ3N0YXR1cycsIGZ1bmN0aW9uICgkcmVxdWlzaXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHN0YXR1cyA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICAkc3RhdHVzIC49ICc8cCBpZD0ic3RhdHVzJyAuICRyZXF1aXNpdGlvbi0+aWQgLiAnIj4nOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHJlcXVpc2l0aW9uLT5zdGF0dXMgPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHN0YXR1cyAuPSAnPHNwYW4gY2xhc3M9ImJ0biBidG4teHMgYnRuLXdhcm5pbmciPlBlbmRpbmc8L3NwYW4+JzsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlaWYgKCRyZXF1aXNpdGlvbi0+c3RhdHVzID09IDEpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc3RhdHVzIC49ICc8c3BhbiBjbGFzcz0iYnRuIGJ0bi14cyBidG4tc3VjY2VzcyI+QXBwcm92ZWQ8L3NwYW4+JzsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlaWYgKCRyZXF1aXNpdGlvbi0+c3RhdHVzID09IDIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzdGF0dXMgLj0gJzxzcGFuIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi1kYW5nZXIiPkhhbHQ8L3NwYW4+JzsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlaWYgKCRyZXF1aXNpdGlvbi0+c3RhdHVzID09IDMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzdGF0dXMgLj0gJzxzcGFuIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi13YXJuaW5nIj5EcmFmdDwvc3Bhbj4nOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICRzdGF0dXMgLj0gJzwvcD4nOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHN0YXR1czsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdhdHRhY2htZW50JywgZnVuY3Rpb24gKCRyZXF1aXNpdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAkYXR0YWNobWVudCA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ0VtcGxveWVlJykgfHwgYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ0RlcGFydG1lbnQtSGVhZCcpIHx8IGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdQdXJjaGFzZS1EZXBhcnRtZW50JykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZW1wdHkoJHJlcXVpc2l0aW9uLT5hdHRhY2htZW50KSAmJiBmaWxlX2V4aXN0cyhwdWJsaWNfcGF0aCgkcmVxdWlzaXRpb24tPmF0dGFjaG1lbnQpKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhdHRhY2htZW50IC49ICc8YSBocmVmPSInIC4gdXJsKCRyZXF1aXNpdGlvbi0+YXR0YWNobWVudCkgLiAnIiB0YXJnZXQ9Il9ibGFuayIgY2xhc3M9ImJ0biBidG4teHMgYnRuLXByaW1hcnkiPjxpIGNsYXNzPSJsYXMgbGEtcGFwZXJjbGlwIj48L2k+QXR0YWNobWVudDwvYT4nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGF0dGFjaG1lbnQ7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignYWN0aW9ucycsIGZ1bmN0aW9uICgkcmVxdWlzaXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgPSAnJzsKCiAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICc8ZGl2IGNsYXNzPSJidG4tZ3JvdXAiPjxidXR0b24gY2xhc3M9ImJ0biBkcm9wZG93bi10b2dnbGUiIGRhdGEtdG9nZ2xlPSJkcm9wZG93biI+PHNwYW4gaWQ9InN0YXR1c05hbWUnIC4gJHJlcXVpc2l0aW9uLT5pZCAuICciPjxpIGNsYXNzPSJsYSBsYS1lbGxpcHNpcy12Ij48L2k+PC9zcGFuPjwvYnV0dG9uPjx1bCBjbGFzcz0iZHJvcGRvd24tbWVudSI+PGxpPjxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgdGl0bGU9IlRyYWNraW5nIFJlcXVpc2l0aW9uIiBkYXRhLXNyYz0iJyAuIHJvdXRlKCdwbXMucmVxdWlzaXRpb24ubGlzdC52aWV3LnNob3cnLCAkcmVxdWlzaXRpb24tPmlkKSAuICciIGNsYXNzPSJzaG93UmVxdWlzdGlvbkRldGFpbHMiICBvbmNsaWNrPSJyZXF1aXN0aW9uRGV0YWlscygkKHRoaXMpKSI+PGkgY2xhc3M9ImxhIGxhLWV5ZSI+PC9pPiZuYnNwO1ZpZXc8L2E+PC9saT4nOwoKICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxsaT48YSBocmVmPSInIC4gcm91dGUoJ3Btcy5yZXF1aXNpdGlvbi5yZXF1aXNpdGlvbi5lZGl0JywgJHJlcXVpc2l0aW9uLT5pZCkgLiAnP3JlZGlyZWN0PXJlcXVpc2l0aW9uJmVkaXRvcj1hdXRob3IiIHRpdGxlPSJDbGljayBIZXJlIFRvIEVkaXQiIGNsYXNzPSJyZXF1aXNpdGlvbi1lZGl0Ij48aSBjbGFzcz0ibGEgbGEtZWRpdCI+PC9pPiZuYnNwO0VkaXQ8L2E+PC9saT4nOwoKICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxsaT48YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIGRhdGEtcm9sZT0iZHVwbGljYXRlIiBkYXRhLXNyYz0iJyAuIHJvdXRlKCdwbXMucmVxdWlzaXRpb24uZHVwbGljYXRlJywgJHJlcXVpc2l0aW9uLT5pZCkgLiAnIiBjbGFzcz0idGV4dC1kYW5nZXIgZGVsZXRlQnRuIHJlcXVpc2l0aW9uLWR1cGxpY2F0ZSIgb25jbGljaz0iZHVwbGljYXRlUmVxdWlzaXRpb24oJCh0aGlzKSkiPjxpIGNsYXNzPSJsYXMgbGEtY29weSI+PC9pPiZuYnNwO0R1cGxpY2F0ZTwvYT48L2xpPic7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHJlcXVpc2l0aW9uLT5zdGF0dXMgPT0gMykgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICc8bGk+PGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiAgb25jbGljaz0ic2VuZFJlcXVpc2l0aW9uKCQodGhpcykpIiBjbGFzcz0ic2VuZFJlcXVpc2l0aW9uIiBkYXRhLWlkPSInIC4gJHJlcXVpc2l0aW9uLT5pZCAuICciIGRhdGEtc3RhdHVzPSIwIiB0aXRsZT0iQ2xpY2sgSGVyZSBUbyBTZW5kIj48aSBjbGFzcz0ibGEgbGEtcGFwZXItcGxhbmUiPjwvaT4mbmJzcDtTZW5kPC9hPjwvbGk+JzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICc8bGk+PGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiBkYXRhLXJvbGU9ImRlbGV0ZSIgZGF0YS1zcmM9IicgLiByb3V0ZSgncG1zLnJlcXVpc2l0aW9uLnJlcXVpc2l0aW9uLmRlc3Ryb3knLCAkcmVxdWlzaXRpb24tPmlkKSAuICciIGNsYXNzPSJ0ZXh0LWRhbmdlciBkZWxldGVCdG4gcmVxdWlzaXRpb24tZGVsZXRlIiBvbmNsaWNrPSJkZWxldGVCdG4oJCh0aGlzKSkiPjxpIGNsYXNzPSJsYXMgbGEtdHJhc2giPjwvaT4mbmJzcDtEZWxldGU8L2E+PC9saT4nOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHJlcXVpc2l0aW9uLT5yZXF1aXNpdGlvbkxvZ3MtPmNvdW50KCkgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnPGxpPjxhIHRhcmdldD0iX19ibGFuayIgaHJlZj0iJyAuIHJvdXRlKCdwbXMucmVxdWlzaXRpb24ubG9nLmhpc3RvcnknLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb24tPmlkKSAuICciPjxpIGNsYXNzPSJsYSBsYS1oaXN0b3J5IiB0aXRsZT0iUmVxdWlzaXRpb24gTG9nIEhpc3RvcnkiPjwvaT4mbmJzcDtSZXF1aXNpdGlvbiBMb2dzPC9hPjwvbGk8L2E+PC9saT4nOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnPGxpPjxhIHRhcmdldD0iX19ibGFuayIgaHJlZj0iJyAuIHJvdXRlKCdwbXMucmVxdWlzaXRpb24uaGlzdG9yeScsICRyZXF1aXNpdGlvbi0+aWQpIC4gJyI+PGkgY2xhc3M9ImxhIGxhLWhpc3RvcnkiIHRpdGxlPSJSZXF1aXNpdGlvbiBIaXN0b3J5Ij48L2k+Jm5ic3A7UmVxdWlzaXRpb24gSGlzdG9yeTwvYT48L2xpPC9hPjwvbGk+JzsKCiAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICc8bGk+PGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiB0aXRsZT0iVHJhY2tpbmcgUmVxdWlzaXRpb24iIGNsYXNzPSJ0cmFja2luZ1JlcXVpc3Rpb25TdGF0dXMiIG9uY2xpY2s9InRyYWNraW5nUmVxdWlzaXRpb25TdGF0dXMoJCh0aGlzKSkiIGRhdGEtaWQ9IicgLiAkcmVxdWlzaXRpb24tPmlkIC4gJyI+PGkgY2xhc3M9ImxhIGxhLW1hcCI+PC9pPiZuYnNwO1RyYWNrIFByb2dyZXNzPC9hPjwvbGk+PC91bD48L2Rpdj4nOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGFjdGlvbnM7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPnJhd0NvbHVtbnMoWydyZWZlcmVuY2Vfbm8nLCAnc3RhdHVzJywgJ2F0dGFjaG1lbnQnLCAnYWN0aW9ucyddKQogICAgICAgICAgICAgICAgICAgIC0+bWFrZSh0cnVlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnJlcXVpc2l0aW9ucy5pbmRleCcsIFsndGl0bGUnID0+ICdSZXF1aXNpdGlvbicsCiAgICAgICAgICAgICAgICAnZnJvbScgPT4gJGZyb20sICd0bycgPT4gJHRvLCAnY2F0ZWdvcnlfaWQnID0+ICRjYXRlZ29yeV9pZCwgJ2NhdGVnb3JpZXMnID0+ICRjYXRlZ29yaWVzLCAnaGVhZGVyQ29sdW1ucycgPT4gJHRoaXMtPmhlYWRlckNvbHVtbnMoKV0pOwoKICAgICAgICB9IGNhdGNoIChcVGhyb3dhYmxlICR0aCkgewogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCiAgICBwdWJsaWMgZnVuY3Rpb24gaGFsdCgpCiAgICB7CiAgICAgICAgdHJ5IHsKCiAgICAgICAgICAgICR0aXRsZSA9ICdIYWx0IFJlcXVpc2l0aW9ucyc7CgogICAgICAgICAgICAkZnJvbSA9IHJlcXVlc3QoKS0+aGFzKCdmcm9tJykgPyByZXF1ZXN0KCktPmdldCgnZnJvbScpIDogZGF0ZSgnWS1tLTAxJyk7CiAgICAgICAgICAgICR0byA9IHJlcXVlc3QoKS0+aGFzKCd0bycpID8gcmVxdWVzdCgpLT5nZXQoJ3RvJykgOiBkYXRlKCdZLW0tdCcpOwogICAgICAgICAgICAkY2F0ZWdvcnlfaWQgPSByZXF1ZXN0KCktPmhhcygnY2F0ZWdvcnlfaWQnKSA/IHJlcXVlc3QoKS0+Z2V0KCdjYXRlZ29yeV9pZCcpIDogMDsKICAgICAgICAgICAgJGNhdGVnb3J5SWRzID0gQ2F0ZWdvcnlEZXBhcnRtZW50Ojp3aGVuKGlzc2V0KGF1dGgoKS0+dXNlcigpLT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCksIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdocl9kZXBhcnRtZW50X2lkJywgYXV0aCgpLT51c2VyKCktPmVtcGxveWVlLT5hc19kZXBhcnRtZW50X2lkKTsKICAgICAgICAgICAgfSktPnBsdWNrKCdjYXRlZ29yeV9pZCcpLT50b0FycmF5KCk7CgogICAgICAgICAgICAkY2F0ZWdvcmllcyA9IENhdGVnb3J5Ojpkb2VzbnRIYXZlKCdjYXRlZ29yeScpCiAgICAgICAgICAgICAgICAtPndoZXJlSW4oJ2lkJywgJGNhdGVnb3J5SWRzKQogICAgICAgICAgICAgICAgLT5nZXQoKTsKCiAgICAgICAgICAgICRyZXF1aXNpdGlvbnMgPSBSZXF1aXNpdGlvbjo6d2l0aChbJ2l0ZW1zJywgJ2l0ZW1zLnByb2R1Y3QuY2F0ZWdvcnkuY2F0ZWdvcnknXSkKICAgICAgICAgICAgICAgIC0+d2hlbihpc3NldChhdXRoKCktPnVzZXIoKS0+ZW1wbG95ZWUtPmFzX2RlcGFydG1lbnRfaWQpLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2F1dGhvcl9pZCcsIGF1dGgoKS0+dXNlcigpLT5pZCk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT53aGVuKHN0cnRvdGltZSgkZnJvbSkgPiAwLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRmcm9tKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVEYXRlKCdyZXF1aXNpdGlvbl9kYXRlJywgJz49JywgJGZyb20pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+d2hlbihzdHJ0b3RpbWUoJHRvKSA+IDAsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJHRvKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVEYXRlKCdyZXF1aXNpdGlvbl9kYXRlJywgJzw9JywgJHRvKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPndoZW4oJGNhdGVnb3J5X2lkID4gMCwgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgkY2F0ZWdvcnlfaWQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygnaXRlbXMucHJvZHVjdC5jYXRlZ29yeS5jYXRlZ29yeScsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGNhdGVnb3J5X2lkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdpZCcsICRjYXRlZ29yeV9pZCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT53aGVuKCFlbXB0eShyZXF1ZXN0KCktPmdldCgnc2VhcmNoX3RleHQnKSksIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZShmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdyZWZlcmVuY2Vfbm8nLCAnTElLRScsICclJyAuIHJlcXVlc3QoKS0+Z2V0KCdzZWFyY2hfdGV4dCcpIC4gJyUnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5vcldoZXJlKCdyZW1hcmtzJywgJ0xJS0UnLCAnJScgLiByZXF1ZXN0KCktPmdldCgnc2VhcmNoX3RleHQnKSAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT53aGVuKCFkYXRhdGFibGVPcmRlcmluZygpLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+b3JkZXJieSgnaWQnLCAnZGVzYycpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+d2hlcmVJbignc3RhdHVzJywgWzJdKTsKCiAgICAgICAgICAgIGlmIChyZXF1ZXN0KCktPmFqYXgoKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIERhdGF0YWJsZXM6Om9mKCRyZXF1aXNpdGlvbnMpCiAgICAgICAgICAgICAgICAgICAgLT5hZGRJbmRleENvbHVtbigpCiAgICAgICAgICAgICAgICAgICAgLT5lZGl0Q29sdW1uKCdyZWZlcmVuY2Vfbm8nLCBmdW5jdGlvbiAoJHJlcXVpc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnPGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiBkYXRhLXNyYz0iJyAuIHJvdXRlKCdwbXMucmVxdWlzaXRpb24ubGlzdC52aWV3LnNob3cnLCAkcmVxdWlzaXRpb24tPmlkKSAuICciIGNsYXNzPSJidG4gYnRuLWxpbmsgcmVxdWlzaXRpb24gbS0xIHJvdW5kZWQgc2hvd1JlcXVpc3Rpb25EZXRhaWxzIiBvbmNsaWNrPSJyZXF1aXN0aW9uRGV0YWlscygkKHRoaXMpKSI+JyAuICRyZXF1aXNpdGlvbi0+cmVmZXJlbmNlX25vIC4gJzwvYT4nOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3JlcXVpc2l0aW9uX2RhdGUnLCBmdW5jdGlvbiAoJHJlcXVpc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkYXRlKCdZLW0tZCcsIHN0cnRvdGltZSgkcmVxdWlzaXRpb24tPnJlcXVpc2l0aW9uX2RhdGUpKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdyZXF1aXNpdGlvbl9kYXRlJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgncmVxdWlzaXRpb25fZGF0ZScsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbigncmVxdWlzaXRpb25fZGF0ZScsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT5vcmRlckJ5KCdyZXF1aXNpdGlvbl9kYXRlJywgJG9yZGVyKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdwcm9kdWN0X2NhdGVnb3J5JywgZnVuY3Rpb24gKCRyZXF1aXNpdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNzZXQoJHJlcXVpc2l0aW9uLT5pdGVtc1swXS0+cHJvZHVjdC0+Y2F0ZWdvcnktPmNhdGVnb3J5LT5uYW1lKSA/ICRyZXF1aXNpdGlvbi0+aXRlbXNbMF0tPnByb2R1Y3QtPmNhdGVnb3J5LT5jYXRlZ29yeS0+bmFtZSA6ICcnOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3Byb2R1Y3RfY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygnaXRlbXMucHJvZHVjdC5jYXRlZ29yeS5jYXRlZ29yeScsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdwcm9kdWN0X2NhdGVnb3J5JywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwbGVhc2VTb3J0TWUoJHF1ZXJ5LCAkb3JkZXIsIFJlcXVpc2l0aW9uSXRlbTo6c2VsZWN0KCdtYWluX2NhdGVnb3J5Lm5hbWUnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdwcm9kdWN0cycsICdwcm9kdWN0cy5pZCcsICc9JywgJ3JlcXVpc2l0aW9uX2l0ZW1zLnByb2R1Y3RfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdjYXRlZ29yaWVzIGFzIHN1Yl9jYXRlZ29yeScsICdzdWJfY2F0ZWdvcnkuaWQnLCAnPScsICdwcm9kdWN0cy5jYXRlZ29yeV9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ2NhdGVnb3JpZXMgYXMgbWFpbl9jYXRlZ29yeScsICdtYWluX2NhdGVnb3J5LmlkJywgJz0nLCAnc3ViX2NhdGVnb3J5LnBhcmVudF9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCdyZXF1aXNpdGlvbl9pdGVtcy5yZXF1aXNpdGlvbl9pZCcsICdyZXF1aXNpdGlvbnMuaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT50YWtlKDEpCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmVkaXRDb2x1bW4oJ3N0YXR1cycsIGZ1bmN0aW9uICgkcmVxdWlzaXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHN0YXR1cyA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICAkc3RhdHVzIC49ICc8cCBpZD0ic3RhdHVzJyAuICRyZXF1aXNpdGlvbi0+aWQgLiAnIj4nOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHJlcXVpc2l0aW9uLT5zdGF0dXMgPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHN0YXR1cyAuPSAnPHNwYW4gY2xhc3M9ImJ0biBidG4teHMgYnRuLXdhcm5pbmciPlBlbmRpbmc8L3NwYW4+JzsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlaWYgKCRyZXF1aXNpdGlvbi0+c3RhdHVzID09IDEpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc3RhdHVzIC49ICc8c3BhbiBjbGFzcz0iYnRuIGJ0bi14cyBidG4tc3VjY2VzcyI+QXBwcm92ZWQ8L3NwYW4+JzsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlaWYgKCRyZXF1aXNpdGlvbi0+c3RhdHVzID09IDIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzdGF0dXMgLj0gJzxzcGFuIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi1kYW5nZXIiPkhhbHQ8L3NwYW4+JzsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlaWYgKCRyZXF1aXNpdGlvbi0+c3RhdHVzID09IDMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzdGF0dXMgLj0gJzxzcGFuIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi13YXJuaW5nIj5EcmFmdDwvc3Bhbj4nOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICRzdGF0dXMgLj0gJzwvcD4nOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHN0YXR1czsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdhdHRhY2htZW50JywgZnVuY3Rpb24gKCRyZXF1aXNpdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAkYXR0YWNobWVudCA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ0VtcGxveWVlJykgfHwgYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ0RlcGFydG1lbnQtSGVhZCcpIHx8IGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdQdXJjaGFzZS1EZXBhcnRtZW50JykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZW1wdHkoJHJlcXVpc2l0aW9uLT5hdHRhY2htZW50KSAmJiBmaWxlX2V4aXN0cyhwdWJsaWNfcGF0aCgkcmVxdWlzaXRpb24tPmF0dGFjaG1lbnQpKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhdHRhY2htZW50IC49ICc8YSBocmVmPSInIC4gdXJsKCRyZXF1aXNpdGlvbi0+YXR0YWNobWVudCkgLiAnIiB0YXJnZXQ9Il9ibGFuayIgY2xhc3M9ImJ0biBidG4teHMgYnRuLXByaW1hcnkiPjxpIGNsYXNzPSJsYXMgbGEtcGFwZXJjbGlwIj48L2k+QXR0YWNobWVudDwvYT4nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGF0dGFjaG1lbnQ7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignYWN0aW9ucycsIGZ1bmN0aW9uICgkcmVxdWlzaXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgPSAnJzsKCiAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICc8ZGl2IGNsYXNzPSJidG4tZ3JvdXAiPgogICAgICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBkcm9wZG93bi10b2dnbGUiIGRhdGEtdG9nZ2xlPSJkcm9wZG93biI+CiAgICAgICAgICAgICAgICAgICAgPHNwYW4gaWQ9InN0YXR1c05hbWUnIC4gJHJlcXVpc2l0aW9uLT5pZCAuICciPgogICAgICAgICAgICAgICAgICAgIDxpIGNsYXNzPSJsYSBsYS1lbGxpcHNpcy12Ij48L2k+PC9zcGFuPjwvYnV0dG9uPgogICAgICAgICAgICAgICAgICAgIDx1bCBjbGFzcz0iZHJvcGRvd24tbWVudSI+CiAgICAgICAgICAgICAgICAgICAgPGxpPjxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgdGl0bGU9IlRyYWNraW5nIFJlcXVpc2l0aW9uIiBkYXRhLXNyYz0iJyAuIHJvdXRlKCdwbXMucmVxdWlzaXRpb24ubGlzdC52aWV3LnNob3cnLCAkcmVxdWlzaXRpb24tPmlkKSAuICciIGNsYXNzPSJzaG93UmVxdWlzdGlvbkRldGFpbHMiICBvbmNsaWNrPSJyZXF1aXN0aW9uRGV0YWlscygkKHRoaXMpKSI+PGkgY2xhc3M9ImxhIGxhLWV5ZSI+PC9pPiBWaWV3PC9hPjwvbGk+JzsKICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxsaT48YSBocmVmPSInIC4gcm91dGUoJ3Btcy5yZXF1aXNpdGlvbi5yZXF1aXNpdGlvbi5lZGl0JywgJHJlcXVpc2l0aW9uLT5pZCkgLiAnP3JlZGlyZWN0PWhhbHQtcmVxdWlzaXRpb24mZWRpdG9yPWF1dGhvciIgdGl0bGU9IkNsaWNrIEhlcmUgVG8gRWRpdCIgY2xhc3M9InJlcXVpc2l0aW9uLWVkaXQiPjxpIGNsYXNzPSJsYSBsYS1lZGl0Ij48L2k+Jm5ic3A7RWRpdDwvYT4KICAgICAgICAgICAgICAgICAgICA8L2xpPic7CiAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICc8bGk+PGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiAgb25jbGljaz0ic2VuZFJlcXVpc2l0aW9uKCQodGhpcykpIiBjbGFzcz0ic2VuZFJlcXVpc2l0aW9uIiBkYXRhLWlkPSInIC4gJHJlcXVpc2l0aW9uLT5pZCAuICciIGRhdGEtc3RhdHVzPSIwIiB0aXRsZT0iQ2xpY2sgSGVyZSBUbyBTZW5kIj48aSBjbGFzcz0ibGEgbGEtcGFwZXItcGxhbmUiPjwvaT4gUmVTZW5kPC9hPgogICAgICAgICAgICAgICAgICAgICAgICA8L2xpPic7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHJlcXVpc2l0aW9uLT5yZXF1aXNpdGlvbkxvZ3MtPmNvdW50KCkgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnPGxpPjxhIHRhcmdldD0iX19ibGFuayIgaHJlZj0iJyAuIHJvdXRlKCdwbXMucmVxdWlzaXRpb24ubG9nLmhpc3RvcnknLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb24tPmlkKSAuICciPjxpIGNsYXNzPSJsYSBsYS1oaXN0b3J5IiB0aXRsZT0iUmVxdWlzaXRpb24gTG9nIEhpc3RvcnkiPjwvaT4mbmJzcDtSZXF1aXNpdGlvbiBMb2dzPC9hPjwvbGk8L2E+PC9saT4nOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnPGxpPgogICAgICAgICAgICAgICAgICAgIDxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgZGF0YS1yb2xlPSJkZWxldGUiIGRhdGEtc3JjPSInIC4gcm91dGUoJ3Btcy5yZXF1aXNpdGlvbi5yZXF1aXNpdGlvbi5kZXN0cm95JywgJHJlcXVpc2l0aW9uLT5pZCkgLiAnIiBjbGFzcz0idGV4dC1kYW5nZXIgZGVsZXRlQnRuIHJlcXVpc2l0aW9uLWRlbGV0ZSIgb25jbGljaz0iZGVsZXRlQnRuKCQodGhpcykpIj48aSBjbGFzcz0ibGFzIGxhLXRyYXNoIj48L2k+Jm5ic3A7RGVsZXRlPC9hPgogICAgICAgICAgICAgICAgICAgIDwvbGk+JzsKICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxsaT48YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIHRpdGxlPSJUcmFja2luZyBSZXF1aXNpdGlvbiIgY2xhc3M9InRyYWNraW5nUmVxdWlzdGlvblN0YXR1cyIgb25jbGljaz0idHJhY2tpbmdSZXF1aXN0aW9uU3RhdHVzKCQodGhpcykpIiBkYXRhLWlkPSInIC4gJHJlcXVpc2l0aW9uLT5pZCAuICciPjxpIGNsYXNzPSJsYSBsYS1tYXAiPjwvaT5UcmFjayBQcm9ncmVzczwvYT48L2xpPjwvdWw+PC9kaXY+JzsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRhY3Rpb25zOwoKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+cmF3Q29sdW1ucyhbJ3JlZmVyZW5jZV9ubycsICdzdGF0dXMnLCAnYXR0YWNobWVudCcsICdhY3Rpb25zJ10pCiAgICAgICAgICAgICAgICAgICAgLT5tYWtlKHRydWUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMucmVxdWlzaXRpb25zLmhhbHQtaW5kZXgnLCBbJ3RpdGxlJyA9PiAnUmVxdWlzaXRpb24nLAogICAgICAgICAgICAgICAgJ2Zyb20nID0+ICRmcm9tLCAndG8nID0+ICR0bywgJ2NhdGVnb3J5X2lkJyA9PiAkY2F0ZWdvcnlfaWQsICdjYXRlZ29yaWVzJyA9PiAkY2F0ZWdvcmllcywgJ2hlYWRlckNvbHVtbnMnID0+ICR0aGlzLT5oZWFkZXJDb2x1bW5zKCldKTsKCiAgICAgICAgfSBjYXRjaCAoXFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBTaG93IHRoZSBmb3JtIGZvciBjcmVhdGluZyBhIG5ldyByZXNvdXJjZS4KICAgICAqCiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwogICAgcHVibGljIGZ1bmN0aW9uIGNyZWF0ZSgpCiAgICB7CiAgICAgICAgaWYgKHJlcXVlc3QoKS0+aGFzKCdnZXQtYXR0cmlidXRlcycpKSB7CiAgICAgICAgICAgICRwcm9kdWN0ID0gUHJvZHVjdDo6ZmluZE9yRmFpbChyZXF1ZXN0KCktPmdldCgncHJvZHVjdF9pZCcpKTsKICAgICAgICAgICAgJGl0ZW0gPSBSZXF1aXNpdGlvbkl0ZW06OndpdGgoWwogICAgICAgICAgICAgICAgJ2F0dHJpYnV0ZXMuYXR0cmlidXRlT3B0aW9uJwogICAgICAgICAgICBdKS0+ZmluZChyZXF1ZXN0KCktPmdldCgnaXRlbV9pZCcpKTsKICAgICAgICAgICAgJHNlbGVjdGVkQXR0cmlidXRlcyA9IFtdOwogICAgICAgICAgICBpZiAoaXNzZXQoJGl0ZW0tPmF0dHJpYnV0ZXNbMF0pKSB7CiAgICAgICAgICAgICAgICBmb3JlYWNoICgkaXRlbS0+YXR0cmlidXRlcyBhcyAkYXR0cmlidXRlKSB7CiAgICAgICAgICAgICAgICAgICAgYXJyYXlfcHVzaCgkc2VsZWN0ZWRBdHRyaWJ1dGVzLCAkYXR0cmlidXRlLT5hdHRyaWJ1dGVPcHRpb24tPmF0dHJpYnV0ZV9pZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5yZXF1aXNpdGlvbnMuYXR0cmlidXRlcycsIFsKICAgICAgICAgICAgICAgICdwcm9kdWN0JyA9PiAkcHJvZHVjdCwKICAgICAgICAgICAgICAgICdpdGVtJyA9PiAkaXRlbSwKICAgICAgICAgICAgICAgICdzZWxlY3RlZEF0dHJpYnV0ZXMnID0+ICRzZWxlY3RlZEF0dHJpYnV0ZXMsCiAgICAgICAgICAgICAgICAnYXR0cmlidXRlcycgPT4gQXR0cmlidXRlOjp3aXRoKFsKICAgICAgICAgICAgICAgICAgICAnb3B0aW9ucycsCiAgICAgICAgICAgICAgICAgICAgJ2NhdGVnb3JpZXMnCiAgICAgICAgICAgICAgICBdKQogICAgICAgICAgICAgICAgLT53aGVyZUhhcygnY2F0ZWdvcmllcy5jYXRlZ29yeS5wcm9kdWN0cycsIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnaWQnLCByZXF1ZXN0KCktPmdldCgncHJvZHVjdF9pZCcpKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmdldCgpLAogICAgICAgICAgICBdKTsKICAgICAgICB9CgogICAgICAgIGlmICghYXV0aCgpLT51c2VyKCktPmVtcGxveWVlKSB7CiAgICAgICAgICAgIHJldHVybiByZWRpcmVjdCgpLT5iYWNrKCk7CiAgICAgICAgfQoKICAgICAgICB0cnkgewogICAgICAgICAgICAkdGFzayA9IG51bGw7CiAgICAgICAgICAgIGlmIChyZXF1ZXN0KCktPmhhcygndGFzay1pZCcpKSB7CiAgICAgICAgICAgICAgICAkdGFzayA9IFByb2plY3RUYXNrOjp3aXRoKFsKICAgICAgICAgICAgICAgICAgICAnc3ViRGVsaXZlcmFibGUuZGVsaXZlcmFibGUucHJvamVjdCcKICAgICAgICAgICAgICAgIF0pLT5maW5kT3JGYWlsKHJlcXVlc3QoKS0+Z2V0KCd0YXNrLWlkJykpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAkY2F0ZWdvcnlJZCA9IENhdGVnb3J5RGVwYXJ0bWVudDo6d2hlbihpc3NldChhdXRoKCktPnVzZXIoKS0+ZW1wbG95ZWUtPmFzX2RlcGFydG1lbnRfaWQpLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnaHJfZGVwYXJ0bWVudF9pZCcsIGF1dGgoKS0+dXNlcigpLT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCk7CiAgICAgICAgICAgIH0pLT5wbHVjaygnY2F0ZWdvcnlfaWQnKS0+dG9BcnJheSgpOwoKICAgICAgICAgICAgJGNhdGVnb3JpZXMgPSBDYXRlZ29yeTo6ZG9lc250SGF2ZSgnY2F0ZWdvcnknKQogICAgICAgICAgICAgICAgLT53aXRoKFsnc3ViQ2F0ZWdvcnknXSkKICAgICAgICAgICAgICAgIC0+d2hlcmVJbignaWQnLCAkY2F0ZWdvcnlJZCkKICAgICAgICAgICAgICAgIC0+d2hlcmUoWwogICAgICAgICAgICAgICAgICAgICdpc19maXhlZF9hc3NldCcgPT4gMCwKICAgICAgICAgICAgICAgICAgICAnaXNfY3dpcCcgPT4gMCwKICAgICAgICAgICAgICAgIF0pCiAgICAgICAgICAgICAgICAtPmdldCgpOwogICAgICAgICAgICAkZml4ZWRBc3NldENhdGVnb3JpZXMgPSBDYXRlZ29yeTo6ZG9lc250SGF2ZSgnY2F0ZWdvcnknKQogICAgICAgICAgICAgICAgLT53aXRoKFsnc3ViQ2F0ZWdvcnknXSkKICAgICAgICAgICAgICAgIC0+d2hlcmVJbignaWQnLCAkY2F0ZWdvcnlJZCkKICAgICAgICAgICAgICAgIC0+d2hlcmUoWwogICAgICAgICAgICAgICAgICAgICdpc19maXhlZF9hc3NldCcgPT4gMSwKICAgICAgICAgICAgICAgICAgICAnaXNfY3dpcCcgPT4gMCwKICAgICAgICAgICAgICAgIF0pCiAgICAgICAgICAgICAgICAtPmdldCgpOwogICAgICAgICAgICAkY3dpcENhdGVnb3JpZXMgPSBDYXRlZ29yeTo6ZG9lc250SGF2ZSgnY2F0ZWdvcnknKQogICAgICAgICAgICAgICAgLT53aXRoKFsnc3ViQ2F0ZWdvcnknXSkKICAgICAgICAgICAgICAgIC0+d2hlcmVJbignaWQnLCAkY2F0ZWdvcnlJZCkKICAgICAgICAgICAgICAgIC0+d2hlcmUoWwogICAgICAgICAgICAgICAgICAgICdpc19maXhlZF9hc3NldCcgPT4gMCwKICAgICAgICAgICAgICAgICAgICAnaXNfY3dpcCcgPT4gMSwKICAgICAgICAgICAgICAgIF0pCiAgICAgICAgICAgICAgICAtPmdldCgpOwoKICAgICAgICAgICAgJHRpdGxlID0gJ0NyZWF0ZSBSZXF1aXNpdGlvbic7CiAgICAgICAgICAgICRyZXF1aXNpdGlvbiA9IG51bGw7CgogICAgICAgICAgICAkcHJlZml4ID0gJ1JRLScgLiBkYXRlKCd5Jywgc3RydG90aW1lKGRhdGUoJ1ktbS1kJykpKSAuICctJyAuIGF1dGgoKS0+dXNlcigpLT5lbXBsb3llZS0+dW5pdC0+aHJfdW5pdF9zaG9ydF9uYW1lIC4gJy0nOwogICAgICAgICAgICAkcmVmTm8gPSB1bmlxdWVDb2RlKDE2LCAkcHJlZml4LCAncmVxdWlzaXRpb25zJywgJ2lkJyk7CgogICAgICAgICAgICAvKgogICAgICAgICAgICAkcHJvamVjdHMgPSBbXTsKICAgICAgICAgICAgJHRhc2tzID0gUHJvamVjdFRhc2s6OndpdGgoWwogICAgICAgICAgICAgICAgJ3N1YkRlbGl2ZXJhYmxlLmRlbGl2ZXJhYmxlLnByb2plY3QnCiAgICAgICAgICAgIF0pCiAgICAgICAgICAgIC0+d2hlcmUoJ3VzZXJfaWQnLCBhdXRoKCktPnVzZXIoKS0+aWQpCiAgICAgICAgICAgIC0+Z2V0KCk7CiAgICAgICAgICAgIGlmKGlzc2V0KCR0YXNrc1swXSkpewogICAgICAgICAgICAgICAgZm9yZWFjaCAoJHRhc2tzIGFzICR0YXNrKXsKICAgICAgICAgICAgICAgICAgICAkcHJvamVjdHNbXSA9ICR0YXNrLT5zdWJEZWxpdmVyYWJsZS0+ZGVsaXZlcmFibGUtPnByb2plY3Q7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICRwcm9qZWN0cyA9IFByb2plY3Q6OndoZXJlSW4oImlkIiwgYXJyYXlfa2V5cyhjb2xsZWN0KCRwcm9qZWN0cyktPmdyb3VwQnkoJ2lkJyktPnRvQXJyYXkoKSkpLT5nZXQoKTsKICAgICAgICAgICAgKi8KCiAgICAgICAgICAgICR1bml0SWQgPSBpc3NldChhdXRoKCktPnVzZXIoKS0+ZW1wbG95ZWUtPmFzX3VuaXRfaWQpID8gYXV0aCgpLT51c2VyKCktPmVtcGxveWVlLT5hc191bml0X2lkIDogbnVsbDsKCiAgICAgICAgICAgICRleHBsYW5hdGlvbnMgPSBSZXF1aXNpdGlvbkV4cGxhbmF0aW9uOjphbGwoKTsKCiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5yZXF1aXNpdGlvbnMuY3JlYXRlJywgY29tcGFjdCgndGl0bGUnLCAncmVxdWlzaXRpb24nLCAncmVmTm8nLCAnY2F0ZWdvcmllcycsICdmaXhlZEFzc2V0Q2F0ZWdvcmllcycsICdjd2lwQ2F0ZWdvcmllcycsICd1bml0SWQnLCAndGFzaycsICdleHBsYW5hdGlvbnMnKSk7CiAgICAgICAgfSBjYXRjaCAoVGhyb3dhYmxlICR0aCkgewogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCiAgICBwdWJsaWMgZnVuY3Rpb24gbG9hZFByb2plY3RXaXNlRGVsaXZlcmFibGVzKFByb2plY3QgJHByb2plY3QgPSBudWxsKQogICAgewogICAgICAgICRkZWxpdmVyYWJsZXMgPSBbXTsKICAgICAgICBmb3JlYWNoIChBdXRoOjp1c2VyKCktPnByb2plY3RUYXNrIGFzICR0YXNrKSB7CiAgICAgICAgICAgIGlmICgkdGFzay0+c3ViRGVsaXZlcmFibGUtPmRlbGl2ZXJhYmxlLT5wcm9qZWN0X2lkID09ICRwcm9qZWN0LT5pZCkgewogICAgICAgICAgICAgICAgJGRlbGl2ZXJhYmxlc1tdID0gJHRhc2stPnN1YkRlbGl2ZXJhYmxlLT5kZWxpdmVyYWJsZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAkZGVsaXZlcmFibGVzID0gYXJyYXlfa2V5cyhjb2xsZWN0KCRkZWxpdmVyYWJsZXMpLT5ncm91cEJ5KCdpZCcpLT50b0FycmF5KCkpOwogICAgICAgICRkZWxpdmVyYWJsZXMgPSBEZWxpdmVyYWJsZXM6OndoZXJlSW4oImlkIiwgJGRlbGl2ZXJhYmxlcyktPmdldCgpOwoKICAgICAgICAkb3V0cHV0ID0gW107CiAgICAgICAgJG91dHB1dFtdID0gIjxvcHRpb24+U2VsZWN0IE9uZTwvb3B0aW9uPiI7CiAgICAgICAgZm9yZWFjaCAoJGRlbGl2ZXJhYmxlcyBhcyAkZGVsaXZlcmFibGUpIHsKICAgICAgICAgICAgJG91dHB1dFtdID0gJzxvcHRpb24gdmFsdWU9IicgLiAkZGVsaXZlcmFibGUtPmlkIC4gJyI+JyAuICRkZWxpdmVyYWJsZS0+bmFtZSAuICc8L29wdGlvbj4nOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihpbXBsb2RlKCcsJywgJG91dHB1dCkpOwogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBsb2FkQ2F0ZWdvcnlXaXNlUHJvZHVjdHMoJGNhdGVnb3J5SWQsIFJlcXVlc3QgJHJlcXVlc3QpCiAgICB7CiAgICAgICAgJHJlc3BvbnNlID0gJyc7CgogICAgICAgICRjYXRlZ29yeUlkcyA9IENhdGVnb3J5RGVwYXJ0bWVudDo6d2hlbihpc3NldChhdXRoKCktPnVzZXIoKS0+ZW1wbG95ZWUtPmFzX2RlcGFydG1lbnRfaWQpLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdocl9kZXBhcnRtZW50X2lkJywgYXV0aCgpLT51c2VyKCktPmVtcGxveWVlLT5hc19kZXBhcnRtZW50X2lkKTsKICAgICAgICB9KS0+cGx1Y2soJ2NhdGVnb3J5X2lkJyktPnRvQXJyYXkoKTsKCgogICAgICAgICRjYXRlZ29yeVByb2R1Y3RzID0gUHJvZHVjdDo6d2l0aChbCiAgICAgICAgICAgICdwcm9kdWN0VW5pdCcsICdjYXRlZ29yeS5jYXRlZ29yeScsICdhdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGUnCiAgICAgICAgXSkKICAgICAgICAgICAgLT53aGVyZSgnc3RhdHVzJywgJ2FwcHJvdmVkJykKICAgICAgICAgICAgLT53aGVuKCFlbXB0eSgkY2F0ZWdvcnlJZCksIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGNhdGVnb3J5SWQpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGNhdGVnb3J5SWQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnY2F0ZWdvcnlfaWQnLCAkY2F0ZWdvcnlJZCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT53aGVyZUhhcygnY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgncGFyZW50X2lkJywgcmVxdWVzdCgpLT5nZXQoJ3BhcmVudF9pZCcpKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT53aGVyZSgnaXNfZmluYWxfYXNzZXQnLCAwKQogICAgICAgICAgICAtPndoZXJlSW4oJ2NhdGVnb3J5X2lkJywgJGNhdGVnb3J5SWRzKTsKCiAgICAgICAgaWYgKGlzc2V0KCRyZXF1ZXN0LT5wcm9kdWN0c19pZCkpIHsKICAgICAgICAgICAgJGV4aXN0ZWRQcm9kdWN0cyA9IGV4cGxvZGUoJywnLCAkcmVxdWVzdC0+cHJvZHVjdHNfaWQpOwogICAgICAgICAgICBpZiAocmVxdWVzdCgpLT5oYXMoJ3NlbGVjdGVkJykpIHsKICAgICAgICAgICAgICAgICRleGlzdGVkUHJvZHVjdHMgPSBhcnJheV9kaWZmKCRleGlzdGVkUHJvZHVjdHMsIFtyZXF1ZXN0KCktPmdldCgnc2VsZWN0ZWQnKV0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAkY2F0ZWdvcnlQcm9kdWN0cyA9ICRjYXRlZ29yeVByb2R1Y3RzLT53aGVyZU5vdEluKCdpZCcsICRleGlzdGVkUHJvZHVjdHMpOwogICAgICAgIH0KCiAgICAgICAgJGNhdGVnb3J5UHJvZHVjdHMgPSAkY2F0ZWdvcnlQcm9kdWN0cy0+Z2V0KCk7CgogICAgICAgICRyZXNwb25zZSAuPSAnPHNlbGVjdCBuYW1lPSJwcm9kdWN0X2lkW10iIGlkPSJwcm9kdWN0XzEiIGNsYXNzPSJmb3JtLWNvbnRyb2wgc2VsZWN0MiBwcm9kdWN0IiByZXF1aXJlZD4nOwogICAgICAgICRyZXNwb25zZSAuPSAnPG9wdGlvbiB2YWx1ZT0iIiBkYXRhLXVvbT0iIj5TZWxlY3QgUHJvZHVjdDwvb3B0aW9uPic7CiAgICAgICAgaWYgKCFlbXB0eSgkY2F0ZWdvcnlQcm9kdWN0cykpIHsKICAgICAgICAgICAgZm9yZWFjaCAoJGNhdGVnb3J5UHJvZHVjdHMgYXMgJGRhdGEpIHsKICAgICAgICAgICAgICAgICRyZXNwb25zZSAuPSAnPG9wdGlvbiBkYXRhLXVvbT0iJyAuICgkZGF0YS0+cHJvZHVjdFVuaXQgPyAkZGF0YS0+cHJvZHVjdFVuaXQtPnVuaXRfbmFtZSA6ICcnKSAuICciIHZhbHVlPSInIC4gJGRhdGEtPmlkIC4gJyIgZGF0YS1zdWItY2F0ZWdvcnktaWQ9IicgLiAkZGF0YS0+Y2F0ZWdvcnlfaWQgLiAnIiBkYXRhLWNhdGVnb3J5LWlkPSInIC4gJGRhdGEtPmNhdGVnb3J5LT5wYXJlbnRfaWQgLiAnIiAnIC4gKHJlcXVlc3QoKS0+Z2V0KCdzZWxlY3RlZCcpID09ICRkYXRhLT5pZCA/ICdzZWxlY3RlZCcgOiAnJykgLiAnPicgLiAkZGF0YS0+bmFtZSAuICcgJyAuIGdldFByb2R1Y3RBdHRyaWJ1dGVzRmFzdGVyKCRkYXRhKSAuICcgKFVPTTogJyAuICgkZGF0YS0+cHJvZHVjdFVuaXQgPyAkZGF0YS0+cHJvZHVjdFVuaXQtPnVuaXRfbmFtZSA6ICcnKSAuICcpPC9vcHRpb24+JzsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICRyZXNwb25zZSAuPSAiPG9wdGlvbiB2YWx1ZT0nJz5ObyBQcm9kdWN0IEZvdW5kISE8L29wdGlvbj4iOwogICAgICAgIH0KICAgICAgICAkcmVzcG9uc2UgLj0gIjwvc2VsZWN0PiI7CgogICAgICAgIHJldHVybiAkcmVzcG9uc2U7CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIGxvYWRDYXRlZ29yeVdpc2VTdWJjYXRlZ29yeSgkY2F0ZWdvcnlJZCkKICAgIHsKICAgICAgICAkcmVzcG9uc2UgPSAnJzsKICAgICAgICAkc3ViQ2F0ZWdvcnkgPSBDYXRlZ29yeTo6d2hlbighZW1wdHkoJGNhdGVnb3J5SWQpLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRjYXRlZ29yeUlkKSB7CiAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdwYXJlbnRfaWQnLCAkY2F0ZWdvcnlJZCk7CiAgICAgICAgfSktPmdldCgpOwoKICAgICAgICBpZiAoaXNzZXQoJHN1YkNhdGVnb3J5KSAmJiBjb3VudCgoYXJyYXkpJHN1YkNhdGVnb3J5KSA+IDApIHsKICAgICAgICAgICAgJHJlc3BvbnNlIC49ICc8b3B0aW9uIHZhbHVlPSIiPi0tU2VsZWN0IFN1YmNhdGVnb3J5LS08L29wdGlvbj4nOwogICAgICAgICAgICBmb3JlYWNoICgkc3ViQ2F0ZWdvcnkgYXMgJGRhdGEpIHsKICAgICAgICAgICAgICAgICRyZXNwb25zZSAuPSAnPG9wdGlvbiB2YWx1ZT0iJyAuICRkYXRhLT5pZCAuICciPicgLiAkZGF0YS0+bmFtZSAuICcoJyAuICRkYXRhLT5jb2RlIC4gJyknIC4gJzwvb3B0aW9uPic7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAkcmVzcG9uc2UgLj0gIjxvcHRpb24gdmFsdWU9Jyc+Tm8gQ2F0ZWdvcnkgRm91bmQhITwvb3B0aW9uPiI7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gJHJlc3BvbnNlOwogICAgfQoKICAgIC8qKgogICAgICogU3RvcmUgYSBuZXdseSBjcmVhdGVkIHJlc291cmNlIGluIHN0b3JhZ2UuCiAgICAgKgogICAgICogQHBhcmFtIFxJbGx1bWluYXRlXEh0dHBcUmVxdWVzdCAkcmVxdWVzdAogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KCiAgICBwdWJsaWMgZnVuY3Rpb24gc3RvcmUoUmVxdWVzdCAkcmVxdWVzdCwgJGVkaXQgPSBmYWxzZSkKICAgIHsKICAgICAgICAkcmVxdWVzdC0+dmFsaWRhdGUoWwogICAgICAgICAgICAncmVtYXJrcycgPT4gJ3JlcXVpcmVkJywKICAgICAgICAgICAgJ3Byb2R1Y3RfaWQnID0+ICdyZXF1aXJlZCcsCiAgICAgICAgICAgICdwcm9kdWN0X2lkLionID0+ICdyZXF1aXJlZCcsCiAgICAgICAgXSk7CgogICAgICAgIGlmICgkcmVxdWVzdC0+aGFzRmlsZSgnZmlsZScpKSB7CiAgICAgICAgICAgICR0aGlzLT52YWxpZGF0ZSgkcmVxdWVzdCwgWwogICAgICAgICAgICAgICAgJ2ZpbGUnID0+IFsnbWF4OjEwMDAwJ10sCiAgICAgICAgICAgIF0pOwogICAgICAgIH0KCiAgICAgICAgREI6OmJlZ2luVHJhbnNhY3Rpb24oKTsKICAgICAgICB0cnkgewoKICAgICAgICAgICAgLy9UYXNrIEJ1ZGdldCBWYWxpZGF0aW9uCiAgICAgICAgICAgICRwcm9qZWN0X3Rhc2tfaWQgPSAoJHJlcXVlc3QtPmFwcHJvdmFsX3F0eSA9PSAndHJ1ZScpID8gJHJlcXVlc3QtPnByb2plY3RfdGFza19pZCA6IChpc3NldCgkcmVxdWVzdC0+cHJvamVjdF90YXNrX2lkKSA/ICRyZXF1ZXN0LT5wcm9qZWN0X3Rhc2tfaWQgOiBudWxsKTsKICAgICAgICAgICAgJHByb2plY3RUYXNrID0gUHJvamVjdFRhc2s6OmZpbmQoJHByb2plY3RfdGFza19pZCk7CiAgICAgICAgICAgIGlmIChpc3NldCgkcHJvamVjdFRhc2stPmlkKSkgewogICAgICAgICAgICAgICAgJGNvbnN1bXB0aW9ucyA9IDA7CiAgICAgICAgICAgICAgICBpZiAoaXNzZXQoJHByb2plY3RUYXNrLT5yZXF1aXNpdGlvbnNbMF0pKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yZWFjaCAoJHByb2plY3RUYXNrLT5yZXF1aXNpdGlvbnMgYXMgJGtleSA9PiAkdGhpc19yZXF1aXNpdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAkY29uc3VtcHRpb25zICs9IGVzdGltYXRlZFZhbHVlKCR0aGlzX3JlcXVpc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9uX2NvbnN1bXB0aW9uID0gMDsKICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRyZXF1ZXN0LT5xdHkgYXMgJGtleSA9PiAkcXR5KSB7CiAgICAgICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9uX2NvbnN1bXB0aW9uICs9IFByb2R1Y3Q6OmZpbmQoJHJlcXVlc3QtPnByb2R1Y3RfaWRbJGtleV0pLT51bml0X3ByaWNlICogJHF0eTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAkY29uc3VtcHRpb25zICs9ICRyZXF1aXNpdGlvbl9jb25zdW1wdGlvbjsKCiAgICAgICAgICAgICAgICBpZiAoJGNvbnN1bXB0aW9ucyA+ICRwcm9qZWN0VGFzay0+c3ViRGVsaXZlcmFibGUtPmJ1ZGdldCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcignUHJvamVjdCBCdWRnZXQgYWxsb2NhdGlvbiAoJyAuICRwcm9qZWN0VGFzay0+YnVkZ2V0IC4gJyBCRFQpIGhhcyBiZWVuIGV4Y2VlZGVkIGZvciB0aGlzIHJlcXVpc2l0aW9uICgnIC4gJHJlcXVpc2l0aW9uX2NvbnN1bXB0aW9uIC4gJyBCRFQpLiBSZW1haW5pbmcgQnVkZ2V0IGlzICgnIC4gKCRwcm9qZWN0VGFzay0+c3ViRGVsaXZlcmFibGUtPmJ1ZGdldCA+ICRjb25zdW1wdGlvbnMgPyAkcHJvamVjdFRhc2stPnN1YkRlbGl2ZXJhYmxlLT5idWRnZXQgLSAkY29uc3VtcHRpb25zIDogMCkgLiAnIEJEVCknKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvL1Rhc2sgQnVkZ2V0IFZhbGlkYXRpb24KCiAgICAgICAgICAgICRyZXF1aXNpdGlvbiA9IFJlcXVpc2l0aW9uOjpjcmVhdGUoWwogICAgICAgICAgICAgICAgJ3JlcXVpc2l0aW9uJyA9PiB1bmlxdWVTdHJpbmdHZW5lcmF0b3IoKSwKICAgICAgICAgICAgICAgICdyZWZlcmVuY2Vfbm8nID0+ICRyZXF1ZXN0LT5yZWZlcmVuY2Vfbm8sCgogICAgICAgICAgICAgICAgJ2hyX3VuaXRfaWQnID0+IGlzc2V0KCRyZXF1ZXN0LT5ocl91bml0X2lkKSA/ICRyZXF1ZXN0LT5ocl91bml0X2lkIDogbnVsbCwKCiAgICAgICAgICAgICAgICAncmVxdWlzaXRpb25fZGF0ZScgPT4gZGF0ZSgnWS1tLWQgaDppJywgc3RydG90aW1lKCRyZXF1ZXN0LT5yZXF1aXNpdGlvbl9kYXRlKSksCiAgICAgICAgICAgICAgICAnYXV0aG9yX2lkJyA9PiAoJHJlcXVlc3QtPmFwcHJvdmFsX3F0eSA9PSAndHJ1ZScpID8gJHJlcXVlc3QtPmF1dGhvcl9pZCA6IGF1dGgoKS0+dXNlcigpLT5pZCwKCiAgICAgICAgICAgICAgICAncHJvamVjdF9pZCcgPT4gKCRyZXF1ZXN0LT5hcHByb3ZhbF9xdHkgPT0gJ3RydWUnKSA/ICRyZXF1ZXN0LT5wcm9qZWN0X2lkIDogKGlzc2V0KCRyZXF1ZXN0LT5wcm9qZWN0X2lkKSA/ICRyZXF1ZXN0LT5wcm9qZWN0X2lkIDogbnVsbCksCgogICAgICAgICAgICAgICAgJ2RlbGl2ZXJhYmxlX2lkJyA9PiAoJHJlcXVlc3QtPmFwcHJvdmFsX3F0eSA9PSAndHJ1ZScpID8gJHJlcXVlc3QtPmRlbGl2ZXJhYmxlX2lkIDogKGlzc2V0KCRyZXF1ZXN0LT5kZWxpdmVyYWJsZV9pZCkgPyAkcmVxdWVzdC0+ZGVsaXZlcmFibGVfaWQgOiBudWxsKSwKCiAgICAgICAgICAgICAgICAncHJvamVjdF90YXNrX2lkJyA9PiAoJHJlcXVlc3QtPmFwcHJvdmFsX3F0eSA9PSAndHJ1ZScpID8gJHJlcXVlc3QtPnByb2plY3RfdGFza19pZCA6IChpc3NldCgkcmVxdWVzdC0+cHJvamVjdF90YXNrX2lkKSA/ICRyZXF1ZXN0LT5wcm9qZWN0X3Rhc2tfaWQgOiBudWxsKSwKICAgICAgICAgICAgICAgICdzdGF0dXMnID0+ICgkcmVxdWVzdC0+YXBwcm92YWxfcXR5ID09ICd0cnVlJykgPyAwIDogMywKICAgICAgICAgICAgICAgICdyZW1hcmtzJyA9PiAkcmVxdWVzdC0+cmVtYXJrcywKICAgICAgICAgICAgICAgICdleHBsYW5hdGlvbnMnID0+IGpzb25fZW5jb2RlKGlzc2V0KCRyZXF1ZXN0LT5leHBsYW5hdGlvbnNbMF0pID8gJHJlcXVlc3QtPmV4cGxhbmF0aW9ucyA6IFtdKSwKICAgICAgICAgICAgXSk7CgogICAgICAgICAgICBpZiAoJHJlcXVlc3QtPmhhc0ZpbGUoJ2ZpbGUnKSkgewogICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9uLT5hdHRhY2htZW50ID0gJHRoaXMtPmZpbGVVcGxvYWQoJHJlcXVlc3QtPmZpbGUoJ2ZpbGUnKSwgJ3VwbG9hZC9yZXF1aXNpdGlvbi1hdHRhY2htZW50cycpOwogICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9uLT5zYXZlKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvcmVhY2ggKCRyZXF1ZXN0LT5xdHkgYXMgJGtleSA9PiAkcXR5KSB7CiAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb25JdGVtSW5wdXRbXSA9IFsKICAgICAgICAgICAgICAgICAgICAncmVxdWlzaXRpb25faWQnID0+ICRyZXF1aXNpdGlvbi0+aWQsCiAgICAgICAgICAgICAgICAgICAgJ3Byb2R1Y3RfaWQnID0+ICRyZXF1ZXN0LT5wcm9kdWN0X2lkWyRrZXldLAogICAgICAgICAgICAgICAgICAgICd1bml0X3ByaWNlJyA9PiBpc3NldCgkcmVxdWVzdC0+b2xkX3VuaXRfcHJpY2VbJGtleV0pID8gJHJlcXVlc3QtPm9sZF91bml0X3ByaWNlWyRrZXldIDogKGlzc2V0KCRyZXF1ZXN0LT51bml0X3ByaWNlWyRrZXldKSA/ICRyZXF1ZXN0LT51bml0X3ByaWNlWyRrZXldIDogMCksCiAgICAgICAgICAgICAgICAgICAgJ3F0eScgPT4gJHF0eSwKICAgICAgICAgICAgICAgICAgICAncmVxdWlzaXRpb25fcXR5JyA9PiAoJHJlcXVlc3QtPmFwcHJvdmFsX3F0eSA9PSAndHJ1ZScpID8gKGlzc2V0KCRyZXF1ZXN0LT5vbGRfcXR5WyRrZXldKSA/ICRyZXF1ZXN0LT5vbGRfcXR5WyRrZXldIDogJHF0eSkgOiAkcXR5LAogICAgICAgICAgICAgICAgICAgICdjcmVhdGVkX2F0JyA9PiBkYXRlKCdZLW0tZCBoOmknKSwKICAgICAgICAgICAgICAgICAgICAnY3JlYXRlZF9ieScgPT4gKCRyZXF1ZXN0LT5hcHByb3ZhbF9xdHkgPT0gJ3RydWUnKSA/ICRyZXF1ZXN0LT5hdXRob3JfaWQgOiBhdXRoKCktPnVzZXIoKS0+aWQsCiAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICB9CgogICAgICAgICAgICBSZXF1aXNpdGlvbkl0ZW06Omluc2VydCgkcmVxdWlzaXRpb25JdGVtSW5wdXQpOwoKICAgICAgICAgICAgUmVxdWlzaXRpb25UcmFja2luZzo6c3RvcmVSZXF1aXNpdGlvblRyYWNraW5nKCRyZXF1aXNpdGlvbi0+aWQsICdwZW5kaW5nJyk7CgogICAgICAgICAgICAvL0luc2VydCBub3RlcyBsb2dnaW5nCiAgICAgICAgICAgIFJlcXVpc2l0aW9uTm90ZUxvZ3M6OmNyZWF0ZShbCiAgICAgICAgICAgICAgICAncmVxdWlzaXRpb25faWQnID0+ICRyZXF1aXNpdGlvbi0+aWQsCiAgICAgICAgICAgICAgICAnbm90ZXMnID0+ICRyZXF1ZXN0LT5yZW1hcmtzLAogICAgICAgICAgICAgICAgJ3R5cGUnID0+ICgkcmVxdWVzdC0+YXBwcm92YWxfcXR5ID09ICd0cnVlJykgPyAnZGVwYXJ0bWVudC1oZWFkJyA6ICdyZXF1aXNpdGlvbicsCiAgICAgICAgICAgIF0pOwogICAgICAgICAgICAvL1RyYWNraW5nCgogICAgICAgICAgICAkaXRlbXMgPSBSZXF1aXNpdGlvbkl0ZW06OndoZXJlKCdyZXF1aXNpdGlvbl9pZCcsICRyZXF1aXNpdGlvbi0+aWQpLT5nZXQoKTsKICAgICAgICAgICAgJGF0dHJpYnV0ZXMgPSBbXTsKICAgICAgICAgICAgaWYgKGlzc2V0KCRpdGVtc1swXSkpIHsKICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRpdGVtcyBhcyAkaXRlbSkgewogICAgICAgICAgICAgICAgICAgIGlmIChpc3NldCgkcmVxdWVzdC0+YXR0cmlidXRlX29wdGlvbnNbJGl0ZW0tPnByb2R1Y3RfaWRdKSAmJiBpc19hcnJheSgkcmVxdWVzdC0+YXR0cmlidXRlX29wdGlvbnNbJGl0ZW0tPnByb2R1Y3RfaWRdKSAmJiBjb3VudCgkcmVxdWVzdC0+YXR0cmlidXRlX29wdGlvbnNbJGl0ZW0tPnByb2R1Y3RfaWRdKSA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yZWFjaCAoJHJlcXVlc3QtPmF0dHJpYnV0ZV9vcHRpb25zWyRpdGVtLT5wcm9kdWN0X2lkXSBhcyAkYXR0cmlidXRlX2lkID0+ICRhdHRyaWJ1dGVfb3B0aW9uX2lkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNzZXQoJHJlcXVlc3QtPnByb2R1Y3RfYXR0cmlidXRlc1skaXRlbS0+cHJvZHVjdF9pZF0pICYmIGluX2FycmF5KCRhdHRyaWJ1dGVfaWQsICRyZXF1ZXN0LT5wcm9kdWN0X2F0dHJpYnV0ZXNbJGl0ZW0tPnByb2R1Y3RfaWRdKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5X3B1c2goJGF0dHJpYnV0ZXMsIFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3JlcXVpc2l0aW9uX2l0ZW1faWQnID0+ICRpdGVtLT5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2F0dHJpYnV0ZV9vcHRpb25faWQnID0+ICRhdHRyaWJ1dGVfb3B0aW9uX2lkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnY3JlYXRlZF9ieScgPT4gYXV0aCgpLT51c2VyKCktPmlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaXNzZXQoJGF0dHJpYnV0ZXNbMF0pKSB7CiAgICAgICAgICAgICAgICBSZXF1aXNpdGlvbkl0ZW1BdHRyaWJ1dGU6Omluc2VydCgkYXR0cmlidXRlcyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIERCOjpjb21taXQoKTsKCiAgICAgICAgICAgIHNlc3Npb24oKS0+Zm9yZ2V0KCdyZXF1aXNpdGlvbi1pdGVtcycpOwoKICAgICAgICAgICAgaWYgKCRlZGl0ID09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNzZXQoJHJlcXVlc3QtPndoZXJlX3RvX2dvKSAmJiAkcmVxdWVzdC0+d2hlcmVfdG9fZ28gPT0gJ2JhY2snKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aFN1Y2Nlc3MoJ1JlcXVpc2l0aW9uIGhhcyBiZWVuIHN1Y2Nlc3NmdWxseSBhcHBsaWVkJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5yZWRpcmVjdEJhY2tXaXRoU3VjY2VzcygnUmVxdWlzaXRpb24gaGFzIGJlZW4gc3VjY2Vzc2Z1bGx5IGFwcGxpZWQnLCAncG1zLnJlcXVpc2l0aW9uLnJlcXVpc2l0aW9uLmluZGV4Jyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJHJlcXVpc2l0aW9uOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoXFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgREI6OnJvbGxiYWNrKCk7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogRHVwbGljYXRlIHRoZSBzcGVjaWZpZWQgcmVzb3VyY2UuCiAgICAgKgogICAgICogQHBhcmFtIFxBcHBcTW9kZWxzXFBtc01vZGVsc1xSZXF1aXNpdGlvbiAkaWQKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxKc29uUmVzcG9uc2UKICAgICAqLwoKICAgIHB1YmxpYyBmdW5jdGlvbiBkdXBsaWNhdGUoJGlkKQogICAgewogICAgICAgICRtb2RlbCA9IFJlcXVpc2l0aW9uOjp3aXRoKFsKICAgICAgICAgICAgJ2l0ZW1zLnByb2R1Y3QuY2F0ZWdvcnknLAogICAgICAgICAgICAnaXRlbXMuYXR0cmlidXRlcycsCiAgICAgICAgICAgICdwcm9qZWN0VGFzaycKICAgICAgICBdKS0+ZmluZE9yRmFpbCgkaWQpOwoKICAgICAgICBEQjo6YmVnaW5UcmFuc2FjdGlvbigpOwogICAgICAgIHRyeSB7CgogICAgICAgICAgICAvL1Rhc2sgQnVkZ2V0IFZhbGlkYXRpb24KICAgICAgICAgICAgJHByb2plY3RUYXNrSWQgPSBpc3NldCgkbW9kZWwtPnByb2plY3RfdGFza19pZCkgPyAkbW9kZWwtPnByb2plY3RfdGFza19pZCA6IG51bGw7CiAgICAgICAgICAgICRwcm9qZWN0VGFzayA9IFByb2plY3RUYXNrOjpmaW5kKCRwcm9qZWN0VGFza0lkKTsKICAgICAgICAgICAgaWYgKGlzc2V0KCRwcm9qZWN0VGFzay0+aWQpKSB7CiAgICAgICAgICAgICAgICAkY29uc3VtcHRpb25zID0gMDsKICAgICAgICAgICAgICAgIGlmIChpc3NldCgkcHJvamVjdFRhc2stPnJlcXVpc2l0aW9uc1swXSkpIHsKICAgICAgICAgICAgICAgICAgICBmb3JlYWNoICgkcHJvamVjdFRhc2stPnJlcXVpc2l0aW9ucyBhcyAka2V5ID0+ICR0aGlzX3JlcXVpc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRjb25zdW1wdGlvbnMgKz0gZXN0aW1hdGVkVmFsdWUoJHRoaXNfcmVxdWlzaXRpb24pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbkNvbnN1bXB0aW9uID0gMDsKICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRtb2RlbC0+aXRlbXMgYXMgJGl0ZW0pIHsKICAgICAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb25Db25zdW1wdGlvbiArPSBQcm9kdWN0OjpmaW5kKCRpdGVtLT5wcm9kdWN0X2lkKS0+dW5pdF9wcmljZSAqICRpdGVtLT5xdHk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgJGNvbnN1bXB0aW9ucyArPSAkcmVxdWlzaXRpb25Db25zdW1wdGlvbjsKICAgICAgICAgICAgICAgIGlmICgkY29uc3VtcHRpb25zID4gJHByb2plY3RUYXNrLT5zdWJEZWxpdmVyYWJsZS0+YnVkZ2V0KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAnUHJvamVjdCBCdWRnZXQgYWxsb2NhdGlvbiAoJyAuICRwcm9qZWN0VGFzay0+YnVkZ2V0IC4gJyBCRFQpIGhhcyBiZWVuIGV4Y2VlZGVkIGZvciB0aGlzIHJlcXVpc2l0aW9uICgnIC4gJHJlcXVpc2l0aW9uQ29uc3VtcHRpb24gLiAnIEJEVCkuIFJlbWFpbmluZyBCdWRnZXQgaXMgKCcgLiAoJHByb2plY3RUYXNrLT5zdWJEZWxpdmVyYWJsZS0+YnVkZ2V0ID4gJGNvbnN1bXB0aW9ucyA/ICRwcm9qZWN0VGFzay0+c3ViRGVsaXZlcmFibGUtPmJ1ZGdldCAtICRjb25zdW1wdGlvbnMgOiAwKSAuICcgQkRUKScKICAgICAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvL1Rhc2sgQnVkZ2V0IFZhbGlkYXRpb24KCiAgICAgICAgICAgICRwcmVmaXggPSAnUlEtJyAuIGRhdGUoJ3knLCBzdHJ0b3RpbWUoZGF0ZSgnWS1tLWQnKSkpIC4gJy0nIC4gYXV0aCgpLT51c2VyKCktPmVtcGxveWVlLT51bml0LT5ocl91bml0X3Nob3J0X25hbWUgLiAnLSc7CiAgICAgICAgICAgICRyZWZObyA9IHVuaXF1ZUNvZGUoMTYsICRwcmVmaXgsICdyZXF1aXNpdGlvbnMnLCAnaWQnKTsKCiAgICAgICAgICAgICRyZXF1aXNpdGlvbiA9IFJlcXVpc2l0aW9uOjpjcmVhdGUoWwogICAgICAgICAgICAgICAgJ3JlcXVpc2l0aW9uJyA9PiB1bmlxdWVTdHJpbmdHZW5lcmF0b3IoKSwKICAgICAgICAgICAgICAgICdyZWZlcmVuY2Vfbm8nID0+ICRyZWZObywKICAgICAgICAgICAgICAgICdocl91bml0X2lkJyA9PiBpc3NldCgkbW9kZWwtPmhyX3VuaXRfaWQpID8gJG1vZGVsLT5ocl91bml0X2lkIDogbnVsbCwKICAgICAgICAgICAgICAgICdyZXF1aXNpdGlvbl9kYXRlJyA9PiBkYXRlKCdZLW0tZCBoOmknKSwKICAgICAgICAgICAgICAgICdhdXRob3JfaWQnID0+IGF1dGgoKS0+dXNlcigpLT5pZCwKICAgICAgICAgICAgICAgICdwcm9qZWN0X2lkJyA9PiBpc3NldCgkbW9kZWwtPnByb2plY3RfaWQpID8gJG1vZGVsLT5wcm9qZWN0X2lkIDogbnVsbCwKICAgICAgICAgICAgICAgICdkZWxpdmVyYWJsZV9pZCcgPT4gaXNzZXQoJG1vZGVsLT5kZWxpdmVyYWJsZV9pZCkgPyAkbW9kZWwtPmRlbGl2ZXJhYmxlX2lkIDogbnVsbCwKICAgICAgICAgICAgICAgICdwcm9qZWN0X3Rhc2tfaWQnID0+IGlzc2V0KCRtb2RlbC0+cHJvamVjdF90YXNrX2lkKSA/ICRtb2RlbC0+cHJvamVjdF90YXNrX2lkIDogbnVsbCwKICAgICAgICAgICAgICAgICdzdGF0dXMnID0+IDMsCiAgICAgICAgICAgICAgICAncmVtYXJrcycgPT4gJG1vZGVsLT5yZW1hcmtzLAogICAgICAgICAgICAgICAgJ2V4cGxhbmF0aW9ucycgPT4gJG1vZGVsLT5leHBsYW5hdGlvbnMsCiAgICAgICAgICAgICAgICAnYXR0YWNobWVudCcgPT4gJG1vZGVsLT5hdHRhY2htZW50CiAgICAgICAgICAgIF0pOwoKICAgICAgICAgICAgJGF0dHJpYnV0ZXMgPSBbXTsKICAgICAgICAgICAgZm9yZWFjaCAoJG1vZGVsLT5pdGVtcyBhcyAkaXRlbSkgewogICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9uSXRlbSA9IFJlcXVpc2l0aW9uSXRlbTo6Y3JlYXRlKFsKICAgICAgICAgICAgICAgICAgICAncmVxdWlzaXRpb25faWQnID0+ICRyZXF1aXNpdGlvbi0+aWQsCiAgICAgICAgICAgICAgICAgICAgJ3Byb2R1Y3RfaWQnID0+ICRpdGVtLT5wcm9kdWN0X2lkLAogICAgICAgICAgICAgICAgICAgICd1bml0X3ByaWNlJyA9PiAkaXRlbS0+dW5pdF9wcmljZSwKICAgICAgICAgICAgICAgICAgICAncXR5JyA9PiAkaXRlbS0+cXR5LAogICAgICAgICAgICAgICAgICAgICdyZXF1aXNpdGlvbl9xdHknID0+ICRpdGVtLT5xdHksCiAgICAgICAgICAgICAgICAgICAgJ2NyZWF0ZWRfYXQnID0+IGRhdGUoJ1ktbS1kIGg6aTpzJyksCiAgICAgICAgICAgICAgICAgICAgJ2NyZWF0ZWRfYnknID0+IGF1dGgoKS0+dXNlcigpLT5pZCwKICAgICAgICAgICAgICAgIF0pOwoKICAgICAgICAgICAgICAgIGlmIChpc3NldCgkaXRlbS0+YXR0cmlidXRlc1swXSkpIHsKICAgICAgICAgICAgICAgICAgICBmb3JlYWNoICgkaXRlbS0+YXR0cmlidXRlcyBhcyAkYXR0cmlidXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5X3B1c2goJGF0dHJpYnV0ZXMsIFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdyZXF1aXNpdGlvbl9pdGVtX2lkJyA9PiAkcmVxdWlzaXRpb25JdGVtLT5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdhdHRyaWJ1dGVfb3B0aW9uX2lkJyA9PiAkYXR0cmlidXRlLT5hdHRyaWJ1dGVfb3B0aW9uX2lkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2NyZWF0ZWRfYnknID0+IGF1dGgoKS0+dXNlcigpLT5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpc3NldCgkYXR0cmlidXRlc1swXSkpIHsKICAgICAgICAgICAgICAgIFJlcXVpc2l0aW9uSXRlbUF0dHJpYnV0ZTo6aW5zZXJ0KCRhdHRyaWJ1dGVzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgUmVxdWlzaXRpb25UcmFja2luZzo6c3RvcmVSZXF1aXNpdGlvblRyYWNraW5nKCRyZXF1aXNpdGlvbi0+aWQsICdwZW5kaW5nJyk7CgogICAgICAgICAgICAvL0luc2VydCBub3RlcyBsb2dnaW5nCiAgICAgICAgICAgIFJlcXVpc2l0aW9uTm90ZUxvZ3M6OmNyZWF0ZShbCiAgICAgICAgICAgICAgICAncmVxdWlzaXRpb25faWQnID0+ICRyZXF1aXNpdGlvbi0+aWQsCiAgICAgICAgICAgICAgICAnbm90ZXMnID0+ICRtb2RlbC0+cmVtYXJrcywKICAgICAgICAgICAgICAgICd0eXBlJyA9PiAncmVxdWlzaXRpb24nLAogICAgICAgICAgICBdKTsKCiAgICAgICAgICAgIERCOjpjb21taXQoKTsKCiAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiB0cnVlLAogICAgICAgICAgICBdKTsKCiAgICAgICAgfSBjYXRjaCAoXFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgREI6OnJvbGxiYWNrKCk7CgogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gZmFsc2UsCiAgICAgICAgICAgICAgICAnbWVzc2FnZScgPT4gJHRoLT5nZXRNZXNzYWdlKCkKICAgICAgICAgICAgXSk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogRGlzcGxheSB0aGUgc3BlY2lmaWVkIHJlc291cmNlLgogICAgICoKICAgICAqIEBwYXJhbSBcQXBwXE1vZGVsc1xQbXNNb2RlbHNcUmVxdWlzaXRpb24gJHJlcXVpc2l0aW9uCiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwogICAgcHVibGljIGZ1bmN0aW9uIHNob3coUmVxdWlzaXRpb24gJHJlcXVpc2l0aW9uKQogICAgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgICR0aXRsZSA9ICdSZXF1aXNpdGlvbiBTaG93JzsKICAgICAgICAgICAgJHJlcXVpc2l0aW9uID0gUmVxdWlzaXRpb246OndpdGgoJ2l0ZW1zJywgJ2l0ZW1zLnByb2R1Y3QnLCAnaXRlbXMucHJvZHVjdC5jYXRlZ29yeScsICdwcm9qZWN0VGFzaycpLT5maW5kT3JGYWlsKCRyZXF1aXNpdGlvbi0+aWQpOwoKICAgICAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnJlcXVpc2l0aW9ucy5zaG93JywgY29tcGFjdCgndGl0bGUnLCAncmVxdWlzaXRpb24nKSk7CiAgICAgICAgfSBjYXRjaCAoXFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIHNob3dSZXF1aXNpdGlvbigkaWQpCiAgICB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgJHRpdGxlID0gJ1JlcXVpc2l0aW9uIFNob3cnOwogICAgICAgICAgICAkcmVxdWlzaXRpb24gPSBSZXF1aXNpdGlvbjo6d2l0aChbCiAgICAgICAgICAgICAgICAncHJvamVjdFRhc2suc3ViRGVsaXZlcmFibGUuZGVsaXZlcmFibGUucHJvamVjdCcsCiAgICAgICAgICAgICAgICAnaXRlbXMucHJvZHVjdC5jYXRlZ29yeS5jYXRlZ29yeScsCiAgICAgICAgICAgICAgICAnaXRlbXMucHJvZHVjdC5wcm9kdWN0VW5pdCcsCiAgICAgICAgICAgICAgICAnaXRlbXMucHJvZHVjdC5hdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGUnLAogICAgICAgICAgICAgICAgJ2l0ZW1zLnByb2R1Y3QucmVsSW52ZW50b3J5U3VtbWFyeScsCiAgICAgICAgICAgICAgICAncmVsVXNlcnNMaXN0LmVtcGxveWVlLmxvY2F0aW9uJywKICAgICAgICAgICAgICAgICdyZWxVc2Vyc0xpc3QuZW1wbG95ZWUuZGVwYXJ0bWVudCcsCiAgICAgICAgICAgICAgICAncmVsVXNlcnNMaXN0LmVtcGxveWVlLnVuaXQnLAoKICAgICAgICAgICAgICAgICdpdGVtcy5hdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGUnLAogICAgICAgICAgICBdKS0+ZmluZE9yRmFpbCgkaWQpOwoKICAgICAgICAgICAgJGJvZHkgPSBWaWV3OjptYWtlKCdwbXMuYmFja2VuZC5wYWdlcy5yZXF1aXNpdGlvbnMuc2hvdycsCiAgICAgICAgICAgICAgICBbJ3JlcXVpc2l0aW9uJyA9PiAkcmVxdWlzaXRpb24sICd0aXRsZScgPT4gJHRpdGxlXSk7CiAgICAgICAgICAgICRjb250ZW50cyA9ICRib2R5LT5yZW5kZXIoKTsKCiAgICAgICAgICAgIGlmIChyZXF1ZXN0KCktPmhhcygndmlldycpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJGNvbnRlbnRzOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbigkY29udGVudHMpOwogICAgICAgIH0gY2F0Y2ggKFxUaHJvd2FibGUgJHRoKSB7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogU2hvdyB0aGUgZm9ybSBmb3IgZWRpdGluZyB0aGUgc3BlY2lmaWVkIHJlc291cmNlLgogICAgICoKICAgICAqIEBwYXJhbSBcQXBwXE1vZGVsc1xSZXF1aXNpdGlvbiAkcmVxdWlzaXRpb24KICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCiAgICBwdWJsaWMgZnVuY3Rpb24gZWRpdCgkaWQpCiAgICB7CiAgICAgICAgJHJlcXVpc2l0aW9uID0gUmVxdWlzaXRpb246OndpdGgoWwogICAgICAgICAgICAnaXRlbXMucHJvZHVjdCcKICAgICAgICBdKQogICAgICAgICAgICAtPndoZW4oaXNzZXQoQXV0aDo6dXNlcigpLT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCkgJiYgYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ0VtcGxveWVlJyksIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdhdXRob3JfaWQnLCBhdXRoKCktPnVzZXIoKS0+aWQpOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPndoZW4oYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ0RlcGFydG1lbnQtSGVhZCcpLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUluKCdhdXRob3JfaWQnLCBpbmNsdWRlVXNlcnMoKSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+d2hlbihhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnU0JVIEhlYWQnKSwgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVJbignYXV0aG9yX2lkJywgaW5jbHVkZVVzZXJzKCkpOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPndoZXJlKCdpZCcsICRpZCkKICAgICAgICAgICAgLT5maXJzdCgpOwoKICAgICAgICBpZiAoIWVtcHR5KCRyZXF1aXNpdGlvbikpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICR0aXRsZSA9ICdSZXF1aXNpdGlvbiBVcGRhdGUnOwoKICAgICAgICAgICAgICAgICRjYXRlZ29yeUlkID0gQ2F0ZWdvcnlEZXBhcnRtZW50Ojp3aGVuKGlzc2V0KGF1dGgoKS0+dXNlcigpLT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCksIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnaHJfZGVwYXJ0bWVudF9pZCcsIGF1dGgoKS0+dXNlcigpLT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCk7CiAgICAgICAgICAgICAgICB9KS0+cGx1Y2soJ2NhdGVnb3J5X2lkJyktPnRvQXJyYXkoKTsKCiAgICAgICAgICAgICAgICAkY2F0ZWdvcmllcyA9IENhdGVnb3J5Ojpkb2VzbnRIYXZlKCdjYXRlZ29yeScpCiAgICAgICAgICAgICAgICAgICAgLT53aXRoKFsnc3ViQ2F0ZWdvcnknXSkKICAgICAgICAgICAgICAgICAgICAtPndoZXJlSW4oJ2lkJywgJGNhdGVnb3J5SWQpCiAgICAgICAgICAgICAgICAgICAgLT53aGVyZShbCiAgICAgICAgICAgICAgICAgICAgICAgICdpc19maXhlZF9hc3NldCcgPT4gMCwKICAgICAgICAgICAgICAgICAgICAgICAgJ2lzX2N3aXAnID0+IDAsCiAgICAgICAgICAgICAgICAgICAgXSkKICAgICAgICAgICAgICAgICAgICAtPmdldCgpOwogICAgICAgICAgICAgICAgJGZpeGVkQXNzZXRDYXRlZ29yaWVzID0gQ2F0ZWdvcnk6OmRvZXNudEhhdmUoJ2NhdGVnb3J5JykKICAgICAgICAgICAgICAgICAgICAtPndpdGgoWydzdWJDYXRlZ29yeSddKQogICAgICAgICAgICAgICAgICAgIC0+d2hlcmVJbignaWQnLCAkY2F0ZWdvcnlJZCkKICAgICAgICAgICAgICAgICAgICAtPndoZXJlKFsKICAgICAgICAgICAgICAgICAgICAgICAgJ2lzX2ZpeGVkX2Fzc2V0JyA9PiAxLAogICAgICAgICAgICAgICAgICAgICAgICAnaXNfY3dpcCcgPT4gMCwKICAgICAgICAgICAgICAgICAgICBdKQogICAgICAgICAgICAgICAgICAgIC0+Z2V0KCk7CiAgICAgICAgICAgICAgICAkY3dpcENhdGVnb3JpZXMgPSBDYXRlZ29yeTo6ZG9lc250SGF2ZSgnY2F0ZWdvcnknKQogICAgICAgICAgICAgICAgICAgIC0+d2l0aChbJ3N1YkNhdGVnb3J5J10pCiAgICAgICAgICAgICAgICAgICAgLT53aGVyZUluKCdpZCcsICRjYXRlZ29yeUlkKQogICAgICAgICAgICAgICAgICAgIC0+d2hlcmUoWwogICAgICAgICAgICAgICAgICAgICAgICAnaXNfZml4ZWRfYXNzZXQnID0+IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICdpc19jd2lwJyA9PiAxLAogICAgICAgICAgICAgICAgICAgIF0pCiAgICAgICAgICAgICAgICAgICAgLT5nZXQoKTsKCiAgICAgICAgICAgICAgICAkY2F0ZWdvcnkgPSBDYXRlZ29yeTo6d2hlcmVIYXMoJ3N1YkNhdGVnb3J5LnByb2R1Y3RzJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgkcmVxdWlzaXRpb24pIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUluKCdpZCcsICRyZXF1aXNpdGlvbi0+aXRlbXMtPnBsdWNrKCdwcm9kdWN0X2lkJyktPnRvQXJyYXkoKSk7CiAgICAgICAgICAgICAgICB9KS0+Zmlyc3QoKTsKICAgICAgICAgICAgICAgICRjYXRlZ29yeV9pZCA9IChpc3NldCgkY2F0ZWdvcnktPmlkKSA/ICRjYXRlZ29yeS0+aWQgOiAwKTsKCiAgICAgICAgICAgICAgICAkcHJvamVjdHMgPSBbXTsKICAgICAgICAgICAgICAgICR0YXNrcyA9IFByb2plY3RUYXNrOjp3aXRoKFsKICAgICAgICAgICAgICAgICAgICAnc3ViRGVsaXZlcmFibGUuZGVsaXZlcmFibGUucHJvamVjdCcKICAgICAgICAgICAgICAgIF0pCiAgICAgICAgICAgICAgICAgICAgLT53aGVyZSgndXNlcl9pZCcsIGF1dGgoKS0+dXNlcigpLT5pZCkKICAgICAgICAgICAgICAgICAgICAtPmdldCgpOwogICAgICAgICAgICAgICAgaWYgKGlzc2V0KCR0YXNrc1swXSkpIHsKICAgICAgICAgICAgICAgICAgICBmb3JlYWNoICgkdGFza3MgYXMgJHRhc2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHByb2plY3RzW10gPSAkdGFzay0+c3ViRGVsaXZlcmFibGUtPmRlbGl2ZXJhYmxlLT5wcm9qZWN0OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICRwcm9qZWN0cyA9IFByb2plY3Q6OndoZXJlSW4oImlkIiwgYXJyYXlfa2V5cyhjb2xsZWN0KCRwcm9qZWN0cyktPmdyb3VwQnkoJ2lkJyktPnRvQXJyYXkoKSkpLT5nZXQoKTsKCiAgICAgICAgICAgICAgICAkZGVsaXZlcmFibGVzID0gW107CiAgICAgICAgICAgICAgICBpZiAoaXNzZXQoJHRhc2tzWzBdKSkgewogICAgICAgICAgICAgICAgICAgIGZvcmVhY2ggKCR0YXNrcyBhcyAkdGFzaykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHRhc2stPnN1YkRlbGl2ZXJhYmxlLT5kZWxpdmVyYWJsZS0+cHJvamVjdF9pZCA9PSAkcmVxdWlzaXRpb24tPnByb2plY3RfaWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRkZWxpdmVyYWJsZXNbXSA9ICR0YXNrLT5zdWJEZWxpdmVyYWJsZS0+ZGVsaXZlcmFibGU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAkZGVsaXZlcmFibGVzID0gRGVsaXZlcmFibGVzOjp3aGVyZUluKCJpZCIsIGFycmF5X2tleXMoY29sbGVjdCgkZGVsaXZlcmFibGVzKS0+Z3JvdXBCeSgnaWQnKS0+dG9BcnJheSgpKSktPmdldCgpOwoKICAgICAgICAgICAgICAgICRtb2RpZmllZE5hbWUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICR0YXNrID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAoJHJlcXVpc2l0aW9uLT5wcm9qZWN0X3Rhc2tfaWQpIHsKICAgICAgICAgICAgICAgICAgICAkdGFzayA9IFByb2plY3RUYXNrOjpmaW5kT3JGYWlsKCRyZXF1aXNpdGlvbi0+cHJvamVjdF90YXNrX2lkKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAkZXhwbGFuYXRpb25zID0gUmVxdWlzaXRpb25FeHBsYW5hdGlvbjo6YWxsKCk7CgogICAgICAgICAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnJlcXVpc2l0aW9ucy5lZGl0JywgY29tcGFjdCgndGl0bGUnLCAnY2F0ZWdvcmllcycsICdmaXhlZEFzc2V0Q2F0ZWdvcmllcycsICdjd2lwQ2F0ZWdvcmllcycsICdyZXF1aXNpdGlvbicsICdwcm9qZWN0cycsICdkZWxpdmVyYWJsZXMnLCAnY2F0ZWdvcnlfaWQnLCAnbW9kaWZpZWROYW1lJywgJ3Rhc2snLCAnZXhwbGFuYXRpb25zJykpOwogICAgICAgICAgICB9IGNhdGNoIChcVGhyb3dhYmxlICR0aCkgewogICAgICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChyZXF1ZXN0KCktPmhhcygncmVkaXJlY3QnKSAmJiByZXF1ZXN0KCktPmdldCgncmVkaXJlY3QnKSA9PSAnbGlzdC12aWV3JykgewogICAgICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5yZWRpcmVjdEJhY2tXaXRoRXJyb3IoJ1JlcXVpc2l0aW9uIG5vdCBmb3VuZCcsICdwbXMucmVxdWlzaXRpb24ubGlzdC52aWV3LmluZGV4Jyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJHRoaXMtPnJlZGlyZWN0QmFja1dpdGhFcnJvcignUmVxdWlzaXRpb24gbm90IGZvdW5kJywgJ3Btcy5yZXF1aXNpdGlvbi5yZXF1aXNpdGlvbi5pbmRleCcpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogVXBkYXRlIHRoZSBzcGVjaWZpZWQgcmVzb3VyY2UgaW4gc3RvcmFnZS4KICAgICAqCiAgICAgKiBAcGFyYW0gXElsbHVtaW5hdGVcSHR0cFxSZXF1ZXN0ICRyZXF1ZXN0CiAgICAgKiBAcGFyYW0gXEFwcFxNb2RlbHNcUmVxdWlzaXRpb24gJHJlcXVpc2l0aW9uCiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVkaXJlY3RSZXNwb25zZQogICAgICovCgogICAgcHVibGljIGZ1bmN0aW9uIHVwZGF0ZShSZXF1ZXN0ICRyZXF1ZXN0LCBSZXF1aXNpdGlvbiAkcmVxdWlzaXRpb24pCiAgICB7CiAgICAgICAgaWYgKCRyZXF1ZXN0LT5oYXNGaWxlKCdlZGl0X2ZpbGUnKSkgewogICAgICAgICAgICAkdGhpcy0+dmFsaWRhdGUoJHJlcXVlc3QsIFsKICAgICAgICAgICAgICAgICdlZGl0X2ZpbGUnID0+IFsnbWF4OjEwMDAwJ10sCiAgICAgICAgICAgIF0pOwogICAgICAgIH0KCiAgICAgICAgLy9CZWdpbiBkYiB0cmFuc2FjdGlvbi4KICAgICAgICBEQjo6YmVnaW5UcmFuc2FjdGlvbigpOwogICAgICAgIHRyeSB7CgogICAgICAgICAgICBpZiAoJHJlcXVpc2l0aW9uLT5zdGF0dXMgPT0gMSkgewogICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9uLT5yZW1hcmtzID0gJHJlcXVlc3QtPnJlbWFya3M7CiAgICAgICAgICAgICAgICBpZiAoJHJlcXVlc3QtPmhhc0ZpbGUoJ2VkaXRfZmlsZScpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFlbXB0eSgkcmVxdWlzaXRpb24tPmF0dGFjaG1lbnQpICYmIGZpbGVfZXhpc3RzKHB1YmxpY19wYXRoKCRyZXF1aXNpdGlvbi0+YXR0YWNobWVudCkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHVubGluayhwdWJsaWNfcGF0aCgkcmVxdWlzaXRpb24tPmF0dGFjaG1lbnQpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9uLT5hdHRhY2htZW50ID0gJHRoaXMtPmZpbGVVcGxvYWQoJHJlcXVlc3QtPmZpbGUoJ2VkaXRfZmlsZScpLCAndXBsb2FkL3JlcXVpc2l0aW9uLWF0dGFjaG1lbnRzJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb24tPnNhdmUoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIFJlcXVpc2l0aW9uSXRlbUF0dHJpYnV0ZTo6d2hlcmVJbigncmVxdWlzaXRpb25faXRlbV9pZCcsICRyZXF1aXNpdGlvbi0+aXRlbXMtPnBsdWNrKCdpZCcpLT50b0FycmF5KCkpLT5kZWxldGUoKTsKICAgICAgICAgICAgICAgIFJlcXVpc2l0aW9uSXRlbTo6d2hlcmUoJ3JlcXVpc2l0aW9uX2lkJywgJHJlcXVpc2l0aW9uLT5pZCktPmRlbGV0ZSgpOwoKICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbi0+cmVxdWlzaXRpb25fZGF0ZSA9IGRhdGUoJ1ktbS1kIGg6aTpzJywgc3RydG90aW1lKCRyZXF1ZXN0LT5yZXF1aXNpdGlvbl9kYXRlKSk7CgogICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9uLT5yZW1hcmtzID0gJHJlcXVlc3QtPnJlbWFya3M7CiAgICAgICAgICAgICAgICBpZiAoJHJlcXVlc3QtPmhhc0ZpbGUoJ2VkaXRfZmlsZScpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFlbXB0eSgkcmVxdWlzaXRpb24tPmF0dGFjaG1lbnQpICYmIGZpbGVfZXhpc3RzKHB1YmxpY19wYXRoKCRyZXF1aXNpdGlvbi0+YXR0YWNobWVudCkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHVubGluayhwdWJsaWNfcGF0aCgkcmVxdWlzaXRpb24tPmF0dGFjaG1lbnQpKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbi0+YXR0YWNobWVudCA9ICR0aGlzLT5maWxlVXBsb2FkKCRyZXF1ZXN0LT5maWxlKCdlZGl0X2ZpbGUnKSwgJ3VwbG9hZC9yZXF1aXNpdGlvbi1hdHRhY2htZW50cycpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbi0+c2F2ZSgpOwoKICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRyZXF1ZXN0LT5wcm9kdWN0X2lkIGFzICRrZXkgPT4gJHByb2R1Y3RfaWQpIHsKICAgICAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb25JdGVtSW5wdXRbXSA9IFsKICAgICAgICAgICAgICAgICAgICAgICAgJ3JlcXVpc2l0aW9uX2lkJyA9PiAkcmVxdWlzaXRpb24tPmlkLAogICAgICAgICAgICAgICAgICAgICAgICAncHJvZHVjdF9pZCcgPT4gJHJlcXVlc3QtPnByb2R1Y3RfaWRbJGtleV0sCiAgICAgICAgICAgICAgICAgICAgICAgICd1bml0X3ByaWNlJyA9PiAocmVxdWVzdCgpLT5oYXMoJ2VkaXRvcicpICYmIHJlcXVlc3QoKS0+Z2V0KCdlZGl0b3InKSA9PSAiYm9zcyIgPyAkcmVxdWVzdC0+b2xkX3VuaXRfcHJpY2VbJGtleV0gOiAkcmVxdWVzdC0+dW5pdF9wcmljZVska2V5XSksCiAgICAgICAgICAgICAgICAgICAgICAgICdxdHknID0+ICRyZXF1ZXN0LT5xdHlbJGtleV0sCiAgICAgICAgICAgICAgICAgICAgICAgICdyZXF1aXNpdGlvbl9xdHknID0+IChyZXF1ZXN0KCktPmhhcygnZWRpdG9yJykgJiYgcmVxdWVzdCgpLT5nZXQoJ2VkaXRvcicpID09ICJib3NzIiA/ICRyZXF1ZXN0LT5vbGRfcXR5WyRrZXldIDogJHJlcXVlc3QtPnF0eVska2V5XSksCiAgICAgICAgICAgICAgICAgICAgICAgICdjcmVhdGVkX2F0JyA9PiBkYXRlKCdZLW0tZCBoOmk6cycpLAogICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgUmVxdWlzaXRpb25JdGVtOjppbnNlcnQoJHJlcXVpc2l0aW9uSXRlbUlucHV0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgJHJlcXVpc2l0aW9uLT5leHBsYW5hdGlvbnMgPSBqc29uX2VuY29kZShpc3NldCgkcmVxdWVzdC0+ZXhwbGFuYXRpb25zWzBdKSA/ICRyZXF1ZXN0LT5leHBsYW5hdGlvbnMgOiBbXSk7CiAgICAgICAgICAgICRyZXF1aXNpdGlvbi0+c2F2ZSgpOwoKCiAgICAgICAgICAgICRpdGVtcyA9IFJlcXVpc2l0aW9uSXRlbTo6d2hlcmUoJ3JlcXVpc2l0aW9uX2lkJywgJHJlcXVpc2l0aW9uLT5pZCktPmdldCgpOwogICAgICAgICAgICAkYXR0cmlidXRlcyA9IFtdOwogICAgICAgICAgICBpZiAoaXNzZXQoJGl0ZW1zWzBdKSkgewogICAgICAgICAgICAgICAgZm9yZWFjaCAoJGl0ZW1zIGFzICRpdGVtKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzc2V0KCRyZXF1ZXN0LT5hdHRyaWJ1dGVfb3B0aW9uc1skaXRlbS0+cHJvZHVjdF9pZF0pICYmIGlzX2FycmF5KCRyZXF1ZXN0LT5hdHRyaWJ1dGVfb3B0aW9uc1skaXRlbS0+cHJvZHVjdF9pZF0pICYmIGNvdW50KCRyZXF1ZXN0LT5hdHRyaWJ1dGVfb3B0aW9uc1skaXRlbS0+cHJvZHVjdF9pZF0pID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3JlYWNoICgkcmVxdWVzdC0+YXR0cmlidXRlX29wdGlvbnNbJGl0ZW0tPnByb2R1Y3RfaWRdIGFzICRhdHRyaWJ1dGVfaWQgPT4gJGF0dHJpYnV0ZV9vcHRpb25faWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc3NldCgkcmVxdWVzdC0+cHJvZHVjdF9hdHRyaWJ1dGVzWyRpdGVtLT5wcm9kdWN0X2lkXSkgJiYgaW5fYXJyYXkoJGF0dHJpYnV0ZV9pZCwgJHJlcXVlc3QtPnByb2R1Y3RfYXR0cmlidXRlc1skaXRlbS0+cHJvZHVjdF9pZF0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXlfcHVzaCgkYXR0cmlidXRlcywgWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAncmVxdWlzaXRpb25faXRlbV9pZCcgPT4gJGl0ZW0tPmlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnYXR0cmlidXRlX29wdGlvbl9pZCcgPT4gJGF0dHJpYnV0ZV9vcHRpb25faWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdjcmVhdGVkX2J5JyA9PiAkcmVxdWlzaXRpb24tPmF1dGhvcl9pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3VwZGF0ZWRfYnknID0+IGF1dGgoKS0+dXNlcigpLT5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGlzc2V0KCRhdHRyaWJ1dGVzWzBdKSkgewogICAgICAgICAgICAgICAgUmVxdWlzaXRpb25JdGVtQXR0cmlidXRlOjppbnNlcnQoJGF0dHJpYnV0ZXMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBEQjo6Y29tbWl0KCk7CgogICAgICAgICAgICBpZiAocmVxdWVzdCgpLT5oYXMoJ3JlZGlyZWN0JykgJiYgcmVxdWVzdCgpLT5nZXQoJ3JlZGlyZWN0JykgPT0gJ2xpc3QtdmlldycpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkdGhpcy0+cmVkaXJlY3RCYWNrV2l0aFN1Y2Nlc3MoJ1JlcXVpc2l0aW9uIGhhcyBiZWVuIHN1Y2Nlc3NmdWxseSBVcGRhdGVkJywgJ3Btcy5yZXF1aXNpdGlvbi5saXN0LnZpZXcuaW5kZXgnKTsKICAgICAgICAgICAgfSBlbHNlaWYgKHJlcXVlc3QoKS0+aGFzKCdyZWRpcmVjdCcpICYmIHJlcXVlc3QoKS0+Z2V0KCdyZWRpcmVjdCcpID09ICdoYWx0LXJlcXVpc2l0aW9uJykgewogICAgICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5yZWRpcmVjdEJhY2tXaXRoU3VjY2VzcygnUmVxdWlzaXRpb24gaGFzIGJlZW4gc3VjY2Vzc2Z1bGx5IFVwZGF0ZWQnLCAncG1zLnJlcXVpc2l0aW9uLmhhbHQucmVxdWlzaXRpb24uaW5kZXgnKTsKICAgICAgICAgICAgfSBlbHNlaWYgKHJlcXVlc3QoKS0+aGFzKCdyZWRpcmVjdCcpICYmIHJlcXVlc3QoKS0+Z2V0KCdyZWRpcmVjdCcpID09ICdwYXNzZWQtcmVxdWlzaXRpb24tYXBwcm92YWwnKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJHRoaXMtPnJlZGlyZWN0QmFja1dpdGhTdWNjZXNzKCdSZXF1aXNpdGlvbiBoYXMgYmVlbiBzdWNjZXNzZnVsbHkgVXBkYXRlZCcsICdwbXMucmVxdWlzaXRpb24ucGFzc2VkLXJlcXVpc2l0aW9uLWFwcHJvdmFsJyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJHRoaXMtPnJlZGlyZWN0QmFja1dpdGhTdWNjZXNzKCdSZXF1aXNpdGlvbiBoYXMgYmVlbiBzdWNjZXNzZnVsbHkgVXBkYXRlZCcsICdwbXMucmVxdWlzaXRpb24ucmVxdWlzaXRpb24uaW5kZXgnKTsKICAgICAgICAgICAgfQoKICAgICAgICB9IGNhdGNoIChcVGhyb3dhYmxlICR0aCkgewogICAgICAgICAgICBEQjo6cm9sbGJhY2soKTsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBSZW1vdmUgdGhlIHNwZWNpZmllZCByZXNvdXJjZSBmcm9tIHN0b3JhZ2UuCiAgICAgKgogICAgICogQHBhcmFtIFxBcHBcTW9kZWxzXFJlcXVpc2l0aW9uICRyZXF1aXNpdGlvbgogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXEpzb25SZXNwb25zZQogICAgICovCiAgICBwdWJsaWMgZnVuY3Rpb24gZGVzdHJveSgkaWQpCiAgICB7CiAgICAgICAgJHJlcXVpc2l0aW9uID0gUmVxdWlzaXRpb246OmZpbmQoJGlkKTsKICAgICAgICBpZiAoIWluX2FycmF5KCRyZXF1aXNpdGlvbi0+c3RhdHVzLCBbMCwgMiwgM10pKSB7CiAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiBmYWxzZSwKICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAiUmVxdWlzaXRpb24gY2Fubm90IGJlIGRlbGV0ZWQhIgogICAgICAgICAgICBdKTsKICAgICAgICB9CgogICAgICAgICRyZXF1aXNpdGlvbiA9IFJlcXVpc2l0aW9uOjpmaW5kKCRpZCk7CiAgICAgICAgJGRlbGV0ZSA9IFJlcXVpc2l0aW9uOjpmaW5kKCRpZCktPmRlbGV0ZSgpOwogICAgICAgIGlmICgkZGVsZXRlKSB7CiAgICAgICAgICAgIGlmICghZW1wdHkoJHJlcXVpc2l0aW9uLT5hdHRhY2htZW50KSAmJiBmaWxlX2V4aXN0cyhwdWJsaWNfcGF0aCgkcmVxdWlzaXRpb24tPmF0dGFjaG1lbnQpKSkgewogICAgICAgICAgICAgICAgdW5saW5rKHB1YmxpY19wYXRoKCRyZXF1aXNpdGlvbi0+YXR0YWNobWVudCkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gdHJ1ZSwKICAgICAgICAgICAgXSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICdzdWNjZXNzJyA9PiBmYWxzZSwKICAgICAgICAgICAgJ21lc3NhZ2UnID0+ICJTb21ldGhpbmcgd2VudCB3cm9uZyEiCiAgICAgICAgXSk7CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIGRlc3Ryb3lJdGVtKFJlcXVpc2l0aW9uSXRlbSAkaXRlbSkKICAgIHsKICAgICAgICB0cnkgewogICAgICAgICAgICAkcmVxdWlzaXRpb24gPSAkaXRlbS0+cmVxdWlzaXRpb247CiAgICAgICAgICAgICRpdGVtLT5kZWxldGUoKTsKICAgICAgICAgICAgaWYgKCRyZXF1aXNpdGlvbi0+aXRlbXMtPmNvdW50KCkgPCAxKSB7CiAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb24tPmRlbGV0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKCRyZXF1aXNpdGlvbi0+aXRlbXMtPmNvdW50KCkpOwogICAgICAgIH0gY2F0Y2ggKFxUaHJvd2FibGUgJHRoKSB7CiAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBSZnAgbGlzdCB2aWV3LgogICAgICovCiAgICBwdWJsaWMgZnVuY3Rpb24gdXNlckhlYWRlckNvbHVtbnMoJHZhbHVlID0gJycpCiAgICB7CiAgICAgICAgJHJvdyA9IGFycmF5KAogICAgICAgICAgICBbJ1NMJywgJ1NMJ10sCiAgICAgICAgICAgIFsncmVmZXJlbmNlX25vJywgJ3JlZmVyZW5jZV9ubycsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3JlcXVpc2l0aW9uX2RhdGUnLCAncmVxdWlzaXRpb25fZGF0ZScsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3Byb2R1Y3RfY2F0ZWdvcnknLCAncHJvZHVjdF9jYXRlZ29yeScsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3JlcXVpc2l0aW9uX2J5JywgJ3JlcXVpc2l0aW9uX2J5JywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsndW5pdCcsICd1bml0JywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsnYXR0YWNobWVudCcsICdhdHRhY2htZW50JywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsnc3RhdHVzJywgJ3N0YXR1cycsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ2FjdGlvbnMnLCAnYWN0aW9ucycsICd0ZXh0LWNlbnRlciddCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gJHJvdzsKICAgIH0KCiAgICBwdWJsaWMgZnVuY3Rpb24gcmVxdWlzaXRpb25MaXN0VmlldygpCiAgICB7CiAgICAgICAgdHJ5IHsKCiAgICAgICAgICAgICR0aXRsZSA9ICdVc2VyIFJlcXVpc2l0aW9uIExpc3QnOwogICAgICAgICAgICAkc3RhdHVzID0gcmVxdWVzdCgpLT5oYXMoJ3N0YXR1cycpID8gcmVxdWVzdCgpLT5nZXQoJ3N0YXR1cycpIDogLTE7CiAgICAgICAgICAgICRmcm9tID0gcmVxdWVzdCgpLT5oYXMoJ2Zyb20nKSA/IHJlcXVlc3QoKS0+Z2V0KCdmcm9tJykgOiBkYXRlKCdZLW0tMDEnKTsKICAgICAgICAgICAgJHRvID0gcmVxdWVzdCgpLT5oYXMoJ3RvJykgPyByZXF1ZXN0KCktPmdldCgndG8nKSA6IGRhdGUoJ1ktbS10Jyk7CiAgICAgICAgICAgICRjYXRlZ29yeV9pZCA9IHJlcXVlc3QoKS0+aGFzKCdjYXRlZ29yeV9pZCcpID8gcmVxdWVzdCgpLT5nZXQoJ2NhdGVnb3J5X2lkJykgOiAwOwogICAgICAgICAgICAkYXV0aG9yX2lkID0gcmVxdWVzdCgpLT5oYXMoJ2F1dGhvcl9pZCcpID8gcmVxdWVzdCgpLT5nZXQoJ2F1dGhvcl9pZCcpIDogMDsKCiAgICAgICAgICAgICRjYXRlZ29yaWVzID0gQ2F0ZWdvcnk6OmRvZXNudEhhdmUoJ2NhdGVnb3J5JykKICAgICAgICAgICAgICAgIC0+d2hlcmVIYXMoJ2RlcGFydG1lbnRzTGlzdCcsIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUluKCdocl9kZXBhcnRtZW50X2lkJywgYXV0aCgpLT51c2VyKCktPnByaW9yaXRpZXMtPnBsdWNrKCdocl9kZXBhcnRtZW50X2lkJyktPnRvQXJyYXkoKSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5nZXQoKTsKCiAgICAgICAgICAgICRpbmNsdWRlVXNlcnMgPSBpbmNsdWRlVXNlcnMoKTsKCiAgICAgICAgICAgICRyZXF1aXNpdGlvblVzZXJMaXN0cyA9IFJlcXVpc2l0aW9uOjp3aGVyZUluKCdhdXRob3JfaWQnLCAkaW5jbHVkZVVzZXJzKQogICAgICAgICAgICAgICAgLT5qb2luKCd1c2VycycsICd1c2Vycy5pZCcsICc9JywgJ3JlcXVpc2l0aW9ucy5hdXRob3JfaWQnKQogICAgICAgICAgICAgICAgLT5ncm91cEJ5KCdyZXF1aXNpdGlvbnMuYXV0aG9yX2lkJykKICAgICAgICAgICAgICAgIC0+Z2V0KFsndXNlcnMuaWQnLCAndXNlcnMubmFtZSddKTsKCiAgICAgICAgICAgICRkYXRhID0gWwogICAgICAgICAgICAgICAgJ3RpdGxlJyA9PiAnUmVxdWlzaXRpb24nLAogICAgICAgICAgICAgICAgJ3JlcXVpc2l0aW9uVXNlckxpc3RzJyA9PiAkcmVxdWlzaXRpb25Vc2VyTGlzdHMsCiAgICAgICAgICAgICAgICAnZnJvbScgPT4gJGZyb20sCiAgICAgICAgICAgICAgICAndG8nID0+ICR0bywKICAgICAgICAgICAgICAgICdzdGF0dXMnID0+ICRzdGF0dXMsCiAgICAgICAgICAgICAgICAnY2F0ZWdvcnlfaWQnID0+ICRjYXRlZ29yeV9pZCwKICAgICAgICAgICAgICAgICdhdXRob3JfaWQnID0+ICRhdXRob3JfaWQsCiAgICAgICAgICAgICAgICAnY2F0ZWdvcmllcycgPT4gJGNhdGVnb3JpZXMsCiAgICAgICAgICAgICAgICAnaGVhZGVyQ29sdW1ucycgPT4gJHRoaXMtPnVzZXJIZWFkZXJDb2x1bW5zKCkKICAgICAgICAgICAgXTsKCiAgICAgICAgICAgICRyZXF1aXNpdGlvbnMgPSBSZXF1aXNpdGlvbjo6d2l0aChbJ2l0ZW1zJywgJ2l0ZW1zLnByb2R1Y3QuY2F0ZWdvcnkuY2F0ZWdvcnknLCAncmVsVXNlcnNMaXN0JywgJ3JlbFVzZXJzTGlzdC5lbXBsb3llZS51bml0J10pCiAgICAgICAgICAgICAgICAtPndoZXJlSW4oJ2F1dGhvcl9pZCcsICRpbmNsdWRlVXNlcnMpCiAgICAgICAgICAgICAgICAtPndoZW4oc3RydG90aW1lKCRmcm9tKSA+IDAsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGZyb20pIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZURhdGUoJ3JlcXVpc2l0aW9uX2RhdGUnLCAnPj0nLCAkZnJvbSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT53aGVuKHN0cnRvdGltZSgkdG8pID4gMCwgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgkdG8pIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZURhdGUoJ3JlcXVpc2l0aW9uX2RhdGUnLCAnPD0nLCAkdG8pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+d2hlbigkc3RhdHVzID49IDAsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJHN0YXR1cykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdzdGF0dXMnLCAkc3RhdHVzKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPndoZW4oJGF1dGhvcl9pZCA+IDAsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGF1dGhvcl9pZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdhdXRob3JfaWQnLCAkYXV0aG9yX2lkKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPndoZW4oJGNhdGVnb3J5X2lkID4gMCwgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgkY2F0ZWdvcnlfaWQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygnaXRlbXMucHJvZHVjdC5jYXRlZ29yeS5jYXRlZ29yeScsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGNhdGVnb3J5X2lkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdpZCcsICRjYXRlZ29yeV9pZCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT53aGVuKCFkYXRhdGFibGVPcmRlcmluZygpLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+b3JkZXJieSgnaWQnLCAnZGVzYycpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+d2hlcmVOb3RJbignc3RhdHVzJywgWzNdKQogICAgICAgICAgICAgICAgLT53aGVyZSgnaXNfcGFzc2VkJywgJ25vJyk7CgogICAgICAgICAgICBpZiAocmVxdWVzdCgpLT5hamF4KCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBEYXRhdGFibGVzOjpvZigkcmVxdWlzaXRpb25zKQogICAgICAgICAgICAgICAgICAgIC0+YWRkSW5kZXhDb2x1bW4oKQogICAgICAgICAgICAgICAgICAgIC0+ZWRpdENvbHVtbigncmVmZXJlbmNlX25vJywgZnVuY3Rpb24gKCRyZXF1aXNpdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgZGF0YS1zcmM9IicgLiByb3V0ZSgncG1zLnJlcXVpc2l0aW9uLmxpc3Qudmlldy5zaG93JywgJHJlcXVpc2l0aW9uLT5pZCkgLiAnIiBjbGFzcz0iYnRuIGJ0bi1saW5rIHJlcXVpc2l0aW9uIG0tMSByb3VuZGVkIHNob3dSZXF1aXN0aW9uRGV0YWlscyIgb25jbGljaz0icmVxdWlzdGlvbkRldGFpbHMoJCh0aGlzKSkiPicgLiAkcmVxdWlzaXRpb24tPnJlZmVyZW5jZV9ubyAuICc8L2E+JzsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZWRpdENvbHVtbigncmVxdWlzaXRpb25fZGF0ZScsIGZ1bmN0aW9uICgkcmVxdWlzaXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRhdGUoJ1ktbS1kJywgc3RydG90aW1lKCRyZXF1aXNpdGlvbi0+cmVxdWlzaXRpb25fZGF0ZSkpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbigncmVxdWlzaXRpb25fZGF0ZScsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT5vcmRlckJ5KCdyZXF1aXNpdGlvbl9kYXRlJywgJG9yZGVyKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdwcm9kdWN0X2NhdGVnb3J5JywgZnVuY3Rpb24gKCRyZXF1aXNpdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNzZXQoJHJlcXVpc2l0aW9uLT5pdGVtc1swXS0+cHJvZHVjdC0+Y2F0ZWdvcnktPmNhdGVnb3J5LT5uYW1lKSA/ICRyZXF1aXNpdGlvbi0+aXRlbXNbMF0tPnByb2R1Y3QtPmNhdGVnb3J5LT5jYXRlZ29yeS0+bmFtZSA6ICcnOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3Byb2R1Y3RfY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygnaXRlbXMucHJvZHVjdC5jYXRlZ29yeS5jYXRlZ29yeScsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdwcm9kdWN0X2NhdGVnb3J5JywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwbGVhc2VTb3J0TWUoJHF1ZXJ5LCAkb3JkZXIsIFJlcXVpc2l0aW9uSXRlbTo6c2VsZWN0KCdtYWluX2NhdGVnb3J5Lm5hbWUnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdwcm9kdWN0cycsICdwcm9kdWN0cy5pZCcsICc9JywgJ3JlcXVpc2l0aW9uX2l0ZW1zLnByb2R1Y3RfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdjYXRlZ29yaWVzIGFzIHN1Yl9jYXRlZ29yeScsICdzdWJfY2F0ZWdvcnkuaWQnLCAnPScsICdwcm9kdWN0cy5jYXRlZ29yeV9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ2NhdGVnb3JpZXMgYXMgbWFpbl9jYXRlZ29yeScsICdtYWluX2NhdGVnb3J5LmlkJywgJz0nLCAnc3ViX2NhdGVnb3J5LnBhcmVudF9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCdyZXF1aXNpdGlvbl9pdGVtcy5yZXF1aXNpdGlvbl9pZCcsICdyZXF1aXNpdGlvbnMuaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT50YWtlKDEpCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbigncmVxdWlzaXRpb25fYnknLCBmdW5jdGlvbiAoJHJlcXVpc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpc3NldCgkcmVxdWlzaXRpb24tPnJlbFVzZXJzTGlzdC0+bmFtZSkgPyAkcmVxdWlzaXRpb24tPnJlbFVzZXJzTGlzdC0+bmFtZSA6ICcnOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3JlcXVpc2l0aW9uX2J5JywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFVzZXJzTGlzdCcsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdyZXF1aXNpdGlvbl9ieScsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBVc2VyOjpzZWxlY3QoJ25hbWUnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbigndXNlcnMuaWQnLCAncmVxdWlzaXRpb25zLmF1dGhvcl9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbigndW5pdCcsIGZ1bmN0aW9uICgkcmVxdWlzaXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzc2V0KCRyZXF1aXNpdGlvbi0+cmVsVXNlcnNMaXN0LT5lbXBsb3llZS0+dW5pdC0+aHJfdW5pdF9zaG9ydF9uYW1lKSA/ICRyZXF1aXNpdGlvbi0+cmVsVXNlcnNMaXN0LT5lbXBsb3llZS0+dW5pdC0+aHJfdW5pdF9zaG9ydF9uYW1lIDogJyc7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbigndW5pdCcsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxVc2Vyc0xpc3QuZW1wbG95ZWUudW5pdCcsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ2hyX3VuaXRfc2hvcnRfbmFtZScsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ3VuaXQnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgXEFwcFxVc2VyOjpzZWxlY3QoJ2hyX3VuaXQuaHJfdW5pdF9zaG9ydF9uYW1lJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbignaHJfYXNfYmFzaWNfaW5mbycsICdocl9hc19iYXNpY19pbmZvLmFzc29jaWF0ZV9pZCcsICc9JywgJ3VzZXJzLmFzc29jaWF0ZV9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ2hyX3VuaXQnLCAnaHJfdW5pdC5ocl91bml0X2lkJywgJz0nLCAnaHJfYXNfYmFzaWNfaW5mby5hc191bml0X2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3VzZXJzLmlkJywgJ3JlcXVpc2l0aW9ucy5hdXRob3JfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2F0dGFjaG1lbnQnLCBmdW5jdGlvbiAoJHJlcXVpc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRhdHRhY2htZW50ID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnRW1wbG95ZWUnKSB8fCBhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnRGVwYXJ0bWVudC1IZWFkJykgfHwgYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ1B1cmNoYXNlLURlcGFydG1lbnQnKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFlbXB0eSgkcmVxdWlzaXRpb24tPmF0dGFjaG1lbnQpICYmIGZpbGVfZXhpc3RzKHB1YmxpY19wYXRoKCRyZXF1aXNpdGlvbi0+YXR0YWNobWVudCkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGF0dGFjaG1lbnQgLj0gJzxhIGhyZWY9IicgLiB1cmwoJHJlcXVpc2l0aW9uLT5hdHRhY2htZW50KSAuICciIHRhcmdldD0iX2JsYW5rIiBjbGFzcz0iYnRuIGJ0bi14cyBidG4tcHJpbWFyeSI+PGkgY2xhc3M9ImxhcyBsYS1wYXBlcmNsaXAiPjwvaT5BdHRhY2htZW50PC9hPic7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRhdHRhY2htZW50OwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5lZGl0Q29sdW1uKCdzdGF0dXMnLCBmdW5jdGlvbiAoJHJlcXVpc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRzdGF0dXMgPSAnJzsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkcmVxdWlzaXRpb24tPnN0YXR1cyA9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc3RhdHVzIC49ICc8c3BhbiBjbGFzcz0iYnRuIGJ0bi14cyBidG4td2FybmluZyI+UGVuZGluZzwvc3Bhbj4nOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2VpZiAoJHJlcXVpc2l0aW9uLT5zdGF0dXMgPT0gMSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzdGF0dXMgLj0gJzxzcGFuIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi1zdWNjZXNzIj5BY2tub3dsZWRnZTwvc3Bhbj4nOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2VpZiAoJHJlcXVpc2l0aW9uLT5zdGF0dXMgPT0gMikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHN0YXR1cyAuPSAnPHNwYW4gY2xhc3M9ImJ0biBidG4teHMgYnRuLWRhbmdlciI+SGFsdDwvc3Bhbj4nOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICRzdGF0dXMgLj0gJzwvcD4nOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHN0YXR1czsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdhY3Rpb25zJywgZnVuY3Rpb24gKCR2YWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgPSAnJzsKCiAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICc8ZGl2IGNsYXNzPSJidG4tZ3JvdXAiPjxidXR0b24gY2xhc3M9ImJ0biBkcm9wZG93bi10b2dnbGUiIGRhdGEtdG9nZ2xlPSJkcm9wZG93biI+PHNwYW4gaWQ9InN0YXR1c05hbWUnIC4gJHZhbHVlcy0+aWQgLiAnIj48aSBjbGFzcz0ibGEgbGEtZWxsaXBzaXMtdiI+PC9pPjwvc3Bhbj48L2J1dHRvbj48dWwgY2xhc3M9ImRyb3Bkb3duLW1lbnUiPic7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHZhbHVlcy0+aXNfc2VuZF90b19yZnAgPT0gJ25vJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCR2YWx1ZXMtPnN0YXR1cyAhPSAwICYmIGF1dGgoKS0+dXNlcigpLT5oYXNQZXJtaXNzaW9uVG8oJ3BlbmRpbmcnKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICc8bGk+PGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiB0aXRsZT0iQ2xpY2sgSGVyZSBUbyBQZW5kaW5nIiBjbGFzcz0icmVxdWlzaXRpb25BcHByb3ZlZEJ0biIgZGF0YS1pZD0iJyAuICR2YWx1ZXMtPmlkIC4gJyIgb25jbGljaz0icmVxdWlzaXRpb25BcHByb3ZlZEJ0bigkKHRoaXMpKSIgIGRhdGEtZGF0YT0icGVuZGluZyIgZGF0YS1zdGF0dXM9IjAiPjxpIGNsYXNzPSJsYSBsYS1wYXVzZSI+PC9pPiZuYnNwO1BlbmRpbmc8L2E+PC9saT4nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxsaT48YSBocmVmPSInIC4gcm91dGUoJ3Btcy5yZXF1aXNpdGlvbi5yZXF1aXNpdGlvbi5lZGl0JywgJHZhbHVlcy0+aWQpIC4gJz9yZWRpcmVjdD1saXN0LXZpZXcmZWRpdG9yPWJvc3MiIHRpdGxlPSJDbGljayBIZXJlIFRvIEVkaXQiPjxpIGNsYXNzPSJsYSBsYS1lZGl0Ij48L2k+Jm5ic3A7RWRpdDwvYT48L2xpPic7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCR2YWx1ZXMtPnN0YXR1cyAhPSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGF1dGgoKS0+dXNlcigpLT5oYXNQZXJtaXNzaW9uVG8oJ3JlcXVpc2l0aW9uLWFja25vd2xlZGdlJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxsaT48YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIHRpdGxlPSJDbGljayBIZXJlIFRvIEFja25vd2xlZGdlIiBjbGFzcz0icmVxdWlzaXRpb25BcHByb3ZlZEJ0biIgb25jbGljaz0icmVxdWlzaXRpb25BcHByb3ZlZEJ0bigkKHRoaXMpKSIgZGF0YS1pZD0iJyAuICR2YWx1ZXMtPmlkIC4gJyIgZGF0YS1kYXRhPSJhY2tub3dsZWRnZWQiIGRhdGEtc3RhdHVzPSIxIj48aSBjbGFzcz0ibGEgbGEtY2hlY2siPjwvaT4mbmJzcDtBY2tub3dsZWRnZTwvYT48L2xpPic7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ0RlcGFydG1lbnQtSGVhZCcpICYmICR2YWx1ZXMtPmlzX3Bhc3NlZCA9PSAnbm8nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnPGxpPjxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgdGl0bGU9IlNlbmQgdG8gTWFuYWdlbWVudCIgY2xhc3M9InJlcXVpc2l0aW9uQXBwcm92ZWRCdG4iIG9uY2xpY2s9InNlbmRUb01hbmFnZW1lbnQoJCh0aGlzKSkiIGRhdGEtc3JjPSInIC4gcm91dGUoJ3Btcy5yZXF1aXNpdGlvbi5yZXF1aXNpdGlvbnMuc2VuZFRvTWFuYWdlbWVudCcpIC4gJyIgZGF0YS1pZD0iJyAuICR2YWx1ZXMtPmlkIC4gJyI+PGkgY2xhc3M9ImxhIGxhLXBhcGVyLXBsYW5lIj48L2k+Jm5ic3A7U2VuZCB0byBNYW5hZ2VtZW50PC9hPjwvbGk+JzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXV0aCgpLT51c2VyKCktPmhhc1Blcm1pc3Npb25UbygnaGFsdCcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCR2YWx1ZXMtPnN0YXR1cyAhPSAyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICc8bGk+PGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiB0aXRsZT0iQ2xpY2sgSGVyZSBUbyBIYWx0IiBjbGFzcz0icmVxdWlzaXRpb25BcHByb3ZlZEJ0biIgb25jbGljaz0icmVxdWlzaXRpb25BcHByb3ZlZEJ0bigkKHRoaXMpKSIgZGF0YS1kYXRhPSJoYWx0IiBkYXRhLWlkPSInIC4gJHZhbHVlcy0+aWQgLiAnIiBkYXRhLXN0YXR1cz0iMiI+PGkgY2xhc3M9ImxhIGxhLWJhbiI+PC9pPiZuYnNwO0hhbHQ8L2E+PC9saT4nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXV0aCgpLT51c2VyKCktPmhhc1Blcm1pc3Npb25Ubygnc2VuZC10by1yZnAnKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxsaT48YSBjbGFzcz0ic2VuZFRvUHVyY2hhc2VEZXBhcnRtZW50IiBkYXRhLXNyYz0iJyAuIHJvdXRlKCdwbXMuc3RvcmUtbWFuYWdlLnNlbmQudG8ucHVyY2hhc2UuZGVwYXJ0bWVudCcpIC4gJyIgb25jbGljaz0ic2VuZFRvUHVyY2hhc2VEZXBhcnRtZW50KCQodGhpcykpIiAgZGF0YS1pZD0iJyAuICR2YWx1ZXMtPmlkIC4gJyIgIHRpdGxlPSJTZW5kIFRvIHByb2N1cmVtZW50Ij4mbmJzcDtTZW5kIFRvIFByb2N1cmVtZW50PC9hPjwvbGk+JzsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxsaT48YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIHRpdGxlPSJUcmFja2luZyBSZXF1aXNpdGlvbiIgY2xhc3M9InRyYWNraW5nUmVxdWlzdGlvblN0YXR1cyIgb25jbGljaz0idHJhY2tpbmdSZXF1aXN0aW9uU3RhdHVzKCcgLiAkdmFsdWVzLT5pZCAuICcpIiA+PGkgY2xhc3M9ImxhIGxhLW1hcCI+PC9pPiZuYnNwO1RyYWNrIFByb2dyZXNzPC9hPjwvbGk+JzsKCiAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICc8bGk+PGEgdGFyZ2V0PSJfX2JsYW5rIiBocmVmPSInIC4gcm91dGUoJ3Btcy5yZXF1aXNpdGlvbi5oaXN0b3J5JywgJHZhbHVlcy0+aWQpIC4gJyI+PGkgY2xhc3M9ImxhIGxhLWhpc3RvcnkiIHRpdGxlPSJSZXF1aXNpdGlvbiBIaXN0b3J5Ij48L2k+Jm5ic3A7UmVxdWlzaXRpb24gSGlzdG9yeTwvYT48L2xpPC9hPjwvbGk+JzsKCgogICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnPC91bD48L2Rpdj4nOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGFjdGlvbnM7CgogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5yYXdDb2x1bW5zKFsncmVmZXJlbmNlX25vJywgJ3N0YXR1cycsICdhdHRhY2htZW50JywgJ2FjdGlvbnMnXSkKICAgICAgICAgICAgICAgICAgICAtPm1ha2UodHJ1ZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5yZXF1aXNpdGlvbnMucmVxdWlzaXRpb24tbGlzdC1pbmRleCcsICRkYXRhKTsKICAgICAgICB9IGNhdGNoIChUaHJvd2FibGUgJHRoKSB7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUmZwIGxpc3QgdmlldyBzZWFyY2guCiAgICAgKiBTZWFyY2ggYmV0d2VlbiBmcm9tIGFuZCB0byBkYXRlIGFuZCBhbHNvIHVzZXIgY2FuIHNlYXJjaCBieSBlbXBsb3llZQogICAgICogQHBhcmFtIFxJbGx1bWluYXRlXEh0dHBcUmVxdWVzdCAkcmVxdWVzdAogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KCiAgICBmdW5jdGlvbiBuZWVkdG9rZWVwKCkKICAgIHsKICAgICAgICAkcmVxdWlzdGlvbnMgPSBSZXF1aXNpdGlvbjo6d2hlbihpc3NldChBdXRoOjp1c2VyKCktPmVtcGxveWVlLT5hc19kZXBhcnRtZW50X2lkKSwgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsVXNlcnNMaXN0LmVtcGxveWVlJywgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2FzX2RlcGFydG1lbnRfaWQnLCBBdXRoOjp1c2VyKCktPmVtcGxveWVlLT5hc19kZXBhcnRtZW50X2lkKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSkKICAgICAgICAgICAgLT53aGVyZSgnc3RhdHVzJywgMCkKICAgICAgICAgICAgLT5nZXQoKTsKCiAgICAgICAgJHJlcXVpc3Rpb25fZGF0YSA9IFtdOwogICAgICAgIGZvcmVhY2ggKCRyZXF1aXN0aW9ucyBhcyAkcmVxdWlzdGlvbikgewogICAgICAgICAgICAkdHAgPSAwOwogICAgICAgICAgICBmb3JlYWNoICgkcmVxdWlzdGlvbi0+aXRlbXMgYXMgJGl0ZW0pIHsKICAgICAgICAgICAgICAgICR0cCArPSAoJGl0ZW0tPnByb2R1Y3QtPnVuaXRfcHJpY2UgKiAkaXRlbS0+cXR5KTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgJHJlcXVpc3Rpb24tPnRvdGFsX3ByaWNlID0gJHRwOwogICAgICAgICAgICBmb3JlYWNoIChBdXRoOjp1c2VyKCktPnJlbEFwcHJvdmFsUmFuZ2UgYXMgJHJhbmdlKSB7CiAgICAgICAgICAgICAgICBpZiAoJHJhbmdlLT5taW5fYW1vdW50IDw9ICRyZXF1aXN0aW9uLT50b3RhbF9wcmljZSAmJiAkcmFuZ2UtPm1heF9hbW91bnQgPj0gJHJlcXVpc3Rpb24tPnRvdGFsX3ByaWNlKSB7CiAgICAgICAgICAgICAgICAgICAgJHJlcXVpc3Rpb25fZGF0YVtdID0gJHJlcXVpc3Rpb247CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuICR0aGlzLT5wYWdpbmF0ZSgkcmVxdWlzdGlvbl9kYXRhLCAzMCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZnAgbGlzdCB2aWV3LgogICAgICogQ2hhbmdlIHJlcXVpc2l0aW9uIHN0YXR1cyAoQXBwcm92ZSBhbmQgcmVqZWN0ZWQpCiAgICAgKiBAcGFyYW0gXElsbHVtaW5hdGVcSHR0cFxSZXF1ZXN0ICRyZXF1ZXN0CiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcSnNvblJlc3BvbnNlCiAgICAgKi8KCiAgICBwdWJsaWMgZnVuY3Rpb24gdG9nZ2xlUmVxdWlzaXRpb25TdGF0dXMoUmVxdWVzdCAkcmVxdWVzdCkKICAgIHsKICAgICAgICAkcmVxdWlzaXRpb24gPSBSZXF1aXNpdGlvbjo6d2hlcmUoJ2lkJywgJHJlcXVlc3QtPmlkKS0+Zmlyc3QoKTsKICAgICAgICBpZiAoaXNzZXQoJHJlcXVpc2l0aW9uLT5pZCkpIHsKICAgICAgICAgICAgJG5ld1N0YXR1cyA9ICRyZXF1ZXN0LT5zdGF0dXM7CiAgICAgICAgICAgICRuZXdUZXh0ID0gJG5ld1N0YXR1cyA9PSAxID8gJ0Fja25vd2xlZGdlJyA6ICgoJG5ld1N0YXR1cyA9PSAyKSA/ICdIYWx0JyA6ICdQZW5kaW5nJyk7CiAgICAgICAgICAgICRuZXdBcHByb3ZlZCA9ICRuZXdTdGF0dXMgPT0gMSA/IDEgOiAoKCRuZXdTdGF0dXMgPT0gMikgPyAxIDogTnVsbCk7CiAgICAgICAgICAgICRuZXdNZXNzYWdlID0gJG5ld1N0YXR1cyA9PSAxID8gJ1N1Y2Nlc3NmdWxseSBVcGRhdGVkIFRvIEFja25vd2xlZGdlbWVudCcgOiAoKCRuZXdTdGF0dXMgPT0gMikgPyAnU3VjY2Vzc2Z1bGx5IFVwZGF0ZWQgVG8gSGFsdCcgOiAoKCRuZXdTdGF0dXMgPT0gMCkgPyAnU3VjY2Vzc2Z1bGx5IFNlbmQgdG8gJyAuIChhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnRGVwYXJ0bWVudC1IZWFkJykgPyAnU0JVIGhlYWQnIDogKGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdTQlUgSGVhZCcpID8gJ01hbmFnZW1lbnQnIDogJ0RlcGFydG1lbnQgaGVhZCcpKSA6ICdTdWNjZXNzZnVsbHkgVXBkYXRlZCBUbyBQZW5kaW5nJykpOwoKICAgICAgICAgICAgLy9XaGVuIHJlc2VuZCByZXF1aXNpdGlvbgogICAgICAgICAgICBpZiAoJHJlcXVpc2l0aW9uLT5zdGF0dXMgPT0gMikgewogICAgICAgICAgICAgICAgLy9jb3VudCBjaGVjawogICAgICAgICAgICAgICAgaWYgKHNlc3Npb24oKS0+Z2V0KCdzeXN0ZW0taW5mb3JtYXRpb24nKVsncmVzZW5kX2xpbWl0J10gPiAkcmVxdWlzaXRpb24tPnJlc2VuZF9jb3VudCkgewogICAgICAgICAgICAgICAgICAgIC8vdXBkYXRlIHJlc2VuZCBjb3VudAogICAgICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbi0+cmVzZW5kX2NvdW50ID0gJHJlcXVpc2l0aW9uLT5yZXNlbmRfY291bnQgKyAxOwogICAgICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbi0+c2F2ZSgpOwogICAgICAgICAgICAgICAgICAgIC8vc3RvcmUgdGhlIGV4aXN0aW5nIGRhdGEgdG8gbG9nCiAgICAgICAgICAgICAgICAgICAgJHRoaXMtPnJlc2VuZFJlcXVpc2l0aW9uTG9nU3RvcmUoJHJlcXVpc2l0aW9uKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAnU29ycnkhLllvdXIgcmVzZW5kIGxpbWl0IGlzIG92ZXIuIFBsZWFzZSBnZW5lcmF0ZSBhIG5ldyByZXF1aXNpdGlvbicKICAgICAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgJHVwZGF0ZSA9ICRyZXF1aXNpdGlvbi0+dXBkYXRlKFsKICAgICAgICAgICAgICAgICdzdGF0dXMnID0+ICRuZXdTdGF0dXMsCiAgICAgICAgICAgICAgICAnaXNfcGFzc2VkJyA9PiAnbm8nLAogICAgICAgICAgICAgICAgJ2FwcHJvdmVkX2lkJyA9PiAkbmV3QXBwcm92ZWQsCiAgICAgICAgICAgICAgICAnYWRtaW5fcmVtYXJrJyA9PiAkcmVxdWVzdC0+YWRtaW5fcmVtYXJrLAogICAgICAgICAgICAgICAgJ3VwZGF0ZWRfYXQnID0+IGRhdGUoJ1ktbS1kIEg6aTpzJyksCiAgICAgICAgICAgICAgICAndXBkYXRlZF9ieScgPT4gYXV0aCgpLT51c2VyKCktPmlkLAogICAgICAgICAgICAgICAgJ2FwcHJvdmVkX2J5JyA9PiBhdXRoKCktPnVzZXIoKS0+aWQKICAgICAgICAgICAgXSk7CiAgICAgICAgICAgIGlmICgkbmV3U3RhdHVzID09IDEpIHsKCiAgICAgICAgICAgICAgICAvL0lmIGFwcHJvdmVkIHRoZW4gc2VuZCB0byBmaW5hbmNlIGZvciBhcHByb3ZhbC4KCiAgICAgICAgICAgICAgICBSZXF1aXNpdGlvblRyYWNraW5nOjpzdG9yZVJlcXVpc2l0aW9uVHJhY2tpbmcoJHJlcXVpc2l0aW9uLT5pZCwgJ2FwcHJvdmVkJyk7CgogICAgICAgICAgICAgICAgJG1lc3NhZ2UgPSAnPHNwYW4gY2xhc3M9Im5vdGlmaWNhdGlvbi1saW5rcyIgZGF0YS1zcmM9IicgLiBnZXRNb2R1bGVzKClbJ2ZpbmFuY2UnXS0+dXJsIC4gJy9wbXMvc3RvcmUtbWFuYWdlL3N0b3JlLWludmVudG9yeS1jb21wYXJlLycgLiAkcmVxdWlzaXRpb24tPmlkIC4gJyIgZGF0YS10aXRsZT0iUmVxdWlzaXRpb24gRGV0YWlscyI+UmVmZXJlbmNlIE5vOicgLiAkcmVxdWlzaXRpb24tPnJlZmVyZW5jZV9ubyAuICcuV2F0dGluZyBmb3IgRmluYW5hY2UgQXBwcm92YWwuPC9zcGFuPic7CgogICAgICAgICAgICAgICAgJG1hbmFnZXJJbmZvcyA9IGdldEJ1bGtNYW5hZ2VySW5mbygnQWNjb3VudHMnLCAkcmVxdWlzaXRpb24tPmhyX3VuaXRfaWQpOwoKICAgICAgICAgICAgICAgIGlmIChpc3NldCgkbWFuYWdlckluZm9zWzBdKSkgewogICAgICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRtYW5hZ2VySW5mb3MgYXMgJG1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgQ3JlYXRlT3JVcGRhdGVOb3RpZmljYXRpb24oJG1lc3NhZ2UsICd1bnJlYWQnLCAnJywgJG1hbmFnZXItPmlkLCAnc2VuZC10by1hY2NvdW50cycsICcnKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gJG1lc3NhZ2UgPSAnPHNwYW4gY2xhc3M9Im5vdGlmaWNhdGlvbi1saW5rcyIgZGF0YS1zcmM9IicgLiByb3V0ZSgncG1zCiAgICAgICAgICAgICAgICAvLy5zdG9yZS1tYW5hZ2Uuc3RvcmUuaW52ZW50b3J5LmNvbXBhcmUnLCAkcmVxdWlzaXRpb24tPmlkKSAuICciIGRhdGEtdGl0bGU9IlJlcXVpc2l0aW9uIERldGFpbHMiPlJlZmVyZW5jZSBObzonIC4gJHJlcXVpc2l0aW9uLT5yZWZlcmVuY2Vfbm8gLiAnLldhaXRpbmcgZm9yIFByb2N1cmVtZW50L0RlbGl2ZXJ5Ljwvc3Bhbj4nOwogICAgICAgICAgICAgICAgLy8KICAgICAgICAgICAgICAgIC8vQ3JlYXRlT3JVcGRhdGVOb3RpZmljYXRpb24oJG1lc3NhZ2UsICd1bnJlYWQnLCAnJywgZ2V0TWFuYWdlckluZm8oJ1N0b3JlLU1hbmFnZXInLCAkcmVxdWlzaXRpb24tPmhyX3VuaXRfaWQpLCAnc2VuZC10by1zdG9yZScsICcnKTsKCgogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiB0cnVlLAogICAgICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAnU3VjY2Vzc2Z1bGx5IFVwZGF0ZWQgVG8gQWNrbm93bGVkZ2VtZW50JywKICAgICAgICAgICAgICAgICAgICAnbmV3X3RleHQnID0+ICRuZXdUZXh0CiAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCRuZXdTdGF0dXMgPT0gMCkgewogICAgICAgICAgICAgICAgUmVxdWlzaXRpb25UcmFja2luZzo6c3RvcmVSZXF1aXNpdGlvblRyYWNraW5nKCRyZXF1aXNpdGlvbi0+aWQsICdwZW5kaW5nJyk7CiAgICAgICAgICAgICAgICAkbWVzc2FnZSA9ICc8c3BhbiBjbGFzcz0ibm90aWZpY2F0aW9uLWxpbmtzIiBkYXRhLXNyYz0iJyAuIHJvdXRlKCdwbXMucmVxdWlzaXRpb24ubGlzdC52aWV3LnNob3cnLCAkcmVxdWlzaXRpb24tPmlkKSAuICciIGRhdGEtdGl0bGU9IlJlcXVpc2l0aW9uIERldGFpbHMiPlJlZmVyZW5jZSBObzonIC4gJHJlcXVpc2l0aW9uLT5yZWZlcmVuY2Vfbm8gLiAnLiBXYXR0aW5nIGZvciBhcHByb3ZhbC48L3NwYW4+JzsKCiAgICAgICAgICAgICAgICAkcmVjZWl2ZXIgPSBnZXREZXBhcnRtZW50SGVhZCgkcmVxdWlzaXRpb24tPmF1dGhvcl9pZCk7CiAgICAgICAgICAgICAgICAkcmVjZWl2ZXJfc2x1ZyA9ICdzZW5kLXRvLWRlcGFydG1lbnQtaGVhZCc7CgogICAgICAgICAgICAgICAgaWYgKGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdEZXBhcnRtZW50LUhlYWQnKSkgewogICAgICAgICAgICAgICAgICAgICRyZWNlaXZlciA9IGdldE1hbmFnZXJJbmZvKCdTQlUgSGVhZCcsIGF1dGgoKS0+dXNlcigpLT5lbXBsb3llZS0+YXNfdW5pdF9pZCk7CiAgICAgICAgICAgICAgICAgICAgJHJlY2VpdmVyX3NsdWcgPSAnc2VuZC10by1zYnUtaGVhZCc7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdTQlUgSGVhZCcpKSB7CiAgICAgICAgICAgICAgICAgICAgJHJlY2VpdmVyID0gZ2V0TWFuYWdlckluZm8oJ01hbmFnZW1lbnQnKTsKICAgICAgICAgICAgICAgICAgICAkcmVjZWl2ZXJfc2x1ZyA9ICdzZW5kLXRvLW1hbmFnbWVudCc7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgQ3JlYXRlT3JVcGRhdGVOb3RpZmljYXRpb24oJG1lc3NhZ2UsICd1bnJlYWQnLCAnJywgJHJlY2VpdmVyLCAkcmVjZWl2ZXJfc2x1ZywgJycpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoJHVwZGF0ZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiB0cnVlLAogICAgICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAkbmV3TWVzc2FnZSwKICAgICAgICAgICAgICAgICAgICAnbmV3X3RleHQnID0+ICRuZXdUZXh0CiAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnID0+IGZhbHNlLAogICAgICAgICAgICAgICAgJ21lc3NhZ2UnID0+ICdTb21ldGhpbmcgV2VudCBXcm9uZyEnCiAgICAgICAgICAgIF0pOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAnc3VjY2VzcycgPT4gZmFsc2UsCiAgICAgICAgICAgICdtZXNzYWdlJyA9PiAnRGF0YSBub3QgZm91bmQhJwogICAgICAgIF0pOwogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBoYWx0UmVxdWlzaXRpb25TdGF0dXMoUmVxdWVzdHNcUG1zXFJlcXVpc2l0aW9uUmVxdWVzdCAkcmVxdWVzdCkKICAgIHsKCiAgICAgICAgLy9GaW5kIHJlcXVpc2l0aW9uCiAgICAgICAgJHJlcXVpc2l0aW9uID0gUmVxdWlzaXRpb246OmZpbmRPckZhaWwoJHJlcXVlc3QtPmlkKTsKICAgICAgICB0cnkgewogICAgICAgICAgICAvL0lmIHlvdSBmaW5kLCB0aGVuIHVwZGF0ZQogICAgICAgICAgICAkcmVxdWlzaXRpb24tPnVwZGF0ZShbCiAgICAgICAgICAgICAgICAnYWRtaW5fcmVtYXJrJyA9PiAkcmVxdWVzdC0+YWRtaW5fcmVtYXJrLAogICAgICAgICAgICAgICAgJ3N0YXR1cycgPT4gMiwKICAgICAgICAgICAgICAgICdpc19wYXNzZWQnID0+ICdubycsCiAgICAgICAgICAgICAgICAndXBkYXRlZF9hdCcgPT4gZGF0ZSgnWS1tLWQgSDppOnMnKSwKICAgICAgICAgICAgICAgICd1cGRhdGVkX2J5JyA9PiBhdXRoKCktPnVzZXIoKS0+aWQKICAgICAgICAgICAgXSk7CgogICAgICAgICAgICAkbWVzc2FnZSA9ICc8c3BhbiBjbGFzcz0ibm90aWZpY2F0aW9uLWxpbmtzIiBkYXRhLXNyYz0iJyAuIHJvdXRlKCdwbXMucmVxdWlzaXRpb24ubGlzdC52aWV3LnNob3cnLCAkcmVxdWlzaXRpb24tPmlkKSAuICciIGRhdGEtdGl0bGU9IlJlcXVpc2l0aW9uIERldGFpbHMiPlJlZmVyZW5jZSBObzonIC4gJHJlcXVpc2l0aW9uLT5yZWZlcmVuY2Vfbm8gLiAnLiBEZXBhcnRtZW50IEhlYWQgSGFsdCBUaGlzIFJlcXVpc2l0aW9uLi48L3NwYW4+JzsKICAgICAgICAgICAgQ3JlYXRlT3JVcGRhdGVOb3RpZmljYXRpb24oJG1lc3NhZ2UsICd1bnJlYWQnLCAnJywgJHJlcXVpc2l0aW9uLT5hdXRob3JfaWQsICdyZXF1aXNpdGlvbicsICcnKTsKCiAgICAgICAgICAgIC8vUmVxdWlzaXRpb24gdHJhY2tpbmcgZnVuY3Rpb24gY2FsbAogICAgICAgICAgICBSZXF1aXNpdGlvblRyYWNraW5nOjpzdG9yZVJlcXVpc2l0aW9uVHJhY2tpbmcoJHJlcXVpc2l0aW9uLT5pZCwgJ2hhbHQnLCAkcmVxdWVzdC0+YWRtaW5fcmVtYXJrKTsKICAgICAgICAgICAgLy9Ob3RpZmljYXRpb24KICAgICAgICAgICAgLy9JZiBzdWNjZXNzIHRoZW4gcmV0dXJuIHdpdGggc3VjY2VzcyBtZXNzYWdlCiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhTdWNjZXNzKCdSZXF1aXNpdGlvbiBTdWNjZXNzZnVsbHkgSGFsdCcpOwoKICAgICAgICB9IGNhdGNoIChcVGhyb3dhYmxlICR0aCkgewogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCiAgICBwdWJsaWMgZnVuY3Rpb24gc2hvd1RyYWNraW5nKFJlcXVlc3QgJHJlcXVlc3QpCiAgICB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgJHJlc3BvbnNlID0gW107CiAgICAgICAgICAgICRyZXF1aXNpdGlvbiA9IFJlcXVpc2l0aW9uOjp3aXRoKFsKICAgICAgICAgICAgICAgICdyZXF1aXNpdGlvblRyYWNraW5nJwogICAgICAgICAgICBdKQogICAgICAgICAgICAgICAgLT5maW5kT3JGYWlsKCRyZXF1ZXN0LT5pZCk7CiAgICAgICAgICAgICRyZXNwb25zZSA9IFsKICAgICAgICAgICAgICAgICdyZXN1bHQnID0+ICdzdWNjZXNzJywKICAgICAgICAgICAgICAgICdib2R5JyA9PiBWaWV3OjptYWtlKCdwbXMuYmFja2VuZC5wYWdlcy5yZXF1aXNpdGlvbnMudHJhY2tpbmcnLCBbCiAgICAgICAgICAgICAgICAgICAgJ3JlcXVpc2l0aW9uJyA9PiAkcmVxdWlzaXRpb24KICAgICAgICAgICAgICAgIF0pLT5yZW5kZXIoKQogICAgICAgICAgICBdOwogICAgICAgIH0gY2F0Y2ggKFxUaHJvd2FibGUgJHRoKSB7CiAgICAgICAgICAgICRyZXNwb25zZSA9IFsKICAgICAgICAgICAgICAgICdyZXN1bHQnID0+ICdlcnJvcicsCiAgICAgICAgICAgICAgICAnbWVzc2FnZScgPT4gJHRoLT5nZXRNZXNzYWdlKCkKICAgICAgICAgICAgXTsKICAgICAgICB9CgogICAgICAgIHJldHVybiAkcmVzcG9uc2U7CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIG5vdGlmaWNhdGlvbkhlYWRlckNvbHVtbnMoJHZhbHVlID0gJycpCiAgICB7CiAgICAgICAgJHJvdyA9IGFycmF5KAogICAgICAgICAgICBbJ1NMJywgJ1NMJ10sCiAgICAgICAgICAgIFsnZGF0ZScsICdjcmVhdGVkX2F0JywgJ3RleHQtY2VudGVyJywgJ3dpZHRoOjE1JSddLAogICAgICAgICAgICBbJ21lc3NhZ2VzJywgJ21lc3NhZ2VzJywgJ3RleHQtbGVmdCddLAogICAgICAgICAgICBbJ3N0YXR1cycsICd0eXBlJywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsnYWN0aW9ucycsICdhY3Rpb25zJywgJ3RleHQtY2VudGVyIGFjdGlvbicsICd3aWR0aDoxNSUnXQogICAgICAgICk7CiAgICAgICAgcmV0dXJuICRyb3c7CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIG5vdGlmaWNhdGlvbkFsbCgpCiAgICB7CiAgICAgICAgdHJ5IHsKCiAgICAgICAgICAgICR0aXRsZSA9ICJOb3RpZmljYXRpb24iOwogICAgICAgICAgICAkbm90aWZpY2F0aW9uID0gTm90aWZpY2F0aW9uOjp3aGVyZSgndXNlcl9pZCcsIFxhdXRoKCktPnVzZXIoKS0+aWQpCiAgICAgICAgICAgICAgICAtPndoZW4oIWRhdGF0YWJsZU9yZGVyaW5nKCksIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT5vcmRlcmJ5KCdpZCcsICdkZXNjJyk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICR1bnJlYWROb3RpZmljYXRpb24gPSBOb3RpZmljYXRpb246OndoZXJlKCd1c2VyX2lkJywgYXV0aCgpLT51c2VyKCktPmlkKS0+d2hlcmUoJ3R5cGUnLCAndW5yZWFkJyktPmNvdW50KCk7CgogICAgICAgICAgICBpZiAocmVxdWVzdCgpLT5hamF4KCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBEYXRhdGFibGVzOjpvZigkbm90aWZpY2F0aW9uKQogICAgICAgICAgICAgICAgICAgIC0+YWRkSW5kZXhDb2x1bW4oKQogICAgICAgICAgICAgICAgICAgIC0+ZWRpdENvbHVtbignZGF0ZScsIGZ1bmN0aW9uICgkdmFsdWVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkYXRlKCdZLW0tZCcsIHN0cnRvdGltZSgkdmFsdWVzLT5jcmVhdGVkX2F0KSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdkYXRlJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyQnkoJ2NyZWF0ZWRfYXQnLCAkb3JkZXIpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5lZGl0Q29sdW1uKCdzdGF0dXMnLCBmdW5jdGlvbiAoJHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICAkc3RhdHVzID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgICRzdGF0dXMgLj0gJzxwIGlkPSJ0eXBlJyAuICR2YWx1ZXMtPmlkIC4gJyIgY2xhc3M9InR5cGUiPic7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHZhbHVlcy0+dHlwZSA9PSAncmVhZCcpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc3RhdHVzIC49ICc8c3BhbiBjbGFzcz0iYnRuIGJ0bi1zbSBidG4tc3VjY2VzcyI+PGkgY2xhc3M9ImxhcyBsYS1jaGVjay1jaXJjbGUiPjwvaT48L3NwYW4+JzsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzdGF0dXMgLj0gJzxzcGFuIGNsYXNzPSJidG4gYnRuLXNtIGJ0bi13YXJuaW5nIj48aSBjbGFzcz0ibGFzIGxhLWluYm94Ij48L2k+PC9zcGFuPic7CgogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAkc3RhdHVzIC49ICc8L3A+JzsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRzdGF0dXM7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignYWN0aW9ucycsIGZ1bmN0aW9uICgkdmFsdWVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zID0gJzxwIGlkPSJhY3Rpb24nIC4gJHZhbHVlcy0+aWQgLiAnIiBjbGFzcz0iYWN0aW9uIj4nOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHZhbHVlcy0+dHlwZSA9PSAndW5yZWFkJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxkaXYgY2xhc3M9ImJ0bi1ncm91cCI+CiAgICAgICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGRyb3Bkb3duLXRvZ2dsZSIgZGF0YS10b2dnbGU9ImRyb3Bkb3duIj4KICAgICAgICAgICAgICAgICAgICA8c3BhbiBpZD0ic3RhdHVzTmFtZScgLiAkdmFsdWVzLT5pZCAuICciPgogICAgICAgICAgICAgICAgICAgIDxpIGNsYXNzPSJsYSBsYS1lbGxpcHNpcy12Ij48L2k+PC9zcGFuPjwvYnV0dG9uPjx1bCBjbGFzcz0iZHJvcGRvd24tbWVudSI+JzsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnPGxpPjxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgY2xhc3M9Im1hcmtBc1JlYWQiIGRhdGEtaWQ9IicgLiAkdmFsdWVzLT5pZCAuICciIG9uY2xpY2s9Im1hcmtBc1JlYWQoJCh0aGlzKSkiIHRpdGxlPSJNYXJrIEFzIFJlYWQiPjxpIGNsYXNzPSJsYSBsYS1jaGVjayI+PC9pPiBNYXJrIEFzIFJlYWQ8L2E+PC9saT48L3VsPjwvZGl2Pic7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnQWxyZWFkeSBSZWFkJzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnPC9wPic7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkYWN0aW9uczsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZXNjYXBlQ29sdW1ucyhbXSkKICAgICAgICAgICAgICAgICAgICAtPnJhd0NvbHVtbnMoWydtZXNzYWdlcycsICdzdGF0dXMnLCAnYWN0aW9ucyddKQogICAgICAgICAgICAgICAgICAgIC0+bWFrZSh0cnVlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnJlcXVpc2l0aW9ucy5ub3RpZmljYXRpb24tbGlzdCcsIFsndGl0bGUnID0+ICR0aXRsZSwKICAgICAgICAgICAgICAgICd1bnJlYWROb3RpZmljYXRpb24nID0+ICR1bnJlYWROb3RpZmljYXRpb24sICdoZWFkZXJDb2x1bW5zJyA9PiAkdGhpcy0+bm90aWZpY2F0aW9uSGVhZGVyQ29sdW1ucygpXSk7CiAgICAgICAgfSBjYXRjaCAoXFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIG1hcmtBc1JlYWQoUmVxdWVzdCAkcmVxdWVzdCkKICAgIHsKICAgICAgICAkcmVzcG9uc2UgPSBbXTsKICAgICAgICAvL0ZpbmQgbm90aWZpY2F0aW9uCiAgICAgICAgJG5vdGlmaWNhdGlvbiA9IE5vdGlmaWNhdGlvbjo6d2hlcmUoJ2lkJywgJHJlcXVlc3QtPmlkKS0+Zmlyc3QoKTsKCiAgICAgICAgREI6OmJlZ2luVHJhbnNhY3Rpb24oKTsKICAgICAgICB0cnkgewoKICAgICAgICAgICAgaWYgKGlzc2V0KCRub3RpZmljYXRpb24pKSB7CiAgICAgICAgICAgICAgICAkbm90aWZpY2F0aW9uLT50eXBlID0gJ3JlYWQnOwogICAgICAgICAgICAgICAgJG5vdGlmaWNhdGlvbi0+cmVhZF9hdCA9IGRhdGUoJ1ktbS1kIGg6aTpzJyk7CiAgICAgICAgICAgICAgICAkbm90aWZpY2F0aW9uLT5zYXZlKCk7CgogICAgICAgICAgICAgICAgREI6OmNvbW1pdCgpOwogICAgICAgICAgICAgICAgJHJlc3BvbnNlWydyZXN1bHQnXSA9ICdzdWNjZXNzJzsKICAgICAgICAgICAgICAgICRyZXNwb25zZVsnbWVzc2FnZSddID0gJ1N1Y2Nlc3NmdWxseSBSZWFkIE5vdGlmaWNhdGlvbic7CiAgICAgICAgICAgICAgICAkcmVzcG9uc2VbJ3RvdGFsX25vdGlmaWNhdGlvbiddID0gTm90aWZpY2F0aW9uOjp3aGVyZSgndHlwZScsICd1bnJlYWQnKS0+d2hlcmUoJ3VzZXJfaWQnLCBhdXRoKCktPnVzZXIoKS0+aWQpLT53aGVuKGlzc2V0KEF1dGg6OnVzZXIoKS0+ZW1wbG95ZWUtPmFzX2RlcGFydG1lbnRfaWQpLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFVzZXIuZW1wbG95ZWUnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdhc19kZXBhcnRtZW50X2lkJywgQXV0aDo6dXNlcigpLT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KS0+Y291bnQoKTsKCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAkcmVzcG9uc2VbJ3Jlc3VsdCddID0gJ2Vycm9yJzsKICAgICAgICAgICAgICAgICRyZXNwb25zZVsnbWVzc2FnZSddID0gJ05vIE5vdGlmaWNhdGlvbiBGb3VuZCc7CiAgICAgICAgICAgICAgICAkcmVzcG9uc2VbJ3RvdGFsX25vdGlmaWNhdGlvbiddID0gTm90aWZpY2F0aW9uOjp3aGVyZSgndHlwZScsICd1bnJlYWQnKS0+d2hlcmUoJ3VzZXJfaWQnLCBhdXRoKCktPnVzZXIoKS0+aWQpLT53aGVuKGlzc2V0KEF1dGg6OnVzZXIoKS0+ZW1wbG95ZWUtPmFzX2RlcGFydG1lbnRfaWQpLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFVzZXIuZW1wbG95ZWUnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdhc19kZXBhcnRtZW50X2lkJywgQXV0aDo6dXNlcigpLT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KS0+Y291bnQoKTsKICAgICAgICAgICAgfQoKICAgICAgICB9IGNhdGNoIChcVGhyb3dhYmxlICR0aCkgewogICAgICAgICAgICBEQjo6cm9sbGJhY2soKTsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiAkcmVzcG9uc2U7CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIG1hcmtBc1JlYWRBbGwoUmVxdWVzdCAkcmVxdWVzdCkKICAgIHsKICAgICAgICAkcmVzcG9uc2UgPSBbXTsKCiAgICAgICAgJG5vdGlmaWNhdGlvbnMgPSBOb3RpZmljYXRpb246OndoZXJlKCd1c2VyX2lkJywgYXV0aCgpLT51c2VyKCktPmlkKS0+d2hlcmUoJ3R5cGUnLCAndW5yZWFkJyktPmdldCgpOwoKICAgICAgICBEQjo6YmVnaW5UcmFuc2FjdGlvbigpOwogICAgICAgIHRyeSB7CgogICAgICAgICAgICBpZiAoY291bnQoJG5vdGlmaWNhdGlvbnMpID4gMCkgewoKICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRub3RpZmljYXRpb25zIGFzICRub3RpZmljYXRpb24pIHsKICAgICAgICAgICAgICAgICAgICBOb3RpZmljYXRpb246OndoZXJlKCdpZCcsICRub3RpZmljYXRpb24tPmlkKS0+dXBkYXRlKAogICAgICAgICAgICAgICAgICAgICAgICBbJ3R5cGUnID0+ICdyZWFkJywgJ3JlYWRfYXQnID0+IGRhdGUoJ1ktbS1kIGg6aTpzJyldCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICRyZXNwb25zZVsncmVzdWx0J10gPSAnc3VjY2Vzcyc7CiAgICAgICAgICAgICAgICAkcmVzcG9uc2VbJ21lc3NhZ2UnXSA9ICdTdWNjZXNzZnVsbHkgUmVhZCBOb3RpZmljYXRpb24nOwogICAgICAgICAgICAgICAgJHJlc3BvbnNlWyd0b3RhbF9ub3RpZmljYXRpb24nXSA9IE5vdGlmaWNhdGlvbjo6d2hlcmUoJ3R5cGUnLCAndW5yZWFkJyktPndoZXJlKCd1c2VyX2lkJywgYXV0aCgpLT51c2VyKCktPmlkKS0+d2hlbihpc3NldChBdXRoOjp1c2VyKCktPmVtcGxveWVlLT5hc19kZXBhcnRtZW50X2lkKSwgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxVc2VyLmVtcGxveWVlJywgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnYXNfZGVwYXJ0bWVudF9pZCcsIEF1dGg6OnVzZXIoKS0+ZW1wbG95ZWUtPmFzX2RlcGFydG1lbnRfaWQpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSktPmNvdW50KCk7CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgJHJlc3BvbnNlWydyZXN1bHQnXSA9ICdlcnJvcic7CiAgICAgICAgICAgICAgICAkcmVzcG9uc2VbJ21lc3NhZ2UnXSA9ICdObyBOb3RpZmljYXRpb24gRm91bmQnOwogICAgICAgICAgICAgICAgJHJlc3BvbnNlWyd0b3RhbF9ub3RpZmljYXRpb24nXSA9IE5vdGlmaWNhdGlvbjo6d2hlcmUoJ3R5cGUnLCAndW5yZWFkJyktPndoZXJlKCd1c2VyX2lkJywgYXV0aCgpLT51c2VyKCktPmlkKS0+d2hlbihpc3NldChBdXRoOjp1c2VyKCktPmVtcGxveWVlLT5hc19kZXBhcnRtZW50X2lkKSwgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxVc2VyLmVtcGxveWVlJywgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnYXNfZGVwYXJ0bWVudF9pZCcsIEF1dGg6OnVzZXIoKS0+ZW1wbG95ZWUtPmFzX2RlcGFydG1lbnRfaWQpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSktPmNvdW50KCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIERCOjpjb21taXQoKTsKCiAgICAgICAgfSBjYXRjaCAoXFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgREI6OnJvbGxiYWNrKCk7CgogICAgICAgICAgICAkcmVzcG9uc2VbJ3Jlc3VsdCddID0gJ2Vycm9yJzsKICAgICAgICAgICAgJHJlc3BvbnNlWydtZXNzYWdlJ10gPSAkdGgtPmdldE1lc3NhZ2UoKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiAkcmVzcG9uc2U7CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIGRIZWFkZXJDb2x1bW5zKCR2YWx1ZSA9ICcnKQogICAgewogICAgICAgICRyb3cgPSBhcnJheSgKICAgICAgICAgICAgWydTTCcsICdTTCddLAogICAgICAgICAgICBbJ3JlZmVyZW5jZV9ubycsICdyZWZlcmVuY2Vfbm8nLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydyZXF1aXNpdGlvbl9kYXRlJywgJ3JlcXVpc2l0aW9uX2RhdGUnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydkZWxpdmVyZWRfcmVmX25vJywgJ2RlbGl2ZXJlZF9yZWZfbm8nLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydkZWxpdmVyeV9kYXRlJywgJ2RlbGl2ZXJ5X2RhdGUnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydjYXRlZ29yeScsICdjYXRlZ29yeScsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3N1Yl9jYXRlZ29yeScsICdzdWJfY2F0ZWdvcnknLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydwcm9kdWN0JywgJ3Byb2R1Y3QnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydkZWxpdmVyeV9xdHknLCAnZGVsaXZlcnlfcXR5JywgJ3RleHQtbGVmdCddLAogICAgICAgICAgICBbJ2FjdGlvbnMnLCAnYWN0aW9ucycsICd0ZXh0LWNlbnRlcicsICd3aWR0aDoxNSUnXQogICAgICAgICk7CgogICAgICAgIHJldHVybiAkcm93OwogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBkZWxpdmVyZWRSZXF1aXNpdGlvbkxpc3QoKQogICAgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgICRzdGF0dXMgPSByZXF1ZXN0KCktPmhhcygnc3RhdHVzJykgPyByZXF1ZXN0KCktPmdldCgnc3RhdHVzJykgOiAnJzsKCiAgICAgICAgICAgICRmcm9tID0gcmVxdWVzdCgpLT5oYXMoJ2Zyb20nKSA/IHJlcXVlc3QoKS0+Z2V0KCdmcm9tJykgOiBkYXRlKCdZLW0tMDEnKTsKICAgICAgICAgICAgJHRvID0gcmVxdWVzdCgpLT5oYXMoJ3RvJykgPyByZXF1ZXN0KCktPmdldCgndG8nKSA6IGRhdGUoJ1ktbS10Jyk7CiAgICAgICAgICAgICRjYXRlZ29yeV9pZCA9IHJlcXVlc3QoKS0+aGFzKCdjYXRlZ29yeV9pZCcpID8gcmVxdWVzdCgpLT5nZXQoJ2NhdGVnb3J5X2lkJykgOiAwOwoKICAgICAgICAgICAgJGNhdGVnb3J5SWRzID0gQ2F0ZWdvcnlEZXBhcnRtZW50Ojp3aGVuKGlzc2V0KGF1dGgoKS0+dXNlcigpLT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCksIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdocl9kZXBhcnRtZW50X2lkJywgYXV0aCgpLT51c2VyKCktPmVtcGxveWVlLT5hc19kZXBhcnRtZW50X2lkKTsKICAgICAgICAgICAgfSktPnBsdWNrKCdjYXRlZ29yeV9pZCcpLT50b0FycmF5KCk7CgogICAgICAgICAgICAkY2F0ZWdvcmllcyA9IENhdGVnb3J5Ojpkb2VzbnRIYXZlKCdjYXRlZ29yeScpCiAgICAgICAgICAgICAgICAtPndoZXJlSW4oJ2lkJywgJGNhdGVnb3J5SWRzKQogICAgICAgICAgICAgICAgLT5nZXQoWydpZCcsICduYW1lJywgJ2NvZGUnXSk7CgogICAgICAgICAgICAkZGVsaXZlcmVkUmVxdWlzaXRpb24gPSBSZXF1aXNpdGlvbkRlbGl2ZXJ5SXRlbTo6d2l0aChbCiAgICAgICAgICAgICAgICAncmVsUmVxdWlzaXRpb25EZWxpdmVyeS5yZWxSZXF1aXNpdGlvbi5pdGVtcy5hdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGUnLAogICAgICAgICAgICAgICAgJ3Byb2R1Y3QuY2F0ZWdvcnkuY2F0ZWdvcnknLAogICAgICAgICAgICAgICAgJ3Byb2R1Y3QucHJvZHVjdFVuaXQnLAogICAgICAgICAgICAgICAgJ3Byb2R1Y3QuYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24uYXR0cmlidXRlJywKICAgICAgICAgICAgXSkKICAgICAgICAgICAgICAgIC0+d2hlbihpc3NldChBdXRoOjp1c2VyKCktPmVtcGxveWVlLT5hc19kZXBhcnRtZW50X2lkKSwgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxSZXF1aXNpdGlvbkRlbGl2ZXJ5LnJlbFJlcXVpc2l0aW9uLnJlbFVzZXJzTGlzdC5lbXBsb3llZScsIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2FzX2RlcGFydG1lbnRfaWQnLCBBdXRoOjp1c2VyKCktPmVtcGxveWVlLT5hc19kZXBhcnRtZW50X2lkKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPndoZXJlSGFzKCdyZWxSZXF1aXNpdGlvbkRlbGl2ZXJ5LnJlbFJlcXVpc2l0aW9uJywgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdhdXRob3JfaWQnLCBhdXRoKCktPnVzZXIoKS0+aWQpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+d2hlbihzdHJ0b3RpbWUoJGZyb20pID4gMCwgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgkZnJvbSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxSZXF1aXNpdGlvbkRlbGl2ZXJ5JywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgkZnJvbSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZURhdGUoJ2RlbGl2ZXJ5X2RhdGUnLCAnPj0nLCAkZnJvbSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT53aGVuKHN0cnRvdGltZSgkdG8pID4gMCwgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgkdG8pIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUmVxdWlzaXRpb25EZWxpdmVyeScsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJHRvKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlRGF0ZSgnZGVsaXZlcnlfZGF0ZScsICc8PScsICR0byk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT53aGVuKCFlbXB0eSgkc3RhdHVzKSwgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgkc3RhdHVzKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ3N0YXR1cycsICRzdGF0dXMpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+d2hlbigkY2F0ZWdvcnlfaWQgPiAwLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRjYXRlZ29yeV9pZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxSZXF1aXNpdGlvbkRlbGl2ZXJ5LnJlbFJlcXVpc2l0aW9uLml0ZW1zLnByb2R1Y3QuY2F0ZWdvcnkuY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRjYXRlZ29yeV9pZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnaWQnLCAkY2F0ZWdvcnlfaWQpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+d2hlbighZW1wdHkocmVxdWVzdCgpLT5nZXQoJ3NlYXJjaF90ZXh0JykpLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVpc2l0aW9uRGVsaXZlcnknLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdyZWZlcmVuY2Vfbm8nLCAnTElLRScsICclJyAuIHJlcXVlc3QoKS0+Z2V0KCdzZWFyY2hfdGV4dCcpIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPndoZW4oIWRhdGF0YWJsZU9yZGVyaW5nKCksIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT5vcmRlcmJ5KCdpZCcsICdkZXNjJyk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGlmIChyZXF1ZXN0KCktPmFqYXgoKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIERhdGF0YWJsZXM6Om9mKCRkZWxpdmVyZWRSZXF1aXNpdGlvbikKICAgICAgICAgICAgICAgICAgICAtPmFkZEluZGV4Q29sdW1uKCkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbigncmVmZXJlbmNlX25vJywgZnVuY3Rpb24gKCR2YWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIGRhdGEtc3JjPSInIC4gcm91dGUoJ3Btcy5yZXF1aXNpdGlvbi5saXN0LnZpZXcuc2hvdycsICR2YWx1ZXMtPnJlbFJlcXVpc2l0aW9uRGVsaXZlcnktPnJlbFJlcXVpc2l0aW9uLT5pZCkgLiAnIiAgY2xhc3M9ImJ0biBidG4tbGluayByZXF1aXNpdGlvbiBtLTEgcm91bmRlZCBzaG93UmVxdWlzdGlvbkRldGFpbHMiIG9uY2xpY2s9InNob3dSZXF1aXN0aW9uRGV0YWlscygkKHRoaXMpKSI+JyAuIChpc3NldCgkdmFsdWVzLT5yZWxSZXF1aXNpdGlvbkRlbGl2ZXJ5LT5yZWxSZXF1aXNpdGlvbi0+cmVmZXJlbmNlX25vKSA/ICR2YWx1ZXMtPnJlbFJlcXVpc2l0aW9uRGVsaXZlcnktPnJlbFJlcXVpc2l0aW9uLT5yZWZlcmVuY2Vfbm8gOiAnJykgLiAnPC9hPjwvdGQ+JzsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdyZWZlcmVuY2Vfbm8nLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUmVxdWlzaXRpb25EZWxpdmVyeS5yZWxSZXF1aXNpdGlvbicsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ3JlZmVyZW5jZV9ubycsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdyZXF1aXNpdGlvbl9kYXRlJywgZnVuY3Rpb24gKCR2YWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzc2V0KCR2YWx1ZXMtPnJlbFJlcXVpc2l0aW9uRGVsaXZlcnktPnJlbFJlcXVpc2l0aW9uLT5yZXF1aXNpdGlvbl9kYXRlKSA/IGRhdGUoJ1ktbS1kJywgc3RydG90aW1lKCR2YWx1ZXMtPnJlbFJlcXVpc2l0aW9uRGVsaXZlcnktPnJlbFJlcXVpc2l0aW9uLT5yZXF1aXNpdGlvbl9kYXRlKSkgOiAnJzsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdkZWxpdmVyZWRfcmVmX25vJywgZnVuY3Rpb24gKCR2YWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzc2V0KCR2YWx1ZXMtPnJlbFJlcXVpc2l0aW9uRGVsaXZlcnktPnJlZmVyZW5jZV9ubykgPyAkdmFsdWVzLT5yZWxSZXF1aXNpdGlvbkRlbGl2ZXJ5LT5yZWZlcmVuY2Vfbm8gOiAnJzsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdkZWxpdmVyZWRfcmVmX25vJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVpc2l0aW9uRGVsaXZlcnknLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdyZWZlcmVuY2Vfbm8nLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignZGVsaXZlcnlfZGF0ZScsIGZ1bmN0aW9uICgkdmFsdWVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpc3NldCgkdmFsdWVzLT5yZWxSZXF1aXNpdGlvbkRlbGl2ZXJ5LT5kZWxpdmVyeV9kYXRlKSA/IGRhdGUoJ1ktbS1kJywgc3RydG90aW1lKCR2YWx1ZXMtPnJlbFJlcXVpc2l0aW9uRGVsaXZlcnktPmRlbGl2ZXJ5X2RhdGUpKSA6ICcnOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2NhdGVnb3J5JywgZnVuY3Rpb24gKCR2YWx1ZXMpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpc3NldCgkdmFsdWVzLT5wcm9kdWN0LT5jYXRlZ29yeS0+Y2F0ZWdvcnktPm5hbWUpID8gJHZhbHVlcy0+cHJvZHVjdC0+Y2F0ZWdvcnktPmNhdGVnb3J5LT5uYW1lIDogJyc7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbignY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncHJvZHVjdC5jYXRlZ29yeS5jYXRlZ29yeScsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignc3ViX2NhdGVnb3J5JywgZnVuY3Rpb24gKCR2YWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzc2V0KCR2YWx1ZXMtPnByb2R1Y3QtPmNhdGVnb3J5LT5uYW1lKSA/ICR2YWx1ZXMtPnByb2R1Y3QtPmNhdGVnb3J5LT5uYW1lIDogJyc7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbignc3ViX2NhdGVnb3J5JywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3Byb2R1Y3QuY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3Byb2R1Y3QnLCBmdW5jdGlvbiAoJHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNzZXQoJHZhbHVlcy0+cHJvZHVjdC0+bmFtZSkgPyAkdmFsdWVzLT5wcm9kdWN0LT5uYW1lLicgJy5nZXRQcm9kdWN0QXR0cmlidXRlc0Zhc3RlcigkdmFsdWVzLT5wcm9kdWN0KS4nICcuZ2V0UHJvZHVjdEF0dHJpYnV0ZXNGYXN0ZXIoJHZhbHVlcy0+cmVsUmVxdWlzaXRpb25EZWxpdmVyeS0+cmVsUmVxdWlzaXRpb24tPml0ZW1zLT53aGVyZSgncHJvZHVjdF9pZCcsICR2YWx1ZXMtPnByb2R1Y3RfaWQpLT5maXJzdCgpKSA6ICcnOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3Byb2R1Y3QnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncHJvZHVjdCcsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmVkaXRDb2x1bW4oJ2RlbGl2ZXJ5X3F0eScsIGZ1bmN0aW9uICgkdmFsdWVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudW1iZXJfZm9ybWF0KCR2YWx1ZXMtPmRlbGl2ZXJ5X3F0eSwgMCk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignYWN0aW9ucycsIGZ1bmN0aW9uICgkdmFsdWVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zID0gJzxwIGlkPSJhY3Rpb24nIC4gJHZhbHVlcy0+aWQgLiAnIj4nOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHZhbHVlcy0+c3RhdHVzID09ICdwZW5kaW5nJyB8fCAkdmFsdWVzLT5zdGF0dXMgPT0gJ2RlbGl2ZXJlZCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICc8ZGl2IGNsYXNzPSJidG4tZ3JvdXAiPjxidXR0b24gY2xhc3M9ImJ0biBkcm9wZG93bi10b2dnbGUiIGRhdGEtdG9nZ2xlPSJkcm9wZG93biI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBpZD0ic3RhdHVzTmFtZScgLiAkdmFsdWVzLT5pZCAuICciPicgLiB1Y2ZpcnN0KCR2YWx1ZXMtPnN0YXR1cykgLiAnIDxpIGNsYXNzPSJsYSBsYS1lbGxpcHNpcy12Ij48L2k+PC9zcGFuPjwvYnV0dG9uPjx1bCBjbGFzcz0iZHJvcGRvd24tbWVudSI+PGxpIGlkPSJoaWRlQnRuJyAuICR2YWx1ZXMtPmlkIC4gJyI+PGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiBvbmNsaWNrPSJkZWxpdmVyZWRBY2tub3dsZWRnZSgkKHRoaXMpKSIgY2xhc3M9ImRlbGl2ZXJlZEFja25vd2xlZGdlIiBkYXRhLWlkPSInIC4gJHZhbHVlcy0+aWQgLiAnIiB0aXRsZT0iQWNrbm93bGVkZ2VkIj48aSBjbGFzcz0ibGEgbGEtY2hlY2siPjwvaT5BY2tub3dsZWRnZWQ8L2E+PC9saT48L3VsPjwvZGl2Pic7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnQWNrbm93bGVkZ2VkJzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGFjdGlvbnM7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPnJhd0NvbHVtbnMoWydyZWZlcmVuY2Vfbm8nLCAncHJvZHVjdCcsICdhY3Rpb25zJ10pCiAgICAgICAgICAgICAgICAgICAgLT5tYWtlKHRydWUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAkZGF0YSA9IFsKICAgICAgICAgICAgICAgICd0aXRsZScgPT4gJ0RlbGl2ZXJkIFJlcXVpc2l0aW9uJywKICAgICAgICAgICAgICAgICdmcm9tJyA9PiAkZnJvbSwKICAgICAgICAgICAgICAgICd0bycgPT4gJHRvLAogICAgICAgICAgICAgICAgJ3N0YXR1c3MnID0+IFsncGVuZGluZycsICdhY2tub3dsZWRnZScsICdkZWxpdmVyZWQnXSwKICAgICAgICAgICAgICAgICdjYXRlZ29yeV9pZCcgPT4gJGNhdGVnb3J5X2lkLAogICAgICAgICAgICAgICAgJ2NhdGVnb3JpZXMnID0+ICRjYXRlZ29yaWVzLAogICAgICAgICAgICAgICAgJ2hlYWRlckNvbHVtbnMnID0+ICR0aGlzLT5kSGVhZGVyQ29sdW1ucygpLAogICAgICAgICAgICBdOwoKICAgICAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnJlcXVpc2l0aW9uLWRlbGl2ZXJ5LmRlbGl2ZXJlZC1yZXF1aXNpdGlvbi1saXN0JywgJGRhdGEpOwogICAgICAgIH0gY2F0Y2ggKFxUaHJvd2FibGUgJHRoKSB7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBkZWxpdmVyZWRSZXF1aXNpdGlvbkFjayhSZXF1ZXN0ICRyZXF1ZXN0KQogICAgewoKICAgICAgICAkcmVzcG9uc2UgPSBbXTsKCiAgICAgICAgJGRlbGl2ZXJlZFJlcXVpc2l0aW9uID0gUmVxdWlzaXRpb25EZWxpdmVyeUl0ZW06OndoZW4oaXNzZXQoQXV0aDo6dXNlcigpLT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCksIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVpc2l0aW9uRGVsaXZlcnkucmVsUmVxdWlzaXRpb24ucmVsVXNlcnNMaXN0LmVtcGxveWVlJywgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2FzX2RlcGFydG1lbnRfaWQnLCBBdXRoOjp1c2VyKCktPmVtcGxveWVlLT5hc19kZXBhcnRtZW50X2lkKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSktPndoZXJlSGFzKCdyZWxSZXF1aXNpdGlvbkRlbGl2ZXJ5LnJlbFJlcXVpc2l0aW9uJywgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnYXV0aG9yX2lkJywgYXV0aCgpLT51c2VyKCktPmlkKTsKICAgICAgICB9KQogICAgICAgICAgICAtPndoZXJlKCdpZCcsICRyZXF1ZXN0LT5pZCkKICAgICAgICAgICAgLT5maXJzdCgpOwoKICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAoaXNzZXQoJGRlbGl2ZXJlZFJlcXVpc2l0aW9uKSkgewoKICAgICAgICAgICAgICAgICRkZWxpdmVyZWRSZXF1aXNpdGlvbi0+c3RhdHVzID0gJ2Fja25vd2xlZGdlJzsKICAgICAgICAgICAgICAgICRkZWxpdmVyZWRSZXF1aXNpdGlvbi0+c2F2ZSgpOwoKICAgICAgICAgICAgICAgICRyZXNwb25zZVsncmVzdWx0J10gPSAnc3VjY2Vzcyc7CiAgICAgICAgICAgICAgICAkcmVzcG9uc2VbJ21lc3NhZ2UnXSA9ICdTdWNjZXNzZnVsbHkgQWNrbm93bGVkZ2VkLic7CgogICAgICAgICAgICAgICAgUmVxdWlzaXRpb25UcmFja2luZzo6c3RvcmVSZXF1aXNpdGlvblRyYWNraW5nKCRkZWxpdmVyZWRSZXF1aXNpdGlvbi0+cmVsUmVxdWlzaXRpb25EZWxpdmVyeS0+cmVsUmVxdWlzaXRpb24tPmlkLCAncmVjZWl2ZWQnKTsKCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAkcmVzcG9uc2VbJ3Jlc3VsdCddID0gJ2Vycm9yJzsKICAgICAgICAgICAgICAgICRyZXNwb25zZVsnbWVzc2FnZSddID0gJ05vIERhdGEgRm91bmQnOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoXFRocm93YWJsZSAkdGgpIHsKCiAgICAgICAgICAgICRyZXNwb25zZVsncmVzdWx0J10gPSAnZXJyb3InOwogICAgICAgICAgICAkcmVzcG9uc2VbJ21lc3NhZ2UnXSA9ICR0aC0+Z2V0TWVzc2FnZSgpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuICRyZXNwb25zZTsKICAgIH0KCiAgICBwdWJsaWMgZnVuY3Rpb24gZGVsaXZlcmVkUmVxdWlzaXRpb25TZWFyY2goUmVxdWVzdCAkcmVxdWVzdCkKICAgIHsKICAgICAgICAkcmVzcG9uc2UgPSBbXTsKCiAgICAgICAgJGZyb21EYXRlID0gZGF0ZSgnWS1tLWQgSDppOnMnLCBzdHJ0b3RpbWUoJHJlcXVlc3QtPmZyb21fZGF0ZSkpOwogICAgICAgICR0b0RhdGUgPSBkYXRlKCdZLW0tZCBIOmk6cycsIHN0cnRvdGltZSgkcmVxdWVzdC0+dG9fZGF0ZSkpOwoKICAgICAgICAkc3RhdHVzID0gJHJlcXVlc3QtPnN0YXR1czsKCiAgICAgICAgJGRlbGl2ZXJlZFJlcXVpc2l0aW9uID0gUmVxdWlzaXRpb25EZWxpdmVyeUl0ZW06OndoZW4oaXNzZXQoQXV0aDo6dXNlcigpLT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCksIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVpc2l0aW9uRGVsaXZlcnkucmVsUmVxdWlzaXRpb24ucmVsVXNlcnNMaXN0LmVtcGxveWVlJywgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2FzX2RlcGFydG1lbnRfaWQnLCBBdXRoOjp1c2VyKCktPmVtcGxveWVlLT5hc19kZXBhcnRtZW50X2lkKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSktPndoZXJlSGFzKCdyZWxSZXF1aXNpdGlvbkRlbGl2ZXJ5LnJlbFJlcXVpc2l0aW9uJywgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnYXV0aG9yX2lkJywgYXV0aCgpLT51c2VyKCktPmlkKTsKICAgICAgICB9KQogICAgICAgICAgICAtPndoZW4oJHN0YXR1cywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgkc3RhdHVzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnc3RhdHVzJywgJHN0YXR1cyk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+d2hlbigkZnJvbURhdGUsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGZyb21EYXRlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUmVxdWlzaXRpb25EZWxpdmVyeScsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGZyb21EYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVEYXRlKCdkZWxpdmVyeV9kYXRlJywgJz49JywgJGZyb21EYXRlKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPndoZW4oJHRvRGF0ZSwgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgkdG9EYXRlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUmVxdWlzaXRpb25EZWxpdmVyeScsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJHRvRGF0ZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlRGF0ZSgnZGVsaXZlcnlfZGF0ZScsICc8PScsICR0b0RhdGUpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+b3JkZXJCeSgnaWQnLCAnREVTQycpCiAgICAgICAgICAgIC0+cGFnaW5hdGUoMzApOwoKICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAoY291bnQoJGRlbGl2ZXJlZFJlcXVpc2l0aW9uKSA+IDApIHsKICAgICAgICAgICAgICAgICRib2R5ID0gVmlldzo6bWFrZSgncG1zLmJhY2tlbmQucGFnZXMucmVxdWlzaXRpb24tZGVsaXZlcnkuZGVsaXZlcmVkLXJlcXVpc2l0aW9uLXNlYXJjaCcsCiAgICAgICAgICAgICAgICAgICAgWydkZWxpdmVyZWRSZXF1aXNpdGlvbicgPT4gJGRlbGl2ZXJlZFJlcXVpc2l0aW9uXSk7CiAgICAgICAgICAgICAgICAkY29udGVudHMgPSAkYm9keS0+cmVuZGVyKCk7CiAgICAgICAgICAgICAgICAkcmVzcG9uc2VbJ3Jlc3VsdCddID0gJ3N1Y2Nlc3MnOwogICAgICAgICAgICAgICAgJHJlc3BvbnNlWydib2R5J10gPSAkY29udGVudHM7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAkcmVzcG9uc2VbJ3Jlc3VsdCddID0gJ2Vycm9yJzsKICAgICAgICAgICAgICAgICRyZXNwb25zZVsnbWVzc2FnZSddID0gJ05vIERhdGEgRm91bmQhISc7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChcVGhyb3dhYmxlICR0aCkgewoKICAgICAgICAgICAgJHJlc3BvbnNlWydyZXN1bHQnXSA9ICdlcnJvcic7CiAgICAgICAgICAgICRyZXNwb25zZVsnbWVzc2FnZSddID0gJHRoLT5nZXRNZXNzYWdlKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiAkcmVzcG9uc2U7CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIGhpc3RvcnkoJGlkKQogICAgewogICAgICAgIHRyeSB7CgogICAgICAgICAgICAkdGl0bGUgPSAiUmVxdWlzaXRpb24gSGlzdG9yeSI7CgogICAgICAgICAgICAkcmVxdWlzaXRpb24gPSBSZXF1ZXN0UHJvcG9zYWxSZXF1aXNpdGlvbnM6OndoZXJlKCdyZXF1aXNpdGlvbl9pZCcsICRpZCktPmZpcnN0KCk7CgogICAgICAgICAgICBpZiAoJHJlcXVpc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAkcHJvcG9zYWxzID0gKCRyZXF1aXNpdGlvbi0+cmVsUmVxdWVzdFByb3Bvc2FsKSA/ICRyZXF1aXNpdGlvbi0+cmVsUmVxdWVzdFByb3Bvc2FsIDogJyc7CgogICAgICAgICAgICAgICAgaWYgKCRwcm9wb3NhbHMgJiYgY291bnQoJHByb3Bvc2Fscy0+cmVsUXVvdGF0aW9ucykgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgJHB1cmNoYXNlID0gJHByb3Bvc2Fscy0+cmVsUXVvdGF0aW9ucygpLT53aXRoKCdyZWxQdXJjaGFzZU9yZGVyJyktPmZpcnN0KCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgJHB1cmNoYXNlT3JkZXIgPSBpc3NldCgkcHVyY2hhc2UpID8gKCFlbXB0eSgkcHVyY2hhc2UtPnJlbFB1cmNoYXNlT3JkZXIpID8gJHB1cmNoYXNlLT5yZWxQdXJjaGFzZU9yZGVyIDogJycpIDogJyc7CgogICAgICAgICAgICAgICAgaWYgKCRwdXJjaGFzZU9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgJGJpbGxNYW5hZ2UgPSBQdXJjaGFzZU9yZGVyOjp3aXRoKFsKICAgICAgICAgICAgICAgICAgICAgICAgJ3JlbEdvb2RSZWNlaXZlTm90ZScsCiAgICAgICAgICAgICAgICAgICAgICAgICdyZWxHb29kc1JlY2VpdmVkSXRlbVN0b2NrSW4nLAogICAgICAgICAgICAgICAgICAgICAgICAncmVsUXVvdGF0aW9uLnJlbFN1cHBsaWVycycsCiAgICAgICAgICAgICAgICAgICAgICAgICdyZWxRdW90YXRpb24uZXhjaGFuZ2VSYXRlLmN1cnJlbmN5JywKICAgICAgICAgICAgICAgICAgICAgICAgJ3JlbFB1cmNoYXNlT3JkZXJJdGVtcycsCiAgICAgICAgICAgICAgICAgICAgICAgICdyZWxQb0F0dGFjaG1lbnQnCiAgICAgICAgICAgICAgICAgICAgXSkKICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZSgnaXNfc2VuZCcsICd5ZXMnKQogICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlSGFzKCdyZWxHb29kUmVjZWl2ZU5vdGUnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlUmF3KCdwdXJjaGFzZV9vcmRlcnMuaWQ9Z29vZHNfcmVjZWl2ZWRfbm90ZXMucHVyY2hhc2Vfb3JkZXJfaWQnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUhhcygncmVsR29vZHNSZWNlaXZlZEl0ZW1TdG9ja0luJywgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2lzX2dybl9jb21wbGV0ZScsICd5ZXMnKS0+d2hlcmUoJ3RvdGFsX2Ftb3VudCcsICc+JywgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmUoJ2lkJywgJHB1cmNoYXNlT3JkZXItPmlkKQogICAgICAgICAgICAgICAgICAgICAgICAtPmZpcnN0KCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICRiaWxsTWFuYWdlID0gJyc7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnJmcC5yZnAtaGlzdG9yeScsIGNvbXBhY3QoJ3RpdGxlJywgJ3B1cmNoYXNlT3JkZXInLCAncHJvcG9zYWxzJywgJ2JpbGxNYW5hZ2UnKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9uID0gUmVxdWlzaXRpb246OndoZXJlKCdpZCcsICRpZCktPmZpcnN0KCk7CgogICAgICAgICAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnJlcXVpc2l0aW9ucy5oaXN0b3J5JywgY29tcGFjdCgndGl0bGUnLCAncmVxdWlzaXRpb24nKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgfSBjYXRjaCAoXFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aFdhcm5pbmcoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIER1cGxpY2F0ZSB0aGUgc3BlY2lmaWVkIHJlc291cmNlLgogICAgICoKICAgICAqIEBwYXJhbSBcQXBwXE1vZGVsc1xQbXNNb2RlbHNcUmVxdWlzaXRpb24gJGlkCiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcSnNvblJlc3BvbnNlCiAgICAgKi8KCiAgICBwdWJsaWMgZnVuY3Rpb24gcmVzZW5kUmVxdWlzaXRpb25Mb2dTdG9yZSgkcmVxdWlzaXRpb24pCiAgICB7CgogICAgICAgIERCOjpiZWdpblRyYW5zYWN0aW9uKCk7CiAgICAgICAgdHJ5IHsKCiAgICAgICAgICAgIC8vVGFzayBCdWRnZXQgVmFsaWRhdGlvbgogICAgICAgICAgICAkcHJvamVjdFRhc2tJZCA9IGlzc2V0KCRyZXF1aXNpdGlvbi0+cHJvamVjdF90YXNrX2lkKSA/ICRyZXF1aXNpdGlvbi0+cHJvamVjdF90YXNrX2lkIDogbnVsbDsKICAgICAgICAgICAgJHByb2plY3RUYXNrID0gUHJvamVjdFRhc2s6OmZpbmQoJHByb2plY3RUYXNrSWQpOwogICAgICAgICAgICBpZiAoaXNzZXQoJHByb2plY3RUYXNrLT5pZCkpIHsKICAgICAgICAgICAgICAgICRjb25zdW1wdGlvbnMgPSAwOwogICAgICAgICAgICAgICAgaWYgKGlzc2V0KCRwcm9qZWN0VGFzay0+cmVxdWlzaXRpb25zWzBdKSkgewogICAgICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRwcm9qZWN0VGFzay0+cmVxdWlzaXRpb25zIGFzICRrZXkgPT4gJHRoaXNfcmVxdWlzaXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGNvbnN1bXB0aW9ucyArPSBlc3RpbWF0ZWRWYWx1ZSgkdGhpc19yZXF1aXNpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9uQ29uc3VtcHRpb24gPSAwOwogICAgICAgICAgICAgICAgZm9yZWFjaCAoJHJlcXVpc2l0aW9uLT5pdGVtcyBhcyAkaXRlbSkgewogICAgICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbkNvbnN1bXB0aW9uICs9IFByb2R1Y3Q6OmZpbmQoJGl0ZW0tPnByb2R1Y3RfaWQpLT51bml0X3ByaWNlICogJGl0ZW0tPnF0eTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAkY29uc3VtcHRpb25zICs9ICRyZXF1aXNpdGlvbkNvbnN1bXB0aW9uOwogICAgICAgICAgICAgICAgaWYgKCRjb25zdW1wdGlvbnMgPiAkcHJvamVjdFRhc2stPnN1YkRlbGl2ZXJhYmxlLT5idWRnZXQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgJ21lc3NhZ2UnID0+ICdQcm9qZWN0IEJ1ZGdldCBhbGxvY2F0aW9uICgnIC4gJHByb2plY3RUYXNrLT5idWRnZXQgLiAnIEJEVCkgaGFzIGJlZW4gZXhjZWVkZWQgZm9yIHRoaXMgcmVxdWlzaXRpb24gKCcgLiAkcmVxdWlzaXRpb25Db25zdW1wdGlvbiAuICcgQkRUKS4gUmVtYWluaW5nIEJ1ZGdldCBpcyAoJyAuICgkcHJvamVjdFRhc2stPnN1YkRlbGl2ZXJhYmxlLT5idWRnZXQgPiAkY29uc3VtcHRpb25zID8gJHByb2plY3RUYXNrLT5zdWJEZWxpdmVyYWJsZS0+YnVkZ2V0IC0gJGNvbnN1bXB0aW9ucyA6IDApIC4gJyBCRFQpJwogICAgICAgICAgICAgICAgICAgIF0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vVGFzayBCdWRnZXQgVmFsaWRhdGlvbgoKICAgICAgICAgICAgJHJlc2VuZExvZ1JlcXVpc2l0aW9uID0gUmVxdWlzaXRpb25Mb2c6OmNyZWF0ZShbCiAgICAgICAgICAgICAgICAncmVxdWlzaXRpb25faWQnID0+ICRyZXF1aXNpdGlvbi0+aWQsCiAgICAgICAgICAgICAgICAncmVmZXJlbmNlX25vJyA9PiAkcmVxdWlzaXRpb24tPnJlZmVyZW5jZV9ubywKICAgICAgICAgICAgICAgICdyZXF1aXNpdGlvbl9kYXRlJyA9PiAkcmVxdWlzaXRpb24tPnJlcXVpc2l0aW9uX2RhdGUsCiAgICAgICAgICAgICAgICAnYXV0aG9yX2lkJyA9PiAkcmVxdWlzaXRpb24tPmF1dGhvcl9pZCwKICAgICAgICAgICAgICAgICdkZWxpdmVyYWJsZV9pZCcgPT4gaXNzZXQoJHJlcXVpc2l0aW9uLT5kZWxpdmVyYWJsZV9pZCkgPyAkcmVxdWlzaXRpb24tPmRlbGl2ZXJhYmxlX2lkIDogbnVsbCwKICAgICAgICAgICAgICAgICdwcm9qZWN0X3Rhc2tfaWQnID0+IGlzc2V0KCRyZXF1aXNpdGlvbi0+cHJvamVjdF90YXNrX2lkKSA/ICRyZXF1aXNpdGlvbi0+cHJvamVjdF90YXNrX2lkIDogbnVsbCwKICAgICAgICAgICAgICAgICdwcm9qZWN0X2lkJyA9PiBpc3NldCgkcmVxdWlzaXRpb24tPnByb2plY3RfaWQpID8gJHJlcXVpc2l0aW9uLT5wcm9qZWN0X2lkIDogbnVsbCwKICAgICAgICAgICAgICAgICdocl91bml0X2lkJyA9PiBpc3NldCgkcmVxdWlzaXRpb24tPmhyX3VuaXRfaWQpID8gJHJlcXVpc2l0aW9uLT5ocl91bml0X2lkIDogbnVsbCwKICAgICAgICAgICAgICAgICdyZXF1aXNpdGlvbicgPT4gJHJlcXVpc2l0aW9uLT5yZXF1aXNpdGlvbiwKICAgICAgICAgICAgICAgICdzdGF0dXMnID0+IDIsCiAgICAgICAgICAgICAgICAnYXBwcm92ZWRfaWQnID0+ICRyZXF1aXNpdGlvbi0+YXBwcm92ZWRfaWQsCiAgICAgICAgICAgICAgICAnaXNfc2VuZF90b19yZnAnID0+ICRyZXF1aXNpdGlvbi0+aXNfc2VuZF90b19yZnAsCiAgICAgICAgICAgICAgICAnZGVsaXZlcnlfc3RhdHVzJyA9PiAkcmVxdWlzaXRpb24tPmRlbGl2ZXJ5X3N0YXR1cywKICAgICAgICAgICAgICAgICdyZXF1ZXN0X3N0YXR1cycgPT4gJHJlcXVpc2l0aW9uLT5yZXF1ZXN0X3N0YXR1cywKICAgICAgICAgICAgICAgICdpc19wb19nZW5lcmF0ZScgPT4gJHJlcXVpc2l0aW9uLT5pc19wb19nZW5lcmF0ZSwKICAgICAgICAgICAgICAgICdleHBsYW5hdGlvbnMnID0+ICRyZXF1aXNpdGlvbi0+ZXhwbGFuYXRpb25zLAogICAgICAgICAgICAgICAgJ3JlbWFya3MnID0+ICRyZXF1aXNpdGlvbi0+cmVtYXJrcywKICAgICAgICAgICAgICAgICdkZWxpdmVyeV9ub3RlJyA9PiAkcmVxdWlzaXRpb24tPmRlbGl2ZXJ5X25vdGUsCiAgICAgICAgICAgICAgICAnYWRtaW5fcmVtYXJrJyA9PiAkcmVxdWlzaXRpb24tPmFkbWluX3JlbWFyaywKICAgICAgICAgICAgXSk7CgogICAgICAgICAgICBpZiAoJHJlcXVpc2l0aW9uLT5hdHRhY2htZW50KSB7CiAgICAgICAgICAgICAgICAkcmVzZW5kTG9nUmVxdWlzaXRpb24tPmF0dGFjaG1lbnQgPSAkcmVxdWlzaXRpb24tPmF0dGFjaG1lbnQ7CiAgICAgICAgICAgICAgICAkcmVzZW5kTG9nUmVxdWlzaXRpb24tPnNhdmUoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yZWFjaCAoJHJlcXVpc2l0aW9uLT5pdGVtcyBhcyAkaXRlbSkgewogICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9uSXRlbUlucHV0W10gPSBbCiAgICAgICAgICAgICAgICAgICAgJ3JlcXVpc2l0aW9uX2xvZ19pZCcgPT4gJHJlc2VuZExvZ1JlcXVpc2l0aW9uLT5pZCwKICAgICAgICAgICAgICAgICAgICAncHJvZHVjdF9pZCcgPT4gJGl0ZW0tPnByb2R1Y3RfaWQsCiAgICAgICAgICAgICAgICAgICAgJ3F0eScgPT4gJGl0ZW0tPnF0eSwKICAgICAgICAgICAgICAgICAgICAncmVxdWlzaXRpb25fcXR5JyA9PiAkaXRlbS0+cmVxdWlzaXRpb25fcXR5LAogICAgICAgICAgICAgICAgICAgICdkZWxpdmVyeV9xdHknID0+ICRpdGVtLT5kZWxpdmVyeV9xdHksCiAgICAgICAgICAgICAgICAgICAgJ3B1cmNoYXNlX3F0eScgPT4gJGl0ZW0tPnB1cmNoYXNlX3F0eSwKICAgICAgICAgICAgICAgICAgICAncWNfcXR5JyA9PiAkaXRlbS0+cWNfcXR5LAogICAgICAgICAgICAgICAgICAgICdjb21tZW50JyA9PiAkaXRlbS0+Y29tbWVudCwKICAgICAgICAgICAgICAgICAgICAnaXNfc2VuZCcgPT4gJGl0ZW0tPmlzX3NlbmQsCiAgICAgICAgICAgICAgICAgICAgJ3BvX2dlbmVyYXRlJyA9PiAkaXRlbS0+cG9fZ2VuZXJhdGUsCiAgICAgICAgICAgICAgICAgICAgJ2NyZWF0ZWRfYXQnID0+ICRpdGVtLT5jcmVhdGVkX2F0LAogICAgICAgICAgICAgICAgICAgICdjcmVhdGVkX2J5JyA9PiBhdXRoKCktPnVzZXIoKS0+aWQsCiAgICAgICAgICAgICAgICAgICAgJ3VwZGF0ZWRfYnknID0+IGF1dGgoKS0+dXNlcigpLT5pZCwKICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIFJlcXVpc2l0aW9uSXRlbUxvZzo6aW5zZXJ0KCRyZXF1aXNpdGlvbkl0ZW1JbnB1dCk7CiAgICAgICAgICAgIERCOjpjb21taXQoKTsKCiAgICAgICAgICAgIHJldHVybiB0cnVlOwoKICAgICAgICB9IGNhdGNoIChcVGhyb3dhYmxlICR0aCkgewogICAgICAgICAgICBEQjo6cm9sbGJhY2soKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnID0+IGZhbHNlLAogICAgICAgICAgICAgICAgJ21lc3NhZ2UnID0+ICR0aC0+Z2V0TWVzc2FnZSgpCiAgICAgICAgICAgIF0pOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIERpc3BsYXkgYSBsaXN0aW5nIG9mIHRoZSByZXNvdXJjZS4KICAgICAqCiAgICAgKiBAcGFyYW0gJGlkCiAgICAgKiBAcGFyYW0gJHJlcXVpc2l0aW9uTG9ncwogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxDb250cmFjdHNcRm91bmRhdGlvblxBcHBsaWNhdGlvbnxcSWxsdW1pbmF0ZVxDb250cmFjdHNcVmlld1xGYWN0b3J5fFxJbGx1bWluYXRlXENvbnRyYWN0c1xWaWV3XFZpZXd8XElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCgogICAgcHVibGljIGZ1bmN0aW9uIGxvZ0hlYWRlckNvbHVtbnMoJHZhbHVlID0gJycpCiAgICB7CiAgICAgICAgJHJvdyA9IGFycmF5KAogICAgICAgICAgICBbJ1NMJywgJ1NMJ10sCiAgICAgICAgICAgIFsncmVmZXJlbmNlX25vJywgJ3JlZmVyZW5jZV9ubycsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3JlcXVpc2l0aW9uX2RhdGUnLCAncmVxdWlzaXRpb25fZGF0ZScsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3Byb2R1Y3RfY2F0ZWdvcnknLCAncHJvZHVjdF9jYXRlZ29yeScsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ2F0dGFjaG1lbnQnLCAnYXR0YWNobWVudCcsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ2FkbWluX3JlbWFyaycsICdhZG1pbl9yZW1hcmsnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydzdGF0dXMnLCAnc3RhdHVzJywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gJHJvdzsKICAgIH0KCiAgICAvKioKICAgICAqIERpc3BsYXkgYSBsaXN0aW5nIG9mIHRoZSByZXNvdXJjZS4KICAgICAqCiAgICAgKiBAcGFyYW0gJGlkCiAgICAgKiBAcGFyYW0gJHJlcXVpc2l0aW9uTG9ncwogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxDb250cmFjdHNcRm91bmRhdGlvblxBcHBsaWNhdGlvbnxcSWxsdW1pbmF0ZVxDb250cmFjdHNcVmlld1xGYWN0b3J5fFxJbGx1bWluYXRlXENvbnRyYWN0c1xWaWV3XFZpZXd8XElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCgogICAgcHVibGljIGZ1bmN0aW9uIGxvZ0hpc3RvcnkoJGlkKQogICAgewogICAgICAgICR0aXRsZSA9ICdSZXF1aXNpdGlvbiBMb2cgSGlzdG9yeSc7CiAgICAgICAgJHJlcXVpc2l0aW9uTG9ncyA9IFJlcXVpc2l0aW9uTG9nOjp3aGVyZSgncmVxdWlzaXRpb25faWQnLCAkaWQpLT53aXRoKFsncmVxdWlzaXRpb25JdGVtTG9ncyddKQogICAgICAgICAgICAtPndoZW4oIWRhdGF0YWJsZU9yZGVyaW5nKCksIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyYnkoJ2lkJywgJ2Rlc2MnKTsKICAgICAgICAgICAgfSk7CgogICAgICAgIHRyeSB7CgogICAgICAgICAgICBpZiAocmVxdWVzdCgpLT5hamF4KCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBEYXRhdGFibGVzOjpvZigkcmVxdWlzaXRpb25Mb2dzKQogICAgICAgICAgICAgICAgICAgIC0+YWRkSW5kZXhDb2x1bW4oKQogICAgICAgICAgICAgICAgICAgIC0+ZWRpdENvbHVtbigncmVmZXJlbmNlX25vJywgZnVuY3Rpb24gKCRyZXF1aXNpdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgZGF0YS1zcmM9IicgLiByb3V0ZSgncG1zLnJlcXVpc2l0aW9uLmhpc3Rvcnkudmlldy5zaG93JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb24tPmlkKSAuICciIGNsYXNzPSJidG4gYnRuLWxpbmsgcmVxdWlzaXRpb24gbS0xIHJvdW5kZWQgc2hvd1JlcXVpc3Rpb25EZXRhaWxzIiBvbmNsaWNrPSJyZXF1aXN0aW9uRGV0YWlscygkKHRoaXMpKSI+JyAuICRyZXF1aXNpdGlvbi0+cmVmZXJlbmNlX25vIC4gJzwvYT4nOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3JlcXVpc2l0aW9uX2RhdGUnLCBmdW5jdGlvbiAoJHJlcXVpc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkYXRlKCdZLW0tZCcsIHN0cnRvdGltZSgkcmVxdWlzaXRpb24tPnJlcXVpc2l0aW9uX2RhdGUpKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdyZXF1aXNpdGlvbl9kYXRlJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgncmVxdWlzaXRpb25fZGF0ZScsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbigncmVxdWlzaXRpb25fZGF0ZScsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT5vcmRlckJ5KCdyZXF1aXNpdGlvbl9kYXRlJywgJG9yZGVyKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdwcm9kdWN0X2NhdGVnb3J5JywgZnVuY3Rpb24gKCRyZXF1aXNpdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNzZXQoJHJlcXVpc2l0aW9uLT5yZXF1aXNpdGlvbkl0ZW1Mb2dzWzBdLT5wcm9kdWN0LT5jYXRlZ29yeS0+Y2F0ZWdvcnktPm5hbWUpID8gJHJlcXVpc2l0aW9uLT5yZXF1aXNpdGlvbkl0ZW1Mb2dzWzBdLT5wcm9kdWN0LT5jYXRlZ29yeS0+Y2F0ZWdvcnktPm5hbWUgOiAnJzsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdwcm9kdWN0X2NhdGVnb3J5JywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlcXVpc2l0aW9uSXRlbUxvZ3MucHJvZHVjdC5jYXRlZ29yeS5jYXRlZ29yeScsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdwcm9kdWN0X2NhdGVnb3J5JywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwbGVhc2VTb3J0TWUoJHF1ZXJ5LCAkb3JkZXIsIFJlcXVpc2l0aW9uSXRlbUxvZzo6c2VsZWN0KCdtYWluX2NhdGVnb3J5Lm5hbWUnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdwcm9kdWN0cycsICdwcm9kdWN0cy5pZCcsICc9JywgJ3JlcXVpc2l0aW9uX2l0ZW1fbG9ncy5wcm9kdWN0X2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbignY2F0ZWdvcmllcyBhcyBzdWJfY2F0ZWdvcnknLCAnc3ViX2NhdGVnb3J5LmlkJywgJz0nLCAncHJvZHVjdHMuY2F0ZWdvcnlfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdjYXRlZ29yaWVzIGFzIG1haW5fY2F0ZWdvcnknLCAnbWFpbl9jYXRlZ29yeS5pZCcsICc9JywgJ3N1Yl9jYXRlZ29yeS5wYXJlbnRfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbigncmVxdWlzaXRpb25faXRlbV9sb2dzLnJlcXVpc2l0aW9uX2xvZ19pZCcsICdyZXF1aXNpdGlvbl9sb2dzLmlkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+dGFrZSgxKQogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5lZGl0Q29sdW1uKCdzdGF0dXMnLCBmdW5jdGlvbiAoJHJlcXVpc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRzdGF0dXMgPSAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgJHN0YXR1cyAuPSAnPHAgaWQ9InN0YXR1cycgLiAkcmVxdWlzaXRpb24tPmlkIC4gJyI+JzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRyZXF1aXNpdGlvbi0+c3RhdHVzID09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzdGF0dXMgLj0gJzxzcGFuIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi13YXJuaW5nIj5QZW5kaW5nPC9zcGFuPic7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZWlmICgkcmVxdWlzaXRpb24tPnN0YXR1cyA9PSAxKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHN0YXR1cyAuPSAnPHNwYW4gY2xhc3M9ImJ0biBidG4teHMgYnRuLXN1Y2Nlc3MiPkFwcHJvdmVkPC9zcGFuPic7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZWlmICgkcmVxdWlzaXRpb24tPnN0YXR1cyA9PSAyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc3RhdHVzIC49ICc8c3BhbiBjbGFzcz0iYnRuIGJ0bi14cyBidG4tZGFuZ2VyIj5IYWx0PC9zcGFuPic7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZWlmICgkcmVxdWlzaXRpb24tPnN0YXR1cyA9PSAzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc3RhdHVzIC49ICc8c3BhbiBjbGFzcz0iYnRuIGJ0bi14cyBidG4td2FybmluZyI+RHJhZnQ8L3NwYW4+JzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAkc3RhdHVzIC49ICc8L3A+JzsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRzdGF0dXM7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignYXR0YWNobWVudCcsIGZ1bmN0aW9uICgkcmVxdWlzaXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGF0dGFjaG1lbnQgPSAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdFbXBsb3llZScpIHx8IGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdEZXBhcnRtZW50LUhlYWQnKSB8fCBhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnUHVyY2hhc2UtRGVwYXJ0bWVudCcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWVtcHR5KCRyZXF1aXNpdGlvbi0+YXR0YWNobWVudCkgJiYgZmlsZV9leGlzdHMocHVibGljX3BhdGgoJHJlcXVpc2l0aW9uLT5hdHRhY2htZW50KSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYXR0YWNobWVudCAuPSAnPGEgaHJlZj0iJyAuIHVybCgkcmVxdWlzaXRpb24tPmF0dGFjaG1lbnQpIC4gJyIgdGFyZ2V0PSJfYmxhbmsiIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi1wcmltYXJ5Ij48aSBjbGFzcz0ibGFzIGxhLXBhcGVyY2xpcCI+PC9pPkF0dGFjaG1lbnQ8L2E+JzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRhdHRhY2htZW50OwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5yYXdDb2x1bW5zKFsncmVmZXJlbmNlX25vJywgJ3N0YXR1cycsICdhdHRhY2htZW50J10pCiAgICAgICAgICAgICAgICAgICAgLT5tYWtlKHRydWUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMucmVxdWlzaXRpb25zLmxvZ0hpc3RvcnknLCBbCiAgICAgICAgICAgICAgICAndGl0bGUnID0+ICR0aXRsZSwKICAgICAgICAgICAgICAgICdoZWFkZXJDb2x1bW5zJyA9PiAkdGhpcy0+bG9nSGVhZGVyQ29sdW1ucygpCiAgICAgICAgICAgIF0pOwoKICAgICAgICB9IGNhdGNoIChcRXhjZXB0aW9uICR0aCkgewogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCiAgICBwdWJsaWMgZnVuY3Rpb24gc2hvd0xvZ1JlcXVpc2l0aW9uSXRlbXMoJGlkKQogICAgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgICR0aXRsZSA9ICdSZXF1aXNpdGlvbiBMb2cgSXRlbXMgU2hvdyc7CiAgICAgICAgICAgICRyZXF1aXNpdGlvbiA9IFJlcXVpc2l0aW9uTG9nOjp3aXRoKFsKICAgICAgICAgICAgICAgICdwcm9qZWN0VGFzay5zdWJEZWxpdmVyYWJsZS5kZWxpdmVyYWJsZS5wcm9qZWN0JywKICAgICAgICAgICAgICAgICdyZXF1aXNpdGlvbkl0ZW1Mb2dzLnByb2R1Y3QuY2F0ZWdvcnkuY2F0ZWdvcnknLAogICAgICAgICAgICAgICAgJ3JlcXVpc2l0aW9uSXRlbUxvZ3MucHJvZHVjdC5wcm9kdWN0VW5pdCcsCiAgICAgICAgICAgICAgICAncmVxdWlzaXRpb25JdGVtTG9ncy5wcm9kdWN0LmF0dHJpYnV0ZXMuYXR0cmlidXRlT3B0aW9uLmF0dHJpYnV0ZScsCiAgICAgICAgICAgICAgICAncmVxdWlzaXRpb25JdGVtTG9ncy5wcm9kdWN0LnJlbEludmVudG9yeVN1bW1hcnknLAogICAgICAgICAgICAgICAgJ3JlbFVzZXJzTGlzdC5lbXBsb3llZS5sb2NhdGlvbicsCiAgICAgICAgICAgICAgICAncmVsVXNlcnNMaXN0LmVtcGxveWVlLmRlcGFydG1lbnQnLAogICAgICAgICAgICAgICAgJ3JlbFVzZXJzTGlzdC5lbXBsb3llZS51bml0JwogICAgICAgICAgICBdKS0+ZmluZE9yRmFpbCgkaWQpOwoKICAgICAgICAgICAgJGJvZHkgPSBWaWV3OjptYWtlKCdwbXMuYmFja2VuZC5wYWdlcy5yZXF1aXNpdGlvbnMubG9nU2hvdycsCiAgICAgICAgICAgICAgICBbJ3JlcXVpc2l0aW9uJyA9PiAkcmVxdWlzaXRpb24sICd0aXRsZScgPT4gJHRpdGxlXSk7CiAgICAgICAgICAgICRjb250ZW50cyA9ICRib2R5LT5yZW5kZXIoKTsKCiAgICAgICAgICAgIGlmIChyZXF1ZXN0KCktPmhhcygndmlldycpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJGNvbnRlbnRzOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbigkY29udGVudHMpOwogICAgICAgIH0gY2F0Y2ggKFxUaHJvd2FibGUgJHRoKSB7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiB1cGxvYWRFeGNlbChSZXF1ZXN0ICRyZXF1ZXN0KQogICAgewogICAgICAgICRyZXF1ZXN0LT52YWxpZGF0ZShbCiAgICAgICAgICAgICdjYXRlZ29yeScgPT4gJ3JlcXVpcmVkJywKICAgICAgICAgICAgJ2V4Y2VsX2ZpbGUnID0+ICdyZXF1aXJlZHxtaW1lczp4bHMseGxzeCcKICAgICAgICBdKTsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgJHBhdGggPSAkdGhpcy0+ZmlsZVVwbG9hZCgkcmVxdWVzdC0+ZmlsZSgnZXhjZWxfZmlsZScpLCAndXBsb2FkL3VwbG9hZC1leGNlbHMnKTsKICAgICAgICAgICAgJHNoZWV0cyA9IEV4Y2VsOjp0b0FycmF5KG5ldyBSZXF1aXNpdGlvbkltcG9ydCwgcHVibGljX3BhdGgoJHBhdGgpKTsKICAgICAgICAgICAgJHRoaXMtPmZpbGVEZWxldGUoJHBhdGgpOwoKICAgICAgICAgICAgJHByb2R1Y3RzID0gUHJvZHVjdDo6d2l0aChbCiAgICAgICAgICAgICAgICAncHJvZHVjdFVuaXQnCiAgICAgICAgICAgIF0pCiAgICAgICAgICAgICAgICAtPndoZXJlSGFzKCdjYXRlZ29yeScsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJHJlcXVlc3QpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgncGFyZW50X2lkJywgJHJlcXVlc3QtPmNhdGVnb3J5KTsKICAgICAgICAgICAgICAgIH0pLT5nZXQoKTsKCiAgICAgICAgICAgICRpdGVtcyA9IFtdOwogICAgICAgICAgICBpZiAoaXNzZXQoJHNoZWV0c1swXVswXSkpIHsKICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRzaGVldHNbMF0gYXMgJGtleSA9PiAkdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoJHByb2R1Y3RzLT53aGVyZSgnc2t1JywgJHZhbHVlWydwcm9kdWN0X3NrdSddKS0+Y291bnQoKSA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHByb2R1Y3QgPSAkcHJvZHVjdHMtPndoZXJlKCdza3UnLCAkdmFsdWVbJ3Byb2R1Y3Rfc2t1J10pLT5maXJzdCgpOwogICAgICAgICAgICAgICAgICAgICAgICBhcnJheV9wdXNoKCRpdGVtcywgWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2NhdGVnb3J5X2lkJyA9PiAkcHJvZHVjdC0+Y2F0ZWdvcnlfaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAncHJvZHVjdF9pZCcgPT4gJHByb2R1Y3QtPmlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3F1YW50aXR5JyA9PiAkdmFsdWVbJ3F1YW50aXR5J10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAndW9tJyA9PiAkcHJvZHVjdC0+cHJvZHVjdFVuaXQtPnVuaXRfbmFtZQogICAgICAgICAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHNlc3Npb24oKS0+cHV0KCdyZXF1aXNpdGlvbi1pdGVtcycsIFsKICAgICAgICAgICAgICAgICdjYXRlZ29yeV9pZCcgPT4gJHJlcXVlc3QtPmNhdGVnb3J5LAogICAgICAgICAgICAgICAgJ2l0ZW1zJyA9PiAkaXRlbXMKICAgICAgICAgICAgXSk7CgogICAgICAgICAgICBzZXNzaW9uKCktPmZsYXNoKCdhbGVydC10eXBlJywgJ3N1Y2Nlc3MnKTsKICAgICAgICAgICAgc2Vzc2lvbigpLT5mbGFzaCgnbWVzc2FnZScsICJFeGNlbCBmaWxlIHVwbG9hZGVkIHN1Y2Nlc3NmdWxseSAmIEl0ZW1zIGhhcyBiZWVuIGFkZGVkIHRvIHRoZSByZXF1aXNpb24gZm9ybS4iKTsKCiAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiB0cnVlLAogICAgICAgICAgICBdKTsKICAgICAgICB9IGNhdGNoIChcVGhyb3dhYmxlICR0aCkgewogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gZmFsc2UsCiAgICAgICAgICAgICAgICAnbWVzc2FnZScgPT4gJHRoLT5nZXRNZXNzYWdlKCkKICAgICAgICAgICAgXSk7CiAgICAgICAgfQogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBzZW5kUmVxdWlzaXRpb25Ub01hbmFnZW1lbnQoUmVxdWVzdCAkcmVxdWVzdCkKICAgIHsKICAgICAgICAkcmVzcG9uc2UgPSBbXTsKCiAgICAgICAgJHJlcXVpc2l0aW9uID0gUmVxdWlzaXRpb246OndoZXJlKFsnaWQnID0+ICRyZXF1ZXN0LT5yZXF1aXNpdGlvbl9pZCwgJ2lzX3Bhc3NlZCcgPT4gJ25vJ10pLT5maXJzdCgpOwoKICAgICAgICAvL1N0YXJ0IHRyYW5zYWN0aW9uCiAgICAgICAgREI6OmJlZ2luVHJhbnNhY3Rpb24oKTsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKCRyZXF1aXNpdGlvbikgewogICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9uLT5pc19wYXNzZWQgPSAneWVzJzsKICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbi0+cGFzc2VkX2J5ID0gXGF1dGgoKS0+dXNlcigpLT5pZDsKICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbi0+c2F2ZSgpOwoKICAgICAgICAgICAgICAgIC8vU2V0IE5vdGlmaWNhdGlvbgogICAgICAgICAgICAgICAgJG1lc3NhZ2UgPSAnPHNwYW4gY2xhc3M9Im5vdGlmaWNhdGlvbi1saW5rcyIgZGF0YS1zcmM9IicgLiByb3V0ZSgncG1zLnJlcXVpc2l0aW9uLmxpc3Qudmlldy5zaG93JywgJHJlcXVpc2l0aW9uLT5pZCkgLiAnIiBkYXRhLXRpdGxlPSJSZXF1aXNpdGlvbiBEZXRhaWxzIj5SZWZlcmVuY2UgTm86JyAuICRyZXF1aXNpdGlvbi0+cmVmZXJlbmNlX25vIC4gJy4gV2F0dGluZyBmb3IgYXBwcm92YWwuPC9zcGFuPic7CgogICAgICAgICAgICAgICAgaWYgKGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdEZXBhcnRtZW50LUhlYWQnKSkgewogICAgICAgICAgICAgICAgICAgICRyZWNlaXZlciA9IGdldE1hbmFnZXJJbmZvKCdNYW5hZ2VtZW50Jyk7CiAgICAgICAgICAgICAgICAgICAgJHJlY2VpdmVyX3NsdWcgPSAnc2VuZC10by1tYW5hZ2VtZW50JzsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBDcmVhdGVPclVwZGF0ZU5vdGlmaWNhdGlvbigkbWVzc2FnZSwgJ3VucmVhZCcsICcnLCAkcmVjZWl2ZXIsICRyZWNlaXZlcl9zbHVnLCAnJyk7CiAgICAgICAgICAgICAgICAvL0NvbW1pdCBkYXRhCiAgICAgICAgICAgICAgICBEQjo6Y29tbWl0KCk7CgogICAgICAgICAgICAgICAgJHJlc3BvbnNlWydyZXN1bHQnXSA9ICdzdWNjZXNzJzsKICAgICAgICAgICAgICAgICRyZXNwb25zZVsnbWVzc2FnZSddID0gJ1N1Y2Nlc3NmdWxseSBTZW5kIHRvIE1hbmFnZW1lbnQhISc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAkcmVzcG9uc2VbJ3Jlc3VsdCddID0gJ2Vycm9yJzsKICAgICAgICAgICAgICAgICRyZXNwb25zZVsnbWVzc2FnZSddID0gJ0RhdGEgbm90IGZvdW5kLiEhJzsKICAgICAgICAgICAgfQoKICAgICAgICB9IGNhdGNoIChcVGhyb3dhYmxlICR0aCkgewogICAgICAgICAgICAvL0lmIHByb2Nlc3MgaGFzIGFueSBwcm9ibGVtIHRoZW4gcm9sbGJhY2sgdGhlIGRhdGEKICAgICAgICAgICAgREI6OnJvbGxiYWNrKCk7CiAgICAgICAgICAgICRyZXNwb25zZVsncmVzdWx0J10gPSAnZXJyb3InOwogICAgICAgICAgICAkcmVzcG9uc2VbJ21lc3NhZ2UnXSA9ICR0aC0+Z2V0TWVzc2FnZSgpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuICRyZXNwb25zZTsKICAgIH0KCiAgICBwdWJsaWMgZnVuY3Rpb24gcGFzc2VkUmVxdWlzaXRpb25zKCkKICAgIHsKICAgICAgICB0cnkgewoKICAgICAgICAgICAgJHRpdGxlID0gJ1VzZXIgUGFzc2VkIFJlcXVpc2l0aW9uIExpc3QnOwogICAgICAgICAgICAkc3RhdHVzID0gcmVxdWVzdCgpLT5oYXMoJ3N0YXR1cycpID8gcmVxdWVzdCgpLT5nZXQoJ3N0YXR1cycpIDogLTE7CiAgICAgICAgICAgICRmcm9tID0gcmVxdWVzdCgpLT5oYXMoJ2Zyb20nKSA/IHJlcXVlc3QoKS0+Z2V0KCdmcm9tJykgOiBkYXRlKCdZLW0tMDEnKTsKICAgICAgICAgICAgJHRvID0gcmVxdWVzdCgpLT5oYXMoJ3RvJykgPyByZXF1ZXN0KCktPmdldCgndG8nKSA6IGRhdGUoJ1ktbS10Jyk7CiAgICAgICAgICAgICRjYXRlZ29yeV9pZCA9IHJlcXVlc3QoKS0+aGFzKCdjYXRlZ29yeV9pZCcpID8gcmVxdWVzdCgpLT5nZXQoJ2NhdGVnb3J5X2lkJykgOiAwOwogICAgICAgICAgICAkYXV0aG9yX2lkID0gcmVxdWVzdCgpLT5oYXMoJ2F1dGhvcl9pZCcpID8gcmVxdWVzdCgpLT5nZXQoJ2F1dGhvcl9pZCcpIDogMDsKCiAgICAgICAgICAgICRjYXRlZ29yaWVzID0gQ2F0ZWdvcnk6OmRvZXNudEhhdmUoJ2NhdGVnb3J5JykKICAgICAgICAgICAgICAgIC0+d2hlcmVIYXMoJ2RlcGFydG1lbnRzTGlzdCcsIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUluKCdocl9kZXBhcnRtZW50X2lkJywgYXV0aCgpLT51c2VyKCktPnByaW9yaXRpZXMtPnBsdWNrKCdocl9kZXBhcnRtZW50X2lkJyktPnRvQXJyYXkoKSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5nZXQoKTsKICAgICAgICAgICAgJHJlcXVpc2l0aW9uVXNlckxpc3RzID0gUmVxdWlzaXRpb246OndoZXJlSGFzKCdyZWxVc2Vyc0xpc3QuZW1wbG95ZWUnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUluKCdhc191bml0X2lkJywgYXV0aCgpLT51c2VyKCktPnByaW9yaXRpZXMtPnBsdWNrKCdocl91bml0X2lkJyktPnRvQXJyYXkoKSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmpvaW4oJ3VzZXJzJywgJ3VzZXJzLmlkJywgJz0nLCAncmVxdWlzaXRpb25zLmF1dGhvcl9pZCcpCiAgICAgICAgICAgICAgICAtPmdyb3VwQnkoJ3JlcXVpc2l0aW9ucy5hdXRob3JfaWQnKQogICAgICAgICAgICAgICAgLT5nZXQoWyd1c2Vycy5pZCcsICd1c2Vycy5uYW1lJ10pOwoKICAgICAgICAgICAgJGRhdGEgPSBbCiAgICAgICAgICAgICAgICAndGl0bGUnID0+ICdSZXF1aXNpdGlvbicsCiAgICAgICAgICAgICAgICAncmVxdWlzaXRpb25Vc2VyTGlzdHMnID0+ICRyZXF1aXNpdGlvblVzZXJMaXN0cywKICAgICAgICAgICAgICAgICdmcm9tJyA9PiAkZnJvbSwKICAgICAgICAgICAgICAgICd0bycgPT4gJHRvLAogICAgICAgICAgICAgICAgJ3N0YXR1cycgPT4gJHN0YXR1cywKICAgICAgICAgICAgICAgICdjYXRlZ29yeV9pZCcgPT4gJGNhdGVnb3J5X2lkLAogICAgICAgICAgICAgICAgJ2F1dGhvcl9pZCcgPT4gJGF1dGhvcl9pZCwKICAgICAgICAgICAgICAgICdjYXRlZ29yaWVzJyA9PiAkY2F0ZWdvcmllcywKICAgICAgICAgICAgICAgICdoZWFkZXJDb2x1bW5zJyA9PiAkdGhpcy0+dXNlckhlYWRlckNvbHVtbnMoKQogICAgICAgICAgICBdOwoKICAgICAgICAgICAgJHJlcXVpc2l0aW9ucyA9IFJlcXVpc2l0aW9uOjp3aXRoKFsnaXRlbXMnLCAnaXRlbXMucHJvZHVjdC5jYXRlZ29yeS5jYXRlZ29yeScsICdyZWxVc2Vyc0xpc3QnLCAncmVsVXNlcnNMaXN0LmVtcGxveWVlLnVuaXQnXSkKICAgICAgICAgICAgICAgIC0+d2hlcmVIYXMoJ3JlbFVzZXJzTGlzdC5lbXBsb3llZScsIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUluKCdhc191bml0X2lkJywgYXV0aCgpLT51c2VyKCktPnByaW9yaXRpZXMtPnBsdWNrKCdocl91bml0X2lkJyktPnRvQXJyYXkoKSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT53aGVuKHN0cnRvdGltZSgkZnJvbSkgPiAwLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRmcm9tKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVEYXRlKCdyZXF1aXNpdGlvbl9kYXRlJywgJz49JywgJGZyb20pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+d2hlbihzdHJ0b3RpbWUoJHRvKSA+IDAsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJHRvKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVEYXRlKCdyZXF1aXNpdGlvbl9kYXRlJywgJzw9JywgJHRvKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPndoZW4oJHN0YXR1cyA+PSAwLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRzdGF0dXMpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnc3RhdHVzJywgJHN0YXR1cyk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT53aGVuKCRhdXRob3JfaWQgPiAwLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRhdXRob3JfaWQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnYXV0aG9yX2lkJywgJGF1dGhvcl9pZCk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT53aGVuKCRjYXRlZ29yeV9pZCA+IDAsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGNhdGVnb3J5X2lkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ2l0ZW1zLnByb2R1Y3QuY2F0ZWdvcnkuY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRjYXRlZ29yeV9pZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnaWQnLCAkY2F0ZWdvcnlfaWQpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+d2hlbighZGF0YXRhYmxlT3JkZXJpbmcoKSwgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyYnkoJ2lkJywgJ2Rlc2MnKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPndoZXJlTm90SW4oJ3N0YXR1cycsIFszXSkKICAgICAgICAgICAgICAgIC0+d2hlcmUoJ2lzX3Bhc3NlZCcsICd5ZXMnKTsKCiAgICAgICAgICAgIGlmIChyZXF1ZXN0KCktPmFqYXgoKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIERhdGF0YWJsZXM6Om9mKCRyZXF1aXNpdGlvbnMpCiAgICAgICAgICAgICAgICAgICAgLT5hZGRJbmRleENvbHVtbigpCiAgICAgICAgICAgICAgICAgICAgLT5lZGl0Q29sdW1uKCdyZWZlcmVuY2Vfbm8nLCBmdW5jdGlvbiAoJHJlcXVpc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnPGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiBkYXRhLXNyYz0iJyAuIHJvdXRlKCdwbXMucmVxdWlzaXRpb24ubGlzdC52aWV3LnNob3cnLCAkcmVxdWlzaXRpb24tPmlkKSAuICciIGNsYXNzPSJidG4gYnRuLWxpbmsgcmVxdWlzaXRpb24gbS0xIHJvdW5kZWQgc2hvd1JlcXVpc3Rpb25EZXRhaWxzIiBvbmNsaWNrPSJyZXF1aXN0aW9uRGV0YWlscygkKHRoaXMpKSI+JyAuICRyZXF1aXNpdGlvbi0+cmVmZXJlbmNlX25vIC4gJzwvYT4nOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5lZGl0Q29sdW1uKCdyZXF1aXNpdGlvbl9kYXRlJywgZnVuY3Rpb24gKCRyZXF1aXNpdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGF0ZSgnWS1tLWQnLCBzdHJ0b3RpbWUoJHJlcXVpc2l0aW9uLT5yZXF1aXNpdGlvbl9kYXRlKSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdyZXF1aXNpdGlvbl9kYXRlJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyQnkoJ3JlcXVpc2l0aW9uX2RhdGUnLCAkb3JkZXIpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3Byb2R1Y3RfY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHJlcXVpc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpc3NldCgkcmVxdWlzaXRpb24tPml0ZW1zWzBdLT5wcm9kdWN0LT5jYXRlZ29yeS0+Y2F0ZWdvcnktPm5hbWUpID8gJHJlcXVpc2l0aW9uLT5pdGVtc1swXS0+cHJvZHVjdC0+Y2F0ZWdvcnktPmNhdGVnb3J5LT5uYW1lIDogJyc7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbigncHJvZHVjdF9jYXRlZ29yeScsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdpdGVtcy5wcm9kdWN0LmNhdGVnb3J5LmNhdGVnb3J5JywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ3Byb2R1Y3RfY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgUmVxdWlzaXRpb25JdGVtOjpzZWxlY3QoJ21haW5fY2F0ZWdvcnkubmFtZScpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ3Byb2R1Y3RzJywgJ3Byb2R1Y3RzLmlkJywgJz0nLCAncmVxdWlzaXRpb25faXRlbXMucHJvZHVjdF9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ2NhdGVnb3JpZXMgYXMgc3ViX2NhdGVnb3J5JywgJ3N1Yl9jYXRlZ29yeS5pZCcsICc9JywgJ3Byb2R1Y3RzLmNhdGVnb3J5X2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbignY2F0ZWdvcmllcyBhcyBtYWluX2NhdGVnb3J5JywgJ21haW5fY2F0ZWdvcnkuaWQnLCAnPScsICdzdWJfY2F0ZWdvcnkucGFyZW50X2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3JlcXVpc2l0aW9uX2l0ZW1zLnJlcXVpc2l0aW9uX2lkJywgJ3JlcXVpc2l0aW9ucy5pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdyZXF1aXNpdGlvbl9ieScsIGZ1bmN0aW9uICgkcmVxdWlzaXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzc2V0KCRyZXF1aXNpdGlvbi0+cmVsVXNlcnNMaXN0LT5uYW1lKSA/ICRyZXF1aXNpdGlvbi0+cmVsVXNlcnNMaXN0LT5uYW1lIDogJyc7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbigncmVxdWlzaXRpb25fYnknLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsVXNlcnNMaXN0JywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ3JlcXVpc2l0aW9uX2J5JywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwbGVhc2VTb3J0TWUoJHF1ZXJ5LCAkb3JkZXIsIFVzZXI6OnNlbGVjdCgnbmFtZScpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCd1c2Vycy5pZCcsICdyZXF1aXNpdGlvbnMuYXV0aG9yX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCd1bml0JywgZnVuY3Rpb24gKCRyZXF1aXNpdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNzZXQoJHJlcXVpc2l0aW9uLT5yZWxVc2Vyc0xpc3QtPmVtcGxveWVlLT51bml0LT5ocl91bml0X3Nob3J0X25hbWUpID8gJHJlcXVpc2l0aW9uLT5yZWxVc2Vyc0xpc3QtPmVtcGxveWVlLT51bml0LT5ocl91bml0X3Nob3J0X25hbWUgOiAnJzsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCd1bml0JywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFVzZXJzTGlzdC5lbXBsb3llZS51bml0JywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnaHJfdW5pdF9zaG9ydF9uYW1lJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbigndW5pdCcsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBcQXBwXFVzZXI6OnNlbGVjdCgnaHJfdW5pdC5ocl91bml0X3Nob3J0X25hbWUnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdocl9hc19iYXNpY19pbmZvJywgJ2hyX2FzX2Jhc2ljX2luZm8uYXNzb2NpYXRlX2lkJywgJz0nLCAndXNlcnMuYXNzb2NpYXRlX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbignaHJfdW5pdCcsICdocl91bml0LmhyX3VuaXRfaWQnLCAnPScsICdocl9hc19iYXNpY19pbmZvLmFzX3VuaXRfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbigndXNlcnMuaWQnLCAncmVxdWlzaXRpb25zLmF1dGhvcl9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignYXR0YWNobWVudCcsIGZ1bmN0aW9uICgkcmVxdWlzaXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGF0dGFjaG1lbnQgPSAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdFbXBsb3llZScpIHx8IGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdEZXBhcnRtZW50LUhlYWQnKSB8fCBhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnUHVyY2hhc2UtRGVwYXJ0bWVudCcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWVtcHR5KCRyZXF1aXNpdGlvbi0+YXR0YWNobWVudCkgJiYgZmlsZV9leGlzdHMocHVibGljX3BhdGgoJHJlcXVpc2l0aW9uLT5hdHRhY2htZW50KSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYXR0YWNobWVudCAuPSAnPGEgaHJlZj0iJyAuIHVybCgkcmVxdWlzaXRpb24tPmF0dGFjaG1lbnQpIC4gJyIgdGFyZ2V0PSJfYmxhbmsiIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi1wcmltYXJ5Ij48aSBjbGFzcz0ibGFzIGxhLXBhcGVyY2xpcCI+PC9pPkF0dGFjaG1lbnQ8L2E+JzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGF0dGFjaG1lbnQ7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmVkaXRDb2x1bW4oJ3N0YXR1cycsIGZ1bmN0aW9uICgkcmVxdWlzaXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHN0YXR1cyA9ICcnOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRyZXF1aXNpdGlvbi0+c3RhdHVzID09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzdGF0dXMgLj0gJzxzcGFuIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi13YXJuaW5nIj5QZW5kaW5nPC9zcGFuPic7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZWlmICgkcmVxdWlzaXRpb24tPnN0YXR1cyA9PSAxKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHN0YXR1cyAuPSAnPHNwYW4gY2xhc3M9ImJ0biBidG4teHMgYnRuLXN1Y2Nlc3MiPkFja25vd2xlZGdlPC9zcGFuPic7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZWlmICgkcmVxdWlzaXRpb24tPnN0YXR1cyA9PSAyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc3RhdHVzIC49ICc8c3BhbiBjbGFzcz0iYnRuIGJ0bi14cyBidG4tZGFuZ2VyIj5IYWx0PC9zcGFuPic7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgJHN0YXR1cyAuPSAnPC9wPic7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkc3RhdHVzOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2FjdGlvbnMnLCBmdW5jdGlvbiAoJHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyA9ICcnOwoKICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxkaXYgY2xhc3M9ImJ0bi1ncm91cCI+PGJ1dHRvbiBjbGFzcz0iYnRuIGRyb3Bkb3duLXRvZ2dsZSIgZGF0YS10b2dnbGU9ImRyb3Bkb3duIj48c3BhbiBpZD0ic3RhdHVzTmFtZScgLiAkdmFsdWVzLT5pZCAuICciPjxpIGNsYXNzPSJsYSBsYS1lbGxpcHNpcy12Ij48L2k+PC9zcGFuPjwvYnV0dG9uPjx1bCBjbGFzcz0iZHJvcGRvd24tbWVudSI+JzsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkdmFsdWVzLT5pc19zZW5kX3RvX3JmcCA9PSAnbm8nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHZhbHVlcy0+c3RhdHVzICE9IDAgJiYgYXV0aCgpLT51c2VyKCktPmhhc1Blcm1pc3Npb25UbygncGVuZGluZycpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxsaT48YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIHRpdGxlPSJDbGljayBIZXJlIFRvIFBlbmRpbmciIGNsYXNzPSJyZXF1aXNpdGlvbkFwcHJvdmVkQnRuIiBkYXRhLWlkPSInIC4gJHZhbHVlcy0+aWQgLiAnIiBvbmNsaWNrPSJyZXF1aXNpdGlvbkFwcHJvdmVkQnRuKCQodGhpcykpIiAgZGF0YS1kYXRhPSJwZW5kaW5nIiBkYXRhLXN0YXR1cz0iMCI+PGkgY2xhc3M9ImxhIGxhLXBhdXNlIj48L2k+UGVuZGluZzwvYT48L2xpPic7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnPGxpPjxhIGhyZWY9IicgLiByb3V0ZSgncG1zLnJlcXVpc2l0aW9uLnJlcXVpc2l0aW9uLmVkaXQnLCAkdmFsdWVzLT5pZCkgLiAnP3JlZGlyZWN0PXBhc3NlZC1yZXF1aXNpdGlvbi1hcHByb3ZhbCZlZGl0b3I9bWFuYWdlbWVudCIgdGl0bGU9IkNsaWNrIEhlcmUgVG8gRWRpdCI+PGkgY2xhc3M9ImxhIGxhLWVkaXQiPjwvaT5FZGl0PC9hPjwvbGk+JzsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHZhbHVlcy0+c3RhdHVzICE9IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXV0aCgpLT51c2VyKCktPmhhc1Blcm1pc3Npb25UbygncmVxdWlzaXRpb24tYWNrbm93bGVkZ2UnKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnPGxpPjxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgdGl0bGU9IkNsaWNrIEhlcmUgVG8gQWNrbm93bGVkZ2UiIGNsYXNzPSJyZXF1aXNpdGlvbkFwcHJvdmVkQnRuIiBvbmNsaWNrPSJyZXF1aXNpdGlvbkFwcHJvdmVkQnRuKCQodGhpcykpIiBkYXRhLWlkPSInIC4gJHZhbHVlcy0+aWQgLiAnIiBkYXRhLWRhdGE9ImFja25vd2xlZGdlZCIgZGF0YS1zdGF0dXM9IjEiPjxpIGNsYXNzPSJsYSBsYS1jaGVjayI+PC9pPkFja25vd2xlZGdlPC9hPjwvbGk+JzsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhdXRoKCktPnVzZXIoKS0+aGFzUGVybWlzc2lvblRvKCdoYWx0JykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHZhbHVlcy0+c3RhdHVzICE9IDIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxsaT48YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIHRpdGxlPSJDbGljayBIZXJlIFRvIEhhbHQiIGNsYXNzPSJyZXF1aXNpdGlvbkFwcHJvdmVkQnRuIiBvbmNsaWNrPSJyZXF1aXNpdGlvbkFwcHJvdmVkQnRuKCQodGhpcykpIiBkYXRhLWRhdGE9ImhhbHQiIGRhdGEtaWQ9IicgLiAkdmFsdWVzLT5pZCAuICciIGRhdGEtc3RhdHVzPSIyIj48aSBjbGFzcz0ibGEgbGEtYmFuIj48L2k+SGFsdDwvYT48L2xpPic7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnPGxpPjxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgdGl0bGU9IlRyYWNraW5nIFJlcXVpc2l0aW9uIiBjbGFzcz0idHJhY2tpbmdSZXF1aXN0aW9uU3RhdHVzIiBvbmNsaWNrPSJ0cmFja2luZ1JlcXVpc2l0aW9uU3RhdHVzKCcgLiAkdmFsdWVzLT5pZCAuICcpIiA+PGkgY2xhc3M9ImxhIGxhLW1hcCI+PC9pPlRyYWNrIFByb2dyZXNzPC9hPjwvbGk+JzsKCiAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICc8bGk+PGEgdGFyZ2V0PSJfX2JsYW5rIiBocmVmPSInIC4gcm91dGUoJ3Btcy5yZXF1aXNpdGlvbi5oaXN0b3J5JywgJHZhbHVlcy0+aWQpIC4gJyI+PGkgY2xhc3M9ImxhIGxhLWhpc3RvcnkiIHRpdGxlPSJSZXF1aXNpdGlvbiBIaXN0b3J5Ij48L2k+UmVxdWlzaXRpb24gSGlzdG9yeTwvYT48L2xpPC9hPjwvbGk+JzsKCgogICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnPC91bD48L2Rpdj4nOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGFjdGlvbnM7CgogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5yYXdDb2x1bW5zKFsncmVmZXJlbmNlX25vJywgJ3N0YXR1cycsICdhdHRhY2htZW50JywgJ2FjdGlvbnMnXSkKICAgICAgICAgICAgICAgICAgICAtPm1ha2UodHJ1ZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5yZXF1aXNpdGlvbnMucGFzc2VkLXJlcXVpc2l0aW9uLWluZGV4JywgJGRhdGEpOwogICAgICAgIH0gY2F0Y2ggKFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9Cn0KCg==