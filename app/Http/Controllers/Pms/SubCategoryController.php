<?php
bolt_decrypt( __FILE__ , 'biGBcI'); return 0;
##!!!##CgpuYW1lc3BhY2UgQXBwXEh0dHBcQ29udHJvbGxlcnNcUG1zOwoKdXNlIEFwcFxIdHRwXENvbnRyb2xsZXJzXENvbnRyb2xsZXI7CnVzZSBBcHBcSW1wb3J0c1xDYXRlZ29yeUltcG9ydDsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXENhdGVnb3J5Owp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUHJvZHVjdEF0dHJpYnV0ZTsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFJlcXVpc2l0aW9uVHlwZTsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFdhcmVob3VzZXM7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xDYXRlZ29yeURlcGFydG1lbnQ7CnVzZSBBcHBcTW9kZWxzXEhyXFVuaXQ7CnVzZSBBcHBcTW9kZWxzXEhyXERlcGFydG1lbnQ7CnVzZSBJbGx1bWluYXRlXEh0dHBcUmVxdWVzdDsKdXNlIElsbHVtaW5hdGVcVmFsaWRhdGlvblxSdWxlOwp1c2UgTWFhdHdlYnNpdGVcRXhjZWxcRmFjYWRlc1xFeGNlbDsKCnVzZSBcQXBwXE1vZGVsc1xQbXNNb2RlbHNcQXR0cmlidXRlOwp1c2UgXEFwcFxNb2RlbHNcUG1zTW9kZWxzXEF0dHJpYnV0ZU9wdGlvbjsKdXNlIFxBcHBcTW9kZWxzXFBtc01vZGVsc1xDYXRlZ29yeUF0dHJpYnV0ZTsKCnVzZSBEQiwgRGF0YVRhYmxlczsKCmNsYXNzIFN1YkNhdGVnb3J5Q29udHJvbGxlciBleHRlbmRzIENvbnRyb2xsZXIKewogICAgcHVibGljIGZ1bmN0aW9uIGhlYWRlckNvbHVtbnMoJHZhbHVlPScnKQogICAgewogICAgICAgIHJldHVybiBhcnJheSgKICAgICAgICAgICAgWydTTCcsICdTTCcsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICAvLyBbJ3Byb2R1Y3RfdHlwZScsICdwcm9kdWN0X3R5cGUnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydtYWluX2NhdGVnb3J5JywgJ21haW5fY2F0ZWdvcnknLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydjb2RlJywgJ2NvZGUnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWyduYW1lJywgJ25hbWUnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydhdHRyaWJ1dGVzJywgJ2F0dHJpYnV0ZXMnXSwKICAgICAgICAgICAgWyd1bml0cycsICd1bml0cycsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICAvLyBbJ3NlcnZpY2UnLCAnc2VydmljZScsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICAvLyBbJ3NhbGVfaXRlbScsICdzYWxlX2l0ZW0nLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydhY3Rpb25zJywgJ2FjdGlvbnMnLCAndGV4dC1jZW50ZXInXQogICAgICAgICk7CiAgICB9CiAgICAvKioKICAgICAqIERpc3BsYXkgYSBsaXN0aW5nIG9mIHRoZSByZXNvdXJjZS4KICAgICAqCiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwogICAgcHVibGljIGZ1bmN0aW9uIGluZGV4KCkKICAgIHsKICAgICAgICB0cnkgewogICAgICAgICAgICAkdGl0bGUgPSAnU3ViIENhdGVnb3J5JzsKCiAgICAgICAgICAgICRpc19maXhlZF9hc3NldCA9IHJlcXVlc3QoKS0+aGFzKCdmaXhlZC1hc3NldHMnKTsKICAgICAgICAgICAgJGlzX2N3aXAgPSByZXF1ZXN0KCktPmhhcygnY3dpcCcpOwoKICAgICAgICAgICAgJHVuaXRzID0gVW5pdDo6YWxsKCk7CiAgICAgICAgICAgICRjYXRlZ29yaWVzID0gQ2F0ZWdvcnk6OndpdGgoWwogICAgICAgICAgICAgICAgJ2NhdGVnb3J5JywKICAgICAgICAgICAgICAgICdhdHRyaWJ1dGVzLmF0dHJpYnV0ZScKICAgICAgICAgICAgXSkKICAgICAgICAgICAgLT5oYXMoJ2NhdGVnb3J5JykKICAgICAgICAgICAgLT53aGVyZUhhcygnY2F0ZWdvcnkuZGVwYXJ0bWVudHNMaXN0LmRlcGFydG1lbnQudW5pdCcsIGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUluKCdjb21wYW55X2lkJywgYXV0aCgpLT51c2VyKCktPmNvbXBhbmllcy0+cGx1Y2soJ2NvbXBhbnlfaWQnKS0+dG9BcnJheSgpKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT53aGVuKCFkYXRhdGFibGVPcmRlcmluZygpLCBmdW5jdGlvbigkcXVlcnkpewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+b3JkZXJieSgncGFyZW50X2lkJywgJ2Rlc2MnKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBpZiAocmVxdWVzdCgpLT5hamF4KCkpIHsKICAgICAgICAgICAgICAgICRhdHRyaWJ1dGVPcHRpb25zID0gQXR0cmlidXRlT3B0aW9uOjphbGwoKTsKICAgICAgICAgICAgICAgIHJldHVybiBEYXRhdGFibGVzOjpvZigkY2F0ZWdvcmllcykKICAgICAgICAgICAgICAgIC0+YWRkSW5kZXhDb2x1bW4oKQogICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3VuaXRzJywgZnVuY3Rpb24oJHN1YkNhdGVnb3J5KSB1c2UoJHVuaXRzKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHVuaXRzLT53aGVyZUluKCdocl91bml0X2lkJywgJHN1YkNhdGVnb3J5LT5jYXRlZ29yeS0+ZGVwYXJ0bWVudHNMaXN0LT5wbHVjaygnZGVwYXJ0bWVudC5ocl91bml0X2lkJyktPnRvQXJyYXkoKSktPnBsdWNrKCdocl91bml0X3Nob3J0X25hbWUnKS0+aW1wbG9kZSgnLCAnKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbigndW5pdHMnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdjYXRlZ29yeS5kZXBhcnRtZW50c0xpc3QuZGVwYXJ0bWVudC51bml0JywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ2hyX3VuaXRfc2hvcnRfbmFtZScsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJyk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbigndW5pdHMnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBDYXRlZ29yeURlcGFydG1lbnQ6OnNlbGVjdCgnaHJfdW5pdC5ocl91bml0X3Nob3J0X25hbWUnKQogICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ2hyX3VuaXQnLCAnaHJfdW5pdC5ocl91bml0X2lkJywgJz0nLCAnY2F0ZWdvcmllc19kZXBhcnRtbmV0LmhyX3VuaXRfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ2hyX2RlcGFydG1lbnQnLCAnaHJfZGVwYXJ0bWVudC5ocl9kZXBhcnRtZW50X2lkJywgJz0nLCAnY2F0ZWdvcmllc19kZXBhcnRtbmV0LmhyX2RlcGFydG1lbnRfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCdjYXRlZ29yaWVzX2RlcGFydG1lbnQuY2F0ZWdvcnlfaWQnLCAnY2F0ZWdvcmllcy5pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+dGFrZSgxKQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3Byb2R1Y3RfdHlwZScsIGZ1bmN0aW9uKCRzdWJDYXRlZ29yeSl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRzdWJDYXRlZ29yeS0+aXNfZml4ZWRfYXNzZXQgPT0gMSA/ICdGaXhlZCBBc3NldCcgOiAoJHN1YkNhdGVnb3J5LT5pc19jd2lwID09IDEgPyAnQ1dJUCcgOiAnUHJvZHVjdHMnKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignc2VydmljZScsIGZ1bmN0aW9uICgkY2F0ZWdvcnkpewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkY2F0ZWdvcnktPmlzX3NlcnZpY2UgPT0gMSA/ICc8YSBjbGFzcz0iYnRuIGJ0bi1zdWNjZXNzIGJ0bi14cyI+WWVzPC9hPicgOiAnPGEgY2xhc3M9ImJ0biBidG4tZGFyayBidG4teHMiPk5vPC9hPic7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3NhbGVfaXRlbScsIGZ1bmN0aW9uICgkY2F0ZWdvcnkpewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkY2F0ZWdvcnktPmlzX3NhbGVfaXRlbSA9PSAxID8gJzxhIGNsYXNzPSJidG4gYnRuLXN1Y2Nlc3MgYnRuLXhzIj5ZZXM8L2E+JyA6ICc8YSBjbGFzcz0iYnRuIGJ0bi1kYXJrIGJ0bi14cyI+Tm88L2E+JzsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignbWFpbl9jYXRlZ29yeScsIGZ1bmN0aW9uKCRzdWJDYXRlZ29yeSl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzc2V0KCRzdWJDYXRlZ29yeS0+Y2F0ZWdvcnktPm5hbWUpPyRzdWJDYXRlZ29yeS0+Y2F0ZWdvcnktPm5hbWU6Jyc7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ21haW5fY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdjYXRlZ29yeScsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignYXR0cmlidXRlcycsIGZ1bmN0aW9uICgkc3ViQ2F0ZWdvcnkpIHVzZSgkYXR0cmlidXRlT3B0aW9ucyl7CiAgICAgICAgICAgICAgICAgICAgJGF0dHIgPScnOwogICAgICAgICAgICAgICAgICAgICRhdHRyaWJ1dGVzID0gaXNzZXQoJHN1YkNhdGVnb3J5LT5hdHRyaWJ1dGVzWzBdKSA/IGNvbGxlY3QoJHN1YkNhdGVnb3J5LT5hdHRyaWJ1dGVzKS0+c29ydEJ5KCdzZXJpYWwnKS0+dmFsdWVzKCktPmFsbCgpIDogW107CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzc2V0KCRhdHRyaWJ1dGVzWzBdKSkgewogICAgICAgICAgICAgICAgICAgICAgICAkYXR0ciAuPSc8dWw+JzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcmVhY2goJGF0dHJpYnV0ZXMgYXMgJGtleSA9PiAkY2F0ZWdvcnlBdHRyaWJ1dGUpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhdHRyIC49JzxsaT48c3Ryb25nPicuJGNhdGVnb3J5QXR0cmlidXRlLT5hdHRyaWJ1dGUtPm5hbWUuJzo8L3N0cm9uZz4gJy4kYXR0cmlidXRlT3B0aW9ucy0+d2hlcmUoJ2F0dHJpYnV0ZV9pZCcsICRjYXRlZ29yeUF0dHJpYnV0ZS0+YXR0cmlidXRlX2lkKS0+d2hlcmVJbignaWQnLCAoIWVtcHR5KCRjYXRlZ29yeUF0dHJpYnV0ZS0+b3B0aW9ucykgPyBqc29uX2RlY29kZSgkY2F0ZWdvcnlBdHRyaWJ1dGUtPm9wdGlvbnMsIHRydWUpIDogW10pKS0+cGx1Y2soJ25hbWUnKS0+aW1wbG9kZSgnLCAnKS4nPC9saT4nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAkYXR0ciAuPSc8L3VsPic7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiAkYXR0cjsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbignYXR0cmlidXRlcycsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ2F0dHJpYnV0ZXMuYXR0cmlidXRlJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgIH0pLT5vcldoZXJlSGFzKCdhdHRyaWJ1dGVzLmF0dHJpYnV0ZS5vcHRpb25zJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ2F0dHJpYnV0ZXMnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBDYXRlZ29yeUF0dHJpYnV0ZTo6c2VsZWN0KCdhdHRyaWJ1dGVzLmNvZGUnKQogICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ2F0dHJpYnV0ZXMnLCAnYXR0cmlidXRlcy5pZCcsICc9JywgJ2NhdGVnb3J5X2F0dHJpYnV0ZXMuYXR0cmlidXRlX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbignY2F0ZWdvcnlfYXR0cmlidXRlcy5jYXRlZ29yeV9pZCcsICdjYXRlZ29yaWVzLmlkJykKICAgICAgICAgICAgICAgICAgICAgICAgLT50YWtlKDEpCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignYWN0aW9ucycsIGZ1bmN0aW9uKCRzdWJDYXRlZ29yeSl7CiAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgPSAnJzsKCiAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0nPGEgaHJlZj0iJy51cmwoJ3Btcy9wcm9kdWN0LW1hbmFnZW1lbnQvc3ViLWNhdGVnb3J5LycuJHN1YkNhdGVnb3J5LT5pZC4nL2NyZWF0ZS1hdHRyaWJ1dGVzJykuJyIgY2xhc3M9ImJ0biBidG4tc3VjY2VzcyBtLTEgYnRuLXhzIj48aSBjbGFzcz0ibGFzIGxhLXNpdGVtYXAiPjwvaT48L2E+JzsKCiAgICAgICAgICAgICAgICAgICAgJHVybCA9IHJvdXRlKCdwbXMucHJvZHVjdC1tYW5hZ2VtZW50LnN1Yi1jYXRlZ29yeS5lZGl0JywgJHN1YkNhdGVnb3J5LT5pZCk7CiAgICAgICAgICAgICAgICAgICAgaWYocmVxdWVzdCgpLT5oYXMoJ2ZpeGVkLWFzc2V0cycpKXsKICAgICAgICAgICAgICAgICAgICAgICAgJHVybCA9IHVybCgncG1zL2ZpeGVkLWFzc2V0cy9zdWItY2F0ZWdvcnkvZWRpdC8nLiRzdWJDYXRlZ29yeS0+aWQuJz9maXhlZC1hc3NldHMnKTsKICAgICAgICAgICAgICAgICAgICB9ZWxzZWlmKHJlcXVlc3QoKS0+aGFzKCdjd2lwJykpewogICAgICAgICAgICAgICAgICAgICAgICAkdXJsID0gdXJsKCdwbXMvY3dpcC9zdWItY2F0ZWdvcnkvJy4kc3ViQ2F0ZWdvcnktPmlkLicvZWRpdD9jd2lwJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICc8YSBocmVmPSInLiAkdXJsIC4nIiBjbGFzcz0iYnRuIGJ0bi1pbmZvIG0tMSBidG4teHMiPjxpIGNsYXNzPSJsYXMgbGEtZWRpdCI+PC9pPjwvYT4nOwogICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICc8YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIGRhdGEtcm9sZT0iZGVsZXRlIiBkYXRhLXNyYz0iJy4gcm91dGUoJ3Btcy5wcm9kdWN0LW1hbmFnZW1lbnQuc3ViLWNhdGVnb3J5LmRlc3Ryb3knLCAkc3ViQ2F0ZWdvcnktPmlkKSAuJyIgY2xhc3M9ImJ0biBidG4tZGFuZ2VyIG0tMSBidG4teHMgZGVsZXRlQnRuIiBvbmNsaWNrPSJkZWxldGVGcm9tQ1JVRCgkKHRoaXMpKSI+PGkgY2xhc3M9ImxhcyBsYS10cmFzaCI+PC9pPjwvYT4nOwoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGFjdGlvbnM7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5yYXdDb2x1bW5zKFsnYXR0cmlidXRlcycsICdhY3Rpb25zJywgJ3NlcnZpY2UnLCAnc2FsZV9pdGVtJ10pCiAgICAgICAgICAgICAgICAtPm1ha2UodHJ1ZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5zdWItY2F0ZWdvcnkuaW5kZXgnLFsKICAgICAgICAgICAgICAgICd0aXRsZScgPT4kdGl0bGUsCiAgICAgICAgICAgICAgICAnaGVhZGVyQ29sdW1ucycgPT4gJHRoaXMtPmhlYWRlckNvbHVtbnMoKSwKICAgICAgICAgICAgICAgICdpc19maXhlZF9hc3NldCcgPT4gJGlzX2ZpeGVkX2Fzc2V0LAogICAgICAgICAgICAgICAgJ2lzX2N3aXAnID0+ICRpc19jd2lwLAogICAgICAgICAgICBdKTsKCiAgICAgICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKIAogICAgLyoqCiAgICAgKiBTaG93IHRoZSBmb3JtIGZvciBjcmVhdGluZyBhIG5ldyByZXNvdXJjZS4KICAgICAqCiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwogICAgcHVibGljIGZ1bmN0aW9uIGNyZWF0ZSgpCiAgICB7CiAgICAgICAgaWYocmVxdWVzdCgpLT5oYXMoJ3VwZGF0ZS1jYXRlZ29yeS1kZXBhcnRtZW50cycpKXsKICAgICAgICAgICAgJGNhdGVnb3JpZXMgPSBDYXRlZ29yeTo6aGFzKCdjYXRlZ29yeScpLT5kb2VzbnRIYXZlKCdkZXBhcnRtZW50c0xpc3QnKS0+Z2V0KCk7CiAgICAgICAgICAgICRkZXBhcnRtZW50cyA9IERlcGFydG1lbnQ6OmFsbCgpOwogICAgICAgICAgICBpZigkY2F0ZWdvcmllcy0+Y291bnQoKSA+IDApewogICAgICAgICAgICAgICAgZm9yZWFjaCgkY2F0ZWdvcmllcyBhcyAkY2F0ZWdvcnkpewogICAgICAgICAgICAgICAgICAgICRjYXRlZ29yeS0+ZGVwYXJ0bWVudCgpLT5zeW5jKCRkZXBhcnRtZW50cy0+cGx1Y2soJ2hyX2RlcGFydG1lbnRfaWQnKS0+dG9BcnJheSgpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYocmVxdWVzdCgpLT5oYXMoJ2dldC1jYXRlZ29yaWVzJykpewogICAgICAgICAgICAkY2F0ZWdvcmllcyA9IENhdGVnb3J5Ojp3aXRoKFsKICAgICAgICAgICAgICAgICdjYXRlZ29yeScsICdkZXBhcnRtZW50c0xpc3QnCiAgICAgICAgICAgIF0pCiAgICAgICAgICAgIC0+ZG9lc250SGF2ZSgnY2F0ZWdvcnknKQogICAgICAgICAgICAtPndoZXJlSGFzKCdkZXBhcnRtZW50c0xpc3QuZGVwYXJ0bWVudC51bml0JywgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSW4oJ2NvbXBhbnlfaWQnLCBhdXRoKCktPnVzZXIoKS0+Y29tcGFuaWVzLT5wbHVjaygnY29tcGFueV9pZCcpLT50b0FycmF5KCkpOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPm9yZGVyYnkoJ2NvZGUnLCAnYXNjJykKICAgICAgICAgICAgLT53aGVuKHJlcXVlc3QoKS0+Z2V0KCdwcm9kdWN0X3R5cGUnKSA9PSAncHJvZHVjdHMnLCBmdW5jdGlvbigkcXVlcnkpewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2lzX2ZpeGVkX2Fzc2V0JywgMCktPndoZXJlKCdpc19jd2lwJywgMCk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+d2hlbihyZXF1ZXN0KCktPmdldCgncHJvZHVjdF90eXBlJykgPT0gJ2ZpeGVkX2Fzc2V0JywgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdpc19maXhlZF9hc3NldCcsIDEpOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPndoZW4ocmVxdWVzdCgpLT5nZXQoJ3Byb2R1Y3RfdHlwZScpID09ICdjd2lwJywgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdpc19jd2lwJywgMSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+Z2V0KCk7CgogICAgICAgICAgICAkZGF0YSA9ICcnOwogICAgICAgICAgICBpZihpc3NldCgkY2F0ZWdvcmllc1swXSkpewogICAgICAgICAgICAgICAgZm9yZWFjaCgkY2F0ZWdvcmllcyBhcyAkY2F0ZWdvcnkpewogICAgICAgICAgICAgICAgICAgIGlmKCFpc3NldCgkY2F0ZWdvcnktPmNhdGVnb3J5LT5pZCkpewogICAgICAgICAgICAgICAgICAgICAgICAkZGF0YSAuPSAnPG9wdGlvbiB2YWx1ZT0iJy4kY2F0ZWdvcnktPmlkLiciICcuKHJlcXVlc3QoKS0+Z2V0KCdzZWxlY3RlZCcpID09ICRjYXRlZ29yeS0+aWQgPyAnc2VsZWN0ZWQnIDogJycpLicgZGF0YS1kZXBhcnRtZW50cz0iJy4kY2F0ZWdvcnktPmRlcGFydG1lbnRzTGlzdC0+cGx1Y2soJ2hyX2RlcGFydG1lbnRfaWQnKS0+aW1wbG9kZSgnLCcpLiciIGludmVudG9yeV9hY2NvdW50X2lkPSInLiRjYXRlZ29yeS0+aW52ZW50b3J5X2FjY291bnRfaWQuJyIgY3dpcF9hc3NldF9hY2NvdW50X2lkPSInLiRjYXRlZ29yeS0+Y3dpcF9hc3NldF9hY2NvdW50X2lkLiciIGNvZ3NfYWNjb3VudF9pZD0iJy4kY2F0ZWdvcnktPmNvZ3NfYWNjb3VudF9pZC4nIiBpbnZlbnRvcnlfYWRqdXN0bWVudHNfYWNjb3VudF9pZD0iJy4kY2F0ZWdvcnktPmludmVudG9yeV9hZGp1c3RtZW50c19hY2NvdW50X2lkLiciIGlzX2ZpeGVkX2Fzc2V0PSInLiRjYXRlZ29yeS0+aXNfZml4ZWRfYXNzZXQuJyIgaXNfY3dpcD0iJy4kY2F0ZWdvcnktPmlzX2N3aXAuJyIgIGRlcHJlY2lhdGlvbl9yYXRlPSInLiRjYXRlZ29yeS0+ZGVwcmVjaWF0aW9uX3JhdGUuJyIgc2FsZXNfYWNjb3VudF9pZD0iJy4kY2F0ZWdvcnktPnNhbGVzX2FjY291bnRfaWQuJyIgZGVwcmVjaWF0aW9uX2Nvc3RfYWNjb3VudF9pZD0iJy4kY2F0ZWdvcnktPmRlcHJlY2lhdGlvbl9jb3N0X2FjY291bnRfaWQuJyIgZGVwcmVjaWF0aW9uX2Rpc3Bvc2FsX2FjY291bnRfaWQ9IicuJGNhdGVnb3J5LT5kZXByZWNpYXRpb25fZGlzcG9zYWxfYWNjb3VudF9pZC4nIiBkYXRhLXByb2R1Y3QtdHlwZT0iJy5yZXF1ZXN0KCktPmdldCgncHJvZHVjdF90eXBlJykuJyIgZGF0YS1zZXJ2aWNlPSInLiRjYXRlZ29yeS0+aXNfc2VydmljZS4nIj4nLiRjYXRlZ29yeS0+bmFtZS4nICgnLiRjYXRlZ29yeS0+Y29kZS4nICknLic8L29wdGlvbj4nOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuICRkYXRhOwogICAgICAgIH0KCiAgICAgICAgJHRpdGxlID0gIlN1YiBDYXRlZ29yeSBDcmVhdGUiOwogICAgICAgICRyZXF1aXNpdGlvbnMgPSBSZXF1aXNpdGlvblR5cGU6OmFsbCgpOwogICAgICAgICRkZXBhcnRtZW50cyA9IERlcGFydG1lbnQ6OmFsbCgpOwogICAgICAgICRjb2RlID0gdW5pcXVlQ29kZSg3LCdDVC0nLCdjYXRlZ29yaWVzJywnaWQnKTsKICAgICAgICAkY2hhcnRPZkFjY291bnRzT3B0aW9ucyA9IGNoYXJ0T2ZBY2NvdW50c09wdGlvbnMoW10sIDAsIDAsIFtdKTsKCiAgICAgICAgJGNhdGVnb3JpZXMgPSBDYXRlZ29yeTo6d2l0aChbCiAgICAgICAgICAgICdjYXRlZ29yeScsICdkZXBhcnRtZW50c0xpc3QnCiAgICAgICAgXSkKICAgICAgICAtPmRvZXNudEhhdmUoJ2NhdGVnb3J5JykKICAgICAgICAtPndoZXJlSGFzKCdkZXBhcnRtZW50c0xpc3QuZGVwYXJ0bWVudC51bml0JywgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVJbignY29tcGFueV9pZCcsIGF1dGgoKS0+dXNlcigpLT5jb21wYW5pZXMtPnBsdWNrKCdjb21wYW55X2lkJyktPnRvQXJyYXkoKSk7CiAgICAgICAgfSkKICAgICAgICAtPm9yZGVyYnkoJ2NvZGUnLCAnYXNjJykKICAgICAgICAtPmdldCgpOwoKICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMuc3ViLWNhdGVnb3J5LmNyZWF0ZScsIGNvbXBhY3QoJ3RpdGxlJywncmVxdWlzaXRpb25zJywnZGVwYXJ0bWVudHMnLCdjb2RlJywgJ2NoYXJ0T2ZBY2NvdW50c09wdGlvbnMnLCAnY2F0ZWdvcmllcycpKTsKICAgIH0KCiAgICAvKioKICAgICAqIFNob3cgdGhlIGZvcm0gZm9yIGNyZWF0aW5nIGEgbmV3IHJlc291cmNlLgogICAgICoKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCiAgICBwdWJsaWMgZnVuY3Rpb24gY3JlYXRlQXR0cmlidXRlcygkY2F0ZWdvcnlfaWQpCiAgICB7CiAgICAgICAgJGNhdGVnb3J5ID0gQ2F0ZWdvcnk6OmZpbmRPckZhaWwoJGNhdGVnb3J5X2lkKTsKICAgICAgICAkZGF0YSA9IFsKICAgICAgICAgICAgJ3RpdGxlJyA9PiAiQXR0cmlidXRlcyBmb3IgIyIuJGNhdGVnb3J5LT5uYW1lLAogICAgICAgICAgICAnc3ViY2F0ZWdvcnknID0+ICRjYXRlZ29yeSwKICAgICAgICAgICAgJ2F0dHJpYnV0ZXMnID0+IEF0dHJpYnV0ZTo6aGFzKCdvcHRpb25zJyktPndpdGgoWydvcHRpb25zJ10pLT5nZXQoKSwKICAgICAgICAgICAgJ2NhdGVnb3J5QXR0cmlidXRlcycgPT4gQ2F0ZWdvcnlBdHRyaWJ1dGU6OndoZXJlKCdjYXRlZ29yeV9pZCcsICRjYXRlZ29yeS0+aWQpLT5wbHVjaygnYXR0cmlidXRlX2lkJyktPnRvQXJyYXkoKSwKICAgICAgICBdOwoKICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMuc3ViLWNhdGVnb3J5LmF0dHJpYnV0ZXMnLCAkZGF0YSk7CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIHVwZGF0ZUF0dHJpYnV0ZXMoUmVxdWVzdCAkcmVxdWVzdCwgJGlkKQogICAgewogICAgICAgIERCOjpiZWdpblRyYW5zYWN0aW9uKCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgJGNhdGVnb3J5ID0gQ2F0ZWdvcnk6OmZpbmRPckZhaWwoJGlkKTsKICAgICAgICAgICAgJGNhdGVnb3J5LT5maWxsKCRyZXF1ZXN0LT5hbGwoKSktPnNhdmUoKTsKCiAgICAgICAgICAgIGlmKGlzc2V0KCRyZXF1ZXN0LT5wcm9kdWN0QXR0cmlidXRlc1swXSkpewogICAgICAgICAgICAgICAgZm9yZWFjaCAoJHJlcXVlc3QtPnByb2R1Y3RBdHRyaWJ1dGVzIGFzICRrZXkgPT4gJGF0dHJpYnV0ZV9pZCkgewogICAgICAgICAgICAgICAgICAgIENhdGVnb3J5QXR0cmlidXRlOjp1cGRhdGVPckNyZWF0ZShbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnY2F0ZWdvcnlfaWQnID0+ICRjYXRlZ29yeS0+aWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnYXR0cmlidXRlX2lkJyA9PiAkYXR0cmlidXRlX2lkCiAgICAgICAgICAgICAgICAgICAgXSwgWwogICAgICAgICAgICAgICAgICAgICAgICAnc2VyaWFsJyA9PiAkcmVxdWVzdC0+YXR0cmlidXRlU2VyaWFsc1skYXR0cmlidXRlX2lkXSwKICAgICAgICAgICAgICAgICAgICAgICAgJ29wdGlvbnMnID0+IGpzb25fZW5jb2RlKCRyZXF1ZXN0LT5hdHRyaWJ1dGVPcHRpb25zWyRhdHRyaWJ1dGVfaWRdKSwKICAgICAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgQ2F0ZWdvcnlBdHRyaWJ1dGU6OndoZXJlKCdjYXRlZ29yeV9pZCcsICRjYXRlZ29yeS0+aWQpCiAgICAgICAgICAgIC0+d2hlcmVOb3RJbignYXR0cmlidXRlX2lkJywgJHJlcXVlc3QtPnByb2R1Y3RBdHRyaWJ1dGVzKQogICAgICAgICAgICAtPmRlbGV0ZSgpOwoKICAgICAgICAgICAgJHByb2R1Y3RBdHRyaWJ1dGVzID0gUHJvZHVjdEF0dHJpYnV0ZTo6d2hlcmVIYXMoJ2F0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGUuY2F0ZWdvcmllcycsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRjYXRlZ29yeSl7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnY2F0ZWdvcnlfaWQnLCAkY2F0ZWdvcnktPmlkKTsKICAgICAgICAgICAgfSktPmdldCgpOwoKICAgICAgICAgICAgaWYoaXNzZXQoJHByb2R1Y3RBdHRyaWJ1dGVzWzBdKSl7CiAgICAgICAgICAgICAgICBmb3JlYWNoKCRwcm9kdWN0QXR0cmlidXRlcyBhcyAka2V5ID0+ICRwcm9kdWN0QXR0cmlidXRlKXsKICAgICAgICAgICAgICAgICAgICAkc2VyaWFsID0gQ2F0ZWdvcnlBdHRyaWJ1dGU6OndoZXJlKCdjYXRlZ29yeV9pZCcsICRjYXRlZ29yeS0+aWQpCiAgICAgICAgICAgICAgICAgICAgLT53aGVyZUhhcygnYXR0cmlidXRlLm9wdGlvbnMnLCBmdW5jdGlvbigkcXVlcnkpIHVzZSgkcHJvZHVjdEF0dHJpYnV0ZSl7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdpZCcsICRwcm9kdWN0QXR0cmlidXRlLT5hdHRyaWJ1dGVfb3B0aW9uX2lkKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+Zmlyc3QoKTsKICAgICAgICAgICAgICAgICAgICAkcHJvZHVjdEF0dHJpYnV0ZS0+c2VyaWFsX25vID0gKGlzc2V0KCRzZXJpYWwtPnNlcmlhbCkgPyAkc2VyaWFsLT5zZXJpYWwgOiAwKTsKICAgICAgICAgICAgICAgICAgICAkcHJvZHVjdEF0dHJpYnV0ZS0+c2F2ZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBEQjo6Y29tbWl0KCk7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhTdWNjZXNzKCdTdWIgQ2F0ZWdvcnkgQXR0cmlidXRlcyBoYXZlIGJlbm4gdXBkYXRlZC4gJyk7CiAgICAgICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgIERCOjpyb2xsYmFjaygpOwogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFN0b3JlIGEgbmV3bHkgY3JlYXRlZCByZXNvdXJjZSBpbiBzdG9yYWdlLgogICAgICoKICAgICAqIEBwYXJhbSAgXElsbHVtaW5hdGVcSHR0cFxSZXF1ZXN0ICAkcmVxdWVzdAogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KICAgIHB1YmxpYyBmdW5jdGlvbiBzdG9yZShSZXF1ZXN0ICRyZXF1ZXN0KQogICAgewogICAgICAgICR0aGlzLT52YWxpZGF0ZSgkcmVxdWVzdCwgWwogICAgICAgICAgICAnY29kZScgPT4gWydyZXF1aXJlZCcsICdzdHJpbmcnLCAnbWF4OjI1NScsICd1bmlxdWU6Y2F0ZWdvcmllcyddLAogICAgICAgICAgICAnbmFtZScgPT4gWydyZXF1aXJlZCcsICdzdHJpbmcnLCAnbWF4OjI1NSddLAogICAgICAgICAgICAncGFyZW50X2lkJyA9PiBbJ251bGxhYmxlJywgJ2ludGVnZXInXSwKICAgICAgICBdKTsKICAgICAgICB0cnkgewogICAgICAgICAgICAkaW5wdXRzID0gJHJlcXVlc3QtPmFsbCgpOwogICAgICAgICAgICB1bnNldCgkaW5wdXRzWydfdG9rZW4nXSk7CiAgICAgICAgICAgIHVuc2V0KCRpbnB1dHNbJ19tZXRob2QnXSk7CgogICAgICAgICAgICAkaXNfZml4ZWRfYXNzZXQgPSAwOwogICAgICAgICAgICAkaXNfY3dpcCA9IDA7CiAgICAgICAgICAgIGlmKCRyZXF1ZXN0LT5wcm9kdWN0X3R5cGUgPT0gJ2ZpeGVkX2Fzc2V0Jyl7CiAgICAgICAgICAgICAgICAkaXNfZml4ZWRfYXNzZXQgPSAxOwogICAgICAgICAgICAgICAgJGlzX2N3aXAgPSAwOwogICAgICAgICAgICB9ZWxzZWlmKCRyZXF1ZXN0LT5wcm9kdWN0X3R5cGUgPT0gJ2N3aXAnKXsKICAgICAgICAgICAgICAgICRpc19maXhlZF9hc3NldCA9IDA7CiAgICAgICAgICAgICAgICAkaXNfY3dpcCA9IDE7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICRjYXRlZ29yeSA9IENhdGVnb3J5OjpjcmVhdGUoJGlucHV0cyk7CiAgICAgICAgICAgICRjYXRlZ29yeS0+aXNfZml4ZWRfYXNzZXQgPSAkaXNfZml4ZWRfYXNzZXQ7CiAgICAgICAgICAgICRjYXRlZ29yeS0+aXNfY3dpcCA9ICRpc19jd2lwOwogICAgICAgICAgICAkY2F0ZWdvcnktPnNhdmUoKTsKCiAgICAgICAgICAgICRkZXBhcnRtZW50cyA9IENhdGVnb3J5RGVwYXJ0bWVudDo6d2hlcmUoJ2NhdGVnb3J5X2lkJywgJHJlcXVlc3QtPnBhcmVudF9pZCktPnBsdWNrKCdocl9kZXBhcnRtZW50X2lkJyktPnRvQXJyYXkoKTsKICAgICAgICAgICAgJGNhdGVnb3J5LT5kZXBhcnRtZW50KCktPnN5bmMoJGRlcGFydG1lbnRzKTsKCiAgICAgICAgICAgICR1cmwgPSB1cmwoJ3Btcy9wcm9kdWN0LW1hbmFnZW1lbnQvc3ViLWNhdGVnb3J5Jyk7CiAgICAgICAgICAgIGlmKCRpc19maXhlZF9hc3NldCA9PSAxKXsKICAgICAgICAgICAgICAgICR1cmwgPSB1cmwoJ3Btcy9maXhlZC1hc3NldHMvc3ViLWNhdGVnb3J5JykuJz9maXhlZC1hc3NldHMnOwogICAgICAgICAgICB9ZWxzZWlmKCRpc19jd2lwID09IDEpewogICAgICAgICAgICAgICAgJHVybCA9IHVybCgncG1zL2N3aXAvc3ViLWNhdGVnb3J5JykuJz9jd2lwJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT51cmxSZWRpcmVjdEJhY2soJ1N1YiBDYXRlZ29yeSB1cGRhdGVkIHN1Y2Nlc3NmdWxseScsICR1cmwsICdzdWNjZXNzJyk7CiAgICAgICAgICAgIAogICAgICAgIH1jYXRjaCAoXFRocm93YWJsZSAkdGgpewogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIERpc3BsYXkgdGhlIHNwZWNpZmllZCByZXNvdXJjZS4KICAgICAqCiAgICAgKiBAcGFyYW0gIGludCAgJGlkCiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwogICAgcHVibGljIGZ1bmN0aW9uIHNob3coJGNhdGVnb3J5X2lkKQogICAgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgICRjYXRlZ29yeSA9IENhdGVnb3J5OjpmaW5kT3JGYWlsKCRjYXRlZ29yeV9pZCk7CiAgICAgICAgICAgICRjYXRlZ29yeS0+c3JjID0gcm91dGUoJ3Btcy5wcm9kdWN0LW1hbmFnZW1lbnQuc3ViLWNhdGVnb3J5LnVwZGF0ZScsICRjYXRlZ29yeS0+aWQpOwogICAgICAgICAgICAkY2F0ZWdvcnktPnJlcV90eXBlID0gJ3B1dCc7CiAgICAgICAgICAgICRjYXRlZ29yeS0+cGFyZW50X2lkID0gISRjYXRlZ29yeS0+Y2F0ZWdvcnk/bnVsbDokY2F0ZWdvcnktPmNhdGVnb3J5OwoKICAgICAgICAgICAgJGFycmF5PVtdOwogICAgICAgICAgICBmb3JlYWNoKCRjYXRlZ29yeS0+ZGVwYXJ0bWVudHNMaXN0IGFzICRrZXkgPT4gJGRlcGFydG1lbnQpewogICAgICAgICAgICAgICAgYXJyYXlfcHVzaCgkYXJyYXksJGRlcGFydG1lbnQtPmhyX2RlcGFydG1lbnRfaWQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAkbmV3X2FycmF5PVtdOwoKICAgICAgICAgICAgZm9yZWFjaChEZXBhcnRtZW50Ojp3aGVyZUluKCdocl9kZXBhcnRtZW50X2lkJywkYXJyYXkpLT5zZWxlY3QoJ2hyX2RlcGFydG1lbnRfaWQnKS0+Z2V0KCkgYXMgJHZhbHVlcyl7CiAgICAgICAgICAgICAgICBhcnJheV9wdXNoKCRuZXdfYXJyYXksICR2YWx1ZXMtPmhyX2RlcGFydG1lbnRfaWQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAkZGF0YSA9IFsKICAgICAgICAgICAgICAgICdzdGF0dXMnID0+ICdzdWNjZXNzJywKICAgICAgICAgICAgICAgICdjYXRlZ29yeScgPT4gJGNhdGVnb3J5LAogICAgICAgICAgICAgICAgJ2RlcGFydG1lbnRzJyA9PiBEZXBhcnRtZW50OjphbGwoKSwKICAgICAgICAgICAgICAgICdkZXBhcnRtZW50c0lkJz0+RGVwYXJ0bWVudDo6d2hlcmVJbignaHJfZGVwYXJ0bWVudF9pZCcsJGFycmF5KS0+cGx1Y2soJ2hyX2RlcGFydG1lbnRfaWQnKS0+YWxsKCksCiAgICAgICAgICAgICAgICAnaW52ZW50b3J5X2FjY291bnRfaWQnID0+IGNoYXJ0T2ZBY2NvdW50c09wdGlvbnMoW10sICRjYXRlZ29yeS0+aW52ZW50b3J5X2FjY291bnRfaWQpLAogICAgICAgICAgICAgICAgJ2NvZ3NfYWNjb3VudF9pZCcgPT4gY2hhcnRPZkFjY291bnRzT3B0aW9ucyhbXSwgJGNhdGVnb3J5LT5jb2dzX2FjY291bnRfaWQpLAogICAgICAgICAgICAgICAgJ2ludmVudG9yeV9hZGp1c3RtZW50c19hY2NvdW50X2lkJyA9PiBjaGFydE9mQWNjb3VudHNPcHRpb25zKFtdLCAkY2F0ZWdvcnktPmludmVudG9yeV9hZGp1c3RtZW50c19hY2NvdW50X2lkKSwKICAgICAgICAgICAgXTsKCiAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKCRkYXRhKTsKICAgICAgICB9Y2F0Y2ggKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgJGRhdGEgPSBbCiAgICAgICAgICAgICAgICAnc3RhdHVzJyA9PiBudWxsLAogICAgICAgICAgICAgICAgJ2luZm8nID0+ICR0aC0+Z2V0TWVzc2FnZSgpCiAgICAgICAgICAgIF07CiAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKCRkYXRhKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBTaG93IHRoZSBmb3JtIGZvciBlZGl0aW5nIHRoZSBzcGVjaWZpZWQgcmVzb3VyY2UuCiAgICAgKgogICAgICogQHBhcmFtICBpbnQgICRpZAogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KICAgIHB1YmxpYyBmdW5jdGlvbiBlZGl0KCRpZCkKICAgIHsKICAgICAgICB0cnkgewogICAgICAgICAgICAkY2F0ZWdvcnkgPSBDYXRlZ29yeTo6ZmluZE9yRmFpbCgkaWQpOwogICAgICAgICAgICAkZGF0YSA9IFsKICAgICAgICAgICAgICAgICd0aXRsZScgPT4gJ0VkaXQgU3ViLUNhdGVnb3J5JywKICAgICAgICAgICAgICAgICdjYXRlZ29yeScgPT4gJGNhdGVnb3J5LAogICAgICAgICAgICAgICAgJ2NhdGVnb3JpZXMnID0+IENhdGVnb3J5Ojpkb2VzbnRIYXZlKCdjYXRlZ29yeScpCiAgICAgICAgICAgICAgICAtPndpdGgoWwogICAgICAgICAgICAgICAgICAgICdkZXBhcnRtZW50c0xpc3QnLCAnY2F0ZWdvcnknCiAgICAgICAgICAgICAgICBdKQogICAgICAgICAgICAgICAgLT53aGVyZUhhcygnZGVwYXJ0bWVudHNMaXN0LmRlcGFydG1lbnQudW5pdCcsIGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVJbignY29tcGFueV9pZCcsIGF1dGgoKS0+dXNlcigpLT5jb21wYW5pZXMtPnBsdWNrKCdjb21wYW55X2lkJyktPnRvQXJyYXkoKSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5vcmRlcmJ5KCdjb2RlJywgJ2FzYycpCiAgICAgICAgICAgICAgICAtPmdldCgpLAogICAgICAgICAgICAgICAgJ2RlcGFydG1lbnRzJyA9PiBEZXBhcnRtZW50OjphbGwoKSwKICAgICAgICAgICAgICAgICdkZXBhcnRtZW50c0lkJyA9PiAkY2F0ZWdvcnktPmRlcGFydG1lbnRzTGlzdC0+cGx1Y2soJ2hyX2RlcGFydG1lbnRfaWQnKS0+dG9BcnJheSgpLAogICAgICAgICAgICAgICAgJ2NoYXJ0T2ZBY2NvdW50c09wdGlvbnMnID0+IGNoYXJ0T2ZBY2NvdW50c09wdGlvbnMoW10sIDAsIDAsIFtdKSwKICAgICAgICAgICAgXTsKCiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5zdWItY2F0ZWdvcnkuZWRpdCcsICRkYXRhKTsKICAgICAgICB9Y2F0Y2ggKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBVcGRhdGUgdGhlIHNwZWNpZmllZCByZXNvdXJjZSBpbiBzdG9yYWdlLgogICAgICoKICAgICAqIEBwYXJhbSAgXElsbHVtaW5hdGVcSHR0cFxSZXF1ZXN0ICAkcmVxdWVzdAogICAgICogQHBhcmFtICBpbnQgICRpZAogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KICAgIHB1YmxpYyBmdW5jdGlvbiB1cGRhdGUoUmVxdWVzdCAkcmVxdWVzdCwgJGNhdGVnb3J5X2lkKQogICAgewogICAgICAgICRjYXRlZ29yeSA9IENhdGVnb3J5OjpmaW5kT3JGYWlsKCRjYXRlZ29yeV9pZCk7CgogICAgICAgICR0aGlzLT52YWxpZGF0ZSgkcmVxdWVzdCwgWwogICAgICAgICAgICAnY29kZScgPT4gWydyZXF1aXJlZCcsICdzdHJpbmcnLCAnbWF4OjI1NScsIFJ1bGU6OnVuaXF1ZSgnY2F0ZWdvcmllcycpLT5pZ25vcmUoJGNhdGVnb3J5LT5pZCldLAogICAgICAgICAgICAnbmFtZScgPT4gWydyZXF1aXJlZCcsICdzdHJpbmcnLCAnbWF4OjI1NSddLAogICAgICAgICAgICAncGFyZW50X2lkJyA9PiBbJ251bGxhYmxlJywgJ2ludGVnZXInXSwKICAgICAgICBdKTsKICAgICAgICB0cnkgewogICAgICAgICAgICAkZGVwYXJ0bWVudHMgPSBDYXRlZ29yeURlcGFydG1lbnQ6OndoZXJlKCdjYXRlZ29yeV9pZCcsICRjYXRlZ29yeS0+cGFyZW50X2lkKS0+cGx1Y2soJ2hyX2RlcGFydG1lbnRfaWQnKS0+dG9BcnJheSgpOwoKICAgICAgICAgICAgJGlucHV0cyA9ICRyZXF1ZXN0LT5hbGwoKTsKICAgICAgICAgICAgdW5zZXQoJGlucHV0c1snX3Rva2VuJ10pOwogICAgICAgICAgICB1bnNldCgkaW5wdXRzWydfbWV0aG9kJ10pOwoKICAgICAgICAgICAgJGlzX2ZpeGVkX2Fzc2V0ID0gMDsKICAgICAgICAgICAgJGlzX2N3aXAgPSAwOwogICAgICAgICAgICBpZigkcmVxdWVzdC0+cHJvZHVjdF90eXBlID09ICdmaXhlZF9hc3NldCcpewogICAgICAgICAgICAgICAgJGlzX2ZpeGVkX2Fzc2V0ID0gMTsKICAgICAgICAgICAgICAgICRpc19jd2lwID0gMDsKICAgICAgICAgICAgfWVsc2VpZigkcmVxdWVzdC0+cHJvZHVjdF90eXBlID09ICdjd2lwJyl7CiAgICAgICAgICAgICAgICAkaXNfZml4ZWRfYXNzZXQgPSAwOwogICAgICAgICAgICAgICAgJGlzX2N3aXAgPSAxOwogICAgICAgICAgICB9CgogICAgICAgICAgICAkY2F0ZWdvcnktPmZpbGwoJHJlcXVlc3QtPmFsbCgpKTsKICAgICAgICAgICAgJGNhdGVnb3J5LT5pc19maXhlZF9hc3NldCA9ICRpc19maXhlZF9hc3NldDsKICAgICAgICAgICAgJGNhdGVnb3J5LT5pc19jd2lwID0gJGlzX2N3aXA7CiAgICAgICAgICAgICRjYXRlZ29yeS0+c2F2ZSgpOwoKICAgICAgICAgICAgJGNhdGVnb3J5LT5kZXBhcnRtZW50KCktPnN5bmMoJGRlcGFydG1lbnRzKTsKCiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+dXJsUmVkaXJlY3RCYWNrKCdTdWIgQ2F0ZWdvcnkgdXBkYXRlZCBzdWNjZXNzZnVsbHknLCB1cmwoJ3Btcy9wcm9kdWN0LW1hbmFnZW1lbnQvc3ViLWNhdGVnb3J5JyksICdzdWNjZXNzJyk7CgogICAgICAgIH1jYXRjaCAoXFRocm93YWJsZSAkdGgpewogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJlbW92ZSB0aGUgc3BlY2lmaWVkIHJlc291cmNlIGZyb20gc3RvcmFnZS4KICAgICAqCiAgICAgKiBAcGFyYW0gIGludCAgJGlkCiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwogICAgcHVibGljIGZ1bmN0aW9uIGRlc3Ryb3koJGNhdGVnb3J5X2lkKQogICAgewogICAgICAgIHRyeSB7CgogICAgICAgICAgICAkY2F0ZWdvcnkgPSBDYXRlZ29yeTo6ZmluZE9yRmFpbCgkY2F0ZWdvcnlfaWQpOwoKICAgICAgICAgICAgaWYgKCRjYXRlZ29yeS0+cHJvZHVjdHMtPmNvdW50KCkgPiAwIHx8ICRjYXRlZ29yeS0+c3ViQ2F0ZWdvcnktPmNvdW50KCkgPiAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnID0+IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAnU3ViQ2F0ZWdvcnkgY2FuIG5vdCBiZSBkZWxldGVkLicKICAgICAgICAgICAgICAgIF0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAkY2F0ZWdvcnktPnN1YkNhdGVnb3J5LT5lYWNoLT5kZWxldGUoKTsKICAgICAgICAgICAgQ2F0ZWdvcnlEZXBhcnRtZW50Ojp3aGVyZSgnY2F0ZWdvcnlfaWQnLCAkY2F0ZWdvcnktPmlkKS0+ZGVsZXRlKCk7CiAgICAgICAgICAgICRjYXRlZ29yeS0+ZGVsZXRlKCk7CiAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiB0cnVlLAogICAgICAgICAgICAgICAgJ21lc3NhZ2UnID0+ICdTdWJDYXRlZ29yeSBTdWNjZXNzZnVsbHkgRGVsZXRlZC4nCiAgICAgICAgICAgIF0pOwoKICAgICAgICB9Y2F0Y2ggKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnID0+IGZhbHNlLAogICAgICAgICAgICAgICAgJ21lc3NhZ2UnID0+ICR0aC0+Z2V0TWVzc2FnZSgpCiAgICAgICAgICAgIF0pOwogICAgICAgIH0KICAgIH0KCgogICAgcHVibGljIGZ1bmN0aW9uIGltcG9ydENhdGVnb3J5KFJlcXVlc3QgJHJlcXVlc3QpewoKICAgICAgICAkdGhpcy0+dmFsaWRhdGUoJHJlcXVlc3QsIFsKICAgICAgICAgICAgJ2NhdGVnb3J5X2ZpbGUnID0+ICdyZXF1aXJlZHxtaW1lczp4bHMseGxzeCcKICAgICAgICBdKTsKCiAgICAgICAgJHBhdGggPSAkcmVxdWVzdC0+ZmlsZSgnY2F0ZWdvcnlfZmlsZScpLT5nZXRSZWFsUGF0aCgpOwoKICAgICAgICB0cnkgewogICAgICAgICAgICBFeGNlbDo6aW1wb3J0KG5ldyBDYXRlZ29yeUltcG9ydCgpLCAkcGF0aCk7CgogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoU3VjY2VzcygnQ2F0ZWdvcnkgRGF0YSBJbXBvcnRlZCBzdWNjZXNzZnVsbHkuJyk7CgogICAgICAgIH1jYXRjaCAoXE1hYXR3ZWJzaXRlXEV4Y2VsXFZhbGlkYXRvcnNcVmFsaWRhdGlvbkV4Y2VwdGlvbiAkZSkgewoKICAgICAgICAgICAgJGVycm9yTWVzc2FnZT0nJzsKICAgICAgICAgICAgJHJvd051bWJlcj0xOwogICAgICAgICAgICAkcm93TnVtYmVyKz0kZS0+ZmFpbHVyZXMoKVswXS0+cm93KCk7CiAgICAgICAgICAgICRjb2x1bW49JGUtPmZhaWx1cmVzKClbMF0tPmF0dHJpYnV0ZSgpOwoKICAgICAgICAgICAgJGVycm9yTWVzc2FnZS49JGUtPmZhaWx1cmVzKClbMF0tPmVycm9ycygpWzBdLicgZm9yIHJvdyAnLiRyb3dOdW1iZXIuJyBvbiBDb2x1bW4gJy4kY29sdW1uOwoKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCRlcnJvck1lc3NhZ2UpOwogICAgICAgIH0KICAgIH0KfQo=