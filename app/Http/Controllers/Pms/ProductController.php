<?php
bolt_decrypt( __FILE__ , 'CZFWbd'); return 0;
##!!!##CgpuYW1lc3BhY2UgQXBwXEh0dHBcQ29udHJvbGxlcnNcUG1zOwoKdXNlIEFwcFxIdHRwXENvbnRyb2xsZXJzXENvbnRyb2xsZXI7CnVzZSBBcHBcTW9kZWxzXEhyXFVuaXQ7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xCcmFuZDsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXENhdGVnb3J5Owp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcQ2F0ZWdvcnlBdHRyaWJ1dGU7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xDYXRlZ29yeURlcGFydG1lbnQ7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xJbnZlbnRvcnlNb2RlbHNcSW52ZW50b3J5U3VtbWFyeTsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFByb2R1Y3Q7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xTdXBwbGllcnM7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xQcm9kdWN0VW5pdDsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXEF0dHJpYnV0ZTsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFByb2R1Y3RBdHRyaWJ1dGU7CnVzZSBBcHBcTW9kZWxzXEZpeGVkQXNzZXRzXERlcHJlY2lhdGlvbk1ldGhvZDsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFN0YW5kYXJkQ29zdDsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFByb2R1Y3RTdGFuZGFyZENvc3Q7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xQcm9kdWN0VW5pdENvbnZlcnNpb247CnVzZSBJbGx1bWluYXRlXEh0dHBcUmVxdWVzdDsKdXNlIEFwcFxJbXBvcnRzXFByb2R1Y3RJbXBvcnQ7CnVzZSBNYWF0d2Vic2l0ZVxFeGNlbFxGYWNhZGVzXEV4Y2VsOwp1c2UgREIsIERhdGFUYWJsZXM7CgpjbGFzcyBQcm9kdWN0Q29udHJvbGxlciBleHRlbmRzIENvbnRyb2xsZXIKeyAgIAoKICAgIHB1YmxpYyBmdW5jdGlvbiBoZWFkZXJDb2x1bW5zKCR2YWx1ZT0nJykKICAgIHsKICAgICAgICAkcm93cyA9ICBhcnJheSgKICAgICAgICAgICAgWydTTCcsICdTTCddLAogICAgICAgICAgICBbJ3Byb2R1Y3RfdHlwZScsICdwcm9kdWN0X3R5cGUnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWyd1bml0cycsICd1bml0cyddLAogICAgICAgICAgICBbJ2NhdGVnb3J5X2NvZGUnLCAnY2F0ZWdvcnlfY29kZScsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ2NhdGVnb3J5JywgJ2NhdGVnb3J5JywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsnc3ViX2NhdGVnb3J5X2NvZGUnLCAnc3ViX2NhdGVnb3J5X2NvZGUnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydzdWJfY2F0ZWdvcnknLCAnc3ViX2NhdGVnb3J5JywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsnY29kZScsICdjb2RlJywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsnbmFtZScsICduYW1lJywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsnYXR0cmlidXRlcycsICdhdHRyaWJ1dGVzJywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsncHJvZHVjdF91bml0JywgJ3Byb2R1Y3RfdW5pdCcsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3VuaXRfcHJpY2UnLCAndW5pdF9wcmljZScsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3NhbGVzX3ByaWNlJywgJ3NhbGVzX3ByaWNlJywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsnYWRkZWRfYnknLCAnYWRkZWRfYnknLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydmaW5hbF9hc3NldCcsICdmaW5hbF9hc3NldCcsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3NlcnZpY2UnLCAnc2VydmljZScsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICAvLyBbJ3NhbGVfaXRlbScsICdzYWxlX2l0ZW0nLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydzdGF0dXMnLCAnc3RhdHVzJywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsnYWN0aW9ucycsICdhY3Rpb25zJywgJ3RleHQtY2VudGVyJ10KICAgICAgICApOwoKICAgICAgICByZXR1cm4gJHJvd3M7CiAgICB9CiAgICAKICAgIC8qKgogICAgICogRGlzcGxheSBhIGxpc3Rpbmcgb2YgdGhlIHJlc291cmNlLgogICAgICoKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCiAgICBwdWJsaWMgZnVuY3Rpb24gaW5kZXgoKQogICAgewogICAgICAgIHRyeSB7CgogICAgICAgICAgICAkdGl0bGUgPSAocmVxdWVzdCgpLT5oYXMoJ2ZpeGVkLWFzc2V0cycpID8gJ0ZpeGVkIEFzc2V0cycgOiAocmVxdWVzdCgpLT5oYXMoJ2N3aXAnKSA/ICdDV0lQJyA6ICdQcm9kdWN0cycpKTsKICAgICAgICAgICAgJHByb2R1Y3RzID0gUHJvZHVjdDo6d2l0aChbCiAgICAgICAgICAgICAgICAncHJvZHVjdFVuaXQnLCAnY2F0ZWdvcnkuY2F0ZWdvcnknLCAnYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24uYXR0cmlidXRlJywgJ2NyZWF0b3InLCAnbWFpbkFzc2V0LmF0dHJpYnV0ZXMuYXR0cmlidXRlT3B0aW9uLmF0dHJpYnV0ZScsICdzdWJBc3NldHMuYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24uYXR0cmlidXRlJywgJ3JlcXVpc2l0aW9uSXRlbScKICAgICAgICAgICAgXSkKICAgICAgICAgICAgLT5oYXMoJ2NhdGVnb3J5JykKICAgICAgICAgICAgLT53aGVuKCFkYXRhdGFibGVPcmRlcmluZygpLCBmdW5jdGlvbigkcXVlcnkpewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+b3JkZXJieSgnc2t1JywgJ2Rlc2MnKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAkb3B0aW9ucyA9IFsKICAgICAgICAgICAgICAgICdQdXJjaGFzZS1EZXBhcnRtZW50JyA9PiBhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnUHVyY2hhc2UtRGVwYXJ0bWVudCcpLAogICAgICAgICAgICAgICAgJ3Byb2R1Y3QtZWRpdCcgPT4gYXV0aCgpLT51c2VyKCktPmhhc1Blcm1pc3Npb25UbygncHJvZHVjdC1lZGl0JyksCiAgICAgICAgICAgICAgICAncHJvZHVjdC1kZWxldGUnID0+IGF1dGgoKS0+dXNlcigpLT5oYXNQZXJtaXNzaW9uVG8oJ3Byb2R1Y3QtZGVsZXRlJyksCiAgICAgICAgICAgICAgICAncHJvZHVjdC1zdGFuZGFyZC1jb3N0cycgPT4gZmFsc2UsCiAgICAgICAgICAgICAgICAvLyAncHJvZHVjdC1zdGFuZGFyZC1jb3N0cycgPT4gYXV0aCgpLT51c2VyKCktPmhhc1Blcm1pc3Npb25UbygncHJvZHVjdC1zdGFuZGFyZC1jb3N0cycpLAogICAgICAgICAgICBdOwogICAgICAgICAgICAkdW5pdHMgPSBVbml0OjphbGwoKTsKICAgICAgICAgICAgaWYgKHJlcXVlc3QoKS0+YWpheCgpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gRGF0YXRhYmxlczo6b2YoJHByb2R1Y3RzKQogICAgICAgICAgICAgICAgICAgIC0+YWRkSW5kZXhDb2x1bW4oKQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdwcm9kdWN0X3R5cGUnLCBmdW5jdGlvbiAoJHByb2R1Y3QpewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHByb2R1Y3QtPmlzX2ZpeGVkX2Fzc2V0ID09IDEgPyAnRml4ZWQgQXNzZXQnIDogKCRwcm9kdWN0LT5pc19jd2lwID09IDEgPyAnQ1dJUCcgOiAnUHJvZHVjdHMnKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCd1bml0cycsIGZ1bmN0aW9uKCRwcm9kdWN0KSB1c2UoJHVuaXRzKXsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICR1bml0cy0+d2hlcmVJbignaHJfdW5pdF9pZCcsICRwcm9kdWN0LT5jYXRlZ29yeS0+Y2F0ZWdvcnktPmRlcGFydG1lbnRzTGlzdC0+cGx1Y2soJ2RlcGFydG1lbnQuaHJfdW5pdF9pZCcpLT50b0FycmF5KCkpLT5wbHVjaygnaHJfdW5pdF9zaG9ydF9uYW1lJyktPmltcGxvZGUoJywgJyk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbigndW5pdHMnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygnY2F0ZWdvcnkuY2F0ZWdvcnkuZGVwYXJ0bWVudHNMaXN0LmRlcGFydG1lbnQudW5pdCcsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnaHJfdW5pdF9zaG9ydF9uYW1lJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCd1bml0cycsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBDYXRlZ29yeURlcGFydG1lbnQ6OnNlbGVjdCgnaHJfdW5pdC5ocl91bml0X3Nob3J0X25hbWUnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdocl91bml0JywgJ2hyX3VuaXQuaHJfdW5pdF9pZCcsICc9JywgJ2NhdGVnb3JpZXNfZGVwYXJ0bW5ldC5ocl91bml0X2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbignaHJfZGVwYXJ0bWVudCcsICdocl9kZXBhcnRtZW50LmhyX2RlcGFydG1lbnRfaWQnLCAnPScsICdjYXRlZ29yaWVzX2RlcGFydG1uZXQuaHJfZGVwYXJ0bWVudF9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCdjYXRlZ29yaWVzX2RlcGFydG1lbnQuY2F0ZWdvcnlfaWQnLCAncHJvZHVjdHMuY2F0ZWdvcnlfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT50YWtlKDEpCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignY2F0ZWdvcnlfY29kZScsIGZ1bmN0aW9uKCRwcm9kdWN0KXsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzc2V0KCRwcm9kdWN0LT5jYXRlZ29yeS0+Y2F0ZWdvcnktPmNvZGUpID8gJHByb2R1Y3QtPmNhdGVnb3J5LT5jYXRlZ29yeS0+Y29kZSA6ICcnOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ2NhdGVnb3J5X2NvZGUnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygnY2F0ZWdvcnkuY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ2NvZGUnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ2NhdGVnb3J5X2NvZGUnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgQ2F0ZWdvcnk6OnNlbGVjdCgnbWFpbl9jYXRlZ29yeS5jb2RlJykKICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdjYXRlZ29yaWVzIGFzIG1haW5fY2F0ZWdvcnknLCAnbWFpbl9jYXRlZ29yeS5pZCcsICc9JywgJ2NhdGVnb3JpZXMucGFyZW50X2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbignY2F0ZWdvcmllcy5pZCcsICdwcm9kdWN0cy5jYXRlZ29yeV9pZCcpKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdjYXRlZ29yeScsIGZ1bmN0aW9uKCRwcm9kdWN0KXsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzc2V0KCRwcm9kdWN0LT5jYXRlZ29yeS0+Y2F0ZWdvcnktPm5hbWUpID8gJHByb2R1Y3QtPmNhdGVnb3J5LT5jYXRlZ29yeS0+bmFtZSA6ICcnOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ2NhdGVnb3J5JywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ2NhdGVnb3J5LmNhdGVnb3J5JywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdjYXRlZ29yeScsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBDYXRlZ29yeTo6c2VsZWN0KCdtYWluX2NhdGVnb3J5Lm5hbWUnKQogICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ2NhdGVnb3JpZXMgYXMgbWFpbl9jYXRlZ29yeScsICdtYWluX2NhdGVnb3J5LmlkJywgJz0nLCAnY2F0ZWdvcmllcy5wYXJlbnRfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCdjYXRlZ29yaWVzLmlkJywgJ3Byb2R1Y3RzLmNhdGVnb3J5X2lkJykpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3N1Yl9jYXRlZ29yeV9jb2RlJywgZnVuY3Rpb24oJHByb2R1Y3QpewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNzZXQoJHByb2R1Y3QtPmNhdGVnb3J5LT5jb2RlKSA/ICRwcm9kdWN0LT5jYXRlZ29yeS0+Y29kZSA6ICcnOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3N1Yl9jYXRlZ29yeV9jb2RlJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ2NhdGVnb3J5JywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdjb2RlJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdzdWJfY2F0ZWdvcnlfY29kZScsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBDYXRlZ29yeTo6c2VsZWN0KCdjb2RlJyktPndoZXJlQ29sdW1uKCdjYXRlZ29yaWVzLmlkJywgJ3Byb2R1Y3RzLmNhdGVnb3J5X2lkJykpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3N1Yl9jYXRlZ29yeScsIGZ1bmN0aW9uKCRwcm9kdWN0KXsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzc2V0KCRwcm9kdWN0LT5jYXRlZ29yeS0+bmFtZSkgPyAkcHJvZHVjdC0+Y2F0ZWdvcnktPm5hbWUgOiAnJzsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdzdWJfY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygnY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ3N1Yl9jYXRlZ29yeScsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBDYXRlZ29yeTo6c2VsZWN0KCduYW1lJyktPndoZXJlQ29sdW1uKCdjYXRlZ29yaWVzLmlkJywgJ3Byb2R1Y3RzLmNhdGVnb3J5X2lkJykpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2NvZGUnLCBmdW5jdGlvbigkcHJvZHVjdCl7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcHJvZHVjdC0+c2t1OwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ2NvZGUnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnc2t1JywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ2NvZGUnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+b3JkZXJieSgnc2t1JywgJG9yZGVyKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdhdHRyaWJ1dGVzJywgZnVuY3Rpb24oJHByb2R1Y3QpewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0UHJvZHVjdEF0dHJpYnV0ZXNGYXN0ZXIoJHByb2R1Y3QpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ2F0dHJpYnV0ZXMnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygnYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24nLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICAtPm9yV2hlcmVIYXMoJ2F0dHJpYnV0ZXMuYXR0cmlidXRlT3B0aW9uLmF0dHJpYnV0ZScsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbignYXR0cmlidXRlcycsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnkgPSBwbGVhc2VTb3J0TWUoJHF1ZXJ5LCAkb3JkZXIsIFByb2R1Y3RBdHRyaWJ1dGU6OnNlbGVjdCgnYXR0cmlidXRlcy5jb2RlJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbignYXR0cmlidXRlX29wdGlvbnMnLCAnYXR0cmlidXRlX29wdGlvbnMuaWQnLCAnPScsICdwcm9kdWN0X2F0dHJpYnV0ZXMuYXR0cmlidXRlX29wdGlvbl9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ2F0dHJpYnV0ZXMnLCAnYXR0cmlidXRlcy5pZCcsICc9JywgJ2F0dHJpYnV0ZV9vcHRpb25zLmF0dHJpYnV0ZV9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCdwcm9kdWN0X2F0dHJpYnV0ZXMucHJvZHVjdF9pZCcsICdwcm9kdWN0cy5pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICAgICAgKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeSA9IHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgUHJvZHVjdEF0dHJpYnV0ZTo6c2VsZWN0KCdhdHRyaWJ1dGVfb3B0aW9ucy5uYW1lJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbignYXR0cmlidXRlX29wdGlvbnMnLCAnYXR0cmlidXRlX29wdGlvbnMuaWQnLCAnPScsICdwcm9kdWN0X2F0dHJpYnV0ZXMuYXR0cmlidXRlX29wdGlvbl9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCdwcm9kdWN0X2F0dHJpYnV0ZXMucHJvZHVjdF9pZCcsICdwcm9kdWN0cy5pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICAgICAgKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbigncHJvZHVjdF91bml0JywgZnVuY3Rpb24oJHByb2R1Y3QpewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNzZXQoJHByb2R1Y3QtPnByb2R1Y3RVbml0LT51bml0X25hbWUpPyRwcm9kdWN0LT5wcm9kdWN0VW5pdC0+dW5pdF9uYW1lOicnOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3Byb2R1Y3RfdW5pdCcsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdwcm9kdWN0VW5pdCcsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgndW5pdF9uYW1lJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdwcm9kdWN0X3VuaXQnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgUHJvZHVjdFVuaXQ6OnNlbGVjdCgndW5pdF9uYW1lJyktPndoZXJlQ29sdW1uKCdwcm9kdWN0X3VuaXRzLmlkJywgJ3Byb2R1Y3RzLnByb2R1Y3RfdW5pdF9pZCcpKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZWRpdENvbHVtbigndW5pdF9wcmljZScsIGZ1bmN0aW9uKCRwcm9kdWN0KXsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHN5c3RlbU1vbmV5Rm9ybWF0KCRwcm9kdWN0LT51bml0X3ByaWNlKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdhZGRlZF9ieScsIGZ1bmN0aW9uKCRwcm9kdWN0KXsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzc2V0KCRwcm9kdWN0LT5jcmVhdG9yLT5uYW1lKSA/ICRwcm9kdWN0LT5jcmVhdG9yLT5uYW1lIDogJyc7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbignYWRkZWRfYnknLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygnY3JlYXRvcicsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbignYWRkZWRfYnknLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgVXNlcjo6c2VsZWN0KCduYW1lJyktPndoZXJlQ29sdW1uKCd1c2Vycy5pZCcsICdwcm9kdWN0cy5jcmVhdGVkX2J5JykpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ21haW5fYXNzZXQnLCBmdW5jdGlvbigkcHJvZHVjdCl7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHJlcXVlc3QoKS0+aGFzKCdjd2lwJykpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRwcm9kdWN0LT5tYWluQXNzZXQgPyAkcHJvZHVjdC0+bWFpbkFzc2V0LT5uYW1lLicgJy5nZXRQcm9kdWN0QXR0cmlidXRlc0Zhc3RlcigkcHJvZHVjdC0+bWFpbkFzc2V0KSA6ICcnOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnJzsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdtYWluX2Fzc2V0JywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ21haW5Bc3NldCcsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3N1Yl9hc3NldCcsIGZ1bmN0aW9uKCRwcm9kdWN0KXsKICAgICAgICAgICAgICAgICAgICAgICAgaWYocmVxdWVzdCgpLT5oYXMoJ2N3aXAnKSl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHByb2R1Y3QtPnN1YkFzc2V0cy0+cGx1Y2soJ25hbWUnKS0+aW1wbG9kZSgnLCAnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJyc7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbignc3ViX2Fzc2V0JywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3N1YkFzc2V0cycsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2ZpbmFsX2Fzc2V0JywgZnVuY3Rpb24oJHByb2R1Y3QpewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHByb2R1Y3QtPmlzX2ZpbmFsX2Fzc2V0ID09IDEgPyAgJzxhIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi1zdWNjZXNzIj5ZZXM8L2E+JyA6ICc8YSBjbGFzcz0iYnRuIGJ0bi14cyBidG4tZGFyayI+Tm88L2E+JzsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdzZXJ2aWNlJywgZnVuY3Rpb24gKCRwcm9kdWN0KXsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRwcm9kdWN0LT5pc19zZXJ2aWNlID09IDEgPyAnPGEgY2xhc3M9ImJ0biBidG4tc3VjY2VzcyBidG4teHMiPlllczwvYT4nIDogJzxhIGNsYXNzPSJidG4gYnRuLWRhcmsgYnRuLXhzIj5ObzwvYT4nOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLy8gLT5hZGRDb2x1bW4oJ3NhbGVfaXRlbScsIGZ1bmN0aW9uICgkcHJvZHVjdCl7CiAgICAgICAgICAgICAgICAgICAgLy8gICAgIHJldHVybiAkcHJvZHVjdC0+aXNfc2FsZV9pdGVtID09IDEgPyAnPGEgY2xhc3M9ImJ0biBidG4tc3VjY2VzcyBidG4teHMiPlllczwvYT4nIDogJzxhIGNsYXNzPSJidG4gYnRuLWRhcmsgYnRuLXhzIj5ObzwvYT4nOwogICAgICAgICAgICAgICAgICAgIC8vIH0pCiAgICAgICAgICAgICAgICAgICAgLT5lZGl0Q29sdW1uKCdzdGF0dXMnLCBmdW5jdGlvbigkcHJvZHVjdCkgdXNlKCRvcHRpb25zKXsKICAgICAgICAgICAgICAgICAgICAgICAgJHN0YXR1cyA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICBpZigkcHJvZHVjdC0+c3RhdHVzID09ICdwZW5kaW5nJyl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZigkb3B0aW9uc1snUHVyY2hhc2UtRGVwYXJ0bWVudCddKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc3RhdHVzIC49ICc8YSBjbGFzcz0iYnRuIGJ0bi14cyBidG4td2FybmluZyIgIG9uY2xpY2s9InRvZ2dsZVByb2R1Y3QoJCh0aGlzKSkiIGRhdGEtcHJvZHVjdC1pZD0iJy4kcHJvZHVjdC0+aWQuJyIgZGF0YS1zdGF0dXM9IicuICRwcm9kdWN0LT5zdGF0dXMgLiciIHN0eWxlPSJjdXJzb3I6IHBvaW50ZXIiPlBlbmRpbmc8L2E+JzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzdGF0dXMgLj0gJzxhIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi13YXJuaW5nIiAgZGF0YS1wcm9kdWN0LWlkPSInLiRwcm9kdWN0LT5pZC4nIiBkYXRhLXN0YXR1cz0iJy4gJHByb2R1Y3QtPnN0YXR1cyAuJyIgc3R5bGU9ImN1cnNvcjogcG9pbnRlciI+UGVuZGluZzwvYT4nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZWlmICgkcHJvZHVjdC0+c3RhdHVzID09ICdhcHByb3ZlZCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCRvcHRpb25zWydQdXJjaGFzZS1EZXBhcnRtZW50J10pewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzdGF0dXMgLj0gJzxhIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi1zdWNjZXNzIiAgb25jbGljaz0idG9nZ2xlUHJvZHVjdCgkKHRoaXMpKSIgZGF0YS1wcm9kdWN0LWlkPSInLiRwcm9kdWN0LT5pZC4nIiBkYXRhLXN0YXR1cz0iJy4gJHByb2R1Y3QtPnN0YXR1cyAuJyIgc3R5bGU9ImN1cnNvcjogcG9pbnRlciI+QXBwcm92ZWQ8L2E+JzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzdGF0dXMgLj0gJzxhIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi1zdWNjZXNzIiAgZGF0YS1wcm9kdWN0LWlkPSInLiRwcm9kdWN0LT5pZC4nIiBkYXRhLXN0YXR1cz0iJy4gJHByb2R1Y3QtPnN0YXR1cyAuJyIgc3R5bGU9ImN1cnNvcjogcG9pbnRlciI+QXBwcm92ZWQ8L2E+JzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRzdGF0dXM7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignYWN0aW9ucycsIGZ1bmN0aW9uKCRwcm9kdWN0KSB1c2UoJG9wdGlvbnMpewogICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICBpZighZnJlZXplUHJvZHVjdCgkcHJvZHVjdCkgfHwgYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ1N1cGVyIEFkbWluJykpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxhIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi1zdWNjZXNzIHJvdW5kZWQtY2lyY2xlIG1sLTIiIG9uY2xpY2s9InVuaXRDb252ZXJzaW9ucygkKHRoaXMpKSIgZGF0YS1wcm9kdWN0LWlkPSInLiRwcm9kdWN0LT5pZC4nIiB0aXRsZT0iVW5pdCBDb252ZXJzaW9ucyI+PGkgY2xhc3M9ImxhcyBsYS1wcm9qZWN0LWRpYWdyYW0iPjwvaT48L2E+JzsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnPGEgY2xhc3M9ImJ0biBidG4teHMgYnRuLWRhcmsgcm91bmRlZC1jaXJjbGUgbWwtMiIgb25jbGljaz0idXBkYXRlU3VwcGxpZXJzKCQodGhpcykpIiBkYXRhLXByb2R1Y3QtaWQ9IicuJHByb2R1Y3QtPmlkLiciIHRpdGxlPSJVcGRhdGUgU3VwcGxpZXJzIj48aSBjbGFzcz0ibGFzIGxhLXVzZXJzIj48L2k+PC9hPic7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHVybCA9IHJvdXRlKCdwbXMucHJvZHVjdC1tYW5hZ2VtZW50LnByb2R1Y3QuZWRpdCcsICRwcm9kdWN0LT5pZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihyZXF1ZXN0KCktPmhhcygnZml4ZWQtYXNzZXRzJykpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR1cmwgPSB1cmwoJ3Btcy9maXhlZC1hc3NldHMvcHJvZHVjdC9lZGl0LycuJHByb2R1Y3QtPmlkKS4nP2ZpeGVkLWFzc2V0cyc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZWlmKHJlcXVlc3QoKS0+aGFzKCdjd2lwJykpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR1cmwgPSB1cmwoJ3Btcy9jd2lwL3Byb2R1Y3QvJy4kcHJvZHVjdC0+aWQuJy9lZGl0JykuJz9jd2lwJzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZigkb3B0aW9uc1sncHJvZHVjdC1lZGl0J10pewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICc8YSBjbGFzcz0iYnRuIGJ0bi14cyBidG4taW5mbyByb3VuZGVkLWNpcmNsZSBtbC0yIiBocmVmPSInLiR1cmwuJyI+PGkgY2xhc3M9ImxhIGxhLWVkaXQiPjwvaT48L2E+JzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZigkb3B0aW9uc1sncHJvZHVjdC1kZWxldGUnXSAmJiAhZnJlZXplUHJvZHVjdCgkcHJvZHVjdCkpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICc8YSBjbGFzcz0iYnRuIGJ0bi14cyBidG4tZGFuZ2VyIG1sLTIiIG9uY2xpY2s9ImRlbGV0ZUZyb21DUlVEKCQodGhpcykpIiBkYXRhLXNyYz0iJy5yb3V0ZSgncG1zLnByb2R1Y3QtbWFuYWdlbWVudC5wcm9kdWN0LmRlc3Ryb3knLCAkcHJvZHVjdC0+aWQpLiciPjxpIGNsYXNzPSJsYSBsYS10cmFzaCI+PC9pPjwvYT4nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCRvcHRpb25zWydwcm9kdWN0LXN0YW5kYXJkLWNvc3RzJ10pewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICc8YSBjbGFzcz0iYnRuIGJ0bi14cyBidG4tc3VjY2VzcyBtbC0yIG10LTEiIGhyZWY9IicudXJsKCdwbXMvcHJvZHVjdC1tYW5hZ2VtZW50L3Byb2R1Y3QvJy4kcHJvZHVjdC0+aWQuJy9zdGFuZGFyZC1jb3N0cycpLiciPjxpIGNsYXNzPSJsYSBsYS10YXNrcyI+PC9pPjwvYT4nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGFjdGlvbnM7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPnJhd0NvbHVtbnMoWydzdGF0dXMnLCAnYWN0aW9ucycsICdmaW5hbF9hc3NldCcsICdzZXJ2aWNlJywgJ3NhbGVfaXRlbSddKQogICAgICAgICAgICAgICAgICAgIC0+bWFrZSh0cnVlKTsKICAgICAgICAgICAgfQoKCiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5wcm9kdWN0cy5pbmRleCcsIFsKICAgICAgICAgICAgICAgICd0aXRsZScgPT4kdGl0bGUsCiAgICAgICAgICAgICAgICAnaGVhZGVyQ29sdW1ucycgPT4gJHRoaXMtPmhlYWRlckNvbHVtbnMoKQogICAgICAgICAgICBdKTsKICAgICAgICB9Y2F0Y2ggKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgoKICAgIC8qKgogICAgICogU2hvdyB0aGUgZm9ybSBmb3IgY3JlYXRpbmcgYSBuZXcgcmVzb3VyY2UuCiAgICAgKgogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KICAgIHB1YmxpYyBmdW5jdGlvbiBjcmVhdGUoKQogICAgewogICAgICAgIGlmKHJlcXVlc3QoKS0+aGFzKCdnZXQtc3ViLWNhdGVnb3JpZXMnKSl7CiAgICAgICAgICAgIHJldHVybiBjYXRlZ29yeU9wdGlvbnMoW10sIHJlcXVlc3QoKS0+Z2V0KCdjaG9zZW4nKSwgMCwgcmVxdWVzdCgpLT5oYXMoJ2ZpeGVkX2Fzc2V0JyksIHJlcXVlc3QoKS0+aGFzKCdjd2lwJykpOwogICAgICAgIH0KCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgJHByZWZpeCA9IGRhdGUoJ3ltJywgc3RydG90aW1lKGRhdGUoJ1ktbS1kJykpKTsKICAgICAgICAgICAgJHNrdSA9IHVuaXF1ZUNvZGUoMTIsICRwcmVmaXgsICdwcm9kdWN0cycsICdpZCcpOwoKICAgICAgICAgICAgJGRhdGEgPSBbCiAgICAgICAgICAgICAgICAndGl0bGUnID0+ICdOZXcgUHJvZHVjdCcsCiAgICAgICAgICAgICAgICAnc3VwcGxpZXJzJyA9PiBTdXBwbGllcnM6OndoZXJlKCdzdGF0dXMnLCAnQWN0aXZlJyktPnBsdWNrKCduYW1lJywnaWQnKS0+YWxsKCksCiAgICAgICAgICAgICAgICAnYnJhbmRzJyA9PiBCcmFuZDo6cGx1Y2soJ25hbWUnLCdpZCcpLT5hbGwoKSwKICAgICAgICAgICAgICAgICd1bml0JyA9PiBQcm9kdWN0VW5pdDo6cGx1Y2soJ3VuaXRfbmFtZScsJ2lkJyktPmFsbCgpLAogICAgICAgICAgICAgICAgJ3NrdScgPT4gJHNrdSwKICAgICAgICAgICAgICAgICdhdHRyaWJ1dGVzJyA9PiBBdHRyaWJ1dGU6OndpdGgoJ29wdGlvbnMnKS0+Z2V0KCksCiAgICAgICAgICAgICAgICAnYWNjb3VudHMnID0+IGNoYXJ0T2ZBY2NvdW50c09wdGlvbnMoW10sIDAsIDAsIFtdKSwKICAgICAgICAgICAgICAgICdkZXByZWNpYXRpb25NZXRob2RzJyA9PiBjYWxsTW9kdWxlQXBpKCdmaW5hbmNlJywgJ2RlcHJlY2lhdGlvbi1tZXRob2RzJywgWwogICAgICAgICAgICAgICAgICAgICdzdGF0dXMnID0+IDEKICAgICAgICAgICAgICAgIF0pWydkYXRhJ10sCiAgICAgICAgICAgICAgICAnY2F0ZWdvcnlPcHRpb25zJyA9PiBjYXRlZ29yeU9wdGlvbnMoW10sIDAsIDAsIC0xLCAtMSkKICAgICAgICAgICAgXTsKCiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5wcm9kdWN0cy5jcmVhdGUnLCAkZGF0YSk7CiAgICAgICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogU3RvcmUgYSBuZXdseSBjcmVhdGVkIHJlc291cmNlIGluIHN0b3JhZ2UuCiAgICAgKgogICAgICogQHBhcmFtICBcSWxsdW1pbmF0ZVxIdHRwXFJlcXVlc3QgICRyZXF1ZXN0CiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwogICAgcHVibGljIGZ1bmN0aW9uIHN0b3JlKFJlcXVlc3QgJHJlcXVlc3QpCiAgICB7CiAgICAgICAgJHRoaXMtPnZhbGlkYXRlKCRyZXF1ZXN0LCBbCiAgICAgICAgICAgICduYW1lJyA9PiBbJ3JlcXVpcmVkJywgJ3N0cmluZycsICdtYXg6MjU1J10sCiAgICAgICAgICAgICdjYXRlZ29yeV9pZCcgPT4gWydyZXF1aXJlZCcsICdzdHJpbmcnLCAnbWF4OjI1NSddLAogICAgICAgICAgICAncHJvZHVjdF91bml0X2lkJyA9PiBbJ3JlcXVpcmVkJywgJ3N0cmluZycsICdtYXg6MjU1J10sCiAgICAgICAgICAgIC8vICd0YXgnID0+IFsncmVxdWlyZWQnLCAncmVnZXg6L15cZCooXC5cZHsxLDJ9KT8kLyddLAogICAgICAgICAgICAndmF0JyA9PiBbJ3JlcXVpcmVkJywgJ3JlZ2V4Oi9eXGQqKFwuXGR7MSwyfSk/JC8nXSwKICAgICAgICAgICAgJ3VuaXRfcHJpY2UnID0+IFsncmVxdWlyZWQnLCAncmVnZXg6L15cZCooXC5cZHsxLDJ9KT8kLyddLAogICAgICAgICAgICAvLyAnc2FsZXNfcHJpY2UnID0+IFsncmVxdWlyZWQnLCAncmVnZXg6L15cZCooXC5cZHsxLDJ9KT8kLyddLAogICAgICAgICAgICAnc2t1JyA9PiBbJ3JlcXVpcmVkJ10sCiAgICAgICAgICAgIC8vICdzdXBwbGllcicgPT4gWydyZXF1aXJlZCddLAogICAgICAgIF0pOwoKICAgICAgICBpZihhdXRoKCktPnVzZXIoKS0+aGFzUGVybWlzc2lvblRvKCdwcm9kdWN0LWZpbmFuY2UtaW5mb3JtYXRpb24nKSl7CiAgICAgICAgICAgICR0aGlzLT52YWxpZGF0ZSgkcmVxdWVzdCwgWwogICAgICAgICAgICAgICAgJ2ludmVudG9yeV9hY2NvdW50X2lkJyA9PiBbJ3JlcXVpcmVkJ10sCiAgICAgICAgICAgICAgICAnaW52ZW50b3J5X2FkanVzdG1lbnRzX2FjY291bnRfaWQnID0+IFsncmVxdWlyZWQnXSwKICAgICAgICAgICAgXSk7CiAgICAgICAgfQoKICAgICAgICBEQjo6YmVnaW5UcmFuc2FjdGlvbigpOwogICAgICAgIHRyeSB7CgogICAgICAgICAgICBpZihpc3NldCgkcmVxdWVzdC0+cGFyZW50X2lkKSAmJiAkcmVxdWVzdC0+cGFyZW50X2lkID4gMCl7CiAgICAgICAgICAgICAgICAkcGFyZW50ID0gUHJvZHVjdDo6ZmluZE9yRmFpbCgkcmVxdWVzdC0+cGFyZW50X2lkKTsKICAgICAgICAgICAgICAgIGlmKCRyZXF1ZXN0LT55ZWFycyA+ICRwYXJlbnQtPnllYXJzKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgJ21lc3NhZ2UnID0+ICJTdWIgQXNzZXRzIGxpZmUgZHVyYXRpb24gKCIuJHJlcXVlc3QtPnllYXJzLiIpIGNhbm5vdCBiZSBncmF0ZXIgdGhhbiBNYWluIEFzc2V0IGxpZmUgZHVyYXRpb24gKCIuJHBhcmVudC0+eWVhcnMuIikiLAogICAgICAgICAgICAgICAgICAgIF0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAkc3VwcGxpZXJzID0gaXNzZXQoJHJlcXVlc3QtPnN1cHBsaWVyKSA/ICRyZXF1ZXN0LT5zdXBwbGllciA6IFtdOwogICAgICAgICAgICAkYnVmZmVySW52ZW50b3J5ID0gJHJlcXVlc3QtPmJ1ZmZlcl9pbnZlbnRvcnk7CiAgICAgICAgICAgICRpbnB1dHMgPSAkcmVxdWVzdC0+YWxsKCk7CiAgICAgICAgICAgIHVuc2V0KCRpbnB1dHNbJ190b2tlbiddKTsKICAgICAgICAgICAgdW5zZXQoJGlucHV0c1snX21ldGhvZCddKTsKICAgICAgICAgICAgdW5zZXQoJGlucHV0c1snc3VwcGxpZXInXSk7CiAgICAgICAgICAgIHVuc2V0KCRpbnB1dHNbJ2J1ZmZlcl9pbnZlbnRvcnknXSk7CgogICAgICAgICAgICAkaW5wdXRzWydpc19maXhlZF9hc3NldCddID0gMDsKICAgICAgICAgICAgJGlucHV0c1snaXNfY3dpcCddID0gMDsKICAgICAgICAgICAgaWYoJHJlcXVlc3QtPnByb2R1Y3RfdHlwZSA9PSAnZml4ZWRfYXNzZXQnKXsKICAgICAgICAgICAgICAgICRpbnB1dHNbJ2lzX2ZpeGVkX2Fzc2V0J10gPSAxOwogICAgICAgICAgICAgICAgJGlucHV0c1snaXNfY3dpcCddID0gMDsKICAgICAgICAgICAgfWVsc2VpZigkcmVxdWVzdC0+cHJvZHVjdF90eXBlID09ICdjd2lwJyl7CiAgICAgICAgICAgICAgICAkaW5wdXRzWydpc19maXhlZF9hc3NldCddID0gMDsKICAgICAgICAgICAgICAgICRpbnB1dHNbJ2lzX2N3aXAnXSA9IDE7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICRwcm9kdWN0ID0gUHJvZHVjdDo6Y3JlYXRlKCRpbnB1dHMpOwogICAgICAgICAgICAvLyAkcHJvZHVjdC0+c3VwcGxpZXJzKCktPnN5bmMoaXNzZXQoJHN1cHBsaWVyc1swXSkgPyAkc3VwcGxpZXJzIDogW10pOwogICAgICAgICAgICBpZiAoJGJ1ZmZlckludmVudG9yeSl7CiAgICAgICAgICAgICAgICAkaW52ZW50b3J5U3VtbWFyeSA9IG5ldyBJbnZlbnRvcnlTdW1tYXJ5KCk7CiAgICAgICAgICAgICAgICAkaW52ZW50b3J5U3VtbWFyeS0+Y2F0ZWdvcnlfaWQgPSAkaW5wdXRzWydjYXRlZ29yeV9pZCddOwogICAgICAgICAgICAgICAgJGludmVudG9yeVN1bW1hcnktPnByb2R1Y3RfaWQgPSAkcHJvZHVjdC0+aWQ7CiAgICAgICAgICAgICAgICAkaW52ZW50b3J5U3VtbWFyeS0+YnVmZmVyX2ludmVudG9yeSA9ICRidWZmZXJJbnZlbnRvcnk7CiAgICAgICAgICAgICAgICAkaW52ZW50b3J5U3VtbWFyeS0+c2F2ZSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZihpc3NldCgkcmVxdWVzdC0+cHJvZHVjdEF0dHJpYnV0ZXNbMF0pKXsKICAgICAgICAgICAgICAgIGZvcmVhY2goJHJlcXVlc3QtPnByb2R1Y3RBdHRyaWJ1dGVzIGFzICRrZXkgPT4gJGF0dHJpYnV0ZV9pZCl7CiAgICAgICAgICAgICAgICAgICAgJHNlcmlhbF9ubyA9IENhdGVnb3J5QXR0cmlidXRlOjp3aGVyZShbCiAgICAgICAgICAgICAgICAgICAgICAgICdjYXRlZ29yeV9pZCcgPT4gJHJlcXVlc3QtPmNhdGVnb3J5X2lkLAogICAgICAgICAgICAgICAgICAgICAgICAnYXR0cmlidXRlX2lkJyA9PiAkYXR0cmlidXRlX2lkCiAgICAgICAgICAgICAgICAgICAgXSktPnN1bSgnc2VyaWFsJyk7CiAgICAgICAgICAgICAgICAgICAgaWYoaXNzZXQoJHJlcXVlc3QtPmF0dHJpYnV0ZV9vcHRpb25faWRbJGF0dHJpYnV0ZV9pZF0pICYmICRyZXF1ZXN0LT5hdHRyaWJ1dGVfb3B0aW9uX2lkWyRhdHRyaWJ1dGVfaWRdICE9IDApewogICAgICAgICAgICAgICAgICAgICAgICBQcm9kdWN0QXR0cmlidXRlOjpjcmVhdGUoWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3Byb2R1Y3RfaWQnID0+ICRwcm9kdWN0LT5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdhdHRyaWJ1dGVfb3B0aW9uX2lkJyA9PiAkcmVxdWVzdC0+YXR0cmlidXRlX29wdGlvbl9pZFskYXR0cmlidXRlX2lkXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdzZXJpYWxfbm8nID0+ICRzZXJpYWxfbm8sCiAgICAgICAgICAgICAgICAgICAgICAgIF0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgJHByb2R1Y3RBdHRyaWJ1dGVzID0gZ2V0UHJvZHVjdEF0dHJpYnV0ZXNGYXN0ZXIoJHByb2R1Y3QpOwoKICAgICAgICAgICAgJHByb2R1Y3RzID0gUHJvZHVjdDo6d2l0aChbCiAgICAgICAgICAgICAgICAnYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24uYXR0cmlidXRlJwogICAgICAgICAgICBdKQogICAgICAgICAgICAtPndoZXJlKFsKICAgICAgICAgICAgICAgIFsnaWQnLCAnIT0nLCAkcHJvZHVjdC0+aWRdLAogICAgICAgICAgICAgICAgWyduYW1lJywgJHByb2R1Y3QtPm5hbWVdLAogICAgICAgICAgICBdKQogICAgICAgICAgICAtPndoZXJlSGFzKCdhdHRyaWJ1dGVzJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgkcHJvZHVjdCkgewogICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZUluKCdhdHRyaWJ1dGVfb3B0aW9uX2lkJywgJHByb2R1Y3QtPmF0dHJpYnV0ZXMtPnBsdWNrKCdhdHRyaWJ1dGVfb3B0aW9uX2lkJyktPnRvQXJyYXkoKSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+Z2V0KCk7CiAgICAgICAgICAgICRjb3VudCA9IDA7CiAgICAgICAgICAgIGlmKGlzc2V0KCRwcm9kdWN0c1swXSkpewogICAgICAgICAgICAgICAgZm9yZWFjaCgkcHJvZHVjdHMgYXMgJGtleSA9PiAkdGhpc19wcm9kdWN0KXsKICAgICAgICAgICAgICAgICAgICBpZigkcHJvZHVjdEF0dHJpYnV0ZXMgPT0gZ2V0UHJvZHVjdEF0dHJpYnV0ZXNGYXN0ZXIoJHRoaXNfcHJvZHVjdCkpewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbWVzc2FnZScgPT4gJHRoaXNfcHJvZHVjdC0+bmFtZS4nICcuZ2V0UHJvZHVjdEF0dHJpYnV0ZXNGYXN0ZXIoJHRoaXNfcHJvZHVjdCkuJyBhbHJlYWR5IGV4aXN0cyEnLAogICAgICAgICAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICRtZXNzYWdlID0gJzxzcGFuIGNsYXNzPSJub3RpZmljYXRpb24tbGlua3MiIGRhdGEtc3JjPSInLnVybCgncG1zL3Byb2R1Y3QtbWFuYWdlbWVudC9wcm9kdWN0LycuJHByb2R1Y3QtPmlkLicvZGV0YWlscycpLiciIGRhdGEtdGl0bGU9IlByb2R1Y3QgRGV0YWlscyI+UHJvZHVjdCAnLiRwcm9kdWN0LT5uYW1lLicgJy4kcHJvZHVjdEF0dHJpYnV0ZXMuJyBpcyB3YWl0aW5nIGZvciBhcHByb3ZhbC48L3NwYW4+JzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBDcmVhdGVPclVwZGF0ZU5vdGlmaWNhdGlvbigkbWVzc2FnZSwndW5yZWFkJywnJyxnZXRNYW5hZ2VySW5mbygnUHVyY2hhc2UtRGVwYXJ0bWVudCcsIG51bGwsIHRydWUpLCdzZW5kLXRvLXB1cmNoYXNlLWRlcGFydG1lbnQnKTsKCgogICAgICAgICAgICAvLyB1cGRhdGVTdXBwbGllclByb2R1Y3RzKDEyKTsKICAgICAgICAgICAgREI6OmNvbW1pdCgpOwoKICAgICAgICAgICAgJHByZWZpeCA9IGRhdGUoJ3ltJywgc3RydG90aW1lKGRhdGUoJ1ktbS1kJykpKTsKICAgICAgICAgICAgJHNrdSA9IHVuaXF1ZUNvZGUoMTIsICRwcmVmaXgsICdwcm9kdWN0cycsICdpZCcpOwoKICAgICAgICAgICAgaWYoJHJlcXVlc3QtPndoZXJlX3RvX2dvID09ICdzYXZlJyl7CiAgICAgICAgICAgICAgICBzZXNzaW9uKCktPmZsYXNoKCdhbGVydC10eXBlJywgJ3N1Y2Nlc3MnKTsKICAgICAgICAgICAgICAgIHNlc3Npb24oKS0+Zmxhc2goJ21lc3NhZ2UnLCAiUHJvZHVjdCBoYXMgYmVlbiBhZGRlZCBzdWNjZXNzZnVsbHkiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnID0+IHRydWUsCiAgICAgICAgICAgICAgICAnbmV3JyA9PiAoJHJlcXVlc3QtPndoZXJlX3RvX2dvID09ICdzYXZlLWFuZC1uZXcnKSwKICAgICAgICAgICAgICAgICdza3UnID0+ICRza3UsCiAgICAgICAgICAgICAgICAnbWVzc2FnZScgPT4gIlByb2R1Y3QgaGFzIGJlZW4gYWRkZWQgc3VjY2Vzc2Z1bGx5IiwKICAgICAgICAgICAgXSk7CgogICAgICAgIH1jYXRjaCAoXFRocm93YWJsZSAkdGgpewogICAgICAgICAgICBEQjo6cm9sbGJhY2soKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnID0+IGZhbHNlLAogICAgICAgICAgICAgICAgJ21lc3NhZ2UnID0+ICR0aC0+Z2V0TWVzc2FnZSgpLAogICAgICAgICAgICBdKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBEaXNwbGF5IHRoZSBzcGVjaWZpZWQgcmVzb3VyY2UuCiAgICAgKgogICAgICogQHBhcmFtICBpbnQgICRpZAogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KICAgIHB1YmxpYyBmdW5jdGlvbiBzaG93KFByb2R1Y3QgJHByb2R1Y3QpCiAgICB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgJHByb2R1Y3QtPnNyYyA9IHJvdXRlKCdwbXMucHJvZHVjdC1tYW5hZ2VtZW50LnByb2R1Y3QudXBkYXRlJywkcHJvZHVjdC0+aWQpOwogICAgICAgICAgICAkcHJvZHVjdC0+cmVxX3R5cGUgPSAncHV0JzsKICAgICAgICAgICAgJHN1cHBsaWVycyA9IFtdOwogICAgICAgICAgICBmb3JlYWNoICgkcHJvZHVjdC0+c3VwcGxpZXJzIGFzICRzdXBwbGllcil7CiAgICAgICAgICAgICAgICAkc3VwcGxpZXJzW10gPSAkc3VwcGxpZXItPmlkOwogICAgICAgICAgICB9CgogICAgICAgICAgICAkcHJvZHVjdC0+c3VwcGxpZXIgPSAkc3VwcGxpZXJzOwogICAgICAgICAgICAkcHJvZHVjdC0+YnVmZmVyX2ludmVudG9yeSA9ICRwcm9kdWN0LT5yZWxJbnZlbnRvcnlTdW1tYXJ5PyRwcm9kdWN0LT5yZWxJbnZlbnRvcnlTdW1tYXJ5LT5idWZmZXJfaW52ZW50b3J5Om51bGw7CiAgICAgICAgICAgICRkYXRhID0gWwogICAgICAgICAgICAgICAgJ3N0YXR1cycgPT4gJ3N1Y2Nlc3MnLAogICAgICAgICAgICAgICAgJ2luZm8nID0+ICRwcm9kdWN0CiAgICAgICAgICAgIF07CgogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbigkZGF0YSk7CiAgICAgICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgICRkYXRhID0gWwogICAgICAgICAgICAgICAgJ3N0YXR1cycgPT4gbnVsbCwKICAgICAgICAgICAgICAgICdpbmZvJyA9PiAkdGgtPmdldE1lc3NhZ2UoKQogICAgICAgICAgICBdOwogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbigkZGF0YSk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogU2hvdyB0aGUgZm9ybSBmb3IgZWRpdGluZyB0aGUgc3BlY2lmaWVkIHJlc291cmNlLgogICAgICoKICAgICAqIEBwYXJhbSAgaW50ICAkaWQKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCiAgICBwdWJsaWMgZnVuY3Rpb24gZWRpdCgkaWQpCiAgICB7CiAgICAgICAgJHByb2R1Y3QgPSBQcm9kdWN0Ojp3aXRoKFsKICAgICAgICAgICAgJ2F0dHJpYnV0ZXMuYXR0cmlidXRlT3B0aW9uLmF0dHJpYnV0ZScsCiAgICAgICAgICAgICdzdXBwbGllcnMnCiAgICAgICAgXSktPmZpbmRPckZhaWwoJGlkKTsKICAgICAgICBpZihmcmVlemVQcm9kdWN0KCRwcm9kdWN0KSAmJiAhYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ1N1cGVyIEFkbWluJykpewogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoIlByb2R1Y3QgIyIuJHByb2R1Y3QtPm5hbWUuIiAiLmdldFByb2R1Y3RBdHRyaWJ1dGVzRmFzdGVyKCRwcm9kdWN0KS4iIENhbm5vdCBCZSBFZGl0ZWQhIik7CiAgICAgICAgfQoKICAgICAgICB0cnkgewogICAgICAgICAgICAkY2F0ZWdvcnlBdHRyaWJ1dGVzID0gQ2F0ZWdvcnlBdHRyaWJ1dGU6OndoZXJlKCdjYXRlZ29yeV9pZCcsICRwcm9kdWN0LT5jYXRlZ29yeV9pZCktPmdldCgpOwogICAgICAgICAgICAkYXR0cmlidXRlcyA9IFtdOwogICAgICAgICAgICAkYXR0cmlidXRlT3B0aW9ucyA9IFtdOwogICAgICAgICAgICBpZihpc3NldCgkY2F0ZWdvcnlBdHRyaWJ1dGVzWzBdKSl7CiAgICAgICAgICAgICAgICBmb3JlYWNoKCRjYXRlZ29yeUF0dHJpYnV0ZXMgYXMgJGtleSA9PiAkY2F0ZWdvcnlBdHRyaWJ1dGUpewogICAgICAgICAgICAgICAgICAgIGFycmF5X3B1c2goJGF0dHJpYnV0ZXMsICRjYXRlZ29yeUF0dHJpYnV0ZS0+YXR0cmlidXRlX2lkKTsKICAgICAgICAgICAgICAgICAgICAkYXR0cmlidXRlT3B0aW9ucyA9IGFycmF5X21lcmdlKCRhdHRyaWJ1dGVPcHRpb25zLCAoaXNfYXJyYXkoanNvbl9kZWNvZGUoJGNhdGVnb3J5QXR0cmlidXRlLT5vcHRpb25zLCB0cnVlKSkgPyBqc29uX2RlY29kZSgkY2F0ZWdvcnlBdHRyaWJ1dGUtPm9wdGlvbnMsIHRydWUpIDogW10pKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgJGRhdGEgPSBbCiAgICAgICAgICAgICAgICAndGl0bGUnID0+ICdFZGl0IFByb2R1Y3QnLAogICAgICAgICAgICAgICAgJ2NhdGVnb3JpZXMnID0+IENhdGVnb3J5OjphbGwoKSwKICAgICAgICAgICAgICAgICdzdXBwbGllcnMnID0+IFN1cHBsaWVyczo6d2hlcmUoJ3N0YXR1cycsICdBY3RpdmUnKS0+Z2V0KFsnaWQnLCAnbmFtZSddKSwKICAgICAgICAgICAgICAgICdicmFuZHMnID0+IEJyYW5kOjpwbHVjaygnbmFtZScsJ2lkJyktPmFsbCgpLAogICAgICAgICAgICAgICAgJ3VuaXQnID0+IFByb2R1Y3RVbml0OjpwbHVjaygndW5pdF9uYW1lJywnaWQnKS0+YWxsKCksCiAgICAgICAgICAgICAgICAnYXR0cmlidXRlcycgPT4gQXR0cmlidXRlOjp3aXRoKCdvcHRpb25zJyktPmdldCgpLAogICAgICAgICAgICAgICAgJ3Byb2R1Y3QnID0+ICRwcm9kdWN0LAogICAgICAgICAgICAgICAgJ3Byb2R1Y3RBdHRyaWJ1dGVzJyA9PiAkcHJvZHVjdC0+YXR0cmlidXRlcy0+cGx1Y2soJ2F0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGVfaWQnKS0+dG9BcnJheSgpLAogICAgICAgICAgICAgICAgJ2V4aXN0ZWRTdXBwbGllcnMnID0+ICRwcm9kdWN0LT5zdXBwbGllcnMtPnBsdWNrKCdwaXZvdC5zdXBwbGllcl9pZCcpLT50b0FycmF5KCksCiAgICAgICAgICAgICAgICAnY2F0ZWdvcnlPcHRpb25zJyA9PiBjYXRlZ29yeU9wdGlvbnMoW10sICRwcm9kdWN0LT5jYXRlZ29yeV9pZCwgMCwgLTEsIC0xKSwKICAgICAgICAgICAgICAgICdjYXRlZ29yeUF0dHJpYnV0ZXMnID0+ICRhdHRyaWJ1dGVzLAogICAgICAgICAgICAgICAgJ2NhdGVnb3J5QXR0cmlidXRlT3B0aW9ucycgPT4gJGF0dHJpYnV0ZU9wdGlvbnMsCgogICAgICAgICAgICAgICAgJ2NoYXJ0T2ZBY2NvdW50c09wdGlvbnMnID0+IGNoYXJ0T2ZBY2NvdW50c09wdGlvbnMoW10sIDAsIDAsIFtdKSwKICAgICAgICAgICAgICAgICdkZXByZWNpYXRpb25NZXRob2RzJyA9PiBjYWxsTW9kdWxlQXBpKCdmaW5hbmNlJywgJ2RlcHJlY2lhdGlvbi1tZXRob2RzJywgWwogICAgICAgICAgICAgICAgICAgICdzdGF0dXMnID0+IDEKICAgICAgICAgICAgICAgIF0pWydkYXRhJ10sCiAgICAgICAgICAgICAgICAnY2F0ZWdvcnlfdHlwZScgPT4gKCRwcm9kdWN0LT5jYXRlZ29yeS0+aXNfZml4ZWRfYXNzZXQgPT0gMSA/ICdmaXhlZF9hc3NldCcgOiAoJHByb2R1Y3QtPmNhdGVnb3J5LT5pc19jd2lwID09IDEgPyAnY3dpcCcgOiAncHJvZHVjdHMnKSksCiAgICAgICAgICAgICAgICAncHJvZHVjdF90eXBlJyA9PiAoJHByb2R1Y3QtPmlzX2ZpeGVkX2Fzc2V0ID09IDEgPyAnZml4ZWRfYXNzZXQnIDogKCRwcm9kdWN0LT5pc19jd2lwID09IDEgPyAnY3dpcCcgOiAncHJvZHVjdHMnKSksCiAgICAgICAgICAgIF07CiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMucHJvZHVjdHMuZWRpdCcsICRkYXRhKTsKICAgICAgICB9Y2F0Y2ggKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBVcGRhdGUgdGhlIHNwZWNpZmllZCByZXNvdXJjZSBpbiBzdG9yYWdlLgogICAgICoKICAgICAqIEBwYXJhbSAgXElsbHVtaW5hdGVcSHR0cFxSZXF1ZXN0ICAkcmVxdWVzdAogICAgICogQHBhcmFtICBpbnQgICRpZAogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KICAgIHB1YmxpYyBmdW5jdGlvbiB1cGRhdGUoUmVxdWVzdCAkcmVxdWVzdCwgUHJvZHVjdCAkcHJvZHVjdCkKICAgIHsKICAgICAgICBpZighYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ0VtcGxveWVlJykpewogICAgICAgICAgICAkdGhpcy0+dmFsaWRhdGUoJHJlcXVlc3QsIFsKICAgICAgICAgICAgICAgICdza3UnID0+IFsncmVxdWlyZWQnXSwKICAgICAgICAgICAgICAgICduYW1lJyA9PiBbJ3JlcXVpcmVkJywgJ3N0cmluZycsICdtYXg6MjU1J10sCiAgICAgICAgICAgICAgICAnY2F0ZWdvcnlfaWQnID0+IFsncmVxdWlyZWQnLCAnc3RyaW5nJywgJ21heDoyNTUnXSwKICAgICAgICAgICAgXSk7CiAgICAgICAgfQoKICAgICAgICAkdGhpcy0+dmFsaWRhdGUoJHJlcXVlc3QsIFsKICAgICAgICAgICAgJ3Byb2R1Y3RfdW5pdF9pZCcgPT4gWydyZXF1aXJlZCcsICdzdHJpbmcnLCAnbWF4OjI1NSddLAogICAgICAgICAgICAndW5pdF9wcmljZScgPT4gWydyZXF1aXJlZCcsICdyZWdleDovXlxkKihcLlxkezEsMn0pPyQvJ10sCiAgICAgICAgICAgIC8vICdzYWxlc19wcmljZScgPT4gWydyZXF1aXJlZCcsICdyZWdleDovXlxkKihcLlxkezEsMn0pPyQvJ10sCiAgICAgICAgICAgIC8vICd0YXgnID0+IFsncmVxdWlyZWQnLCAncmVnZXg6L15cZCooXC5cZHsxLDJ9KT8kLyddLAogICAgICAgICAgICAndmF0JyA9PiBbJ3JlcXVpcmVkJywgJ3JlZ2V4Oi9eXGQqKFwuXGR7MSwyfSk/JC8nXSwKICAgICAgICAgICAgLy8gJ3N1cHBsaWVyJyA9PiBbJ3JlcXVpcmVkJ10sCiAgICAgICAgXSk7CgogICAgICAgIGlmKGF1dGgoKS0+dXNlcigpLT5oYXNQZXJtaXNzaW9uVG8oJ3Byb2R1Y3QtZmluYW5jZS1pbmZvcm1hdGlvbicpKXsKICAgICAgICAgICAgJHRoaXMtPnZhbGlkYXRlKCRyZXF1ZXN0LCBbCiAgICAgICAgICAgICAgICAnaW52ZW50b3J5X2FjY291bnRfaWQnID0+IFsncmVxdWlyZWQnXSwKICAgICAgICAgICAgICAgIC8vICdjb2dzX2FjY291bnRfaWQnID0+IFsncmVxdWlyZWQnXSwKICAgICAgICAgICAgICAgICdpbnZlbnRvcnlfYWRqdXN0bWVudHNfYWNjb3VudF9pZCcgPT4gWydyZXF1aXJlZCddLAogICAgICAgICAgICBdKTsKICAgICAgICB9CgogICAgICAgIGlmKGZyZWV6ZVByb2R1Y3QoJHByb2R1Y3QpICYmICFhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnU3VwZXIgQWRtaW4nKSl7CiAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiBmYWxzZSwKICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAiUHJvZHVjdCAjIi4kcHJvZHVjdC0+bmFtZS4iICIuZ2V0UHJvZHVjdEF0dHJpYnV0ZXNGYXN0ZXIoJHByb2R1Y3QpLiIgQ2Fubm90IEJlIEVkaXRlZCEiCiAgICAgICAgICAgIF0pOwogICAgICAgIH0KCiAgICAgICAgREI6OmJlZ2luVHJhbnNhY3Rpb24oKTsKICAgICAgICB0cnkgewogICAgICAgICAgICBpZihpc3NldCgkcmVxdWVzdC0+cGFyZW50X2lkKSAmJiAkcmVxdWVzdC0+cGFyZW50X2lkID4gMCl7CiAgICAgICAgICAgICAgICAkcGFyZW50ID0gUHJvZHVjdDo6ZmluZE9yRmFpbCgkcmVxdWVzdC0+cGFyZW50X2lkKTsKICAgICAgICAgICAgICAgIGlmKCRyZXF1ZXN0LT55ZWFycyA+ICRwYXJlbnQtPnllYXJzKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgJ21lc3NhZ2UnID0+ICJTdWIgQXNzZXRzIGxpZmUgZHVyYXRpb24gKCIuJHJlcXVlc3QtPnllYXJzLiIpIGNhbm5vdCBiZSBncmF0ZXIgdGhhbiBNYWluIEFzc2V0IGxpZmUgZHVyYXRpb24gKCIuJHBhcmVudC0+eWVhcnMuIikiCiAgICAgICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICRzdXBwbGllcnMgPSBpc3NldCgkcmVxdWVzdC0+c3VwcGxpZXIpID8gJHJlcXVlc3QtPnN1cHBsaWVyIDogW107CiAgICAgICAgICAgICRidWZmZXJJbnZlbnRvcnkgPSAkcmVxdWVzdC0+YnVmZmVyX2ludmVudG9yeTsKICAgICAgICAgICAgJGlucHV0cyA9ICRyZXF1ZXN0LT5hbGwoKTsKICAgICAgICAgICAgdW5zZXQoJGlucHV0c1snX3Rva2VuJ10pOwogICAgICAgICAgICB1bnNldCgkaW5wdXRzWydfbWV0aG9kJ10pOwogICAgICAgICAgICB1bnNldCgkaW5wdXRzWydzdXBwbGllciddKTsKICAgICAgICAgICAgdW5zZXQoJGlucHV0c1snYnVmZmVyX2ludmVudG9yeSddKTsKCiAgICAgICAgICAgICRpbnB1dHNbJ2lzX2ZpeGVkX2Fzc2V0J10gPSAwOwogICAgICAgICAgICAkaW5wdXRzWydpc19jd2lwJ10gPSAwOwogICAgICAgICAgICBpZigkcmVxdWVzdC0+cHJvZHVjdF90eXBlID09ICdmaXhlZF9hc3NldCcpewogICAgICAgICAgICAgICAgJGlucHV0c1snaXNfZml4ZWRfYXNzZXQnXSA9IDE7CiAgICAgICAgICAgICAgICAkaW5wdXRzWydpc19jd2lwJ10gPSAwOwogICAgICAgICAgICB9ZWxzZWlmKCRyZXF1ZXN0LT5wcm9kdWN0X3R5cGUgPT0gJ2N3aXAnKXsKICAgICAgICAgICAgICAgICRpbnB1dHNbJ2lzX2ZpeGVkX2Fzc2V0J10gPSAwOwogICAgICAgICAgICAgICAgJGlucHV0c1snaXNfY3dpcCddID0gMTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgJHByb2R1Y3QtPnVwZGF0ZSgkaW5wdXRzKTsKICAgICAgICAgICAgLy8gJHByb2R1Y3QtPnN1cHBsaWVycygpLT5zeW5jKGlzc2V0KCRzdXBwbGllcnNbMF0pID8gJHN1cHBsaWVycyA6IFtdKTsKICAgICAgICAgICAgaWYgKCRidWZmZXJJbnZlbnRvcnkpewogICAgICAgICAgICAgICAgaWYgKCRwcm9kdWN0LT5yZWxJbnZlbnRvcnlTdW1tYXJ5KXsKICAgICAgICAgICAgICAgICAgICAkaW52ZW50b3J5U3VtbWFyeSA9ICRwcm9kdWN0LT5yZWxJbnZlbnRvcnlTdW1tYXJ5OwogICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgJGludmVudG9yeVN1bW1hcnkgPSBuZXcgSW52ZW50b3J5U3VtbWFyeSgpOwogICAgICAgICAgICAgICAgICAgICRpbnZlbnRvcnlTdW1tYXJ5LT5jYXRlZ29yeV9pZCA9ICRpbnB1dHNbJ2NhdGVnb3J5X2lkJ107CiAgICAgICAgICAgICAgICAgICAgJGludmVudG9yeVN1bW1hcnktPnByb2R1Y3RfaWQgPSAkcHJvZHVjdC0+aWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAkaW52ZW50b3J5U3VtbWFyeS0+YnVmZmVyX2ludmVudG9yeSA9ICRidWZmZXJJbnZlbnRvcnk7CiAgICAgICAgICAgICAgICAkaW52ZW50b3J5U3VtbWFyeS0+c2F2ZSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBQcm9kdWN0QXR0cmlidXRlOjp3aGVyZSgncHJvZHVjdF9pZCcsICRwcm9kdWN0LT5pZCktPmRlbGV0ZSgpOwogICAgICAgICAgICBpZihpc3NldCgkcmVxdWVzdC0+cHJvZHVjdEF0dHJpYnV0ZXNbMF0pKXsKICAgICAgICAgICAgICAgIGZvcmVhY2goJHJlcXVlc3QtPnByb2R1Y3RBdHRyaWJ1dGVzIGFzICRrZXkgPT4gJGF0dHJpYnV0ZV9pZCl7CiAgICAgICAgICAgICAgICAgICAgJHNlcmlhbF9ubyA9IENhdGVnb3J5QXR0cmlidXRlOjp3aGVyZShbCiAgICAgICAgICAgICAgICAgICAgICAgICdjYXRlZ29yeV9pZCcgPT4gJHJlcXVlc3QtPmNhdGVnb3J5X2lkLAogICAgICAgICAgICAgICAgICAgICAgICAnYXR0cmlidXRlX2lkJyA9PiAkYXR0cmlidXRlX2lkCiAgICAgICAgICAgICAgICAgICAgXSktPnN1bSgnc2VyaWFsJyk7CiAgICAgICAgICAgICAgICAgICAgaWYoaXNzZXQoJHJlcXVlc3QtPmF0dHJpYnV0ZV9vcHRpb25faWRbJGF0dHJpYnV0ZV9pZF0pICYmICRyZXF1ZXN0LT5hdHRyaWJ1dGVfb3B0aW9uX2lkWyRhdHRyaWJ1dGVfaWRdICE9IDApewogICAgICAgICAgICAgICAgICAgICAgICBQcm9kdWN0QXR0cmlidXRlOjpjcmVhdGUoWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3Byb2R1Y3RfaWQnID0+ICRwcm9kdWN0LT5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdhdHRyaWJ1dGVfb3B0aW9uX2lkJyA9PiAkcmVxdWVzdC0+YXR0cmlidXRlX29wdGlvbl9pZFskYXR0cmlidXRlX2lkXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdzZXJpYWxfbm8nID0+ICRzZXJpYWxfbm8sCiAgICAgICAgICAgICAgICAgICAgICAgIF0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgJHByb2R1Y3RzID0gUHJvZHVjdDo6d2l0aChbCiAgICAgICAgICAgICAgICAnYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24uYXR0cmlidXRlJwogICAgICAgICAgICBdKQogICAgICAgICAgICAtPndoZXJlKFsKICAgICAgICAgICAgICAgIFsnaWQnLCAnIT0nLCAkcHJvZHVjdC0+aWRdLAogICAgICAgICAgICAgICAgWyduYW1lJywgJHByb2R1Y3QtPm5hbWVdLAogICAgICAgICAgICBdKQogICAgICAgICAgICAtPndoZXJlSGFzKCdhdHRyaWJ1dGVzJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgkcHJvZHVjdCkgewogICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZUluKCdhdHRyaWJ1dGVfb3B0aW9uX2lkJywgJHByb2R1Y3QtPmF0dHJpYnV0ZXMtPnBsdWNrKCdhdHRyaWJ1dGVfb3B0aW9uX2lkJyktPnRvQXJyYXkoKSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+Z2V0KCk7CiAgICAgICAgICAgICRjb3VudCA9IDA7CiAgICAgICAgICAgIGlmKGlzc2V0KCRwcm9kdWN0c1swXSkpewogICAgICAgICAgICAgICAgZm9yZWFjaCgkcHJvZHVjdHMgYXMgJGtleSA9PiAkdGhpc19wcm9kdWN0KXsKICAgICAgICAgICAgICAgICAgICBpZihnZXRQcm9kdWN0QXR0cmlidXRlc0Zhc3RlcigkcHJvZHVjdCkgPT0gZ2V0UHJvZHVjdEF0dHJpYnV0ZXNGYXN0ZXIoJHRoaXNfcHJvZHVjdCkpewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbWVzc2FnZScgPT4gJHRoaXNfcHJvZHVjdC0+bmFtZS4nICcuZ2V0UHJvZHVjdEF0dHJpYnV0ZXNGYXN0ZXIoJHRoaXNfcHJvZHVjdCkuJyBhbHJlYWR5IGV4aXN0cyEnLAogICAgICAgICAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHVwZGF0ZVN1cHBsaWVyUHJvZHVjdHMoMTIpOwogICAgICAgICAgICBEQjo6Y29tbWl0KCk7CgogICAgICAgICAgICBzZXNzaW9uKCktPmZsYXNoKCdhbGVydC10eXBlJywgJ3N1Y2Nlc3MnKTsKICAgICAgICAgICAgc2Vzc2lvbigpLT5mbGFzaCgnbWVzc2FnZScsICdQcm9kdWN0IGhhcyBiZWVuIHVwZGF0ZWQgc3VjY2Vzc2Z1bGx5Jyk7CiAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiB0cnVlLAogICAgICAgICAgICAgICAgJ3VybCcgPT4gdXJsKCdwbXMvcHJvZHVjdC1tYW5hZ2VtZW50L3Byb2R1Y3QnKQogICAgICAgICAgICBdKTsKICAgICAgICB9Y2F0Y2ggKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgREI6OnJvbGxiYWNrKCk7CiAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiB0cnVlLAogICAgICAgICAgICAgICAgJ21lc3NhZ2UnID0+ICR0aC0+Z2V0TWVzc2FnZSgpCiAgICAgICAgICAgIF0pOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJlbW92ZSB0aGUgc3BlY2lmaWVkIHJlc291cmNlIGZyb20gc3RvcmFnZS4KICAgICAqCiAgICAgKiBAcGFyYW0gIGludCAgJGlkCiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwogICAgcHVibGljIGZ1bmN0aW9uIGRlc3Ryb3koUHJvZHVjdCAkcHJvZHVjdCkKICAgIHsKICAgICAgICBpZihmcmVlemVQcm9kdWN0KCRwcm9kdWN0KSl7CiAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiBmYWxzZSwKICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAiUHJvZHVjdCAjIi4kcHJvZHVjdC0+bmFtZS4iICIuZ2V0UHJvZHVjdEF0dHJpYnV0ZXNGYXN0ZXIoJHByb2R1Y3QpLiIgQ2Fubm90IEJlIERlbGV0ZWQhIgogICAgICAgICAgICBdKTsKICAgICAgICB9CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgICRwcm9kdWN0LT5zdXBwbGllcnMoKS0+c3luYyhbXSk7CiAgICAgICAgICAgIFByb2R1Y3RBdHRyaWJ1dGU6OndoZXJlKCdwcm9kdWN0X2lkJywgJHByb2R1Y3QtPmlkKS0+ZGVsZXRlKCk7CiAgICAgICAgICAgICRwcm9kdWN0LT5kZWxldGUoKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnID0+IHRydWUKICAgICAgICAgICAgXSk7CiAgICAgICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiBmYWxzZSwKICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAkdGgtPmdldE1lc3NhZ2UoKQogICAgICAgICAgICBdKTsKICAgICAgICB9CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIGltcG9ydFByb2R1Y3RTYW1wbGUoKXsKICAgICAgICAkZGF0YSA9IFsKICAgICAgICAgICAgJ2F0dHJpYnV0ZXMnID0+IEF0dHJpYnV0ZTo6Z2V0KFsnaWQnLCduYW1lJ10pLAogICAgICAgICAgICAnY2F0ZWdvcnknID0+IENhdGVnb3J5OjpoYXMoJ2NhdGVnb3J5JyktPmluUmFuZG9tT3JkZXIoKS0+Zmlyc3QoWydjb2RlJ10pLAogICAgICAgICAgICAnYnJhbmQnID0+IEJyYW5kOjppblJhbmRvbU9yZGVyKCktPmZpcnN0KFsnY29kZSddKSwKICAgICAgICAgICAgJ3VuaXQnID0+IFByb2R1Y3RVbml0OjppblJhbmRvbU9yZGVyKCktPmZpcnN0KFsndW5pdF9uYW1lJ10pLAogICAgICAgICAgICAnc3VwcGxpZXJfbW9iaWxlJyA9PiBTdXBwbGllcnM6OndoZXJlKCdzdGF0dXMnLCAnQWN0aXZlJyktPmluUmFuZG9tT3JkZXIoKS0+dGFrZSgnMycpLT5wbHVjaygnbW9iaWxlX25vJyktPmltcGxvZGUoJywnKQogICAgICAgIF07CgogICAgICAgIHJldHVybiBFeGNlbDo6ZG93bmxvYWQobmV3IFxBcHBcRXhwb3J0c1xQTVNcUHJvZHVjdFNhbXBsZSgkZGF0YSksICdQcm9kdWN0IFVwbG9hZCBTYW1wbGUueGxzeCcpOwogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBpbXBvcnRQcm9kdWN0KFJlcXVlc3QgJHJlcXVlc3QpCiAgICB7CiAgICAgICAgJHRoaXMtPnZhbGlkYXRlKCRyZXF1ZXN0LCBbCiAgICAgICAgICAgICdwcm9kdWN0X2ZpbGUnICA9PiAnbWltZXM6eGxzLHhsc3gnCiAgICAgICAgXSk7CgogICAgICAgIC8vJHBhdGggPSAkcmVxdWVzdC0+ZmlsZSgncHJvZHVjdF9maWxlJyktPmdldFJlYWxQYXRoKCk7CgogICAgICAgIHRyeSB7CgogICAgICAgICAgICBFeGNlbDo6aW1wb3J0KG5ldyBQcm9kdWN0SW1wb3J0LCAkcmVxdWVzdC0+cHJvZHVjdF9maWxlKTsKCiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhTdWNjZXNzKCdFeGNlbCBEYXRhIEltcG9ydGVkIHN1Y2Nlc3NmdWxseS4nKTsKCiAgICAgICAgfWNhdGNoIChcTWFhdHdlYnNpdGVcRXhjZWxcVmFsaWRhdG9yc1xWYWxpZGF0aW9uRXhjZXB0aW9uICRlKSB7CiAgICAgICAgICAgICRmYWlsdXJlcyA9ICRlLT5mYWlsdXJlcygpOwogICAgICAgICAgICAkZXJyb3I9W107CiAgICAgICAgICAgIGZvcmVhY2ggKCRmYWlsdXJlcyBhcyAkZmFpbHVyZSkgewogICAgICAgICAgICAgICAgJGZhaWx1cmUtPnJvdygpOyAKICAgICAgICAgICAgICAgICRmYWlsdXJlLT5hdHRyaWJ1dGUoKTsgCiAgICAgICAgICAgICAgICAkZXJyb3JbXT0kZmFpbHVyZS0+ZXJyb3JzKCk7IAogICAgICAgICAgICAgICAgJGZhaWx1cmUtPnZhbHVlcygpOyAKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCRlcnJvclswXVswXSk7CiAgICAgICAgfQogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiB0b2dnbGUoUmVxdWVzdCAkcmVxdWVzdCwgJGlkKQogICAgewogICAgICAgICRwcm9kdWN0ID0gUHJvZHVjdDo6d2l0aChbJ2F0dHJpYnV0ZXMuYXR0cmlidXRlT3B0aW9uLmF0dHJpYnV0ZSddKS0+ZmluZE9yRmFpbCgkaWQpOwogICAgICAgICRwcm9kdWN0LT5zdGF0dXMgPSAoJHByb2R1Y3QtPnN0YXR1cyA9PSAncGVuZGluZycgPyAnYXBwcm92ZWQnIDogJ3BlbmRpbmcnKTsKICAgICAgICAkcHJvZHVjdC0+c2F2ZSgpOwoKICAgICAgICBpZigkcHJvZHVjdCl7CiAgICAgICAgICAgIGlmKCRwcm9kdWN0LT5zdGF0dXMgPT0gJ2FwcHJvdmVkJyl7CiAgICAgICAgICAgICAgICAkbWVzc2FnZT0gJzxzcGFuIGNsYXNzPSJub3RpZmljYXRpb24tbGlua3MiIGRhdGEtc3JjPSInLnVybCgncG1zL3Byb2R1Y3QtbWFuYWdlbWVudC9wcm9kdWN0LycuJHByb2R1Y3QtPmlkLicvZGV0YWlscycpLiciIGRhdGEtdGl0bGU9IlByb2R1Y3QgRGV0YWlscyI+UHJvZHVjdCAnLiRwcm9kdWN0LT5uYW1lLicgJy5nZXRQcm9kdWN0QXR0cmlidXRlc0Zhc3RlcigkcHJvZHVjdCkuJyBoYXMgYmVlbiBhcHByb3ZlZC48L3NwYW4+JzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgQ3JlYXRlT3JVcGRhdGVOb3RpZmljYXRpb24oJG1lc3NhZ2UsJ3VucmVhZCcsJycsWyRwcm9kdWN0LT5jcmVhdGVkX2J5XSwnc2VuZC10by1lbXBsb3llZScpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gdHJ1ZSwKICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAiUHJvZHVjdCBoYXMgYmVlbiAiLnVjd29yZHMoJHByb2R1Y3QtPnN0YXR1cyksCiAgICAgICAgICAgICAgICAiYnV0dG9uIiA9PiAnPGEgY2xhc3M9ImJ0biBidG4teHMgYnRuLScuKCRwcm9kdWN0LT5zdGF0dXMgPT0gJ3BlbmRpbmcnID8gJ3dhcm5pbmcnIDogJ3N1Y2Nlc3MnKS4nIiAnLihhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnUHVyY2hhc2UtRGVwYXJ0bWVudCcpID8gJ29uY2xpY2s9InRvZ2dsZVByb2R1Y3QoJCh0aGlzKSkiJyA6ICcnKS4nIGRhdGEtcHJvZHVjdC1pZD0iJy4kcHJvZHVjdC0+aWQuJyIgZGF0YS1zdGF0dXM9IicuJHByb2R1Y3QtPnN0YXR1cy4nIiBzdHlsZT0iY3Vyc29yOiBwb2ludGVyIj4nLnVjd29yZHMoJHByb2R1Y3QtPnN0YXR1cykuJzwvYT4nLCAKICAgICAgICAgICAgXSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICdzdWNjZXNzJyA9PiBmYWxzZSwKICAgICAgICAgICAgJ21lc3NhZ2UnID0+ICJTb21ldGhpbmcgd2VudCB3cm9uZyEiCiAgICAgICAgXSk7CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIGRldGFpbHMgKCRwcm9kdWN0X2lkKQogICAgewogICAgICAgICRwcm9kdWN0ID0gUHJvZHVjdDo6ZmluZE9yRmFpbCgkcHJvZHVjdF9pZCk7CiAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnByb2R1Y3RzLmRldGFpbHMnLCBjb21wYWN0KCdwcm9kdWN0JykpOwogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBnZXRTdWJBc3NldHMoJGlkKQogICAgewogICAgICAgICRwcm9kdWN0cyA9IFByb2R1Y3Q6OndpdGgoWwogICAgICAgICAgICAnYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24uYXR0cmlidXRlJwogICAgICAgIF0pCiAgICAgICAgLT53aGVyZShbCiAgICAgICAgICAgICdjYXRlZ29yeV9pZCcgPT4gJGlkLAogICAgICAgICAgICAncGFyZW50X2lkJyA9PiAwCiAgICAgICAgXSktPmdldCgpOwogICAgICAgICRyZXNwb25zZSA9ICc8b3B0aW9uIHZhbHVlPSIwIiBkYXRhLWNvZGU9IiI+Ti9BPC9vcHRpb24+JzsKICAgICAgICBpZihpc3NldCgkcHJvZHVjdHNbMF0pKXsKICAgICAgICAgICAgZm9yZWFjaCAoJHByb2R1Y3RzIGFzICRrZXkgPT4gJHByb2R1Y3QpIHsKICAgICAgICAgICAgICAgICRzdWJBc3NldHMgPSAoJHByb2R1Y3QtPnN1YkFzc2V0cy0+Y291bnQoKSsxKTsKICAgICAgICAgICAgICAgICRjb2RlID0gKCRwcm9kdWN0LT5za3UuJy0nLigkc3ViQXNzZXRzIDwgOSA/ICcwJyA6ICcnKS4kc3ViQXNzZXRzKTsKICAgICAgICAgICAgICAgICRyZXNwb25zZSAuPSAnPG9wdGlvbiB2YWx1ZT0iJy4kcHJvZHVjdC0+aWQuJyIgZGF0YS1jb2RlPSInLiRjb2RlLiciICcuKHJlcXVlc3QoKS0+Z2V0KCdzZWxlY3RlZCcpID09ICRwcm9kdWN0LT5pZCA/ICdzZWxlY3RlZCcgOiAnJykuJz4nLiRwcm9kdWN0LT5uYW1lLicgJy5nZXRQcm9kdWN0QXR0cmlidXRlc0Zhc3RlcigkcHJvZHVjdCkuJzwvb3B0aW9uPic7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiAkcmVzcG9uc2U7CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIGdldFN0YW5kYXJkQ29zdHMoJGlkKXsKICAgICAgICAkcHJvZHVjdCA9IFByb2R1Y3Q6OmZpbmRPckZhaWwoJGlkKTsKICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMucHJvZHVjdHMuc3RhbmRhcmQtY29zdHMnLCBbCiAgICAgICAgICAgICd0aXRsZScgPT4gIlN0YW5kYXJkIENvc3RzIGZvciAiLiRwcm9kdWN0LT5uYW1lLicgJy5nZXRQcm9kdWN0QXR0cmlidXRlc0Zhc3RlcigkcHJvZHVjdCksCiAgICAgICAgICAgICdwcm9kdWN0JyA9PiAkcHJvZHVjdCwKICAgICAgICAgICAgJ3N0YW5kYXJkQ29zdHMnID0+IFN0YW5kYXJkQ29zdDo6YWxsKCkKICAgICAgICBdKTsKICAgIH0KCiAgICBwdWJsaWMgZnVuY3Rpb24gdXBkYXRlU3RhbmRhcmRDb3N0cyhSZXF1ZXN0ICRyZXF1ZXN0LCAkaWQpCiAgICB7CiAgICAgICAgJHJlcXVlc3QtPnZhbGlkYXRlKFsKICAgICAgICAgICAgJ2Ftb3VudHMnID0+ICdyZXF1aXJlZCcsCiAgICAgICAgICAgICdhbW91bnRzLionID0+ICdyZXF1aXJlZCcsCiAgICAgICAgXSk7CgogICAgICAgICRwcm9kdWN0ID0gUHJvZHVjdDo6ZmluZE9yRmFpbCgkaWQpOwogICAgICAgIERCOjpiZWdpblRyYW5zYWN0aW9uKCk7CiAgICAgICAgdHJ5eyAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcmVhY2goJHJlcXVlc3QtPmFtb3VudHMgYXMgJHN0YW5kYXJkX2Nvc3RfaWQgPT4gJGFtb3VudCl7CiAgICAgICAgICAgICAgICBQcm9kdWN0U3RhbmRhcmRDb3N0Ojp1cGRhdGVPckNyZWF0ZShbCiAgICAgICAgICAgICAgICAgICAgJ3Byb2R1Y3RfaWQnID0+ICRwcm9kdWN0LT5pZCwKICAgICAgICAgICAgICAgICAgICAnc3RhbmRhcmRfY29zdF9pZCcgPT4gJHN0YW5kYXJkX2Nvc3RfaWQsCiAgICAgICAgICAgICAgICBdLCBbCiAgICAgICAgICAgICAgICAgICAgJ2Ftb3VudCcgPT4gJGFtb3VudAogICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIERCOjpjb21taXQoKTsKICAgICAgICAgICAgJG5vdGlmaWNhdGlvbiA9IFsKICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAiU3RhbmRhcmQgY29zdHMgaGFzIGJlZW4gdXBkYXRlZCIsCiAgICAgICAgICAgICAgICAnYWxlcnQtdHlwZScgPT4gJ3N1Y2Nlc3MnCiAgICAgICAgICAgIF07CiAgICAgICAgICAgIHJldHVybiByZWRpcmVjdCgncG1zL3Byb2R1Y3QtbWFuYWdlbWVudC9wcm9kdWN0LycuJHByb2R1Y3QtPmlkLicvc3RhbmRhcmQtY29zdHMnKS0+d2l0aCgkbm90aWZpY2F0aW9uKTsKICAgICAgICB9Y2F0Y2ggKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgREI6OnJvbGxiYWNrKCk7CiAgICAgICAgICAgICRub3RpZmljYXRpb24gPSBbCiAgICAgICAgICAgICAgICAnbWVzc2FnZScgPT4gJHRoLT5nZXRNZXNzYWdlKCksCiAgICAgICAgICAgICAgICAnYWxlcnQtdHlwZScgPT4gJ2Vycm9yJwogICAgICAgICAgICBdOwogICAgICAgICAgICByZXR1cm4gcmVkaXJlY3QoJ3Btcy9wcm9kdWN0LW1hbmFnZW1lbnQvcHJvZHVjdC8nLiRwcm9kdWN0LT5pZC4nL3N0YW5kYXJkLWNvc3RzJyktPndpdGgoJG5vdGlmaWNhdGlvbik7CiAgICAgICAgfQogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiB1bml0Q29udmVyc2lvbnMoJGlkKQogICAgewogICAgICAgICRwcm9kdWN0ID0gUHJvZHVjdDo6d2l0aChbCiAgICAgICAgICAgICdwcm9kdWN0VW5pdC5tYXRyaXhlcycsCiAgICAgICAgICAgICdwcm9kdWN0VW5pdENvbnZlcnNpb25zJwogICAgICAgIF0pLT5maW5kT3JGYWlsKCRpZCk7CiAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnByb2R1Y3RzLnVuaXQtY29udmVyc2lvbnMnLCBbCiAgICAgICAgICAgICdwcm9kdWN0JyA9PiAkcHJvZHVjdCwKICAgICAgICAgICAgJ3VuaXRzJyA9PiBQcm9kdWN0VW5pdDo6d2hlcmUoJ2lkJywgJyE9JywgJHByb2R1Y3QtPnByb2R1Y3RfdW5pdF9pZCktPmdldCgpLAogICAgICAgIF0pOwogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiB1cGRhdGVVbml0Q29udmVyc2lvbnMoUmVxdWVzdCAkcmVxdWVzdCwgJGlkKQogICAgewogICAgICAgIERCOjpiZWdpblRyYW5zYWN0aW9uKCk7CiAgICAgICAgdHJ5ewogICAgICAgICAgICAkcHJvZHVjdCA9IFByb2R1Y3Q6OndpdGgoWwogICAgICAgICAgICAgICAgJ3Byb2R1Y3RVbml0Lm1hdHJpeGVzJywKICAgICAgICAgICAgICAgICdwcm9kdWN0VW5pdENvbnZlcnNpb25zJwogICAgICAgICAgICBdKS0+ZmluZE9yRmFpbCgkaWQpOwogICAgICAgICAgICAkdW5pdHMgPSBQcm9kdWN0VW5pdDo6d2hlcmUoJ2lkJywgJyE9JywgJHByb2R1Y3QtPnByb2R1Y3RfdW5pdF9pZCktPmdldCgpOwogICAgICAgICAgICBpZihpc3NldCgkdW5pdHNbMF0pKXsKICAgICAgICAgICAgICAgIGZvcmVhY2goJHVuaXRzIGFzICR1bml0KXsKICAgICAgICAgICAgICAgICAgICBQcm9kdWN0VW5pdENvbnZlcnNpb246OnVwZGF0ZU9yQ3JlYXRlKFsKICAgICAgICAgICAgICAgICAgICAgICAgJ3Byb2R1Y3RfaWQnID0+ICRpZCwKICAgICAgICAgICAgICAgICAgICAgICAgJ3Byb2R1Y3RfdW5pdF9pZCcgPT4gJHByb2R1Y3QtPnByb2R1Y3RfdW5pdF9pZCwKICAgICAgICAgICAgICAgICAgICAgICAgJ2NvbnZlcnNpb25fdW5pdF9pZCcgPT4gJHVuaXQtPmlkCiAgICAgICAgICAgICAgICAgICAgXSwgWwogICAgICAgICAgICAgICAgICAgICAgICAnY29udmVyc2lvbl9yYXRlJyA9PiBpc3NldCgkcmVxdWVzdC0+dW5pdHNbJHVuaXQtPmlkXSkgJiYgJHJlcXVlc3QtPnVuaXRzWyR1bml0LT5pZF0gPj0gMCA/ICRyZXF1ZXN0LT51bml0c1skdW5pdC0+aWRdIDogMCwKICAgICAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgREI6OmNvbW1pdCgpOwogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gdHJ1ZSwKICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAiVW5pdCBDb252ZXJzaW9ucyBoYXMgYmVlbiB1cGRhdGVkIHN1Y2Nlc3NmdWxseS4iCiAgICAgICAgICAgIF0pOwogICAgICAgIH1jYXRjaCAoXFRocm93YWJsZSAkdGgpewogICAgICAgICAgICBEQjo6cm9sbGJhY2soKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnID0+IGZhbHNlLAogICAgICAgICAgICAgICAgJ21lc3NhZ2UnID0+ICR0aC0+Z2V0TWVzc2FnZSgpCiAgICAgICAgICAgIF0pOwogICAgICAgIH0KICAgIH0KCiAgICBwdWJsaWMgZnVuY3Rpb24gc3VwcGxpZXJzKCRpZCkKICAgIHsKICAgICAgICAkcHJvZHVjdCA9IFByb2R1Y3Q6OndpdGgoWwogICAgICAgICAgICAnc3VwcGxpZXJzJywKICAgICAgICBdKS0+ZmluZE9yRmFpbCgkaWQpOwoKICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMucHJvZHVjdHMudXBkYXRlLXN1cHBsaWVycycsIFsKICAgICAgICAgICAgJ3Byb2R1Y3QnID0+ICRwcm9kdWN0LAogICAgICAgICAgICAnc3VwcGxpZXJzJyA9PiBTdXBwbGllcnM6OndoZXJlKCdzdGF0dXMnLCAnQWN0aXZlJyktPmdldChbJ2lkJywgJ25hbWUnXSksCiAgICAgICAgICAgICdleGlzdGVkU3VwcGxpZXJzJyA9PiAkcHJvZHVjdC0+c3VwcGxpZXJzLT5wbHVjaygncGl2b3Quc3VwcGxpZXJfaWQnKS0+dG9BcnJheSgpLAogICAgICAgIF0pOwogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiB1cGRhdGVTdXBwbGllcnMoUmVxdWVzdCAkcmVxdWVzdCwgJGlkKQogICAgewogICAgICAgIERCOjpiZWdpblRyYW5zYWN0aW9uKCk7CiAgICAgICAgdHJ5ewogICAgICAgICAgICAkcHJvZHVjdCA9IFByb2R1Y3Q6OndpdGgoWwogICAgICAgICAgICAgICAgJ3Byb2R1Y3RVbml0Lm1hdHJpeGVzJywKICAgICAgICAgICAgICAgICdwcm9kdWN0VW5pdENvbnZlcnNpb25zJwogICAgICAgICAgICBdKS0+ZmluZE9yRmFpbCgkaWQpOwogICAgICAgICAgICAkcHJvZHVjdC0+c3VwcGxpZXJzKCktPnN5bmMoaXNzZXQoJHJlcXVlc3QtPnN1cHBsaWVyWzBdKSA/ICRyZXF1ZXN0LT5zdXBwbGllciA6IFtdKTsKCiAgICAgICAgICAgIERCOjpjb21taXQoKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnID0+IHRydWUsCiAgICAgICAgICAgICAgICAnbWVzc2FnZScgPT4gIlByb2R1Y3QgU3VwcGxpZXJzIGhhcyBiZWVuIHVwZGF0ZWQgc3VjY2Vzc2Z1bGx5LiIKICAgICAgICAgICAgXSk7CiAgICAgICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgIERCOjpyb2xsYmFjaygpOwogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gZmFsc2UsCiAgICAgICAgICAgICAgICAnbWVzc2FnZScgPT4gJHRoLT5nZXRNZXNzYWdlKCkKICAgICAgICAgICAgXSk7CiAgICAgICAgfQogICAgfQp9Cg==