<?php
bolt_decrypt( __FILE__ , 'u5wL0c'); return 0;
##!!!##CgpuYW1lc3BhY2UgQXBwXEh0dHBcQ29udHJvbGxlcnNcUG1zOwoKdXNlIEFwcFxIdHRwXENvbnRyb2xsZXJzXENvbnRyb2xsZXI7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xCcmFuZDsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXENhdGVnb3J5Owp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcQ2F0ZWdvcnlBdHRyaWJ1dGU7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xJbnZlbnRvcnlNb2RlbHNcSW52ZW50b3J5U3VtbWFyeTsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFByb2R1Y3Q7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xTdXBwbGllcnM7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xQcm9kdWN0VW5pdDsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXEF0dHJpYnV0ZTsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFByb2R1Y3RBdHRyaWJ1dGU7CnVzZSBBcHBcTW9kZWxzXEZpeGVkQXNzZXRzXERlcHJlY2lhdGlvbk1ldGhvZDsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFN0YW5kYXJkQ29zdDsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFByb2R1Y3RTdGFuZGFyZENvc3Q7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xQcm9kdWN0VW5pdENvbnZlcnNpb247CnVzZSBJbGx1bWluYXRlXEh0dHBcUmVxdWVzdDsKdXNlIEFwcFxJbXBvcnRzXFByb2R1Y3RJbXBvcnQ7CnVzZSBNYWF0d2Vic2l0ZVxFeGNlbFxGYWNhZGVzXEV4Y2VsOwp1c2UgREIsIERhdGFUYWJsZXM7CgpjbGFzcyBQcm9kdWN0Q29udHJvbGxlciBleHRlbmRzIENvbnRyb2xsZXIKeyAgIAoKICAgIHB1YmxpYyBmdW5jdGlvbiBoZWFkZXJDb2x1bW5zKCR2YWx1ZT0nJykKICAgIHsKICAgICAgICAkcm93cyA9ICBhcnJheSgKICAgICAgICAgICAgWydTTCcsICdTTCddLAogICAgICAgICAgICBbJ3Byb2R1Y3RfdHlwZScsICdwcm9kdWN0X3R5cGUnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydjYXRlZ29yeScsICdjYXRlZ29yeScsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3N1Yl9jYXRlZ29yeScsICdzdWJfY2F0ZWdvcnknLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydjb2RlJywgJ2NvZGUnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWyduYW1lJywgJ25hbWUnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydhdHRyaWJ1dGVzJywgJ2F0dHJpYnV0ZXMnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydwcm9kdWN0X3VuaXQnLCAncHJvZHVjdF91bml0JywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsndW5pdF9wcmljZScsICd1bml0X3ByaWNlJywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsnc2FsZXNfcHJpY2UnLCAnc2FsZXNfcHJpY2UnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydhZGRlZF9ieScsICdhZGRlZF9ieScsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ2ZpbmFsX2Fzc2V0JywgJ2ZpbmFsX2Fzc2V0JywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsnc2VydmljZScsICdzZXJ2aWNlJywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIC8vIFsnc2FsZV9pdGVtJywgJ3NhbGVfaXRlbScsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3N0YXR1cycsICdzdGF0dXMnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydhY3Rpb25zJywgJ2FjdGlvbnMnLCAndGV4dC1jZW50ZXInXQogICAgICAgICk7CgogICAgICAgIHJldHVybiAkcm93czsKICAgIH0KICAgIAogICAgLyoqCiAgICAgKiBEaXNwbGF5IGEgbGlzdGluZyBvZiB0aGUgcmVzb3VyY2UuCiAgICAgKgogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KICAgIHB1YmxpYyBmdW5jdGlvbiBpbmRleCgpCiAgICB7CiAgICAgICAgdHJ5IHsKCiAgICAgICAgICAgICR0aXRsZSA9IChyZXF1ZXN0KCktPmhhcygnZml4ZWQtYXNzZXRzJykgPyAnRml4ZWQgQXNzZXRzJyA6IChyZXF1ZXN0KCktPmhhcygnY3dpcCcpID8gJ0NXSVAnIDogJ1Byb2R1Y3RzJykpOwogICAgICAgICAgICAkcHJvZHVjdHMgPSBQcm9kdWN0Ojp3aXRoKFsKICAgICAgICAgICAgICAgICdwcm9kdWN0VW5pdCcsICdjYXRlZ29yeS5jYXRlZ29yeScsICdhdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGUnLCAnY3JlYXRvcicsICdtYWluQXNzZXQuYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24uYXR0cmlidXRlJywgJ3N1YkFzc2V0cy5hdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGUnLCAncmVxdWlzaXRpb25JdGVtJwogICAgICAgICAgICBdKQogICAgICAgICAgICAtPmhhcygnY2F0ZWdvcnknKQogICAgICAgICAgICAtPndoZW4oIWRhdGF0YWJsZU9yZGVyaW5nKCksIGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT5vcmRlcmJ5KCdza3UnLCAnZGVzYycpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICRvcHRpb25zID0gWwogICAgICAgICAgICAgICAgJ1B1cmNoYXNlLURlcGFydG1lbnQnID0+IGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdQdXJjaGFzZS1EZXBhcnRtZW50JyksCiAgICAgICAgICAgICAgICAncHJvZHVjdC1lZGl0JyA9PiBhdXRoKCktPnVzZXIoKS0+aGFzUGVybWlzc2lvblRvKCdwcm9kdWN0LWVkaXQnKSwKICAgICAgICAgICAgICAgICdwcm9kdWN0LWRlbGV0ZScgPT4gYXV0aCgpLT51c2VyKCktPmhhc1Blcm1pc3Npb25UbygncHJvZHVjdC1kZWxldGUnKSwKICAgICAgICAgICAgICAgICdwcm9kdWN0LXN0YW5kYXJkLWNvc3RzJyA9PiBmYWxzZSwKICAgICAgICAgICAgICAgIC8vICdwcm9kdWN0LXN0YW5kYXJkLWNvc3RzJyA9PiBhdXRoKCktPnVzZXIoKS0+aGFzUGVybWlzc2lvblRvKCdwcm9kdWN0LXN0YW5kYXJkLWNvc3RzJyksCiAgICAgICAgICAgIF07CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAocmVxdWVzdCgpLT5hamF4KCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBEYXRhdGFibGVzOjpvZigkcHJvZHVjdHMpCiAgICAgICAgICAgICAgICAgICAgLT5hZGRJbmRleENvbHVtbigpCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3Byb2R1Y3RfdHlwZScsIGZ1bmN0aW9uICgkcHJvZHVjdCl7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcHJvZHVjdC0+aXNfZml4ZWRfYXNzZXQgPT0gMSA/ICdGaXhlZCBBc3NldCcgOiAoJHByb2R1Y3QtPmlzX2N3aXAgPT0gMSA/ICdDV0lQJyA6ICdQcm9kdWN0cycpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2NhdGVnb3J5JywgZnVuY3Rpb24oJHByb2R1Y3QpewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNzZXQoJHByb2R1Y3QtPmNhdGVnb3J5LT5jYXRlZ29yeS0+bmFtZSkgPyAkcHJvZHVjdC0+Y2F0ZWdvcnktPmNhdGVnb3J5LT5uYW1lIDogJyc7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbignY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygnY2F0ZWdvcnkuY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ2NhdGVnb3J5JywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwbGVhc2VTb3J0TWUoJHF1ZXJ5LCAkb3JkZXIsIENhdGVnb3J5OjpzZWxlY3QoJ21haW5fY2F0ZWdvcnkubmFtZScpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbignY2F0ZWdvcmllcyBhcyBtYWluX2NhdGVnb3J5JywgJ21haW5fY2F0ZWdvcnkuaWQnLCAnPScsICdjYXRlZ29yaWVzLnBhcmVudF9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ2NhdGVnb3JpZXMuaWQnLCAncHJvZHVjdHMuY2F0ZWdvcnlfaWQnKSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignc3ViX2NhdGVnb3J5JywgZnVuY3Rpb24oJHByb2R1Y3QpewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNzZXQoJHByb2R1Y3QtPmNhdGVnb3J5LT5uYW1lKSA/ICRwcm9kdWN0LT5jYXRlZ29yeS0+bmFtZSA6ICcnOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3N1Yl9jYXRlZ29yeScsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdjYXRlZ29yeScsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbignc3ViX2NhdGVnb3J5JywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwbGVhc2VTb3J0TWUoJHF1ZXJ5LCAkb3JkZXIsIENhdGVnb3J5OjpzZWxlY3QoJ25hbWUnKS0+d2hlcmVDb2x1bW4oJ2NhdGVnb3JpZXMuaWQnLCAncHJvZHVjdHMuY2F0ZWdvcnlfaWQnKSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignY29kZScsIGZ1bmN0aW9uKCRwcm9kdWN0KXsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRwcm9kdWN0LT5za3U7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbignY29kZScsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdza3UnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbignY29kZScsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT5vcmRlcmJ5KCdza3UnLCAkb3JkZXIpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2F0dHJpYnV0ZXMnLCBmdW5jdGlvbigkcHJvZHVjdCl7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRQcm9kdWN0QXR0cmlidXRlc0Zhc3RlcigkcHJvZHVjdCk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbignYXR0cmlidXRlcycsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdhdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbicsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgIC0+b3JXaGVyZUhhcygnYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24uYXR0cmlidXRlJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdhdHRyaWJ1dGVzJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeSA9IHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgUHJvZHVjdEF0dHJpYnV0ZTo6c2VsZWN0KCdhdHRyaWJ1dGVzLmNvZGUnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdhdHRyaWJ1dGVfb3B0aW9ucycsICdhdHRyaWJ1dGVfb3B0aW9ucy5pZCcsICc9JywgJ3Byb2R1Y3RfYXR0cmlidXRlcy5hdHRyaWJ1dGVfb3B0aW9uX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbignYXR0cmlidXRlcycsICdhdHRyaWJ1dGVzLmlkJywgJz0nLCAnYXR0cmlidXRlX29wdGlvbnMuYXR0cmlidXRlX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3Byb2R1Y3RfYXR0cmlidXRlcy5wcm9kdWN0X2lkJywgJ3Byb2R1Y3RzLmlkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+dGFrZSgxKQogICAgICAgICAgICAgICAgICAgICAgICApOwoKICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5ID0gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBQcm9kdWN0QXR0cmlidXRlOjpzZWxlY3QoJ2F0dHJpYnV0ZV9vcHRpb25zLm5hbWUnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdhdHRyaWJ1dGVfb3B0aW9ucycsICdhdHRyaWJ1dGVfb3B0aW9ucy5pZCcsICc9JywgJ3Byb2R1Y3RfYXR0cmlidXRlcy5hdHRyaWJ1dGVfb3B0aW9uX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3Byb2R1Y3RfYXR0cmlidXRlcy5wcm9kdWN0X2lkJywgJ3Byb2R1Y3RzLmlkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+dGFrZSgxKQogICAgICAgICAgICAgICAgICAgICAgICApOwoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdwcm9kdWN0X3VuaXQnLCBmdW5jdGlvbigkcHJvZHVjdCl7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpc3NldCgkcHJvZHVjdC0+cHJvZHVjdFVuaXQtPnVuaXRfbmFtZSk/JHByb2R1Y3QtPnByb2R1Y3RVbml0LT51bml0X25hbWU6Jyc7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbigncHJvZHVjdF91bml0JywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3Byb2R1Y3RVbml0JywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCd1bml0X25hbWUnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ3Byb2R1Y3RfdW5pdCcsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBQcm9kdWN0VW5pdDo6c2VsZWN0KCd1bml0X25hbWUnKS0+d2hlcmVDb2x1bW4oJ3Byb2R1Y3RfdW5pdHMuaWQnLCAncHJvZHVjdHMucHJvZHVjdF91bml0X2lkJykpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5lZGl0Q29sdW1uKCd1bml0X3ByaWNlJywgZnVuY3Rpb24oJHByb2R1Y3QpewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc3lzdGVtTW9uZXlGb3JtYXQoJHByb2R1Y3QtPnVuaXRfcHJpY2UpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2FkZGVkX2J5JywgZnVuY3Rpb24oJHByb2R1Y3QpewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNzZXQoJHByb2R1Y3QtPmNyZWF0b3ItPm5hbWUpID8gJHByb2R1Y3QtPmNyZWF0b3ItPm5hbWUgOiAnJzsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdhZGRlZF9ieScsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdjcmVhdG9yJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdhZGRlZF9ieScsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBVc2VyOjpzZWxlY3QoJ25hbWUnKS0+d2hlcmVDb2x1bW4oJ3VzZXJzLmlkJywgJ3Byb2R1Y3RzLmNyZWF0ZWRfYnknKSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignbWFpbl9hc3NldCcsIGZ1bmN0aW9uKCRwcm9kdWN0KXsKICAgICAgICAgICAgICAgICAgICAgICAgaWYocmVxdWVzdCgpLT5oYXMoJ2N3aXAnKSl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHByb2R1Y3QtPm1haW5Bc3NldCA/ICRwcm9kdWN0LT5tYWluQXNzZXQtPm5hbWUuJyAnLmdldFByb2R1Y3RBdHRyaWJ1dGVzRmFzdGVyKCRwcm9kdWN0LT5tYWluQXNzZXQpIDogJyc7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICcnOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ21haW5fYXNzZXQnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygnbWFpbkFzc2V0JywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignc3ViX2Fzc2V0JywgZnVuY3Rpb24oJHByb2R1Y3QpewogICAgICAgICAgICAgICAgICAgICAgICBpZihyZXF1ZXN0KCktPmhhcygnY3dpcCcpKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcHJvZHVjdC0+c3ViQXNzZXRzLT5wbHVjaygnbmFtZScpLT5pbXBsb2RlKCcsICcpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnJzsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdzdWJfYXNzZXQnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygnc3ViQXNzZXRzJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignZmluYWxfYXNzZXQnLCBmdW5jdGlvbigkcHJvZHVjdCl7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcHJvZHVjdC0+aXNfZmluYWxfYXNzZXQgPT0gMSA/ICAnPGEgY2xhc3M9ImJ0biBidG4teHMgYnRuLXN1Y2Nlc3MiPlllczwvYT4nIDogJzxhIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi1kYXJrIj5ObzwvYT4nOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3NlcnZpY2UnLCBmdW5jdGlvbiAoJHByb2R1Y3QpewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHByb2R1Y3QtPmlzX3NlcnZpY2UgPT0gMSA/ICc8YSBjbGFzcz0iYnRuIGJ0bi1zdWNjZXNzIGJ0bi14cyI+WWVzPC9hPicgOiAnPGEgY2xhc3M9ImJ0biBidG4tZGFyayBidG4teHMiPk5vPC9hPic7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAvLyAtPmFkZENvbHVtbignc2FsZV9pdGVtJywgZnVuY3Rpb24gKCRwcm9kdWN0KXsKICAgICAgICAgICAgICAgICAgICAvLyAgICAgcmV0dXJuICRwcm9kdWN0LT5pc19zYWxlX2l0ZW0gPT0gMSA/ICc8YSBjbGFzcz0iYnRuIGJ0bi1zdWNjZXNzIGJ0bi14cyI+WWVzPC9hPicgOiAnPGEgY2xhc3M9ImJ0biBidG4tZGFyayBidG4teHMiPk5vPC9hPic7CiAgICAgICAgICAgICAgICAgICAgLy8gfSkKICAgICAgICAgICAgICAgICAgICAtPmVkaXRDb2x1bW4oJ3N0YXR1cycsIGZ1bmN0aW9uKCRwcm9kdWN0KSB1c2UoJG9wdGlvbnMpewogICAgICAgICAgICAgICAgICAgICAgICAkc3RhdHVzID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCRwcm9kdWN0LT5zdGF0dXMgPT0gJ3BlbmRpbmcnKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCRvcHRpb25zWydQdXJjaGFzZS1EZXBhcnRtZW50J10pewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzdGF0dXMgLj0gJzxhIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi13YXJuaW5nIiAgb25jbGljaz0idG9nZ2xlUHJvZHVjdCgkKHRoaXMpKSIgZGF0YS1wcm9kdWN0LWlkPSInLiRwcm9kdWN0LT5pZC4nIiBkYXRhLXN0YXR1cz0iJy4gJHByb2R1Y3QtPnN0YXR1cyAuJyIgc3R5bGU9ImN1cnNvcjogcG9pbnRlciI+UGVuZGluZzwvYT4nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHN0YXR1cyAuPSAnPGEgY2xhc3M9ImJ0biBidG4teHMgYnRuLXdhcm5pbmciICBkYXRhLXByb2R1Y3QtaWQ9IicuJHByb2R1Y3QtPmlkLiciIGRhdGEtc3RhdHVzPSInLiAkcHJvZHVjdC0+c3RhdHVzIC4nIiBzdHlsZT0iY3Vyc29yOiBwb2ludGVyIj5QZW5kaW5nPC9hPic7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlaWYgKCRwcm9kdWN0LT5zdGF0dXMgPT0gJ2FwcHJvdmVkJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoJG9wdGlvbnNbJ1B1cmNoYXNlLURlcGFydG1lbnQnXSl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHN0YXR1cyAuPSAnPGEgY2xhc3M9ImJ0biBidG4teHMgYnRuLXN1Y2Nlc3MiICBvbmNsaWNrPSJ0b2dnbGVQcm9kdWN0KCQodGhpcykpIiBkYXRhLXByb2R1Y3QtaWQ9IicuJHByb2R1Y3QtPmlkLiciIGRhdGEtc3RhdHVzPSInLiAkcHJvZHVjdC0+c3RhdHVzIC4nIiBzdHlsZT0iY3Vyc29yOiBwb2ludGVyIj5BcHByb3ZlZDwvYT4nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHN0YXR1cyAuPSAnPGEgY2xhc3M9ImJ0biBidG4teHMgYnRuLXN1Y2Nlc3MiICBkYXRhLXByb2R1Y3QtaWQ9IicuJHByb2R1Y3QtPmlkLiciIGRhdGEtc3RhdHVzPSInLiAkcHJvZHVjdC0+c3RhdHVzIC4nIiBzdHlsZT0iY3Vyc29yOiBwb2ludGVyIj5BcHByb3ZlZDwvYT4nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHN0YXR1czsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdhY3Rpb25zJywgZnVuY3Rpb24oJHByb2R1Y3QpIHVzZSgkb3B0aW9ucyl7CiAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCFmcmVlemVQcm9kdWN0KCRwcm9kdWN0KSB8fCBhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnU3VwZXIgQWRtaW4nKSl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnPGEgY2xhc3M9ImJ0biBidG4teHMgYnRuLXN1Y2Nlc3Mgcm91bmRlZC1jaXJjbGUgbWwtMiIgb25jbGljaz0idW5pdENvbnZlcnNpb25zKCQodGhpcykpIiBkYXRhLXByb2R1Y3QtaWQ9IicuJHByb2R1Y3QtPmlkLiciPjxpIGNsYXNzPSJsYXMgbGEtcHJvamVjdC1kaWFncmFtIj48L2k+PC9hPic7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHVybCA9IHJvdXRlKCdwbXMucHJvZHVjdC1tYW5hZ2VtZW50LnByb2R1Y3QuZWRpdCcsICRwcm9kdWN0LT5pZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihyZXF1ZXN0KCktPmhhcygnZml4ZWQtYXNzZXRzJykpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR1cmwgPSB1cmwoJ3Btcy9maXhlZC1hc3NldHMvcHJvZHVjdC9lZGl0LycuJHByb2R1Y3QtPmlkKS4nP2ZpeGVkLWFzc2V0cyc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZWlmKHJlcXVlc3QoKS0+aGFzKCdjd2lwJykpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR1cmwgPSB1cmwoJ3Btcy9jd2lwL3Byb2R1Y3QvJy4kcHJvZHVjdC0+aWQuJy9lZGl0JykuJz9jd2lwJzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZigkb3B0aW9uc1sncHJvZHVjdC1lZGl0J10pewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICc8YSBjbGFzcz0iYnRuIGJ0bi14cyBidG4taW5mbyByb3VuZGVkLWNpcmNsZSBtbC0yIiBocmVmPSInLiR1cmwuJyI+PGkgY2xhc3M9ImxhIGxhLWVkaXQiPjwvaT48L2E+JzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZigkb3B0aW9uc1sncHJvZHVjdC1kZWxldGUnXSAmJiAhZnJlZXplUHJvZHVjdCgkcHJvZHVjdCkpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICc8YSBjbGFzcz0iYnRuIGJ0bi14cyBidG4tZGFuZ2VyIG1sLTIiIG9uY2xpY2s9ImRlbGV0ZUZyb21DUlVEKCQodGhpcykpIiBkYXRhLXNyYz0iJy5yb3V0ZSgncG1zLnByb2R1Y3QtbWFuYWdlbWVudC5wcm9kdWN0LmRlc3Ryb3knLCAkcHJvZHVjdC0+aWQpLiciPjxpIGNsYXNzPSJsYSBsYS10cmFzaCI+PC9pPjwvYT4nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCRvcHRpb25zWydwcm9kdWN0LXN0YW5kYXJkLWNvc3RzJ10pewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICc8YSBjbGFzcz0iYnRuIGJ0bi14cyBidG4tc3VjY2VzcyBtbC0yIG10LTEiIGhyZWY9IicudXJsKCdwbXMvcHJvZHVjdC1tYW5hZ2VtZW50L3Byb2R1Y3QvJy4kcHJvZHVjdC0+aWQuJy9zdGFuZGFyZC1jb3N0cycpLiciPjxpIGNsYXNzPSJsYSBsYS10YXNrcyI+PC9pPjwvYT4nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGFjdGlvbnM7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPnJhd0NvbHVtbnMoWydzdGF0dXMnLCAnYWN0aW9ucycsICdmaW5hbF9hc3NldCcsICdzZXJ2aWNlJywgJ3NhbGVfaXRlbSddKQogICAgICAgICAgICAgICAgICAgIC0+bWFrZSh0cnVlKTsKICAgICAgICAgICAgfQoKCiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5wcm9kdWN0cy5pbmRleCcsIFsKICAgICAgICAgICAgICAgICd0aXRsZScgPT4kdGl0bGUsCiAgICAgICAgICAgICAgICAnaGVhZGVyQ29sdW1ucycgPT4gJHRoaXMtPmhlYWRlckNvbHVtbnMoKQogICAgICAgICAgICBdKTsKICAgICAgICB9Y2F0Y2ggKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgoKICAgIC8qKgogICAgICogU2hvdyB0aGUgZm9ybSBmb3IgY3JlYXRpbmcgYSBuZXcgcmVzb3VyY2UuCiAgICAgKgogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KICAgIHB1YmxpYyBmdW5jdGlvbiBjcmVhdGUoKQogICAgewogICAgICAgIGlmKHJlcXVlc3QoKS0+aGFzKCdnZXQtc3ViLWNhdGVnb3JpZXMnKSl7CiAgICAgICAgICAgIHJldHVybiBjYXRlZ29yeU9wdGlvbnMoW10sIHJlcXVlc3QoKS0+Z2V0KCdjaG9zZW4nKSwgMCwgcmVxdWVzdCgpLT5oYXMoJ2ZpeGVkX2Fzc2V0JyksIHJlcXVlc3QoKS0+aGFzKCdjd2lwJykpOwogICAgICAgIH0KCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgJHByZWZpeCA9IGRhdGUoJ3ltJywgc3RydG90aW1lKGRhdGUoJ1ktbS1kJykpKTsKICAgICAgICAgICAgJHNrdSA9IHVuaXF1ZUNvZGUoMTIsICRwcmVmaXgsICdwcm9kdWN0cycsICdpZCcpOwoKICAgICAgICAgICAgJGRhdGEgPSBbCiAgICAgICAgICAgICAgICAndGl0bGUnID0+ICdOZXcgUHJvZHVjdCcsCiAgICAgICAgICAgICAgICAnc3VwcGxpZXJzJyA9PiBTdXBwbGllcnM6OndoZXJlKCdzdGF0dXMnLCAnQWN0aXZlJyktPnBsdWNrKCduYW1lJywnaWQnKS0+YWxsKCksCiAgICAgICAgICAgICAgICAnYnJhbmRzJyA9PiBCcmFuZDo6cGx1Y2soJ25hbWUnLCdpZCcpLT5hbGwoKSwKICAgICAgICAgICAgICAgICd1bml0JyA9PiBQcm9kdWN0VW5pdDo6cGx1Y2soJ3VuaXRfbmFtZScsJ2lkJyktPmFsbCgpLAogICAgICAgICAgICAgICAgJ3NrdScgPT4gJHNrdSwKICAgICAgICAgICAgICAgICdhdHRyaWJ1dGVzJyA9PiBBdHRyaWJ1dGU6OndpdGgoJ29wdGlvbnMnKS0+Z2V0KCksCiAgICAgICAgICAgICAgICAnYWNjb3VudHMnID0+IGNoYXJ0T2ZBY2NvdW50c09wdGlvbnMoW10sIDAsIDAsIFtdKSwKICAgICAgICAgICAgICAgICdkZXByZWNpYXRpb25NZXRob2RzJyA9PiBjYWxsTW9kdWxlQXBpKCdmaW5hbmNlJywgJ2RlcHJlY2lhdGlvbi1tZXRob2RzJywgWwogICAgICAgICAgICAgICAgICAgICdzdGF0dXMnID0+IDEKICAgICAgICAgICAgICAgIF0pWydkYXRhJ10sCiAgICAgICAgICAgICAgICAnY2F0ZWdvcnlPcHRpb25zJyA9PiBjYXRlZ29yeU9wdGlvbnMoW10sIDAsIDAsIC0xLCAtMSkKICAgICAgICAgICAgXTsKCiAgICAgICAgICAgIC8vIHJldHVybiAkZGF0YVsnY2F0ZWdvcnlPcHRpb25zJ107CiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMucHJvZHVjdHMuY3JlYXRlJywgJGRhdGEpOwogICAgICAgIH1jYXRjaCAoXFRocm93YWJsZSAkdGgpewogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFN0b3JlIGEgbmV3bHkgY3JlYXRlZCByZXNvdXJjZSBpbiBzdG9yYWdlLgogICAgICoKICAgICAqIEBwYXJhbSAgXElsbHVtaW5hdGVcSHR0cFxSZXF1ZXN0ICAkcmVxdWVzdAogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KICAgIHB1YmxpYyBmdW5jdGlvbiBzdG9yZShSZXF1ZXN0ICRyZXF1ZXN0KQogICAgewogICAgICAgICR0aGlzLT52YWxpZGF0ZSgkcmVxdWVzdCwgWwogICAgICAgICAgICAnbmFtZScgPT4gWydyZXF1aXJlZCcsICdzdHJpbmcnLCAnbWF4OjI1NSddLAogICAgICAgICAgICAnY2F0ZWdvcnlfaWQnID0+IFsncmVxdWlyZWQnLCAnc3RyaW5nJywgJ21heDoyNTUnXSwKICAgICAgICAgICAgJ3Byb2R1Y3RfdW5pdF9pZCcgPT4gWydyZXF1aXJlZCcsICdzdHJpbmcnLCAnbWF4OjI1NSddLAogICAgICAgICAgICAvLyAndGF4JyA9PiBbJ3JlcXVpcmVkJywgJ3JlZ2V4Oi9eXGQqKFwuXGR7MSwyfSk/JC8nXSwKICAgICAgICAgICAgJ3ZhdCcgPT4gWydyZXF1aXJlZCcsICdyZWdleDovXlxkKihcLlxkezEsMn0pPyQvJ10sCiAgICAgICAgICAgICd1bml0X3ByaWNlJyA9PiBbJ3JlcXVpcmVkJywgJ3JlZ2V4Oi9eXGQqKFwuXGR7MSwyfSk/JC8nXSwKICAgICAgICAgICAgLy8gJ3NhbGVzX3ByaWNlJyA9PiBbJ3JlcXVpcmVkJywgJ3JlZ2V4Oi9eXGQqKFwuXGR7MSwyfSk/JC8nXSwKICAgICAgICAgICAgJ3NrdScgPT4gWydyZXF1aXJlZCddLAogICAgICAgICAgICAnc3VwcGxpZXInID0+IFsncmVxdWlyZWQnXSwKICAgICAgICBdKTsKCiAgICAgICAgaWYoYXV0aCgpLT51c2VyKCktPmhhc1Blcm1pc3Npb25UbygncHJvZHVjdC1maW5hbmNlLWluZm9ybWF0aW9uJykpewogICAgICAgICAgICAkdGhpcy0+dmFsaWRhdGUoJHJlcXVlc3QsIFsKICAgICAgICAgICAgICAgICdpbnZlbnRvcnlfYWNjb3VudF9pZCcgPT4gWydyZXF1aXJlZCddLAogICAgICAgICAgICAgICAgJ2ludmVudG9yeV9hZGp1c3RtZW50c19hY2NvdW50X2lkJyA9PiBbJ3JlcXVpcmVkJ10sCiAgICAgICAgICAgIF0pOwogICAgICAgIH0KCiAgICAgICAgREI6OmJlZ2luVHJhbnNhY3Rpb24oKTsKICAgICAgICB0cnkgewoKICAgICAgICAgICAgaWYoaXNzZXQoJHJlcXVlc3QtPnBhcmVudF9pZCkgJiYgJHJlcXVlc3QtPnBhcmVudF9pZCA+IDApewogICAgICAgICAgICAgICAgJHBhcmVudCA9IFByb2R1Y3Q6OmZpbmRPckZhaWwoJHJlcXVlc3QtPnBhcmVudF9pZCk7CiAgICAgICAgICAgICAgICBpZigkcmVxdWVzdC0+eWVhcnMgPiAkcGFyZW50LT55ZWFycyl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAiU3ViIEFzc2V0cyBsaWZlIGR1cmF0aW9uICgiLiRyZXF1ZXN0LT55ZWFycy4iKSBjYW5ub3QgYmUgZ3JhdGVyIHRoYW4gTWFpbiBBc3NldCBsaWZlIGR1cmF0aW9uICgiLiRwYXJlbnQtPnllYXJzLiIpIiwKICAgICAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgJHN1cHBsaWVycyA9ICRyZXF1ZXN0LT5zdXBwbGllcjsKICAgICAgICAgICAgJGJ1ZmZlckludmVudG9yeSA9ICRyZXF1ZXN0LT5idWZmZXJfaW52ZW50b3J5OwogICAgICAgICAgICAkaW5wdXRzID0gJHJlcXVlc3QtPmFsbCgpOwogICAgICAgICAgICB1bnNldCgkaW5wdXRzWydfdG9rZW4nXSk7CiAgICAgICAgICAgIHVuc2V0KCRpbnB1dHNbJ19tZXRob2QnXSk7CiAgICAgICAgICAgIHVuc2V0KCRpbnB1dHNbJ3N1cHBsaWVyJ10pOwogICAgICAgICAgICB1bnNldCgkaW5wdXRzWydidWZmZXJfaW52ZW50b3J5J10pOwoKICAgICAgICAgICAgJGlucHV0c1snaXNfZml4ZWRfYXNzZXQnXSA9IDA7CiAgICAgICAgICAgICRpbnB1dHNbJ2lzX2N3aXAnXSA9IDA7CiAgICAgICAgICAgIGlmKCRyZXF1ZXN0LT5wcm9kdWN0X3R5cGUgPT0gJ2ZpeGVkX2Fzc2V0Jyl7CiAgICAgICAgICAgICAgICAkaW5wdXRzWydpc19maXhlZF9hc3NldCddID0gMTsKICAgICAgICAgICAgICAgICRpbnB1dHNbJ2lzX2N3aXAnXSA9IDA7CiAgICAgICAgICAgIH1lbHNlaWYoJHJlcXVlc3QtPnByb2R1Y3RfdHlwZSA9PSAnY3dpcCcpewogICAgICAgICAgICAgICAgJGlucHV0c1snaXNfZml4ZWRfYXNzZXQnXSA9IDA7CiAgICAgICAgICAgICAgICAkaW5wdXRzWydpc19jd2lwJ10gPSAxOwogICAgICAgICAgICB9CgogICAgICAgICAgICAkcHJvZHVjdCA9IFByb2R1Y3Q6OmNyZWF0ZSgkaW5wdXRzKTsKICAgICAgICAgICAgJHByb2R1Y3QtPnN1cHBsaWVycygpLT5zeW5jKCRzdXBwbGllcnMpOwogICAgICAgICAgICBpZiAoJGJ1ZmZlckludmVudG9yeSl7CiAgICAgICAgICAgICAgICAkaW52ZW50b3J5U3VtbWFyeSA9IG5ldyBJbnZlbnRvcnlTdW1tYXJ5KCk7CiAgICAgICAgICAgICAgICAkaW52ZW50b3J5U3VtbWFyeS0+Y2F0ZWdvcnlfaWQgPSAkaW5wdXRzWydjYXRlZ29yeV9pZCddOwogICAgICAgICAgICAgICAgJGludmVudG9yeVN1bW1hcnktPnByb2R1Y3RfaWQgPSAkcHJvZHVjdC0+aWQ7CiAgICAgICAgICAgICAgICAkaW52ZW50b3J5U3VtbWFyeS0+YnVmZmVyX2ludmVudG9yeSA9ICRidWZmZXJJbnZlbnRvcnk7CiAgICAgICAgICAgICAgICAkaW52ZW50b3J5U3VtbWFyeS0+c2F2ZSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZihpc3NldCgkcmVxdWVzdC0+cHJvZHVjdEF0dHJpYnV0ZXNbMF0pKXsKICAgICAgICAgICAgICAgIGZvcmVhY2goJHJlcXVlc3QtPnByb2R1Y3RBdHRyaWJ1dGVzIGFzICRrZXkgPT4gJGF0dHJpYnV0ZV9pZCl7CiAgICAgICAgICAgICAgICAgICAgJHNlcmlhbF9ubyA9IENhdGVnb3J5QXR0cmlidXRlOjp3aGVyZShbCiAgICAgICAgICAgICAgICAgICAgICAgICdjYXRlZ29yeV9pZCcgPT4gJHJlcXVlc3QtPmNhdGVnb3J5X2lkLAogICAgICAgICAgICAgICAgICAgICAgICAnYXR0cmlidXRlX2lkJyA9PiAkYXR0cmlidXRlX2lkCiAgICAgICAgICAgICAgICAgICAgXSktPnN1bSgnc2VyaWFsJyk7CiAgICAgICAgICAgICAgICAgICAgaWYoaXNzZXQoJHJlcXVlc3QtPmF0dHJpYnV0ZV9vcHRpb25faWRbJGF0dHJpYnV0ZV9pZF0pICYmICRyZXF1ZXN0LT5hdHRyaWJ1dGVfb3B0aW9uX2lkWyRhdHRyaWJ1dGVfaWRdICE9IDApewogICAgICAgICAgICAgICAgICAgICAgICBQcm9kdWN0QXR0cmlidXRlOjpjcmVhdGUoWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3Byb2R1Y3RfaWQnID0+ICRwcm9kdWN0LT5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdhdHRyaWJ1dGVfb3B0aW9uX2lkJyA9PiAkcmVxdWVzdC0+YXR0cmlidXRlX29wdGlvbl9pZFskYXR0cmlidXRlX2lkXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdzZXJpYWxfbm8nID0+ICRzZXJpYWxfbm8sCiAgICAgICAgICAgICAgICAgICAgICAgIF0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgJHByb2R1Y3RBdHRyaWJ1dGVzID0gZ2V0UHJvZHVjdEF0dHJpYnV0ZXNGYXN0ZXIoJHByb2R1Y3QpOwoKICAgICAgICAgICAgJHByb2R1Y3RzID0gUHJvZHVjdDo6d2l0aChbCiAgICAgICAgICAgICAgICAnYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24uYXR0cmlidXRlJwogICAgICAgICAgICBdKQogICAgICAgICAgICAtPndoZXJlKFsKICAgICAgICAgICAgICAgIFsnaWQnLCAnIT0nLCAkcHJvZHVjdC0+aWRdLAogICAgICAgICAgICAgICAgWyduYW1lJywgJHByb2R1Y3QtPm5hbWVdLAogICAgICAgICAgICBdKQogICAgICAgICAgICAtPndoZXJlSGFzKCdhdHRyaWJ1dGVzJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgkcHJvZHVjdCkgewogICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZUluKCdhdHRyaWJ1dGVfb3B0aW9uX2lkJywgJHByb2R1Y3QtPmF0dHJpYnV0ZXMtPnBsdWNrKCdhdHRyaWJ1dGVfb3B0aW9uX2lkJyktPnRvQXJyYXkoKSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+Z2V0KCk7CiAgICAgICAgICAgICRjb3VudCA9IDA7CiAgICAgICAgICAgIGlmKGlzc2V0KCRwcm9kdWN0c1swXSkpewogICAgICAgICAgICAgICAgZm9yZWFjaCgkcHJvZHVjdHMgYXMgJGtleSA9PiAkdGhpc19wcm9kdWN0KXsKICAgICAgICAgICAgICAgICAgICBpZigkcHJvZHVjdEF0dHJpYnV0ZXMgPT0gZ2V0UHJvZHVjdEF0dHJpYnV0ZXNGYXN0ZXIoJHRoaXNfcHJvZHVjdCkpewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbWVzc2FnZScgPT4gJHRoaXNfcHJvZHVjdC0+bmFtZS4nICcuZ2V0UHJvZHVjdEF0dHJpYnV0ZXNGYXN0ZXIoJHRoaXNfcHJvZHVjdCkuJyBhbHJlYWR5IGV4aXN0cyEnLAogICAgICAgICAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICRtZXNzYWdlID0gJzxzcGFuIGNsYXNzPSJub3RpZmljYXRpb24tbGlua3MiIGRhdGEtc3JjPSInLnVybCgncG1zL3Byb2R1Y3QtbWFuYWdlbWVudC9wcm9kdWN0LycuJHByb2R1Y3QtPmlkLicvZGV0YWlscycpLiciIGRhdGEtdGl0bGU9IlByb2R1Y3QgRGV0YWlscyI+UHJvZHVjdCAnLiRwcm9kdWN0LT5uYW1lLicgJy4kcHJvZHVjdEF0dHJpYnV0ZXMuJyBpcyB3YWl0aW5nIGZvciBhcHByb3ZhbC48L3NwYW4+JzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBDcmVhdGVPclVwZGF0ZU5vdGlmaWNhdGlvbigkbWVzc2FnZSwndW5yZWFkJywnJyxnZXRNYW5hZ2VySW5mbygnUHVyY2hhc2UtRGVwYXJ0bWVudCcpLCdzZW5kLXRvLXB1cmNoYXNlLWRlcGFydG1lbnQnLCcnKTsKCgogICAgICAgICAgICAvLyB1cGRhdGVTdXBwbGllclByb2R1Y3RzKDEyKTsKICAgICAgICAgICAgREI6OmNvbW1pdCgpOwoKICAgICAgICAgICAgJHByZWZpeCA9IGRhdGUoJ3ltJywgc3RydG90aW1lKGRhdGUoJ1ktbS1kJykpKTsKICAgICAgICAgICAgJHNrdSA9IHVuaXF1ZUNvZGUoMTIsICRwcmVmaXgsICdwcm9kdWN0cycsICdpZCcpOwoKICAgICAgICAgICAgaWYoJHJlcXVlc3QtPndoZXJlX3RvX2dvID09ICdzYXZlJyl7CiAgICAgICAgICAgICAgICBzZXNzaW9uKCktPmZsYXNoKCdhbGVydC10eXBlJywgJ3N1Y2Nlc3MnKTsKICAgICAgICAgICAgICAgIHNlc3Npb24oKS0+Zmxhc2goJ21lc3NhZ2UnLCAiUHJvZHVjdCBoYXMgYmVlbiBhZGRlZCBzdWNjZXNzZnVsbHkiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnID0+IHRydWUsCiAgICAgICAgICAgICAgICAnbmV3JyA9PiAoJHJlcXVlc3QtPndoZXJlX3RvX2dvID09ICdzYXZlLWFuZC1uZXcnKSwKICAgICAgICAgICAgICAgICdza3UnID0+ICRza3UsCiAgICAgICAgICAgICAgICAnbWVzc2FnZScgPT4gIlByb2R1Y3QgaGFzIGJlZW4gYWRkZWQgc3VjY2Vzc2Z1bGx5IiwKICAgICAgICAgICAgXSk7CgogICAgICAgIH1jYXRjaCAoXFRocm93YWJsZSAkdGgpewogICAgICAgICAgICBEQjo6cm9sbGJhY2soKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnID0+IGZhbHNlLAogICAgICAgICAgICAgICAgJ21lc3NhZ2UnID0+ICR0aC0+Z2V0TWVzc2FnZSgpLAogICAgICAgICAgICBdKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBEaXNwbGF5IHRoZSBzcGVjaWZpZWQgcmVzb3VyY2UuCiAgICAgKgogICAgICogQHBhcmFtICBpbnQgICRpZAogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KICAgIHB1YmxpYyBmdW5jdGlvbiBzaG93KFByb2R1Y3QgJHByb2R1Y3QpCiAgICB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgJHByb2R1Y3QtPnNyYyA9IHJvdXRlKCdwbXMucHJvZHVjdC1tYW5hZ2VtZW50LnByb2R1Y3QudXBkYXRlJywkcHJvZHVjdC0+aWQpOwogICAgICAgICAgICAkcHJvZHVjdC0+cmVxX3R5cGUgPSAncHV0JzsKICAgICAgICAgICAgJHN1cHBsaWVycyA9IFtdOwogICAgICAgICAgICBmb3JlYWNoICgkcHJvZHVjdC0+c3VwcGxpZXJzIGFzICRzdXBwbGllcil7CiAgICAgICAgICAgICAgICAkc3VwcGxpZXJzW10gPSAkc3VwcGxpZXItPmlkOwogICAgICAgICAgICB9CgogICAgICAgICAgICAkcHJvZHVjdC0+c3VwcGxpZXIgPSAkc3VwcGxpZXJzOwogICAgICAgICAgICAkcHJvZHVjdC0+YnVmZmVyX2ludmVudG9yeSA9ICRwcm9kdWN0LT5yZWxJbnZlbnRvcnlTdW1tYXJ5PyRwcm9kdWN0LT5yZWxJbnZlbnRvcnlTdW1tYXJ5LT5idWZmZXJfaW52ZW50b3J5Om51bGw7CiAgICAgICAgICAgICRkYXRhID0gWwogICAgICAgICAgICAgICAgJ3N0YXR1cycgPT4gJ3N1Y2Nlc3MnLAogICAgICAgICAgICAgICAgJ2luZm8nID0+ICRwcm9kdWN0CiAgICAgICAgICAgIF07CgogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbigkZGF0YSk7CiAgICAgICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgICRkYXRhID0gWwogICAgICAgICAgICAgICAgJ3N0YXR1cycgPT4gbnVsbCwKICAgICAgICAgICAgICAgICdpbmZvJyA9PiAkdGgtPmdldE1lc3NhZ2UoKQogICAgICAgICAgICBdOwogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbigkZGF0YSk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogU2hvdyB0aGUgZm9ybSBmb3IgZWRpdGluZyB0aGUgc3BlY2lmaWVkIHJlc291cmNlLgogICAgICoKICAgICAqIEBwYXJhbSAgaW50ICAkaWQKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCiAgICBwdWJsaWMgZnVuY3Rpb24gZWRpdCgkaWQpCiAgICB7CiAgICAgICAgJHByb2R1Y3QgPSBQcm9kdWN0Ojp3aXRoKFsKICAgICAgICAgICAgJ2F0dHJpYnV0ZXMuYXR0cmlidXRlT3B0aW9uLmF0dHJpYnV0ZScsCiAgICAgICAgICAgICdzdXBwbGllcnMnCiAgICAgICAgXSktPmZpbmRPckZhaWwoJGlkKTsKICAgICAgICBpZihmcmVlemVQcm9kdWN0KCRwcm9kdWN0KSAmJiAhYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ1N1cGVyIEFkbWluJykpewogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoIlByb2R1Y3QgIyIuJHByb2R1Y3QtPm5hbWUuIiAiLmdldFByb2R1Y3RBdHRyaWJ1dGVzRmFzdGVyKCRwcm9kdWN0KS4iIENhbm5vdCBCZSBFZGl0ZWQhIik7CiAgICAgICAgfQoKICAgICAgICB0cnkgewogICAgICAgICAgICAkY2F0ZWdvcnlBdHRyaWJ1dGVzID0gQ2F0ZWdvcnlBdHRyaWJ1dGU6OndoZXJlKCdjYXRlZ29yeV9pZCcsICRwcm9kdWN0LT5jYXRlZ29yeV9pZCktPmdldCgpOwogICAgICAgICAgICAkYXR0cmlidXRlcyA9IFtdOwogICAgICAgICAgICAkYXR0cmlidXRlT3B0aW9ucyA9IFtdOwogICAgICAgICAgICBpZihpc3NldCgkY2F0ZWdvcnlBdHRyaWJ1dGVzWzBdKSl7CiAgICAgICAgICAgICAgICBmb3JlYWNoKCRjYXRlZ29yeUF0dHJpYnV0ZXMgYXMgJGtleSA9PiAkY2F0ZWdvcnlBdHRyaWJ1dGUpewogICAgICAgICAgICAgICAgICAgIGFycmF5X3B1c2goJGF0dHJpYnV0ZXMsICRjYXRlZ29yeUF0dHJpYnV0ZS0+YXR0cmlidXRlX2lkKTsKICAgICAgICAgICAgICAgICAgICAkYXR0cmlidXRlT3B0aW9ucyA9IGFycmF5X21lcmdlKCRhdHRyaWJ1dGVPcHRpb25zLCAoaXNfYXJyYXkoanNvbl9kZWNvZGUoJGNhdGVnb3J5QXR0cmlidXRlLT5vcHRpb25zLCB0cnVlKSkgPyBqc29uX2RlY29kZSgkY2F0ZWdvcnlBdHRyaWJ1dGUtPm9wdGlvbnMsIHRydWUpIDogW10pKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgJGRhdGEgPSBbCiAgICAgICAgICAgICAgICAndGl0bGUnID0+ICdFZGl0IFByb2R1Y3QnLAogICAgICAgICAgICAgICAgJ2NhdGVnb3JpZXMnID0+IENhdGVnb3J5OjphbGwoKSwKICAgICAgICAgICAgICAgICdzdXBwbGllcnMnID0+IFN1cHBsaWVyczo6d2hlcmUoJ3N0YXR1cycsICdBY3RpdmUnKS0+Z2V0KFsnaWQnLCAnbmFtZSddKSwKICAgICAgICAgICAgICAgICdicmFuZHMnID0+IEJyYW5kOjpwbHVjaygnbmFtZScsJ2lkJyktPmFsbCgpLAogICAgICAgICAgICAgICAgJ3VuaXQnID0+IFByb2R1Y3RVbml0OjpwbHVjaygndW5pdF9uYW1lJywnaWQnKS0+YWxsKCksCiAgICAgICAgICAgICAgICAnYXR0cmlidXRlcycgPT4gQXR0cmlidXRlOjp3aXRoKCdvcHRpb25zJyktPmdldCgpLAogICAgICAgICAgICAgICAgJ3Byb2R1Y3QnID0+ICRwcm9kdWN0LAogICAgICAgICAgICAgICAgJ3Byb2R1Y3RBdHRyaWJ1dGVzJyA9PiAkcHJvZHVjdC0+YXR0cmlidXRlcy0+cGx1Y2soJ2F0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGVfaWQnKS0+dG9BcnJheSgpLAogICAgICAgICAgICAgICAgJ2V4aXN0ZWRTdXBwbGllcnMnID0+ICRwcm9kdWN0LT5zdXBwbGllcnMtPnBsdWNrKCdwaXZvdC5zdXBwbGllcl9pZCcpLT50b0FycmF5KCksCiAgICAgICAgICAgICAgICAnY2F0ZWdvcnlPcHRpb25zJyA9PiBjYXRlZ29yeU9wdGlvbnMoW10sICRwcm9kdWN0LT5jYXRlZ29yeV9pZCwgMCwgLTEsIC0xKSwKICAgICAgICAgICAgICAgICdjYXRlZ29yeUF0dHJpYnV0ZXMnID0+ICRhdHRyaWJ1dGVzLAogICAgICAgICAgICAgICAgJ2NhdGVnb3J5QXR0cmlidXRlT3B0aW9ucycgPT4gJGF0dHJpYnV0ZU9wdGlvbnMsCgogICAgICAgICAgICAgICAgJ2NoYXJ0T2ZBY2NvdW50c09wdGlvbnMnID0+IGNoYXJ0T2ZBY2NvdW50c09wdGlvbnMoW10sIDAsIDAsIFtdKSwKICAgICAgICAgICAgICAgICdkZXByZWNpYXRpb25NZXRob2RzJyA9PiBjYWxsTW9kdWxlQXBpKCdmaW5hbmNlJywgJ2RlcHJlY2lhdGlvbi1tZXRob2RzJywgWwogICAgICAgICAgICAgICAgICAgICdzdGF0dXMnID0+IDEKICAgICAgICAgICAgICAgIF0pWydkYXRhJ10sCiAgICAgICAgICAgICAgICAnY2F0ZWdvcnlfdHlwZScgPT4gKCRwcm9kdWN0LT5jYXRlZ29yeS0+aXNfZml4ZWRfYXNzZXQgPT0gMSA/ICdmaXhlZF9hc3NldCcgOiAoJHByb2R1Y3QtPmNhdGVnb3J5LT5pc19jd2lwID09IDEgPyAnY3dpcCcgOiAncHJvZHVjdHMnKSksCiAgICAgICAgICAgICAgICAncHJvZHVjdF90eXBlJyA9PiAoJHByb2R1Y3QtPmlzX2ZpeGVkX2Fzc2V0ID09IDEgPyAnZml4ZWRfYXNzZXQnIDogKCRwcm9kdWN0LT5pc19jd2lwID09IDEgPyAnY3dpcCcgOiAncHJvZHVjdHMnKSksCiAgICAgICAgICAgIF07CiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMucHJvZHVjdHMuZWRpdCcsICRkYXRhKTsKICAgICAgICB9Y2F0Y2ggKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBVcGRhdGUgdGhlIHNwZWNpZmllZCByZXNvdXJjZSBpbiBzdG9yYWdlLgogICAgICoKICAgICAqIEBwYXJhbSAgXElsbHVtaW5hdGVcSHR0cFxSZXF1ZXN0ICAkcmVxdWVzdAogICAgICogQHBhcmFtICBpbnQgICRpZAogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KICAgIHB1YmxpYyBmdW5jdGlvbiB1cGRhdGUoUmVxdWVzdCAkcmVxdWVzdCwgUHJvZHVjdCAkcHJvZHVjdCkKICAgIHsKICAgICAgICBpZighYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ0VtcGxveWVlJykpewogICAgICAgICAgICAkdGhpcy0+dmFsaWRhdGUoJHJlcXVlc3QsIFsKICAgICAgICAgICAgICAgICdza3UnID0+IFsncmVxdWlyZWQnXSwKICAgICAgICAgICAgICAgICduYW1lJyA9PiBbJ3JlcXVpcmVkJywgJ3N0cmluZycsICdtYXg6MjU1J10sCiAgICAgICAgICAgICAgICAnY2F0ZWdvcnlfaWQnID0+IFsncmVxdWlyZWQnLCAnc3RyaW5nJywgJ21heDoyNTUnXSwKICAgICAgICAgICAgXSk7CiAgICAgICAgfQoKICAgICAgICAkdGhpcy0+dmFsaWRhdGUoJHJlcXVlc3QsIFsKICAgICAgICAgICAgJ3Byb2R1Y3RfdW5pdF9pZCcgPT4gWydyZXF1aXJlZCcsICdzdHJpbmcnLCAnbWF4OjI1NSddLAogICAgICAgICAgICAndW5pdF9wcmljZScgPT4gWydyZXF1aXJlZCcsICdyZWdleDovXlxkKihcLlxkezEsMn0pPyQvJ10sCiAgICAgICAgICAgIC8vICdzYWxlc19wcmljZScgPT4gWydyZXF1aXJlZCcsICdyZWdleDovXlxkKihcLlxkezEsMn0pPyQvJ10sCiAgICAgICAgICAgIC8vICd0YXgnID0+IFsncmVxdWlyZWQnLCAncmVnZXg6L15cZCooXC5cZHsxLDJ9KT8kLyddLAogICAgICAgICAgICAndmF0JyA9PiBbJ3JlcXVpcmVkJywgJ3JlZ2V4Oi9eXGQqKFwuXGR7MSwyfSk/JC8nXSwKICAgICAgICAgICAgJ3N1cHBsaWVyJyA9PiBbJ3JlcXVpcmVkJ10sCiAgICAgICAgXSk7CgogICAgICAgIGlmKGF1dGgoKS0+dXNlcigpLT5oYXNQZXJtaXNzaW9uVG8oJ3Byb2R1Y3QtZmluYW5jZS1pbmZvcm1hdGlvbicpKXsKICAgICAgICAgICAgJHRoaXMtPnZhbGlkYXRlKCRyZXF1ZXN0LCBbCiAgICAgICAgICAgICAgICAnaW52ZW50b3J5X2FjY291bnRfaWQnID0+IFsncmVxdWlyZWQnXSwKICAgICAgICAgICAgICAgIC8vICdjb2dzX2FjY291bnRfaWQnID0+IFsncmVxdWlyZWQnXSwKICAgICAgICAgICAgICAgICdpbnZlbnRvcnlfYWRqdXN0bWVudHNfYWNjb3VudF9pZCcgPT4gWydyZXF1aXJlZCddLAogICAgICAgICAgICBdKTsKICAgICAgICB9CgogICAgICAgIGlmKGZyZWV6ZVByb2R1Y3QoJHByb2R1Y3QpICYmICFhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnU3VwZXIgQWRtaW4nKSl7CiAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiBmYWxzZSwKICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAiUHJvZHVjdCAjIi4kcHJvZHVjdC0+bmFtZS4iICIuZ2V0UHJvZHVjdEF0dHJpYnV0ZXNGYXN0ZXIoJHByb2R1Y3QpLiIgQ2Fubm90IEJlIEVkaXRlZCEiCiAgICAgICAgICAgIF0pOwogICAgICAgIH0KCiAgICAgICAgREI6OmJlZ2luVHJhbnNhY3Rpb24oKTsKICAgICAgICB0cnkgewogICAgICAgICAgICBpZihpc3NldCgkcmVxdWVzdC0+cGFyZW50X2lkKSAmJiAkcmVxdWVzdC0+cGFyZW50X2lkID4gMCl7CiAgICAgICAgICAgICAgICAkcGFyZW50ID0gUHJvZHVjdDo6ZmluZE9yRmFpbCgkcmVxdWVzdC0+cGFyZW50X2lkKTsKICAgICAgICAgICAgICAgIGlmKCRyZXF1ZXN0LT55ZWFycyA+ICRwYXJlbnQtPnllYXJzKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgJ21lc3NhZ2UnID0+ICJTdWIgQXNzZXRzIGxpZmUgZHVyYXRpb24gKCIuJHJlcXVlc3QtPnllYXJzLiIpIGNhbm5vdCBiZSBncmF0ZXIgdGhhbiBNYWluIEFzc2V0IGxpZmUgZHVyYXRpb24gKCIuJHBhcmVudC0+eWVhcnMuIikiCiAgICAgICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICRzdXBwbGllcnMgPSAkcmVxdWVzdC0+c3VwcGxpZXI7CiAgICAgICAgICAgICRidWZmZXJJbnZlbnRvcnkgPSAkcmVxdWVzdC0+YnVmZmVyX2ludmVudG9yeTsKICAgICAgICAgICAgJGlucHV0cyA9ICRyZXF1ZXN0LT5hbGwoKTsKICAgICAgICAgICAgdW5zZXQoJGlucHV0c1snX3Rva2VuJ10pOwogICAgICAgICAgICB1bnNldCgkaW5wdXRzWydfbWV0aG9kJ10pOwogICAgICAgICAgICB1bnNldCgkaW5wdXRzWydzdXBwbGllciddKTsKICAgICAgICAgICAgdW5zZXQoJGlucHV0c1snYnVmZmVyX2ludmVudG9yeSddKTsKCiAgICAgICAgICAgICRpbnB1dHNbJ2lzX2ZpeGVkX2Fzc2V0J10gPSAwOwogICAgICAgICAgICAkaW5wdXRzWydpc19jd2lwJ10gPSAwOwogICAgICAgICAgICBpZigkcmVxdWVzdC0+cHJvZHVjdF90eXBlID09ICdmaXhlZF9hc3NldCcpewogICAgICAgICAgICAgICAgJGlucHV0c1snaXNfZml4ZWRfYXNzZXQnXSA9IDE7CiAgICAgICAgICAgICAgICAkaW5wdXRzWydpc19jd2lwJ10gPSAwOwogICAgICAgICAgICB9ZWxzZWlmKCRyZXF1ZXN0LT5wcm9kdWN0X3R5cGUgPT0gJ2N3aXAnKXsKICAgICAgICAgICAgICAgICRpbnB1dHNbJ2lzX2ZpeGVkX2Fzc2V0J10gPSAwOwogICAgICAgICAgICAgICAgJGlucHV0c1snaXNfY3dpcCddID0gMTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgJHByb2R1Y3QtPnVwZGF0ZSgkaW5wdXRzKTsKICAgICAgICAgICAgJHByb2R1Y3QtPnN1cHBsaWVycygpLT5zeW5jKCRzdXBwbGllcnMpOwogICAgICAgICAgICBpZiAoJGJ1ZmZlckludmVudG9yeSl7CiAgICAgICAgICAgICAgICBpZiAoJHByb2R1Y3QtPnJlbEludmVudG9yeVN1bW1hcnkpewogICAgICAgICAgICAgICAgICAgICRpbnZlbnRvcnlTdW1tYXJ5ID0gJHByb2R1Y3QtPnJlbEludmVudG9yeVN1bW1hcnk7CiAgICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICAgICAkaW52ZW50b3J5U3VtbWFyeSA9IG5ldyBJbnZlbnRvcnlTdW1tYXJ5KCk7CiAgICAgICAgICAgICAgICAgICAgJGludmVudG9yeVN1bW1hcnktPmNhdGVnb3J5X2lkID0gJGlucHV0c1snY2F0ZWdvcnlfaWQnXTsKICAgICAgICAgICAgICAgICAgICAkaW52ZW50b3J5U3VtbWFyeS0+cHJvZHVjdF9pZCA9ICRwcm9kdWN0LT5pZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICRpbnZlbnRvcnlTdW1tYXJ5LT5idWZmZXJfaW52ZW50b3J5ID0gJGJ1ZmZlckludmVudG9yeTsKICAgICAgICAgICAgICAgICRpbnZlbnRvcnlTdW1tYXJ5LT5zYXZlKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIFByb2R1Y3RBdHRyaWJ1dGU6OndoZXJlKCdwcm9kdWN0X2lkJywgJHByb2R1Y3QtPmlkKS0+ZGVsZXRlKCk7CiAgICAgICAgICAgIGlmKGlzc2V0KCRyZXF1ZXN0LT5wcm9kdWN0QXR0cmlidXRlc1swXSkpewogICAgICAgICAgICAgICAgZm9yZWFjaCgkcmVxdWVzdC0+cHJvZHVjdEF0dHJpYnV0ZXMgYXMgJGtleSA9PiAkYXR0cmlidXRlX2lkKXsKICAgICAgICAgICAgICAgICAgICAkc2VyaWFsX25vID0gQ2F0ZWdvcnlBdHRyaWJ1dGU6OndoZXJlKFsKICAgICAgICAgICAgICAgICAgICAgICAgJ2NhdGVnb3J5X2lkJyA9PiAkcmVxdWVzdC0+Y2F0ZWdvcnlfaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICdhdHRyaWJ1dGVfaWQnID0+ICRhdHRyaWJ1dGVfaWQKICAgICAgICAgICAgICAgICAgICBdKS0+c3VtKCdzZXJpYWwnKTsKICAgICAgICAgICAgICAgICAgICBpZihpc3NldCgkcmVxdWVzdC0+YXR0cmlidXRlX29wdGlvbl9pZFskYXR0cmlidXRlX2lkXSkgJiYgJHJlcXVlc3QtPmF0dHJpYnV0ZV9vcHRpb25faWRbJGF0dHJpYnV0ZV9pZF0gIT0gMCl7CiAgICAgICAgICAgICAgICAgICAgICAgIFByb2R1Y3RBdHRyaWJ1dGU6OmNyZWF0ZShbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAncHJvZHVjdF9pZCcgPT4gJHByb2R1Y3QtPmlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2F0dHJpYnV0ZV9vcHRpb25faWQnID0+ICRyZXF1ZXN0LT5hdHRyaWJ1dGVfb3B0aW9uX2lkWyRhdHRyaWJ1dGVfaWRdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3NlcmlhbF9ubycgPT4gJHNlcmlhbF9ubywKICAgICAgICAgICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgoKCiAgICAgICAgICAgICRwcm9kdWN0cyA9IFByb2R1Y3Q6OndpdGgoWwogICAgICAgICAgICAgICAgJ2F0dHJpYnV0ZXMuYXR0cmlidXRlT3B0aW9uLmF0dHJpYnV0ZScKICAgICAgICAgICAgXSkKICAgICAgICAgICAgLT53aGVyZShbCiAgICAgICAgICAgICAgICBbJ2lkJywgJyE9JywgJHByb2R1Y3QtPmlkXSwKICAgICAgICAgICAgICAgIFsnbmFtZScsICRwcm9kdWN0LT5uYW1lXSwKICAgICAgICAgICAgXSkKICAgICAgICAgICAgLT53aGVyZUhhcygnYXR0cmlidXRlcycsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJHByb2R1Y3QpIHsKICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmVJbignYXR0cmlidXRlX29wdGlvbl9pZCcsICRwcm9kdWN0LT5hdHRyaWJ1dGVzLT5wbHVjaygnYXR0cmlidXRlX29wdGlvbl9pZCcpLT50b0FycmF5KCkpOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPmdldCgpOwogICAgICAgICAgICAkY291bnQgPSAwOwogICAgICAgICAgICBpZihpc3NldCgkcHJvZHVjdHNbMF0pKXsKICAgICAgICAgICAgICAgIGZvcmVhY2goJHByb2R1Y3RzIGFzICRrZXkgPT4gJHRoaXNfcHJvZHVjdCl7CiAgICAgICAgICAgICAgICAgICAgaWYoZ2V0UHJvZHVjdEF0dHJpYnV0ZXNGYXN0ZXIoJHByb2R1Y3QpID09IGdldFByb2R1Y3RBdHRyaWJ1dGVzRmFzdGVyKCR0aGlzX3Byb2R1Y3QpKXsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnID0+IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ21lc3NhZ2UnID0+ICR0aGlzX3Byb2R1Y3QtPm5hbWUuJyAnLmdldFByb2R1Y3RBdHRyaWJ1dGVzRmFzdGVyKCR0aGlzX3Byb2R1Y3QpLicgYWxyZWFkeSBleGlzdHMhJywKICAgICAgICAgICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyB1cGRhdGVTdXBwbGllclByb2R1Y3RzKDEyKTsKICAgICAgICAgICAgREI6OmNvbW1pdCgpOwoKICAgICAgICAgICAgc2Vzc2lvbigpLT5mbGFzaCgnYWxlcnQtdHlwZScsICdzdWNjZXNzJyk7CiAgICAgICAgICAgIHNlc3Npb24oKS0+Zmxhc2goJ21lc3NhZ2UnLCAnUHJvZHVjdCBoYXMgYmVlbiB1cGRhdGVkIHN1Y2Nlc3NmdWxseScpOwogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gdHJ1ZSwKICAgICAgICAgICAgICAgICd1cmwnID0+IHVybCgncG1zL3Byb2R1Y3QtbWFuYWdlbWVudC9wcm9kdWN0JykKICAgICAgICAgICAgXSk7CiAgICAgICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgIERCOjpyb2xsYmFjaygpOwogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gdHJ1ZSwKICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAkdGgtPmdldE1lc3NhZ2UoKQogICAgICAgICAgICBdKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBSZW1vdmUgdGhlIHNwZWNpZmllZCByZXNvdXJjZSBmcm9tIHN0b3JhZ2UuCiAgICAgKgogICAgICogQHBhcmFtICBpbnQgICRpZAogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KICAgIHB1YmxpYyBmdW5jdGlvbiBkZXN0cm95KFByb2R1Y3QgJHByb2R1Y3QpCiAgICB7CiAgICAgICAgaWYoZnJlZXplUHJvZHVjdCgkcHJvZHVjdCkpewogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gZmFsc2UsCiAgICAgICAgICAgICAgICAnbWVzc2FnZScgPT4gIlByb2R1Y3QgIyIuJHByb2R1Y3QtPm5hbWUuIiAiLmdldFByb2R1Y3RBdHRyaWJ1dGVzRmFzdGVyKCRwcm9kdWN0KS4iIENhbm5vdCBCZSBEZWxldGVkISIKICAgICAgICAgICAgXSk7CiAgICAgICAgfQoKICAgICAgICB0cnkgewogICAgICAgICAgICAkcHJvZHVjdC0+c3VwcGxpZXJzKCktPnN5bmMoW10pOwogICAgICAgICAgICBQcm9kdWN0QXR0cmlidXRlOjp3aGVyZSgncHJvZHVjdF9pZCcsICRwcm9kdWN0LT5pZCktPmRlbGV0ZSgpOwogICAgICAgICAgICAkcHJvZHVjdC0+ZGVsZXRlKCk7CiAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiB0cnVlCiAgICAgICAgICAgIF0pOwogICAgICAgIH1jYXRjaCAoXFRocm93YWJsZSAkdGgpewogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gZmFsc2UsCiAgICAgICAgICAgICAgICAnbWVzc2FnZScgPT4gJHRoLT5nZXRNZXNzYWdlKCkKICAgICAgICAgICAgXSk7CiAgICAgICAgfQogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBpbXBvcnRQcm9kdWN0U2FtcGxlKCl7CiAgICAgICAgJGRhdGEgPSBbCiAgICAgICAgICAgICdhdHRyaWJ1dGVzJyA9PiBBdHRyaWJ1dGU6OmdldChbJ2lkJywnbmFtZSddKSwKICAgICAgICAgICAgJ2NhdGVnb3J5JyA9PiBDYXRlZ29yeTo6aGFzKCdjYXRlZ29yeScpLT5pblJhbmRvbU9yZGVyKCktPmZpcnN0KFsnY29kZSddKSwKICAgICAgICAgICAgJ2JyYW5kJyA9PiBCcmFuZDo6aW5SYW5kb21PcmRlcigpLT5maXJzdChbJ2NvZGUnXSksCiAgICAgICAgICAgICd1bml0JyA9PiBQcm9kdWN0VW5pdDo6aW5SYW5kb21PcmRlcigpLT5maXJzdChbJ3VuaXRfbmFtZSddKSwKICAgICAgICAgICAgJ3N1cHBsaWVyX21vYmlsZScgPT4gU3VwcGxpZXJzOjp3aGVyZSgnc3RhdHVzJywgJ0FjdGl2ZScpLT5pblJhbmRvbU9yZGVyKCktPnRha2UoJzMnKS0+cGx1Y2soJ21vYmlsZV9ubycpLT5pbXBsb2RlKCcsJykKICAgICAgICBdOwoKICAgICAgICByZXR1cm4gRXhjZWw6OmRvd25sb2FkKG5ldyBcQXBwXEV4cG9ydHNcUE1TXFByb2R1Y3RTYW1wbGUoJGRhdGEpLCAnUHJvZHVjdCBVcGxvYWQgU2FtcGxlLnhsc3gnKTsKICAgIH0KCiAgICBwdWJsaWMgZnVuY3Rpb24gaW1wb3J0UHJvZHVjdChSZXF1ZXN0ICRyZXF1ZXN0KQogICAgewogICAgICAgICR0aGlzLT52YWxpZGF0ZSgkcmVxdWVzdCwgWwogICAgICAgICAgICAncHJvZHVjdF9maWxlJyAgPT4gJ21pbWVzOnhscyx4bHN4JwogICAgICAgIF0pOwoKICAgICAgICAvLyRwYXRoID0gJHJlcXVlc3QtPmZpbGUoJ3Byb2R1Y3RfZmlsZScpLT5nZXRSZWFsUGF0aCgpOwoKICAgICAgICB0cnkgewoKICAgICAgICAgICAgRXhjZWw6OmltcG9ydChuZXcgUHJvZHVjdEltcG9ydCwgJHJlcXVlc3QtPnByb2R1Y3RfZmlsZSk7CgogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoU3VjY2VzcygnRXhjZWwgRGF0YSBJbXBvcnRlZCBzdWNjZXNzZnVsbHkuJyk7CgogICAgICAgIH1jYXRjaCAoXE1hYXR3ZWJzaXRlXEV4Y2VsXFZhbGlkYXRvcnNcVmFsaWRhdGlvbkV4Y2VwdGlvbiAkZSkgewogICAgICAgICAgICAkZmFpbHVyZXMgPSAkZS0+ZmFpbHVyZXMoKTsKICAgICAgICAgICAgJGVycm9yPVtdOwogICAgICAgICAgICBmb3JlYWNoICgkZmFpbHVyZXMgYXMgJGZhaWx1cmUpIHsKICAgICAgICAgICAgICAgICRmYWlsdXJlLT5yb3coKTsgCiAgICAgICAgICAgICAgICAkZmFpbHVyZS0+YXR0cmlidXRlKCk7IAogICAgICAgICAgICAgICAgJGVycm9yW109JGZhaWx1cmUtPmVycm9ycygpOyAKICAgICAgICAgICAgICAgICRmYWlsdXJlLT52YWx1ZXMoKTsgCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkZXJyb3JbMF1bMF0pOwogICAgICAgIH0KICAgIH0KCiAgICBwdWJsaWMgZnVuY3Rpb24gdG9nZ2xlKFJlcXVlc3QgJHJlcXVlc3QsICRpZCkKICAgIHsKICAgICAgICAkcHJvZHVjdCA9IFByb2R1Y3Q6OndpdGgoWydhdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGUnXSktPmZpbmRPckZhaWwoJGlkKTsKICAgICAgICAkcHJvZHVjdC0+c3RhdHVzID0gKCRwcm9kdWN0LT5zdGF0dXMgPT0gJ3BlbmRpbmcnID8gJ2FwcHJvdmVkJyA6ICdwZW5kaW5nJyk7CiAgICAgICAgJHByb2R1Y3QtPnNhdmUoKTsKCiAgICAgICAgaWYoJHByb2R1Y3QpewogICAgICAgICAgICBpZigkcHJvZHVjdC0+c3RhdHVzID09ICdhcHByb3ZlZCcpewogICAgICAgICAgICAgICAgJG1lc3NhZ2U9ICc8c3BhbiBjbGFzcz0ibm90aWZpY2F0aW9uLWxpbmtzIiBkYXRhLXNyYz0iJy51cmwoJ3Btcy9wcm9kdWN0LW1hbmFnZW1lbnQvcHJvZHVjdC8nLiRwcm9kdWN0LT5pZC4nL2RldGFpbHMnKS4nIiBkYXRhLXRpdGxlPSJQcm9kdWN0IERldGFpbHMiPlByb2R1Y3QgJy4kcHJvZHVjdC0+bmFtZS4nICcuZ2V0UHJvZHVjdEF0dHJpYnV0ZXNGYXN0ZXIoJHByb2R1Y3QpLicgaGFzIGJlZW4gYXBwcm92ZWQuPC9zcGFuPic7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIENyZWF0ZU9yVXBkYXRlTm90aWZpY2F0aW9uKCRtZXNzYWdlLCd1bnJlYWQnLCcnLCRwcm9kdWN0LT5jcmVhdGVkX2J5LCdzZW5kLXRvLWVtcGxveWVlJywnJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiB0cnVlLAogICAgICAgICAgICAgICAgJ21lc3NhZ2UnID0+ICJQcm9kdWN0IGhhcyBiZWVuICIudWN3b3JkcygkcHJvZHVjdC0+c3RhdHVzKSwKICAgICAgICAgICAgICAgICJidXR0b24iID0+ICc8YSBjbGFzcz0iYnRuIGJ0bi14cyBidG4tJy4oJHByb2R1Y3QtPnN0YXR1cyA9PSAncGVuZGluZycgPyAnd2FybmluZycgOiAnc3VjY2VzcycpLiciICcuKGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdQdXJjaGFzZS1EZXBhcnRtZW50JykgPyAnb25jbGljaz0idG9nZ2xlUHJvZHVjdCgkKHRoaXMpKSInIDogJycpLicgZGF0YS1wcm9kdWN0LWlkPSInLiRwcm9kdWN0LT5pZC4nIiBkYXRhLXN0YXR1cz0iJy4kcHJvZHVjdC0+c3RhdHVzLiciIHN0eWxlPSJjdXJzb3I6IHBvaW50ZXIiPicudWN3b3JkcygkcHJvZHVjdC0+c3RhdHVzKS4nPC9hPicsIAogICAgICAgICAgICBdKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAgICAgJ3N1Y2Nlc3MnID0+IGZhbHNlLAogICAgICAgICAgICAnbWVzc2FnZScgPT4gIlNvbWV0aGluZyB3ZW50IHdyb25nISIKICAgICAgICBdKTsKICAgIH0KCiAgICBwdWJsaWMgZnVuY3Rpb24gZGV0YWlscyAoJHByb2R1Y3RfaWQpCiAgICB7CiAgICAgICAgJHByb2R1Y3QgPSBQcm9kdWN0OjpmaW5kT3JGYWlsKCRwcm9kdWN0X2lkKTsKICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMucHJvZHVjdHMuZGV0YWlscycsIGNvbXBhY3QoJ3Byb2R1Y3QnKSk7CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIGdldFN1YkFzc2V0cygkaWQpCiAgICB7CiAgICAgICAgJHByb2R1Y3RzID0gUHJvZHVjdDo6d2l0aChbCiAgICAgICAgICAgICdhdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGUnCiAgICAgICAgXSkKICAgICAgICAtPndoZXJlKFsKICAgICAgICAgICAgJ2NhdGVnb3J5X2lkJyA9PiAkaWQsCiAgICAgICAgICAgICdwYXJlbnRfaWQnID0+IDAKICAgICAgICBdKS0+Z2V0KCk7CiAgICAgICAgJHJlc3BvbnNlID0gJzxvcHRpb24gdmFsdWU9IjAiIGRhdGEtY29kZT0iIj5OL0E8L29wdGlvbj4nOwogICAgICAgIGlmKGlzc2V0KCRwcm9kdWN0c1swXSkpewogICAgICAgICAgICBmb3JlYWNoICgkcHJvZHVjdHMgYXMgJGtleSA9PiAkcHJvZHVjdCkgewogICAgICAgICAgICAgICAgJHN1YkFzc2V0cyA9ICgkcHJvZHVjdC0+c3ViQXNzZXRzLT5jb3VudCgpKzEpOwogICAgICAgICAgICAgICAgJGNvZGUgPSAoJHByb2R1Y3QtPnNrdS4nLScuKCRzdWJBc3NldHMgPCA5ID8gJzAnIDogJycpLiRzdWJBc3NldHMpOwogICAgICAgICAgICAgICAgJHJlc3BvbnNlIC49ICc8b3B0aW9uIHZhbHVlPSInLiRwcm9kdWN0LT5pZC4nIiBkYXRhLWNvZGU9IicuJGNvZGUuJyIgJy4ocmVxdWVzdCgpLT5nZXQoJ3NlbGVjdGVkJykgPT0gJHByb2R1Y3QtPmlkID8gJ3NlbGVjdGVkJyA6ICcnKS4nPicuJHByb2R1Y3QtPm5hbWUuJyAnLmdldFByb2R1Y3RBdHRyaWJ1dGVzRmFzdGVyKCRwcm9kdWN0KS4nPC9vcHRpb24+JzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuICRyZXNwb25zZTsKICAgIH0KCiAgICBwdWJsaWMgZnVuY3Rpb24gZ2V0U3RhbmRhcmRDb3N0cygkaWQpewogICAgICAgICRwcm9kdWN0ID0gUHJvZHVjdDo6ZmluZE9yRmFpbCgkaWQpOwogICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5wcm9kdWN0cy5zdGFuZGFyZC1jb3N0cycsIFsKICAgICAgICAgICAgJ3RpdGxlJyA9PiAiU3RhbmRhcmQgQ29zdHMgZm9yICIuJHByb2R1Y3QtPm5hbWUuJyAnLmdldFByb2R1Y3RBdHRyaWJ1dGVzRmFzdGVyKCRwcm9kdWN0KSwKICAgICAgICAgICAgJ3Byb2R1Y3QnID0+ICRwcm9kdWN0LAogICAgICAgICAgICAnc3RhbmRhcmRDb3N0cycgPT4gU3RhbmRhcmRDb3N0OjphbGwoKQogICAgICAgIF0pOwogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiB1cGRhdGVTdGFuZGFyZENvc3RzKFJlcXVlc3QgJHJlcXVlc3QsICRpZCkKICAgIHsKICAgICAgICAkcmVxdWVzdC0+dmFsaWRhdGUoWwogICAgICAgICAgICAnYW1vdW50cycgPT4gJ3JlcXVpcmVkJywKICAgICAgICAgICAgJ2Ftb3VudHMuKicgPT4gJ3JlcXVpcmVkJywKICAgICAgICBdKTsKCiAgICAgICAgJHByb2R1Y3QgPSBQcm9kdWN0OjpmaW5kT3JGYWlsKCRpZCk7CiAgICAgICAgREI6OmJlZ2luVHJhbnNhY3Rpb24oKTsKICAgICAgICB0cnl7ICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgZm9yZWFjaCgkcmVxdWVzdC0+YW1vdW50cyBhcyAkc3RhbmRhcmRfY29zdF9pZCA9PiAkYW1vdW50KXsKICAgICAgICAgICAgICAgIFByb2R1Y3RTdGFuZGFyZENvc3Q6OnVwZGF0ZU9yQ3JlYXRlKFsKICAgICAgICAgICAgICAgICAgICAncHJvZHVjdF9pZCcgPT4gJHByb2R1Y3QtPmlkLAogICAgICAgICAgICAgICAgICAgICdzdGFuZGFyZF9jb3N0X2lkJyA9PiAkc3RhbmRhcmRfY29zdF9pZCwKICAgICAgICAgICAgICAgIF0sIFsKICAgICAgICAgICAgICAgICAgICAnYW1vdW50JyA9PiAkYW1vdW50CiAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgREI6OmNvbW1pdCgpOwogICAgICAgICAgICAkbm90aWZpY2F0aW9uID0gWwogICAgICAgICAgICAgICAgJ21lc3NhZ2UnID0+ICJTdGFuZGFyZCBjb3N0cyBoYXMgYmVlbiB1cGRhdGVkIiwKICAgICAgICAgICAgICAgICdhbGVydC10eXBlJyA9PiAnc3VjY2VzcycKICAgICAgICAgICAgXTsKICAgICAgICAgICAgcmV0dXJuIHJlZGlyZWN0KCdwbXMvcHJvZHVjdC1tYW5hZ2VtZW50L3Byb2R1Y3QvJy4kcHJvZHVjdC0+aWQuJy9zdGFuZGFyZC1jb3N0cycpLT53aXRoKCRub3RpZmljYXRpb24pOwogICAgICAgIH1jYXRjaCAoXFRocm93YWJsZSAkdGgpewogICAgICAgICAgICBEQjo6cm9sbGJhY2soKTsKICAgICAgICAgICAgJG5vdGlmaWNhdGlvbiA9IFsKICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAkdGgtPmdldE1lc3NhZ2UoKSwKICAgICAgICAgICAgICAgICdhbGVydC10eXBlJyA9PiAnZXJyb3InCiAgICAgICAgICAgIF07CiAgICAgICAgICAgIHJldHVybiByZWRpcmVjdCgncG1zL3Byb2R1Y3QtbWFuYWdlbWVudC9wcm9kdWN0LycuJHByb2R1Y3QtPmlkLicvc3RhbmRhcmQtY29zdHMnKS0+d2l0aCgkbm90aWZpY2F0aW9uKTsKICAgICAgICB9CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIHVuaXRDb252ZXJzaW9ucygkaWQpCiAgICB7CiAgICAgICAgJHByb2R1Y3QgPSBQcm9kdWN0Ojp3aXRoKFsKICAgICAgICAgICAgJ3Byb2R1Y3RVbml0Lm1hdHJpeGVzJywKICAgICAgICAgICAgJ3Byb2R1Y3RVbml0Q29udmVyc2lvbnMnCiAgICAgICAgXSktPmZpbmRPckZhaWwoJGlkKTsKICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMucHJvZHVjdHMudW5pdC1jb252ZXJzaW9ucycsIFsKICAgICAgICAgICAgJ3Byb2R1Y3QnID0+ICRwcm9kdWN0LAogICAgICAgICAgICAndW5pdHMnID0+IFByb2R1Y3RVbml0Ojp3aGVyZSgnaWQnLCAnIT0nLCAkcHJvZHVjdC0+cHJvZHVjdF91bml0X2lkKS0+Z2V0KCksCiAgICAgICAgXSk7CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIHVwZGF0ZVVuaXRDb252ZXJzaW9ucyhSZXF1ZXN0ICRyZXF1ZXN0LCAkaWQpCiAgICB7CiAgICAgICAgREI6OmJlZ2luVHJhbnNhY3Rpb24oKTsKICAgICAgICB0cnl7CiAgICAgICAgICAgICRwcm9kdWN0ID0gUHJvZHVjdDo6d2l0aChbCiAgICAgICAgICAgICAgICAncHJvZHVjdFVuaXQubWF0cml4ZXMnLAogICAgICAgICAgICAgICAgJ3Byb2R1Y3RVbml0Q29udmVyc2lvbnMnCiAgICAgICAgICAgIF0pLT5maW5kT3JGYWlsKCRpZCk7CiAgICAgICAgICAgICR1bml0cyA9IFByb2R1Y3RVbml0Ojp3aGVyZSgnaWQnLCAnIT0nLCAkcHJvZHVjdC0+cHJvZHVjdF91bml0X2lkKS0+Z2V0KCk7CiAgICAgICAgICAgIGlmKGlzc2V0KCR1bml0c1swXSkpewogICAgICAgICAgICAgICAgZm9yZWFjaCgkdW5pdHMgYXMgJHVuaXQpewogICAgICAgICAgICAgICAgICAgIFByb2R1Y3RVbml0Q29udmVyc2lvbjo6dXBkYXRlT3JDcmVhdGUoWwogICAgICAgICAgICAgICAgICAgICAgICAncHJvZHVjdF9pZCcgPT4gJGlkLAogICAgICAgICAgICAgICAgICAgICAgICAncHJvZHVjdF91bml0X2lkJyA9PiAkcHJvZHVjdC0+cHJvZHVjdF91bml0X2lkLAogICAgICAgICAgICAgICAgICAgICAgICAnY29udmVyc2lvbl91bml0X2lkJyA9PiAkdW5pdC0+aWQKICAgICAgICAgICAgICAgICAgICBdLCBbCiAgICAgICAgICAgICAgICAgICAgICAgICdjb252ZXJzaW9uX3JhdGUnID0+IGlzc2V0KCRyZXF1ZXN0LT51bml0c1skdW5pdC0+aWRdKSAmJiAkcmVxdWVzdC0+dW5pdHNbJHVuaXQtPmlkXSA+PSAwID8gJHJlcXVlc3QtPnVuaXRzWyR1bml0LT5pZF0gOiAwLAogICAgICAgICAgICAgICAgICAgIF0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBEQjo6Y29tbWl0KCk7CiAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiB0cnVlLAogICAgICAgICAgICAgICAgJ21lc3NhZ2UnID0+ICJVbml0IENvbnZlcnNpb25zIGhhcyBiZWVuIHVwZGF0ZWQgc3VjY2Vzc2Z1bGx5LiIKICAgICAgICAgICAgXSk7CiAgICAgICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgIERCOjpyb2xsYmFjaygpOwogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gZmFsc2UsCiAgICAgICAgICAgICAgICAnbWVzc2FnZScgPT4gJHRoLT5nZXRNZXNzYWdlKCkKICAgICAgICAgICAgXSk7CiAgICAgICAgfQogICAgfQp9Cg==