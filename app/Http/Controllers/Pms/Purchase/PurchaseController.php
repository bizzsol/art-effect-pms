<?php
bolt_decrypt( __FILE__ , 'gWAVAj'); return 0;
##!!!##CgpuYW1lc3BhY2UgQXBwXEh0dHBcQ29udHJvbGxlcnNcUG1zXFB1cmNoYXNlOwoKdXNlIEFwcFxIdHRwXENvbnRyb2xsZXJzXENvbnRyb2xsZXI7CnVzZSBBcHBcTW9kZWxzXEhyXERlcGFydG1lbnQ7CnVzZSBBcHBcTW9kZWxzXEhyXFVuaXQ7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xDYXRlZ29yeTsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFBheW1lbnRUZXJtOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUHVyY2hhc2VcUHVyY2hhc2VPcmRlcjsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFB1cmNoYXNlXFB1cmNoYXNlT3JkZXJJdGVtOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUHVyY2hhc2VcUHVyY2hhc2VPcmRlck1pbGVzdG9uZTsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFB1cmNoYXNlXFB1cmNoYXNlT3JkZXJSZXF1aXNpdGlvbjsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFF1b3RhdGlvbnM7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xRdW90YXRpb25zSXRlbXM7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xSZXF1aXNpdGlvbjsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFJlcXVpc2l0aW9uSXRlbTsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFJlcXVpc2l0aW9uVHJhY2tpbmc7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xSZnBcUmVxdWVzdFByb3Bvc2FsOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcU3VwcGxpZXJQYXltZW50Owp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcV2FyZWhvdXNlczsKdXNlIElsbHVtaW5hdGVcSHR0cFxSZXF1ZXN0Owp1c2UgSWxsdW1pbmF0ZVxTdXBwb3J0XEZhY2FkZXNcQXV0aDsKdXNlIElsbHVtaW5hdGVcU3VwcG9ydFxGYWNhZGVzXERCOwp1c2UgSWxsdW1pbmF0ZVxTdXBwb3J0XEZhY2FkZXNcTWFpbDsKdXNlIElsbHVtaW5hdGVcU3VwcG9ydFxGYWNhZGVzXFZpZXc7CnVzZSBQREY7CnVzZSBZYWpyYVxEYXRhVGFibGVzXERhdGFUYWJsZXM7CgpjbGFzcyBQdXJjaGFzZUNvbnRyb2xsZXIgZXh0ZW5kcyBDb250cm9sbGVyCnsKICAgIHB1YmxpYyBmdW5jdGlvbiBoZWFkZXJDb2x1bW5zKCR2YWx1ZSA9ICcnKQogICAgewogICAgICAgIHJldHVybiBhcnJheSgKICAgICAgICAgICAgWydTTCcsICdTTCddLAogICAgICAgICAgICBbJ2FwcHJvdmFsX2RhdGUnLCAnYXBwcm92YWxfZGF0ZScsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3JlZmVyZW5jZV9ubycsICdyZWZlcmVuY2Vfbm8nLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydzdXBwbGllcicsICdzdXBwbGllcicsICd0ZXh0LWxlZnQnXSwKICAgICAgICAgICAgLy9bJ3F1b3RhdGlvbl9yZWZfbm8nLCAncXVvdGF0aW9uX3JlZl9ubycsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3Byb2R1Y3RzJywgJ3Byb2R1Y3RzJywgJ3RleHQtbGVmdCddLAogICAgICAgICAgICBbJ3RvdGFsX3ByaWNlJywgJ3RvdGFsX3ByaWNlJywgJ3RleHQtcmlnaHQnXSwKICAgICAgICAgICAgWyd2YXQnLCAndmF0JywgJ3RleHQtcmlnaHQnXSwKICAgICAgICAgICAgWydncm9zc19wcmljZScsICdncm9zc19wcmljZScsICd0ZXh0LXJpZ2h0J10sCiAgICAgICAgICAgIFsnYWN0aW9ucycsICdhY3Rpb25zJywgJ3RleHQtY2VudGVyJywgJ3dpZHRoOjE1JSddCiAgICAgICAgKTsKICAgIH0KCiAgICBwdWJsaWMgZnVuY3Rpb24gaW5kZXgoKQogICAgewoKICAgICAgICAvL2RkKHNlc3Npb24oKS0+Z2V0KCdzeXN0ZW0taW5mb3JtYXRpb24nKSk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgJHRpdGxlID0gJ1B1cmNoYXNlIE9yZGVyJzsKICAgICAgICAgICAgJHB1cmNoYXNlT3JkZXJMaXN0ID0gUHVyY2hhc2VPcmRlcjo6d2l0aChbCiAgICAgICAgICAgICAgICAncmVsUXVvdGF0aW9uLnJlbFN1cHBsaWVycycsCiAgICAgICAgICAgICAgICAncmVsR29vZFJlY2VpdmVOb3RlJywKICAgICAgICAgICAgICAgICdyZWxRdW90YXRpb24uZXhjaGFuZ2VSYXRlLmN1cnJlbmN5JywKICAgICAgICAgICAgICAgICdyZWxQb0F0dGFjaG1lbnQnLAogICAgICAgICAgICAgICAgJ3JlbFN1cHBsaWVyUGF5bWVudHMnLAogICAgICAgICAgICAgICAgJ3JlbFF1b3RhdGlvbi5yZWxSZXF1ZXN0UHJvcG9zYWwucmVxdWVzdFByb3Bvc2FsUmVxdWlzaXRpb24nCiAgICAgICAgICAgIF0pCiAgICAgICAgICAgICAgICAtPndoZXJlSGFzKCdyZWxRdW90YXRpb24ucmVsU3VwcGxpZXJzJywgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlTm90SW4oJ25hbWUnLCBpZ25vcmVTdXBwbGllcnMoKSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT53aGVuKCFhdXRoKCktPnVzZXIoKS0+aGFzQW55Um9sZShbJ1B1cmNoYXNlLURlcGFydG1lbnQnLCAnQXVkaXQnLCAnQmlsbGluZycsICdNYW5hZ2VtZW50JywgJ0FjY291bnRzJ10pLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3B1cmNoYXNlT3JkZXJSZXF1aXNpdGlvbnMucmVxdWlzaXRpb24nLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdhc3NpZ25lZF91c2VyX2lkJywgYXV0aCgpLT51c2VyKCktPmlkKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPndoZXJlSW4oJ2hyX3VuaXRfaWQnLCBhdXRoKCktPnVzZXIoKS0+cHJpb3JpdGllcy0+cGx1Y2soJ2hyX3VuaXRfaWQnKS0+dG9BcnJheSgpKQogICAgICAgICAgICAgICAgLT53aGVyZUhhcygncmVsUXVvdGF0aW9uJywgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlTm90SW4oJ3R5cGUnLCBbJ2RpcmVjdC1wdXJjaGFzZSddKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPndoZXJlSW4oJ2lzX3NlbmQnLCBbJ25vJywgJ3llcyddKQogICAgICAgICAgICAgICAgLT53aGVuKCFkYXRhdGFibGVPcmRlcmluZygpLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+b3JkZXJieSgnaWQnLCAnZGVzYycpOwogICAgICAgICAgICAgICAgfSk7CgoKICAgICAgICAgICAgJG9wdGlvbnMgPSBbCiAgICAgICAgICAgICAgICAnc2VuZC1wby10by1zdXBwbGllcicgPT4gYXV0aCgpLT51c2VyKCktPmhhc1Blcm1pc3Npb25Ubygnc2VuZC1wby10by1zdXBwbGllcicpLAogICAgICAgICAgICAgICAgJ3BvLWNhbmNlbCcgPT4gYXV0aCgpLT51c2VyKCktPmhhc1Blcm1pc3Npb25UbygncG8tY2FuY2VsJyksCiAgICAgICAgICAgIF07CgogICAgICAgICAgICBpZiAocmVxdWVzdCgpLT5hamF4KCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBEYXRhVGFibGVzOjpvZigkcHVyY2hhc2VPcmRlckxpc3QpCiAgICAgICAgICAgICAgICAgICAgLT5hZGRJbmRleENvbHVtbigpCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2FwcHJvdmFsX2RhdGUnLCBmdW5jdGlvbiAoJHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICAkc3RhZ2UgPSBzdGFnZUZpbmRlcigkdmFsdWVzLT5yZWxRdW90YXRpb24tPnJlbFJlcXVlc3RQcm9wb3NhbC0+cmVxdWVzdFByb3Bvc2FsUmVxdWlzaXRpb24tPmZpcnN0KCktPnJlcXVpc2l0aW9uX2lkLCAnY3NfYXBwcm92ZWQnKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRzdGFnZSAmJiAkc3RhZ2UtPnN0YWdlX3VwZGF0ZWRfYXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gZGF0ZSgnWS1tLWQnLCBzdHJ0b3RpbWUoJHN0YWdlLT5zdGFnZV91cGRhdGVkX2F0KSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogbnVsbDsKICAgICAgICAgICAgICAgICAgICB9KQovLyAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ2FwcHJvdmFsX2RhdGUnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewovLyAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ3BvX2RhdGUnLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKLy8gICAgICAgICAgICAgICAgICAgIH0pCi8vICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdhcHByb3ZhbF9kYXRlJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7Ci8vICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+b3JkZXJCeSgncG9fZGF0ZScsICRvcmRlcik7Ci8vICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZWRpdENvbHVtbigncmVmZXJlbmNlX25vJywgZnVuY3Rpb24gKCR2YWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIG9uY2xpY2s9InB1cmNoYXNlT3JkZXJEZXRhaWxzKCQodGhpcykpIiBjbGFzcz0iYnRuIGJ0bi1saW5rIiBkYXRhLXNyYz0iJyAuIHJvdXRlKCdwbXMucHVyY2hhc2Uub3JkZXItbGlzdC5zaG93JywgJHZhbHVlcy0+aWQpIC4gJyI+JyAuICR2YWx1ZXMtPnJlZmVyZW5jZV9ubyAuICc8L2E+JzsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdzdXBwbGllcicsIGZ1bmN0aW9uICgkdmFsdWVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpc3NldCgkdmFsdWVzLT5yZWxRdW90YXRpb24tPnJlbFN1cHBsaWVycykgPyAoaXNzZXQoJHZhbHVlcy0+cmVsUXVvdGF0aW9uLT5yZWxTdXBwbGllcnMtPm5hbWUpID8gJHZhbHVlcy0+cmVsUXVvdGF0aW9uLT5yZWxTdXBwbGllcnMtPm5hbWUgLiAnICgnIC4gJHZhbHVlcy0+cmVsUXVvdGF0aW9uLT5yZWxTdXBwbGllcnMtPmNvZGUgLiAnKScgOiAnJykgOiAnJzsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdzdXBwbGllcicsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxRdW90YXRpb24ucmVsU3VwcGxpZXJzJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5vcldoZXJlKCdjb2RlJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbignc3VwcGxpZXInLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRvcmRlciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFF1b3RhdGlvbnM6OnNlbGVjdCgnc3VwcGxpZXJzLm5hbWUnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbignc3VwcGxpZXJzJywgJ3N1cHBsaWVycy5pZCcsICc9JywgJ3F1b3RhdGlvbnMuc3VwcGxpZXJfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3F1b3RhdGlvbnMuaWQnLCAncHVyY2hhc2Vfb3JkZXJzLnF1b3RhdGlvbl9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLT50YWtlKDEpCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfSkKLy8gICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdxdW90YXRpb25fcmVmX25vJywgZnVuY3Rpb24gKCR2YWx1ZXMpIHsKLy8gICAgICAgICAgICAgICAgICAgICAgICAvL3JldHVybiBpc3NldCgkdmFsdWVzLT5yZWxRdW90YXRpb24tPnJlZmVyZW5jZV9ubykgPyAkdmFsdWVzLT5yZWxRdW90YXRpb24tPnJlZmVyZW5jZV9ubyA6ICcnOwovLyAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnPGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiBvbmNsaWNrPSJvcGVuTW9kYWwoJyAuICR2YWx1ZXMtPmlkIC4gJykiICBjbGFzcz0iYnRuIGJ0bi1saW5rIj4nIC4gJHZhbHVlcy0+cmVsUXVvdGF0aW9uLT5yZWZlcmVuY2Vfbm8gLiAnPC9hPic7Ci8vICAgICAgICAgICAgICAgICAgICB9KQovLyAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3F1b3RhdGlvbl9yZWZfbm8nLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewovLyAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxRdW90YXRpb24nLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7Ci8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ3JlZmVyZW5jZV9ubycsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpOwovLyAgICAgICAgICAgICAgICAgICAgICAgIH0pOwovLyAgICAgICAgICAgICAgICAgICAgfSkKLy8gICAgICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ3F1b3RhdGlvbl9yZWZfbm8nLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKLy8gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKAovLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnksCi8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICRvcmRlciwKLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgUXVvdGF0aW9uczo6c2VsZWN0KCdxdW90YXRpb25zLnJlZmVyZW5jZV9ubycpCi8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCdxdW90YXRpb25zLmlkJywgJ3B1cmNoYXNlX29yZGVycy5xdW90YXRpb25faWQnKQovLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLT50YWtlKDEpCi8vICAgICAgICAgICAgICAgICAgICAgICAgKTsKLy8gICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLy9wcm9kdWN0CiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3Byb2R1Y3RzJywgZnVuY3Rpb24gKCRxdW90YXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHByb2R1Y3RzID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgICRzbCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICRhcnJheSA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHF1b3RhdGlvbi0+cmVsUXVvdGF0aW9uLT5yZWxSZXF1ZXN0UHJvcG9zYWwtPnJlcXVlc3RQcm9wb3NhbERldGFpbHMtPmNvdW50KCkgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JlYWNoICgkcXVvdGF0aW9uLT5yZWxRdW90YXRpb24tPnJlbFJlcXVlc3RQcm9wb3NhbC0+cmVxdWVzdFByb3Bvc2FsRGV0YWlscyBhcyAka2V5ID0+ICRwcm9kdWN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzc2V0KCRwcm9kdWN0LT5wcm9kdWN0LT5pZCkgJiYgIWluX2FycmF5KCRwcm9kdWN0LT5wcm9kdWN0LT5pZCwgJGFycmF5KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc2wrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHByb2R1Y3RzIC49ICgkc2wgPiAxID8gJywgJyA6ICcnKSAuICRwcm9kdWN0LT5wcm9kdWN0LT5uYW1lIC4gJyAnIC4gZ2V0UHJvZHVjdEF0dHJpYnV0ZXNGYXN0ZXIoJHByb2R1Y3QtPnByb2R1Y3QpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcnJheV9wdXNoKCRhcnJheSwgJHByb2R1Y3QtPnByb2R1Y3QtPmlkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcHJvZHVjdHM7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbigncHJvZHVjdHMnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZShmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZShmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFF1b3RhdGlvbi5yZWxSZXF1ZXN0UHJvcG9zYWwucmVxdWVzdFByb3Bvc2FsRGV0YWlscy5wcm9kdWN0JywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPm9yV2hlcmUoZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUXVvdGF0aW9uLnJlbFJlcXVlc3RQcm9wb3NhbC5yZXF1ZXN0UHJvcG9zYWxEZXRhaWxzLnByb2R1Y3QuYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24nLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPm9yV2hlcmVIYXMoJ3JlbFF1b3RhdGlvbi5yZWxSZXF1ZXN0UHJvcG9zYWwucmVxdWVzdFByb3Bvc2FsRGV0YWlscy5wcm9kdWN0LmF0dHJpYnV0ZXMuYXR0cmlidXRlT3B0aW9uLmF0dHJpYnV0ZScsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdwcm9kdWN0cycsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJG9yZGVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgUmVxdWVzdFByb3Bvc2FsOjpzZWxlY3QoJ3Byb2R1Y3RzLm5hbWUnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbigncHJvZHVjdHMnLCAncHJvZHVjdHMuaWQnLCAnPScsICdyZXF1ZXN0X3Byb3Bvc2FsX2RldGFpbHMucHJvZHVjdF9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdyZXF1ZXN0X3Byb3Bvc2FsX2RldGFpbHMnLCAncmVxdWVzdF9wcm9wb3NhbF9kZXRhaWxzLnJlcXVlc3RfcHJvcG9zYWxfaWQnLCAnPScsICdyZXF1ZXN0X3Byb3Bvc2Fscy5pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdyZXF1ZXN0X3Byb3Bvc2FsX3JlcXVpc2l0aW9ucycsICdyZXF1ZXN0X3Byb3Bvc2FsX3JlcXVpc2l0aW9ucy5yZXF1ZXN0X3Byb3Bvc2FsX2lkJywgJz0nLCAncmVxdWVzdF9wcm9wb3NhbHMuaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3JlcXVlc3RfcHJvcG9zYWxzLmlkJywgJ3F1b3RhdGlvbnMucmVxdWVzdF9wcm9wb3NhbF9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLT50YWtlKDEpCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmVkaXRDb2x1bW4oJ3RvdGFsX3ByaWNlJywgZnVuY3Rpb24gKCR2YWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgoaXNzZXQoJHZhbHVlcy0+cmVsUXVvdGF0aW9uLT5leGNoYW5nZVJhdGUtPmN1cnJlbmN5LT5zeW1ib2wpID8gJHZhbHVlcy0+cmVsUXVvdGF0aW9uLT5leGNoYW5nZVJhdGUtPmN1cnJlbmN5LT5zeW1ib2wgOiAnJykgLiAnICcgLiBzeXN0ZW1Nb25leUZvcm1hdCgkdmFsdWVzLT50b3RhbF9wcmljZSkpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5lZGl0Q29sdW1uKCd2YXQnLCBmdW5jdGlvbiAoJHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKChpc3NldCgkdmFsdWVzLT5yZWxRdW90YXRpb24tPmV4Y2hhbmdlUmF0ZS0+Y3VycmVuY3ktPnN5bWJvbCkgPyAkdmFsdWVzLT5yZWxRdW90YXRpb24tPmV4Y2hhbmdlUmF0ZS0+Y3VycmVuY3ktPnN5bWJvbCA6ICcnKSAuICcgJyAuIHN5c3RlbU1vbmV5Rm9ybWF0KCR2YWx1ZXMtPnZhdCkpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5lZGl0Q29sdW1uKCdncm9zc19wcmljZScsIGZ1bmN0aW9uICgkdmFsdWVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoKGlzc2V0KCR2YWx1ZXMtPnJlbFF1b3RhdGlvbi0+ZXhjaGFuZ2VSYXRlLT5jdXJyZW5jeS0+c3ltYm9sKSA/ICR2YWx1ZXMtPnJlbFF1b3RhdGlvbi0+ZXhjaGFuZ2VSYXRlLT5jdXJyZW5jeS0+c3ltYm9sIDogJycpIC4gJyAnIC4gc3lzdGVtTW9uZXlGb3JtYXQoJHZhbHVlcy0+Z3Jvc3NfcHJpY2UpKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdhY3Rpb25zJywgZnVuY3Rpb24gKCR2YWx1ZXMpIHVzZSAoJG9wdGlvbnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgPSAnJzsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkdmFsdWVzLT5yZWxHb29kUmVjZWl2ZU5vdGUtPmNvdW50KCkgPT0gMCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkb3B0aW9uc1snc2VuZC1wby10by1zdXBwbGllciddKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCR2YWx1ZXMtPmlzX3NlbmQgPT0gJ25vJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnPGEgZGF0YS1zcmM9IicgLiByb3V0ZSgncG1zLnB1cmNoYXNlLnNlbmQucG8udG8uc3VwcGxpZXInLCAkdmFsdWVzLT5pZCkgLiAnIiBjbGFzcz0iYnRuIGJ0bi14cyBidG4tcHJpbWFyeSBtLTEiIHRpdGxlPSJTZW5kIFB1cmNoYXNlIE9yZGVyIFRvIFN1cHBsaWVyIiBvbmNsaWNrPSJwb0FjdGlvbnMoJCh0aGlzKSkiPjxpIGNsYXNzPSJsYXMgbGEtcGFwZXItcGxhbmUiPjwvaT48L2E+JzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnPGEgY2xhc3M9ImJ0biBidG4teHMgYnRuLXN1Y2Nlc3MgbS0xIiB0aXRsZT0iUHVyY2hhc2UgT3JkZXIgQWxyZWFkeSBTZW50IFRvIFN1cHBsaWVyIj48aSBjbGFzcz0ibGFzIGxhLWNoZWNrLWNpcmNsZSI+PC9pPjwvYT4nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJG9wdGlvbnNbJ3BvLWNhbmNlbCddKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxhIGRhdGEtc3JjPSInIC4gcm91dGUoJ3Btcy5wdXJjaGFzZS5jYW5jZWwucG8nLCAkdmFsdWVzLT5pZCkgLiAnIiBjbGFzcz0iYnRuIGJ0bi14cyBidG4tZGFuZ2VyIGRlbGV0ZVBvIG0tMSIgdGl0bGU9IkNhbmNlbCBQdXJjaGFzZSBPcmRlciIgb25jbGljaz0icG9BY3Rpb25zKCQodGhpcykpIj48aSBjbGFzcz0ibGFzIGxhLXRpbWVzLWNpcmNsZSI+PC9pPjwvYT4nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vaWYgKCR2YWx1ZXMtPnJlbFBvQXR0YWNobWVudC0+Y291bnQoKSA8PSAwICYmICR2YWx1ZXMtPnJlbFN1cHBsaWVyUGF5bWVudHMtPndoZXJlSW4oJ3N0YXR1cycsIFsnYXBwcm92ZWQnLCAnYXVkaXRlZCddKS0+Y291bnQoKSA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHZhbHVlcy0+aXNfc2VuZCA9PSAnbm8nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxhIGhyZWY9IicgLiByb3V0ZSgncG1zLnB1cmNoYXNlLm9yZGVyLWxpc3QucmV2aXNlLnBvJywgJHZhbHVlcy0+aWQpIC4gJyIgdGFyZ2V0PSJfX2JsYW5rIiBjbGFzcz0iYnRuIGJ0bi14cyBidG4tc3VjY2VzcyBtLTEiIHRpdGxlPSJQdXJjaGFzZSBPcmRlciBSZXZpc2UiPjxpIGNsYXNzPSJsYXMgbGEtZWRpdCI+PC9pPjwvYT4nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vfQoKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJyA8YSB0YXJnZXQ9Il9ibGFuayIgaHJlZj0iJyAuIHJvdXRlKCdwbXMuYmlsbGluZy1hdWRpdC5wby5pbnZvaWNlLnByaW50JywgJHZhbHVlcy0+aWQpIC4gJyIgIHRpdGxlPSJQdXJjaGFzZSBPcmRlciBQcmludCBWaWV3IiBjbGFzcz0iYnRuIGJ0bi14cyBidG4td2FybmluZyBtLTEiPjxpIGNsYXNzPSJsYXMgbGEtcHJpbnQiPjwvaT48L2E+JzsKCiAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICcgPGEgdGFyZ2V0PSJfYmxhbmsiIGhyZWY9IicgLiByb3V0ZSgncG1zLmJpbGxpbmctYXVkaXQucG8uaGlzdG9yeScsICR2YWx1ZXMtPmlkKSAuICciICB0aXRsZT0iUE8gSGlzdG9yeSIgY2xhc3M9ImJ0biBidG4teHMgYnRuLWluZm8gbS0xIj48aSBjbGFzcz0ibGFzIGxhLXVzZXItY2xvY2siPjwvaT48L2E+JzsKCgogICAgICAgICAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb25JZCA9ICR2YWx1ZXMtPnJlbFF1b3RhdGlvbi0+cmVsUmVxdWVzdFByb3Bvc2FsLT5yZXF1ZXN0UHJvcG9zYWxSZXF1aXNpdGlvbi0+Zmlyc3QoKS0+cmVxdWlzaXRpb25faWQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkcmVxdWlzaXRpb25JZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgdGl0bGU9IlRyYWNrIFByb2dyZXNzIgogICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3M9InRyYWNraW5nUmVxdWlzdGlvblN0YXR1cyBidG4gYnRuLXhzIGJ0bi1zZWNvbmRhcnkgbWwtMiIgb25jbGljaz0idHJhY2tSZXF1aXNpdGlvblByb2dyZXNzKCQodGhpcykpIiBkYXRhLWlkPSInIC4gJHJlcXVpc2l0aW9uSWQgLiAnIj48aSBjbGFzcz0ibGEgbGEtbWFwIj48L2k+PC9hPic7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRhY3Rpb25zOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5yYXdDb2x1bW5zKFsncmVmZXJlbmNlX25vJywgJ3N1cHBsaWVyJywgJ3RvdGFsX3ByaWNlJywgJ3ZhdCcsICdncm9zc19wcmljZScsICdhY3Rpb25zJywgJ3F1b3RhdGlvbl9yZWZfbm8nXSkKICAgICAgICAgICAgICAgICAgICAtPm1ha2UodHJ1ZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5wdXJjaGFzZS5vcmRlci1saXN0JywgWwogICAgICAgICAgICAgICAgJ3RpdGxlJyA9PiAkdGl0bGUsCiAgICAgICAgICAgICAgICAnaGVhZGVyQ29sdW1ucycgPT4gJHRoaXMtPmhlYWRlckNvbHVtbnMoKQogICAgICAgICAgICBdKTsKICAgICAgICB9IGNhdGNoIChcVGhyb3dhYmxlICR0aCkgewogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCgogICAgcHVibGljIGZ1bmN0aW9uIHNlbmRQb1RvU3VwcGxpZXIoJGlkKQogICAgewogICAgICAgIERCOjpiZWdpblRyYW5zYWN0aW9uKCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgJHB1cmNoYXNlT3JkZXIgPSBQdXJjaGFzZU9yZGVyOjpmaW5kT3JGYWlsKCRpZCk7CgogICAgICAgICAgICAvLyB1cGRhdGUgUE8gc3RhdHVzCiAgICAgICAgICAgICRwdXJjaGFzZU9yZGVyLT51cGRhdGUoWydpc19zZW5kJyA9PiAneWVzJ10pOwoKICAgICAgICAgICAgLy8gdHJhY2sgcmVxdWlzaXRpb24KICAgICAgICAgICAgJHJlcXVpc2l0aW9uSWQgPSAkcHVyY2hhc2VPcmRlci0+cmVsUXVvdGF0aW9uLT5yZWxSZXF1ZXN0UHJvcG9zYWwtPnJlcXVlc3RQcm9wb3NhbFJlcXVpc2l0aW9uLT5maXJzdCgpLT5yZXF1aXNpdGlvbl9pZDsKICAgICAgICAgICAgaWYgKCRyZXF1aXNpdGlvbklkKSB7CiAgICAgICAgICAgICAgICByZXF1aXNpdGlvblRyYWNraW5nSGlzdG9yeSgkcmVxdWlzaXRpb25JZCwgJ3BvX3NlbmRfdG9fc3VwcGxpZXInLCAnUE8gc2VudCB0byBTdXBwbGllcicpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBnZXQgc3VwcGxpZXIgZW1haWwKICAgICAgICAgICAgJHN1cHBsaWVyID0gJHB1cmNoYXNlT3JkZXItPnJlbFF1b3RhdGlvbi0+cmVsU3VwcGxpZXJzID8/IG51bGw7CiAgICAgICAgICAgICRzdXBwbGllckVtYWlsID0gJHN1cHBsaWVyID8gJHN1cHBsaWVyLT5lbWFpbCA6IG51bGw7CgovLyAgICAgICAgICAgIGlmIChpc01haWxDb25maWd1cmVkKCRzdXBwbGllcikpIHsKLy8gICAgICAgICAgICAgICAgLy8gcHJlcGFyZSBtYWlsIGRhdGEKLy8gICAgICAgICAgICAgICAgJGRhdGFbImVtYWlsIl0gPSAkc3VwcGxpZXJFbWFpbDsKLy8gICAgICAgICAgICAgICAgJGRhdGFbInRpdGxlIl0gPSAiUHVyY2hhc2UgT3JkZXIgRW1haWwiOwovLyAgICAgICAgICAgICAgICAkZGF0YVsicmVmZXJlbmNlX25vIl0gPSAkcHVyY2hhc2VPcmRlci0+cmVmZXJlbmNlX25vOwovLyAgICAgICAgICAgICAgICAkZGF0YVsicHVyY2hhc2VPcmRlciJdID0gJHB1cmNoYXNlT3JkZXI7Ci8vICAgICAgICAgICAgICAgICRkYXRhWydmbGFnJ10gPSAnY29uZmlybWVkJzsKLy8gICAgICAgICAgICAgICAgJGRhdGFbIm1haWxfYm9keSJdID0gJ3Btcy5iYWNrZW5kLnBhZ2VzLmJpbGxpbmcucG8taW52b2ljZS1wZGYnOwovLwovLyAgICAgICAgICAgICAgICAkdmlldyA9ICdwbXMuYmFja2VuZC5tYWlsLnBvX21haWxfYm9keSc7Ci8vICAgICAgICAgICAgICAgIHNlbmRFbWFpbCgkdmlldywgJGRhdGEsICRkYXRhWyd0aXRsZSddLCAkZGF0YVsiZW1haWwiXSwgW10sIFtdLCBbXSk7Ci8vICAgICAgICAgICAgfQoKICAgICAgICAgICAgREI6OmNvbW1pdCgpOwogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gdHJ1ZSwKICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAnUHVyY2hhc2Ugb3JkZXIgaGFzIGJlZW4gc3VjY2Vzc2Z1bGx5IHNlbnQgdG8gc3VwcGxpZXIuJwogICAgICAgICAgICBdKTsKICAgICAgICB9IGNhdGNoIChcVGhyb3dhYmxlICR0aCkgewogICAgICAgICAgICBEQjo6cm9sbEJhY2soKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnID0+IGZhbHNlLAogICAgICAgICAgICAgICAgJ21lc3NhZ2UnID0+ICR0aC0+Z2V0TWVzc2FnZSgpCiAgICAgICAgICAgIF0pOwogICAgICAgIH0KICAgIH0KCgogICAgcHVibGljIGZ1bmN0aW9uIHNob3coJGlkKQogICAgewogICAgICAgICRyZXNwb25zZSA9IFtdOwoKICAgICAgICB0cnkgewogICAgICAgICAgICAkbW9kYWwgPSBQdXJjaGFzZU9yZGVyOjp3aXRoKFsKICAgICAgICAgICAgICAgICdyZWxRdW90YXRpb24ucmVsUXVvdGF0aW9uSXRlbXMnLAogICAgICAgICAgICAgICAgJ3JlbFF1b3RhdGlvbi5yZWxTdXBwbGllcnMuU3VwcGxpZXJSYXRpbmdzJywKICAgICAgICAgICAgICAgICdyZWxRdW90YXRpb24uZXhjaGFuZ2VSYXRlLmN1cnJlbmN5JywKICAgICAgICAgICAgICAgICdyZWxQdXJjaGFzZU9yZGVySXRlbXMucmVsUHJvZHVjdC5jYXRlZ29yeS5jYXRlZ29yeScsCiAgICAgICAgICAgICAgICAncmVsUHVyY2hhc2VPcmRlckl0ZW1zLnJlbFByb2R1Y3QucHJvZHVjdFVuaXQnLAogICAgICAgICAgICAgICAgJ3JlbFB1cmNoYXNlT3JkZXJJdGVtcy5yZWxQcm9kdWN0LmF0dHJpYnV0ZXMuYXR0cmlidXRlT3B0aW9uLmF0dHJpYnV0ZScsCiAgICAgICAgICAgIF0pLT5maW5kT3JGYWlsKCRpZCk7CgogICAgICAgICAgICAkcmVxdWlzaXRpb25JdGVtcyA9IFJlcXVpc2l0aW9uSXRlbTo6d2l0aChbCiAgICAgICAgICAgICAgICAnYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24uYXR0cmlidXRlJwogICAgICAgICAgICBdKQogICAgICAgICAgICAgICAgLT53aGVyZUhhcygncmVxdWlzaXRpb24ucmVxdWVzdFByb3Bvc2FsUmVxdWlzaXRpb24nLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRtb2RhbCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdyZXF1ZXN0X3Byb3Bvc2FsX2lkJywgJG1vZGFsLT5yZWxRdW90YXRpb24tPnJlcXVlc3RfcHJvcG9zYWxfaWQpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+Z2V0KCk7CgogICAgICAgICAgICAkc3lzdGVtQ3VycmVuY3kgPSBzeXN0ZW1DdXJyZW5jeSgpOwogICAgICAgICAgICAkY3VycmVuY3kgPSAkbW9kYWwtPnJlbFF1b3RhdGlvbi0+ZXhjaGFuZ2VSYXRlLT5jdXJyZW5jeS0+Y29kZTsKICAgICAgICAgICAgJGV4Y2hhbmdlUmF0ZSA9IGV4Y2hhbmdlUmF0ZSgkbW9kYWwtPnJlbFF1b3RhdGlvbi0+ZXhjaGFuZ2VSYXRlLCAkc3lzdGVtQ3VycmVuY3ktPmlkKTsKICAgICAgICAgICAgJHNhbWUgPSAoJHN5c3RlbUN1cnJlbmN5LT5pZCA9PSAkbW9kYWwtPnJlbFF1b3RhdGlvbi0+ZXhjaGFuZ2VSYXRlLT5jdXJyZW5jeV9pZCA/IHRydWUgOiBmYWxzZSk7CiAgICAgICAgICAgIGlmICgkbW9kYWwpIHsKICAgICAgICAgICAgICAgICRib2R5ID0gVmlldzo6bWFrZSgncG1zLmJhY2tlbmQucGFnZXMucHVyY2hhc2Uuc2hvdycsIFsKICAgICAgICAgICAgICAgICAgICAncHVyY2hhc2VPcmRlcicgPT4gJG1vZGFsLAogICAgICAgICAgICAgICAgICAgICdzeXN0ZW1DdXJyZW5jeScgPT4gJHN5c3RlbUN1cnJlbmN5LAogICAgICAgICAgICAgICAgICAgICdjdXJyZW5jeScgPT4gJGN1cnJlbmN5LAogICAgICAgICAgICAgICAgICAgICdleGNoYW5nZVJhdGUnID0+ICRleGNoYW5nZVJhdGUsCiAgICAgICAgICAgICAgICAgICAgJ3NhbWUnID0+ICRzYW1lLAogICAgICAgICAgICAgICAgICAgICdyZXF1aXNpdGlvbkl0ZW1zJyA9PiAkcmVxdWlzaXRpb25JdGVtcwogICAgICAgICAgICAgICAgXSk7CgogICAgICAgICAgICAgICAgaWYgKHJlcXVlc3QoKS0+aGFzKCd2aWV3JykpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGJvZHktPnJlbmRlcigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgJHJlc3BvbnNlWydyZXN1bHQnXSA9ICdzdWNjZXNzJzsKICAgICAgICAgICAgICAgICRyZXNwb25zZVsnYm9keSddID0gJGJvZHktPnJlbmRlcigpOwogICAgICAgICAgICAgICAgJHJlc3BvbnNlWydtZXNzYWdlJ10gPSAnU3VjY2Vzc2Z1bGx5IEdlbmVyYXRlZCBQTyc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAkcmVzcG9uc2VbJ3Jlc3VsdCddID0gJ2Vycm9yJzsKICAgICAgICAgICAgICAgICRyZXNwb25zZVsnbWVzc2FnZSddID0gJ1B1cmNoYXNlIE9yZGVyIG5vdCBmb3VuZCEhJzsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFxUaHJvd2FibGUgJHRoKSB7CiAgICAgICAgICAgICRyZXNwb25zZVsncmVzdWx0J10gPSAnZXJyb3InOwogICAgICAgICAgICAkcmVzcG9uc2VbJ21lc3NhZ2UnXSA9ICR0aC0+Z2V0TWVzc2FnZSgpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHJlcXVlc3QoKS0+aGFzKCd2aWV3JykpIHsKICAgICAgICAgICAgcmV0dXJuICRib2R5LT5yZW5kZXIoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gJHJlc3BvbnNlOwogICAgICAgIH0KICAgIH0KCiAgICBwdWJsaWMgZnVuY3Rpb24gd29ya09yZGVyQ2FuY2VsKCRpZCkKICAgIHsKICAgICAgICBEQjo6YmVnaW5UcmFuc2FjdGlvbigpOwogICAgICAgIHRyeSB7CgogICAgICAgICAgICAkcHVyY2hhc2VPcmRlciA9IFB1cmNoYXNlT3JkZXI6OmZpbmRPckZhaWwoJGlkKTsKICAgICAgICAgICAgJHB1cmNoYXNlT3JkZXItPmlzX3NlbmQgPSAnaGFsdCc7CiAgICAgICAgICAgICRwdXJjaGFzZU9yZGVyLT5zYXZlKCk7CgogICAgICAgICAgICAkcmVxdWlzaXRpb25JZCA9ICRwdXJjaGFzZU9yZGVyLT5yZWxRdW90YXRpb24tPnJlbFJlcXVlc3RQcm9wb3NhbC0+cmVxdWVzdFByb3Bvc2FsUmVxdWlzaXRpb24tPmZpcnN0KCktPnJlcXVpc2l0aW9uX2lkOwogICAgICAgICAgICBpZiAoJHJlcXVpc2l0aW9uSWQpIHsKICAgICAgICAgICAgICAgIHJlcXVpc2l0aW9uVHJhY2tpbmdIaXN0b3J5KCRyZXF1aXNpdGlvbklkLCAncG9fY2FuY2VsbGVkJywgJ1B1cmNoYXNlIE9yZGVyIGhhcyBiZWVuIENhbmNlbGxlZCcpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAkc3VwcGxpZXIgPSAkcHVyY2hhc2VPcmRlci0+cmVsUXVvdGF0aW9uLT5yZWxTdXBwbGllcnMgPz8gbnVsbDsKICAgICAgICAgICAgJHN1cHBsaWVyRW1haWwgPSAkc3VwcGxpZXIgPyAkc3VwcGxpZXItPmVtYWlsIDogbnVsbDsKCi8vICAgICAgICAgICAgaWYgKGlzTWFpbENvbmZpZ3VyZWQoJHN1cHBsaWVyKSkgewovLyAgICAgICAgICAgICAgICAvLyBwcmVwYXJlIG1haWwgZGF0YQovLyAgICAgICAgICAgICAgICAkZGF0YVsiZW1haWwiXSA9ICRzdXBwbGllckVtYWlsOwovLyAgICAgICAgICAgICAgICAkZGF0YVsidGl0bGUiXSA9ICJQdXJjaGFzZSBPcmRlciBDYW5jZWxsZWQgRW1haWwiOwovLyAgICAgICAgICAgICAgICAkZGF0YVsicmVmZXJlbmNlX25vIl0gPSAkcHVyY2hhc2VPcmRlci0+cmVmZXJlbmNlX25vOwovLyAgICAgICAgICAgICAgICAkZGF0YVsicHVyY2hhc2VPcmRlciJdID0gJHB1cmNoYXNlT3JkZXI7Ci8vICAgICAgICAgICAgICAgICRkYXRhWyJtYWlsX2JvZHkiXSA9ICdwbXMuYmFja2VuZC5wYWdlcy5iaWxsaW5nLnBvLWludm9pY2UtcGRmJzsKLy8gICAgICAgICAgICAgICAgJGRhdGFbJ2ZsYWcnXSA9ICdjYW5jZWxsZWQnOwovLwovLyAgICAgICAgICAgICAgICAkdmlldyA9ICdwbXMuYmFja2VuZC5tYWlsLnBvX21haWxfYm9keSc7Ci8vICAgICAgICAgICAgICAgIHNlbmRFbWFpbCgkdmlldywgJGRhdGEsICRkYXRhWyd0aXRsZSddLCAkZGF0YVsiZW1haWwiXSwgW10sIFtdLCBbXSk7Ci8vICAgICAgICAgICAgfQoKCiAgICAgICAgICAgIC8vTm90aWZpY2F0aW9uCiAgICAgICAgICAgIC8vICRtZXNzYWdlID0gJzxzcGFuIGNsYXNzPSJub3RpZmljYXRpb24tbGlua3MiIGRhdGEtc3JjPSInLnJvdXRlKCdwbXMucHVyY2hhc2Uub3JkZXItbGlzdC5zaG93JywkcHVyY2hhc2VPcmRlci0+aWQpLic/dmlldyIgZGF0YS10aXRsZT0iUHVyY2hhc2UgT3JkZXIgRGV0YWlscyI+UmVmZXJlbmNlIE5vOicuJHB1cmNoYXNlT3JkZXItPnJlZmVyZW5jZV9uby4nLiBXYWl0aW5nIEZvciBHYXRlIEluLjwvc3Bhbj4nOwoKICAgICAgICAgICAgLy8gQ3JlYXRlT3JVcGRhdGVOb3RpZmljYXRpb24oJG1lc3NhZ2UsJ3VucmVhZCcsJycsZ2V0TWFuYWdlckluZm8oJ0dhdGUgUGVybWlzc2lvbicsJHB1cmNoYXNlT3JkZXItPmhyX3VuaXRfaWQpLCdzZW5kLXRvLWdhdGUtbWFuYWdlcicpOwoKICAgICAgICAgICAgREI6OmNvbW1pdCgpOwogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gdHJ1ZSwKICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAiUHVyY2hhc2UgaGFzIGJlZW4gY2FuY2VsbGVkIHN1Y2Nlc3NmdWxseS4iCiAgICAgICAgICAgIF0pOwogICAgICAgIH0gY2F0Y2ggKFxUaHJvd2FibGUgJHRoKSB7CiAgICAgICAgICAgIERCOjpyb2xsYmFjaygpOwogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gZmFsc2UsCiAgICAgICAgICAgICAgICAnbWVzc2FnZScgPT4gJHRoLT5nZXRNZXNzYWdlKCkKICAgICAgICAgICAgXSk7CiAgICAgICAgfQogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBjYW5jZWxsZWRMaXN0KCkKICAgIHsKICAgICAgICB0cnkgewoKICAgICAgICAgICAgJHRpdGxlID0gJ1B1cmNoYXNlIE9yZGVyIENhbmNlbGxlZCBMaXN0JzsKICAgICAgICAgICAgJHB1cmNoYXNlT3JkZXJMaXN0ID0gUHVyY2hhc2VPcmRlcjo6d2l0aChbCiAgICAgICAgICAgICAgICAncmVsUXVvdGF0aW9uLnJlbFN1cHBsaWVycycsCiAgICAgICAgICAgICAgICAncmVsR29vZFJlY2VpdmVOb3RlJywKICAgICAgICAgICAgICAgICdyZWxRdW90YXRpb24uZXhjaGFuZ2VSYXRlLmN1cnJlbmN5JwogICAgICAgICAgICBdKQogICAgICAgICAgICAgICAgLT53aGVuKCFhdXRoKCktPnVzZXIoKS0+aGFzQW55Um9sZShbJ1B1cmNoYXNlLURlcGFydG1lbnQnLCAnQXVkaXQnLCAnQmlsbGluZycsICdNYW5hZ2VtZW50JywgJ0FjY291bnRzJ10pLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3B1cmNoYXNlT3JkZXJSZXF1aXNpdGlvbnMucmVxdWlzaXRpb24nLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdhc3NpZ25lZF91c2VyX2lkJywgYXV0aCgpLT51c2VyKCktPmlkKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPndoZXJlSW4oJ2hyX3VuaXRfaWQnLCBhdXRoKCktPnVzZXIoKS0+cHJpb3JpdGllcy0+cGx1Y2soJ2hyX3VuaXRfaWQnKS0+dG9BcnJheSgpKQogICAgICAgICAgICAgICAgLT53aGVyZUhhcygncmVsUXVvdGF0aW9uJywgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlTm90SW4oJ3R5cGUnLCBbJ2RpcmVjdC1wdXJjaGFzZSddKTsKICAgICAgICAgICAgICAgIH0pLT53aGVyZSgnaXNfc2VuZCcsIFsnaGFsdCddKQogICAgICAgICAgICAgICAgLT53aGVuKCFkYXRhdGFibGVPcmRlcmluZygpLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+b3JkZXJieSgnaWQnLCAnZGVzYycpOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAkb3B0aW9ucyA9IFsKICAgICAgICAgICAgICAgICdyZXN0b3JlLXBvJyA9PiBhdXRoKCktPnVzZXIoKS0+aGFzUGVybWlzc2lvblRvKCdyZXN0b3JlLXBvJyksCiAgICAgICAgICAgIF07CgogICAgICAgICAgICBpZiAocmVxdWVzdCgpLT5hamF4KCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBEYXRhVGFibGVzOjpvZigkcHVyY2hhc2VPcmRlckxpc3QpCiAgICAgICAgICAgICAgICAgICAgLT5hZGRJbmRleENvbHVtbigpCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2FwcHJvdmFsX2RhdGUnLCBmdW5jdGlvbiAoJHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGF0ZSgnWS1tLWQnLCBzdHJ0b3RpbWUoJHZhbHVlcy0+cG9fZGF0ZSkpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ2FwcHJvdmFsX2RhdGUnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdwb19kYXRlJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdhcHByb3ZhbF9kYXRlJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyQnkoJ3BvX2RhdGUnLCAkb3JkZXIpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5lZGl0Q29sdW1uKCdyZWZlcmVuY2Vfbm8nLCBmdW5jdGlvbiAoJHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgb25jbGljaz0icHVyY2hhc2VPcmRlckRldGFpbHMoJCh0aGlzKSkiIGNsYXNzPSJidG4gYnRuLWxpbmsiIGRhdGEtc3JjPSInIC4gcm91dGUoJ3Btcy5wdXJjaGFzZS5vcmRlci1saXN0LnNob3cnLCAkdmFsdWVzLT5pZCkgLiAnIj4nIC4gJHZhbHVlcy0+cmVmZXJlbmNlX25vIC4gJzwvYT4nOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3N1cHBsaWVyJywgZnVuY3Rpb24gKCR2YWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzc2V0KCR2YWx1ZXMtPnJlbFF1b3RhdGlvbi0+cmVsU3VwcGxpZXJzKSA/IChpc3NldCgkdmFsdWVzLT5yZWxRdW90YXRpb24tPnJlbFN1cHBsaWVycy0+bmFtZSkgPyAkdmFsdWVzLT5yZWxRdW90YXRpb24tPnJlbFN1cHBsaWVycy0+bmFtZSAuICcgKCcgLiAkdmFsdWVzLT5yZWxRdW90YXRpb24tPnJlbFN1cHBsaWVycy0+Y29kZSAuICcpJyA6ICcnKSA6ICcnOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3N1cHBsaWVyJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFF1b3RhdGlvbi5yZWxTdXBwbGllcnMnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZShmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+b3JXaGVyZSgnY29kZScsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbignc3VwcGxpZXInLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRvcmRlciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFF1b3RhdGlvbnM6OnNlbGVjdCgnc3VwcGxpZXJzLm5hbWUnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbignc3VwcGxpZXJzJywgJ3N1cHBsaWVycy5pZCcsICc9JywgJ3F1b3RhdGlvbnMuc3VwcGxpZXJfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3F1b3RhdGlvbnMuaWQnLCAncHVyY2hhc2Vfb3JkZXJzLnF1b3RhdGlvbl9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLT50YWtlKDEpCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbigncXVvdGF0aW9uX3JlZl9ubycsIGZ1bmN0aW9uICgkdmFsdWVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpc3NldCgkdmFsdWVzLT5yZWxRdW90YXRpb24tPnJlZmVyZW5jZV9ubykgPyAkdmFsdWVzLT5yZWxRdW90YXRpb24tPnJlZmVyZW5jZV9ubyA6ICcnOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3F1b3RhdGlvbl9yZWZfbm8nLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUXVvdGF0aW9uJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgncmVmZXJlbmNlX25vJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbigncXVvdGF0aW9uX3JlZl9ubycsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJG9yZGVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgUXVvdGF0aW9uczo6c2VsZWN0KCdxdW90YXRpb25zLnJlZmVyZW5jZV9ubycpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbigncXVvdGF0aW9ucy5pZCcsICdwdXJjaGFzZV9vcmRlcnMucXVvdGF0aW9uX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZWRpdENvbHVtbigndG90YWxfcHJpY2UnLCBmdW5jdGlvbiAoJHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKChpc3NldCgkdmFsdWVzLT5yZWxRdW90YXRpb24tPmV4Y2hhbmdlUmF0ZS0+Y3VycmVuY3ktPnN5bWJvbCkgPyAkdmFsdWVzLT5yZWxRdW90YXRpb24tPmV4Y2hhbmdlUmF0ZS0+Y3VycmVuY3ktPnN5bWJvbCA6ICcnKSAuICcgJyAuIHN5c3RlbU1vbmV5Rm9ybWF0KCR2YWx1ZXMtPnRvdGFsX3ByaWNlKSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmVkaXRDb2x1bW4oJ3ZhdCcsIGZ1bmN0aW9uICgkdmFsdWVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoKGlzc2V0KCR2YWx1ZXMtPnJlbFF1b3RhdGlvbi0+ZXhjaGFuZ2VSYXRlLT5jdXJyZW5jeS0+c3ltYm9sKSA/ICR2YWx1ZXMtPnJlbFF1b3RhdGlvbi0+ZXhjaGFuZ2VSYXRlLT5jdXJyZW5jeS0+c3ltYm9sIDogJycpIC4gJyAnIC4gc3lzdGVtTW9uZXlGb3JtYXQoJHZhbHVlcy0+dmF0KSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmVkaXRDb2x1bW4oJ3gnLCBmdW5jdGlvbiAoJHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKChpc3NldCgkdmFsdWVzLT5yZWxRdW90YXRpb24tPmV4Y2hhbmdlUmF0ZS0+Y3VycmVuY3ktPnN5bWJvbCkgPyAkdmFsdWVzLT5yZWxRdW90YXRpb24tPmV4Y2hhbmdlUmF0ZS0+Y3VycmVuY3ktPnN5bWJvbCA6ICcnKSAuICcgJyAuIHN5c3RlbU1vbmV5Rm9ybWF0KCR2YWx1ZXMtPmdyb3NzX3ByaWNlKSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignYWN0aW9ucycsIGZ1bmN0aW9uICgkdmFsdWVzKSB1c2UgKCRvcHRpb25zKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zID0gJyc7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHZhbHVlcy0+cmVsR29vZFJlY2VpdmVOb3RlLT5jb3VudCgpID09IDAgJiYgIVF1b3RhdGlvbnM6OndoZXJlKCdwYXJlbnRfcXVvdGF0aW9uX2lkJywgJHZhbHVlcy0+cXVvdGF0aW9uX2lkKS0+ZXhpc3RzKCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkb3B0aW9uc1sncmVzdG9yZS1wbyddKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxhIGRhdGEtc3JjPSInIC4gcm91dGUoJ3Btcy5wdXJjaGFzZS5yZXN0b3JlLnBvJywgJHZhbHVlcy0+aWQpIC4gJyIgY2xhc3M9ImJ0biBidG4teHMgYnRuLXN1Y2Nlc3MgcmVzdG9yZVBvIG0tMSIgdGl0bGU9IlJlc3RvcmUgUHVyY2hhc2UgT3JkZXIiIG9uY2xpY2s9InBvQWN0aW9ucygkKHRoaXMpKSI+PGkgY2xhc3M9ImxhcyBsYS1yZWRvLWFsdCI+PC9pPjwvYT4nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIVF1b3RhdGlvbnM6OndoZXJlKCdwYXJlbnRfcXVvdGF0aW9uX2lkJywgJHZhbHVlcy0+cXVvdGF0aW9uX2lkKS0+ZXhpc3RzKCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICcgPGEgdGFyZ2V0PSJfYmxhbmsiIGhyZWY9IicgLiByb3V0ZSgncG1zLnJmcC5yZWdlbmVyYXRlLnRvLnB1cmNoYXNlJywgJHZhbHVlcy0+cXVvdGF0aW9uX2lkKSAuICciICB0aXRsZT0iUmVnZW5lcmF0ZSBQTyIgY2xhc3M9ImJ0biBidG4teHMgYnRuLWluZm8gbS0xIj48aSBjbGFzcz0ibGFzIGxhLXJlY3ljbGUiPjwvaT48L2E+JzsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJyA8YSB0YXJnZXQ9Il9ibGFuayIgaHJlZj0iJyAuIHJvdXRlKCdwbXMuYmlsbGluZy1hdWRpdC5wby5pbnZvaWNlLnByaW50JywgJHZhbHVlcy0+aWQpIC4gJyIgIHRpdGxlPSJQdXJjaGFzZSBPcmRlciBQcmludCBWaWV3IiBjbGFzcz0iYnRuIGJ0bi14cyBidG4td2FybmluZyBtLTEiPjxpIGNsYXNzPSJsYXMgbGEtcHJpbnQiPjwvaT48L2E+JzsKCiAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICcgPGEgdGFyZ2V0PSJfYmxhbmsiIGhyZWY9IicgLiByb3V0ZSgncG1zLmJpbGxpbmctYXVkaXQucG8uaGlzdG9yeScsICR2YWx1ZXMtPmlkKSAuICciICB0aXRsZT0iUE8gSGlzdG9yeSIgY2xhc3M9ImJ0biBidG4teHMgYnRuLWluZm8gbS0xIj48aSBjbGFzcz0ibGFzIGxhLXVzZXItY2xvY2siPjwvaT48L2E+JzsKCiAgICAgICAgICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbklkID0gJHZhbHVlcy0+cmVsUXVvdGF0aW9uLT5yZWxSZXF1ZXN0UHJvcG9zYWwtPnJlcXVlc3RQcm9wb3NhbFJlcXVpc2l0aW9uLT5maXJzdCgpLT5yZXF1aXNpdGlvbl9pZDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRyZXF1aXNpdGlvbklkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnPGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiB0aXRsZT0iVHJhY2sgUHJvZ3Jlc3MiCiAgICAgICAgICAgICAgICAgICAgICAgICBjbGFzcz0idHJhY2tpbmdSZXF1aXN0aW9uU3RhdHVzIGJ0biBidG4teHMgYnRuLXN1Y2Nlc3MiIG9uY2xpY2s9InRyYWNrUmVxdWlzaXRpb25Qcm9ncmVzcygkKHRoaXMpKSIgZGF0YS1pZD0iJyAuICRyZXF1aXNpdGlvbklkIC4gJyI+PGkgY2xhc3M9ImxhIGxhLW1hcCI+PC9pPjwvYT4nOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGFjdGlvbnM7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPnJhd0NvbHVtbnMoWydyZWZlcmVuY2Vfbm8nLCAnc3VwcGxpZXInLCAndG90YWxfcHJpY2UnLCAndmF0JywgJ2dyb3NzX3ByaWNlJywgJ2FjdGlvbnMnXSkKICAgICAgICAgICAgICAgICAgICAtPm1ha2UodHJ1ZSk7CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMucHVyY2hhc2UuY2FuY2VsbGVkLWxpc3QnLCBbCiAgICAgICAgICAgICAgICAndGl0bGUnID0+ICR0aXRsZSwKICAgICAgICAgICAgICAgICdoZWFkZXJDb2x1bW5zJyA9PiAkdGhpcy0+aGVhZGVyQ29sdW1ucygpCiAgICAgICAgICAgIF0pOwogICAgICAgIH0gY2F0Y2ggKFxUaHJvd2FibGUgJHRoKSB7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiB3b3JrT3JkZXJSZXN0b3JlKCRpZCkKICAgIHsKICAgICAgICBEQjo6YmVnaW5UcmFuc2FjdGlvbigpOwogICAgICAgIHRyeSB7CgogICAgICAgICAgICAkcHVyY2hhc2VPcmRlciA9IFB1cmNoYXNlT3JkZXI6OmZpbmRPckZhaWwoJGlkKTsKICAgICAgICAgICAgJHB1cmNoYXNlT3JkZXItPmlzX3NlbmQgPSAnbm8nOwogICAgICAgICAgICAkcHVyY2hhc2VPcmRlci0+c2F2ZSgpOwoKICAgICAgICAgICAgJHN1cHBsaWVyID0gJHB1cmNoYXNlT3JkZXItPnJlbFF1b3RhdGlvbi0+cmVsU3VwcGxpZXJzID8/IG51bGw7CiAgICAgICAgICAgICRzdXBwbGllckVtYWlsID0gJHN1cHBsaWVyID8gJHN1cHBsaWVyLT5lbWFpbCA6IG51bGw7CgovLyAgICAgICAgICAgIGlmIChpc01haWxDb25maWd1cmVkKCRzdXBwbGllcikpIHsKLy8gICAgICAgICAgICAgICAgLy8gcHJlcGFyZSBtYWlsIGRhdGEKLy8gICAgICAgICAgICAgICAgJGRhdGFbImVtYWlsIl0gPSAkc3VwcGxpZXJFbWFpbDsKLy8gICAgICAgICAgICAgICAgJGRhdGFbInRpdGxlIl0gPSAiUHVyY2hhc2UgT3JkZXIgUmV2aXNlZCBFbWFpbCI7Ci8vICAgICAgICAgICAgICAgICRkYXRhWyJyZWZlcmVuY2Vfbm8iXSA9ICRwdXJjaGFzZU9yZGVyLT5yZWZlcmVuY2Vfbm87Ci8vICAgICAgICAgICAgICAgICRkYXRhWyJwdXJjaGFzZU9yZGVyIl0gPSAkcHVyY2hhc2VPcmRlcjsKLy8gICAgICAgICAgICAgICAgJGRhdGFbIm1haWxfYm9keSJdID0gJ3Btcy5iYWNrZW5kLnBhZ2VzLmJpbGxpbmcucG8taW52b2ljZS1wZGYnOwovLyAgICAgICAgICAgICAgICAkdmlldyA9ICdwbXMuYmFja2VuZC5tYWlsLnBvX21haWxfYm9keSc7Ci8vICAgICAgICAgICAgICAgICRkYXRhWydmbGFnJ10gPSAncmVzdG9yZSc7Ci8vCi8vICAgICAgICAgICAgICAgIHNlbmRFbWFpbCgkdmlldywgJGRhdGEsICRkYXRhWyd0aXRsZSddLCAkZGF0YVsiZW1haWwiXSwgW10sIFtdLCBbXSk7Ci8vICAgICAgICAgICAgfQoKCiAgICAgICAgICAgIC8vTm90aWZpY2F0aW9uCiAgICAgICAgICAgIC8vICRtZXNzYWdlID0gJzxzcGFuIGNsYXNzPSJub3RpZmljYXRpb24tbGlua3MiIGRhdGEtc3JjPSInLnJvdXRlKCdwbXMucHVyY2hhc2Uub3JkZXItbGlzdC5zaG93JywkcHVyY2hhc2VPcmRlci0+aWQpLic/dmlldyIgZGF0YS10aXRsZT0iUHVyY2hhc2UgT3JkZXIgRGV0YWlscyI+UmVmZXJlbmNlIE5vOicuJHB1cmNoYXNlT3JkZXItPnJlZmVyZW5jZV9uby4nLiBXYWl0aW5nIEZvciBHYXRlIEluLjwvc3Bhbj4nOwoKICAgICAgICAgICAgLy8gQ3JlYXRlT3JVcGRhdGVOb3RpZmljYXRpb24oJG1lc3NhZ2UsJ3VucmVhZCcsJycsZ2V0TWFuYWdlckluZm8oJ0dhdGUgUGVybWlzc2lvbicsJHB1cmNoYXNlT3JkZXItPmhyX3VuaXRfaWQpLCdzZW5kLXRvLWdhdGUtbWFuYWdlcicpOwoKICAgICAgICAgICAgREI6OmNvbW1pdCgpOwogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gdHJ1ZSwKICAgICAgICAgICAgICAgICJtZXNzYWdlIiA9PiAiUHVyY2hhc2UgT3JkZXIgaGFzIGJlZW4gcmVzdG9yZWQgc3VjY2Vzc2Z1bGx5LiIKICAgICAgICAgICAgXSk7CiAgICAgICAgfSBjYXRjaCAoXFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgREI6OnJvbGxiYWNrKCk7CiAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiBmYWxzZSwKICAgICAgICAgICAgICAgICJtZXNzYWdlIiA9PiAkdGgtPmdldE1lc3NhZ2UoKQogICAgICAgICAgICBdKTsKICAgICAgICB9CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIHJldmlzZVBvKCRwdXJjaGFzZUlkKQogICAgewogICAgICAgICR0aXRsZSA9ICdQdXJjaGFzZSBPcmRlciBSZXZpc2UnOwoKICAgICAgICAkcHVyY2hhc2VPcmRlciA9IFB1cmNoYXNlT3JkZXI6OmZpbmRPckZhaWwoJHB1cmNoYXNlSWQpOwoKICAgICAgICAkcXVvdGF0aW9uID0gUXVvdGF0aW9uczo6d2l0aChbCiAgICAgICAgICAgICdyZWxRdW90YXRpb25JdGVtcycsCiAgICAgICAgICAgICdyZWxSZXF1ZXN0UHJvcG9zYWwucmVxdWVzdFByb3Bvc2FsUmVxdWlzaXRpb24nCiAgICAgICAgXSktPndoZXJlKFsnc3RhdHVzJyA9PiAnYWN0aXZlJywgJ2lzX2FwcHJvdmVkJyA9PiAnYXBwcm92ZWQnLCAnaWQnID0+ICRwdXJjaGFzZU9yZGVyLT5xdW90YXRpb25faWRdKS0+Zmlyc3QoKTsKCiAgICAgICAgJHVuY29tbW9uID0gQ2F0ZWdvcnk6OndoZXJlSGFzKCdzdWJDYXRlZ29yeS5wcm9kdWN0cycsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJHF1b3RhdGlvbikgewogICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUluKCdpZCcsICRxdW90YXRpb24tPnJlbFF1b3RhdGlvbkl0ZW1zLT5wbHVjaygncHJvZHVjdF9pZCcpLT50b0FycmF5KCkpOwogICAgICAgIH0pLT53aGVyZSgndHlwZScsICd1bmNvbW1vbicpLT5jb3VudCgpOwoKICAgICAgICAkcmVxdWlzaXRpb25zID0gUmVxdWlzaXRpb246OndpdGgoWwogICAgICAgICAgICAncmVsVXNlcnNMaXN0LmVtcGxveWVlJwogICAgICAgIF0pCiAgICAgICAgICAgIC0+d2hlcmVIYXMoJ3JlcXVlc3RQcm9wb3NhbFJlcXVpc2l0aW9uLnJlbFJlcXVlc3RQcm9wb3NhbC5yZWxRdW90YXRpb25zJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgkcXVvdGF0aW9uKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnaWQnLCAkcXVvdGF0aW9uLT5pZCk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+d2hlcmVIYXMoJ2l0ZW1zJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgkcXVvdGF0aW9uKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUluKCdwcm9kdWN0X2lkJywgJHF1b3RhdGlvbi0+cmVsUXVvdGF0aW9uSXRlbXMtPndoZXJlKCdpc19hcHByb3ZlZCcsICdhcHByb3ZlZCcpLT5wbHVjaygncHJvZHVjdF9pZCcpLT50b0FycmF5KCkpOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPmdldCgpOwoKICAgICAgICAkdW5pdF9pZHMgPSAkcmVxdWlzaXRpb25zLT5wbHVjaygnaHJfdW5pdF9pZCcpLT50b0FycmF5KCk7CiAgICAgICAgJGRlcGFydG1lbnRfaWRzID0gW107CiAgICAgICAgaWYgKCRyZXF1aXNpdGlvbnMtPmNvdW50KCkgPiAwKSB7CiAgICAgICAgICAgIGZvcmVhY2ggKCRyZXF1aXNpdGlvbnMgYXMgJGtleSA9PiAkcmVxdWlzaXRpb24pIHsKICAgICAgICAgICAgICAgIGFycmF5X3B1c2goJGRlcGFydG1lbnRfaWRzLCAkcmVxdWlzaXRpb24tPnJlbFVzZXJzTGlzdC0+ZW1wbG95ZWUtPmFzX2RlcGFydG1lbnRfaWQpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0cnkgewoKICAgICAgICAgICAgJHVuaXRzID0gVW5pdDo6d2hlcmVJbignaHJfdW5pdF9pZCcsICR1bml0X2lkcyktPmdldCgpOwogICAgICAgICAgICAkZGVwYXJ0bWVudHMgPSBEZXBhcnRtZW50Ojp3aGVyZUluKCdocl9kZXBhcnRtZW50X2lkJywgJGRlcGFydG1lbnRfaWRzKS0+Z2V0KCk7CgogICAgICAgICAgICAkc3lzdGVtQ3VycmVuY3kgPSBzeXN0ZW1DdXJyZW5jeSgpOwogICAgICAgICAgICAkY3VycmVuY3kgPSAkcXVvdGF0aW9uLT5leGNoYW5nZVJhdGUtPmN1cnJlbmN5LT5jb2RlOwogICAgICAgICAgICAkZXhjaGFuZ2VSYXRlID0gZXhjaGFuZ2VSYXRlKCRxdW90YXRpb24tPmV4Y2hhbmdlUmF0ZSwgJHN5c3RlbUN1cnJlbmN5LT5pZCk7CiAgICAgICAgICAgICRzYW1lID0gKCRzeXN0ZW1DdXJyZW5jeS0+aWQgPT0gJHF1b3RhdGlvbi0+ZXhjaGFuZ2VSYXRlLT5jdXJyZW5jeV9pZCA/IHRydWUgOiBmYWxzZSk7CgogICAgICAgICAgICAkc3VwcGxpZXJQYXltZW50VGVybXMgPSBzdXBwbGllclBheW1lbnRUZXJtKCk7CiAgICAgICAgICAgICRwYXltZW50VGVybXMgPSBQYXltZW50VGVybTo6YWxsKCk7CgogICAgICAgICAgICAvL3dhcmVob3VzZSBnZXR0aW5nCiAgICAgICAgICAgICR3YXJlaG91c2VfaWRzID0gQXV0aDo6dXNlcigpLT5yZWxVc2Vyc1dhcmVob3VzZS0+cGx1Y2soJ2lkJyktPmFsbCgpOwoKICAgICAgICAgICAgaWYgKGNvdW50KCR3YXJlaG91c2VfaWRzKSA+IDApIHsKICAgICAgICAgICAgICAgICR3YXJlaG91c2VzID0gV2FyZWhvdXNlczo6d2hlcmVJbignaWQnLCAkd2FyZWhvdXNlX2lkcyktPnNlbGVjdCgnbmFtZScsICdpZCcpLT5nZXQoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICR3YXJlaG91c2VzID0gV2FyZWhvdXNlczo6c2VsZWN0KCduYW1lJywgJ2lkJyktPmdldCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMucHVyY2hhc2UucmV2aXNlLXB1cmNoYXNlLW9yZGVyJywgY29tcGFjdCgndGl0bGUnLCAncXVvdGF0aW9uJywgJ3VuaXRzJywgJ2RlcGFydG1lbnRzJywgJ3VuY29tbW9uJywgJ3N5c3RlbUN1cnJlbmN5JywgJ2V4Y2hhbmdlUmF0ZScsICdjdXJyZW5jeScsICdzYW1lJywgJ3B1cmNoYXNlT3JkZXInLCAnc3VwcGxpZXJQYXltZW50VGVybXMnLCAncGF5bWVudFRlcm1zJywgJ3dhcmVob3VzZXMnKSk7CiAgICAgICAgfSBjYXRjaCAoXFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIHVuaXRXaXNlUmVxdWlzaXRpb24oJHVuaXRJZCwgJHF1b3RhdGlvbklkKQogICAgewogICAgICAgIHRyeSB7CgogICAgICAgICAgICAkcHJvZHVjdElkcyA9IFF1b3RhdGlvbnNJdGVtczo6d2hlcmUoJ3F1b3RhdGlvbl9pZCcsICRxdW90YXRpb25JZCkKICAgICAgICAgICAgICAgIC0+cGx1Y2soJ3Byb2R1Y3RfaWQnKS0+dG9BcnJheSgpOwoKICAgICAgICAgICAgJGFycmF5MSA9IFJlcXVpc2l0aW9uOjp3aGVyZShbCiAgICAgICAgICAgICAgICAnaHJfdW5pdF9pZCcgPT4gJHVuaXRJZCwKICAgICAgICAgICAgICAgICdpc19wb19nZW5lcmF0ZScgPT4gJ25vJywKICAgICAgICAgICAgICAgICdpc19zZW5kX3RvX3JmcCcgPT4gJ3llcycsCiAgICAgICAgICAgICAgICAnZGVsaXZlcnlfc3RhdHVzJyA9PiAncmZwJywKICAgICAgICAgICAgICAgICdhcHByb3ZlZF9pZCcgPT4gMSwKICAgICAgICAgICAgICAgICdzdGF0dXMnID0+IDEsCiAgICAgICAgICAgIF0pCiAgICAgICAgICAgICAgICAtPndoZXJlSGFzKCdyZXF1aXNpdGlvbkl0ZW1zJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgkcHJvZHVjdElkcykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdpc19zZW5kJywgJ3llcycpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmUoJ3BvX2dlbmVyYXRlJywgJ3llcycpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVJbigncHJvZHVjdF9pZCcsICRwcm9kdWN0SWRzKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPndoZXJlSGFzKCdyZXF1ZXN0UHJvcG9zYWxSZXF1aXNpdGlvbi5yZWxSZXF1ZXN0UHJvcG9zYWwucmVsUXVvdGF0aW9ucycsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJHF1b3RhdGlvbklkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2lkJywgJHF1b3RhdGlvbklkKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPndoZW4ocmVxdWVzdCgpLT5nZXQoJ3VuY29tbW9uJykgPiAwLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFVzZXJzTGlzdC5lbXBsb3llZScsIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2FzX2RlcGFydG1lbnRfaWQnLCByZXF1ZXN0KCktPmdldCgnaHJfZGVwYXJ0bWVudF9pZCcpKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPnBsdWNrKCdpZCcpLT50b0FycmF5KCk7CgogICAgICAgICAgICAkYXJyYXkyID0gUmVxdWlzaXRpb246OndoZXJlKFsKICAgICAgICAgICAgICAgICdocl91bml0X2lkJyA9PiAkdW5pdElkLAogICAgICAgICAgICAgICAgJ2FwcHJvdmVkX2lkJyA9PiAxLAogICAgICAgICAgICAgICAgJ3N0YXR1cycgPT4gMSwKICAgICAgICAgICAgICAgICdpc19wb19nZW5lcmF0ZScgPT4gJ3llcycsCiAgICAgICAgICAgICAgICAnaXNfc2VuZF90b19yZnAnID0+ICd5ZXMnLAogICAgICAgICAgICAgICAgJ3JlcXVlc3Rfc3RhdHVzJyA9PiAnc2VuZF9yZnAnLAogICAgICAgICAgICAgICAgJ2RlbGl2ZXJ5X3N0YXR1cycgPT4gJ3BhcnRpYWwtZGVsaXZlcmVkJywKICAgICAgICAgICAgXSkKICAgICAgICAgICAgICAgIC0+d2hlcmVIYXMoJ3JlcXVpc2l0aW9uSXRlbXMnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRwcm9kdWN0SWRzKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2lzX3NlbmQnLCAneWVzJykKICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZSgncG9fZ2VuZXJhdGUnLCAneWVzJykKICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUluKCdwcm9kdWN0X2lkJywgJHByb2R1Y3RJZHMpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+d2hlcmVIYXMoJ3JlcXVlc3RQcm9wb3NhbFJlcXVpc2l0aW9uLnJlbFJlcXVlc3RQcm9wb3NhbC5yZWxRdW90YXRpb25zJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgkcXVvdGF0aW9uSWQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnaWQnLCAkcXVvdGF0aW9uSWQpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+d2hlbihyZXF1ZXN0KCktPmdldCgndW5jb21tb24nKSA+IDAsIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsVXNlcnNMaXN0LmVtcGxveWVlJywgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnYXNfZGVwYXJ0bWVudF9pZCcsIHJlcXVlc3QoKS0+Z2V0KCdocl9kZXBhcnRtZW50X2lkJykpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+cGx1Y2soJ2lkJyktPnRvQXJyYXkoKTsKCiAgICAgICAgICAgICRhcnJheSA9IGFycmF5X3VuaXF1ZShhcnJheV9tZXJnZSgkYXJyYXkxLCAkYXJyYXkyKSk7CgogICAgICAgICAgICByZXR1cm4gUmVxdWlzaXRpb246OndoZXJlSW4oJ2lkJywgJGFycmF5KS0+Z2V0KFsnaWQnLCAncmVmZXJlbmNlX25vJ10pOwogICAgICAgIH0gY2F0Y2ggKFxUaHJvd2FibGUgJHRoKSB7CiAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBEaXNwbGF5IGEgbGlzdGluZyBvZiB0aGUgcmVzb3VyY2UuCiAgICAgKgogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KCiAgICBwdWJsaWMgZnVuY3Rpb24gcmVxdWlzaXRpb25XaXNlSXRlbXNRdHkoUmVxdWVzdCAkcmVxdWVzdCkKICAgIHsKICAgICAgICB0cnkgewoKICAgICAgICAgICAgJGl0ZW1zID0gUXVvdGF0aW9uc0l0ZW1zOjp3aGVyZSgncXVvdGF0aW9uX2lkJywgJHJlcXVlc3QtPnF1b3RhdGlvbklkKS0+Z2V0KCk7CiAgICAgICAgICAgICRkYXRhID0gW107CiAgICAgICAgICAgIGlmIChpc3NldCgkaXRlbXNbMF0pKSB7CiAgICAgICAgICAgICAgICBmb3JlYWNoICgkaXRlbXMgYXMgJGtleSA9PiAkaXRlbSkgewogICAgICAgICAgICAgICAgICAgICRxdHkgPSBSZXF1aXNpdGlvbkl0ZW06OndoZXJlSW4oJ3JlcXVpc2l0aW9uX2lkJywgJHJlcXVlc3QtPnJlcXVpc2l0aW9uSWQpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmUoJ3Byb2R1Y3RfaWQnLCAkaXRlbS0+cHJvZHVjdF9pZCkKICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZSgnaXNfc2VuZCcsICd5ZXMnKQogICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlKCdwb19nZW5lcmF0ZScsICd5ZXMnKQogICAgICAgICAgICAgICAgICAgICAgICAtPnN1bSgncXR5Jyk7CgogICAgICAgICAgICAgICAgICAgICRkZWxpdmVyeVF0eSA9IFJlcXVpc2l0aW9uSXRlbTo6d2hlcmVJbigncmVxdWlzaXRpb25faWQnLCAkcmVxdWVzdC0+cmVxdWlzaXRpb25JZCkKICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZSgncHJvZHVjdF9pZCcsICRpdGVtLT5wcm9kdWN0X2lkKQogICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlKCdpc19zZW5kJywgJ3llcycpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmUoJ3BvX2dlbmVyYXRlJywgJ3llcycpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+c3VtKCdkZWxpdmVyeV9xdHknKTsKCiAgICAgICAgICAgICAgICAgICAgJGRhdGFbJGl0ZW0tPmlkXSA9ICgkZGVsaXZlcnlRdHkgPiAwKSA/ICRxdHkgLSAkZGVsaXZlcnlRdHkgOiAkcXR5OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gJGRhdGE7CiAgICAgICAgfSBjYXRjaCAoXFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIHJldmlzZVBvVXBkYXRlKFJlcXVlc3QgJHJlcXVlc3QsICRwdXJjaGFzZU9yZGVySWQpCiAgICB7CgogICAgICAgICR0aGlzLT52YWxpZGF0ZSgkcmVxdWVzdCwgWwogICAgICAgICAgICAncXVvdGF0aW9uX2lkJyA9PiAncmVxdWlyZWQnLAogICAgICAgICAgICAncG9fcXR5JyA9PiAncmVxdWlyZWQnLAogICAgICAgICAgICAncmVxdWlzaXRpb25faWQnID0+ICdyZXF1aXJlZCcsCiAgICAgICAgICAgICdocl91bml0X2lkJyA9PiAncmVxdWlyZWQnLAogICAgICAgICAgICAnY29zdF9jZW50cmVfaWQnID0+ICdyZXF1aXJlZCcsCiAgICAgICAgICAgICd3YXJlaG91c2VfaWQnID0+ICdudWxsYWJsZXxleGlzdHM6d2FyZWhvdXNlcyxpZCcsCiAgICAgICAgXSk7CgogICAgICAgICRmaWx0ZXJQb1F0eSA9IGFycmF5X2RpZmYoJHJlcXVlc3QtPnBvX3F0eSwgWzBdKTsKICAgICAgICAkY29sbGVjdFByb2R1Y3RJZCA9IGFycmF5X2tleXMoJGZpbHRlclBvUXR5KTsKCiAgICAgICAgaWYgKGFycmF5X3N1bSgkZmlsdGVyUG9RdHkpIDw9IDApIHsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCdQbGVhc2UgcG8gcXR5IGNhbiBub3QgYmUgMCcpOwogICAgICAgIH0KCiAgICAgICAgJG1vZGFsID0gUXVvdGF0aW9uczo6d2hlcmUoJ2lkJywgJHJlcXVlc3QtPnF1b3RhdGlvbl9pZCktPmZpcnN0KCk7CgogICAgICAgIC8vICRwcmVmaXggPSAnUE8tJy5kYXRlKCd5Jywgc3RydG90aW1lKGRhdGUoJ1ktbS1kJykpKS4nLScudW5pdE5hbWUoJHJlcXVlc3QtPmhyX3VuaXRfaWQpLT5ocl91bml0X3Nob3J0X25hbWUuJy0nOwogICAgICAgIC8vICRyZWZObyA9IHVuaXF1ZUNvZGUoMTYsJHByZWZpeCwncHVyY2hhc2Vfb3JkZXJzJywnaWQnKTsKCiAgICAgICAgREI6OmJlZ2luVHJhbnNhY3Rpb24oKTsKCiAgICAgICAgdHJ5IHsKCiAgICAgICAgICAgICRwb19kYXRhID0gUHVyY2hhc2VPcmRlcjo6ZmluZE9yRmFpbCgkcHVyY2hhc2VPcmRlcklkKTsKICAgICAgICAgICAgJHBvX2RhdGEtPmhyX3VuaXRfaWQgPSAkcmVxdWVzdC0+aHJfdW5pdF9pZDsKICAgICAgICAgICAgJHBvX2RhdGEtPnBvX2RhdGUgPSBkYXRlKCdZLW0tZCcsIHN0cnRvdGltZSgkcmVxdWVzdC0+cG9fZGF0ZSkpOwogICAgICAgICAgICAkcG9fZGF0YS0+cmV2aXNlX2NvdW50ID0gJHBvX2RhdGEtPnJldmlzZV9jb3VudCArIDE7CiAgICAgICAgICAgICRwb19kYXRhLT5yZW1hcmtzID0gJHJlcXVlc3QtPnJlbWFya3M7CiAgICAgICAgICAgICRwb19kYXRhLT50ZXJtcyA9ICRyZXF1ZXN0LT50ZXJtczsKICAgICAgICAgICAgJHBvX2RhdGEtPmNvc3RfY2VudHJlX2lkID0gJHJlcXVlc3QtPmNvc3RfY2VudHJlX2lkOwogICAgICAgICAgICAkcG9fZGF0YS0+d2FyZWhvdXNlX2lkID0gJHJlcXVlc3QtPndhcmVob3VzZV9pZDsKICAgICAgICAgICAgJHBvX2RhdGEtPnNhdmUoKTsKCiAgICAgICAgICAgICRwb1N1YlRvdGFsID0gMDsKICAgICAgICAgICAgJHBvVmF0ID0gMDsKICAgICAgICAgICAgJHBvR3Jvc3NUb3RhbCA9IDA7CgogICAgICAgICAgICAkaXRlbXMgPSBRdW90YXRpb25zSXRlbXM6OndoZXJlKCdxdW90YXRpb25faWQnLCAkbW9kYWwtPmlkKS0+d2hlcmVJbigndWlkJywgJGNvbGxlY3RQcm9kdWN0SWQpCiAgICAgICAgICAgICAgICAtPndoZXJlKCdpc19hcHByb3ZlZCcsICdhcHByb3ZlZCcpLT5nZXQoKTsKCiAgICAgICAgICAgIC8vZGVsZXRlIHB1cmNoYXNlIG9yZGVyIGl0ZW1zCiAgICAgICAgICAgICRwb19kYXRhLT5yZWxQdXJjaGFzZU9yZGVySXRlbXMoKS0+ZGVsZXRlKCk7CgogICAgICAgICAgICBmb3JlYWNoICgkaXRlbXMgYXMgJGtleSA9PiAkdmFsdWVzKSB7CgogICAgICAgICAgICAgICAgJGRpc2NvdW50X2Ftb3VudCA9ICR2YWx1ZXMtPnVuaXRfcHJpY2UgPiAwICYmICR2YWx1ZXMtPmFwcHJvdmVkX3F0eSA+IDAgJiYgJHJlcXVlc3QtPmRpc2NvdW50X3BlcmNlbnRhZ2VbJHZhbHVlcy0+aWRdID4gMCA/ICgkdmFsdWVzLT51bml0X3ByaWNlICogJHZhbHVlcy0+YXBwcm92ZWRfcXR5KSAqICgkcmVxdWVzdC0+ZGlzY291bnRfcGVyY2VudGFnZVskdmFsdWVzLT5pZF0gLyAxMDApIDogMDsKICAgICAgICAgICAgICAgICRhZnRlcl9kaXNjb3VudCA9ICgkdmFsdWVzLT51bml0X3ByaWNlICogJHZhbHVlcy0+YXBwcm92ZWRfcXR5KSAtICRkaXNjb3VudF9hbW91bnQ7CgogICAgICAgICAgICAgICAgJHZhbHVlcy0+ZGlzY291bnQgPSAkcmVxdWVzdC0+ZGlzY291bnRfcGVyY2VudGFnZVskdmFsdWVzLT5pZF07CiAgICAgICAgICAgICAgICAkdmFsdWVzLT5kaXNjb3VudF9hbW91bnQgPSAkZGlzY291bnRfYW1vdW50OwogICAgICAgICAgICAgICAgJHZhbHVlcy0+dmF0X3BlcmNlbnRhZ2UgPSAkcmVxdWVzdC0+dmF0X3BlcmNlbnRhZ2VbJHZhbHVlcy0+aWRdOwogICAgICAgICAgICAgICAgJHZhbHVlcy0+dmF0ID0gJGFmdGVyX2Rpc2NvdW50ID4gMCAmJiAkcmVxdWVzdC0+dmF0X3BlcmNlbnRhZ2VbJHZhbHVlcy0+aWRdID4gMCA/ICRhZnRlcl9kaXNjb3VudCAqICgkcmVxdWVzdC0+dmF0X3BlcmNlbnRhZ2VbJHZhbHVlcy0+aWRdIC8gMTAwKSA6IDA7CiAgICAgICAgICAgICAgICAkdmFsdWVzLT5zYXZlKCk7CgogICAgICAgICAgICAgICAgJGRpc2NvdW50ZWQgPSAoJHZhbHVlcy0+ZGlzY291bnQgPiAwID8gKCR2YWx1ZXMtPnVuaXRfcHJpY2UgKiAoJHZhbHVlcy0+ZGlzY291bnQgLyAxMDApKSA6IDApOwogICAgICAgICAgICAgICAgJHVuaXRfcHJpY2UgPSAoJHZhbHVlcy0+dW5pdF9wcmljZSAtICRkaXNjb3VudGVkKTsKCiAgICAgICAgICAgICAgICAkcG9RdHkgPSAkZmlsdGVyUG9RdHlbJHZhbHVlcy0+dWlkXTsKICAgICAgICAgICAgICAgICRzdWJUb3RhbCA9ICR1bml0X3ByaWNlICogJHBvUXR5OwogICAgICAgICAgICAgICAgJHBvU3ViVG90YWwgKz0gJHN1YlRvdGFsOwoKICAgICAgICAgICAgICAgIGlmICgkdmFsdWVzLT52YXRfdHlwZSA9PSAnaW5jbHVzaXZlJykgewogICAgICAgICAgICAgICAgICAgICR2YXRBbW91bnQgPSAoJHZhbHVlcy0+dmF0X3BlcmNlbnRhZ2UgPiAwICYmICRzdWJUb3RhbCA+IDAgPyAoKCRzdWJUb3RhbCAqICR2YWx1ZXMtPnZhdF9wZXJjZW50YWdlKSAvICgxMDAgKyAkdmFsdWVzLT52YXRfcGVyY2VudGFnZSkpIDogMCk7CiAgICAgICAgICAgICAgICAgICAgJGdyb3NzVG90YWwgPSAkc3ViVG90YWw7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCR2YWx1ZXMtPnZhdF90eXBlID09ICdleGNsdXNpdmUnKSB7CiAgICAgICAgICAgICAgICAgICAgJHZhdEFtb3VudCA9ICgkdmFsdWVzLT52YXRfcGVyY2VudGFnZSA+IDAgJiYgJHN1YlRvdGFsID4gMCA/ICgkc3ViVG90YWwgKiAoJHZhbHVlcy0+dmF0X3BlcmNlbnRhZ2UgLyAxMDApKSA6IDApOwogICAgICAgICAgICAgICAgICAgICRncm9zc1RvdGFsID0gKCRzdWJUb3RhbCArICR2YXRBbW91bnQpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAkdmF0QW1vdW50ID0gMDsKICAgICAgICAgICAgICAgICAgICAkZ3Jvc3NUb3RhbCA9ICRzdWJUb3RhbDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAkcG9WYXQgKz0gJHZhdEFtb3VudDsKICAgICAgICAgICAgICAgICRwb0dyb3NzVG90YWwgKz0gJGdyb3NzVG90YWw7CgogICAgICAgICAgICAgICAgJHBvX2l0ZW1zID0gbmV3IFB1cmNoYXNlT3JkZXJJdGVtKCk7CiAgICAgICAgICAgICAgICAkcG9faXRlbXMtPnBvX2lkID0gJHBvX2RhdGEtPmlkOwogICAgICAgICAgICAgICAgJHBvX2l0ZW1zLT51aWQgPSAkdmFsdWVzLT51aWQ7CiAgICAgICAgICAgICAgICAkcG9faXRlbXMtPnByb2R1Y3RfaWQgPSAkdmFsdWVzLT5wcm9kdWN0X2lkOwogICAgICAgICAgICAgICAgJHBvX2l0ZW1zLT51bml0X3ByaWNlID0gJHVuaXRfcHJpY2U7CiAgICAgICAgICAgICAgICAkcG9faXRlbXMtPnF0eSA9ICRwb1F0eTsKICAgICAgICAgICAgICAgICRwb19pdGVtcy0+c3ViX3RvdGFsX3ByaWNlID0gJHN1YlRvdGFsOwogICAgICAgICAgICAgICAgJHBvX2l0ZW1zLT5kaXNjb3VudF9wZXJjZW50YWdlID0gMDsKICAgICAgICAgICAgICAgICRwb19pdGVtcy0+ZGlzY291bnQgPSAwOwogICAgICAgICAgICAgICAgJHBvX2l0ZW1zLT52YXRfdHlwZSA9ICR2YWx1ZXMtPnZhdF90eXBlOwogICAgICAgICAgICAgICAgJHBvX2l0ZW1zLT52YXRfcGVyY2VudGFnZSA9ICR2YWx1ZXMtPnZhdF9wZXJjZW50YWdlOwogICAgICAgICAgICAgICAgJHBvX2l0ZW1zLT52YXQgPSAkdmF0QW1vdW50OwogICAgICAgICAgICAgICAgJHBvX2l0ZW1zLT50b3RhbF9wcmljZSA9ICRncm9zc1RvdGFsOwogICAgICAgICAgICAgICAgJHBvX2l0ZW1zLT5zYXZlKCk7CgogICAgICAgICAgICAgICAgJHZhbHVlcy0+ZGVzY3JpcHRpb24gPSAkcmVxdWVzdC0+ZGVzY3JpcHRpb25bJHZhbHVlcy0+aWRdOwogICAgICAgICAgICAgICAgJHZhbHVlcy0+aXNfcG9fZ2VuZXJhdGUgPSAneWVzJzsKICAgICAgICAgICAgICAgICR2YWx1ZXMtPnNhdmUoKTsKCiAgICAgICAgICAgICAgICAvL3VwZGF0ZSBsYXRlc3QgcHJvZHVjdCBwcmljZQogICAgICAgICAgICAgICAgbGF0ZXN0UHJvZHVjdFByaWNlVXBkYXRlKCR2YWx1ZXMtPnByb2R1Y3RfaWQsICR1bml0X3ByaWNlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy9VcGRhdGUgUHVyY2hhc2UgT3JkZXIKICAgICAgICAgICAgUHVyY2hhc2VPcmRlcjo6d2hlcmUoJ2lkJywgJHBvX2RhdGEtPmlkKQogICAgICAgICAgICAgICAgLT51cGRhdGUoWwogICAgICAgICAgICAgICAgICAgICd0b3RhbF9wcmljZScgPT4gUHVyY2hhc2VPcmRlckl0ZW06OndoZXJlKCdwb19pZCcsICRwb19kYXRhLT5pZCktPnN1bSgnc3ViX3RvdGFsX3ByaWNlJyksCiAgICAgICAgICAgICAgICAgICAgJ2Rpc2NvdW50JyA9PiAwLAogICAgICAgICAgICAgICAgICAgICd2YXQnID0+IFB1cmNoYXNlT3JkZXJJdGVtOjp3aGVyZSgncG9faWQnLCAkcG9fZGF0YS0+aWQpLT5zdW0oJ3ZhdCcpLAogICAgICAgICAgICAgICAgICAgICdncm9zc19wcmljZScgPT4gUHVyY2hhc2VPcmRlckl0ZW06OndoZXJlKCdwb19pZCcsICRwb19kYXRhLT5pZCktPnN1bSgndG90YWxfcHJpY2UnKSwKICAgICAgICAgICAgICAgIF0pOwoKICAgICAgICAgICAgaWYgKCRtb2RhbC0+cmVsU3VwcGxpZXJQYXltZW50VGVybS0+dHlwZSA9PSAncGFpZCcpIHsKICAgICAgICAgICAgICAgIC8vQWRkIFN1cHBsaWVyIFBheW1lbnRzCiAgICAgICAgICAgICAgICAkZHVyYXRpb25fZGF0ZSA9ICRtb2RhbC0+cmVsU3VwcGxpZXJQYXltZW50VGVybS0+ZGF5X2R1cmF0aW9uOwogICAgICAgICAgICAgICAgJHBheV9kYXRlID0gZGF0ZSgnWS1tLWQgaDppOnMnLCBzdHJ0b3RpbWUoJysnIC4gJGR1cmF0aW9uX2RhdGUgLiAnIGRheScsIHN0cnRvdGltZSgkcG9fZGF0YS0+cG9fZGF0ZSkpKTsKICAgICAgICAgICAgICAgIC8vUGF5bWVudCBkYXRlIGJhc2VkIG9uIGFkdmFuY2UgJiBkdWUKICAgICAgICAgICAgICAgICRwYXlfYW1vdW50ID0gKCRtb2RhbC0+cmVsU3VwcGxpZXJQYXltZW50VGVybS0+cGF5bWVudF9wZXJjZW50ID4gMCAmJiAkcG9Hcm9zc1RvdGFsID4gMCA/ICgkbW9kYWwtPnJlbFN1cHBsaWVyUGF5bWVudFRlcm0tPnBheW1lbnRfcGVyY2VudCAqICRwb0dyb3NzVG90YWwpIC8gMTAwIDogMCk7CiAgICAgICAgICAgICAgICBpZiAoJHBheV9hbW91bnQgPiAwKSB7CgogICAgICAgICAgICAgICAgICAgICRzdXBwbGllcl9wYXltZW50ID0gU3VwcGxpZXJQYXltZW50Ojp3aGVyZShbJ3N1cHBsaWVyX2lkJyA9PiAkbW9kYWwtPnN1cHBsaWVyX2lkLCAncHVyY2hhc2Vfb3JkZXJfaWQnID0+ICRwb19kYXRhLT5pZF0pLT5maXJzdCgpOwoKICAgICAgICAgICAgICAgICAgICAkc3VwcGxpZXJfcGF5bWVudC0+dHJhbnNlY3Rpb25fZGF0ZSA9IGRhdGUoJ1ktbS1kIGg6aTpzJyk7CiAgICAgICAgICAgICAgICAgICAgJHN1cHBsaWVyX3BheW1lbnQtPnRyYW5zZWN0aW9uX3R5cGUgPSAncHVyY2hhc2UnOwogICAgICAgICAgICAgICAgICAgICRzdXBwbGllcl9wYXltZW50LT5wYXlfYW1vdW50ID0gJHBheV9hbW91bnQ7CiAgICAgICAgICAgICAgICAgICAgJHN1cHBsaWVyX3BheW1lbnQtPnBheV9kYXRlID0gJHBheV9kYXRlOwogICAgICAgICAgICAgICAgICAgICRzdXBwbGllcl9wYXltZW50LT5iaWxsX3R5cGUgPSAncG8tYWR2YW5jZSc7CiAgICAgICAgICAgICAgICAgICAgJHN1cHBsaWVyX3BheW1lbnQtPnNhdmUoKTsKCiAgICAgICAgICAgICAgICAgICAgLy9Ob3RpZmljYXRpb24gc2VuZCB0byBhY2NvdW50cwogICAgICAgICAgICAgICAgICAgICRtZXNzYWdlID0gJzxzcGFuIGNsYXNzPSJub3RpZmljYXRpb24tbGlua3MiICBkYXRhLXRpdGxlPSJQdXJjaGFzZSBPcmRlciBEZXRhaWxzIj5SZWZlcmVuY2UgTm86JyAuICRwb19kYXRhLT5yZWZlcmVuY2Vfbm8gLiAnLiBBIFBPIChyZXZpc2VkKSBoYXMgYmVlbiBzdWJtaXR0ZWQgd2l0aCBhbiBhZHZhbmNlIGFtb3VudCBvZiBUSyAnIC4gJHN1cHBsaWVyX3BheW1lbnQtPnBheV9hbW91bnQgLiAnPC9zcGFuPic7CgogICAgICAgICAgICAgICAgICAgIENyZWF0ZU9yVXBkYXRlTm90aWZpY2F0aW9uKCRtZXNzYWdlLCAndW5yZWFkJywgJycsIGdldE1hbmFnZXJJbmZvKCdBY2NvdW50cycsIG51bGwsIHRydWUpLCAnc2VuZC10by1hY2NvdW50cycpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvL1VwZGF0ZSByZXF1aXNpdGlvbgogICAgICAgICAgICBSZXF1aXNpdGlvbkl0ZW06OndoZXJlSW4oJ3JlcXVpc2l0aW9uX2lkJywgJHJlcXVlc3QtPnJlcXVpc2l0aW9uX2lkKQogICAgICAgICAgICAgICAgLT53aGVyZUluKCd1aWQnLCAkY29sbGVjdFByb2R1Y3RJZCkKICAgICAgICAgICAgICAgIC0+d2hlcmUoJ2lzX3NlbmQnLCAneWVzJykKICAgICAgICAgICAgICAgIC0+d2hlcmUoJ3BvX2dlbmVyYXRlJywgJ25vJykKICAgICAgICAgICAgICAgIC0+dXBkYXRlKFsKICAgICAgICAgICAgICAgICAgICAncG9fZ2VuZXJhdGUnID0+ICd5ZXMnCiAgICAgICAgICAgICAgICBdKTsKCiAgICAgICAgICAgIFB1cmNoYXNlT3JkZXJSZXF1aXNpdGlvbjo6d2hlcmUoWydwdXJjaGFzZV9vcmRlcl9pZCcgPT4gJHBvX2RhdGEtPmlkXSktPmRlbGV0ZSgpOwoKICAgICAgICAgICAgaWYgKGlzc2V0KCRyZXF1ZXN0LT5yZXF1aXNpdGlvbl9pZFswXSkpIHsKCiAgICAgICAgICAgICAgICBmb3JlYWNoICgkcmVxdWVzdC0+cmVxdWlzaXRpb25faWQgYXMgJGtleSA9PiAkcmVxdWlzaXRpb25faWQpIHsKICAgICAgICAgICAgICAgICAgICBQdXJjaGFzZU9yZGVyUmVxdWlzaXRpb246OnVwZGF0ZU9yQ3JlYXRlKFsKICAgICAgICAgICAgICAgICAgICAgICAgJ3B1cmNoYXNlX29yZGVyX2lkJyA9PiAkcG9fZGF0YS0+aWQsCiAgICAgICAgICAgICAgICAgICAgICAgICdyZXF1aXNpdGlvbl9pZCcgPT4gJHJlcXVpc2l0aW9uX2lkLAogICAgICAgICAgICAgICAgICAgIF0sIFsKICAgICAgICAgICAgICAgICAgICAgICAgJ2hyX2RlcGFydG1lbnRfaWQnID0+IGlzc2V0KCRyZXF1ZXN0LT5ocl9kZXBhcnRtZW50X2lkKSA/ICRyZXF1ZXN0LT5ocl9kZXBhcnRtZW50X2lkIDogMCwKICAgICAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgICAgICAgICAvL1JlcXVpc2l0aW9uIHRyYWNraW5nIHdpdGggcmVxdWlzaXRpb24gaWQKICAgICAgICAgICAgICAgICAgICBSZXF1aXNpdGlvblRyYWNraW5nOjpzdG9yZVJlcXVpc2l0aW9uVHJhY2tpbmcoJHJlcXVpc2l0aW9uX2lkLCAnUE8tSXNzdWUnKTsKCiAgICAgICAgICAgICAgICAgICAgLy9Ob3RpZmljYXRpb24gZ2VuZXJhdGUKICAgICAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb25Vc2VyID0gUmVxdWlzaXRpb246OndoZXJlKCdpZCcsICRyZXF1aXNpdGlvbl9pZCktPmZpcnN0KCk7CgogICAgICAgICAgICAgICAgICAgICRtZXNzYWdlID0gJzxzcGFuIGNsYXNzPSJub3RpZmljYXRpb24tbGlua3MiICBkYXRhLXRpdGxlPSJQdXJjaGFzZSBPcmRlciBEZXRhaWxzIj5QTyBSZWZlcmVuY2UgTm8gIycgLiAkcG9fZGF0YS0+cmVmZXJlbmNlX25vIC4gJy4gQSBQTyBoYXMgYmVlbiBJc3N1ZWQgKHJldmlzZWQpIGFnYWluc3QgeW91ciByZXF1aXNpdGlvbiAjJyAuICRyZXF1aXNpdGlvblVzZXItPnJlZmVyZW5jZV9ubyAuICc8L3NwYW4+JzsKICAgICAgICAgICAgICAgICAgICBDcmVhdGVPclVwZGF0ZU5vdGlmaWNhdGlvbigkbWVzc2FnZSwgJ3VucmVhZCcsICcnLCBbJHJlcXVpc2l0aW9uVXNlci0+YXV0aG9yX2lkXSwgJ3JlcXVpc2l0aW9uJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICRhcnJheSA9IFtdOwoKICAgICAgICAgICAgLy9QTyBHZW5lcmF0ZSBFcXVhbGx5IGRpc3RyaWJ1dGUKICAgICAgICAgICAgaWYgKGlzc2V0KCRyZXF1ZXN0LT5wcm9kdWN0X2lkWzBdKSkgewogICAgICAgICAgICAgICAgZm9yZWFjaCAoJHJlcXVlc3QtPnByb2R1Y3RfaWQgYXMgJGtleSA9PiAkcHJvZHVjdF9pZCkgewoKICAgICAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb25fcXR5ID0gKGlzc2V0KCRyZXF1ZXN0LT5yZXF1aXNpdGlvbl9xdHlbJHByb2R1Y3RfaWRdKSA/ICRyZXF1ZXN0LT5yZXF1aXNpdGlvbl9xdHlbJHByb2R1Y3RfaWRdIDogMCk7CiAgICAgICAgICAgICAgICAgICAgJHBvX3F0eSA9IChpc3NldCgkcmVxdWVzdC0+cG9fcXR5WyRwcm9kdWN0X2lkXSkgPyAkcmVxdWVzdC0+cG9fcXR5WyRwcm9kdWN0X2lkXSA6IDApOwogICAgICAgICAgICAgICAgICAgICRwZXJjZW50YWdlID0gKCRyZXF1aXNpdGlvbl9xdHkgPiAwICYmICRwb19xdHkgPiAwID8gKCgkcG9fcXR5IC8gJHJlcXVpc2l0aW9uX3F0eSkgKiAxMDApIDogMCk7CgogICAgICAgICAgICAgICAgICAgIGlmIChpc3NldCgkcmVxdWVzdC0+cmVxdWlzaXRpb25faWRbMF0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRyZXF1ZXN0LT5yZXF1aXNpdGlvbl9pZCBhcyAka2V5ID0+ICRyZXF1aXNpdGlvbl9pZCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbkl0ZW1zID0gUmVxdWlzaXRpb25JdGVtOjp3aGVyZSgncmVxdWlzaXRpb25faWQnLCAkcmVxdWlzaXRpb25faWQpLT53aGVyZSgncHJvZHVjdF9pZCcsICRwcm9kdWN0X2lkKS0+Z2V0KCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzc2V0KCRyZXF1aXNpdGlvbkl0ZW1zWzBdKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRyZXF1aXNpdGlvbkl0ZW1zIGFzICRrZXkgPT4gJHJlcXVpc2l0aW9uSXRlbSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHBvX3F0eSA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR0aGlzX3BvX3F0eSA9IHJvdW5kKCgkcGVyY2VudGFnZSA+IDAgPyAoJHJlcXVpc2l0aW9uSXRlbS0+cXR5ICogKCRwZXJjZW50YWdlIC8gMTAwKSkgOiAwKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkdGhpc19wb19xdHkgPSAoJHRoaXNfcG9fcXR5ID4gJHBvX3F0eSA/ICRwb19xdHkgOiAkdGhpc19wb19xdHkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbkl0ZW0tPnB1cmNoYXNlX3F0eSA9ICR0aGlzX3BvX3F0eTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbkl0ZW0tPnNhdmUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcG9fcXR5ID0gKCRwb19xdHkgLSAkdGhpc19wb19xdHkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHBvX3F0eSA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbkl0ZW0gPSBSZXF1aXNpdGlvbkl0ZW06OndoZXJlKCdyZXF1aXNpdGlvbl9pZCcsICRyZXF1aXNpdGlvbl9pZCktPndoZXJlKCdwcm9kdWN0X2lkJywgJHByb2R1Y3RfaWQpLT5maXJzdCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRyZXF1aXNpdGlvbkl0ZW0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb25JdGVtLT5wdXJjaGFzZV9xdHkgPSAoJHJlcXVpc2l0aW9uSXRlbS0+cHVyY2hhc2VfcXR5ICsgcm91bmQoJHBvX3F0eSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbkl0ZW0tPnNhdmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy9jb21wbGV0ZSB0aGUgcXVvdGF0aW9uCiAgICAgICAgICAgIFF1b3RhdGlvbnM6OndoZXJlKCdpZCcsICRtb2RhbC0+aWQpLT51cGRhdGUoWwogICAgICAgICAgICAgICAgJ2lzX3BvX2dlbmVyYXRlJyA9PiAneWVzJwogICAgICAgICAgICBdKTsKCiAgICAgICAgICAgIC8vZGVsZXRlIG9sZCBtaWxlc3RvbmVzCiAgICAgICAgICAgIFB1cmNoYXNlT3JkZXJNaWxlc3RvbmU6OndoZXJlKCdwdXJjaGFzZV9vcmRlcl9pZCcsICRwb19kYXRhLT5pZCktPmRlbGV0ZSgpOwogICAgICAgICAgICAvL2luc2VydCBuZXcgbWlsZXN0b25lcwogICAgICAgICAgICAkbWlsZXN0b25lcyA9IFtdOwogICAgICAgICAgICBpZiAoaXNzZXQoJHJlcXVlc3QtPm1pbGVzdG9uZV9uYW1lc1swXSkpIHsKICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRyZXF1ZXN0LT5taWxlc3RvbmVfbmFtZXMgYXMgJGtleSA9PiAkbWlsZXN0b25lKSB7CiAgICAgICAgICAgICAgICAgICAgYXJyYXlfcHVzaCgkbWlsZXN0b25lcywgWwogICAgICAgICAgICAgICAgICAgICAgICAncHVyY2hhc2Vfb3JkZXJfaWQnID0+ICRwb19kYXRhLT5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgJ25hbWUnID0+ICRyZXF1ZXN0LT5taWxlc3RvbmVfbmFtZXNbJGtleV0sCiAgICAgICAgICAgICAgICAgICAgICAgICdwZXJjZW50YWdlJyA9PiAkcmVxdWVzdC0+bWlsZXN0b25lX3BlcmNlbnRhZ2VzWyRrZXldLAogICAgICAgICAgICAgICAgICAgIF0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpc3NldCgkbWlsZXN0b25lc1swXSkpIHsKICAgICAgICAgICAgICAgIFB1cmNoYXNlT3JkZXJNaWxlc3RvbmU6Omluc2VydCgkbWlsZXN0b25lcyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIERCOjpjb21taXQoKTsKCiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+cmVkaXJlY3RCYWNrV2l0aFN1Y2Nlc3MoJ1B1cmNoYXNlIE9yZGVyIGhhcyBiZWVuIHJldmlzZWQgc3VjY2Vzc2Z1bGx5IScsICdwbXMucHVyY2hhc2Uub3JkZXItaW5kZXgnKTsKICAgICAgICB9IGNhdGNoIChcVGhyb3dhYmxlICR0aCkgewogICAgICAgICAgICBEQjo6cm9sbGJhY2soKTsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBEaXNwbGF5IGEgbGlzdGluZyBvZiB0aGUgcmVzb3VyY2UuCiAgICAgKgogICAgICogQHJldHVybiBcc3RyaW5nW11bXQogICAgICovCgogICAgcHVibGljIGZ1bmN0aW9uIHJlY2VpdmFibGVIZWFkZXJDb2x1bW5zKCR2YWx1ZSA9ICcnKQogICAgewogICAgICAgIHJldHVybiBhcnJheSgKICAgICAgICAgICAgWydTTCcsICdTTCddLAogICAgICAgICAgICBbJ2FwcHJvdmFsX2RhdGUnLCAnYXBwcm92YWxfZGF0ZScsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ2RlbGl2ZXJ5X2RhdGUnLCAnZGVsaXZlcnlfZGF0ZScsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3JlZmVyZW5jZV9ubycsICdyZWZlcmVuY2Vfbm8nLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydzdXBwbGllcicsICdzdXBwbGllcicsICd0ZXh0LWxlZnQnXSwKICAgICAgICAgICAgWydxdW90YXRpb25fcmVmX25vJywgJ3F1b3RhdGlvbl9yZWZfbm8nLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWyd0b3RhbF9wcmljZScsICd0b3RhbF9wcmljZScsICd0ZXh0LXJpZ2h0J10sCiAgICAgICAgICAgIFsndmF0JywgJ3ZhdCcsICd0ZXh0LXJpZ2h0J10sCiAgICAgICAgICAgIFsnZ3Jvc3NfcHJpY2UnLCAnZ3Jvc3NfcHJpY2UnLCAndGV4dC1yaWdodCddLAogICAgICAgICAgICBbJ2FjdGlvbnMnLCAnYWN0aW9ucycsICd0ZXh0LWNlbnRlcicsICd3aWR0aDoxNSUnXQogICAgICAgICk7CiAgICB9CgogICAgLyoqCiAgICAgKiBEaXNwbGF5IGEgbGlzdGluZyBvZiB0aGUgcmVzb3VyY2UuCiAgICAgKgogICAgICovCgogICAgcHVibGljIGZ1bmN0aW9uIHJlY2VpdmFibGVMaXN0KCkKICAgIHsKICAgICAgICB0cnkgewogICAgICAgICAgICAkdGl0bGUgPSAnVXBjb21pbmcgUmVjZWl2YWJsZSBQdXJjaGFzZSBPcmRlcic7CgogICAgICAgICAgICAkcHVyY2hhc2VPcmRlckxpc3QgPSBQdXJjaGFzZU9yZGVyOjp3aXRoKFsKICAgICAgICAgICAgICAgICdyZWxRdW90YXRpb24ucmVsU3VwcGxpZXJzJywKICAgICAgICAgICAgICAgICdyZWxHb29kUmVjZWl2ZU5vdGUnLAogICAgICAgICAgICAgICAgJ3JlbFF1b3RhdGlvbi5leGNoYW5nZVJhdGUuY3VycmVuY3knLAogICAgICAgICAgICAgICAgJ3JlbFBvQXR0YWNobWVudCcsCiAgICAgICAgICAgICAgICAncmVsU3VwcGxpZXJQYXltZW50cycKICAgICAgICAgICAgXSkKICAgICAgICAgICAgICAgIC0+d2hlbighYXV0aCgpLT51c2VyKCktPmhhc0FueVJvbGUoWydQdXJjaGFzZS1EZXBhcnRtZW50JywgJ0F1ZGl0JywgJ0JpbGxpbmcnLCAnTWFuYWdlbWVudCcsICdBY2NvdW50cyddKSwgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdwdXJjaGFzZU9yZGVyUmVxdWlzaXRpb25zLnJlcXVpc2l0aW9uJywgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnYXNzaWduZWRfdXNlcl9pZCcsIGF1dGgoKS0+dXNlcigpLT5pZCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT53aGVyZUluKCdocl91bml0X2lkJywgYXV0aCgpLT51c2VyKCktPnByaW9yaXRpZXMtPnBsdWNrKCdocl91bml0X2lkJyktPnRvQXJyYXkoKSkKICAgICAgICAgICAgICAgIC0+d2hlcmVIYXMoJ3JlbFF1b3RhdGlvbicsIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZU5vdEluKCd0eXBlJywgWydkaXJlY3QtcHVyY2hhc2UnXSkKICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZSgnZGVsaXZlcnlfZGF0ZScsICc+PScsIGRhdGUoJ1ktbS1kJykpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmUoJ2RlbGl2ZXJ5X2RhdGUnLCAnPD0nLCBkYXRlKCdZLW0tZCcsIHN0cnRvdGltZSgnKzEwIGRheScpKSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT53aGVyZUluKCdpc19zZW5kJywgWydubycsICd5ZXMnXSkKICAgICAgICAgICAgICAgIC0+d2hlbighZGF0YXRhYmxlT3JkZXJpbmcoKSwgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyYnkoJ2lkJywgJ2Rlc2MnKTsKICAgICAgICAgICAgICAgIH0pOwoKCiAgICAgICAgICAgICRvcHRpb25zID0gWwogICAgICAgICAgICAgICAgJ3JlY2VpdmFibGVzLXBvLXNlbmQtbm90aWZ5JyA9PiBhdXRoKCktPnVzZXIoKS0+aGFzUGVybWlzc2lvblRvKCdyZWNlaXZhYmxlcy1wby1zZW5kLW5vdGlmeScpLAogICAgICAgICAgICBdOwoKICAgICAgICAgICAgaWYgKHJlcXVlc3QoKS0+YWpheCgpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gRGF0YVRhYmxlczo6b2YoJHB1cmNoYXNlT3JkZXJMaXN0KQogICAgICAgICAgICAgICAgICAgIC0+YWRkSW5kZXhDb2x1bW4oKQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdhcHByb3ZhbF9kYXRlJywgZnVuY3Rpb24gKCR2YWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRhdGUoJ1ktbS1kJywgc3RydG90aW1lKCR2YWx1ZXMtPnBvX2RhdGUpKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdhcHByb3ZhbF9kYXRlJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgncG9fZGF0ZScsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbignYXBwcm92YWxfZGF0ZScsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT5vcmRlckJ5KCdwb19kYXRlJywgJG9yZGVyKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZWRpdENvbHVtbigncmVmZXJlbmNlX25vJywgZnVuY3Rpb24gKCR2YWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIG9uY2xpY2s9InB1cmNoYXNlT3JkZXJEZXRhaWxzKCQodGhpcykpIiBjbGFzcz0iYnRuIGJ0bi1saW5rIiBkYXRhLXNyYz0iJyAuIHJvdXRlKCdwbXMucHVyY2hhc2Uub3JkZXItbGlzdC5zaG93JywgJHZhbHVlcy0+aWQpIC4gJyI+JyAuICR2YWx1ZXMtPnJlZmVyZW5jZV9ubyAuICc8L2E+JzsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdzdXBwbGllcicsIGZ1bmN0aW9uICgkdmFsdWVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpc3NldCgkdmFsdWVzLT5yZWxRdW90YXRpb24tPnJlbFN1cHBsaWVycykgPyAoaXNzZXQoJHZhbHVlcy0+cmVsUXVvdGF0aW9uLT5yZWxTdXBwbGllcnMtPm5hbWUpID8gJHZhbHVlcy0+cmVsUXVvdGF0aW9uLT5yZWxTdXBwbGllcnMtPm5hbWUgLiAnICgnIC4gJHZhbHVlcy0+cmVsUXVvdGF0aW9uLT5yZWxTdXBwbGllcnMtPmNvZGUgLiAnKScgOiAnJykgOiAnJzsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdzdXBwbGllcicsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxRdW90YXRpb24ucmVsU3VwcGxpZXJzJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5vcldoZXJlKCdjb2RlJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbignc3VwcGxpZXInLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRvcmRlciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFF1b3RhdGlvbnM6OnNlbGVjdCgnc3VwcGxpZXJzLm5hbWUnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbignc3VwcGxpZXJzJywgJ3N1cHBsaWVycy5pZCcsICc9JywgJ3F1b3RhdGlvbnMuc3VwcGxpZXJfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3F1b3RhdGlvbnMuaWQnLCAncHVyY2hhc2Vfb3JkZXJzLnF1b3RhdGlvbl9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLT50YWtlKDEpCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbigncXVvdGF0aW9uX3JlZl9ubycsIGZ1bmN0aW9uICgkdmFsdWVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpc3NldCgkdmFsdWVzLT5yZWxRdW90YXRpb24tPnJlZmVyZW5jZV9ubykgPyAkdmFsdWVzLT5yZWxRdW90YXRpb24tPnJlZmVyZW5jZV9ubyA6ICcnOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3F1b3RhdGlvbl9yZWZfbm8nLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUXVvdGF0aW9uJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgncmVmZXJlbmNlX25vJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbigncXVvdGF0aW9uX3JlZl9ubycsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJG9yZGVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgUXVvdGF0aW9uczo6c2VsZWN0KCdxdW90YXRpb25zLnJlZmVyZW5jZV9ubycpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbigncXVvdGF0aW9ucy5pZCcsICdwdXJjaGFzZV9vcmRlcnMucXVvdGF0aW9uX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdkZWxpdmVyeV9kYXRlJywgZnVuY3Rpb24gKCR2YWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzc2V0KCR2YWx1ZXMtPnJlbFF1b3RhdGlvbi0+ZGVsaXZlcnlfZGF0ZSkgPyBkYXRlKCdZLW0tZCcsIHN0cnRvdGltZSgkdmFsdWVzLT5yZWxRdW90YXRpb24tPmRlbGl2ZXJ5X2RhdGUpKSA6ICcnOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ2RlbGl2ZXJ5X2RhdGUnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUXVvdGF0aW9uJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnZGVsaXZlcnlfZGF0ZScsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ2RlbGl2ZXJ5X2RhdGUnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRvcmRlciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFF1b3RhdGlvbnM6OnNlbGVjdCgncXVvdGF0aW9ucy5kZWxpdmVyeV9kYXRlJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCdxdW90YXRpb25zLmlkJywgJ3B1cmNoYXNlX29yZGVycy5xdW90YXRpb25faWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+dGFrZSgxKQogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5lZGl0Q29sdW1uKCd0b3RhbF9wcmljZScsIGZ1bmN0aW9uICgkdmFsdWVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoKGlzc2V0KCR2YWx1ZXMtPnJlbFF1b3RhdGlvbi0+ZXhjaGFuZ2VSYXRlLT5jdXJyZW5jeS0+c3ltYm9sKSA/ICR2YWx1ZXMtPnJlbFF1b3RhdGlvbi0+ZXhjaGFuZ2VSYXRlLT5jdXJyZW5jeS0+c3ltYm9sIDogJycpIC4gJyAnIC4gc3lzdGVtTW9uZXlGb3JtYXQoJHZhbHVlcy0+dG90YWxfcHJpY2UpKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZWRpdENvbHVtbigndmF0JywgZnVuY3Rpb24gKCR2YWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgoaXNzZXQoJHZhbHVlcy0+cmVsUXVvdGF0aW9uLT5leGNoYW5nZVJhdGUtPmN1cnJlbmN5LT5zeW1ib2wpID8gJHZhbHVlcy0+cmVsUXVvdGF0aW9uLT5leGNoYW5nZVJhdGUtPmN1cnJlbmN5LT5zeW1ib2wgOiAnJykgLiAnICcgLiBzeXN0ZW1Nb25leUZvcm1hdCgkdmFsdWVzLT52YXQpKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZWRpdENvbHVtbignZ3Jvc3NfcHJpY2UnLCBmdW5jdGlvbiAoJHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKChpc3NldCgkdmFsdWVzLT5yZWxRdW90YXRpb24tPmV4Y2hhbmdlUmF0ZS0+Y3VycmVuY3ktPnN5bWJvbCkgPyAkdmFsdWVzLT5yZWxRdW90YXRpb24tPmV4Y2hhbmdlUmF0ZS0+Y3VycmVuY3ktPnN5bWJvbCA6ICcnKSAuICcgJyAuIHN5c3RlbU1vbmV5Rm9ybWF0KCR2YWx1ZXMtPmdyb3NzX3ByaWNlKSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignYWN0aW9ucycsIGZ1bmN0aW9uICgkdmFsdWVzKSB1c2UgKCRvcHRpb25zKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICcgPGEgdGFyZ2V0PSJfYmxhbmsiIGhyZWY9IicgLiByb3V0ZSgncG1zLmJpbGxpbmctYXVkaXQucG8uaW52b2ljZS5wcmludCcsICR2YWx1ZXMtPmlkKSAuICciICB0aXRsZT0iUHVyY2hhc2UgT3JkZXIgUHJpbnQgVmlldyIgY2xhc3M9ImJ0biBidG4teHMgYnRuLXdhcm5pbmcgbS0xIj48aSBjbGFzcz0ibGFzIGxhLXByaW50Ij48L2k+PC9hPic7CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGFjdGlvbnM7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPnJhd0NvbHVtbnMoWydyZWZlcmVuY2Vfbm8nLCAnc3VwcGxpZXInLCAndG90YWxfcHJpY2UnLCAndmF0JywgJ2dyb3NzX3ByaWNlJywgJ2FjdGlvbnMnXSkKICAgICAgICAgICAgICAgICAgICAtPm1ha2UodHJ1ZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5wdXJjaGFzZS5yZWNlaXZhYmxlLWxpc3QnLCBbCiAgICAgICAgICAgICAgICAndGl0bGUnID0+ICR0aXRsZSwKICAgICAgICAgICAgICAgICdoZWFkZXJDb2x1bW5zJyA9PiAkdGhpcy0+cmVjZWl2YWJsZUhlYWRlckNvbHVtbnMoKQogICAgICAgICAgICBdKTsKICAgICAgICB9IGNhdGNoIChcVGhyb3dhYmxlICR0aCkgewogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KfQo=